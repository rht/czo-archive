<html>
<head><meta charset="utf-8"><title>pointer removal · design · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/101-design/index.html">design</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html">pointer removal</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="907654"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/907654" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#907654">(Jun 17 2020 at 23:37)</a>:</h4>
<p>OK, I've now test-deployed on this server the critical change that removes the "pointer" as a concept in Zulip (there's a bunch of other other fixes for anomalies with loading indicators etc. that have been merged over the last few days as part of this effort).</p>
<p>What this means is that I'd really really appreciate folks, especially those of your with thousands of unreads right now, doing QA specifically around what messages are shown when you start a Zulip new browser window in the "All messages" view, which should now always take you to the first unread.  And making sure that you don't see any weird anomalies with where loading indicators appear (etc.).</p>



<a name="907656"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/907656" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#907656">(Jun 17 2020 at 23:38)</a>:</h4>
<p>One bug I notice is that after visiting a <code>near:1</code> narrow and then hit <code>end</code> repeatedly to see the boating loading indicator, the loading indicator that appears don't have the spinner component.  <span class="user-mention" data-user-id="13033">@Ryan Rehman</span> FYI, can you investigate?</p>



<a name="911029"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/911029" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wyatt Hoodes <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#911029">(Jun 21 2020 at 23:35)</a>:</h4>
<p>I'm noticing an issue with ~1600 unreads, sometimes I'm left "spinning" on the <code>Loading...</code> page, and I'm forced to manually reload.  However, this doesn't happen consistently.  But it definitely happens.</p>



<a name="911031"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/911031" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wyatt Hoodes <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#911031">(Jun 22 2020 at 01:12)</a>:</h4>
<p>But besides that, things look good on my end.</p>



<a name="911047"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/911047" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#911047">(Jun 22 2020 at 04:45)</a>:</h4>
<p><span class="user-mention" data-user-id="11072">@Wyatt Hoodes</span> that sounds like something we should investigate carefully</p>



<a name="911049"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/911049" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#911049">(Jun 22 2020 at 04:46)</a>:</h4>
<p>Please let me know the next time you see a tab in that state</p>



<a name="911050"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/911050" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#911050">(Jun 22 2020 at 04:46)</a>:</h4>
<p>If it happens to anyone here it's likely important to debug</p>



<a name="911169"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/911169" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wyatt Hoodes <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#911169">(Jun 22 2020 at 11:50)</a>:</h4>
<p>Will do, I didn’t think anything of it until I saw this thread. But next time I see it I’ll certainly let you know and try to gather some more data on it.</p>



<a name="917961"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/917961" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wyatt Hoodes <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#917961">(Jun 28 2020 at 15:17)</a>:</h4>
<p>I haven't been able to reproduce the above.  But I did notice if I scroll moderately fast to the bottom of a topic with a lot of unreads (80+), I see the little "Z" loader flash at the bottom of the message list.  Is this normal?</p>



<a name="917962"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/917962" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wyatt Hoodes <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#917962">(Jun 28 2020 at 15:21)</a>:</h4>
<p>(I have half a mind that the page loading issue was a result of poor signal strength from my router.)</p>



<a name="917993"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/917993" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash RE <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#917993">(Jun 28 2020 at 17:40)</a>:</h4>
<p>I've seen that too!</p>



<a name="917994"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/917994" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yash RE <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#917994">(Jun 28 2020 at 17:41)</a>:</h4>
<p>I thought it was intended?</p>



<a name="918027"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918027" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Rehman <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918027">(Jun 28 2020 at 19:46)</a>:</h4>
<p>This is intentional, the message fetch previously happened, we just added a new bottom loading indicator for the newest messages to display it. <a href="https://github.com/zulip/zulip/pull/15060">#15060</a></p>
<p>From what I understand, the last loading indicator is displayed even though there are no new messages fetched because:<br>
We don't fetch anymore if that message list's <code>found_newest</code> = True.<br>
But we set this to True, only if we receive 0 messages from the backend. <a href="https://github.com/zulip/zulip/blob/master/zerver/views/message_fetch.py#L1093">views/message_fetch.py#L1093</a><br>
So we need to fetch one more time to update it and prevent fetching newer messages.</p>



<a name="918054"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918054" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wyatt Hoodes <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918054">(Jun 28 2020 at 20:21)</a>:</h4>
<p>Interesting. Though showing a loading indicator to no longer load seems funny.</p>



<a name="918055"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918055" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918055">(Jun 28 2020 at 20:21)</a>:</h4>
<p>It's intentional that we show a loading indicator at the bottom when there are more messages to fetch.</p>



<a name="918056"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918056" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wyatt Hoodes <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918056">(Jun 28 2020 at 20:22)</a>:</h4>
<p>This happens when there are no more messages to fetch as well.</p>



<a name="918057"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918057" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918057">(Jun 28 2020 at 20:22)</a>:</h4>
<p>I'm not sure I understand the precise case that <span class="user-mention" data-user-id="13033">@Ryan Rehman</span> is referring to with <code>found_newest</code> not being set to true when getting to the bottom; I would that to only happen in rare cases (E.g. where we fetched the exactly 100 messages that were there to fetch in the previous fetch, and it happened there were 0 more to fetch).</p>



<a name="918059"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918059" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918059">(Jun 28 2020 at 20:24)</a>:</h4>
<p>(I'm not sure the loading indicator spinning around the Z is the right design, BTW; but it is the same loading indicator we've always had at the top)</p>



<a name="918065"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918065" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wyatt Hoodes <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918065">(Jun 28 2020 at 20:29)</a>:</h4>
<p>Yeah, so what I just saw in a topic with 60 unread messages:</p>
<ul>
<li>I scroll fast all the way to the bottom without stopping.</li>
<li>The "Z" circle quickly flashes at the bottom.</li>
</ul>
<p>This quick flash of an icon that is supposed to be "making sure there are no more messages" seems like a confusing way to communicate that.</p>



<a name="918079"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918079" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wyatt Hoodes <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918079">(Jun 28 2020 at 20:41)</a>:</h4>
<p>I've also noticed some weird mouse scrolling behavior in topics with only a handful of messages.</p>



<a name="918103"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918103" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Rehman <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918103">(Jun 28 2020 at 21:05)</a>:</h4>
<p>Sorry the previous comment was incorrect, I think this is why the bug is happening:</p>
<ul>
<li>On narrowing we load the messages locally <a href="https://github.com/zulip/zulip/blob/master/static/js/narrow.js#L217">narrow.js#L217</a>. </li>
<li>Then we fetch 50 new messages first time we activate narrow, starting from the first unread (not too sure which message is the anchor paramater ?). This updates <code>found_newest</code> to false. <a href="https://github.com/zulip/zulip/blob/master/static/js/message_fetch.js#L8">message_fetch.js#L8</a> (Thus this bug would only occur for 50+unreads)</li>
<li>Then on scrolling we fetch again as <code>found_newest</code> is False, but since we fetch from the last message (the anchor parameter is the last message. <a href="https://github.com/zulip/zulip/blob/master/static/js/message_fetch.js#L282">message_fetch.js#L282</a>), we always receive just that 1 last message and <code>found_newest</code> gets updated to True.</li>
</ul>
<p>I tested this by commenting out <a href="https://github.com/zulip/zulip/blob/master/static/js/narrow.js#L217">narrow.js#L217</a> and no loading indicator is displayed for fetching new messages.</p>



<a name="918110"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918110" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918110">(Jun 28 2020 at 21:18)</a>:</h4>
<p>We use likely use <code>anchor="first_unread"</code> in that query, or something very close to it.</p>



<a name="918111"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918111" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918111">(Jun 28 2020 at 21:18)</a>:</h4>
<p>Where's the code that sets <code>found_newest</code> to false?</p>



<a name="918112"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918112" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918112">(Jun 28 2020 at 21:20)</a>:</h4>
<p>Oh, is the problem something like this: Even when we locally render 100 messages including 80 unreads, and we query the server to confirm our understanding of the history, we send an anchor that's 80/100 from the bottom, and only grab 50 messages?</p>



<a name="918114"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918114" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918114">(Jun 28 2020 at 21:20)</a>:</h4>
<p>Yeah, OK, I see how we'd have that bug.</p>



<a name="918115"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918115" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918115">(Jun 28 2020 at 21:22)</a>:</h4>
<p>Interesting.</p>



<a name="918116"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918116" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918116">(Jun 28 2020 at 21:23)</a>:</h4>
<p>Well, one solution would look like fetching <code>max(50, number_locally_rendered_past_pointer + 5)</code>, but that could be an unbounded fetch, which we don't want to be possible.</p>



<a name="918117"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918117" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918117">(Jun 28 2020 at 21:23)</a>:</h4>
<p>Another would be to only locally render a limited number of messages past the anchor, even though we have more in cache; that feels weird too.</p>



<a name="918118"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918118" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918118">(Jun 28 2020 at 21:24)</a>:</h4>
<p>For context, the only reason we need to do that query to the server at all in this case is weird corner cases involving the user having subscribed/unsubscribed from the stream in the past that can result in there being holes in the <code>all_msg_list</code> history.</p>



<a name="918119"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918119" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918119">(Jun 28 2020 at 21:26)</a>:</h4>
<p>So regardless of how we resolve this detail, we might want to look at providing a bit of extra data on <code>Subscription</code> that could tell us whether that sort of holes in the history are possible; in the common case (&gt;99% of the time), they won't be, and we could skip the fetch entirely.</p>



<a name="918120"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918120" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918120">(Jun 28 2020 at 21:27)</a>:</h4>
<p>Which would partially resolve the bug, in that we'd only see that loading indicator for cases where it's an issue (and we could probably just avoid using any locally cached data when such holes are possible in user's history of the stream, to avoid the correctness issue that presently we'll only find such unlikely holes that are within 50 messages of the anchor if the anchor is more than 50 messages back)</p>



<a name="918122"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918122" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Rehman <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918122">(Jun 28 2020 at 21:34)</a>:</h4>
<p>I see, so we do not need to fetch both sides messages every time we activate narrow.</p>
<p>And for the stream subscribing / unsubscribing case, we would just not render any local messages,<br>
and then fetch on both sides from the first unread. <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="918124"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918124" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Rehman <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918124">(Jun 28 2020 at 21:38)</a>:</h4>
<p>I guess we could solve this by making the <code>active</code> field in <code>Subscription</code> to an enum having values something like:<br>
active<br>
inactive<br>
previously_disabled</p>



<a name="918125"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/pointer%20removal/near/918125" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/pointer.20removal.html#918125">(Jun 28 2020 at 21:39)</a>:</h4>
<p>Yeah, better might be <code>last_subscribe_message_id</code>, that would be the latest <code>message_id</code> on the server for the time the user last subscribed to the stream.  We know any messages since that point can be assumed clear of such issues.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>