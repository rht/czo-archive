<html>
<head><meta charset="utf-8"><title>indication that message sent · design · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/101-design/index.html">design</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html">indication that message sent</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="659600"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/659600" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rishi Gupta <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#659600">(Nov 08 2018 at 18:06)</a>:</h4>
<p>For new users, it's very confusing when you're scrolled up in the message view and send a message, since it appears as if nothing happened. I was watching someone use Zulip over their shoulder, and it definitely wasn't clear to them that a successful thing happened when they hit "Send".</p>
<p>Would it be hard to add a <code>Sending ..</code> and  <code>Message sent</code> somewhere (e.g. right above the compose box) if the local echo is not in view?</p>



<a name="659627"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/659627" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#659627">(Nov 08 2018 at 19:45)</a>:</h4>
<p><span class="user-mention" data-user-id="131">@Rishi Gupta</span> I thought we show a notification above the compose box in this case with a link, though maybe we just do that if you send to something not in your current narrow?  In any case it'd probably not be hard to add something similar to that existing feature.</p>



<a name="659663"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/659663" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#659663">(Nov 08 2018 at 20:11)</a>:</h4>
<p>We don't really show anything for the normal case.</p>



<a name="659666"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/659666" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#659666">(Nov 08 2018 at 20:12)</a>:</h4>
<p>I think we definitely want some kinda feedback here.  It can probably be similar to other messages over the compose box, but there's a danger of them being annoying to clear, so I think having them on a timer or be super easy to dismiss is gonna be the trickiest part of fixing this.</p>



<a name="659668"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/659668" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#659668">(Nov 08 2018 at 20:14)</a>:</h4>
<p>Yeah, let's open an issue for doing the exact same thing we do for messages sent to another topic appearing offscreen; I think we should start with that and play with it.</p>



<a name="659682"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/659682" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#659682">(Nov 08 2018 at 20:31)</a>:</h4>
<p>I'll open it.</p>



<a name="659683"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/659683" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#659683">(Nov 08 2018 at 20:34)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/pull/10792" target="_blank" title="https://github.com/zulip/zulip/pull/10792">#10792</a></p>



<a name="659724"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/659724" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#659724">(Nov 08 2018 at 22:34)</a>:</h4>
<p>Great, thanks Rishi for tagging as a priority (I agree with that)</p>



<a name="663402"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/663402" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#663402">(Nov 21 2018 at 10:18)</a>:</h4>
<p>Hey! I would like to work on this issue. I have claimed this issue on Github. Could you help me get started with it?</p>



<a name="663583"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/663583" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#663583">(Nov 21 2018 at 18:18)</a>:</h4>
<p><span class="user-mention" data-user-id="5593">@Vaibhav</span> I would start here:</p>
<p><a href="https://zulip.readthedocs.io/en/latest/overview/contributing.html" target="_blank" title="https://zulip.readthedocs.io/en/latest/overview/contributing.html">https://zulip.readthedocs.io/en/latest/overview/contributing.html</a></p>



<a name="664214"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664214" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664214">(Nov 26 2018 at 12:29)</a>:</h4>
<p>I was working on this issue and I encountered a problem. I tried to check if the local echo is not in view along with other <code>local_mixes</code> but the problem arises that when the insert local echo function is being called, the message has still not been inserted and hence the offset I get for the <code>local_echo</code> is 0. One way is to check for the same when the message has been sent but this is something that can easily be done locally, also, then <code>Sending...</code> thing won't be possible to add.</p>
<p>Any ideas...?</p>



<a name="664273"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664273" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664273">(Nov 26 2018 at 17:40)</a>:</h4>
<p>You want to render the indication basically when the message itself gets drawn.  Have you traced through the code to find out where that happens?</p>



<a name="664280"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664280" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664280">(Nov 26 2018 at 18:00)</a>:</h4>
<p><span class="user-mention" data-user-id="5593">@Vaibhav</span> </p>
<p>In <code>static/js/local_message.js</code> there is a function called <code>insert_message</code> that basically starts the process of inserting the message into the view:</p>
<div class="codehilite"><pre><span></span> <span class="mi">15</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">insert_message</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">16</span>     <span class="c1">// It is a little bit funny to go through the message_events</span>
 <span class="mi">17</span>     <span class="c1">// codepath, but it&#39;s sort of the idea behind local echo that</span>
 <span class="mi">18</span>     <span class="c1">// we are simulating server events before they actually arrive.</span>
 <span class="mi">19</span>     <span class="nx">message_events</span><span class="p">.</span><span class="nx">insert_new_messages</span><span class="p">([</span><span class="nx">message</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span>
 <span class="mi">20</span> <span class="p">};</span>
</pre></div>



<a name="664281"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664281" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664281">(Nov 26 2018 at 18:01)</a>:</h4>
<p>You'll note that <code>true</code> is passed as the second parameter there, and that is called <code>locally_echoed</code> inside of <code>message_events.insert_new_messages</code>, which allows you to have any special logic for the local-echo case.</p>



<a name="664282"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664282" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664282">(Nov 26 2018 at 18:02)</a>:</h4>
<p>An example of that is here:</p>
<div class="codehilite"><pre><span></span> <span class="mi">81</span>     <span class="k">if</span> <span class="p">(</span><span class="nx">locally_echoed</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">82</span>         <span class="nx">notifications</span><span class="p">.</span><span class="nx">notify_local_mixes</span><span class="p">(</span><span class="nx">messages</span><span class="p">);</span>
 <span class="mi">83</span>     <span class="p">}</span>
</pre></div>



<a name="664283"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664283" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664283">(Nov 26 2018 at 18:04)</a>:</h4>
<p>Hopefully this gets you a bit closer to where you'll want to add code for the indication.  It's definitely a bit of a tricky codepath to understand, so I'd try to give yourself a couple hours to just read code, and maybe add some console statements while you're running the app to better understand the order things happen in.</p>



<a name="664343"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664343" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664343">(Nov 26 2018 at 19:34)</a>:</h4>
<p><span class="user-mention" data-user-id="58">@Steve Howell</span> What I did first was that I added the check for the message after all the checks of <code>local_mixes</code>, this one having the least priority and the changes were made in the above <code>notifications.notify_local_mixes</code>.  I guess I'll have to add many more console statements to figure this out, hopefully this will be done by tomorrow.<br>
Thanks for the help :D</p>



<a name="664864"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664864" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664864">(Nov 27 2018 at 19:14)</a>:</h4>
<p><span class="user-mention" data-user-id="58">@Steve Howell</span> I made the required changes, but there is still a big problem. The whole thing is working kind of unpredictably. As I mentioned the other day, when adding the notification function in <code>success</code> it worked, today it wasn't working first, and then after sometime it started functioning properly. I really don't have any clue why, I logged the offset to the console and when it's not working, the y-offset is 0. Any idea about this kind of behaviour?</p>
<p>Right now, considering everything is working fine, a notification saying "Sending..." is posted above compose-box and when the message is sent, "Your message was sent!" is posted, and the notification exits after 3 seconds.<br>
I made a pull request, you can check the code here -&gt; <a href="https://github.com/zulip/zulip/pull/10889" target="_blank" title="https://github.com/zulip/zulip/pull/10889">#10889</a>. The PR is still marked <strong>[WIP]</strong></p>



<a name="664880"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664880" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664880">(Nov 27 2018 at 19:29)</a>:</h4>
<p>I'd add some debugging around this code:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">echo_offset_y</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[zid=&#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">local_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">).</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span><span class="p">;</span>
</pre></div>



<a name="664882"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664882" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664882">(Nov 27 2018 at 19:30)</a>:</h4>
<p>It's not clear why you're rounding the id to the nearest integer.  <span class="user-mention" data-user-id="5593">@Vaibhav</span> I wonder if that selector returns a jQuery object with zero elements.  And then maybe <code>offset()</code> just returns some kind of null object?</p>



<a name="664884"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664884" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664884">(Nov 27 2018 at 19:32)</a>:</h4>
<p>I rounded because the local ID is a floating point, but the <code>zid</code> attribute has the integer value. Also, if jQuery finds 0 elements it logs an error in the console, tried that <span class="emoji emoji-1f605" title="sweat smile">:sweat_smile:</span></p>



<a name="664885"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664885" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664885">(Nov 27 2018 at 19:32)</a>:</h4>
<p>A good debugging trick here is to do something like this:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">message_elem</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[zid=&#39;</span><span class="o">+</span><span class="p">...)</span>
<span class="nx">message_elem</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">echo_offset_y</span> <span class="o">=</span> <span class="nx">message_elem</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">echo_offset_y</span><span class="p">)</span>
</pre></div>



<a name="664886"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664886" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664886">(Nov 27 2018 at 19:32)</a>:</h4>
<p>Have you tried debugging this without server responses?</p>



<a name="664888"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664888" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664888">(Nov 27 2018 at 19:33)</a>:</h4>
<p>Can you elaborate?</p>



<a name="664889"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664889" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664889">(Nov 27 2018 at 19:33)</a>:</h4>
<p>What happens with local echo is a two-step process:</p>
<ul>
<li>we immediately render with a locally generated id</li>
<li>when the server response comes back with a <strong>permanent</strong> id, we re-render the message</li>
</ul>



<a name="664892"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664892" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664892">(Nov 27 2018 at 19:34)</a>:</h4>
<p>Re-rendering means the UI is updated again...?</p>



<a name="664895"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664895" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664895">(Nov 27 2018 at 19:35)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I have a theory on why this code is tricky, and it might be what <span class="user-mention" data-user-id="5593">@Vaibhav</span> is running up against.  There are places in MLV where we do <code>setTimeout(...., 0)</code> before actually rendering stuff.</p>



<a name="664896"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664896" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664896">(Nov 27 2018 at 19:35)</a>:</h4>
<blockquote>
<p>Re-rendering means the UI is updated again...?</p>
</blockquote>
<p>yes</p>



<a name="664898"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664898" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664898">(Nov 27 2018 at 19:36)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I've run across this code in various contexts, and it's always perplexed me, and it seems like it's inviting strange race conditions where we break invariants.</p>
<div class="codehilite"><pre><span></span><span class="mi">530</span>         <span class="c1">// If this message is now out of order, re-order and re-render</span>
<span class="mi">531</span>         <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<span class="mi">532</span>         <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
<span class="mi">533</span>             <span class="kd">var</span> <span class="nx">current_message</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_hash</span><span class="p">[</span><span class="nx">new_id</span><span class="p">];</span>
<span class="mi">534</span>             <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_items</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">current_message</span><span class="p">);</span>
<span class="mi">535</span>
<span class="mi">536</span>             <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">537</span>                 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">muting_enabled</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">is_current_list</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">538</span>                     <span class="nx">blueslip</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Trying to re-order message but can&#39;t find message with new_id in _items!&quot;</span><span class="p">);</span>
<span class="mi">539</span>                 <span class="p">}</span>
<span class="mi">540</span>                 <span class="k">return</span><span class="p">;</span>
<span class="mi">541</span>             <span class="p">}</span>
<span class="mi">542</span>
<span class="mi">543</span>             <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_next_nonlocal_message</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_items</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span>
<span class="mi">544</span>                                                    <span class="kd">function</span> <span class="p">(</span><span class="nx">idx</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">});</span>
<span class="mi">545</span>             <span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_next_nonlocal_message</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_items</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span>
<span class="mi">546</span>                                                    <span class="kd">function</span> <span class="p">(</span><span class="nx">idx</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">});</span>
<span class="mi">547</span>
<span class="mi">548</span>             <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">current_message</span><span class="p">.</span><span class="nx">id</span> <span class="o">&gt;</span> <span class="nx">next</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span>
<span class="mi">549</span>                 <span class="nx">prev</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">current_message</span><span class="p">.</span><span class="nx">id</span> <span class="o">&lt;</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">550</span>                 <span class="nx">blueslip</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Changed message ID from server caused out-of-order list, reordering&quot;</span><span class="p">);</span>
<span class="mi">551</span>                 <span class="nx">self</span><span class="p">.</span><span class="nx">_items</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">message_sort_func</span><span class="p">);</span>
<span class="mi">552</span>                 <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">muting_enabled</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">553</span>                     <span class="nx">self</span><span class="p">.</span><span class="nx">_all_items</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">message_sort_func</span><span class="p">);</span>
<span class="mi">554</span>                 <span class="p">}</span>
<span class="mi">555</span>
<span class="mi">556</span>                 <span class="nx">opts</span><span class="p">.</span><span class="nx">re_render</span><span class="p">();</span>
<span class="mi">557</span>             <span class="p">}</span>
<span class="mi">558</span>         <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>



<a name="664899"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664899" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664899">(Nov 27 2018 at 19:37)</a>:</h4>
<p>In particular, it's that we do it on a zero-second timeout.</p>



<a name="664905"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664905" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664905">(Nov 27 2018 at 19:38)</a>:</h4>
<p>I think the point of the 0-second timeout is to have it run after the rest of the current function finishes (and potentially other pending actions)</p>



<a name="664914"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664914" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664914">(Nov 27 2018 at 19:41)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Why would it be that the timeout function will be executed after the rest of the function is executed? If the functions are asynchronous they can be unpredictable</p>



<a name="664919"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664919" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664919">(Nov 27 2018 at 19:49)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Yeah, there was obviously some intention originally to defer it, but it seems unwise to me to defer it possibly until after operations that depend on it.</p>



<a name="664923"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664923" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664923">(Nov 27 2018 at 19:50)</a>:</h4>
<p><span class="user-mention" data-user-id="5593">@Vaibhav</span> It's possible this is completely unrelated to your issue--I haven't dug too deep.  But you could play around with making that code be synchronous and see if it changes things on your branch--that would be a really good data point to have.  I suspect there's like a 30% chance this is affecting your change, but that's just a wild guess.</p>



<a name="664926"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664926" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664926">(Nov 27 2018 at 19:51)</a>:</h4>
<p>I need to look at the code here; I don't see clear evidence that the <code>setTimeout</code> code block is buggy.</p>



<a name="664928"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664928" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blunivers <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664928">(Nov 27 2018 at 19:51)</a>:</h4>
<p>hello :)</p>



<a name="664929"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664929" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664929">(Nov 27 2018 at 19:51)</a>:</h4>
<p>(A fairly likely possible race is just ordering between various requests to the server returning)</p>



<a name="664930"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664930" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blunivers <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664930">(Nov 27 2018 at 19:51)</a>:</h4>
<p><span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<a name="664938"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664938" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664938">(Nov 27 2018 at 19:54)</a>:</h4>
<p>I'm using the term "race" a bit loosely.  I think this might actually be causing code to run out of order basically 100% of the time.  (But it's race-like in terms of the symptoms probably being flaky, as sometimes things get fixed as soon as server responses or new messages come.)</p>



<a name="664942"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/664942" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#664942">(Nov 27 2018 at 19:55)</a>:</h4>
<blockquote>
<p><span class="user-mention" data-user-id="5593">@Vaibhav</span> It's possible this is completely unrelated to your issue--I haven't dug too deep.  But you could play around with making that code be synchronous and see if it changes things on your branch--that would be a really good data point to have.  I suspect there's like a 30% chance this is affecting your change, but that's just a wild guess.</p>
</blockquote>
<p>Yeah, I'll surely try to find the bug, even I am doubtful about the bug being related to this <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<a name="666636"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/666636" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#666636">(Nov 30 2018 at 14:26)</a>:</h4>
<p><span class="user-mention" data-user-id="58">@Steve Howell</span> I figured out the bug, it was basically that there were two elements with the same <code>zid</code> and when calculating offset, it jQuery took the first one. I fixed that.</p>
<p>There was yet another problem, when ever I checked the offset for the element before it was rendered by the server, it showed me that the element did not exist (or maybe that when checking, the element was being re-rendered). So to solve this I took the last message in <code>focused_table</code> and put the check for it. I think that would be a fine approximation to check for the second last element.</p>
<p>Here is the Pull Request, it is ready to be reviewed. <a href="https://github.com/zulip/zulip/pull/10928" target="_blank" title="https://github.com/zulip/zulip/pull/10928">https://github.com/zulip/zulip/pull/10928</a></p>



<a name="666652"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/666652" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#666652">(Nov 30 2018 at 16:18)</a>:</h4>
<p><span class="user-mention" data-user-id="5593">@Vaibhav</span> Glad you figured out the bug.  There's an <code>.expectOne()</code> jQuery helper that we use to prevent bugs like this.  If you grep for it, you'll see examples.</p>



<a name="666653"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/666653" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#666653">(Nov 30 2018 at 16:20)</a>:</h4>
<p>It's not clear to me the <code>focused_table</code> approach will work, but I'm curious what Tim thinks.</p>



<a name="666654"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/666654" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#666654">(Nov 30 2018 at 16:23)</a>:</h4>
<p>The other approach could be to get the list of messages in that current narrow and to get id from there, this seemed kind of a shortcut for the same</p>



<a name="667093"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/667093" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#667093">(Dec 01 2018 at 16:10)</a>:</h4>
<blockquote>
<p>Here is the Pull Request, it is ready to be reviewed. <a href="https://github.com/zulip/zulip/pull/10928" target="_blank" title="https://github.com/zulip/zulip/pull/10928">https://github.com/zulip/zulip/pull/10928</a></p>
</blockquote>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  What are your thoughts on this?</p>



<a name="670650"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/670650" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#670650">(Dec 11 2018 at 14:12)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I made the required changes in this PR a few days back <a href="https://github.com/zulip/zulip/pull/10928" target="_blank" title="https://github.com/zulip/zulip/pull/10928">#10928</a>. It's ready to be merged I think. Was waiting for the review. Thanks <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<a name="670743"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/670743" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#670743">(Dec 11 2018 at 19:17)</a>:</h4>
<p>Yeah, I expect to take a look at this today <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<a name="673272"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/673272" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#673272">(Dec 17 2018 at 19:28)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="7">@Tim Abbott</span> ! I recently worked on the issue <a href="https://github.com/zulip/zulip/issues/10792" target="_blank" title="https://github.com/zulip/zulip/issues/10792">#10792</a>. The pull request <a href="https://github.com/zulip/zulip/pull/10928" target="_blank" title="https://github.com/zulip/zulip/pull/10928">#10928</a> regarding the issue got merged yesterday. In that you mentioned this:</p>
<blockquote>
<p>A useful follow-up would be moving the bit of logic for figuring out whether a message is onscreen into a reusable function in message_viewport.js, and potentially deduplicating the logic in any other places it appears in the codebase.</p>
</blockquote>
<p>Should I create an issue for the same first or start working straight away?</p>



<a name="673283"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/673283" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#673283">(Dec 17 2018 at 19:35)</a>:</h4>
<p><span class="user-mention" data-user-id="5593">@Vaibhav</span> if you're going to work on it in the next few days, I'd just work on it and submit a PR which can serve the role of a tracking issue for the project.</p>



<a name="673286"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/673286" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#673286">(Dec 17 2018 at 19:35)</a>:</h4>
<p>We generally create issues for anything not going to be resolved ~immediately, but for a refactor like this, it's reasonable to skip.</p>



<a name="673289"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/101-design/topic/indication%20that%20message%20sent/near/673289" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vaibhav Rabber <a href="https://rht.github.io/czo-archive/stream/101-design/topic/indication.20that.20message.20sent.html#673289">(Dec 17 2018 at 19:36)</a>:</h4>
<p>Sure! I don't think it would take much time, should be done in a day or so. Thanks <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>