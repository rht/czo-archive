<html>
<head><meta charset="utf-8"><title>bots and private streams · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html">bots and private streams</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="814354"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814354" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814354">(Feb 04 2020 at 01:38)</a>:</h4>
<p>Quick clarification on Outgoing Webhook integrations/bots: is the expected behavior is that the bots can or cannot function in private streams when the bot is not a member of the stream? <a href="https://zulipchat.com/help/bots-and-integrations" target="_blank" title="https://zulipchat.com/help/bots-and-integrations">The docs</a> say:</p>
<blockquote>
<p>The bot can read private messages where the bot is a participant, and stream messages where the bot is mentioned</p>
</blockquote>
<p>which sounds like perhaps the bot should be able to function in all streams (including private ones) via a mention even if it's not subscribed to the stream, but I vaguely remember that's not the correct interpretation.</p>
<p>Thanks!</p>



<a name="814487"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814487" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814487">(Feb 04 2020 at 21:30)</a>:</h4>
<p><span class="user-mention" data-user-id="3748">@Noe Martinez</span> an outgoing webhook bot can function in private streams even when not subscribed as long as you're just using the "respond to mentions" functionality.</p>



<a name="814518"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814518" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814518">(Feb 04 2020 at 22:06)</a>:</h4>
<p>Ah thanks!</p>
<blockquote>
<p>as long as you're just using the "respond to mentions" functionality</p>
</blockquote>
<p>Is there a way to use more than that? I thought respond-to-mentions (and private messages) was by definition an Outgoing Webhook's only "skill". Or you just mean "as long as you don't expect to be able to do more than that, like actively post an unprompted message to the private stream"?</p>



<a name="814519"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814519" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814519">(Feb 04 2020 at 22:09)</a>:</h4>
<p><span class="user-mention" data-user-id="3748">@Noe Martinez</span> right.  A bot can post unprompted to private streams that it is subscribed to or that its owner is subscribed to</p>



<a name="814520"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814520" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814520">(Feb 04 2020 at 22:11)</a>:</h4>
<p>Cool. And for Generic Bots it's different, right? Those do require a subscription? Or are they also able to respond to @mentions without being subscribed?</p>



<a name="814521"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814521" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814521">(Feb 04 2020 at 22:12)</a>:</h4>
<p>Right, I believe they currently don't have the special feature of outgoing webhook bots to be delivered messages from private streams.  We may change that to make the model more consistent down the line.</p>



<a name="814522"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814522" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814522">(Feb 04 2020 at 22:16)</a>:</h4>
<p>Ok, thanks. Yeah I think since a bot user has no clue (and probably doesn't care much) what the bot type is, it'd probably be nice to unify that bit at some point to avoid confusion.</p>



<a name="814523"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814523" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814523">(Feb 04 2020 at 22:18)</a>:</h4>
<p>Anyways, back to Outgoing, I was asking because as far as I can tell on our instance the Outgoing bot is not successfully posting its reply on private streams when mentioned, unless the bot is subscribed, or its owner is subscribed. We're a bit behind the latest, on 2.0.4 I believe. Is it a recent development that Outgoing Webhooks can function without being subscribed?</p>



<a name="814547"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814547" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814547">(Feb 05 2020 at 00:16)</a>:</h4>
<p><span class="user-mention" data-user-id="3748">@Noe Martinez</span> I don't think there's been any changes to that behavior since 1.9.x.</p>



<a name="814549"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814549" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814549">(Feb 05 2020 at 00:20)</a>:</h4>
<p>Ok thanks. I'll try to reproduce the issue here and report it. Do you know if by any chance someone has set up a  simple "hello world" Outgoing Webhook-compatible server URL out there in the internet that someone which I could point a bot to for testing? Or would I have to set up my own?</p>



<a name="814550"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814550" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814550">(Feb 05 2020 at 00:23)</a>:</h4>
<p>I'm not aware of one that returns an appropriate HTTP response to reply.</p>



<a name="814551"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814551" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814551">(Feb 05 2020 at 00:23)</a>:</h4>
<p>Cool I'll figure something out</p>



<a name="814743"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814743" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814743">(Feb 05 2020 at 17:35)</a>:</h4>
<p>I stood up a quick endpoint that returns a Zulip-compatible Hello World, and made an Outgoing bot (NoeBot) pointing to it. With <span class="user-mention silent" data-user-id="3733">Sean Wallitsch</span>'s help I was able to reproduce the behavior where the bot does not reply in the private stream, unless the bot or me are invited to the stream. I'll make a github issue and leave the bot up for at least a couple days, so feel free to test yourself in private streams.</p>



<a name="814744"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814744" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814744">(Feb 05 2020 at 17:36)</a>:</h4>
<p><a href="/user_uploads/2/90/5bWTq5xQHm3uQObydcYNFjnQ/zulip_outgoing_bot_private_streams.png" target="_blank" title="zulip_outgoing_bot_private_streams.png">Proof</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/90/5bWTq5xQHm3uQObydcYNFjnQ/zulip_outgoing_bot_private_streams.png" target="_blank" title="Proof"><img src="/user_uploads/2/90/5bWTq5xQHm3uQObydcYNFjnQ/zulip_outgoing_bot_private_streams.png"></a></div>



<a name="814749"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814749" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814749">(Feb 05 2020 at 17:49)</a>:</h4>
<p>Opened <a href="https://github.com/zulip/zulip/issues/13828" target="_blank" title="https://github.com/zulip/zulip/issues/13828">https://github.com/zulip/zulip/issues/13828</a></p>



<a name="814821"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814821" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814821">(Feb 05 2020 at 20:05)</a>:</h4>
<p><span class="user-mention" data-user-id="3748">@Noe Martinez</span> great, thanks for investigating!</p>



<a name="814823"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814823" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814823">(Feb 05 2020 at 20:07)</a>:</h4>
<p>So this block in <code>zerver/lib/actions.py</code> inside <code>get_service_bot_events</code> certainly suggests we intend for this to work:</p>
<div class="codehilite"><pre><span></span>        # Important note: service_bot_tuples may contain service bots
        # who were not actually mentioned in the message (e.g. if
        # mention syntax for that bot appeared in a code block).
        # Thus, it is important to filter any users who aren&#39;t part of
        # either mentioned_user_ids (the actual mentioned users) or
        # active_user_ids (the actual recipients).
        #
        # So even though this is implied by the logic below, we filter
        # these not-actually-mentioned users here, to help keep this
        # function future-proof.
        if user_profile_id not in mentioned_user_ids and user_profile_id not in active_user_ids:
            return
</pre></div>



<a name="814824"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814824" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814824">(Feb 05 2020 at 20:08)</a>:</h4>
<p>Probably the right answer will be to write an automated backend test for this and then see why it fails.</p>



<a name="814827"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814827" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814827">(Feb 05 2020 at 20:09)</a>:</h4>
<p>Thanks and no problem</p>



<a name="814935"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814935" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814935">(Feb 05 2020 at 21:48)</a>:</h4>
<p>Slight tangent question: <span class="user-mention" data-user-id="7">@Tim Abbott</span> I noticed that my outgoing bot endpoint on this Zulip server receives an HTTP GET from Zulip when summoned, whereas in our internal server it receives an HTTP POST that exactly matches <a href="https://zulipchat.com/api/outgoing-webhooks#zulip-message-format" target="_blank" title="https://zulipchat.com/api/outgoing-webhooks#zulip-message-format">the spec in the docs</a>. Is there something about this server's setup that might be causing that? As far as I can tell from the latest Zulip source code (assuming I'm looking in the right place), outgoing bots always do a POST so I'm surprised to see that happen here.</p>



<a name="814963"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/814963" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#814963">(Feb 05 2020 at 23:31)</a>:</h4>
<p><span class="user-mention" data-user-id="3748">@Noe Martinez</span> yeah, it should always be a POST.  How are you checking that you're receiving a GET?</p>



<a name="815025"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/815025" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#815025">(Feb 06 2020 at 00:34)</a>:</h4>
<p>The endpoint I stood up is a simple flask server and it reports a GET when I mention the bot in zulip. I'll triple check that I'm not messing something up cause I am doing a bit of url redirection to point to my home IP haha, but I can't see how a POST would be morphing to a GET in that process...</p>



<a name="815027"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/815027" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#815027">(Feb 06 2020 at 00:44)</a>:</h4>
<p><span class="user-mention" data-user-id="3748">@Noe Martinez</span> some web services will treat a POST as a GET in some cases; I don't know flask well enough to comment if it does that.</p>



<a name="815028"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/815028" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#815028">(Feb 06 2020 at 00:47)</a>:</h4>
<p>Flask is pretty POST-enabled as far as I know, and plus we're using flask with our internal zulip as well and it receives a POST so I don't <em>think</em> it's flask being weird, but I'll double check.</p>



<a name="815029"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/815029" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#815029">(Feb 06 2020 at 00:50)</a>:</h4>
<p>Without knowing much about the context, the one thing I can think of that might turn a POST into a GET is an HTTP redirect?</p>



<a name="815032"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/815032" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#815032">(Feb 06 2020 at 01:16)</a>:</h4>
<p>Ah that might be it. I tried a curl POST to my endpoint and it passed through the redirect as a POST but maybe the behavior is different with the zulip requests call. Thanks for the pointer. It's probably my URL setup then.</p>



<a name="815069"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/bots%20and%20private%20streams/near/815069" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noe Martinez <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/bots.20and.20private.20streams.html#815069">(Feb 06 2020 at 04:23)</a>:</h4>
<p>Confirmed it was a 301 redirect in my setup changing the HTTP verb, which I guess <a href="https://stackoverflow.com/a/13628908" target="_blank" title="https://stackoverflow.com/a/13628908">is a thing</a>. So ignore me on the whole GET saga.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>