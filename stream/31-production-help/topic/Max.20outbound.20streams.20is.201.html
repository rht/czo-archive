<html>
<head><meta charset="utf-8"><title>Max outbound streams is 1 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html">Max outbound streams is 1</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="498119"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/498119" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Russell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#498119">(Feb 14 2018 at 02:27)</a>:</h4>
<p>Looking to see if this is a known traceback. It appears to because of a bot using the zulip API to register events. I'm wondering if there is some common issue with connecting bots to to follow streams like only doing one stream per bot or something. </p>
<p>I have requested the source code from the user to see what's up with it.</p>
<div class="codehilite"><pre><span></span>Error generated by Anonymous user (not logged in) on zulip deployment

Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/worker/queue_processors.py&quot;, line 141, in consume_wrapper
    self.consume(data)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/worker/queue_processors.py&quot;, line 287, in consume
    handle_push_notification(data[&#39;user_profile_id&#39;], data)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/decorator.py&quot;, line 643, in wrapped_func
    ret = func(*args, **kwargs)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/lib/push_notifications.py&quot;, line 544, in handle_push_notification
    apns_payload)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/decorator.py&quot;, line 643, in wrapped_func
    ret = func(*args, **kwargs)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/lib/push_notifications.py&quot;, line 121, in send_apple_push_notification
    result = attempt_send()
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/lib/push_notifications.py&quot;, line 113, in attempt_send
    expiration=expiration)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/apns2/client.py&quot;, line 78, in send_notification_async
    stream_id = self._connection.request(&#39;POST&#39;, url, json_payload, headers)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/hyper/http20/connection.py&quot;, line 281, in request
    self.endheaders(message_body=body, final=True, stream_id=stream_id)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/hyper/http20/connection.py&quot;, line 555, in endheaders
    stream.send_headers(headers_only)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/hyper/http20/stream.py&quot;, line 98, in send_headers
    conn.send_headers(self.stream_id, headers, end_stream)
  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/h2/connection.py&quot;, line 836, in send_headers
    (max_open_streams, self.open_outbound_streams)
h2.exceptions.TooManyStreamsError: Max outbound streams is 1, 1 open


Request info:
- path: None
- None: None
- REMOTE_ADDR: &quot;None&quot;
- QUERY_STRING: &quot;None&quot;
- SERVER_NAME: &quot;None&quot;
</pre></div>



<a name="498445"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/498445" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#498445">(Feb 14 2018 at 05:55)</a>:</h4>
<p><span class="user-mention" data-user-email="scott@frak.ms" data-user-id="5233">@Scott Russell</span> I think this is the same APNS issue that you (I think) reported earlier.</p>



<a name="499090"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/499090" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Russell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#499090">(Feb 14 2018 at 12:51)</a>:</h4>
<p>Apple Push Notifications? I haven’t tried to config them. I’ll make sure they are disable in my config.</p>



<a name="499200"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/499200" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrik <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#499200">(Feb 14 2018 at 14:11)</a>:</h4>
<p>I'm experiencing the same issue on my new installation (it was setup yesterday), but I don't have any bots set up in my installation so far</p>



<a name="499789"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/499789" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#499789">(Feb 14 2018 at 16:42)</a>:</h4>
<p><span class="user-mention" data-user-email="scott@frak.ms" data-user-id="5233">@Scott Russell</span> Yeah, the issue is that when a notification was generated, if the server wasn't configured to send it via the <a href="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html">bouncer service</a>, it would attempt to send it through APNs directly. Which would fail if no credentials for that were configured.</p>
<p>The correct logic is of course to attempt to send through APNs only if <em>that's</em> configured. And if the server has credentials configured for neither APNs nor the bouncer, then drop the notification on the floor (separate codepaths will independently handle email notifications, and browser/desktop notifications) and maybe log a warning. That fix only happened last week in master, as 7f6a1714a.</p>



<a name="499795"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/499795" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#499795">(Feb 14 2018 at 16:44)</a>:</h4>
<p>For most users, the preferred workaround is to just <a href="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html">set up the bouncer service</a> <span class="emoji emoji-1f601" title="grin">:grin:</span> -- then you get mobile push notifications, and you don't get this error. If you won't be doing that, this error is harmless; if you want to get it out of your log, you can upgrade to a recent master, or maybe cherry-pick that fix.</p>



<a name="499796"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/499796" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#499796">(Feb 14 2018 at 16:45)</a>:</h4>
<p><span class="user-mention" data-user-email="patrikm87@gmail.com" data-user-id="5344">@Patrik</span> ^</p>



<a name="499798"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/499798" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#499798">(Feb 14 2018 at 16:46)</a>:</h4>
<p>(Looks like the previous report was <a href="#narrow/stream/issues/subject/h2.20exception.20in.20APN.20send/near/491013" title="#narrow/stream/issues/subject/h2.20exception.20in.20APN.20send/near/491013">here</a>, not by Scott but by Maarten Rijke.)</p>



<a name="500000"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/500000" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Russell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#500000">(Feb 14 2018 at 18:01)</a>:</h4>
<p>Thanks all. So I understand the issue now. I think part of the bug might be that with the services disabled in config users can still pick to use Moible notifications in the UI? Is part of the fix 7f6a1714a to disable mobile notifications in the UI if the APNS/bouncer are not configured?</p>



<a name="500019"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/500019" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#500019">(Feb 14 2018 at 18:04)</a>:</h4>
<p>I think that fix is just for the traceback and doesn't include such a concept, but you make a good point that we probably should do something there to hide the option from users or display a warning?  (We're not aware of many sites that don't use the push bouncer.).</p>



<a name="500021"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/500021" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#500021">(Feb 14 2018 at 18:04)</a>:</h4>
<p>I'm curious what Greg thinks.</p>



<a name="500052"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/500052" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#500052">(Feb 14 2018 at 18:12)</a>:</h4>
<p>Yeah, it'd be reasonable to have some UI to warn users in the case where the server admin has chosen not to set up notifications.</p>
<p>I think actually the most important surface for that is probably in the mobile app itself -- we have <a href="https://github.com/zulip/zulip-mobile/pull/1507" target="_blank" title="https://github.com/zulip/zulip-mobile/pull/1507">#M1507</a> for that, which I think will happen soon. If you don't have the mobile app, you won't expect mobile notifications anyway, and if you do install a mobile app for a chat service, then you probably are expecting push notifications unless you've seen a specific reason not to.</p>



<a name="500057"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/500057" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#500057">(Feb 14 2018 at 18:14)</a>:</h4>
<p>But it'd also make sense to hide that UI in the settings screen, or maybe gray it out with a little info tooltip.</p>
<p>Since <a href="https://github.com/zulip/zulip/commit/ecbc72b857aa9ead4ca2458a9ea2c9ab000dc57a" target="_blank" title="https://github.com/zulip/zulip/commit/ecbc72b857aa9ead4ca2458a9ea2c9ab000dc57a">ecbc72b85</a> there's a single function in the code which returns the boolean you'd want to control that UI, so this should be a simple change for someone to do.</p>



<a name="500120"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/500120" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Russell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#500120">(Feb 14 2018 at 18:36)</a>:</h4>
<p>FYI. Requested bouncer setup. I'm curious if it will work for us since our instance is not accessible from the Internet without VPN.</p>



<a name="500243"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/500243" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrik <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#500243">(Feb 14 2018 at 20:02)</a>:</h4>
<p><span class="user-mention" data-user-email="greg@zulipchat.com" data-user-id="2187">@Greg Price</span> thanks for the info, I'll probably just live with the messages in the log until the fix is pushed out in a future release :-)</p>



<a name="500336"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/500336" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#500336">(Feb 14 2018 at 20:31)</a>:</h4>
<p><span class="user-mention" data-user-email="scott@frak.ms" data-user-id="5233">@Scott Russell</span> just FYI, the push bouncer will work fine as long as your server can do outgoing HTTPS to <a href="http://push.zulipchat.com" target="_blank" title="http://push.zulipchat.com">push.zulipchat.com</a>.</p>



<a name="500418"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Max%20outbound%20streams%20is%201/near/500418" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rishi Gupta <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Max.20outbound.20streams.20is.201.html#500418">(Feb 14 2018 at 21:00)</a>:</h4>
<p>For the settings: I think greying out the setting with a tooltip explaining is probably the right stategy.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>