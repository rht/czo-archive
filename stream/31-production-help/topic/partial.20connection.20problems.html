<html>
<head><meta charset="utf-8"><title>partial connection problems · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html">partial connection problems</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="487865"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487865" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487865">(Feb 08 2018 at 09:24)</a>:</h4>
<p>We have a really interesting problem right now. <br>
4 clients (desktop and webapp) can't connect properly to our zulip server. The read message at the top props up and disappears again on a constant basis. The notifications don't work at all. When clicking on private messages they can click on another use and then see the last messages sent to them. But it won't update the narrow if messages are sent after click on a person. You have to click the person again and then it will update. Neither does it mark messages as read properly. <br>
all the other clients are working fine. A zulip server reboot didn't help it. <br>
How can a partial connection problem appear on only a few computers and not for everyone and then so out of the blue?</p>



<a name="487937"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487937" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487937">(Feb 08 2018 at 10:19)</a>:</h4>
<p>ok, more insight now (by now 5 people)<br>
I had one affected person login on a different PC. Same problem. Then I loggged in with my account and I had no problem at all. So it's not antivirus, network connection, workstation etc. related but somehow Zulip itself that can't connect to some user account. <br>
I hope this helps</p>



<a name="487943"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487943" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487943">(Feb 08 2018 at 10:21)</a>:</h4>
<p>If I don't hear back from anyone I will run an update from git master in 40-50 mintues to see if this has already been fixed.</p>



<a name="487951"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487951" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vishnu KS <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487951">(Feb 08 2018 at 10:25)</a>:</h4>
<p><span class="user-mention" data-user-email="matthiasmueller@protonmail.com" data-user-id="1646">@Matthias</span> Can you wait until Tim, Greg, Rishi or Steve shows up. I don't think it's a known issue so It would be helpful for them to have access to the server in the current state to debug this.</p>



<a name="487953"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487953" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vishnu KS <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487953">(Feb 08 2018 at 10:26)</a>:</h4>
<p>My bet is that this can probably fixed without an upgrade.</p>



<a name="487956"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487956" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487956">(Feb 08 2018 at 10:36)</a>:</h4>
<p>the only problem is that the server is only accessible through the LAN...</p>



<a name="487957"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487957" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487957">(Feb 08 2018 at 10:37)</a>:</h4>
<p>the only thing I can see is maybe teamviewer</p>



<a name="487958"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487958" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vishnu KS <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487958">(Feb 08 2018 at 10:38)</a>:</h4>
<p>Let me correct my statement. I didn't mean direct access. They can probably ask you to run some commands to debug the issue.</p>



<a name="487960"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487960" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487960">(Feb 08 2018 at 10:40)</a>:</h4>
<p>I see</p>



<a name="487961"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487961" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487961">(Feb 08 2018 at 10:41)</a>:</h4>
<p>ok then, I'll wait with the update but 5 people can't really use Zulip now</p>



<a name="487964"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487964" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487964">(Feb 08 2018 at 10:49)</a>:</h4>
<p>update: 6 people now disconnected...</p>



<a name="487972"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487972" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vishnu KS <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487972">(Feb 08 2018 at 10:53)</a>:</h4>
<p><span class="user-mention" data-user-email="greg@zulipchat.com" data-user-id="2187">@Greg Price</span> <span class="user-mention" data-user-email="showell@zulipchat.com" data-user-id="58">@Steve Howell</span> <span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> <span class="user-mention" data-user-email="rishig@zulipchat.com" data-user-id="131">@Rishi Gupta</span>  FYI</p>



<a name="487982"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/487982" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Pan <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#487982">(Feb 08 2018 at 10:59)</a>:</h4>
<p>Currently 3AM in our timezone. Will have to wait a couple hours (~4)  at least.</p>



<a name="488089"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488089" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Russell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488089">(Feb 08 2018 at 12:21)</a>:</h4>
<p>Can you check the web browser JS console for errors? I saw something like this on testing in 1.7.1. There were JS errors in the client about an invalid regex.</p>



<a name="488499"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488499" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488499">(Feb 08 2018 at 16:42)</a>:</h4>
<p>will be offline for an hour or so...</p>



<a name="488765"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488765" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488765">(Feb 08 2018 at 19:07)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> Hi, pinging you again as it's kinda a blocker for those affected.</p>



<a name="488822"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488822" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488822">(Feb 08 2018 at 19:28)</a>:</h4>
<p><span class="user-mention" data-user-email="matthiasmueller@protonmail.com" data-user-id="1646">@Matthias</span> Would you paste a copy of your <code>/var/log/zulip/errors.log</code>? That will have any errors the server is hitting with those users.</p>



<a name="488825"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488825" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488825">(Feb 08 2018 at 19:28)</a>:</h4>
<p>Also</p>
<blockquote>
<p>The read message at the top props up and disappears again on a constant basis.</p>
</blockquote>
<p>What message exactly are you/they getting?</p>



<a name="488829"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488829" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488829">(Feb 08 2018 at 19:30)</a>:</h4>
<p>while looking for the logs I can say this: when the server is offline there is the read pop down message at the top of the web app. That's what appears.</p>



<a name="488833"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488833" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488833">(Feb 08 2018 at 19:30)</a>:</h4>
<p>notifications don't work at all but if the user manually selects a PM or stream they will see the latest messages. The red warning also sporadically disappears.</p>



<a name="488845"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488845" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488845">(Feb 08 2018 at 19:33)</a>:</h4>
<p>Sorry, I'm still not sure which message you mean -- is it the "couldn't connect to server" message, or something else?</p>



<a name="488848"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488848" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488848">(Feb 08 2018 at 19:33)</a>:</h4>
<p>i.e. what is the message text?</p>



<a name="488855"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488855" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488855">(Feb 08 2018 at 19:34)</a>:</h4>
<p><a href="/user_uploads/2/2f/Xry3qfZyOf43UwppSucceupk/pasted_image.png" target="_blank" title="pasted_image.png">pasted image</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/2f/Xry3qfZyOf43UwppSucceupk/pasted_image.png" target="_blank" title="pasted image"><img src="/user_uploads/2/2f/Xry3qfZyOf43UwppSucceupk/pasted_image.png"></a></div>



<a name="488867"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488867" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488867">(Feb 08 2018 at 19:37)</a>:</h4>
<p>oh, error log is 89MB... need to trucate a bit first.</p>



<a name="488873"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488873" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488873">(Feb 08 2018 at 19:38)</a>:</h4>
<p>Sure</p>
<p>And thanks for the screenshot!</p>



<a name="488879"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488879" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488879">(Feb 08 2018 at 19:39)</a>:</h4>
<p>oh man, the error log has &gt; 1M lines and 99% of them are from the last two days</p>



<a name="488893"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488893" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488893">(Feb 08 2018 at 19:42)</a>:</h4>
<p>the below seems to be repeating every few seconds. This one is one of the first. </p>
<div class="codehilite"><pre><span></span>2018-02-07 14:24:44.593 ERR  [] Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/base.py&quot;, line 185, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zulip-py3-venv/lib/python3.5/site-packages/django/views/decorators/csrf.py&quot;, line 58, in wrapped_view
    return view_func(*args, **kwargs)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/lib/rest.py&quot;, line 124, in rest_dispatch
    return target_function(request, **kwargs)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/decorator.py&quot;, line 507, in _wrapped_view_func
    return view_func(request, *args, **kwargs)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zulip-py3-venv/lib/python3.5/site-packages/django/utils/decorators.py&quot;, line 149, in _wrapped_view
    response = view_func(request, *args, **kwargs)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/decorator.py&quot;, line 543, in _wrapped_view_func
    return authenticate_log_and_execute_json(request, view_func, *args, **kwargs)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/decorator.py&quot;, line 525, in authenticate_log_and_execute_json
    return rate_limit()(view_func)(request, user_profile, *args, **kwargs)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/decorator.py&quot;, line 686, in wrapped_func
    return func(request, *args, **kwargs)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/lib/request.py&quot;, line 170, in _wrapped_view_func
    return view_func(request, *args, **kwargs)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/views/messages.py&quot;, line 1017, in send_message_backend
    local_id=local_id, sender_queue_id=queue_id)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/lib/actions.py&quot;, line 1692, in check_send_message
    return do_send_messages([message])[0]
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/lib/actions.py&quot;, line 1184, in do_send_messages
    wide_message_dict = MessageDict.wide_dict(message[&#39;message&#39;])
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/lib/message.py&quot;, line 138, in wide_dict
    json = message_to_dict_json(message)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/lib/cache.py&quot;, line 163, in func_with_caching
    cache_set(key, val, cache_name=cache_name, timeout=timeout)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zerver/lib/cache.py&quot;, line 174, in cache_set
    cache_backend.set(KEY_PREFIX + key, (val,), timeout=timeout)
  File &quot;/home/zulip/deployments/2018-01-22-22-48-38/zulip-py3-venv/lib/python3.5/site-packages/django/core/cache/backends/memcached.py&quot;, line 86, in set
    if not self._cache.set(key, value, self.get_backend_timeout(timeout)):
pylibmc.TooBig
</pre></div>



<a name="488909"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488909" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488909">(Feb 08 2018 at 19:50)</a>:</h4>
<p>Huh!</p>



<a name="488911"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488911" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488911">(Feb 08 2018 at 19:50)</a>:</h4>
<p>Well, that's an error from memcached, then</p>



<a name="488912"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488912" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488912">(Feb 08 2018 at 19:50)</a>:</h4>
<p>Sounds like it's saying that we're trying to store a value that is bigger than the memcache server can accommodate</p>



<a name="488915"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488915" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488915">(Feb 08 2018 at 19:51)</a>:</h4>
<p>Maybe a giant message? Looks like it's trying to fetch a message</p>



<a name="488936"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488936" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488936">(Feb 08 2018 at 19:57)</a>:</h4>
<p>Can that be deleted? How can I find that message? The problem spread from 3 or so to 6 people.</p>



<a name="488937"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/488937" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#488937">(Feb 08 2018 at 19:58)</a>:</h4>
<p>Also if we find the message, you guys and program something that prevents the problem from happening again.</p>



<a name="489002"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489002" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489002">(Feb 08 2018 at 20:30)</a>:</h4>
<p><span class="user-mention" data-user-email="matthiasmueller@protonmail.com" data-user-id="1646">@Matthias</span> looking into this now.</p>



<a name="489064"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489064" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489064">(Feb 08 2018 at 20:47)</a>:</h4>
<p>So, this trace is super interesting.</p>



<a name="489066"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489066" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489066">(Feb 08 2018 at 20:47)</a>:</h4>
<p>It's getting this error message in the <code>send_message</code> code path, when trying to store the message in the cache.</p>



<a name="489069"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489069" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489069">(Feb 08 2018 at 20:48)</a>:</h4>
<p>It seems pretty unlikely that the message object itself is over the 1MB limit for message size (given that we have a 10KB limit on how big the input could be), though I could imagine some crazy corner case where the rendered markdown was 100x bigger than the original content.</p>



<a name="489071"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489071" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489071">(Feb 08 2018 at 20:49)</a>:</h4>
<p>I wouldn't expect this to be the traceback if memcached were full and somehow not handling it well, but it's probably worth trying that possiblity first -- <span class="user-mention" data-user-email="matthiasmueller@protonmail.com" data-user-id="1646">@Matthias</span> you should restart memcached and then the Zulip server and see if the problem goes away.</p>



<a name="489076"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489076" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489076">(Feb 08 2018 at 20:50)</a>:</h4>
<p>What's the command to restart memcached?<br>
Btw earlier today I rebooted the entire VM... Didn't help</p>



<a name="489123"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489123" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489123">(Feb 08 2018 at 20:57)</a>:</h4>
<p>Rebooting the VM would definitely achieve what restarting memcached would.</p>



<a name="489124"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489124" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489124">(Feb 08 2018 at 20:58)</a>:</h4>
<p>If you run <code>top</code> to look at memory usage, does it appear the machine is starved for memory?</p>



<a name="489125"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489125" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489125">(Feb 08 2018 at 20:58)</a>:</h4>
<p>i've given it 10GB of RAM... (but checking anyway)</p>



<a name="489145"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489145" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489145">(Feb 08 2018 at 21:04)</a>:</h4>
<p><a href="/user_uploads/2/c7/vNIoRMfS2Rhmv8rYpqOfjwRY/pasted_image.png" target="_blank" title="pasted_image.png">top</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/c7/vNIoRMfS2Rhmv8rYpqOfjwRY/pasted_image.png" target="_blank" title="top"><img src="/user_uploads/2/c7/vNIoRMfS2Rhmv8rYpqOfjwRY/pasted_image.png"></a></div>



<a name="489147"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489147" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489147">(Feb 08 2018 at 21:04)</a>:</h4>
<p>Definitely not a RAM shortage.</p>



<a name="489847"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489847" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489847">(Feb 09 2018 at 08:01)</a>:</h4>
<p>to keep others interested in the loop: Tim did some remote debugging yesterday his guess so far is that it might be a message that was inflated by markdown to go way beyond the 10Kbyte limit. <br>
I asked the affected people whether they share a stream and it looks like it. <br>
This means the number of people affected hasn't increased. It's just that I learnt about them one by one. It's 7 people but in the end 9 might be affected by it (private stream).</p>



<a name="489849"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489849" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489849">(Feb 09 2018 at 08:02)</a>:</h4>
<p><em>Can anyone help me create a postgres user that I can use to access the db from another client?</em> I'd prefer a GUI to browse the messages table to find that culprid message and then delete it with the manage.py dbshell</p>



<a name="489921"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489921" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489921">(Feb 09 2018 at 09:30)</a>:</h4>
<p>i was able to fix it.</p>



<a name="489922"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489922" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489922">(Feb 09 2018 at 09:30)</a>:</h4>
<p><span class="emoji emoji-1f389" title="tada">:tada:</span></p>



<a name="489926"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489926" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vishnu KS <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489926">(Feb 09 2018 at 09:34)</a>:</h4>
<p><span class="user-mention" data-user-email="matthiasmueller@protonmail.com" data-user-id="1646">@Matthias</span> Did the issue got fixed by deleting the message?</p>



<a name="489927"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489927" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489927">(Feb 09 2018 at 09:34)</a>:</h4>
<p>the message in question didn't contain much in the unrendered column of the database. It was a .pdf link on the web. But the rendered content was 3,500,000 characters that blocked memcached and subsequently the stream for all 9 subscribers.</p>



<a name="489929"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489929" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489929">(Feb 09 2018 at 09:35)</a>:</h4>
<p>yes, I deleted the message with <code>/home/zulip/deployments/current/manage.py shell</code><br>
then <br>
<code>Message.objects.get(1234).delete()</code></p>



<a name="489930"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489930" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489930">(Feb 09 2018 at 09:36)</a>:</h4>
<p>but first I had to create a prosgres user and enable external access to use a db manager (DBeaver) from my windows workstation (couldn't face doing this thorugh the CLI)<br>
then queried the <code>zerver_message</code> table with <code>length(rendered_content) &gt; 100000</code></p>



<a name="489931"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489931" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489931">(Feb 09 2018 at 09:39)</a>:</h4>
<p>immediately when I deleted the message the users affected got 'free'</p>



<a name="489957"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/489957" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Russell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#489957">(Feb 09 2018 at 10:37)</a>:</h4>
<p>Are URL previews enabled for this realm? If so would disabling url previews have prevented this? </p>
<p>Not a fix. More of me trying to understand how the rendered content became so large.</p>



<a name="490454"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490454" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490454">(Feb 09 2018 at 16:47)</a>:</h4>
<p>I think it's almost certainly from the URL previews feature.</p>



<a name="490455"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490455" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490455">(Feb 09 2018 at 16:47)</a>:</h4>
<p>But we'll be able to confirm after trying to reproduce in a development environment.</p>



<a name="490842"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490842" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490842">(Feb 09 2018 at 19:52)</a>:</h4>
<p>Fascinating. Thanks <span class="user-mention" data-user-email="matthiasmueller@protonmail.com" data-user-id="1646">@Matthias</span> for the report and the debugging!</p>



<a name="490852"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490852" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490852">(Feb 09 2018 at 19:55)</a>:</h4>
<p>We should impose a limit on the size of rendered messages -- if it's going to go over say 2x the limit on the unrendered size, truncate. (With a bit of care to avoid unclosed HTML tags; probably just throw away any element that wants to span the boundary, i.e. throw away any unclosed tags at the limit and everything after them.)</p>



<a name="490856"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490856" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490856">(Feb 09 2018 at 19:56)</a>:</h4>
<p>There's probably also something we can improve in the URL previews feature to make it less likely to hit that limit; if the limit comes into effect, you're probably not going to have a super great user experience on that message anyway, it just bounds how bad it can get.</p>



<a name="490863"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490863" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490863">(Feb 09 2018 at 20:00)</a>:</h4>
<p>At Dropbox I ran the team that among other things was responsible for our Phabricator install (a code-review tool), and there were a number of edge-case bugs where if you sent a gigantic diff (for some enormous generated network-config files, say) the page wouldn't load; or if you sent a small diff one way but then a big diff at a different stage, it'd get past that but there'd be a perennially-failing task trying to render a notification email, or store something in the database, etc., etc. This bug is a lot like those, where the message came in under a limit we checked for but then ballooned later.</p>



<a name="490869"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490869" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490869">(Feb 09 2018 at 20:01)</a>:</h4>
<p>Part of fixing that class of bug is to limit the size of an item again at every step where something nontrivial has changed or been done to it -- like our markdown rendering :)</p>



<a name="490889"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490889" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490889">(Feb 09 2018 at 20:08)</a>:</h4>
<p><span class="user-mention" data-user-email="greg@zulipchat.com" data-user-id="2187">@Greg Price</span> I had the same idea: already resolved via <a href="https://github.com/zulip/zulip/commit/77addc5456c3e61062bd3615d1ec0d33bb105a90" target="_blank" title="https://github.com/zulip/zulip/commit/77addc5456c3e61062bd3615d1ec0d33bb105a90">77addc5456c3e61062bd3615d1ec0d33bb105a90</a></p>



<a name="490890"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490890" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490890">(Feb 09 2018 at 20:09)</a>:</h4>
<p>Great <span class="emoji emoji-1f600" title="grinning">:grinning:</span></p>



<a name="490891"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490891" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490891">(Feb 09 2018 at 20:09)</a>:</h4>
<p>There's a second bug here (with the URL previews feature; it appears with certain PDF files it seems to end up putting the entire PDF file into the message body)</p>



<a name="490892"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490892" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490892">(Feb 09 2018 at 20:09)</a>:</h4>
<p>Yep -- this basically had to mean an issue in the previews feature too</p>



<a name="490894"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/partial%20connection%20problems/near/490894" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/partial.20connection.20problems.html#490894">(Feb 09 2018 at 20:10)</a>:</h4>
<p>Ha, you even picked the same threshold (2x raw-length limit) I suggested.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>