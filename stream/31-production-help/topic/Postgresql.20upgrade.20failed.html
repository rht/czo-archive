<html>
<head><meta charset="utf-8"><title>Postgresql upgrade failed · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html">Postgresql upgrade failed</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1037472"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037472" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037472">(Oct 14 2020 at 17:04)</a>:</h4>
<p>I started with Zulip 2.1.4 on Ubuntu 18.04.  I upgraded to Zulip 3.2.0 with no problems.  I attempted the Postgresql upgrade instructions but it failed:</p>
<blockquote>
<p>Stopping old cluster...<br>
Error: no initdb program for version 13 found<br>
Error: Could not create target cluster<br>
++ grep -o '/var/log/postgresql/pg_upgradecluster-10-12-main.*' /var/log/zulip/postgres-upgrade-10-12.tQt4icuF8.log<br>
++ true</p>
<ul>
<li>SCRIPTS_PATH=</li>
<li>crudini --set /etc/zulip/zulip.conf postgresql version 12</li>
<li>'[' -n '' ']'</li>
<li>/home/zulip/deployments/current/scripts/setup/../../scripts/zulip-puppet-apply -f<br>
Notice: Compiled catalog for <a href="http://zulip.victorygin.net">zulip.victorygin.net</a> in environment production in 1.95 seconds<br>
Notice: /Stage[main]/Zulip::Apt_repository/Exec[setup_apt_repo]/returns: executed successfully<br>
Notice: /Stage[main]/Zulip::Postgres_appdb_tuned/File[/etc/postgresql/12]/ensure: created<br>
Notice: /Stage[main]/Zulip::Postgres_appdb_tuned/File[/etc/postgresql/12/main]/ensure: created<br>
Notice: /Stage[main]/Zulip::Postgres_appdb_tuned/File[/etc/postgresql/12/main/postgresql.conf]/ensure: defined content as '{md5}c50bb96ed8d54cb56522491131e80133'<br>
Notice: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[pg_ctlcluster 12 main restart]/returns: Error: /var/lib/postgresql/12/main is not accessible or does not exist<br>
Error: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[pg_ctlcluster 12 main restart]: Failed to call refresh: 'pg_ctlcluster 12 main restart' returned 1 instead of one of [0]<br>
Error: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[pg_ctlcluster 12 main restart]: 'pg_ctlcluster 12 main restart' returned 1 instead of one of [0]<br>
Notice: Applied catalog in 0.75 seconds</li>
</ul>
</blockquote>
<p>Zulip was stlil working but seeming still using Postgresql 10.  I then followed the instructions to upgrade to Ubuntu 20.04.  This worked as well but still left me on Postgresql 10.  If I try the Postgresql upgrade again it says I'm already on 12.  The processes running, however, still indicate Postgresql 10:</p>
<blockquote>
<p>postgres   43932  0.0  1.5 634600 63928 ?        S    11:41   0:00 /usr/lib/postgresql/10/bin/postgres -D /var/lib/postgresql/10/main -c config_file=/etc/postgresql/10/main/postgresql.conf<br>
postgres   43933  0.0  0.1  68472  4460 ?        Ss   11:41   0:00  \_ postgres: 10/main: logger process<br>
postgres   43935  0.0  0.6 634728 24524 ?        Ss   11:41   0:00  \_ postgres: 10/main: checkpointer process<br>
postgres   43936  0.0  0.2 634860  9796 ?        Ss   11:41   0:00  \_ postgres: 10/main: writer process<br>
postgres   43937  0.0  0.2 634600 10068 ?        Ss   11:41   0:00  \_ postgres: 10/main: wal writer process<br>
postgres   43938  0.0  0.2 635712  8432 ?        Ss   11:41   0:00  \_ postgres: 10/main: autovacuum launcher process<br>
postgres   43939  0.0  0.1  68872  5116 ?        Ss   11:41   0:00  \_ postgres: 10/main: stats collector process<br>
postgres   43940  0.0  0.1 635556  7132 ?        Ss   11:41   0:00  \_ postgres: 10/main: bgworker: logical replication launcher<br>
postgres   52060  0.0  0.5 639436 20084 ?        Ss   11:49   0:00  \_ postgres: 10/main: zulip zulip [local] idle</p>
</blockquote>
<p>Zulip is working fine but I'd like to fix this Postgresql issue.  Would it be easier to migrate to a fresh server?  This one started with Zulip 1.x and Ubuntu 16.04.</p>



<a name="1037509"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037509" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037509">(Oct 14 2020 at 17:51)</a>:</h4>
<p><span class="user-mention" data-user-id="15987">@J.R. Lillard</span> I don't think migrating to a fresh server can help.</p>



<a name="1037510"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037510" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037510">(Oct 14 2020 at 17:51)</a>:</h4>
<p>Did you read <a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-postgresql">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-postgresql</a> ?</p>



<a name="1037588"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037588" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037588">(Oct 14 2020 at 18:15)</a>:</h4>
<p>Yes.  Those are the directions I followed.</p>



<a name="1037618"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037618" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037618">(Oct 14 2020 at 18:48)</a>:</h4>
<p>Oh, I think the bug is fixed in the 3.x branch, i.e. the changes staged for the 3.3 release.  Can you try <code>upgrade-zulip-from-git 3.x</code> and see if that fixed it?</p>



<a name="1037619"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037619" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037619">(Oct 14 2020 at 18:48)</a>:</h4>
<p>(The issue is just that postgres 13 now exists and there's a bug in the upgrade tool in that setting)</p>



<a name="1037620"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037620" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037620">(Oct 14 2020 at 18:48)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> this may be a good reason to do a 3.3 release this week.</p>



<a name="1037630"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037630" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037630">(Oct 14 2020 at 19:19)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> That did not go so well:</p>
<blockquote>
<ul>
<li>./tools/webpack --quiet<br>
Ignoring local source map at "/home/zulip/deployments/2020-10-14-14-13-18/&lt;no source&gt;" as resource is missing.</li>
</ul>
<p>Error running a subcommand of ./tools/update-prod-static: ./tools/webpack --quiet<br>
Actual error output for the subcommand is just above this.</p>
</blockquote>



<a name="1037649"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037649" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037649">(Oct 14 2020 at 20:23)</a>:</h4>
<p><span class="user-mention" data-user-id="15987">@J.R. Lillard</span>: Can you post the full logs, in triple-backticks?</p>



<a name="1037650"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037650" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037650">(Oct 14 2020 at 20:27)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> </p>
<div class="codehilite"><pre><span></span><code>root@zulip:~# /home/zulip/deployments/current/scripts/upgrade-zulip-from-git 3.x
2020-10-14 20:26:37,350 upgrade-zulip-from-git: Fetching the latest commits
2020-10-14 20:26:40,586 upgrade-zulip-stage-2: Upgrading system packages...
Hit:1 http://mirrors.linode.com/ubuntu focal InRelease
Hit:2 http://mirrors.linode.com/ubuntu focal-updates InRelease
Hit:3 http://mirrors.linode.com/ubuntu focal-backports InRelease
Get:4 http://security.ubuntu.com/ubuntu focal-security InRelease [107 kB]
Hit:5 http://ppa.launchpad.net/groonga/ppa/ubuntu focal InRelease
Hit:6 http://apt.postgresql.org/pub/repos/apt focal-pgdg InRelease
Get:7 http://security.ubuntu.com/ubuntu focal-security/main amd64 Packages [338 kB]
Get:8 http://security.ubuntu.com/ubuntu focal-security/main i386 Packages [138 kB]
Get:9 http://security.ubuntu.com/ubuntu focal-security/universe amd64 Packages [506 kB]
Get:10 http://security.ubuntu.com/ubuntu focal-security/universe i386 Packages [405 kB]
Fetched 1,493 kB in 1s (1,279 kB/s)
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
Calculating upgrade...
The following package was automatically installed and is no longer required:
  libreadline7
Use &#39;apt autoremove&#39; to remove it.
The following packages have been kept back:
  postgresql-12
0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.
+ apt-get -y install build-essential libffi-dev libfreetype6-dev zlib1g-dev libjpeg-dev libldap2-dev python3-dev python3-pip virtualenv libxml2-dev libxslt1-dev libpq-dev libssl-dev libmagic1 libxmlsec1-dev pkg-config jq libsasl2-dev
Reading package lists...
Building dependency tree...
Reading state information...
build-essential is already the newest version (12.8ubuntu1).
libffi-dev is already the newest version (3.3-4).
libfreetype6-dev is already the newest version (2.10.1-2).
libjpeg-dev is already the newest version (8c-2ubuntu8).
libmagic1 is already the newest version (1:5.38-4).
libsasl2-dev is already the newest version (2.1.27+dfsg-2).
libssl-dev is already the newest version (1.1.1f-1ubuntu2).
libxml2-dev is already the newest version (2.9.10+dfsg-5).
libxmlsec1-dev is already the newest version (1.2.28-2).
libxslt1-dev is already the newest version (1.1.34-4).
pkg-config is already the newest version (0.29.1-0ubuntu4).
python3-dev is already the newest version (3.8.2-0ubuntu2).
jq is already the newest version (1.6-1).
virtualenv is already the newest version (20.0.17-1).
libldap2-dev is already the newest version (2.4.49+dfsg-2ubuntu1.3).
zlib1g-dev is already the newest version (1:1.2.11.dfsg-2ubuntu1.1).
python3-pip is already the newest version (20.0.2-5ubuntu1.1).
libpq-dev is already the newest version (13.0-1.pgdg20.04+1).
The following package was automatically installed and is no longer required:
  libreadline7
Use &#39;apt autoremove&#39; to remove it.
0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.
Using cached Python venv from /srv/zulip-venv-cache/aef0b5d0dd2a4cb2b6b5efdb3152dfe9d531f149/zulip-py3-venv
+ ln -nsf /srv/zulip-venv-cache/aef0b5d0dd2a4cb2b6b5efdb3152dfe9d531f149/zulip-py3-venv /home/zulip/deployments/2020-10-14-15-26-37/zulip-py3-venv
+ apt-get -y install libcurl4-openssl-dev libjpeg-dev zlib1g-dev libfreetype6-dev libpng-dev gifsicle
Reading package lists...
Building dependency tree...
Reading state information...
libfreetype6-dev is already the newest version (2.10.1-2).
libjpeg-dev is already the newest version (8c-2ubuntu8).
libpng-dev is already the newest version (1.6.37-2).
gifsicle is already the newest version (1.92-2).
libcurl4-openssl-dev is already the newest version (7.68.0-1ubuntu2.2).
zlib1g-dev is already the newest version (1:1.2.11.dfsg-2ubuntu1.1).
The following package was automatically installed and is no longer required:
  libreadline7
Use &#39;apt autoremove&#39; to remove it.
0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.
Using cached Python venv from /srv/zulip-venv-cache/af03b2dd82449ed7b23b8a55843857f7b0b260e8/zulip-thumbor-venv
+ ln -nsf /srv/zulip-venv-cache/af03b2dd82449ed7b23b8a55843857f7b0b260e8/zulip-thumbor-venv /home/zulip/deployments/2020-10-14-15-26-37/zulip-thumbor-venv
v12.18.2 is already installed.
Now using node v12.18.2 (npm v6.14.5)
default -&gt; 12.18.2 (-&gt; v12.18.2)
Installing Yarn!
Yarn is already at the 1.22.4 version.
generate_secrets: No new secrets to generate.
2020-10-14 20:26:52,607 upgrade-zulip-stage-2: Building static assets...
Using cached node modules from /srv/zulip-npm-cache/34c029af70b5991510af6d2a74087645b48f04cf/node_modules
+ ./tools/setup/emoji/build_emoji
build_emoji: Using cached emojis from /srv/zulip-emoji-cache/44d969948deb16ed0d3711c14028bb8cc6546488/emoji
+ ./scripts/setup/inline_email_css.py
+ ./tools/setup/generate_zulip_bots_static_files.py
+ ./tools/setup/build_pygments_data
+ ./tools/webpack --quiet
Ignoring local source map at &quot;/home/zulip/deployments/2020-10-14-15-26-37/&lt;no source&gt;&quot; as resource is missing.

Error running a subcommand of ./tools/update-prod-static: ./tools/webpack --quiet
Actual error output for the subcommand is just above this.

Traceback (most recent call last):
  File &quot;./tools/update-prod-static&quot;, line 48, in &lt;module&gt;
    run([&#39;./tools/webpack&#39;, &#39;--quiet&#39;])
  File &quot;./tools/../scripts/lib/zulip_tools.py&quot;, line 198, in run
    subprocess.check_call(args, **kwargs)
  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 364, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./tools/webpack&#39;, &#39;--quiet&#39;]&#39; died with &lt;Signals.SIGKILL: 9&gt;.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2020-10-14-15-26-37/scripts/lib/upgrade-zulip-stage-2&quot;, line 206, in &lt;module&gt;
    subprocess.check_call([&quot;./tools/update-prod-static&quot;, &quot;--prev-deploy&quot;,
  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 364, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./tools/update-prod-static&#39;, &#39;--prev-deploy&#39;, &#39;/home/zulip/deployments/current&#39;]&#39; returned non-zero exit status 1.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip-from-git&quot;, line 80, in &lt;module&gt;
    subprocess.check_call([os.path.join(deploy_path, &quot;scripts&quot;, &quot;lib&quot;, &quot;upgrade-zulip-stage-2&quot;),
  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 364, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2020-10-14-15-26-37/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2020-10-14-15-26-37&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1.
</code></pre></div>



<a name="1037651"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037651" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037651">(Oct 14 2020 at 20:29)</a>:</h4>
<p>Can you remove the <code>quote</code> after the triple-backticks?  Reading it without the formatting would be helpful. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1037652"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037652" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037652">(Oct 14 2020 at 20:32)</a>:</h4>
<p>Were you running 3.2 from git, or from release tarball, before?</p>



<a name="1037653"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037653" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037653">(Oct 14 2020 at 20:33)</a>:</h4>
<p>Release tarball</p>



<a name="1037654"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037654" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037654">(Oct 14 2020 at 20:35)</a>:</h4>
<p>Interesting.  Upgrading a test prod deploy to 3.x, I see:</p>
<div class="codehilite"><pre><span></span><code>[...]
+ ./tools/setup/emoji/build_emoji
Dumping emojis ...
Copying individual image files...
Copying individual image files...
Copying individual image files...
build_emoji: Using cached emojis from /srv/zulip-emoji-cache/44d969948deb16ed0d3711c14028bb8cc6546488/emoji
+ ./scripts/setup/inline_email_css.py
+ ./tools/setup/generate_zulip_bots_static_files.py
+ ./tools/setup/build_pygments_data
+ ./tools/webpack --quiet
Ignoring local source map at &quot;/home/zulip/deployments/2020-10-14-20-30-51/&lt;no source&gt;&quot; as resource is missing.
+ ./manage.py collectstatic --no-default-ignore -v0 --noinput -i assets -i emoji-styles -i html -i js -i styles -i templates
[continues]
</code></pre></div>



<a name="1037656"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037656" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037656">(Oct 14 2020 at 20:37)</a>:</h4>
<p>The "Ignoring local source map" is fixed in <a href="https://github.com/zulip/zulip/pull/15981">#15981</a> which is not on 3.x; but that should be only a warning, not an error.</p>



<a name="1037657"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037657" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037657">(Oct 14 2020 at 20:38)</a>:</h4>
<p>If you <code>cd /home/zulip/deployments/current &amp;&amp; ./tools/webpack --quiet; echo $?</code> what does that output?</p>



<a name="1037658"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037658" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037658">(Oct 14 2020 at 20:41)</a>:</h4>
<div class="codehilite"><pre><span></span><code>root@zulip:~# cd /home/zulip/deployments/current &amp;&amp; ./tools/webpack --quiet; echo $?
-bash: ./tools/webpack: No such file or directory
127
</code></pre></div>



<a name="1037660"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037660" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037660">(Oct 14 2020 at 20:45)</a>:</h4>
<p>Oh, the previous deploy failed, and the current deploy was from tarball and thus didn't ship webpack.  So <code>cd /home/zulip/deployments/next/ &amp;&amp; ./tools/webpack --quiet; echo $?</code></p>



<a name="1037664"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037664" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037664">(Oct 14 2020 at 20:49)</a>:</h4>
<div class="codehilite"><pre><span></span><code>root@zulip:/home/zulip/deployments/current# cd /home/zulip/deployments/next/ &amp;&amp; ./tools/webpack --quiet; echo $?
Ignoring local source map at &quot;/home/zulip/deployments/2020-10-14-15-26-37/&lt;no source&gt;&quot; as resource is missing.
Killed
137
</code></pre></div>



<a name="1037669"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037669" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037669">(Oct 14 2020 at 20:56)</a>:</h4>
<p>That's an OOM kill.</p>



<a name="1037670"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037670" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037670">(Oct 14 2020 at 20:56)</a>:</h4>
<p><code>supervisorctl stop all</code> first should help -- the tool does that for you but for this debugging you'll want to do it manually.</p>



<a name="1037675"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037675" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037675">(Oct 14 2020 at 20:59)</a>:</h4>
<div class="codehilite"><pre><span></span><code>root@zulip:/home/zulip/deployments/next# supervisorctl stop all
process-fts-updates: stopped
zulip-workers:zulip_deliver_enqueued_emails: stopped
zulip-workers:zulip_deliver_scheduled_messages: stopped
zulip-tornado: stopped
zulip-django: stopped
zulip-workers:zulip_events_deferred_work: stopped
zulip-workers:zulip_events_digest_emails: stopped
zulip-workers:zulip_events_outgoing_webhooks: stopped
zulip-workers:zulip_events_user_activity: stopped
zulip-workers:zulip_events_user_activity_interval: stopped
zulip-workers:zulip_events_user_presence: stopped
zulip-workers:zulip_events_embed_links: stopped
zulip-workers:zulip_events_signups: stopped
zulip-workers:zulip_events_email_mirror: stopped
zulip-workers:zulip_events_embedded_bots: stopped
zulip-workers:zulip_events_error_reports: stopped
zulip-workers:zulip_events_missedmessage_mobile_notifications: stopped
zulip-workers:zulip_events_invites: stopped
zulip-workers:zulip_events_email_senders: stopped
zulip-workers:zulip_events_missedmessage_emails: stopped
root@zulip:/home/zulip/deployments/next# cd /home/zulip/deployments/next/ &amp;&amp; ./tools/webpack --quiet; echo $?
Ignoring local source map at &quot;/home/zulip/deployments/2020-10-14-15-26-37/&lt;no source&gt;&quot; as resource is missing.
0
</code></pre></div>



<a name="1037676"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037676" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037676">(Oct 14 2020 at 21:01)</a>:</h4>
<p>That looks as expected -- that is, a success.  It may be worth running the upgrade-zulip-from-git command again to see if the failure is consistent, since thins seemed to go fine here.</p>
<p>I <em>suspect</em> to get postgres straightened out, we'll need to set the version to 10 in the config file, then run the postgres upgrade command again, but one thing at a time.</p>



<a name="1037677"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037677" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037677">(Oct 14 2020 at 21:03)</a>:</h4>
<p>I'll try the upgrade again</p>



<a name="1037679"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037679" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037679">(Oct 14 2020 at 21:06)</a>:</h4>
<p>No problem this time <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1037680"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037680" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037680">(Oct 14 2020 at 21:07)</a>:</h4>
<p>Now we can address the Postgresql issue?</p>



<a name="1037682"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037682" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037682">(Oct 14 2020 at 21:14)</a>:</h4>
<p>If you're 100% certain you're currently running against pg 10 (sounds like it, but verify again) then edit <code>/etc/zulip/zulip.conf</code> and set the <code>version</code> under<code>[postgres]</code> to 10, then go through <a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-postgresql">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-postgresql</a> again.</p>



<a name="1037683"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037683" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037683">(Oct 14 2020 at 21:15)</a>:</h4>
<div class="codehilite"><pre><span></span><code>root@zulip:~# ps faux | grep postgres
root      181709  0.0  0.0   6388   664 pts/0    S+   16:14   0:00          \_ grep --color=auto postgres
postgres   43932  0.0  0.7 634600 30056 ?        S    11:41   0:00 /usr/lib/postgresql/10/bin/postgres -D /var/lib/postgresql/10/main -c config_file=/etc/postgresql/10/main/postgresql.conf
postgres   43933  0.0  0.0  68472  1388 ?        Ss   11:41   0:00  \_ postgres: 10/main: logger process
postgres   43935  0.0  0.7 634988 28212 ?        Ss   11:41   0:00  \_ postgres: 10/main: checkpointer process
postgres   43936  0.0  0.2 634860  9804 ?        Ss   11:41   0:00  \_ postgres: 10/main: writer process
postgres   43937  0.0  0.1 634600  4072 ?        Ss   11:41   0:02  \_ postgres: 10/main: wal writer process
postgres   43938  0.0  0.0 635712  2772 ?        Ss   11:41   0:00  \_ postgres: 10/main: autovacuum launcher process
postgres   43939  0.0  0.0  68872   976 ?        Ss   11:41   0:01  \_ postgres: 10/main: stats collector process
postgres   43940  0.0  0.0 635556  1584 ?        Ss   11:41   0:00  \_ postgres: 10/main: bgworker: logical replication launcher
postgres  177675  0.0  0.4 639436 18868 ?        Ss   16:05   0:00  \_ postgres: 10/main: zulip zulip [local] idle
postgres  177734  0.0  0.8 641392 32248 ?        Ss   16:05   0:00  \_ postgres: 10/main: zulip zulip [local] idle
postgres  177753  0.0  0.5 640420 22688 ?        Ss   16:05   0:00  \_ postgres: 10/main: zulip zulip [local] idle
postgres  178155  0.0  0.5 639588 23012 ?        Ss   16:06   0:00  \_ postgres: 10/main: zulip zulip [local] idle
postgres  178159  0.0  0.5 639532 20460 ?        Ss   16:06   0:00  \_ postgres: 10/main: zulip zulip [local] idle
postgres  178162  0.0  0.4 639444 18760 ?        Ss   16:06   0:00  \_ postgres: 10/main: zulip zulip [local] idle
postgres  178163  0.0  0.4 639444 18976 ?        Ss   16:06   0:00  \_ postgres: 10/main: zulip zulip [local] idle
postgres  178200  0.0  0.5 639720 22660 ?        Ss   16:06   0:00  \_ postgres: 10/main: zulip zulip [local] idle
postgres  179082  0.0  0.9 642404 39256 ?        Ss   16:08   0:00  \_ postgres: 10/main: zulip zulip [local] idle
postgres  179089  0.0  0.5 640088 21496 ?        Ss   16:08   0:00  \_ postgres: 10/main: zulip zulip [local] idle
</code></pre></div>



<a name="1037684"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037684" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037684">(Oct 14 2020 at 21:17)</a>:</h4>
<p>Seems solid confirmation to me.</p>



<a name="1037685"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037685" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037685">(Oct 14 2020 at 21:18)</a>:</h4>
<p>Can you run <code>pg_lsclusters</code> for an additional datapoint?</p>



<a name="1037686"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037686" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037686">(Oct 14 2020 at 21:19)</a>:</h4>
<p>That worked!</p>
<div class="codehilite"><pre><span></span><code>root@zulip:~# ps faux | grep postgres
root      185541  0.0  0.0   6388   728 pts/0    S+   16:18   0:00          \_ grep --color=auto postgres
postgres  185295  0.2  1.6 636020 65440 ?        Ss   16:18   0:00 /usr/lib/postgresql/12/bin/postgres -D /var/lib/postgresql/12/main -c config_file=/etc/postgresql/12/main/postgresql.conf
postgres  185296  0.0  0.1  68804  4836 ?        Ss   16:18   0:00  \_ postgres: 12/main: logger
postgres  185298  0.0  0.1 636020  4460 ?        Ss   16:18   0:00  \_ postgres: 12/main: checkpointer
postgres  185299  0.0  0.1 636280  5948 ?        Ss   16:18   0:00  \_ postgres: 12/main: background writer
postgres  185300  0.0  0.2 636020 10076 ?        Ss   16:18   0:00  \_ postgres: 12/main: walwriter
postgres  185301  0.0  0.2 637264  8660 ?        Ss   16:18   0:00  \_ postgres: 12/main: autovacuum launcher
postgres  185302  0.0  0.1  69216  5496 ?        Ss   16:18   0:00  \_ postgres: 12/main: stats collector
postgres  185303  0.0  0.1 637104  6800 ?        Ss   16:18   0:00  \_ postgres: 12/main: logical replication launcher
postgres  185510  0.0  0.5 641292 21152 ?        Ss   16:18   0:00  \_ postgres: 12/main: zulip zulip [local] idle
</code></pre></div>



<a name="1037688"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037688" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037688">(Oct 14 2020 at 21:21)</a>:</h4>
<p>My understanding from the documentation is that Zulip is now managing the version of Postgresql installed instead of Ubuntu.  Is that correct?</p>



<a name="1037689"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037689" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037689">(Oct 14 2020 at 21:23)</a>:</h4>
<p>Yes and no.  We're using packages provided by PostgreSQL themselves, which are packages designed for Ubuntu.   All Zulip does is tell Ubuntu "look for these packages as well, and I'd like version 12 installed" and Ubuntu manages the rest.</p>



<a name="1037690"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037690" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037690">(Oct 14 2020 at 21:25)</a>:</h4>
<p>Okay.  So I can safely remove the 10 packages now?</p>
<div class="codehilite"><pre><span></span><code>root@zulip:~# apt list --installed | grep postgres

WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

check-postgres/focal-pgdg,now 2.25.0-1.pgdg20.04+1 all [installed]
postgresql-12/focal-pgdg,now 12.4-1.pgdg20.04+1 amd64 [installed]
postgresql-client-10/focal-pgdg,now 10.14-1.pgdg20.04+1 amd64 [installed]
postgresql-client-12/focal-pgdg,now 12.4-1.pgdg20.04+1 amd64 [installed,automatic]
postgresql-client-13/focal-pgdg,now 13.0-1.pgdg20.04+1 amd64 [installed,automatic]
postgresql-client-common/focal-pgdg,now 220.pgdg20.04+1 all [installed,automatic]
postgresql-client/focal-pgdg,now 13+220.pgdg20.04+1 all [installed]
postgresql-common/focal-pgdg,now 220.pgdg20.04+1 all [installed,automatic]
</code></pre></div>



<a name="1037691"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037691" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037691">(Oct 14 2020 at 21:25)</a>:</h4>
<p>Hm.  Quick check -- what did <code>/etc/zulip/zulip.conf</code> have in it for the psotgres version when you opened it?</p>



<a name="1037692"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037692" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037692">(Oct 14 2020 at 21:25)</a>:</h4>
<p>It was 12.  I changed it to 10.  Now it's back to 12.</p>



<a name="1037693"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037693" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037693">(Oct 14 2020 at 21:27)</a>:</h4>
<p>Interesting, that's not what I would expect from looking at the code.</p>



<a name="1037694"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037694" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037694">(Oct 14 2020 at 21:27)</a>:</h4>
<p>The only postgres-10 package there is the client.  You can uninstall that (<code>apt-get purge postgresql-client-10</code>) if you wish.</p>



<a name="1037695"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037695" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037695">(Oct 14 2020 at 21:30)</a>:</h4>
<p>Did your first message on this topic contain the whole logs of the failed <code>upgrade-postgres</code>?  If not, can you paste those into here?</p>



<a name="1037697"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037697" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037697">(Oct 14 2020 at 21:31)</a>:</h4>
<p>Aha, I think I see the problem; the <code>tee</code> is obscuring the failed exitcode from <code>pg_upgradecluster</code>.</p>



<a name="1037698"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037698" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037698">(Oct 14 2020 at 21:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Postgresql.20upgrade.20failed/near/1037694">said</a>:</p>
<blockquote>
<p>The only postgres-10 package there is the client.  You can uninstall that (<code>apt-get purge postgresql-client-10</code>) if you wish.</p>
</blockquote>
<p>What about the 13 client?  Is that being used by Zulip?</p>



<a name="1037699"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037699" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037699">(Oct 14 2020 at 21:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Postgresql.20upgrade.20failed/near/1037695">said</a>:</p>
<blockquote>
<p>Did your first message on this topic contain the whole logs of the failed <code>upgrade-postgres</code>?  If not, can you paste those into here?</p>
</blockquote>
<p>Yes but I didn't paste it correctly so the formatting was lost and I have since lost it from my scrollback buffer.</p>



<a name="1037700"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037700" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037700">(Oct 14 2020 at 21:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="15987">J.R. Lillard</span> <a href="#narrow/stream/31-production-help/topic/Postgresql.20upgrade.20failed/near/1037699">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Postgresql.20upgrade.20failed/near/1037695">said</a>:</p>
<blockquote>
<p>Did your first message on this topic contain the whole logs of the failed <code>upgrade-postgres</code>?  If not, can you paste those into here?</p>
</blockquote>
<p>Yes but I didn't paste it correctly so the formatting was lost and I have since lost it from my scrollback buffer.</p>
</blockquote>
<p>No worries -- it had enough to point to the problem and solution.</p>



<a name="1037701"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037701" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037701">(Oct 14 2020 at 21:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="15987">J.R. Lillard</span> <a href="#narrow/stream/31-production-help/topic/Postgresql.20upgrade.20failed/near/1037698">said</a>:</p>
<blockquote>
<p>What about the 13 client?  Is that being used by Zulip?</p>
</blockquote>
<p>No.  You can also uninstall that if you wish.</p>
<p>Really, as long as one <code>client</code> library exists, that's all the tooling needs.  It'd be nice to keep it lockstep with the server version, but that's not a strict requirement.</p>



<a name="1037705"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037705" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037705">(Oct 14 2020 at 21:43)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/pull/16540">#16540</a> will help in the future if there are other causes of pg_upgradecluster failure in the future.  <a href="https://github.com/zulip/zulip/commit/5de6f3523c891bc9b698bb58b7bc223f9ded8659">5de6f3523c891bc9b698bb58b7bc223f9ded8659</a>, which is what the upgrade to 3.x served to get you, addresses the specific problem.</p>



<a name="1037706"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037706" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037706">(Oct 14 2020 at 21:43)</a>:</h4>
<p>When I tried to purge postgresql-client-13 it wanted to take out postgresql-client so I declined</p>



<a name="1037707"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037707" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037707">(Oct 14 2020 at 21:44)</a>:</h4>
<p>Makes sense, in retrospect; the virtual package points to the most recent one.</p>



<a name="1037708"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Postgresql%20upgrade%20failed/near/1037708" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.R. Lillard <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Postgresql.20upgrade.20failed.html#1037708">(Oct 14 2020 at 21:44)</a>:</h4>
<p>I'll leave it alone now.  Thanks for your help.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>