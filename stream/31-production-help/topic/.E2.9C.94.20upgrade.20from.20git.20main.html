<html>
<head><meta charset="utf-8"><title>✔ upgrade from git main · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html">✔ upgrade from git main</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1313493"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313493" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313493">(Jan 21 2022 at 16:01)</a>:</h4>
<div class="codehilite"><pre><span></span><code>[2022-01-21 15:57:45,999 upgrade-zulip-stage-2: Applying database migrations...
Operations to perform:
  Apply all migrations: analytics, auth, confirmation, contenttypes, otp_static, otp_totp, sessions, social_django, two_factor, zerver
Running migrations:
  Applying zerver.0374_backfill_user_delete_realmauditlog...Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 84, in _execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zerver/lib/db.py&quot;, line 46, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zerver/lib/db.py&quot;, line 31, in wrapper_execute
    return action(sql, params)
psycopg2.errors.NotNullViolation: null value in column &quot;realm_id&quot; violates not-null constraint
DETAIL:  Failing row contains (1027, t, 2021-08-12 07:55:10.425405+00, 42, null, 42, null, null, null, 106).


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 157, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;./manage.py&quot;, line 122, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/__init__.py&quot;, line 413, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/base.py&quot;, line 398, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/base.py&quot;, line 89, in wrapped
    res = handle_func(*args, **kwargs)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/commands/migrate.py&quot;, line 246, in handle
    fake_initial=fake_initial,
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/migrations/executor.py&quot;, line 117, in migrate
    state = self._migrate_all_forwards(state, plan, full_plan, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/migrations/executor.py&quot;, line 147, in _migrate_all_forwards
    state = self.apply_migration(state, migration, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/migrations/executor.py&quot;, line 227, in apply_migration
    state = migration.apply(state, schema_editor)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/migrations/migration.py&quot;, line 126, in apply
    operation.database_forwards(self.app_label, schema_editor, old_state, project_state)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/migrations/operations/special.py&quot;, line 190, in database_forwards
    self.code(from_state.apps, schema_editor)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zerver/migrations/0374_backfill_user_delete_realmauditlog.py&quot;, line 25, in backfill_user_deleted_logs
    RealmAuditLog.objects.bulk_create(objects_to_create)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/manager.py&quot;, line 85, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/query.py&quot;, line 515, in bulk_create
    objs_without_pk, fields, batch_size, ignore_conflicts=ignore_conflicts,
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/query.py&quot;, line 1290, in _batched_insert
    ignore_conflicts=ignore_conflicts,
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/query.py&quot;, line 1270, in _insert
    return query.get_compiler(using=using).execute_sql(returning_fields)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/sql/compiler.py&quot;, line 1416, in execute_sql
    cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 66, in execute
    return self._execute_with_wrappers(sql, params, many=False, executor=self._execute)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 75, in _execute_with_wrappers
    return executor(sql, params, many, context)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 84, in _execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/utils.py&quot;, line 90, in __exit__
    raise dj_exc_value.with_traceback(traceback) from exc_value
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 84, in _execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zerver/lib/db.py&quot;, line 46, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/zerver/lib/db.py&quot;, line 31, in wrapper_execute
    return action(sql, params)
django.db.utils.IntegrityError: null value in column &quot;realm_id&quot; violates not-null constraint
DETAIL:  Failing row contains (1027, t, 2021-08-12 07:55:10.425405+00, 42, null, 42, null, null, null, 106).

Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-01-21-16-53-13/scripts/lib/upgrade-zulip-stage-2&quot;, line 318, in &lt;module&gt;
    subprocess.check_call([&quot;./manage.py&quot;, &quot;migrate&quot;, &quot;--noinput&quot;], preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;migrate&#39;, &#39;--noinput&#39;]&#39; returned non-zero exit status 1.

Zulip upgrade failed (exit code 1)!

The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is available in /var/log/zulip/upgrade.log]
</code></pre></div>



<a name="1313494"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313494" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313494">(Jan 21 2022 at 16:02)</a>:</h4>
<p>I was trying to update as usual with<br>
root@chat: ~ # /home/zulip/deployments/current/scripts/upgrade-zulip-from-git main</p>



<a name="1313548"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313548" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313548">(Jan 21 2022 at 17:29)</a>:</h4>
<p><span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span> thanks for the report!</p>



<a name="1313549"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313549" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313549">(Jan 21 2022 at 17:30)</a>:</h4>
<p>I suspect the fix is just this:</p>
<div class="codehilite"><pre><span></span><code>diff --git a/zerver/migrations/0374_backfill_user_delete_realmauditlog.py b/zerver/migrations/0374_backfill_user_delete_realmauditlog.py
index d63f17b3b0..fc35681282 100644
--- a/zerver/migrations/0374_backfill_user_delete_realmauditlog.py
+++ b/zerver/migrations/0374_backfill_user_delete_realmauditlog.py
@@ -14,6 +14,7 @@ def backfill_user_deleted_logs(apps: StateApps, schema_editor: DatabaseSchemaEdi
         is_mirror_dummy=True, is_active=False, delivery_email__regex=r&quot;^deleteduser\d+@.+&quot;
     ):
         entry = RealmAuditLog(
+            realm=user_profile.realm,
             modified_user=user_profile,
             acting_user=user_profile,
             event_type=RealmAuditLog.USER_DELETED,
</code></pre></div>



<a name="1313550"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313550" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313550">(Jan 21 2022 at 17:31)</a>:</h4>
<p>Yeah, that's the bug; just compared with the version of this code that runs when a user is deleted.</p>



<a name="1313551"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313551" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313551">(Jan 21 2022 at 17:32)</a>:</h4>
<p>I will try it in an hour or so</p>



<a name="1313552"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313552" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313552">(Jan 21 2022 at 17:32)</a>:</h4>
<p>Sounds good!</p>



<a name="1313560"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313560" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313560">(Jan 21 2022 at 17:42)</a>:</h4>
<p>Do I only have to run the upgrade command again?</p>



<a name="1313561"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313561" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313561">(Jan 21 2022 at 17:43)</a>:</h4>
<p>Well, that'd be the case if I'd merged the fix above; I think what you want to do is make that change in <code>/home/zulip/deployments/next</code> and then run <code>/home/zulip/deployments/next/scripts/lib/upgrade-zulip-stage-2</code>.</p>



<a name="1313562"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313562" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313562">(Jan 21 2022 at 17:43)</a>:</h4>
<p>(Which will continue the upgrade you'd already attempted with the patched migration)</p>



<a name="1313564"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313564" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313564">(Jan 21 2022 at 17:50)</a>:</h4>
<div class="codehilite"><pre><span></span><code>root@chat: ~ # /home/zulip/deployments/next/scripts/lib/upgrade-zulip-stage-2
usage: upgrade-zulip-stage-2 [-h] [--fill-cache] [--less-graceful]
                             [--skip-tornado] [--skip-puppet]
                             [--skip-migrations] [--from-git]
                             [--ignore-static-assets]
                             [--skip-purge-old-deployments]
                             [--audit-fts-indexes]
                             deploy_path
upgrade-zulip-stage-2: error: the following arguments are required: deploy_path
</code></pre></div>



<a name="1313565"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313565" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313565">(Jan 21 2022 at 17:51)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  is the deploy path "/home/zulip/deployments/"?</p>



<a name="1313581"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313581" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313581">(Jan 21 2022 at 18:18)</a>:</h4>
<p>/home/zulip/deployments/next</p>



<a name="1313586"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313586" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313586">(Jan 21 2022 at 18:21)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Using cached Python venv from /srv/zulip-venv-cache/00016ee6aa6fcf631ab9594a846411dcae82507a/zulip-py3-venv
+ ln -nsf /srv/zulip-venv-cache/00016ee6aa6fcf631ab9594a846411dcae82507a/zulip-py3-venv /home/zulip/deployments/next/zulip-py3-venv
generate_secrets: No new secrets to generate.
2022-01-21 18:20:03,824 upgrade-zulip-stage-2: Installing static assets...
cp: cannot stat &#39;/home/zulip/deployments/next/prod-static/serve&#39;: No such file or directory
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/next/scripts/lib/upgrade-zulip-stage-2&quot;, line 247, in &lt;module&gt;
    preexec_fn=su_to_zulip,
  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;cp&#39;, &#39;-rT&#39;, &#39;/home/zulip/deployments/next/prod-static/serve&#39;, &#39;/home/zulip/prod-static&#39;]&#39; returned non-zero exit status 1.
</code></pre></div>



<a name="1313591"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313591" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313591">(Jan 21 2022 at 18:23)</a>:</h4>
<p>I added <br>
            realm=user_profile.realm,<br>
to<br>
/home/zulip/deployments/next/zerver/migrations/0374_backfill_user_delete_realmauditlog.py<br>
and ran<br>
/home/zulip/deployments/next/scripts/lib/upgrade-zulip-stage-2 /home/zulip/deployments/next</p>



<a name="1313595"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313595" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313595">(Jan 21 2022 at 18:24)</a>:</h4>
<p>Sigh, ok let's stop trying to run that sort of subroutine.</p>



<a name="1313598"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313598" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313598">(Jan 21 2022 at 18:24)</a>:</h4>
<p>Just do <code>/home/zulip/deployments/next/manage.py migrate</code> and then run the full upgrade tool again.</p>



<a name="1313603"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313603" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313603">(Jan 21 2022 at 18:26)</a>:</h4>
<div class="codehilite"><pre><span></span><code>root@chat: ~ # su zulip -c &#39;/home/zulip/deployments/next/manage.py migrate&#39;
Operations to perform:
  Apply all migrations: analytics, auth, confirmation, contenttypes, otp_static, otp_totp, sessions, social_django, two_factor, zerver
Running migrations:
  Applying zerver.0374_backfill_user_delete_realmauditlog... OK
</code></pre></div>



<a name="1313606"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313606" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313606">(Jan 21 2022 at 18:27)</a>:</h4>
<p>and now:<br>
/home/zulip/deployments/current/scripts/upgrade-zulip-from-git main<br>
?</p>



<a name="1313609"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313609" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313609">(Jan 21 2022 at 18:27)</a>:</h4>
<p>Yep!</p>



<a name="1313620"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313620" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313620">(Jan 21 2022 at 18:34)</a>:</h4>
<p>seems fine! only 2 warnings.</p>
<div class="codehilite"><pre><span></span><code>warning &quot; &gt; eslint-plugin-formatjs@2.19.0&quot; has incorrect peer dependency &quot;eslint@^7.4.0&quot;.
warning &quot;swagger-parser &gt; @apidevtools/swagger-parser@10.0.3&quot; has unmet peer dependency &quot;openapi-types@&gt;=7&quot;.
</code></pre></div>
<p>thx Tim!</p>



<a name="1313700"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1313700" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1313700">(Jan 21 2022 at 19:57)</a>:</h4>
<p>Excellent.  Thanks again for the report <span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span>!  I expect <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> will do a PR to fix the bug in <code>main</code> soon.</p>



<a name="1335766"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1335766" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1335766">(Feb 27 2022 at 09:49)</a>:</h4>
<p>try upgrading to git main</p>
<div class="codehilite"><pre><span></span><code>WARNING: You are using pip version 20.3.4; however, version 22.0.3 is available.
You should consider upgrading via the &#39;/srv/zulip-venv-cache/a4194fa3043b76bc764373c54635b10e6b325b85/zulip-py3-venv/bin/python3 -m pip install --upgrade pip&#39; command.
+ chmod -R a+rX /srv/zulip-venv-cache/a4194fa3043b76bc764373c54635b10e6b325b85/zulip-py3-venv
Using cached Python venv from /srv/zulip-venv-cache/a4194fa3043b76bc764373c54635b10e6b325b85/zulip-py3-venv
+ ln -nsf /srv/zulip-venv-cache/a4194fa3043b76bc764373c54635b10e6b325b85/zulip-py3-venv /home/zulip/deployments/2022-02-27-10-41-25/zulip-py3-venv
2022-02-27 09:46:04.109 ERR  [] This is not an upgrade -- the current deployment (version 5.0-dev+git) contains 2 database migrations which /home/zulip/deployments/2022-02-27-10-41-25 (version 5.0-dev+git) does not.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-02-27-10-41-25/scripts/lib/upgrade-zulip-stage-2&quot;, line 224, in &lt;module&gt;
    preexec_fn=su_to_zulip,
  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2022-02-27-10-41-25/scripts/lib/check-database-compatibility.py&#39;]&#39; returned non-zero exit status 1.

Zulip upgrade failed (exit code 1)!

The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is available in /var/log/zulip/upgrade.log
root@chat: ~ #
</code></pre></div>



<a name="1335767"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1335767" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1335767">(Feb 27 2022 at 10:07)</a>:</h4>
<p>also If I try to upgrade to 4.x this error occures</p>
<div class="codehilite"><pre><span></span><code>Building PostgreSQL dictionaries from installed myspell/hunspell packages...
  en_us
Removing obsolete dictionary files:
2022-02-27 10:04:47,360 upgrade-zulip-stage-2: Restarting Zulip...
2022-02-27 10:04:52,619 restart-server: Filling memcached caches
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 84, in _execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zerver/lib/db.py&quot;, line 34, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zerver/lib/db.py&quot;, line 19, in wrapper_execute
    return action(sql, params)
psycopg2.errors.UndefinedColumn: column zerver_realm.add_emoji_by_admins_only does not exist
LINE 1: ...otifications&quot;, &quot;zerver_realm&quot;.&quot;mandatory_topics&quot;, &quot;zerver_re...
                                                             ^


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 52, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/__init__.py&quot;, line 419, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/__init__.py&quot;, line 413, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/base.py&quot;, line 398, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zerver/management/commands/fill_memcached_caches.py&quot;, line 19, in handle
    fill_remote_cache(cache)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zerver/lib/cache_helpers.py&quot;, line 165, in fill_remote_cache
    for obj in objects():
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/query.py&quot;, line 280, in __iter__
    self._fetch_all()
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/query.py&quot;, line 1324, in _fetch_all
    self._result_cache = list(self._iterable_class(self))
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/query.py&quot;, line 51, in __iter__
    results = compiler.execute_sql(chunked_fetch=self.chunked_fetch, chunk_size=self.chunk_size)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/sql/compiler.py&quot;, line 1175, in execute_sql
    cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 66, in execute
    return self._execute_with_wrappers(sql, params, many=False, executor=self._execute)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 75, in _execute_with_wrappers
    return executor(sql, params, many, context)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 84, in _execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/utils.py&quot;, line 90, in __exit__
    raise dj_exc_value.with_traceback(traceback) from exc_value
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zulip-py3-venv/lib/python3.7/site-packages/django/db/backends/utils.py&quot;, line 84, in _execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zerver/lib/db.py&quot;, line 34, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/zerver/lib/db.py&quot;, line 19, in wrapper_execute
    return action(sql, params)
django.db.utils.ProgrammingError: column zerver_realm.add_emoji_by_admins_only does not exist
LINE 1: ...otifications&quot;, &quot;zerver_realm&quot;.&quot;mandatory_topics&quot;, &quot;zerver_re...
                                                             ^

Traceback (most recent call last):
  File &quot;./scripts/restart-server&quot;, line 56, in &lt;module&gt;
    subprocess.check_call([&quot;./manage.py&quot;, &quot;fill_memcached_caches&quot;])
  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;fill_memcached_caches&#39;]&#39; returned non-zero exit status 1.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-02-27-10-56-26/scripts/lib/upgrade-zulip-stage-2&quot;, line 366, in &lt;module&gt;
    subprocess.check_call([&quot;./scripts/restart-server&quot;, &quot;--fill-cache&quot;], preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./scripts/restart-server&#39;, &#39;--fill-cache&#39;]&#39; returned non-zero exit status 1.

Zulip upgrade failed (exit code 1)!

The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is  available in /var/log/zulip/upgrade.log
root@chat: ~ #
</code></pre></div>



<a name="1336142"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336142" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336142">(Feb 28 2022 at 19:07)</a>:</h4>
<p><span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span> 4.x would indeed be a downgrade; what we need to figure out is what those two migrations are.</p>



<a name="1336143"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336143" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336143">(Feb 28 2022 at 19:08)</a>:</h4>
<p>oh.</p>



<a name="1336144"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336144" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336144">(Feb 28 2022 at 19:08)</a>:</h4>
<p>yeah. I tried the git main updaten first</p>



<a name="1336147"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336147" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336147">(Feb 28 2022 at 19:09)</a>:</h4>
<p>I was at 4.?? at git main but I dont know which exactly.<br>
Is git main 5.x? or 4.x?</p>



<a name="1336149"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336149" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336149">(Feb 28 2022 at 19:11)</a>:</h4>
<p><code>main</code> is what will become 5.0.</p>



<a name="1336152"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336152" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336152">(Feb 28 2022 at 19:12)</a>:</h4>
<p>Yeah, you want to upgrade to main . I just merged <a href="https://github.com/zulip/zulip/commit/98a05257eaf4ca6555ffc179a9250a7cfb3a903c">98a05257eaf4ca6555ffc179a9250a7cfb3a903c</a>, which will give more useful output for that error.</p>



<a name="1336153"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336153" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336153">(Feb 28 2022 at 19:12)</a>:</h4>
<p><span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span> can you try running the upgrade to <code>main</code> again?</p>



<a name="1336450"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336450" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The One <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336450">(Feb 28 2022 at 22:47)</a>:</h4>
<p>Is there a way to extend the expiration time of the realm link one gets upon installing zulip.  The realm regenerate does not work for me when trying  to import from Mattermost because it thinks there are more than one domain.<br>
Also according to the docs I should be able to extend the time in the settings.py file.  However, I 'm unable to find it in my file upon installing  zulip. </p>
<p>Doc statemnet: "The link expires after the creation of the realm. The link also expires if not used within 7 days. The expiration period can be changed by modifying REALM_CREATION_LINK_VALIDITY_DAYS in settings.py"</p>



<a name="1336462"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336462" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336462">(Feb 28 2022 at 23:01)</a>:</h4>
<p><span class="user-mention" data-user-id="22053">@The One</span> <a href="https://zulip.readthedocs.io/en/latest/production/multiple-organizations.html#subdomains">https://zulip.readthedocs.io/en/latest/production/multiple-organizations.html#subdomains</a> documents how to many a new such invitation link.</p>



<a name="1336463"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336463" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336463">(Feb 28 2022 at 23:01)</a>:</h4>
<p>That's probably easier than adjusting its expiration time.</p>



<a name="1336765"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336765" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The One <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336765">(Mar 01 2022 at 02:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/upgrade.20from.20git.20main/near/1336462">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="22053">The One</span> <a href="https://zulip.readthedocs.io/en/latest/production/multiple-organizations.html#subdomains">https://zulip.readthedocs.io/en/latest/production/multiple-organizations.html#subdomains</a> documents how to many a new such invitation link.</p>
</blockquote>
<p>Thanks, but this also did not help me last time because the mattermost import still failed upon thinking it already existed.</p>



<a name="1336808"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336808" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336808">(Mar 01 2022 at 07:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/upgrade.20from.20git.20main/near/1336153">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="8768">Fabian Tribrunner</span> can you try running the upgrade to <code>main</code> again?</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>libpq-dev is already the newest version (14.2-1.pgdg100+1).
The following package was automatically installed and is no longer required:
  linux-image-4.19.0-10-amd64
Use &#39;apt autoremove&#39; to remove it.
0 upgraded, 0 newly installed, 0 to remove and 2 not upgraded.
Using cached Python venv from /srv/zulip-venv-cache/a4194fa3043b76bc764373c54635b10e6b325b85/zulip-py3-venv
+ ln -nsf /srv/zulip-venv-cache/a4194fa3043b76bc764373c54635b10e6b325b85/zulip-py3-venv /home/zulip/deployments/2022-03-01-08-15-55/zulip-py3-venv
Migration (&#39;sites&#39;, &#39;0001_initial&#39;) missing in new version.
Migration (&#39;sites&#39;, &#39;0002_alter_domain_unique&#39;) missing in new version.
2022-03-01 07:16:15.611 ERR  [] This is not an upgrade -- the current deployment (version 5.0-dev+git) contains 2 database migrations which /home/zulip/deployments/2022-03-01-08-15-55 (version 5.0-dev+git) does not.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-03-01-08-15-55/scripts/lib/upgrade-zulip-stage-2&quot;, line 224, in &lt;module&gt;
    preexec_fn=su_to_zulip,
  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2022-03-01-08-15-55/scripts/lib/check-database-compatibility.py&#39;]&#39; returned non-zero exit status 1.

Zulip upgrade failed (exit code 1)!

The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is available in /var/log/zulip/upgrade.log
root@chat: ~ #
</code></pre></div>



<a name="1336811"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336811" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336811">(Mar 01 2022 at 07:31)</a>:</h4>
<p>That looks like <code>django.contrib.sites</code>, which we had in <code>INSTALLED_APPS</code> before <a href="https://github.com/zulip/zulip/commit/ee901ac8b12b1a51bb8dec537cc487eb80c08bb0">ee901ac8b12b1a51bb8dec537cc487eb80c08bb0</a> (Dec. 2018).</p>



<a name="1336813"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336813" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336813">(Mar 01 2022 at 07:40)</a>:</h4>
<p><span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span> This should help you get back on track:</p>
<ol>
<li>
<p>Add this line to /etc/zulip/settings.py:<br>
<code>EXTRA_INSTALLED_APPS = ["analytics", "django.contrib.sites"]</code></p>
</li>
<li>
<p>Run:<br>
<code>su zulip -c '/home/zulip/deployments/current/manage.py migrate sites zero'</code></p>
</li>
<li>
<p>Remove that line from /etc/zulip/settings.py.</p>
</li>
<li>Try the upgrade again.</li>
</ol>



<a name="1336815"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336815" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336815">(Mar 01 2022 at 07:42)</a>:</h4>
<p>(Or you can wait for us to fix the upgrader to do something like this automatically, which we’ll need to do.)</p>



<a name="1336818"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336818" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336818">(Mar 01 2022 at 07:55)</a>:</h4>
<p>I guess we can just ignore it: <a href="https://github.com/zulip/zulip/pull/21277">#21277</a>.</p>



<a name="1336831"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336831" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336831">(Mar 01 2022 at 09:08)</a>:</h4>
<p><span class="user-mention" data-user-id="699">@Anders Kaseorg</span> </p>
<div class="codehilite"><pre><span></span><code>root@chat: ~ # su zulip -c &#39;/home/zulip/deployments/current/manage.py migrate sites zero&#39;
Operations to perform:
  Unapply all migrations: sites
Running migrations:
  Rendering model states... DONE
  Unapplying sites.0002_alter_domain_unique... OK
  Unapplying sites.0001_initial... OK
root@chat: ~ #
</code></pre></div>



<a name="1336832"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336832" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336832">(Mar 01 2022 at 09:09)</a>:</h4>
<p>Looks good, proceed to step 3.</p>



<a name="1336835"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336835" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336835">(Mar 01 2022 at 09:16)</a>:</h4>
<p>seems fine. only this warning</p>
<div class="codehilite"><pre><span></span><code>generate_secrets: No new secrets to generate.
2022-03-01 09:09:15,580 upgrade-zulip-stage-2: Building static assets...
Cached version not found! Installing node modules.
+ /srv/zulip-yarn/bin/yarn install --non-interactive --frozen-lockfile --prod
yarn install v1.22.17
[1/4] Resolving packages...
[2/4] Fetching packages...
[3/4] Linking dependencies...
warning &quot;@types/webpack-dev-server &gt; webpack-dev-server &gt; http-proxy-middleware@2.0.2&quot; has unmet peer dependency &quot;@types/express@^4.17.13&quot;.
warning &quot;swagger-parser &gt; @apidevtools/swagger-parser@10.0.3&quot; has unmet peer dependency &quot;openapi-types@&gt;=7&quot;.
[4/4] Building fresh packages...
warning Ignored scripts due to flag.
Done in 57.70s.
</code></pre></div>



<a name="1336836"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1336836" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1336836">(Mar 01 2022 at 09:17)</a>:</h4>
<p>Thank you very much <span class="user-mention" data-user-id="699">@Anders Kaseorg</span></p>



<a name="1337179"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1337179" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1337179">(Mar 01 2022 at 21:28)</a>:</h4>
<p>Adding this was fixed for everyone in <a href="https://github.com/zulip/zulip/pull/21277">https://github.com/zulip/zulip/pull/21277</a>.  Thanks for the report <span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span>!</p>



<a name="1337181"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20upgrade%20from%20git%20main/near/1337181" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20upgrade.20from.20git.20main.html#1337181">(Mar 01 2022 at 21:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>