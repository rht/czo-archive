<html>
<head><meta charset="utf-8"><title>S3 upload issue after v7.2 upgrade · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html">S3 upload issue after v7.2 upgrade</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1631611"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631611" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631611">(Aug 25 2023 at 15:43)</a>:</h4>
<p>hi everyone,<br>
After updating from v7.2 to v6.1<br>
We are facing file upload issue. our file storage is set with AWS S3 bucket.<br>
file upload was working fine in v6.1 and no configuration was changed during v7.2 upgrade.</p>
<p>*I verified the S3 bucket's folder based on the URL generated, the file has been uploaded.<br>
*But when I try to access the file from zulip or from the direct s3 object URL(got from the s3 bucket), both the URL is not working<br>
*When I download the file from the s3 bucket, I can access the file locally.</p>



<a name="1631612"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631612" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631612">(Aug 25 2023 at 15:53)</a>:</h4>
<p>Can you show what happens when you try to load the <code>/user_uploads/...</code> URL for the upload in your browser?  What form of "not working"?</p>



<a name="1631614"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631614" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631614">(Aug 25 2023 at 15:59)</a>:</h4>
<p><a href="/user_uploads/2/39/R6FtOm-Aa_0W050YAmp2Ym5n/image.png">image.png</a><br>
i get this error whe i access my file url<br>
{{my site}}user_uploads/2/z-qLxHIFaqj2kEI3YHXkVPpJ/Screenshot-from-2023-07-06-06-21-27.png</p>
<div class="message_inline_image"><a href="/user_uploads/2/39/R6FtOm-Aa_0W050YAmp2Ym5n/image.png" title="image.png"><img src="/user_uploads/2/39/R6FtOm-Aa_0W050YAmp2Ym5n/image.png"></a></div>



<a name="1631615"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631615" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631615">(Aug 25 2023 at 16:00)</a>:</h4>
<p>there is no error at /var/log/nginx/error.log</p>



<a name="1631616"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631616" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631616">(Aug 25 2023 at 16:02)</a>:</h4>
<p>This is the error when I try to access my s3 object URL<br>
<a href="/user_uploads/2/63/FF03tGceniZLxh3dbQF6o6Aj/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/63/FF03tGceniZLxh3dbQF6o6Aj/image.png" title="image.png"><img src="/user_uploads/2/63/FF03tGceniZLxh3dbQF6o6Aj/image.png"></a></div>



<a name="1631621"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631621" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631621">(Aug 25 2023 at 16:22)</a>:</h4>
<p>Accessing the S3 download URL is expected to fail (it's intentionally not world-readable for security reasons)</p>



<a name="1631622"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631622" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631622">(Aug 25 2023 at 16:23)</a>:</h4>
<p>And this is S3, not an "S3-compatible" service?</p>



<a name="1631623"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631623" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631623">(Aug 25 2023 at 16:24)</a>:</h4>
<p>but the in-app image is broken &amp; can't be accessed.<br>
<a href="/user_uploads/2/dc/jVTZSWg19bMDsBOKng5UZBfZ/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/dc/jVTZSWg19bMDsBOKng5UZBfZ/image.png" title="image.png"><img src="/user_uploads/2/dc/jVTZSWg19bMDsBOKng5UZBfZ/image.png"></a></div>



<a name="1631624"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631624" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631624">(Aug 25 2023 at 16:24)</a>:</h4>
<p>yes, this is direct AWS S3 bucket setup</p>



<a name="1631625"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631625" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631625">(Aug 25 2023 at 16:31)</a>:</h4>
<p>Does uploading new files still seem to put them in the bucket correctly?</p>



<a name="1631628"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631628" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631628">(Aug 25 2023 at 16:35)</a>:</h4>
<p>I tried uploading multiple files,<br>
all files are in the S3 bucket. but can't be accessed inside Zulip.</p>



<a name="1631629"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631629" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631629">(Aug 25 2023 at 16:47)</a>:</h4>
<p>Yes, I understand that none of them currently work through Zulip -- I wanted to make sure that server had the right credentials.</p>



<a name="1631630"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631630" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631630">(Aug 25 2023 at 16:49)</a>:</h4>
<p>Can you paste the error from <a href="#narrow/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade/near/1631614">this message</a> in a <a href="https://zulip.com/help/code-blocks">code block</a> instead of a screenshot?</p>



<a name="1631631"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631631" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631631">(Aug 25 2023 at 16:51)</a>:</h4>
<p>Error:</p>
<div class="codehilite"><pre><span></span><code>This XML file does not appear to have any style information associated with it. The document tree is shown below.
&lt;Error&gt;
&lt;Code&gt;SignatureDoesNotMatch&lt;/Code&gt;
&lt;Message&gt;The request signature we calculated does not match the signature you provided. Check your key and signing method.&lt;/Message&gt;
&lt;AWSAccessKeyId&gt;AKIA4HR4AAO3BY7P6XPH&lt;/AWSAccessKeyId&gt;
&lt;StringToSign&gt;GET 1692982329 x-amz-cf-id:-Ef0_zRJq-d-NfWLJIKQ4LXUmrAOnwnc_CNrANxRkFtIcSbIe2t9QQ== /zulip-uploads-dev/2/z-qLxHIFaqj2kEI3YHXkVPpJ/Screenshot-from-2023-07-06-06-21-27.png&lt;/StringToSign&gt;
&lt;SignatureProvided&gt;bylv/+fqIHjdTuwxULP30W6PbOo=&lt;/SignatureProvided&gt;
&lt;StringToSignBytes&gt;47 45 54 0a 0a 0a 31 36 39 32 39 38 32 33 32 39 0a 78 2d 61 6d 7a 2d 63 66 2d 69 64 3a 2d 45 66 30 5f 7a 52 4a 71 2d 64 2d 4e 66 57 4c 4a 49 4b 51 34 4c 58 55 6d 72 41 4f 6e 77 6e 63 5f 43 4e 72 41 4e 78 52 6b 46 74 49 63 53 62 49 65 32 74 39 51 51 3d 3d 0a 2f 7a 75 6c 69 70 2d 75 70 6c 6f 61 64 73 2d 64 65 76 2f 32 2f 7a 2d 71 4c 78 48 49 46 61 71 6a 32 6b 45 49 33 59 48 58 6b 56 50 70 4a 2f 53 63 72 65 65 6e 73 68 6f 74 2d 66 72 6f 6d 2d 32 30 32 33 2d 30 37 2d 30 36 2d 30 36 2d 32 31 2d 32 37 2e 70 6e 67&lt;/StringToSignBytes&gt;
&lt;RequestId&gt;EBYH90WEPX4K23EC&lt;/RequestId&gt;
&lt;HostId&gt;NVnZqZ5OMWwWRhzvkOs8I5y6ZWMxmyzFPXxO1D810MXCLw5HrgFqkAK/2gd/v2AE5+sLWQq6tbM=&lt;/HostId&gt;
&lt;/Error&gt;
</code></pre></div>



<a name="1631633"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631633" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631633">(Aug 25 2023 at 16:57)</a>:</h4>
<p>Are you using Cloudfront in some way, in this deployment?</p>



<a name="1631638"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631638" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631638">(Aug 25 2023 at 17:06)</a>:</h4>
<p>Try updating <code>/etc/nginx/zulip-include/app.d/uploads-internal.conf</code> with the contents:</p>
<div class="codehilite" data-code-language="Nginx configuration file"><pre><span></span><code><span class="c1"># Handle redirects to S3</span>
<span class="k">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">^/internal/s3/(?&lt;s3_hostname&gt;[^/]+)/(?&lt;s3_path&gt;.*)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">internal</span><span class="p">;</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/etc/nginx/zulip-include/headers</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Content-Security-Policy</span><span class="w"> </span><span class="s">"default-src</span><span class="w"> </span><span class="s">'none'</span><span class="p">;</span><span class="w"> </span><span class="kn">style-src</span><span class="w"> </span><span class="s">'self'</span><span class="w"> </span><span class="s">'unsafe-inline'</span><span class="p">;</span><span class="w"> </span><span class="kn">img-src</span><span class="w"> </span><span class="s">'self'</span><span class="p">;</span><span class="w"> </span><span class="kn">object-src</span><span class="w"> </span><span class="s">'self'</span><span class="p">;</span><span class="w"> </span><span class="kn">plugin-types</span><span class="w"> </span><span class="s">application/pdf</span><span class="p">;</span><span class="kn">"</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># The components of this path are originally double-URI-escaped</span>
<span class="w">    </span><span class="c1"># (see zerver/view/upload.py).  "location" matches are on</span>
<span class="w">    </span><span class="c1"># unescaped values, which fills $s3_path with a properly</span>
<span class="w">    </span><span class="c1"># single-escaped path to pass to the upstream server.</span>
<span class="w">    </span><span class="c1"># (see associated commit message for more details)</span>
<span class="w">    </span><span class="kn">set</span><span class="w"> </span><span class="nv">$download_url</span><span class="w"> </span><span class="s">https://</span><span class="nv">$s3_hostname/$s3_path</span><span class="p">;</span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$s3_hostname</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Remove x-amx-cf-id header, which otherwise has to be signed over</span>
<span class="w">    </span><span class="kn">proxy_hide_header</span><span class="w"> </span><span class="s">x-amz-cf-id</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Ensure that we only get _one_ of these headers: the one that</span>
<span class="w">    </span><span class="c1"># Django added, not the one from S3.</span>
<span class="w">    </span><span class="kn">proxy_hide_header</span><span class="w"> </span><span class="s">Cache-Control</span><span class="p">;</span>
<span class="w">    </span><span class="kn">proxy_hide_header</span><span class="w"> </span><span class="s">Expires</span><span class="p">;</span>
<span class="w">    </span><span class="kn">proxy_hide_header</span><span class="w"> </span><span class="s">Set-Cookie</span><span class="p">;</span>
<span class="w">    </span><span class="c1"># We are _leaving_ S3 to provide Content-Type,</span>
<span class="w">    </span><span class="c1"># Content-Disposition, and Accept-Ranges headers, which are the</span>
<span class="w">    </span><span class="c1"># three remaining headers which nginx would also pass through from</span>
<span class="w">    </span><span class="c1"># the first response.  Django explicitly unsets the first, and</span>
<span class="w">    </span><span class="c1"># does not set the latter two.</span>

<span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="nv">$download_url$is_args$args</span><span class="p">;</span>
<span class="w">    </span><span class="kn">proxy_cache</span><span class="w"> </span><span class="s">uploads</span><span class="p">;</span>
<span class="w">    </span><span class="c1"># If the S3 response doesn't contain Cache-Control headers (which</span>
<span class="w">    </span><span class="c1"># we don't expect it to) then we assume they are valid for a very</span>
<span class="w">    </span><span class="c1"># long time.  The size of the cache is controlled by</span>
<span class="w">    </span><span class="c1"># `s3_disk_cache_size` and read frequency, set via</span>
<span class="w">    </span><span class="c1"># `s3_cache_inactive_time`.</span>
<span class="w">    </span><span class="kn">proxy_cache_valid</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="s">1y</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># We only include the requested content-disposition in the cache</span>
<span class="w">    </span><span class="c1"># key, so that we cache "Content-Disposition: attachment"</span>
<span class="w">    </span><span class="c1"># separately from the inline version.</span>
<span class="w">    </span><span class="kn">proxy_cache_key</span><span class="w"> </span><span class="nv">$download_url$s3_disposition_cache_key</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># Internal file-serving</span>
<span class="k">location</span><span class="w"> </span><span class="s">/internal/local/uploads</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">internal</span><span class="p">;</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/etc/nginx/zulip-include/headers</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Content-Security-Policy</span><span class="w"> </span><span class="s">"default-src</span><span class="w"> </span><span class="s">'none'</span><span class="p">;</span><span class="w"> </span><span class="kn">style-src</span><span class="w"> </span><span class="s">'self'</span><span class="w"> </span><span class="s">'unsafe-inline'</span><span class="p">;</span><span class="w"> </span><span class="kn">img-src</span><span class="w"> </span><span class="s">'self'</span><span class="p">;</span><span class="w"> </span><span class="kn">object-src</span><span class="w"> </span><span class="s">'self'</span><span class="p">;</span><span class="w"> </span><span class="kn">plugin-types</span><span class="w"> </span><span class="s">application/pdf</span><span class="p">;</span><span class="kn">"</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Django handles setting Content-Type, Content-Disposition, and Cache-Control.</span>

<span class="w">    </span><span class="kn">alias</span><span class="w"> </span><span class="s">/home/zulip/uploads/files</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span><span class="w"> </span><span class="s">/internal/local/user_avatars</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">internal</span><span class="p">;</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/etc/nginx/zulip-include/headers</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Content-Security-Policy</span><span class="w"> </span><span class="s">"default-src</span><span class="w"> </span><span class="s">'none'</span><span class="w"> </span><span class="s">img-src</span><span class="w"> </span><span class="s">'self'"</span><span class="p">;</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/etc/nginx/zulip-include/uploads.types</span><span class="p">;</span>
<span class="w">    </span><span class="kn">alias</span><span class="w"> </span><span class="s">/home/zulip/uploads/avatars</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



<a name="1631639"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631639" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631639">(Aug 25 2023 at 17:07)</a>:</h4>
<p>Then run, as <code>root</code>:</p>
<div class="codehilite"><pre><span></span><code>service nginx reload
</code></pre></div>



<a name="1631643"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631643" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631643">(Aug 25 2023 at 17:19)</a>:</h4>
<p>getting same error after updating uploads-internal.conf</p>



<a name="1631646"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631646" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631646">(Aug 25 2023 at 17:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade/near/1631633">said</a>:</p>
<blockquote>
<p>Are you using Cloudfront in some way, in this deployment?</p>
</blockquote>
<p>Can you answer this?</p>



<a name="1631647"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631647" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631647">(Aug 25 2023 at 17:20)</a>:</h4>
<p>zulip is behind an application load balancer.</p>



<a name="1631648"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631648" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631648">(Aug 25 2023 at 17:21)</a>:</h4>
<p>That should be fine.  But no cloudfront?</p>



<a name="1631649"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631649" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631649">(Aug 25 2023 at 17:22)</a>:</h4>
<p>I ask because I see <code>x-amz-cf-id</code> in that error, implying that something is adding a cloudfront id</p>



<a name="1631650"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631650" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631650">(Aug 25 2023 at 17:22)</a>:</h4>
<p>using cloudfront</p>



<a name="1631651"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631651" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631651">(Aug 25 2023 at 17:22)</a>:</h4>
<p>OK, how and where?</p>



<a name="1631652"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631652" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631652">(Aug 25 2023 at 17:26)</a>:</h4>
<p><a href="/user_uploads/2/a8/udPlEaq6MeY6OlwH3AIMNXeo/image.png">image.png</a><br>
this is the cloudfront settings</p>
<div class="message_inline_image"><a href="/user_uploads/2/a8/udPlEaq6MeY6OlwH3AIMNXeo/image.png" title="image.png"><img src="/user_uploads/2/a8/udPlEaq6MeY6OlwH3AIMNXeo/image.png"></a></div>



<a name="1631653"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631653" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631653">(Aug 25 2023 at 17:26)</a>:</h4>
<p>as Web Application Firewall (WAF)</p>



<a name="1631654"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631654" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631654">(Aug 25 2023 at 17:29)</a>:</h4>
<p>this applies to all Wildcard domains (*.domain-name). since we have enabled multi-organisation in Zulip.</p>



<a name="1631659"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631659" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631659">(Aug 25 2023 at 17:36)</a>:</h4>
<p>Try this for <code>/etc/nginx/zulip-include/app.d/uploads-internal.conf</code>:</p>
<div class="codehilite" data-code-language="Nginx configuration file"><pre><span></span><code><span class="c1"># Handle redirects to S3</span>
<span class="k">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">^/internal/s3/(?&lt;s3_hostname&gt;[^/]+)/(?&lt;s3_path&gt;.*)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">internal</span><span class="p">;</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/etc/nginx/zulip-include/headers</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Content-Security-Policy</span><span class="w"> </span><span class="s">"default-src</span><span class="w"> </span><span class="s">'none'</span><span class="p">;</span><span class="w"> </span><span class="kn">style-src</span><span class="w"> </span><span class="s">'self'</span><span class="w"> </span><span class="s">'unsafe-inline'</span><span class="p">;</span><span class="w"> </span><span class="kn">img-src</span><span class="w"> </span><span class="s">'self'</span><span class="p">;</span><span class="w"> </span><span class="kn">object-src</span><span class="w"> </span><span class="s">'self'</span><span class="p">;</span><span class="w"> </span><span class="kn">plugin-types</span><span class="w"> </span><span class="s">application/pdf</span><span class="p">;</span><span class="kn">"</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># The components of this path are originally double-URI-escaped</span>
<span class="w">    </span><span class="c1"># (see zerver/view/upload.py).  "location" matches are on</span>
<span class="w">    </span><span class="c1"># unescaped values, which fills $s3_path with a properly</span>
<span class="w">    </span><span class="c1"># single-escaped path to pass to the upstream server.</span>
<span class="w">    </span><span class="c1"># (see associated commit message for more details)</span>
<span class="w">    </span><span class="kn">set</span><span class="w"> </span><span class="nv">$download_url</span><span class="w"> </span><span class="s">https://</span><span class="nv">$s3_hostname/$s3_path</span><span class="p">;</span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$s3_hostname</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Remove x-amz-cf-id header, which otherwise has to be signed over</span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">x-amz-cf-id</span><span class="w"> </span><span class="s">""</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Ensure that we only get _one_ of these headers: the one that</span>
<span class="w">    </span><span class="c1"># Django added, not the one from S3.</span>
<span class="w">    </span><span class="kn">proxy_hide_header</span><span class="w"> </span><span class="s">Cache-Control</span><span class="p">;</span>
<span class="w">    </span><span class="kn">proxy_hide_header</span><span class="w"> </span><span class="s">Expires</span><span class="p">;</span>
<span class="w">    </span><span class="kn">proxy_hide_header</span><span class="w"> </span><span class="s">Set-Cookie</span><span class="p">;</span>
<span class="w">    </span><span class="c1"># We are _leaving_ S3 to provide Content-Type,</span>
<span class="w">    </span><span class="c1"># Content-Disposition, and Accept-Ranges headers, which are the</span>
<span class="w">    </span><span class="c1"># three remaining headers which nginx would also pass through from</span>
<span class="w">    </span><span class="c1"># the first response.  Django explicitly unsets the first, and</span>
<span class="w">    </span><span class="c1"># does not set the latter two.</span>

<span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="nv">$download_url$is_args$args</span><span class="p">;</span>
<span class="w">    </span><span class="kn">proxy_cache</span><span class="w"> </span><span class="s">uploads</span><span class="p">;</span>
<span class="w">    </span><span class="c1"># If the S3 response doesn't contain Cache-Control headers (which</span>
<span class="w">    </span><span class="c1"># we don't expect it to) then we assume they are valid for a very</span>
<span class="w">    </span><span class="c1"># long time.  The size of the cache is controlled by</span>
<span class="w">    </span><span class="c1"># `s3_disk_cache_size` and read frequency, set via</span>
<span class="w">    </span><span class="c1"># `s3_cache_inactive_time`.</span>
<span class="w">    </span><span class="kn">proxy_cache_valid</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="s">1y</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># We only include the requested content-disposition in the cache</span>
<span class="w">    </span><span class="c1"># key, so that we cache "Content-Disposition: attachment"</span>
<span class="w">    </span><span class="c1"># separately from the inline version.</span>
<span class="w">    </span><span class="kn">proxy_cache_key</span><span class="w"> </span><span class="nv">$download_url$s3_disposition_cache_key</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># Internal file-serving</span>
<span class="k">location</span><span class="w"> </span><span class="s">/internal/local/uploads</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">internal</span><span class="p">;</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/etc/nginx/zulip-include/headers</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Content-Security-Policy</span><span class="w"> </span><span class="s">"default-src</span><span class="w"> </span><span class="s">'none'</span><span class="p">;</span><span class="w"> </span><span class="kn">style-src</span><span class="w"> </span><span class="s">'self'</span><span class="w"> </span><span class="s">'unsafe-inline'</span><span class="p">;</span><span class="w"> </span><span class="kn">img-src</span><span class="w"> </span><span class="s">'self'</span><span class="p">;</span><span class="w"> </span><span class="kn">object-src</span><span class="w"> </span><span class="s">'self'</span><span class="p">;</span><span class="w"> </span><span class="kn">plugin-types</span><span class="w"> </span><span class="s">application/pdf</span><span class="p">;</span><span class="kn">"</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Django handles setting Content-Type, Content-Disposition, and Cache-Control.</span>

<span class="w">    </span><span class="kn">alias</span><span class="w"> </span><span class="s">/home/zulip/uploads/files</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span><span class="w"> </span><span class="s">/internal/local/user_avatars</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">internal</span><span class="p">;</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/etc/nginx/zulip-include/headers</span><span class="p">;</span>
<span class="w">    </span><span class="kn">add_header</span><span class="w"> </span><span class="s">Content-Security-Policy</span><span class="w"> </span><span class="s">"default-src</span><span class="w"> </span><span class="s">'none'</span><span class="w"> </span><span class="s">img-src</span><span class="w"> </span><span class="s">'self'"</span><span class="p">;</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/etc/nginx/zulip-include/uploads.types</span><span class="p">;</span>
<span class="w">    </span><span class="kn">alias</span><span class="w"> </span><span class="s">/home/zulip/uploads/avatars</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



<a name="1631660"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631660" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631660">(Aug 25 2023 at 17:36)</a>:</h4>
<p>Don't forget to <code>service nginx reload</code></p>



<a name="1631663"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631663" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631663">(Aug 25 2023 at 17:40)</a>:</h4>
<p>yes, it's working now.</p>



<a name="1631664"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631664" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631664">(Aug 25 2023 at 17:41)</a>:</h4>
<p>thanks a lot</p>



<a name="1631665"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631665" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631665">(Aug 25 2023 at 17:43)</a>:</h4>
<p>That's too late to make it into 7.3 (which I'm releasing as we speak) but we'll get it in <code>main</code> and 7.4.</p>



<a name="1631667"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1631667" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> raja <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1631667">(Aug 25 2023 at 17:47)</a>:</h4>
<p>cool, will wait for 7.4.<br>
Thanks a lot once again. You are a lifesaver</p>



<a name="1632508"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/S3%20upload%20issue%20after%20v7.2%20upgrade/near/1632508" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/S3.20upload.20issue.20after.20v7.2E2.20upgrade.html#1632508">(Aug 28 2023 at 17:18)</a>:</h4>
<p>Pushed <a href="https://github.com/zulip/zulip/pull/26591">#26591</a>.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>