<html>
<head><meta charset="utf-8"><title>database corruption · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html">database corruption</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1227580"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227580" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227580">(Jul 08 2021 at 11:32)</a>:</h4>
<p>Hi there,<br>
I'm getting bombarded with tracebacks related to Jira integration, since 4.3.</p>
<div class="codehilite"><pre><span></span><code>Logger zerver.middleware.json_error_handler, from module zerver.middleware line 450:
Error generated by JIRA &lt;jira-bot@zulip.xyz.com&gt; (Member) on zulip.xyz.com deployment

Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py&quot;, line 181, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/csrf.py&quot;, line 54, in wrapped_view
    return view_func(*args, **kwargs)
  File &quot;./zerver/lib/request.py&quot;, line 390, in _wrapped_view_func
    return view_func(request, *args, **kwargs)
  File &quot;./zerver/decorator.py&quot;, line 323, in _wrapped_func_arguments
    user_profile = validate_api_key(
  File &quot;./zerver/decorator.py&quot;, line 244, in validate_api_key
    process_client(request, user_profile, client_name=client_name)
  File &quot;./zerver/decorator.py&quot;, line 187, in process_client
    request.client = get_client(client_name)
  File &quot;./zerver/models.py&quot;, line 1988, in get_client
    result = get_client_remote_cache(name)
  File &quot;./zerver/lib/cache.py&quot;, line 204, in func_with_caching
    val = func(*args, **kwargs)
  File &quot;./zerver/models.py&quot;, line 1999, in get_client_remote_cache
    (client, _) = Client.objects.get_or_create(name=name)
  File &quot;/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/manager.py&quot;, line 85, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/query.py&quot;, line 581, in get_or_create
    return self.get(**kwargs), False
  File &quot;/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/query.py&quot;, line 439, in get
    raise self.model.MultipleObjectsReturned(
zerver.models.Client.MultipleObjectsReturned: get() returned more than one Client -- it returned 3!


Deployed code:
- git: None
- ZULIP_VERSION: 4.3


Request info:
- path: /api/v1/external/jira
- POST: {}
- REMOTE_ADDR: &quot;172.17.0.10&quot;
- QUERY_STRING: &quot;api_key=******&amp;stream=******&amp;topic=******&amp;user_id=******&amp;user_key=******&quot;
- SERVER_NAME: &quot;&quot;
</code></pre></div>
<p>Any ideia what can be the issue?<br>
Thanks</p>



<a name="1227752"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227752" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227752">(Jul 08 2021 at 16:37)</a>:</h4>
<p>/api/v1/messages works fine for the same bot</p>



<a name="1227776"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227776" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227776">(Jul 08 2021 at 16:54)</a>:</h4>
<p><span class="user-mention" data-user-id="10530">@Ricardo Duarte</span> I think the issue here is some sort of database corruption.</p>



<a name="1227777"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227777" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227777">(Jul 08 2021 at 16:54)</a>:</h4>
<p>Did this system have the host OS upgrade recently?</p>



<a name="1227778"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227778" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227778">(Jul 08 2021 at 16:55)</a>:</h4>
<p>There's a problem with upgrading the OS on a postgres host that cause indexes to be corrupted that can lead to this sort of failure mode.</p>



<a name="1227779"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227779" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227779">(Jul 08 2021 at 16:56)</a>:</h4>
<p>This may require some surgery to fix if my theory is correct.</p>



<a name="1227786"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227786" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227786">(Jul 08 2021 at 17:01)</a>:</h4>
<p>I tried to do a select for api_key and it just returns one (and the correct) user</p>



<a name="1227787"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227787" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227787">(Jul 08 2021 at 17:02)</a>:</h4>
<p>this is docker-zulip</p>



<a name="1227788"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227788" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227788">(Jul 08 2021 at 17:02)</a>:</h4>
<p>do you know what query should this go to? Client.objects.get_or_create(name=name) ?</p>



<a name="1227789"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227789" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227789">(Jul 08 2021 at 17:03)</a>:</h4>
<p>I see the problem!</p>



<a name="1227790"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227790" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227790">(Jul 08 2021 at 17:03)</a>:</h4>
<p><a href="/user_uploads/2/b9/kFt5MTS9gesAIPkhnYxriYRq/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/b9/kFt5MTS9gesAIPkhnYxriYRq/image.png" title="image.png"><img src="/user_uploads/2/b9/kFt5MTS9gesAIPkhnYxriYRq/image.png"></a></div>



<a name="1227791"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227791" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227791">(Jul 08 2021 at 17:04)</a>:</h4>
<p>there are 3 ZulipJiraWebhook in zerver_client table</p>



<a name="1227795"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227795" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227795">(Jul 08 2021 at 17:06)</a>:</h4>
<p>that explains the error "zerver.models.Client.MultipleObjectsReturned: get() returned more than one Client -- it returned 3!"</p>



<a name="1227796"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227796" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227796">(Jul 08 2021 at 17:07)</a>:</h4>
<p>is it safe do delete two of them?</p>



<a name="1227798"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227798" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227798">(Jul 08 2021 at 17:08)</a>:</h4>
<p>I think I know what is causing this as well</p>



<a name="1227799"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227799" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227799">(Jul 08 2021 at 17:08)</a>:</h4>
<p>and looks to be a bug with zulip code</p>



<a name="1227816"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227816" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227816">(Jul 08 2021 at 17:16)</a>:</h4>
<p>you can also see id=11 thats the same name with different case</p>



<a name="1227826"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227826" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227826">(Jul 08 2021 at 17:26)</a>:</h4>
<p>ok. this is what I did now:</p>
<ul>
<li>updated all zerver_message sending_client_id=23 and =22 to sending_client_id=21</li>
<li>deleted client_id 23 and 22 from zerver_client</li>
</ul>



<a name="1227827"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227827" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227827">(Jul 08 2021 at 17:26)</a>:</h4>
<p>this fixes the issue, but unsure what it may break</p>



<a name="1227829"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227829" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227829">(Jul 08 2021 at 17:28)</a>:</h4>
<p>I'm under the impression the problem happens when different bots post messages to jira webhook endpoint.</p>



<a name="1227830"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227830" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227830">(Jul 08 2021 at 17:29)</a>:</h4>
<p>My theory is that Zulip creates a new ZulipJiraWebhook client for each bot, and then as Client.objects.get_or_create(name=name) targets name, it fails due to duplicates.</p>



<a name="1227909"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227909" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227909">(Jul 08 2021 at 18:29)</a>:</h4>
<p><span class="user-mention" data-user-id="10530">@Ricardo Duarte</span> yeah, that's the problem.  And the fix (move references and then delete) is correct.</p>



<a name="1227910"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227910" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227910">(Jul 08 2021 at 18:30)</a>:</h4>
<p>However, this is going to happen again.  The bug isn't in the Zulip code; it's that updating the OS can corrupt database indexes because of changes in libc that affect how postgres stores indexes.</p>



<a name="1227911"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227911" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227911">(Jul 08 2021 at 18:30)</a>:</h4>
<p>You'll need to run <code>REINDEX</code> on the affected indexes to make this not repeat.</p>



<a name="1227912"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227912" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227912">(Jul 08 2021 at 18:31)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> is I think working on a script that one can run to do that tactically.  If your database is small, you might be able to get away with just the <code>REINDEX</code> SQL query with the server stopped (if it's large, that may take longer to run than you'd like, and the script we're writing to only run <code>REINDEX</code> on the ~20 indexes that need this would be a lot better).</p>



<a name="1227924"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227924" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227924">(Jul 08 2021 at 18:44)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> my SQL is quite limited <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> Can I issue a query to reindex them all, or what index should I target?</p>



<a name="1227925"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227925" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227925">(Jul 08 2021 at 18:45)</a>:</h4>
<p>reindexdb -a would work?</p>



<a name="1227929"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227929" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227929">(Jul 08 2021 at 18:48)</a>:</h4>
<p><a href="/user_uploads/2/d6/C13wkBivCUEpXxr0Sza8vBTU/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/d6/C13wkBivCUEpXxr0Sza8vBTU/image.png" title="image.png"><img src="/user_uploads/2/d6/C13wkBivCUEpXxr0Sza8vBTU/image.png"></a></div>



<a name="1227935"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227935" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227935">(Jul 08 2021 at 18:51)</a>:</h4>
<p>there seems to be a major issue with the database ...</p>



<a name="1227936"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227936" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227936">(Jul 08 2021 at 18:52)</a>:</h4>
<p>can I fix this without losing messages?</p>



<a name="1227939"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227939" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227939">(Jul 08 2021 at 18:53)</a>:</h4>
<p><span class="user-mention" data-user-id="10530">@Ricardo Duarte</span> yeah, that's the right query.  And indeed you'll get a few errors like that for other duplicates objects.</p>



<a name="1227940"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227940" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227940">(Jul 08 2021 at 18:53)</a>:</h4>
<p>You can delete duplicate <code>UserActivity</code> entries easily; that table is used for debugging only.</p>



<a name="1227941"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227941" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227941">(Jul 08 2021 at 18:54)</a>:</h4>
<p>The technique you used with <code>Client</code> is exactly the right model.</p>



<a name="1227942"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227942" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227942">(Jul 08 2021 at 18:54)</a>:</h4>
<p>I'd consider taking a backup using <code>manage.py backup</code> just so you can revert easily if you make a mistake.</p>



<a name="1227943"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227943" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227943">(Jul 08 2021 at 18:54)</a>:</h4>
<p>yes, I have a "docker" backup I can revert in seconds <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="1227944"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227944" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227944">(Jul 08 2021 at 18:54)</a>:</h4>
<p>But based on our Zulip Cloud experience with this issue, you likely only have a handful of duplicated objects like that to resolve.</p>



<a name="1227945"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227945" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227945">(Jul 08 2021 at 18:54)</a>:</h4>
<p>can I just delete all zerver_useractivity?</p>



<a name="1227946"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227946" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227946">(Jul 08 2021 at 18:54)</a>:</h4>
<p>(Basically, the indexes being broken meant that anything where we asked the database to enforce a unique constraint was not enforced)</p>



<a name="1227947"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227947" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227947">(Jul 08 2021 at 18:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10530">Ricardo Duarte</span> <a href="#narrow/stream/31-production-help/topic/jira.20integration.20broken/near/1227945">said</a>:</p>
<blockquote>
<p>can I just delete all zerver_useractivity?</p>
</blockquote>
<p>I wouldn't recommend doing that.</p>



<a name="1227948"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227948" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227948">(Jul 08 2021 at 18:55)</a>:</h4>
<p>But I'd just delete the newest row ID for any duplicates.</p>



<a name="1227958"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227958" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227958">(Jul 08 2021 at 19:01)</a>:</h4>
<p>if reindex completes, should I worry for problems in the future?</p>



<a name="1227960"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227960" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227960">(Jul 08 2021 at 19:01)</a>:</h4>
<p>I have to revert back to May to get to a clean database</p>



<a name="1227962"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1227962" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1227962">(Jul 08 2021 at 19:02)</a>:</h4>
<p>(reindex went through after deleting the duplicates)</p>



<a name="1228032"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1228032" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1228032">(Jul 08 2021 at 20:43)</a>:</h4>
<p><span class="user-mention" data-user-id="10530">@Ricardo Duarte</span> nope, you should be all set now!</p>



<a name="1228046"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1228046" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ricardo Duarte <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1228046">(Jul 08 2021 at 20:57)</a>:</h4>
<p>thanks <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1228071"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1228071" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1228071">(Jul 08 2021 at 21:14)</a>:</h4>
<p>I'm going to mention <span class="user-group-mention" data-user-group-id="128">@selfhosters</span> on this topic to make sure you're all aware of this issue, since even once we have a tool to clean up after it, it's going to require some manual cleanup (as above in this thread).</p>
<p>This is <a href="https://github.com/zulip/zulip/pull/18847">#18847</a>.  Specifically, upgrading the database server from Ubuntu from 18.04 to 20.04, or any OS change which involves a <code>libc</code> version upgrade (particularly to ≥ 2.28), will result in corrupted PostgreSQL indexes.  <em>This corruption is silent</em>, and results in the database not being able to find strings in the places it expects, due to collation changes; the end result is that nominally "unique" indexes get duplicates.  <a href="https://postgresql.verite.pro/blog/2018/08/27/glibc-upgrade.html">https://postgresql.verite.pro/blog/2018/08/27/glibc-upgrade.html</a> and <a href="https://www.citusdata.com/blog/2020/12/12/dont-let-collation-versions-corrupt-your-postgresql-indexes/">https://www.citusdata.com/blog/2020/12/12/dont-let-collation-versions-corrupt-your-postgresql-indexes/</a> explain the problem in more depth.</p>
<p>The simple solution is to run <code>REINDEX DATABASE zulip</code> -- but be aware that will <em>take a write lock on the whole database</em>.  This is reasonable for folks with small databases, but may not be for large instances.</p>
<p>We're working on a comprehensive solution going forward, but I wanted to make sure all <span class="user-group-mention" data-user-group-id="128">@selfhosters</span>  are aware of this data corruption issue, in case you're planning on an OS upgrade, or have done one recently.  As evident in this thread, Docker instances are not immune, either.</p>



<a name="1238712"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238712" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Zamboni <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238712">(Jul 25 2021 at 19:01)</a>:</h4>
<p>Hello all,<br>
 I just upgraded to 4.4 and I wanted to check the database corruption issue using the  "reindex-textual-data" script as described in this blog <a href="https://blog.zulip.com/2021/07/22/zulip-server-4-4/">post</a> but the script seems to be missing.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>zulip@zulip:~$ <span class="nb">cd</span> deployments/current
zulip@zulip:~/deployments/current$ cat version
<span class="m">4</span>.4
zulip@zulip:~/deployments/current$ <span class="nb">cd</span> scripts/setup/
zulip@zulip:~/deployments/current/scripts/setup$ ls -la
total <span class="m">112</span>
drwxr-xr-x <span class="m">3</span> zulip zulip <span class="m">4096</span> Jul <span class="m">24</span> <span class="m">21</span>:26 .
drwxr-xr-x <span class="m">6</span> zulip zulip <span class="m">4096</span> Jul <span class="m">24</span> <span class="m">21</span>:25 ..
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">1726</span> Jul <span class="m">23</span> <span class="m">00</span>:32 compare-settings-to-template
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">1144</span> Jul <span class="m">23</span> <span class="m">00</span>:32 configure-rabbitmq
-rw-r--r-- <span class="m">1</span> zulip zulip  <span class="m">407</span> Jul <span class="m">23</span> <span class="m">00</span>:32 create-db.sql
-rw-r--r-- <span class="m">1</span> zulip zulip   <span class="m">83</span> Jul <span class="m">23</span> <span class="m">00</span>:32 create-pgroonga.sql
-rw-r--r-- <span class="m">1</span> zulip zulip <span class="m">1687</span> Jul <span class="m">23</span> <span class="m">00</span>:32 debathena-archive.asc
-rwxr-xr-x <span class="m">1</span> zulip zulip  <span class="m">410</span> Jul <span class="m">23</span> <span class="m">00</span>:32 flush-memcached
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">7149</span> Jul <span class="m">23</span> <span class="m">00</span>:32 generate_secrets.py
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">2511</span> Jul <span class="m">23</span> <span class="m">00</span>:32 generate-self-signed-cert
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">1574</span> Jul <span class="m">23</span> <span class="m">00</span>:32 initialize-database
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">4099</span> Jul <span class="m">23</span> <span class="m">00</span>:32 inline_email_css.py
-rwxr-xr-x <span class="m">1</span> zulip zulip  <span class="m">914</span> Jul <span class="m">23</span> <span class="m">00</span>:32 install
-rw-r--r-- <span class="m">1</span> zulip zulip <span class="m">4004</span> Jul <span class="m">23</span> <span class="m">00</span>:32 ksplice.asc
-rw-r--r-- <span class="m">1</span> zulip zulip <span class="m">4812</span> Jul <span class="m">23</span> <span class="m">00</span>:32 pgdg.asc
-rw-r--r-- <span class="m">1</span> zulip zulip <span class="m">3175</span> Jul <span class="m">23</span> <span class="m">00</span>:32 pgroonga-packages.groonga.org.asc
-rw-r--r-- <span class="m">1</span> zulip zulip <span class="m">1663</span> Jul <span class="m">23</span> <span class="m">00</span>:32 pgroonga-ppa.asc
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">1475</span> Jul <span class="m">23</span> <span class="m">00</span>:32 postgresql-init-db
drwxr-xr-x <span class="m">2</span> zulip zulip <span class="m">4096</span> Jul <span class="m">24</span> <span class="m">21</span>:26 __pycache__
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">6073</span> Jul <span class="m">23</span> <span class="m">00</span>:32 restore-backup
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">3345</span> Jul <span class="m">23</span> <span class="m">00</span>:32 setup-certbot
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">1019</span> Jul <span class="m">23</span> <span class="m">00</span>:32 sha256-tarball-to
-rwxr-xr-x <span class="m">1</span> zulip zulip  <span class="m">390</span> Jul <span class="m">23</span> <span class="m">00</span>:32 terminate-psql-sessions
-rwxr-xr-x <span class="m">1</span> zulip zulip <span class="m">2668</span> Jul <span class="m">23</span> <span class="m">00</span>:32 upgrade-postgresql
</code></pre></div>
<p>I had a look at the upgrade log but I couldn't find any specific issue (but I am not a zulip master).<br>
<a href="/user_uploads/2/6f/9O1m87913cd2iFdw62FVNaMi/upgrade-to-4.4.log">upgrade-to-4.4.log</a></p>
<p>Did I miss something?<br>
Thanks in advance for your help!<br>
 Michele</p>



<a name="1238718"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238718" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238718">(Jul 25 2021 at 19:51)</a>:</h4>
<p>Ah, I think we may have forgotten to actually backport the relevant commit to the 4.x branch in the release? I'm not seeing <a href="https://github.com/zulip/zulip/commit/91282ab4903ee67f9c84916171e846f245c79c1d">https://github.com/zulip/zulip/commit/91282ab4903ee67f9c84916171e846f245c79c1d</a> there</p>
<p>CC <span class="user-mention" data-user-id="12178">@Alex Vandiver</span></p>



<a name="1238719"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238719" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238719">(Jul 25 2021 at 19:52)</a>:</h4>
<p>Gah. <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="1238770"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238770" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238770">(Jul 25 2021 at 22:36)</a>:</h4>
<p><span class="user-mention" data-user-id="15939">@Michele Zamboni</span> I've added that commit to the 4.x branch; can you try <code>upgrade-zulip-from-git 4.x</code> and then running it?</p>



<a name="1238771"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238771" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238771">(Jul 25 2021 at 22:37)</a>:</h4>
<p>I'll put out a 4.5 release to get that out probably later today, but it'd be nice to confirm it runs for you.</p>



<a name="1238772"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238772" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238772">(Jul 25 2021 at 22:38)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> just FYI that I'm dealing with a 4.5 release to fix that, just to make sure you're not stressing about it <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>.</p>



<a name="1238774"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238774" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238774">(Jul 25 2021 at 22:42)</a>:</h4>
<p>Thank you for dealing, and apologies for the omission. <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="1238776"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238776" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Zamboni <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238776">(Jul 25 2021 at 22:48)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I confirm that the script is there and I was able to run it. Thanks! :-)</p>



<a name="1238777"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238777" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238777">(Jul 25 2021 at 22:48)</a>:</h4>
<p>Great, thanks!  I'll post the 4.5 release shortly.  And huge thanks for the report!</p>



<a name="1238784"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238784" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michele Zamboni <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238784">(Jul 25 2021 at 22:58)</a>:</h4>
<p>you’re welcome! And thanks everyone for making Zulip better and better!</p>



<a name="1238797"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/database%20corruption/near/1238797" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/database.20corruption.html#1238797">(Jul 25 2021 at 23:13)</a>:</h4>
<p>Release is life; I added a small edit note to the blog post and posted in <a class="stream" data-stream-id="1" href="/#narrow/stream/1-announce">#announce</a>, but won't bother emailing zulip-announce@, since users who do the normal thing of "upgrade to latest minor release" will get what they want.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>