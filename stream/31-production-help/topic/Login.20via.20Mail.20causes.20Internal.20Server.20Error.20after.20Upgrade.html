<html>
<head><meta charset="utf-8"><title>Login via Mail causes Internal Server Error after Upgrade · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20via.20Mail.20causes.20Internal.20Server.20Error.20after.20Upgrade.html">Login via Mail causes Internal Server Error after Upgrade</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1268380"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20via%20Mail%20causes%20Internal%20Server%20Error%20after%20Upgrade/near/1268380" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sven Lenhof <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20via.20Mail.20causes.20Internal.20Server.20Error.20after.20Upgrade.html#1268380">(Oct 19 2021 at 11:19)</a>:</h4>
<p>Hi,<br>
I am currently facing an Issue since my last Update to Zulip Server 5.7.<br>
Whenever a User Authenticates himself with a Mailadress instead of a User, it creates the following Error.</p>
<div class="codehilite"><pre><span></span><code>2021-10-19 10:04:15.028 ERR  [django.request] Internal Server Error: /accounts/login/
Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/core/handlers/exception.py&quot;, line 47, in inner
    response = get_response(request)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/core/handlers/base.py&quot;, line 181, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;./zerver/lib/request.py&quot;, line 390, in _wrapped_view_func
    return view_func(request, *args, **kwargs)
  File &quot;./zerver/views/auth.py&quot;, line 752, in login_page
    )(request)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/generic/base.py&quot;, line 70, in view
    return self.dispatch(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py&quot;, line 43, in _wrapper
    return bound_method(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/decorators/debug.py&quot;, line 89, in sensitive_post_parameters_wrapper
    return view(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py&quot;, line 43, in _wrapper
    return bound_method(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py&quot;, line 130, in _wrapped_view
    response = view_func(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py&quot;, line 43, in _wrapper
    return bound_method(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/decorators/cache.py&quot;, line 44, in _wrapped_view_func
    response = view_func(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/auth/views.py&quot;, line 63, in dispatch
    return super().dispatch(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/generic/base.py&quot;, line 98, in dispatch
    return handler(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/generic/edit.py&quot;, line 141, in post
    if form.is_valid():
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py&quot;, line 175, in is_valid
    return self.is_bound and not self.errors
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py&quot;, line 170, in errors
    self.full_clean()
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py&quot;, line 373, in full_clean
    self._clean_form()
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py&quot;, line 400, in _clean_form
    cleaned_data = self.clean()
  File &quot;./zerver/forms.py&quot;, line 397, in clean
    return_data=return_data,
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/decorators/debug.py&quot;, line 42, in sensitive_variables_wrapper
    return func(*func_args, **func_kwargs)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/auth/__init__.py&quot;, line 76, in authenticate
    user = backend.authenticate(request, **credentials)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/decorator.py&quot;, line 232, in fun
    return caller(func, *(extras + args), **kw)
  File &quot;./zproject/backends.py&quot;, line 285, in rate_limit_auth
    result = auth_func(*args, **kwargs)
  File &quot;./zproject/backends.py&quot;, line 788, in authenticate
    username = self.django_to_ldap_username(username)
  File &quot;./zproject/backends.py&quot;, line 543, in django_to_ldap_username
    email_search_result = find_ldap_users_by_email(username)
  File &quot;./zproject/backends.py&quot;, line 440, in find_ldap_users_by_email
    return email_search.search_for_users(should_populate=False)
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py&quot;, line 342, in search_for_users
    results = search.execute(self.connection, {&quot;email&quot;: self._email})
  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/config.py&quot;, line 150, in execute
    filterstr = self.filterstr % filterargs
KeyError: &#39;user&#39;
</code></pre></div>
<p>The Users usually should authenticate with ldap usernames, so i am searching a way to disable the Login via mail in order to prevent this error.<br>
I already tried this by commeting out the line "'zproject.backends.EmailAuthBackend',  # Email and password; just requires SMTP setup" like you can see below and resarting the Zulip Server</p>
<div class="codehilite"><pre><span></span><code>AUTHENTICATION_BACKENDS = (
    # &#39;zproject.backends.EmailAuthBackend&#39;,  # Email and password; just requires SMTP setup
    # &#39;zproject.backends.GoogleMobileOauth2Backend&#39;,  # Google Apps, setup below
    # &#39;zproject.backends.GitHubAuthBackend&#39;,  # GitHub auth, setup below
    # &#39;zproject.backends.AzureADAuthBackend&#39;,  # Microsoft Azure Active Directory auth, setup below
    &#39;zproject.backends.ZulipLDAPAuthBackend&#39;,  # LDAP, setup below
    # &#39;zproject.backends.ZulipRemoteUserBackend&#39;,  # Local SSO, setup docs on readthedocs
</code></pre></div>
<p>But the Error still comes up, if someone tries to authenticate via mail.</p>
<p>Any help would be wonderful<br>
Thanks in advance!</p>



<a name="1268382"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20via%20Mail%20causes%20Internal%20Server%20Error%20after%20Upgrade/near/1268382" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Felix (strifel) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20via.20Mail.20causes.20Internal.20Server.20Error.20after.20Upgrade.html#1268382">(Oct 19 2021 at 11:30)</a>:</h4>
<p>Did you setup the reverse Search option correctly?<br>
Disabling E-Mail Login in the organisation settings could help you, too</p>



<a name="1268387"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20via%20Mail%20causes%20Internal%20Server%20Error%20after%20Upgrade/near/1268387" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sven Lenhof <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20via.20Mail.20causes.20Internal.20Server.20Error.20after.20Upgrade.html#1268387">(Oct 19 2021 at 11:57)</a>:</h4>
<p>Thanks for the fast answer.</p>
<p>actually there is only LDAP in the Organisation configured.<br>
but in the settings.py is the following line:<br>
´´´<br>
AUTH_LDAP_REVERSE_EMAIL_SEARCH = AUTH_LDAP_USER_SEARCH<br>
´´´<br>
Should this be commented out? I just need to be sure, im doing nothing wrong, cuz its a livesystem</p>



<a name="1268413"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20via%20Mail%20causes%20Internal%20Server%20Error%20after%20Upgrade/near/1268413" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Felix (strifel) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20via.20Mail.20causes.20Internal.20Server.20Error.20after.20Upgrade.html#1268413">(Oct 19 2021 at 13:43)</a>:</h4>
<p>The <code>AUTH_LDAP_REVERSE_EMAIL_SEARCH</code> needs to be able to find a user by email address.<br>
(While the <code>AUTH_LDAP_USER_SEARCH</code> should find them by username)</p>
<p>The example from the documentation is</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">AUTH_LDAP_REVERSE_EMAIL_SEARCH</span> <span class="o">=</span> <span class="n">LDAPSearch</span><span class="p">(</span><span class="s2">"ou=users,dc=example,dc=com"</span><span class="p">,</span>
                                            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span> <span class="s2">"(mail=</span><span class="si">%(email)s</span><span class="s2">)"</span><span class="p">)</span>
</code></pre></div>



<a name="1268414"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20via%20Mail%20causes%20Internal%20Server%20Error%20after%20Upgrade/near/1268414" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20via.20Mail.20causes.20Internal.20Server.20Error.20after.20Upgrade.html#1268414">(Oct 19 2021 at 13:46)</a>:</h4>
<p><span class="user-mention" data-user-id="21906">@Sven Lenhof</span> Making <code>AUTH_LDAP_REVERSE_EMAIL_SEARCH = AUTH_LDAP_USER_SEARCH</code> is wrong because <code>AUTH_LDAP_USER_SEARCH</code> uses <code>%(user)</code> in its experssion, while <code>AUTH_LDAP_REVERSE_EMAIL_SEARCH</code> needs <code>%(email)</code>, even if the search are otherwise synonymous. So e.g. you can have</p>
<div class="codehilite"><pre><span></span><code>AUTH_LDAP_USER_SEARCH = LDAPSearch(
    &quot;ou=users,dc=example,dc=com&quot;, ldap.SCOPE_SUBTREE, &quot;(uid=%(user)s)&quot;
)
AUTH_LDAP_REVERSE_EMAIL_SEARCH = LDAPSearch(
    &quot;ou=users,dc=example,dc=com&quot;, ldap.SCOPE_SUBTREE, &quot;(uid=%(email)s)&quot;
)
</code></pre></div>
<p>if the username = the email address and is stored in the <code>uid</code> ldap attribute</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>