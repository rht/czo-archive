<html>
<head><meta charset="utf-8"><title>Internal Server error for some users / KeyError 170 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html">Internal Server error for some users / KeyError 170</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="806787"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/806787" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#806787">(Jan 06 2020 at 13:32)</a>:</h4>
<p>Hello, we just updated our Zulip to the latest version, since that, some users (minimum 2) got an Internal Server Error when they login from web or desktop app. That's the error log :</p>
<div class="codehilite"><pre><span></span>2020-01-06 13:29:46.016 ERR  [django.request] Internal Server Error: /
Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/546c5f60162d0b5be09d52adebaa995f9c609da3/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/exception.py&quot;, line 41, in inner
    response = get_response(request)
  File &quot;/srv/zulip-venv-cache/546c5f60162d0b5be09d52adebaa995f9c609da3/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/base.py&quot;, line 187, in _get_response
    response = self.process_exception_by_middleware(e, request)
  File &quot;/srv/zulip-venv-cache/546c5f60162d0b5be09d52adebaa995f9c609da3/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/base.py&quot;, line 185, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;./zerver/views/home.py&quot;, line 82, in home
    return home_real(request)
  File &quot;./zerver/decorator.py&quot;, line 414, in _wrapped_view
    return view_func(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/546c5f60162d0b5be09d52adebaa995f9c609da3/zulip-py3-venv/lib/python3.5/site-packages/django/contrib/auth/decorators.py&quot;, line 23, in _wrapped_view
    return view_func(request, *args, **kwargs)
  File &quot;./zerver/decorator.py&quot;, line 467, in _wrapped_view_func
    return rate_limit()(view_func)(request, *args, **kwargs)
  File &quot;./zerver/decorator.py&quot;, line 829, in wrapped_func
    return func(request, *args, **kwargs)
  File &quot;./zerver/views/home.py&quot;, line 125, in home_real
    narrow=narrow)
  File &quot;./zerver/lib/events.py&quot;, line 876, in do_events_register
    include_subscribers=include_subscribers)
  File &quot;./zerver/lib/events.py&quot;, line 332, in fetch_initial_state_data
    user_profile, include_subscribers=include_subscribers)
  File &quot;./zerver/lib/actions.py&quot;, line 4754, in gather_subscriptions_helper
    sub[&#39;stream_id&#39;] = stream_recipient.stream_id_for(sub[&#39;recipient_id&#39;])
  File &quot;./zerver/lib/stream_recipient.py&quot;, line 89, in stream_id_for
    return self.recip_to_stream[recip_id]
KeyError: 170
</pre></div>



<a name="806827"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/806827" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#806827">(Jan 06 2020 at 18:29)</a>:</h4>
<p><span class="user-mention" data-user-id="10026">@Nathanaël M.</span> I haven't seen that exception before.  It seems like it should only happen as a result of some sort of database inconistency.  Was this server generated by the data import tool from HipChat or Slack?</p>



<a name="806829"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/806829" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#806829">(Jan 06 2020 at 18:33)</a>:</h4>
<p>I would investigate by running the following in a <code>manage.py shell</code>:</p>
<div class="codehilite"><pre><span></span>for stream in Stream.objects.all():
     print(stream.recipient_id, stream.id, Recipient.objects.get(type=Recipient.STREAM, type_id=stream.id).id)
</pre></div>


<p>The output should look like this:</p>
<div class="codehilite"><pre><span></span>101 33 101
103 35 103
99 31 99
100 32 100
107 36 107
108 37 108
109 38 109
110 39 110
111 40 111
112 41 112
113 42 113
114 43 114
115 44 115
120 45 120
</pre></div>


<p>and looking for whether there's any cases where the first number is None or otherwise doesn't match the 3rd number.</p>



<a name="806830"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/806830" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#806830">(Jan 06 2020 at 18:33)</a>:</h4>
<p>(If you have a lot of streams you can add an <code>if</code> statement)</p>



<a name="806853"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/806853" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#806853">(Jan 06 2020 at 18:52)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  Not at all, data was from Zulip since we installed more than year ago</p>



<a name="806854"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/806854" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#806854">(Jan 06 2020 at 18:53)</a>:</h4>
<p>I will check tomorrow from failed server</p>



<a name="806864"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/806864" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#806864">(Jan 06 2020 at 19:29)</a>:</h4>
<p>Great, thanks.  The most likely culprit is a bug in this migration: <code>zerver/migrations/0256_userprofile_stream_set_recipient_column_values.py</code></p>



<a name="806865"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/806865" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#806865">(Jan 06 2020 at 19:30)</a>:</h4>
<p>And that test should let us figure out whether this is the right direction to investigate.</p>



<a name="806999"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/806999" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#806999">(Jan 07 2020 at 06:44)</a>:</h4>
<p>Indeed, seems like it could be something relating to that migration. At the same time, in such a case, I'd expect it to be happening deterministically to all users, rather than just "some" <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span>  <span class="user-mention" data-user-id="10026">@Nathanaël M.</span> Are the affected users permanently unable to login, or it only happened to them once or a couple of times and then things worked again?</p>



<a name="807000"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807000" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807000">(Jan 07 2020 at 06:46)</a>:</h4>
<p>As a sidenote, the whole <code>stream_recipient.py</code> file should be possible to simplify significantly now.</p>



<a name="807004"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807004" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807004">(Jan 07 2020 at 08:22)</a>:</h4>
<p>No, it was permanently for 5 users</p>



<a name="807005"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807005" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807005">(Jan 07 2020 at 08:22)</a>:</h4>
<p>I tested with my account, and other work colleagues accounts, it was fine from web or desktop</p>



<a name="807008"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807008" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807008">(Jan 07 2020 at 08:38)</a>:</h4>
<p>Ah, I see. I wonder if they're perhaps all subscribed to a problematic stream, and the people without the issue aren't subscribed to it <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> Either way, running the code in <code>manage.py shell</code> that Tim posted should be very informative for the first step to debug this. Have you managed to do that?</p>



<a name="807010"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807010" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807010">(Jan 07 2020 at 08:43)</a>:</h4>
<p>That's the output : </p>
<div class="codehilite"><pre><span></span>In [1]: for stream in Stream.objects.all():
   ...:      print(stream.recipient_id, stream.id, Recipient.objects.get(type=Recipient.STREAM, type_id=stream.id).id)
   ...:
9 1 9
11 3 11
12 4 12
21 8 21
25 9 25
10 2 10
13 5 13
20 7 20
14 6 14
26 10 26
27 11 27
28 12 28
31 14 31
32 15 32
33 16 33
34 17 34
37 18 37
38 19 38
43 20 43
45 21 45
46 22 46
53 23 53
54 24 54
55 25 55
62 26 62
63 27 63
65 28 65
66 29 66
67 30 67
84 31 84
88 32 88
97 33 97
99 34 99
114 35 114
117 36 117
118 37 118
121 38 121
124 39 124
130 40 130
135 41 135
140 42 140
144 43 144
146 44 146
159 46 159
163 47 163
165 48 165
176 52 176
178 54 178
180 56 180
181 57 181
156 45 156
29 13 29
179 55 179
168 50 168
166 49 166
177 53 177
</pre></div>



<a name="807011"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807011" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807011">(Jan 07 2020 at 09:03)</a>:</h4>
<p>Hmm, the numbers are consistent, but the recipient_id that's causing the KeyError (170) isn't here... Can you check the output of</p>
<div class="codehilite"><pre><span></span>Recipient.objects.get(id=170)
Subscription.objects.filter(recipient_id=170).count()
</pre></div>


<p>in <code>manage.py shell</code> again?</p>



<a name="807012"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807012" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807012">(Jan 07 2020 at 09:03)</a>:</h4>
<p>1</p>



<a name="807013"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807013" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807013">(Jan 07 2020 at 09:04)</a>:</h4>
<p>I posted the 2nd line with the wrong id, please make sure to run with the corrected one? (170)</p>



<a name="807014"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807014" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807014">(Jan 07 2020 at 09:04)</a>:</h4>
<p>No problem</p>



<a name="807015"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807015" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807015">(Jan 07 2020 at 09:05)</a>:</h4>
<div class="codehilite"><pre><span></span>In [4]: Recipient.objects.get(id=170)
   ...: Subscription.objects.filter(recipient_id=170).count()
Out[4]: 6
</pre></div>



<a name="807016"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807016" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807016">(Jan 07 2020 at 09:06)</a>:</h4>
<p>Ah, the first line isn't showing output when run in this way, my bad. Can you run just <code>Recipient.objects.get(id=170)</code> ?</p>



<a name="807017"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807017" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807017">(Jan 07 2020 at 09:08)</a>:</h4>
<p>Also, if you run <code>Subscription.objects.filter(recipient_id=170).select_related().values_list('user_profile__email') </code> you'll get a list of user emails, can you verify that they match the  5 users you said have the problem? There'll be one extra email in the list and if I'm correct that user would have this issue too.</p>



<a name="807018"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807018" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807018">(Jan 07 2020 at 09:15)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">Recipient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">170</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="o">---------------------------------------------------------------------------</span>
<span class="n">DoesNotExist</span>                              <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">formatters</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="mi">700</span>                 <span class="n">type_pprinters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type_printers</span><span class="p">,</span>
    <span class="mi">701</span>                 <span class="n">deferred_pprinters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferred_printers</span><span class="p">)</span>
<span class="o">--&gt;</span> <span class="mi">702</span>             <span class="n">printer</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="mi">703</span>             <span class="n">printer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="mi">704</span>             <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pretty</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">pretty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="mi">400</span>                         <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">object</span> \
    <span class="mi">401</span>                                 <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__repr__&#39;</span><span class="p">)):</span>
<span class="o">--&gt;</span> <span class="mi">402</span>                             <span class="k">return</span> <span class="n">_repr_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
    <span class="mi">403</span>
    <span class="mi">404</span>             <span class="k">return</span> <span class="n">_default_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">IPython</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pretty</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_repr_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
    <span class="mi">695</span>     <span class="s2">&quot;&quot;&quot;A pprint that just redirects to the normal repr function.&quot;&quot;&quot;</span>
    <span class="mi">696</span>     <span class="c1"># Find newlines and replace them with p.break_()</span>
<span class="o">--&gt;</span> <span class="mi">697</span>     <span class="n">output</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="mi">698</span>     <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">output_line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
    <span class="mi">699</span>         <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">django</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">base</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">588</span>     <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="mi">589</span>         <span class="k">try</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">590</span>             <span class="n">u</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">591</span>         <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeEncodeError</span><span class="p">,</span> <span class="ne">UnicodeDecodeError</span><span class="p">):</span>
    <span class="mi">592</span>             <span class="n">u</span> <span class="o">=</span> <span class="s1">&#39;[Bad Unicode data]&#39;</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">models</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">765</span>
    <span class="mi">766</span>     <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">767</span>         <span class="n">display_recipient</span> <span class="o">=</span> <span class="n">get_display_recipient</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">768</span>         <span class="k">return</span> <span class="s2">&quot;&lt;Recipient: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">display_recipient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="mi">769</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">models</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_display_recipient</span><span class="p">(</span><span class="n">recipient</span><span class="p">)</span>
    <span class="mi">100</span>         <span class="n">recipient</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="mi">101</span>         <span class="n">recipient</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
<span class="o">--&gt;</span> <span class="mi">102</span>         <span class="n">recipient</span><span class="o">.</span><span class="n">type_id</span>
    <span class="mi">103</span>     <span class="p">)</span>
    <span class="mi">104</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">models</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_display_recipient_by_id</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">recipient_type</span><span class="p">,</span> <span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">92</span>
     <span class="mi">93</span>     <span class="k">if</span> <span class="n">recipient_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">per_request_display_recipient_cache</span><span class="p">:</span>
<span class="o">---&gt;</span> <span class="mi">94</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">get_display_recipient_remote_cache</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">recipient_type</span><span class="p">,</span> <span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">95</span>         <span class="n">per_request_display_recipient_cache</span><span class="p">[</span><span class="n">recipient_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
     <span class="mi">96</span>     <span class="k">return</span> <span class="n">per_request_display_recipient_cache</span><span class="p">[</span><span class="n">recipient_id</span><span class="p">]</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">cache</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">func_with_caching</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">166</span>                 <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="mi">167</span>
<span class="o">--&gt;</span> <span class="mi">168</span>             <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">169</span>
    <span class="mi">170</span>             <span class="n">cache_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cache_name</span><span class="o">=</span><span class="n">cache_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">display_recipient</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_display_recipient_remote_cache</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">recipient_type</span><span class="p">,</span> <span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">25</span>     <span class="k">if</span> <span class="n">recipient_type</span> <span class="o">==</span> <span class="n">Recipient</span><span class="o">.</span><span class="n">STREAM</span><span class="p">:</span>
     <span class="mi">26</span>         <span class="k">assert</span> <span class="n">recipient_type_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="o">---&gt;</span> <span class="mi">27</span>         <span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">28</span>         <span class="k">return</span> <span class="n">stream</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
     <span class="mi">29</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">django</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">query</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">378</span>             <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span>
    <span class="mi">379</span>                 <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> matching query does not exist.&quot;</span> <span class="o">%</span>
<span class="o">--&gt;</span> <span class="mi">380</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
    <span class="mi">381</span>             <span class="p">)</span>
    <span class="mi">382</span>         <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">MultipleObjectsReturned</span><span class="p">(</span>

<span class="n">DoesNotExist</span><span class="p">:</span> <span class="n">Stream</span> <span class="n">matching</span> <span class="n">query</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span>
</pre></div>



<a name="807019"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807019" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807019">(Jan 07 2020 at 09:16)</a>:</h4>
<p>Oh, when I run <code>Subscription.objects.filter(recipient_id=170).select_related().values_list('user_profile__email')</code> I got the list of users who got the problem</p>



<a name="807020"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807020" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807020">(Jan 07 2020 at 09:17)</a>:</h4>
<p>Yeah, there are 6 emails, but the last is a colleague out from work this week, that's why I didn't saw he got the problem too</p>



<a name="807024"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807024" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807024">(Jan 07 2020 at 09:24)</a>:</h4>
<p>Okay, I think I understand the problem now. The fix should be simple, though I think it's best to wait for Tim to say if my suggestion is safe.</p>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> So it seems like a stream was deleted, deleting the <code>Recipient</code> object, but for some reason at least some of the <code>Subscription</code>s didn't get deleted. (I'm somewhat confused about how that would happen though, did we run into something like this before? Perhaps a Django bug, since these fields have  <code>on_delete=CASCADE</code>). An easy fix should be to just <code>.delete()</code> the Subsciptions (perhaps after saving the <code>.values()</code> dict to a file to be safe). Does that sound right? Or do we have a better approach</p>



<a name="807025"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807025" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807025">(Jan 07 2020 at 09:25)</a>:</h4>
<p>True, I deleted some streams, btw we got a problem since weeks, we can't unsubscribe from streams, or delete streams</p>



<a name="807026"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807026" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807026">(Jan 07 2020 at 09:25)</a>:</h4>
<p>Then, I didn't deleted streams, but removed every user from useless old streams</p>



<a name="807027"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807027" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807027">(Jan 07 2020 at 09:26)</a>:</h4>
<p>I used the <code>manage.py remove_users_from_stream</code></p>



<a name="807028"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807028" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807028">(Jan 07 2020 at 09:27)</a>:</h4>
<p>Huh, that is even stranger. What happens if you try to delete a stream?</p>



<a name="807029"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807029" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807029">(Jan 07 2020 at 09:27)</a>:</h4>
<p>Same</p>



<a name="807030"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807030" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807030">(Jan 07 2020 at 09:27)</a>:</h4>
<p>Nothing happens</p>



<a name="807031"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807031" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807031">(Jan 07 2020 at 09:28)</a>:</h4>
<p>No errors, and nothing in server.log or errors.log</p>



<a name="807036"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807036" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807036">(Jan 07 2020 at 09:34)</a>:</h4>
<p>Anything noteworthy that happened right before this started happening? Upgrade? Server crash? Did you successfully delete some of the mentioned streams, and then things stopped working?</p>



<a name="807038"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807038" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807038">(Jan 07 2020 at 10:24)</a>:</h4>
<p>Maybe an upgrade but it was months ago, I don't really know when it started</p>



<a name="807101"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807101" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807101">(Jan 07 2020 at 21:47)</a>:</h4>
<p><span class="user-mention" data-user-id="10026">@Nathanaël M.</span> just to be clear, did you delete any of those streams using a postgres shell?  That's the simplest explanation I can see for how you'd have avoided the <code>on_delete=CASCADE</code> logic.</p>



<a name="807169"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807169" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807169">(Jan 08 2020 at 08:24)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Oh... I just remembered I deleted a stream with the shell, yeah, but after the upgrade</p>



<a name="807172"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807172" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807172">(Jan 08 2020 at 08:27)</a>:</h4>
<p>Because of impossible unsubscribe/deletion from GUI, I've done that with shell commands...</p>



<a name="807173"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807173" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807173">(Jan 08 2020 at 08:29)</a>:</h4>
<p>Now I know where the error from, can you help me to resolve that bug ?</p>



<a name="807177"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807177" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807177">(Jan 08 2020 at 08:54)</a>:</h4>
<p><span class="user-mention" data-user-id="10026">@Nathanaël M.</span> Can you try running this in <code>manage.py shell</code> to see if there are more problemtic objects like this?</p>
<div class="codehilite"><pre><span></span>for sub in Subscription.objects.all():
    recipient_id = sub.recipient_id
    try:
        Recipient.objects.get(id=recipient_id)
    except Recipient.DoesNotExist:
        print(&quot;Subscription {}: missing recipient with id {}&quot;.format(sub.id, recipient_id))

for recipient in Recipient.objects.filter(type=Recipient.STREAM):
    stream_id = recipient.type_id
    try:
        Stream.objects.get(id=stream_id)
    except Stream.DoesNotExist:
        print(&quot;Recipient {}: missing stream with id {}&quot;.format(recipient, stream_id))
</pre></div>



<a name="807178"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807178" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807178">(Jan 08 2020 at 08:56)</a>:</h4>
<p>For the first command I got nothing</p>



<a name="807179"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807179" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807179">(Jan 08 2020 at 08:57)</a>:</h4>
<p>For the other : </p>
<div class="codehilite"><pre><span></span>DoesNotExist                              Traceback (most recent call last)
&lt;ipython-input-6-5cd7a46cd170&gt; in &lt;module&gt;
      3     try:
----&gt; 4         Stream.objects.get(id=stream_id)
      5     except Stream.DoesNotExist:

~/deployments/2020-01-06-12-05-54/zulip-py3-venv/lib/python3.5/site-packages/django/db/models/manager.py in manager_method(self, *args, **kwargs)
     84             def manager_method(self, *args, **kwargs):
---&gt; 85                 return getattr(self.get_queryset(), name)(*args, **kwargs)
     86             manager_method.__name__ = method.__name__

~/deployments/2020-01-06-12-05-54/zulip-py3-venv/lib/python3.5/site-packages/django/db/models/query.py in get(self, *args, **kwargs)
    379                 &quot;%s matching query does not exist.&quot; %
--&gt; 380                 self.model._meta.object_name
    381             )

DoesNotExist: Stream matching query does not exist.

During handling of the above exception, another exception occurred:

DoesNotExist                              Traceback (most recent call last)
&lt;ipython-input-6-5cd7a46cd170&gt; in &lt;module&gt;
      4         Stream.objects.get(id=stream_id)
      5     except Stream.DoesNotExist:
----&gt; 6         print(&quot;Recipient {}: missing stream with id {}&quot;.format(recipient, stream_id))
      7

~/deployments/2020-01-06-12-05-54/zerver/models.py in __str__(self)
    765
    766     def __str__(self) -&gt; str:
--&gt; 767         display_recipient = get_display_recipient(self)
    768         return &quot;&lt;Recipient: %s (%d, %s)&gt;&quot; % (display_recipient, self.type_id, self.type)
    769

~/deployments/2020-01-06-12-05-54/zerver/models.py in get_display_recipient(recipient)
    100         recipient.id,
    101         recipient.type,
--&gt; 102         recipient.type_id
    103     )
    104

~/deployments/2020-01-06-12-05-54/zerver/models.py in get_display_recipient_by_id(recipient_id, recipient_type, recipient_type_id)
     92
     93     if recipient_id not in per_request_display_recipient_cache:
---&gt; 94         result = get_display_recipient_remote_cache(recipient_id, recipient_type, recipient_type_id)
     95         per_request_display_recipient_cache[recipient_id] = result
     96     return per_request_display_recipient_cache[recipient_id]

~/deployments/2020-01-06-12-05-54/zerver/lib/cache.py in func_with_caching(*args, **kwargs)
    166                 return val[0]
    167
--&gt; 168             val = func(*args, **kwargs)
    169
    170             cache_set(key, val, cache_name=cache_name, timeout=timeout)

~/deployments/2020-01-06-12-05-54/zerver/lib/display_recipient.py in get_display_recipient_remote_cache(recipient_id, recipient_type, recipient_type_id)
     25     if recipient_type == Recipient.STREAM:
     26         assert recipient_type_id is not None
---&gt; 27         stream = Stream.objects.values(&#39;name&#39;).get(id=recipient_type_id)
     28         return stream[&#39;name&#39;]
     29

~/deployments/2020-01-06-12-05-54/zulip-py3-venv/lib/python3.5/site-packages/django/db/models/query.py in get(self, *args, **kwargs)
    378             raise self.model.DoesNotExist(
    379                 &quot;%s matching query does not exist.&quot; %
--&gt; 380                 self.model._meta.object_name
    381             )
    382         raise self.model.MultipleObjectsReturned(

DoesNotExist: Stream matching query does not exist.
</pre></div>



<a name="807180"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807180" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807180">(Jan 08 2020 at 09:02)</a>:</h4>
<p>Hmm, that doesn't look right, can you just copypaste the whole thing I posted as one?</p>



<a name="807188"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807188" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807188">(Jan 08 2020 at 10:26)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">recipient_id</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">recipient_id</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">try</span><span class="p">:</span>
   <span class="o">...</span><span class="p">:</span>         <span class="n">Recipient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">recipient_id</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">except</span> <span class="n">Recipient</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
   <span class="o">...</span><span class="p">:</span>         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subscription </span><span class="si">{}</span><span class="s2">: missing recipient with id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">recipient_id</span><span class="p">))</span>
   <span class="o">...</span><span class="p">:</span>
   <span class="o">...</span><span class="p">:</span> <span class="k">for</span> <span class="n">recipient</span> <span class="ow">in</span> <span class="n">Recipient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Recipient</span><span class="o">.</span><span class="n">STREAM</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">stream_id</span> <span class="o">=</span> <span class="n">recipient</span><span class="o">.</span><span class="n">type_id</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">try</span><span class="p">:</span>
   <span class="o">...</span><span class="p">:</span>         <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">except</span> <span class="n">Stream</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
   <span class="o">...</span><span class="p">:</span>         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recipient </span><span class="si">{}</span><span class="s2">: missing stream with id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recipient</span><span class="p">,</span> <span class="n">stream_id</span><span class="p">))</span>
   <span class="o">...</span><span class="p">:</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="n">DoesNotExist</span>                              <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mf">1e6</span><span class="n">af53b4d60</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
     <span class="mi">10</span>     <span class="k">try</span><span class="p">:</span>
<span class="o">---&gt;</span> <span class="mi">11</span>         <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">)</span>
     <span class="mi">12</span>     <span class="k">except</span> <span class="n">Stream</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">django</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">manager</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">manager_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
     <span class="mi">84</span>             <span class="k">def</span> <span class="nf">manager_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="o">---&gt;</span> <span class="mi">85</span>                 <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(),</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
     <span class="mi">86</span>             <span class="n">manager_method</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">django</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">query</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">379</span>                 <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> matching query does not exist.&quot;</span> <span class="o">%</span>
<span class="o">--&gt;</span> <span class="mi">380</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
    <span class="mi">381</span>             <span class="p">)</span>

<span class="n">DoesNotExist</span><span class="p">:</span> <span class="n">Stream</span> <span class="n">matching</span> <span class="n">query</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span>

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="n">DoesNotExist</span>                              <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mf">1e6</span><span class="n">af53b4d60</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
     <span class="mi">11</span>         <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">)</span>
     <span class="mi">12</span>     <span class="k">except</span> <span class="n">Stream</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
<span class="o">---&gt;</span> <span class="mi">13</span>         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recipient </span><span class="si">{}</span><span class="s2">: missing stream with id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recipient</span><span class="p">,</span> <span class="n">stream_id</span><span class="p">))</span>
     <span class="mi">14</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">models</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">765</span>
    <span class="mi">766</span>     <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">767</span>         <span class="n">display_recipient</span> <span class="o">=</span> <span class="n">get_display_recipient</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">768</span>         <span class="k">return</span> <span class="s2">&quot;&lt;Recipient: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">display_recipient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="mi">769</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">models</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_display_recipient</span><span class="p">(</span><span class="n">recipient</span><span class="p">)</span>
    <span class="mi">100</span>         <span class="n">recipient</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="mi">101</span>         <span class="n">recipient</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
<span class="o">--&gt;</span> <span class="mi">102</span>         <span class="n">recipient</span><span class="o">.</span><span class="n">type_id</span>
    <span class="mi">103</span>     <span class="p">)</span>
    <span class="mi">104</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">models</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_display_recipient_by_id</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">recipient_type</span><span class="p">,</span> <span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">92</span>
     <span class="mi">93</span>     <span class="k">if</span> <span class="n">recipient_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">per_request_display_recipient_cache</span><span class="p">:</span>
<span class="o">---&gt;</span> <span class="mi">94</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">get_display_recipient_remote_cache</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">recipient_type</span><span class="p">,</span> <span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">95</span>         <span class="n">per_request_display_recipient_cache</span><span class="p">[</span><span class="n">recipient_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
     <span class="mi">96</span>     <span class="k">return</span> <span class="n">per_request_display_recipient_cache</span><span class="p">[</span><span class="n">recipient_id</span><span class="p">]</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">cache</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">func_with_caching</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">166</span>                 <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="mi">167</span>
<span class="o">--&gt;</span> <span class="mi">168</span>             <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">169</span>
    <span class="mi">170</span>             <span class="n">cache_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cache_name</span><span class="o">=</span><span class="n">cache_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">display_recipient</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_display_recipient_remote_cache</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">recipient_type</span><span class="p">,</span> <span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">25</span>     <span class="k">if</span> <span class="n">recipient_type</span> <span class="o">==</span> <span class="n">Recipient</span><span class="o">.</span><span class="n">STREAM</span><span class="p">:</span>
     <span class="mi">26</span>         <span class="k">assert</span> <span class="n">recipient_type_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="o">---&gt;</span> <span class="mi">27</span>         <span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">28</span>         <span class="k">return</span> <span class="n">stream</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
     <span class="mi">29</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">django</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">query</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">378</span>             <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span>
    <span class="mi">379</span>                 <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> matching query does not exist.&quot;</span> <span class="o">%</span>
<span class="o">--&gt;</span> <span class="mi">380</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
    <span class="mi">381</span>             <span class="p">)</span>
    <span class="mi">382</span>         <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">MultipleObjectsReturned</span><span class="p">(</span>

<span class="n">DoesNotExist</span><span class="p">:</span> <span class="n">Stream</span> <span class="n">matching</span> <span class="n">query</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span>
</pre></div>



<a name="807190"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807190" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807190">(Jan 08 2020 at 10:39)</a>:</h4>
<p>Uh, not sure what's going on there, can you try like this? (to avoid the annoying exceptions)</p>
<div class="codehilite"><pre><span></span>for sub in Subscription.objects.all():
    recipient_id = sub.recipient_id
    if not Recipient.objects.filter(id=recipient_id).exists():
        print(&quot;Subscription {}: missing recipient with id {}&quot;.format(sub.id, recipient_id))

for recipient in Recipient.objects.filter(type=Recipient.STREAM):
    stream_id = recipient.type_id
    if not Stream.objects.filter(id=stream_id).exists():
        print(&quot;Recipient {}: missing stream with id {}&quot;.format(recipient, stream_id))
</pre></div>



<a name="807192"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807192" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807192">(Jan 08 2020 at 11:31)</a>:</h4>
<p>Same</p>



<a name="807194"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807194" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807194">(Jan 08 2020 at 11:39)</a>:</h4>
<p>Can you post the output?</p>



<a name="807206"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807206" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807206">(Jan 08 2020 at 14:19)</a>:</h4>
<p>Sure : </p>
<div class="codehilite"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">recipient_id</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">recipient_id</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">Recipient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">recipient_id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
   <span class="o">...</span><span class="p">:</span>         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subscription </span><span class="si">{}</span><span class="s2">: missing recipient with id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">recipient_id</span><span class="p">))</span>
   <span class="o">...</span><span class="p">:</span>
   <span class="o">...</span><span class="p">:</span> <span class="k">for</span> <span class="n">recipient</span> <span class="ow">in</span> <span class="n">Recipient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Recipient</span><span class="o">.</span><span class="n">STREAM</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">stream_id</span> <span class="o">=</span> <span class="n">recipient</span><span class="o">.</span><span class="n">type_id</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
   <span class="o">...</span><span class="p">:</span>         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recipient </span><span class="si">{}</span><span class="s2">: missing stream with id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recipient</span><span class="p">,</span> <span class="n">stream_id</span><span class="p">))</span>
   <span class="o">...</span><span class="p">:</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="n">DoesNotExist</span>                              <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">65838</span><span class="n">c73fa58</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="mi">7</span>     <span class="n">stream_id</span> <span class="o">=</span> <span class="n">recipient</span><span class="o">.</span><span class="n">type_id</span>
      <span class="mi">8</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<span class="o">----&gt;</span> <span class="mi">9</span>         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recipient </span><span class="si">{}</span><span class="s2">: missing stream with id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recipient</span><span class="p">,</span> <span class="n">stream_id</span><span class="p">))</span>
     <span class="mi">10</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">models</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">765</span>
    <span class="mi">766</span>     <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">767</span>         <span class="n">display_recipient</span> <span class="o">=</span> <span class="n">get_display_recipient</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">768</span>         <span class="k">return</span> <span class="s2">&quot;&lt;Recipient: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">display_recipient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="mi">769</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">models</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_display_recipient</span><span class="p">(</span><span class="n">recipient</span><span class="p">)</span>
    <span class="mi">100</span>         <span class="n">recipient</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="mi">101</span>         <span class="n">recipient</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
<span class="o">--&gt;</span> <span class="mi">102</span>         <span class="n">recipient</span><span class="o">.</span><span class="n">type_id</span>
    <span class="mi">103</span>     <span class="p">)</span>
    <span class="mi">104</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">models</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_display_recipient_by_id</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">recipient_type</span><span class="p">,</span> <span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">92</span>
     <span class="mi">93</span>     <span class="k">if</span> <span class="n">recipient_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">per_request_display_recipient_cache</span><span class="p">:</span>
<span class="o">---&gt;</span> <span class="mi">94</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">get_display_recipient_remote_cache</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">recipient_type</span><span class="p">,</span> <span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">95</span>         <span class="n">per_request_display_recipient_cache</span><span class="p">[</span><span class="n">recipient_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
     <span class="mi">96</span>     <span class="k">return</span> <span class="n">per_request_display_recipient_cache</span><span class="p">[</span><span class="n">recipient_id</span><span class="p">]</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">cache</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">func_with_caching</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">166</span>                 <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="mi">167</span>
<span class="o">--&gt;</span> <span class="mi">168</span>             <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">169</span>
    <span class="mi">170</span>             <span class="n">cache_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cache_name</span><span class="o">=</span><span class="n">cache_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zerver</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">display_recipient</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_display_recipient_remote_cache</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">recipient_type</span><span class="p">,</span> <span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">25</span>     <span class="k">if</span> <span class="n">recipient_type</span> <span class="o">==</span> <span class="n">Recipient</span><span class="o">.</span><span class="n">STREAM</span><span class="p">:</span>
     <span class="mi">26</span>         <span class="k">assert</span> <span class="n">recipient_type_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="o">---&gt;</span> <span class="mi">27</span>         <span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">recipient_type_id</span><span class="p">)</span>
     <span class="mi">28</span>         <span class="k">return</span> <span class="n">stream</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
     <span class="mi">29</span>

<span class="o">~/</span><span class="n">deployments</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">54</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">django</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">query</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">378</span>             <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span>
    <span class="mi">379</span>                 <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> matching query does not exist.&quot;</span> <span class="o">%</span>
<span class="o">--&gt;</span> <span class="mi">380</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
    <span class="mi">381</span>             <span class="p">)</span>
    <span class="mi">382</span>         <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">MultipleObjectsReturned</span><span class="p">(</span>

<span class="n">DoesNotExist</span><span class="p">:</span> <span class="n">Stream</span> <span class="n">matching</span> <span class="n">query</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span>
</pre></div>



<a name="807210"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807210" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807210">(Jan 08 2020 at 15:33)</a>:</h4>
<p>Ahhh, I see the issue. Trying to print out the <code>Recipient</code> object causes an error, because it requires the existence of the related Stream (which is missing by assumption). We can just print out the ids in this case:</p>
<div class="codehilite"><pre><span></span>for sub in Subscription.objects.all():
    recipient_id = sub.recipient_id
    if not Recipient.objects.filter(id=recipient_id).exists():
        print(&quot;Subscription {}: missing recipient with id {}&quot;.format(sub.id, recipient_id))

for recipient in Recipient.objects.filter(type=Recipient.STREAM):
    stream_id = recipient.type_id
    if not Stream.objects.filter(id=stream_id).exists():
        print(&quot;Recipient {}: missing stream with id {}&quot;.format(recipient.id, stream_id))
</pre></div>



<a name="807215"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807215" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807215">(Jan 08 2020 at 16:28)</a>:</h4>
<p><code>Recipient 170: missing stream with id 51</code></p>



<a name="807236"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807236" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807236">(Jan 08 2020 at 17:45)</a>:</h4>
<p>But as I said, that's bug is not problematic anymore, because we restored a backup last time</p>



<a name="807237"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807237" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807237">(Jan 08 2020 at 17:45)</a>:</h4>
<p>Right now, the main problem is the impossible unsubscribe/deletion from GUI</p>



<a name="807322"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807322" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807322">(Jan 08 2020 at 20:40)</a>:</h4>
<p>OK, great, glad to have confirmation that the deletion was done manually via a database shell.</p>



<a name="807325"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807325" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807325">(Jan 08 2020 at 20:40)</a>:</h4>
<p><span class="user-mention" data-user-id="10026">@Nathanaël M.</span> can you confirm whether you did it with a <code>postgres</code> shell or a Django shell?</p>



<a name="807372"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807372" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807372">(Jan 08 2020 at 21:06)</a>:</h4>
<p>I used the manage command, and I've done a get channel .delete()</p>



<a name="807374"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807374" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807374">(Jan 08 2020 at 21:06)</a>:</h4>
<p>I don't remember the exact manage shell command</p>



<a name="807383"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807383" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807383">(Jan 08 2020 at 21:10)</a>:</h4>
<p>OK, that's helpful.  In theory, the <code>on_delete=CASCADE</code> should have deleted those Subscription objects as well.  We can test that precise procedure, though, to see if it can reproduce this leaked Recipient object.</p>



<a name="807530"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807530" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807530">(Jan 08 2020 at 22:26)</a>:</h4>
<p>Yeah !</p>



<a name="807533"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807533" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807533">(Jan 08 2020 at 22:27)</a>:</h4>
<p>It's useless to test right now, because our main problem is the one I told you before</p>



<a name="807829"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807829" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807829">(Jan 09 2020 at 12:26)</a>:</h4>
<p><span class="user-mention" data-user-id="10026">@Nathanaël M.</span> you ran that code above after restoring the backup? Because the broken subscriptions are gone, but you still have a database incosistency with the <code>Recipient</code> object  pointing to the deleted <code>Stream</code>. Which can cause more problems in the future again.</p>
<p>For the unsubscribing issue, what happens if you try this code to unsubscribe yourself from a test stream:</p>
<div class="codehilite"><pre><span></span>from zerver.lib.actions import bulk_remove_subscriptions

realm = get_realm(&quot;&quot;)
user = get_user_by_delivery_email(&quot;youremail@domain.com&quot;, realm)
stream = get_stream(&quot;YourStreamName&quot;, realm)

bulk_remove_subscriptions([user], [stream], get_client(&quot;ZulipServer&quot;))
</pre></div>


<p>(fill in your email and the stream name in there)</p>



<a name="807853"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807853" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807853">(Jan 09 2020 at 13:49)</a>:</h4>
<p>Yeah, I ran every commands on cloned zulip failed server</p>



<a name="807856"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/807856" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#807856">(Jan 09 2020 at 14:26)</a>:</h4>
<p>Our current restored zulip server runs fine</p>



<a name="808037"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/808037" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#808037">(Jan 10 2020 at 08:08)</a>:</h4>
<p>Fine except unsubscribing/deleting streams? Have you tried running that code I posted above to try to debug the issue? (unless I misunderstood and that issue is resolved now too)</p>



<a name="808054"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/808054" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#808054">(Jan 10 2020 at 10:09)</a>:</h4>
<p>Yeah, just tried and no problems</p>



<a name="808055"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/808055" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#808055">(Jan 10 2020 at 10:09)</a>:</h4>
<p>Unsubscribe with that command works without errors</p>



<a name="809245"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/809245" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathanaël M. <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#809245">(Jan 15 2020 at 08:35)</a>:</h4>
<p>Do I need to create another topic for my problem with GUI ?</p>



<a name="809404"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Internal%20Server%20error%20for%20some%20users%20/%20KeyError%20170/near/809404" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Internal.20Server.20error.20for.20some.20users.20.2F.20KeyError.20170.html#809404">(Jan 15 2020 at 20:31)</a>:</h4>
<p>I'm not sure what your problem with GUI is, but if it's unrelated to this one, you should create a new topic for it.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>