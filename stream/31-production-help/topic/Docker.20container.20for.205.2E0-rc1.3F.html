<html>
<head><meta charset="utf-8"><title>Docker container for 5.0-rc1? · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html">Docker container for 5.0-rc1?</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1346006"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346006" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Felix Fontein <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346006">(Mar 16 2022 at 07:31)</a>:</h4>
<p>Quick question: will there be a Docker container for 5.0-rc1? <a href="https://hub.docker.com/r/zulip/docker-zulip/tags">https://hub.docker.com/r/zulip/docker-zulip/tags</a> does not have a tag for 5.0-rc1 yet.</p>



<a name="1346050"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346050" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maarten <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346050">(Mar 16 2022 at 09:15)</a>:</h4>
<p>I would like this too! Of course we can build it ourselves, but having the release candidate published lowers the bar for us to test it. It also lowers the bar to test any second or third release candidate <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1346166"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346166" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346166">(Mar 16 2022 at 16:25)</a>:</h4>
<p>We should build one -- though I do want to be a bit careful about possibly triggering folks running Docker automatically upgrading the 5.0-rc1.</p>



<a name="1346167"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346167" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346167">(Mar 16 2022 at 16:25)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> <span class="user-mention" data-user-id="699">@Anders Kaseorg</span> thoughts on how we should do the Docker build?  I guess maybe because <code>docker-zulip</code> generally pins a version, it might be OK?</p>



<a name="1346173"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346173" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Felix Fontein <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346173">(Mar 16 2022 at 16:40)</a>:</h4>
<p>Maybe it would be ok if <code>latest</code> isn't updated, only a new tag <code>5.0-rc1</code> is added? Assuming that is not too complicated to implement.</p>



<a name="1346239"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346239" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346239">(Mar 16 2022 at 17:46)</a>:</h4>
<p>Yeah, I'm personally not sure how to avoid <code>latest</code> being updated; hopefully someone else does <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>.</p>



<a name="1346240"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346240" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346240">(Mar 16 2022 at 17:47)</a>:</h4>
<p><code>latest</code> is not magic, it's just another name.  So we can push a 5.0-rc1 without touching latest very easily.</p>



<a name="1346305"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346305" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346305">(Mar 16 2022 at 18:57)</a>:</h4>
<p>Cool, do you have time to deal with that today? I don't have much time left in my workday.</p>



<a name="1346312"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346312" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346312">(Mar 16 2022 at 18:59)</a>:</h4>
<p>Yup, will do.</p>



<a name="1346459"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346459" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346459">(Mar 16 2022 at 20:47)</a>:</h4>
<p>Put me down for a Dockerized 5.0-rc1 as well!</p>



<a name="1346559"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346559" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346559">(Mar 16 2022 at 22:35)</a>:</h4>
<p>I've just pushed <code>zulip/docker-zulip:5.0-rc1-0</code>.</p>



<a name="1346629"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346629" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346629">(Mar 17 2022 at 01:44)</a>:</h4>
<p>Pulled successfully, but I have the same issue with doing a "manual configuration":</p>
<p>zulip_1_758dc3f7b42d | /sbin/entrypoint.sh: line 331: SECRETS_postgres_password: parameter not set</p>
<p>postgres_password is set in /opt/docker/zulip/zulip/settings/etc-zulip/zulip-secrets.conf</p>



<a name="1346758"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346758" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Felix Fontein <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346758">(Mar 17 2022 at 07:39)</a>:</h4>
<p>I've switched to 5.0-rc1 in our production setup and it works well (at least nothing off I noticed so far :) ).</p>



<a name="1346901"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346901" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346901">(Mar 17 2022 at 17:06)</a>:</h4>
<p>So I restarted from scratch, got it up and running, however, the "Create your organization" link wants to add a subdomain for the URL for people to connect to - why?  Why can't it be just the server name?  This is just for an internal employee chat, we don't need multiple organizations...is there a configuration option to ignore that?</p>



<a name="1346904"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346904" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Felix (strifel) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346904">(Mar 17 2022 at 17:13)</a>:</h4>
<p>If you have never created a domain without a subdomain you should be able to just create one.<br>
If you already have one on the server name you can not have a second one</p>



<a name="1346916"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1346916" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1346916">(Mar 17 2022 at 17:26)</a>:</h4>
<p>Interesting, it somehow remembered the top level organization.  Even though I docker rm'd all the old images - but I didn't delete the persistent data.</p>



<a name="1347005"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1347005" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1347005">(Mar 17 2022 at 18:31)</a>:</h4>
<p>Okay, I gave up trying to get manual configuration working.  Can someone tell me how to configure SOCIAL_AUTH_SAML_ENABLED_IDPS in the docker-compose file?   In particular, I need to set the entity_id and url.  <br>
I have this part from the readme, ZULIP_AUTH_BACKENDS: "SAMLAuthBackend", and Zulip comes up with "Log in with SAML".</p>



<a name="1347063"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1347063" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1347063">(Mar 17 2022 at 19:12)</a>:</h4>
<p>I think almost got it...</p>
<div class="codehilite"><pre><span></span><code>  SETTING_SOCIAL_AUTH_SAML_SP_ENTITY_ID: &quot;https://zulip.mydomain&quot;
  SETTING_SOCIAL_AUTH_SAML_SP_URL: &quot;https://auth.mydomain/auth/realms/sdm/&quot;
  ZULIP_AUTH_BACKENDS: &quot;SAMLAuthBackend&quot;
</code></pre></div>



<a name="1347099"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1347099" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1347099">(Mar 17 2022 at 19:56)</a>:</h4>
<p>I'm not entirely sure that SAML configuration is possible with the Docker environment variable passing scheme; it's certainly a messy problem to encode the configuration dictionaries in a shell environment variables via the Docker configuration that can then be decoded and written to the configuration file, and I don't recall our having JSON encoding/decoding logic to deal with that. But maybe not actually hard, just messy...</p>



<a name="1347637"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1347637" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1347637">(Mar 18 2022 at 08:14)</a>:</h4>
<p>For SAML configuration, you have to use the environment variable <code>ZULIP_CUSTOM_SETTINGS</code>. It would look something like this:</p>
<div class="codehilite"><pre><span></span><code>services:
  zulip:
    environment:
      SETTING_EXTERNAL_HOST=chat.example.com
      ZULIP_CUSTOM_SETTINGS: |
        SOCIAL_AUTH_SAML_ORG_INFO = {
            &quot;en-US&quot;: {
                &quot;displayname&quot;: &quot;SSO Login&quot;,
                &quot;name&quot;: &quot;Your Organization name&quot;,
                &quot;url&quot;: &quot;https://chat.example.com&quot;,
            }
        }
</code></pre></div>
<p>There is one catch though. This env variable will be processed BEFORE your other environment configuration. That means, that for example the default value <code>"url": "{}{}".format("https://", EXTERNAL_HOST),</code> does not work (<code>EXTERNAL_HOST</code> which you set via <code>SETTING_EXTERNAL_HOST</code> is inserted after the config block from <code>ZULIP_CUSTOM_SETTINGS</code>). You have to insert the correct URL there.</p>



<a name="1348072"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1348072" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1348072">(Mar 18 2022 at 21:20)</a>:</h4>
<p>TY for help - decided to go with openID instead of SAML.</p>



<a name="1348895"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1348895" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Maarten <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1348895">(Mar 21 2022 at 12:11)</a>:</h4>
<p>I'm currently running a version from <code>main</code>, but I'm also running my own fork of the entrypoint script, because I need to set OAUTH variables with env variables. I made a small PR: </p>
<p><a href="https://github.com/zulip/docker-zulip/pull/347">https://github.com/zulip/docker-zulip/pull/347</a></p>
<p>If this could get merged, I could also test the 5.0 release candidate docker version (together with the helm chart, btw <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span> )</p>



<a name="1348956"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1348956" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1348956">(Mar 21 2022 at 15:22)</a>:</h4>
<p>I have the 5.0.rc1 running, using manual configuration for settings.py, when I try to login I get:</p>
<div class="codehilite"><pre><span></span><code> 237, in request
    raise AuthFailed(self, str(err))
social_core.exceptions.AuthFailed: Authentication failed: HTTPSConnectionPool(host=&#39;auth.mydomain&#39;, port=443): Max retries exceeded with url: /auth/realms/mydomain/.well-known/openid-configuration (Caused by ProxyError(&#39;Cannot connect to proxy.&#39;, OSError(&#39;Tunnel connection failed: 407 Request rejected by proxy&#39;)))
</code></pre></div>
<p>Trying to connect to Keycloak, I configured the client the same as how we configured the client for Xwiki.  </p>
<p>oidc_url: <a href="https://auth.mydomain/auth/realms/mydomain">https://auth.mydomain/auth/realms/mydomain</a></p>



<a name="1348961"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1348961" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1348961">(Mar 21 2022 at 15:25)</a>:</h4>
<p><span class="user-mention" data-user-id="21924">@Maarten</span>: Merged!</p>



<a name="1348978"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1348978" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1348978">(Mar 21 2022 at 15:53)</a>:</h4>
<p>As our Keycloak and Zulip are internal only, do I need to add the ip of our Keycloak server to Smokescreen somewhere?   <br>
"Optionally, you can also configure the Smokescreen ACL list. By default, Smokescreen denies access to all non-public IP addresses, including 127.0.0.1, but allows traffic to all public Internet hosts."  from <a href="https://zulip.readthedocs.io/en/latest/production/deployment.html#customizing-the-outgoing-http-proxy">https://zulip.readthedocs.io/en/latest/production/deployment.html#customizing-the-outgoing-http-proxy</a></p>



<a name="1349038"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349038" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349038">(Mar 21 2022 at 17:23)</a>:</h4>
<p>FYI, tried disabling the proxy via </p>
<div class="codehilite"><pre><span></span><code>root@5febdfeac649:/etc/zulip# cat zulip.conf
[machine]
puppet_classes = zulip::profile::docker
deploy_type = production

[http_proxy]
host =
</code></pre></div>
<p>Same issue.</p>



<a name="1349041"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349041" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349041">(Mar 21 2022 at 17:26)</a>:</h4>
<p>Did you run <code>zulip-puppet-apply</code> after doing that?</p>



<a name="1349042"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349042" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349042">(Mar 21 2022 at 17:26)</a>:</h4>
<p>Oh, this is docker.  Hm.</p>



<a name="1349043"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349043" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349043">(Mar 21 2022 at 17:26)</a>:</h4>
<p>But I'd be surprised if we were routing acl requests through smokescreen.</p>



<a name="1349045"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349045" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349045">(Mar 21 2022 at 17:27)</a>:</h4>
<p>You can check <code>/var/log/zulip/smokescreen.log</code> for failures</p>



<a name="1349046"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349046" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349046">(Mar 21 2022 at 17:27)</a>:</h4>
<p>It's definitely smokescreen, found the log:  /var/log/zulip/smokescreen.log</p>
<div class="codehilite"><pre><span></span><code>{&quot;allow&quot;:false,&quot;content_length&quot;:180,&quot;decision_reason&quot;:&quot;The destination address (10.172.0.9) was denied by rule &#39;Deny: Private Range&#39;. destination address was denied by rule, see error&quot;,&quot;dns_lookup_time_ms&quot;:4,&quot;enforce_would_deny&quot;:true,&quot;id&quot;:&quot;c8sb25km4eqs05stjbj0&quot;,&quot;inbound_remote_addr&quot;:&quot;127.0.0.1:37398&quot;,&quot;level&quot;:&quot;warning&quot;,&quot;msg&quot;:&quot;CANONICAL-PROXY-DECISION&quot;,&quot;project&quot;:&quot;&quot;,&quot;proxy_type&quot;:&quot;connect&quot;,&quot;requested_host&quot;:&quot;auth.mydomain:443&quot;,&quot;role&quot;:&quot;&quot;,&quot;start_time&quot;:&quot;2022-03-21T17:08:38.030546281Z&quot;,&quot;time&quot;:&quot;2022-03-21T17:08:38Z&quot;,&quot;trace_id&quot;:&quot;&quot;}
</code></pre></div>



<a name="1349047"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349047" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349047">(Mar 21 2022 at 17:28)</a>:</h4>
<p>Hm!  Interesting.</p>



<a name="1349048"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349048" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349048">(Mar 21 2022 at 17:29)</a>:</h4>
<p>Just need to figure this part perhaps:  "Optionally, you can also configure the Smokescreen ACL list."</p>



<a name="1349049"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349049" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349049">(Mar 21 2022 at 17:29)</a>:</h4>
<p>That's also not well-defined right now, sadly.  <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span>. <a href="https://github.com/zulip/zulip/pull/20490">#20490</a></p>



<a name="1349051"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349051" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349051">(Mar 21 2022 at 17:30)</a>:</h4>
<p>The problem is that we're normally turn off the proxy by running zulip-puppet-apply, which writes out the settings from <code>/etc/zulip.conf</code> into the supervisor configuration files.</p>



<a name="1349054"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349054" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349054">(Mar 21 2022 at 17:31)</a>:</h4>
<p>We don't really have a clean way of doing that in Docker, though.</p>



<a name="1349055"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349055" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349055">(Mar 21 2022 at 17:31)</a>:</h4>
<p>A hacky workaround would be to open a shell in the container and run zulip-puppet-apply, but that will make your container not easy to re-create exactly.</p>



<a name="1349056"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349056" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349056">(Mar 21 2022 at 17:32)</a>:</h4>
<p>Same with editing the <code>/etc/supervisor/conf.d/zulip/</code> files to remove the proxy environment settings, which is what zulip-puppet-apply would do</p>



<a name="1349057"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349057" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349057">(Mar 21 2022 at 17:34)</a>:</h4>
<p>Also be aware that running without smokescreen, or with <code>--unsafe-allow-private-ranges</code>, <em>will</em> open you up to SSRF.  The tradeoff of Zulip making requests for users is that it's better for end-user privacy, but means that it's in general more susceptible to confused-deputy problems.</p>



<a name="1349058"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349058" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349058">(Mar 21 2022 at 17:39)</a>:</h4>
<p>I think the right general solution here is likely to be to extend the smokescreen config to allow only the ACL role to make requests to your Keycloak server.</p>
<p>To build that, we'll need to:</p>
<ul>
<li>Build smokescreen to respect the role header that Zulip is sending</li>
<li>Have some way (both in-docker and without-docker) of providing a smokescreen config file and/or ACL file</li>
</ul>



<a name="1349059"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349059" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349059">(Mar 21 2022 at 17:39)</a>:</h4>
<p>But the <em>fast</em> solution is adjusting the contents of your Docker container to rip out the proxy env vars, or pass <code>--unsafe-allow-private-ranges</code></p>



<a name="1349061"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349061" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349061">(Mar 21 2022 at 17:40)</a>:</h4>
<p>Okay - that helped - adding --unsafe-allow-private-ranges</p>



<a name="1349063"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349063" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349063">(Mar 21 2022 at 17:41)</a>:</h4>
<p>Actually, instead of <code>UnsafeAllowPrivateRanges</code>, you should try <code>--allow-address 10.172.0.9</code></p>



<a name="1349065"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349065" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349065">(Mar 21 2022 at 17:42)</a>:</h4>
<p>Since AFAICT that does override the general, default, private IP range restriction.  And it's certainly safer than allowing all private IPs.</p>



<a name="1349132"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349132" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349132">(Mar 21 2022 at 19:14)</a>:</h4>
<p>So that works, now I am having trouble with our manual certificates...</p>
<div class="codehilite"><pre><span></span><code>social_core.exceptions.AuthFailed: Authentication failed: HTTPSConnectionPool(host=&#39;auth.mydomain&#39;, port=443): Max retries exceeded with url: /auth/realms/mydomain/.well-known/openid-configuration (Caused by SSLError(SSLCertVerificationError(1, &#39;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1131)&#39;)))
</code></pre></div>
<p>What is really strange is, if I do a curl test inside the container, it seems happy:</p>
<div class="codehilite"><pre><span></span><code>root@0135b4414183:/var/log/zulip# curl -SsI https://zulip.mydomain
HTTP/2 302
server: nginx/1.18.0 (Ubuntu)
date: Mon, 21 Mar 2022 19:07:53 GMT
content-type: text/html; charset=utf-8
content-length: 0
location: /login/
vary: Accept-Language, Cookie
content-language: en
strict-transport-security: max-age=15768000
x-frame-options: DENY
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
</code></pre></div>
<p>But outside:</p>
<div class="codehilite"><pre><span></span><code>root@zulip:/srv/docker-zulip# curl -SsI https://zulip.mydomain
curl: (60) SSL certificate problem: unable to get local issuer certificate
More details here: https://curl.haxx.se/docs/sslcerts.html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn more about this situation and
how to fix it, please visit the web page mentioned above.
</code></pre></div>
<p>From a browser it looks fine:<br>
<a href="/user_uploads/2/dd/vxodmt54inU7UGV5UR3hKISK/zulip-cert-01.png">zulip-cert-01.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/dd/vxodmt54inU7UGV5UR3hKISK/zulip-cert-01.png" title="zulip-cert-01.png"><img src="/user_uploads/2/dd/vxodmt54inU7UGV5UR3hKISK/zulip-cert-01.png"></a></div>



<a name="1349366"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349366" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349366">(Mar 21 2022 at 22:19)</a>:</h4>
<p>Our guess is, during the zulip build, if you pass your custom CA then, it puts it in a python venv?<br>
Which isn't respecting the system trust store at all.  Hence why curl works but Zulip won't use it after the fact?</p>



<a name="1349367"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349367" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349367">(Mar 21 2022 at 22:19)</a>:</h4>
<p>From:  <a href="https://github.com/zulip/docker-zulip#using-a-custom-certificate-bundle-for-outgoing-http-connections">https://github.com/zulip/docker-zulip#using-a-custom-certificate-bundle-for-outgoing-http-connections</a></p>



<a name="1349947"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349947" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349947">(Mar 22 2022 at 16:39)</a>:</h4>
<p>So, I rebuilt our image based on <a href="https://github.com/zulip/docker-zulip#using-a-custom-certificate-bundle-for-outgoing-http-connections">https://github.com/zulip/docker-zulip#using-a-custom-certificate-bundle-for-outgoing-http-connections</a></p>
<p>Added to Dockerfile (which includes our internal custom cert):<br>
COPY ./ca-certificates.crt /etc/ssl/certs/</p>



<a name="1349948"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349948" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349948">(Mar 22 2022 at 16:40)</a>:</h4>
<p>Same issue:</p>
<p>File "/srv/zulip-venv-cache/56ac6adf406011a100282dd526d03537be84d23e/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py", line 237, in request<br>
    raise AuthFailed(self, str(err))<br>
social_core.exceptions.AuthFailed: Authentication failed: HTTPSConnectionPool(host='auth.mydomain', port=443): Max retries exceeded with url: /auth/realms/mydomain/.well-known/openid-configuration (Caused by SSLError(SSLCertVerificationError(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1131)')))</p>



<a name="1349975"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349975" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349975">(Mar 22 2022 at 17:46)</a>:</h4>
<p>So, inside the container, if I do:</p>
<div class="codehilite"><pre><span></span><code>root@d684cd969aaf:/# python3
Python 3.8.10 (default, Nov 26 2021, 20:14:08)
[GCC 9.3.0] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import certifi
&gt;&gt;&gt; certifi.where()
&#39;/etc/ssl/certs/ca-certificates.crt&#39;
</code></pre></div>



<a name="1349978"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349978" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349978">(Mar 22 2022 at 17:47)</a>:</h4>
<p>That file has our internal cert.  However, there is another, in:</p>
<p>/srv/zulip-venv-cache/56ac6adf406011a100282dd526d03537be84d23e/zulip-py3-venv/lib/python3.8/site-packages/stripe/data/ca-certificates.crt</p>



<a name="1349979"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349979" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349979">(Mar 22 2022 at 17:48)</a>:</h4>
<p>That path looks like something only used by the <code>stripe</code> package, and thus likely not relevant.</p>



<a name="1349982"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1349982" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1349982">(Mar 22 2022 at 17:48)</a>:</h4>
<p>Okay...too bad...as that does NOT have our cert...</p>



<a name="1350174"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1350174" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1350174">(Mar 22 2022 at 20:43)</a>:</h4>
<p>You’re not supposed to overwrite /etc/ssl/certs/ca-certificates.crt; that’s managed by the system. See <a href="https://ubuntu.com/server/docs/security-trust-store">installing a root CA in the trust store</a>.</p>



<a name="1350177"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1350177" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1350177">(Mar 22 2022 at 20:45)</a>:</h4>
<p>Tried it that way as well, but <a href="https://github.com/zulip/docker-zulip#using-a-custom-certificate-bundle-for-outgoing-http-connections">https://github.com/zulip/docker-zulip#using-a-custom-certificate-bundle-for-outgoing-http-connections</a> that says to build with a custom ca-certificates.crt.</p>



<a name="1350178"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Docker%20container%20for%205.0-rc1%3F/near/1350178" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Geoff Wild <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F.html#1350178">(Mar 22 2022 at 20:48)</a>:</h4>
<p>For some reason, it looks like Zulip isn't using the system's trust store.  openssl and curl do, and we can connect to our keycloak server with a curl -v and see it is good with the cert.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>