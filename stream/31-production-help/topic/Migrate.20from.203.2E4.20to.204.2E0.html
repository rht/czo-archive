<html>
<head><meta charset="utf-8"><title>Migrate from 3.4 to 4.0 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html">Migrate from 3.4 to 4.0</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1257424"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257424" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257424">(Sep 20 2021 at 22:21)</a>:</h4>
<p>When trying to update using docker container I get the following error.</p>
<div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/utils.py&quot;, line 82, in _execute
    return self.cursor.execute(sql)
  File &quot;/home/zulip/deployments/2021-05-14-00-16-26/zerver/lib/db.py&quot;, line 34, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2021-05-14-00-16-26/zerver/lib/db.py&quot;, line 19, in wrapper_execute
    return action(sql, params)
psycopg2.errors.UniqueViolation: could not create unique index &quot;zerver_stream_realm_id_name_uniq&quot;
DETAIL:  Key (realm_id, upper(name::text))=(2, !DEACTIVATED:TEST) is duplicated.
</code></pre></div>



<a name="1257455"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257455" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257455">(Sep 20 2021 at 23:10)</a>:</h4>
<p>Wondering if I need to run the following <a href="https://blog.zulip.com/2021/07/22/zulip-server-4-4/">https://blog.zulip.com/2021/07/22/zulip-server-4-4/</a><br>
How can I do this via Docker / Docker-Compose</p>



<a name="1257458"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257458" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257458">(Sep 20 2021 at 23:11)</a>:</h4>
<p>Not sure which part of that link you’re referring to. If you mean the PostgreSQL database index corruption issue, don’t worry about it, that’s not a thing in Docker.</p>



<a name="1257460"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257460" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257460">(Sep 20 2021 at 23:15)</a>:</h4>
<p>That is, unless you’re using an external PostgreSQL server rather than the Docker-managed one?</p>



<a name="1257461"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257461" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257461">(Sep 20 2021 at 23:22)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="9" href="/#narrow/stream/9-issues/topic/Migrate.20from.203.2E4.20to.204.2E0">#issues &gt; Migrate from 3.4 to 4.0</a> by <span class="user-mention silent" data-user-id="12178">Alex Vandiver</span></p>



<a name="1257463"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257463" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257463">(Sep 20 2021 at 23:23)</a>:</h4>
<p><span class="user-mention" data-user-id="15764">@Blair MacInnis</span>: Can you show a little more context before that error message?</p>



<a name="1257539"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257539" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257539">(Sep 21 2021 at 17:27)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> here is the logs from docker when trying to migrate.</p>
<div class="codehilite"><pre><span></span><code>=== Begin Initial Configuration Phase ===
Preparing and linking the uploads folder ...
Prepared and linked the uploads directory.
Executing nginx configuration ...
Nginx configuration succeeded.
Certificates configuration succeeded.
Auto backup enabled.
=== End Initial Configuration Phase ===
=== Begin Bootstrap Phase ===
Waiting for database server to allow connections ...
Wild Test
Executing Zulip first start init ...
First Start Init not needed. Continuing.
Migrating Zulip to new version ...
Operations to perform:
  Apply all migrations: analytics, auth, confirmation, contenttypes, otp_static, otp_totp, sessions, social_django, two_factor, zerver
Running migrations:
  Applying auth.0012_alter_user_first_name_max_length... OK
  Applying two_factor.0007_auto_20201201_1019... OK
  Applying zerver.0297_draft... OK
  Applying zerver.0298_fix_realmauditlog_format... OK
  Applying zerver.0299_subscription_role... OK
  Applying zerver.0300_add_attachment_is_web_public... OK
  Applying zerver.0301_fix_unread_messages_in_deactivated_streams... OK
Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/utils.py&quot;, line 82, in _execute
    return self.cursor.execute(sql)
  File &quot;/home/zulip/deployments/2021-05-14-00-16-26/zerver/lib/db.py&quot;, line 34, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2021-05-14-00-16-26/zerver/lib/db.py&quot;, line 19, in wrapper_execute
    return action(sql, params)
psycopg2.errors.UniqueViolation: could not create unique index &quot;zerver_stream_realm_id_name_uniq&quot;
DETAIL:  Key (realm_id, upper(name::text))=(2, !DEACTIVATED:TEST) is duplicated.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/manage.py&quot;, line 52, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py&quot;, line 419, in execute_from_command_line
    utility.execute()
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py&quot;, line 413, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 398, in execute
    output = self.handle(*args, **options)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 89, in wrapped
    res = handle_func(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/commands/migrate.py&quot;, line 244, in handle
    post_migrate_state = executor.migrate(
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/executor.py&quot;, line 117, in migrate
    state = self._migrate_all_forwards(state, plan, full_plan, fake=fake, fake_initial=fake_initial)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/executor.py&quot;, line 147, in _migrate_all_forwards
    state = self.apply_migration(state, migration, fake=fake, fake_initial=fake_initial)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/executor.py&quot;, line 227, in apply_migration
    state = migration.apply(state, schema_editor)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/migration.py&quot;, line 126, in apply
    operation.database_forwards(self.app_label, schema_editor, old_state, project_state)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/operations/special.py&quot;, line 105, in database_forwards
    self._run_sql(schema_editor, self.sql)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/operations/special.py&quot;, line 130, in _run_sql
    schema_editor.execute(statement, params=None)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/base/schema.py&quot;, line 145, in execute
    cursor.execute(sql, params)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/utils.py&quot;, line 66, in execute
    return self._execute_with_wrappers(sql, params, many=False, executor=self._execute)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/utils.py&quot;, line 75, in _execute_with_wrappers
    return executor(sql, params, many, context)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/utils.py&quot;, line 84, in _execute
    return self.cursor.execute(sql, params)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/utils.py&quot;, line 90, in __exit__
    raise dj_exc_value.with_traceback(traceback) from exc_value
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/utils.py&quot;, line 82, in _execute
    return self.cursor.execute(sql)
  File &quot;/home/zulip/deployments/2021-05-14-00-16-26/zerver/lib/db.py&quot;, line 34, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2021-05-14-00-16-26/zerver/lib/db.py&quot;, line 19, in wrapper_execute
    return action(sql, params)
django.db.utils.IntegrityError: could not create unique index &quot;zerver_stream_realm_id_name_uniq&quot;
DETAIL:  Key (realm_id, upper(name::text))=(2, !DEACTIVATED:TEST) is duplicated.

  Applying zerver.0302_case_insensitive_stream_name_index...Zulip migration failed with exit code 1. Exiting.
</code></pre></div>



<a name="1257540"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257540" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257540">(Sep 21 2021 at 17:29)</a>:</h4>
<p>Are you using an external PostgreSQL host?</p>



<a name="1257541"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257541" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257541">(Sep 21 2021 at 17:29)</a>:</h4>
<p>Looks like duplicates in the DB<br>
No using docker-compose</p>



<a name="1257542"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257542" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257542">(Sep 21 2021 at 17:34)</a>:</h4>
<p>Here is the docker-compose file running </p>
<div class="codehilite"><pre><span></span><code>version: &#39;3.6&#39;
services:
  database:
    image: &#39;zulip/zulip-postgresql&#39;
    environment:
      POSTGRES_DB: zulip
      POSTGRES_USER: zulip
      POSTGRES_PASSWORD: &#39;xxxxxxxxxxxx&#39;
    volumes:
      - &#39;/data/docker/zulip/postgresql/data:/var/lib/postgresql/data:rw&#39;
  memcached:
    image: &#39;memcached:alpine&#39;
    command:
      - &#39;sh&#39;
      - &#39;-euc&#39;
      - |
        echo &#39;mech_list: plain&#39; &gt; &quot;$$SASL_CONF_PATH&quot;
        echo &quot;zulip@$$HOSTNAME:$$MEMCACHED_PASSWORD&quot; &gt; &quot;$$MEMCACHED_SASL_PWDB&quot;
        echo &quot;zulip@localhost:$$MEMCACHED_PASSWORD&quot; &gt;&gt; &quot;$$MEMCACHED_SASL_PWDB&quot;
        exec memcached -S
    environment:
      SASL_CONF_PATH: &#39;/home/memcache/memcached.conf&#39;
      MEMCACHED_SASL_PWDB: &#39;/home/memcache/memcached-sasl-db&#39;
      MEMCACHED_PASSWORD: &#39;xxxxxxxxxxxx&#39;
    restart: always
  rabbitmq:
    image: &#39;rabbitmq:3.7.7&#39;
    hostname: zulip-rabbit
    restart: always
    environment:
        RABBITMQ_DEFAULT_USER: &#39;zulip&#39;
        RABBITMQ_DEFAULT_PASS: &#39;xxxxxxxxxxxx&#39;
    volumes:
      - &#39;/data/docker/zulip/rabbitmq:/var/lib/rabbitmq:rw&#39;
  redis:
    image: &#39;redis:alpine&#39;
    command:
      - &#39;sh&#39;
      - &#39;-euc&#39;
      - |
        echo &quot;requirepass &#39;$$REDIS_PASSWORD&#39;&quot; &gt; /etc/redis.conf
        exec redis-server /etc/redis.conf
    environment:
      REDIS_PASSWORD: &#39;xxxxxxxxxxxx&#39;
    volumes:
      - &#39;/data/docker/zulip/redis:/var/lib/redis:rw&#39;
  zulip:
    image: &#39;zulip/docker-zulip:4.0-0&#39;
    ports:
      - &#39;80:80&#39;
      - &#39;443:443&#39;
    environment:
      MANUAL_CONFIGURATION: &#39;True&#39;
      LINK_SETTINGS_TO_DATA: &#39;True&#39;
      DB_HOST: &#39;database&#39;
      DB_HOST_PORT: &#39;5432&#39;
      DB_USER: &#39;zulip&#39;
      SSL_CERTIFICATE_GENERATION: &#39;certbot&#39;
      SETTING_MEMCACHED_LOCATION: &#39;memcached:11211&#39;
      SETTING_RABBITMQ_HOST: &#39;rabbitmq&#39;
      SETTING_REDIS_HOST: &#39;redis&#39;
      SETTING_EXTERNAL_HOST: &#39;stg-zulip.server&#39;
      ZULIP_AUTO_GENERATE_CERTS: &quot;True&quot;
      # Email configuration
      SETTING_ZULIP_ADMINISTRATOR: &#39;admin@mail.com&#39;
      SETTING_EMAIL_HOST: &#39;mail.server&#39;  # e.g. smtp.example.com
      SETTING_EMAIL_HOST_USER: &#39;servers&#39;
      SETTING_EMAIL_PORT: &#39;587&#39;
      SETTING_EMAIL_USE_SSL: &#39;False&#39;
      SETTING_EMAIL_USE_TLS: &#39;True&#39;
      ZULIP_AUTH_BACKENDS: &#39;EmailAuthBackend&#39;
      # These should match RABBITMQ_DEFAULT_PASS, POSTGRES_PASSWORD,
      # MEMCACHED_PASSWORD, and REDIS_PASSWORD above.
      SECRETS_rabbitmq_password: &#39;xxxxxxxxxxxx&#39;
      SECRETS_postgres_password: &#39;xxxxxxxxxxxx&#39;
      SECRETS_memcached_password: &#39;xxxxxxxxxxxx&#39;
      SECRETS_redis_password: &#39;xxxxxxxxxxxx&#39;
      SECRETS_secret_key: &#39;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#39;
      # Uncomment this when configuring the mobile push notifications service
      SETTING_PUSH_NOTIFICATION_BOUNCER_URL: &#39;https://push.zulipchat.com&#39;
    volumes:
      - &#39;/data/docker/zulip/zulip:/data:rw&#39;
      - &#39;./templates:/home/zulip/templates:rw&#39;
      - &#39;/data/docker/zulip/zulip/nginx/zulip-enterprise:/etc/nginx/sites-available/zulip-enterprise:rw&#39;
      - &#39;./entrypoint.sh:/sbin/entrypoint.sh:ro&#39;
      # zulip rss feed bot
      - &#39;./rss-feed/feeds-url:/home/zulip/.cache/zulip-rss/rss-feeds&#39;
      - &#39;./rss-feed/zuliprc:/home/zulip/.zuliprc&#39;
    ulimits:
      nofile:
        soft: 40000
        hard: 50000
</code></pre></div>



<a name="1257562"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257562" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257562">(Sep 21 2021 at 18:03)</a>:</h4>
<p>Can I dump the DB and have Zulip recreate or would I have to do manually. If so what is the Zulip scheme ?</p>



<a name="1257570"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257570" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257570">(Sep 21 2021 at 18:33)</a>:</h4>
<p>I've also tried starting Zulip 4.0-0 from scrach I get the following.</p>
<div class="codehilite"><pre><span></span><code>=== Begin Initial Configuration Phase ===
Preparing and linking the uploads folder ...
Prepared and linked the uploads directory.
Executing nginx configuration ...
Nginx configuration succeeded.
Scheduling LetsEncrypt cert generation ...
Generating self-signed certificates ...
+ is_redhat=false
+ &#39;[&#39; -e /etc/redhat-release &#39;]&#39;
+ SSLDIR=/etc/ssl
+ KEYFILE=/etc/ssl/private/zulip.key
+ CERTFILE=/etc/ssl/certs/zulip.combined-chain.crt
+ &#39;[&#39; -n &#39;&#39; &#39;]&#39;
+ &#39;[&#39; -z &#39;&#39; &#39;]&#39;
+ &#39;[&#39; -e /etc/ssl/private/zulip.key &#39;]&#39;
+ &#39;[&#39; -e /etc/ssl/certs/zulip.combined-chain.crt &#39;]&#39;
+ rm -f /etc/ssl/private/zulip.key /etc/ssl/certs/zulip.combined-chain.crt
+ [[ stg-chat.sfcc.tech =~ ^(([0-9]+\.){3}[0-9]+)(:[0-9]+)?$ ]]
+ [[ stg-chat.sfcc.tech =~ ^\[([^][]*)](:[0-9]+)?$ ]]
+ [[ stg-chat.sfcc.tech =~ ^([^:]+)(:[0-9]+)?$ ]]
+ subjectAltName=DNS:stg-chat.sfcc.tech
++ mktemp
+ config=/tmp/tmp.Wxk9oaExzx
+ trap &#39;rm -f &quot;$config&quot;&#39; EXIT
+ cat
+ &#39;[&#39; false = true &#39;]&#39;
+ apt-get install -y openssl
Reading package lists...
Building dependency tree...
Reading state information...
+ openssl req -new -x509 -config /tmp/tmp.Wxk9oaExzx -days 3650 -nodes -sha256 -out /etc/ssl/certs/zulip.combined-chain.crt -keyout /etc/ssl/private/zulip.key
openssl is already the newest version (1.1.1f-1ubuntu2.3).
openssl set to manually installed.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Generating a RSA private key
...+++++
........................................+++++
writing new private key to &#39;/etc/ssl/private/zulip.key&#39;
-----
Cannot write random bytes:
139690619921728:error:2407007A:random number generator:RAND_write_file:Not a regular file:../crypto/rand/randfile.c:183:Filename=/dev/urandom
+ chmod 644 /etc/ssl/certs/zulip.combined-chain.crt
+ chmod 640 /etc/ssl/private/zulip.key
+ rm -f /tmp/tmp.Wxk9oaExzx
Self-signed certificate generation succeeded.
Certificates configuration succeeded.
Executing additional puppet configuration ...
No additional puppet configuration executed.
Auto backup enabled.
=== End Initial Configuration Phase ===
=== Begin Bootstrap Phase ===
Waiting for database server to allow connections ...
......Executing Zulip first start init ...
+++ readlink -f /home/zulip/deployments/current/scripts/setup/initialize-database
++ dirname /home/zulip/deployments/2021-05-14-00-16-26/scripts/setup/initialize-database
+ THIS_DIR=/home/zulip/deployments/2021-05-14-00-16-26/scripts/setup
+ cd /home/zulip/deployments/2021-05-14-00-16-26/scripts/setup/../..
+ ./manage.py checkconfig
Error accessing Zulip secrets; manage.py in production must be run as the zulip user.
Zulip first start database initi failed in &quot;initialize-database&quot; exit code 1. Exiting.
</code></pre></div>



<a name="1257589"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257589" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257589">(Sep 21 2021 at 19:27)</a>:</h4>
<p>This original error suggests to me that probably one needs to hand-fix this duplication in the database and then run <code>manage.py migrate</code>:</p>
<div class="codehilite"><pre><span></span><code>DETAIL:  Key (realm_id, upper(name::text))=(2, !DEACTIVATED:TEST) is duplicated.
</code></pre></div>



<a name="1257590"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257590" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257590">(Sep 21 2021 at 19:27)</a>:</h4>
<p>I don't think any strategy involving dumping the database is going to be super successful, since the problem is that bit of database corruption.</p>



<a name="1257592"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257592" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257592">(Sep 21 2021 at 19:28)</a>:</h4>
<p>(I believe manually renaming one of the two duplicate rows via <code>manage.py dbshell</code> to <code>!DEACTIVATED:TEST2</code> or whatever will work).</p>



<a name="1257654"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257654" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257654">(Sep 21 2021 at 22:01)</a>:</h4>
<p>okay I'll have a go at it</p>



<a name="1257960"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257960" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257960">(Sep 22 2021 at 16:27)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I created an image of the failed container named it <code>zulip-debug</code> I then try running  <code>docker run -it zulip-debug /bin/bash</code>, but get the following error <code>docker: Error response from daemon: cannot mount volume over existing file, file exists /data2/docker/overlay2/4bf293a8211c90c5980cabb81fcff29be5dfd02a10fd48a3d5501ea13ab779c4/merged/etc/nginx/sites-available/zulip-enterprise.</code><br>
Do you know anyway around this ?</p>



<a name="1257961"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257961" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257961">(Sep 22 2021 at 16:31)</a>:</h4>
<p>nvm got in now sorry</p>



<a name="1257963"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrate%20from%203.4%20to%204.0/near/1257963" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrate.20from.203.2E4.20to.204.2E0.html#1257963">(Sep 22 2021 at 16:37)</a>:</h4>
<p>So was able to get into the broken container and try using manage.py</p>
<div class="codehilite"><pre><span></span><code>zulip@53d119190b6e:~/deployments/current$ ./manage.py help
Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 46, in &lt;module&gt;
    log_management_command(sys.argv, settings.MANAGEMENT_LOG_PATH)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/conf/__init__.py&quot;, line 82, in __getattr__
    self._setup(name)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/conf/__init__.py&quot;, line 69, in _setup
    self._wrapped = Settings(settings_module)
  File &quot;/srv/zulip-venv-cache/9d0f5ac272f4e644b222ed65b0b5a996616a215f/zulip-py3-venv/lib/python3.8/site-packages/django/conf/__init__.py&quot;, line 170, in __init__
    mod = importlib.import_module(self.SETTINGS_MODULE)
  File &quot;/usr/lib/python3.8/importlib/__init__.py&quot;, line 127, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 1014, in _gcd_import
  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 991, in _find_and_load
  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 975, in _find_and_load_unlocked
  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 671, in _load_unlocked
  File &quot;&lt;frozen importlib._bootstrap_external&gt;&quot;, line 783, in exec_module
  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 219, in _call_with_frames_removed
  File &quot;/home/zulip/deployments/2021-05-14-00-16-26/zproject/settings.py&quot;, line 19, in &lt;module&gt;
    from .configured_settings import *  # noqa: F401,F403 isort: skip
  File &quot;/home/zulip/deployments/2021-05-14-00-16-26/zproject/configured_settings.py&quot;, line 8, in &lt;module&gt;
    from .default_settings import *  # noqa: F401,F403 isort: skip
  File &quot;/home/zulip/deployments/2021-05-14-00-16-26/zproject/default_settings.py&quot;, line 15, in &lt;module&gt;
    from .dev_settings import EXTERNAL_HOST, ZULIP_ADMINISTRATOR
ModuleNotFoundError: No module named &#39;zproject.dev_settings&#39;
</code></pre></div>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>