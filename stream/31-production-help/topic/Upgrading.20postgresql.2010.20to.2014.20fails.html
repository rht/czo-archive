<html>
<head><meta charset="utf-8"><title>Upgrading postgresql 10 to 14 fails · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html">Upgrading postgresql 10 to 14 fails</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1537176"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537176" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537176">(Mar 30 2023 at 08:51)</a>:</h4>
<p>Hi there,<br>
In my on-premises Zulip instance (Zulip 5.5, Ubuntu 20.04.6 LTS) I try to upgrade postgres from version 10 to 14 according to <a href="https://zulip.readthedocs.io/en/stable/production/upgrade-or-modify.html#upgrading-postgresql">Zulip documentation</a>.<br>
The call of the <code>upgrade-postgresql</code> script results in an error of <code>pg_upgrade</code> due to a missing config dir as you can see in the log below:</p>
<div class="codehilite"><pre><span></span><code>root@zulip:~# /home/zulip/deployments/current/scripts/setup/upgrade-postgresql
[...]
+ &#39;[&#39; &#39;!&#39; -f scripts/setup/apt-repos/zulip/focal.list &#39;]&#39;
++ sha256sum scripts/setup/apt-repos/zulip/custom.sh scripts/setup/apt-repos/zulip/focal.list scripts/setup/apt-repos/zulip/pgdg.asc scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc scripts/setup/apt-repos/zulip/pgroonga-ppa.asc scripts/lib/setup-apt-repo
+ DEPENDENCIES_HASH=&#39;1880c6337400b54a7e344d9c4a42ca11482709ab2641e5fd3aae85f01fd5ea5d  scripts/setup/apt-repos/zulip/custom.sh
93d04e5e9e4e22c5d38e1dca1cf1bfc0fee36a79d7205c1397ad255f464bc09d  scripts/setup/apt-repos/zulip/focal.list
0144068502a1eddd2a0280ede10ef607d1ec592ce819940991203941564e8e76  scripts/setup/apt-repos/zulip/pgdg.asc
06f00f144d99826f27b8912c26d02dd4e0247f662666be5378740828d39c6a41  scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc
a133aa690de5fc1d46ca23a54bf6dd1c6468e8426e1ec9661f390e4f41a365d1  scripts/setup/apt-repos/zulip/pgroonga-ppa.asc
8f70beaa2b1b8621a156d140e6004367684f434f0978baa78e5f742ac3fb593a  scripts/lib/setup-apt-repo&#39;
+ DEPENDENCIES_HASH_FILE=/var/lib/zulip/setup-repositories-state-zulip
+ touch /var/lib/zulip/setup-repositories-state-zulip
++ cat /var/lib/zulip/setup-repositories-state-zulip
+ LAST_DEPENDENCIES_HASH=&#39;1880c6337400b54a7e344d9c4a42ca11482709ab2641e5fd3aae85f01fd5ea5d  scripts/setup/apt-repos/zulip/custom.sh
93d04e5e9e4e22c5d38e1dca1cf1bfc0fee36a79d7205c1397ad255f464bc09d  scripts/setup/apt-repos/zulip/focal.list
0144068502a1eddd2a0280ede10ef607d1ec592ce819940991203941564e8e76  scripts/setup/apt-repos/zulip/pgdg.asc
06f00f144d99826f27b8912c26d02dd4e0247f662666be5378740828d39c6a41  scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc
a133aa690de5fc1d46ca23a54bf6dd1c6468e8426e1ec9661f390e4f41a365d1  scripts/setup/apt-repos/zulip/pgroonga-ppa.asc
8f70beaa2b1b8621a156d140e6004367684f434f0978baa78e5f742ac3fb593a  scripts/lib/setup-apt-repo&#39;
+ &#39;[&#39; &#39;1880c6337400b54a7e344d9c4a42ca11482709ab2641e5fd3aae85f01fd5ea5d  scripts/setup/apt-repos/zulip/custom.sh
93d04e5e9e4e22c5d38e1dca1cf1bfc0fee36a79d7205c1397ad255f464bc09d  scripts/setup/apt-repos/zulip/focal.list
0144068502a1eddd2a0280ede10ef607d1ec592ce819940991203941564e8e76  scripts/setup/apt-repos/zulip/pgdg.asc
06f00f144d99826f27b8912c26d02dd4e0247f662666be5378740828d39c6a41  scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc
a133aa690de5fc1d46ca23a54bf6dd1c6468e8426e1ec9661f390e4f41a365d1  scripts/setup/apt-repos/zulip/pgroonga-ppa.asc
8f70beaa2b1b8621a156d140e6004367684f434f0978baa78e5f742ac3fb593a  scripts/lib/setup-apt-repo&#39; = &#39;1880c6337400b54a7e344d9c4a42ca11482709ab2641e5fd3aae85f01fd5ea5d  scripts/setup/apt-repos/zulip/custom.sh
93d04e5e9e4e22c5d38e1dca1cf1bfc0fee36a79d7205c1397ad255f464bc09d  scripts/setup/apt-repos/zulip/focal.list
0144068502a1eddd2a0280ede10ef607d1ec592ce819940991203941564e8e76  scripts/setup/apt-repos/zulip/pgdg.asc
06f00f144d99826f27b8912c26d02dd4e0247f662666be5378740828d39c6a41  scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc
a133aa690de5fc1d46ca23a54bf6dd1c6468e8426e1ec9661f390e4f41a365d1  scripts/setup/apt-repos/zulip/pgroonga-ppa.asc
8f70beaa2b1b8621a156d140e6004367684f434f0978baa78e5f742ac3fb593a  scripts/lib/setup-apt-repo&#39; &#39;]&#39;
+ exit 0
+ apt-get install -y postgresql-14
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following additional packages will be installed:
  libllvm10
The following NEW packages will be installed:
  libllvm10 postgresql-14
0 upgraded, 2 newly installed, 0 to remove and 0 not upgraded.
Need to get 31.1 MB of archives.
After this operation, 125 MB of additional disk space will be used.
Get:1 http://de.archive.ubuntu.com/ubuntu focal/main amd64 libllvm10 amd64 1:10.0.0-4ubuntu1 [15.3 MB]
Get:2 http://apt.postgresql.org/pub/repos/apt focal-pgdg/main amd64 postgresql-14 amd64 14.7-1.pgdg20.04+1 [15.8 MB]
Fetched 31.1 MB in 20s (1,583 kB/s)
Preconfiguring packages ...
Selecting previously unselected package libllvm10:amd64.
(Reading database ... 136335 files and directories currently installed.)
Preparing to unpack .../libllvm10_1%3a10.0.0-4ubuntu1_amd64.deb ...
Unpacking libllvm10:amd64 (1:10.0.0-4ubuntu1) ...
Selecting previously unselected package postgresql-14.
Preparing to unpack .../postgresql-14_14.7-1.pgdg20.04+1_amd64.deb ...
Unpacking postgresql-14 (14.7-1.pgdg20.04+1) ...
Setting up libllvm10:amd64 (1:10.0.0-4ubuntu1) ...
Setting up postgresql-14 (14.7-1.pgdg20.04+1) ...
Creating new PostgreSQL cluster 14/main ...
/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user &quot;postgres&quot;.
This user must also own the server process.
The database cluster will be initialized with locale &quot;en_US.UTF-8&quot;.
The default database encoding has accordingly been set to &quot;UTF8&quot;.
The default text search configuration will be set to &quot;english&quot;.
Data page checksums are disabled.
fixing permissions on existing directory /var/lib/postgresql/14/main ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Europe/Berlin
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok
update-alternatives: using /usr/share/postgresql/14/man/man1/postmaster.1.gz to provide /usr/share/man/man1/postmaster.1.gz (postmaster.1.gz) in auto mode
Processing triggers for postgresql-common (248.pgdg20.04+1) ...
Building PostgreSQL dictionaries from installed myspell/hunspell packages...
  en_us
Removing obsolete dictionary files:
Processing triggers for libc-bin (2.31-0ubuntu9.9) ...
+ grep -qE &#39;^14\s+main\b&#39;
+ pg_lsclusters -h
+ pg_dropcluster 14 main --stop
++ mktemp -d
+ TEMP_CONF_DIR=/tmp/tmp.tU0S3DqIZ9
+ cp /etc/zulip/zulip.conf /tmp/tmp.tU0S3DqIZ9
+ ZULIP_CONF=/tmp/tmp.tU0S3DqIZ9/zulip.conf
+ crudini --set /tmp/tmp.tU0S3DqIZ9/zulip.conf postgresql version 14
+ crudini --set /tmp/tmp.tU0S3DqIZ9/zulip.conf machine puppet_classes zulip::profile::base,zulip::postgresql_base
+ touch /usr/share/postgresql/14/pgroonga_setup.sql.applied
+ FACTER_LEAVE_SUPERVISOR=true
+ /home/zulip/deployments/current/scripts/setup/../../scripts/zulip-puppet-apply -f --config /tmp/tmp.tU0S3DqIZ9/zulip.conf
Notice: Compiled catalog for zulip.ixsys.de in environment production in 0.63 seconds
Notice: /Stage[main]/Zulip::Postgresql_base/File[/usr/share/postgresql/14/tsearch_data/zulip_english.stop]/ensure: defined content as &#39;{md5}34e771a8f53b4ae2e8b43affd3f820b2&#39;
Notice: Applied catalog in 0.79 seconds
+ rm -rf /tmp/tmp.tU0S3DqIZ9
++ mktemp /var/log/zulip/upgrade-postgresql-10-14.XXXXXXXXX.log
+ UPGRADE_LOG=/var/log/zulip/upgrade-postgresql-10-14.UnjHTa7jk.log
+ pg_upgradecluster -v 14 10 main --method=upgrade --link
+ tee /var/log/zulip/upgrade-postgresql-10-14.UnjHTa7jk.log
Stopping old cluster...
Creating new PostgreSQL cluster 14/main ...
/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main --auth-local peer --auth-host scram-sha-256 --no-instructions --encoding UTF8 --lc-collate en_US.UTF-8 --lc-ctype en_US.UTF-8
The files belonging to this database system will be owned by user &quot;postgres&quot;.
This user must also own the server process.

The database cluster will be initialized with locale &quot;en_US.UTF-8&quot;.
The default text search configuration will be set to &quot;english&quot;.

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/14/main ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Europe/Berlin
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

Copying old configuration files...
Copying old start.conf...
Copying old pg_ctl.conf...
/usr/lib/postgresql/14/bin/pg_upgrade -b /usr/lib/postgresql/10/bin -B /usr/lib/postgresql/14/bin -p 5432 -P 5433 -d /etc/postgresql/10/main -D /etc/postgresql/14/main --link
Finding the real data directory for the source cluster      ok
Finding the real data directory for the target cluster      2023-03-28 20:06:53.811 GMT [1785916] LOG:  could not open configuration directory &quot;/etc/postgresql/14/main/conf.d&quot;: No such file or directory
2023-03-28 20:06:53.811 GMT [1785916] FATAL:  configuration file &quot;/etc/postgresql/14/main/postgresql.conf&quot; contains errors

could not get data directory using &quot;/usr/lib/postgresql/14/bin/postgres&quot; -D &quot;/etc/postgresql/14/main&quot; -C data_directory: No such file or directory
Failure, exiting
Error: pg_upgrade run failed. Logfiles are in /var/log/postgresql/pg_upgradecluster-10-14-main.uLoD
Error during cluster dumping, removing new cluster
</code></pre></div>
<p>I have no clue which part of the process is expected to create that missing config directory (<code>puppet</code>, <code>pg_upgrade</code>?). I have searched the web for similar error cases but have found nothing useful. Do any of you have any ideas on how to fix this?</p>



<a name="1537374"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537374" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537374">(Mar 30 2023 at 15:30)</a>:</h4>
<div class="codehilite"><pre><span></span><code>LOG:  could not open configuration directory &quot;/etc/postgresql/14/main/conf.d&quot;: No such file or directory
</code></pre></div>
<p>That directory should have been created when <code>postgresql-14</code> was installed.  You're not out of disk space, and this is a normal Ubuntu install?</p>
<p><span class="user-mention" data-user-id="16301">@Harald Oest</span>: Can you show:</p>
<div class="codehilite"><pre><span></span><code>ls -al /etc/postgresql/14/main/
</code></pre></div>



<a name="1537380"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537380" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537380">(Mar 30 2023 at 15:37)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="12178">@Alex Vandiver</span> , thx for your reply.<br>
Well, that's the problem, the dir ist missing:</p>
<div class="codehilite"><pre><span></span><code>root@zulip:/home/maint# ls /etc/postgresql/
10  9.3
</code></pre></div>
<p><code>postgres-14</code> ist installed:</p>
<div class="codehilite"><pre><span></span><code>root@zulip:/home/maint# dpkg -l|grep postgres
ii  check-postgres                        2.25.0-5.pgdg20.04+1              all          script for monitoring PostgreSQL databases
ii  postgresql-10                         10.23-1.pgdg20.04+1               amd64        The World&#39;s Most Advanced Open Source Relational Database
ii  postgresql-14                         14.7-1.pgdg20.04+1                amd64        The World&#39;s Most Advanced Open Source Relational Database
ii  postgresql-client                     15+248.pgdg20.04+1                all          front-end programs for PostgreSQL (supported version)
ii  postgresql-client-10                  10.23-1.pgdg20.04+1               amd64        front-end programs for PostgreSQL 10
ii  postgresql-client-14                  14.7-1.pgdg20.04+1                amd64        front-end programs for PostgreSQL 14
ii  postgresql-client-15                  15.2-1.pgdg20.04+1                amd64        front-end programs for PostgreSQL 15
ii  postgresql-client-common              248.pgdg20.04+1                   all          manager for multiple PostgreSQL client versions
ii  postgresql-common                     248.pgdg20.04+1                   all          PostgreSQL database-cluster manager
</code></pre></div>
<p>I assume, <code>/etc/postgres/14</code> should have been created by deb postinstall scripts? Since e.g. <code>dpkg -S /etc/postgresql/10/main/pg_hba.conf</code> yields no results.</p>



<a name="1537386"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537386" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537386">(Mar 30 2023 at 15:41)</a>:</h4>
<p>Correct.  For instance:</p>
<div class="codehilite"><pre><span></span><code>root@alexmv-prod:~# ls /etc/postgresql
12  14
root@alexmv-prod:~# apt-get install postgresql-15
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required:
  libfwupdplugin1 libllvm9 libopts25 libstd-rust-1.57 libstd-rust-1.59 libstd-rust-1.61
  libstd-rust-1.65 libstd-rust-dev libxmlb1 postgresql-client-12
Use &#39;apt autoremove&#39; to remove them.
The following NEW packages will be installed:
  postgresql-15
0 upgraded, 1 newly installed, 0 to remove and 2 not upgraded.
Need to get 16.3 MB of archives.
After this operation, 53.2 MB of additional disk space will be used.
Get:1 http://apt.postgresql.org/pub/repos/apt focal-pgdg/main amd64 postgresql-15 amd64 15.2-1.pgdg20.04+1 [16.3 MB]
Fetched 16.3 MB in 2s (6708 kB/s)
Preconfiguring packages ...
Selecting previously unselected package postgresql-15.
(Reading database ... 136424 files and directories currently installed.)
Preparing to unpack .../postgresql-15_15.2-1.pgdg20.04+1_amd64.deb ...
Unpacking postgresql-15 (15.2-1.pgdg20.04+1) ...
Setting up postgresql-15 (15.2-1.pgdg20.04+1) ...
Creating new PostgreSQL cluster 15/main ...
/usr/lib/postgresql/15/bin/initdb -D /var/lib/postgresql/15/main --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user &quot;postgres&quot;.
This user must also own the server process.

The database cluster will be initialized with locale &quot;C.UTF-8&quot;.
The default database encoding has accordingly been set to &quot;UTF8&quot;.
The default text search configuration will be set to &quot;english&quot;.

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/15/main ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Etc/UTC
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok
update-alternatives: using /usr/share/postgresql/15/man/man1/postmaster.1.gz to provide /usr/share/man/man1/postmaster.1.gz (postmaster.1.gz) in auto mode
Processing triggers for postgresql-common (244.pgdg20.04+1) ...
Building PostgreSQL dictionaries from installed myspell/hunspell packages...
  en_us
Removing obsolete dictionary files:
root@alexmv-prod:~# ls /etc/postgresql
12  14  15
</code></pre></div>



<a name="1537387"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537387" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537387">(Mar 30 2023 at 15:41)</a>:</h4>
<p>So if your system didn't make that, you can try uninstalling and re-installing <code>postgresql-14</code>.</p>



<a name="1537388"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537388" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537388">(Mar 30 2023 at 15:42)</a>:</h4>
<p>But I see no reason from your output above that it wouldn't have been created.</p>



<a name="1537389"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537389" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537389">(Mar 30 2023 at 15:42)</a>:</h4>
<p>I already tried <code>apt-get install --reinstall postgresql-14</code> but that does not help.</p>



<a name="1537390"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537390" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537390">(Mar 30 2023 at 15:43)</a>:</h4>
<p>I assume this is a standard Ubuntu or Debian box, and you've checked your free disk space?</p>



<a name="1537391"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537391" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537391">(Mar 30 2023 at 15:44)</a>:</h4>
<p>What does <code>pg_lsclusters</code> show?</p>



<a name="1537393"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537393" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537393">(Mar 30 2023 at 15:46)</a>:</h4>
<p>Yes, Ubuntu 20.04, VM, upgraded from 18.04 longer time ago. Disk space is not a problem.</p>
<div class="codehilite"><pre><span></span><code>root@zulip:/home/maint# pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
10  main    5432 online postgres /var/lib/postgresql/10/main /var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log
</code></pre></div>



<a name="1537399"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537399" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537399">(Mar 30 2023 at 15:50)</a>:</h4>
<p>You can try <code>pg_createcluster 14 main</code> and then re-running <code>upgrade-postgresql</code></p>



<a name="1537401"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537401" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537401">(Mar 30 2023 at 15:51)</a>:</h4>
<p>But this is uncharted territory.  It might be more useful to spelunk the post-install scripts to see in what circumstances it makes an <code>/etc/postgresql/14</code></p>



<a name="1537403"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537403" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537403">(Mar 30 2023 at 15:52)</a>:</h4>
<p>For me the relevant question is if the missing folder should have been created by postgres package or zulip deployment. Regarding your statements i assume it's a task of the deb package. Thus i try to extract the maintainer scripts from the package.</p>



<a name="1537404"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537404" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537404">(Mar 30 2023 at 15:52)</a>:</h4>
<p>Yes, that directory is assumed to be created by the PostgreSQL package upon installation.</p>



<a name="1537405"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537405" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537405">(Mar 30 2023 at 15:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails/near/1537401">said</a>:</p>
<blockquote>
<p>But this is uncharted territory.  It might be more useful to spelunk the post-install scripts to see in what circumstances it makes an <code>/etc/postgresql/14</code></p>
</blockquote>
<p>Yes, i give it a try...</p>



<a name="1537408"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537408" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537408">(Mar 30 2023 at 15:53)</a>:</h4>
<p>Thank you so much for your help! I let you know the outcome.</p>



<a name="1537411"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537411" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537411">(Mar 30 2023 at 15:54)</a>:</h4>
<p>Keep us posted!  If we shouldn't be assuming there's a <code>main</code> cluster after installation, then that's something that we can adjust the upgrader to handle.</p>



<a name="1537413"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537413" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537413">(Mar 30 2023 at 16:01)</a>:</h4>
<p>Maybe it's a side effect of the OS dist-upgrade from 18.04 to 20.04. Although Debian/Ubuntu can usually be upgraded without major problems, I have experienced some strange effects with some packages over time.</p>



<a name="1537415"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537415" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537415">(Mar 30 2023 at 16:04)</a>:</h4>
<p>FYI: the <code>postinst</code> script just calls <code>/usr/share/postgresql-common/maintscripts-functions</code>.</p>



<a name="1537433"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537433" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537433">(Mar 30 2023 at 16:11)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> , i went brute force: <code>apt-get purge  postgresql-14</code> followed by <code>apt-get install  postgresql-14</code> (i forgot that <code>--reinstall</code> does not execute the maintainer scripts). Now <code>/etc/postgresql/14</code> exists. <br>
Next i'll give <code>/home/zulip/deployments/current/scripts/setup/upgrade-postgresql</code> a try. But I can do that later because there are currently many active users on the zulip server instance.</p>



<a name="1537437"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537437" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537437">(Mar 30 2023 at 16:13)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>configure_version<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nv">VERSION</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>

<span class="w">    </span><span class="c1"># Create a main cluster for given version ($1) if no cluster already exists</span>
<span class="w">    </span><span class="c1"># for that version and we are installing from scratch.</span>
<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$VERSION</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Error: configure_version: need version parameter"</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">"/etc/postgresql/</span><span class="nv">$VERSION</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="k">$(</span>ls<span class="w"> </span>/etc/postgresql/<span class="nv">$VERSION</span><span class="k">)</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="k">$(</span>ls<span class="w"> </span>/etc/postgresql/<span class="nv">$VERSION</span>/*/postgresql.conf<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="c1"># skip creating the main cluster when this is not the first install, or</span>
<span class="w">        </span><span class="c1"># when explicitly disabled ($create is on/off/"")</span>
<span class="w">        </span><span class="nv">create</span><span class="o">=</span><span class="k">$(</span>pg_conftool<span class="w"> </span>/etc/postgresql-common/createcluster.conf<span class="w"> </span>show<span class="w"> </span>-bs<span class="w"> </span>create_main_cluster<span class="w"> </span><span class="o">||</span><span class="w"> </span>:<span class="k">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$create</span><span class="s2">"</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">"off"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>set_system_locale
<span class="w">            </span>pg_createcluster<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>--no-status<span class="w"> </span><span class="nv">$VERSION</span><span class="w"> </span>main<span class="w"> </span><span class="o">||</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Error: could not create default cluster. Please create it manually with</span>

<span class="s2">  pg_createcluster </span><span class="nv">$VERSION</span><span class="s2"> main --start</span>

<span class="s2">or a similar command (see 'man pg_createcluster')."</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="c1"># ...</span>
<span class="o">}</span>
</code></pre></div>



<a name="1537750"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537750" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537750">(Mar 30 2023 at 19:53)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span>  well, now it becomes interesting:</p>
<div class="codehilite"><pre><span></span><code>root@zulip:/home/maint/tmp/DEBIAN# ls /etc/postgresql
10  14  9.3
root@zulip:/home/maint# /home/zulip/deployments/current/scripts/setup/upgrade-postgresql

[yadda yadda yadda]

Stopping old cluster...
Creating new PostgreSQL cluster 14/main ...
/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main --auth-local peer --auth-host scram-sha-256 --no-instructions --encoding UTF8 --lc-collate en_US.UTF-8 --lc-ctype en_US.UTF-8
The files belonging to this database system will be owned by user &quot;postgres&quot;.
This user must also own the server process.

The database cluster will be initialized with locale &quot;en_US.UTF-8&quot;.
The default text search configuration will be set to &quot;english&quot;.

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/14/main ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Europe/Berlin
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

Copying old configuration files...
Copying old start.conf...
Copying old pg_ctl.conf...
/usr/lib/postgresql/14/bin/pg_upgrade -b /usr/lib/postgresql/10/bin -B /usr/lib/postgresql/14/bin -p 5432 -P 5433 -d /etc/postgresql/10/main -D /etc/postgresql/14/main --link
Finding the real data directory for the source cluster      ok
Finding the real data directory for the target cluster      2023-03-30 19:51:02.632 GMT [180143] LOG:  could not open configuration directory &quot;/etc/postgresql/14/main/conf.d&quot;: No such file or directory
2023-03-30 19:51:02.632 GMT [180143] FATAL:  configuration file &quot;/etc/postgresql/14/main/postgresql.conf&quot; contains errors
Error: pg_upgrade run failed. Logfiles are in /var/log/postgresql/pg_upgradecluster-10-14-main.ODyw

could not get data directory using &quot;/usr/lib/postgresql/14/bin/postgres&quot; -D &quot;/etc/postgresql/14/main&quot; -C data_directory: No such file or directory
Failure, exiting
Error during cluster dumping, removing new cluster
Cluster is not running.
Error: could not stop old cluster, please do that manually

root@zulip:/home/maint# ls /etc/postgresql
10  9.3
</code></pre></div>
<p>Puzzled...</p>



<a name="1537752"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537752" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537752">(Mar 30 2023 at 19:55)</a>:</h4>
<p>That looks like the same error as before.  Does the <code>conf.d</code> directory still not exist?</p>



<a name="1537754"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537754" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537754">(Mar 30 2023 at 19:56)</a>:</h4>
<p>See the beginning of the log snippet above. <code>/etc/postgresql/14/</code> definitely existed before running the update script.</p>



<a name="1537769"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537769" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537769">(Mar 30 2023 at 20:03)</a>:</h4>
<p>Mhh, in the process i see this being executed:</p>
<div class="codehilite"><pre><span></span><code>[...]
+ apt-get install -y postgresql-14
Reading package lists... Done
Building dependency tree
Reading state information... Done
postgresql-14 is already the newest version (14.7-1.pgdg20.04+1).
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
+ pg_lsclusters -h
+ grep -qE &#39;^14\s+main\b&#39;
+ pg_dropcluster 14 main --stop.     &lt;--- !!!
++ mktemp -d
[...]
</code></pre></div>
<p>According to <code>man pg_dropcluster</code> it "<em>removes all files that belong to a given PostgreSQL cluster; that includes the data, wal, and tablespace directories, the log file, and all configuration files ... If the configuration directory (/etc/postgresql/version/cluster) is empty after this, it is removed as well</em>".</p>



<a name="1537776"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537776" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537776">(Mar 30 2023 at 20:07)</a>:</h4>
<p>Seems like this part of <code>upgrade-postgresql</code> is doing this:</p>
<div class="codehilite"><pre><span></span><code>if pg_lsclusters -h | grep -qE &quot;^$UPGRADE_TO\s+main\b&quot;; then
    pg_dropcluster &quot;$UPGRADE_TO&quot; main --stop
fi
</code></pre></div>



<a name="1537780"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537780" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537780">(Mar 30 2023 at 20:10)</a>:</h4>
<p>But i don't understand why since the condition renders to <code>false</code>:</p>
<div class="codehilite"><pre><span></span><code>root@zulip:/home/maint# pg_lsclusters -h
10 main 5432 online postgres /var/lib/postgresql/10/main /var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log
root@zulip:/home/maint# pg_lsclusters -h | grep -qE &#39;^14\s+main\b&#39;
root@zulip:/home/maint# echo $?
1
</code></pre></div>



<a name="1537804"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537804" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537804">(Mar 30 2023 at 20:20)</a>:</h4>
<p>Ok, funny, when the Debian package <code>postgresql-14</code> is installed it starts the <code>postgresql@14-main.service</code> immediately:</p>
<div class="codehilite"><pre><span></span><code>root@zulip:/home/maint# apt-get purge postgresql-14
[...]
root@zulip:/home/maint# apt-get install postgresql-14
[...]
root@zulip:/home/maint# systemctl --no-pager|grep postgres
  postgresql.service                                                                  loaded    active exited    PostgreSQL RDBMS
  postgresql@10-main.service                                                          loaded    active running   PostgreSQL Cluster 10-main
  postgresql@14-main.service                                                          loaded    active running   PostgreSQL Cluster 14-main
root@zulip:/home/maint# pg_lsclusters -h
10 main 5432 online postgres /var/lib/postgresql/10/main /var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log
14 main 5433 online postgres /var/lib/postgresql/14/main /var/log/postgresql/postgresql-14-main.log
</code></pre></div>
<p>I'll try the same procedure again but will stop <code>postgresql-14</code> in advance.</p>



<a name="1537872"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1537872" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1537872">(Mar 30 2023 at 21:34)</a>:</h4>
<p>The solution (at least on my system) is to create the config directory required by <code>pg_upgradecluster</code> manually: <code>mkdir -p /etc/postgresql/14/main/conf.d &amp;&amp; chown -R postgres:postgres /etc/postgresql/14</code>.</p>
<p>To sum things up:</p>
<ul>
<li><code>/home/zulip/deployments/current/scripts/setup/upgrade-postgresql</code> installs <code>postgresql-14</code></li>
<li>Package <code>postgresql-14</code> creates <code>/etc/postgresql/14</code> alongside all config files -and starts the service. This makes the version 14 cluster appear in the output of <code>pg_lsclusters -h</code></li>
<li>In <code>upgrade-postgresql</code> the detection if a cluster of the target version already exists kicks in and <code>pg_dopcluster</code> removes the version 14 cluster, including the config directory <code>/etc/postgresql/14</code></li>
<li><code>pg_upgradecluster</code> fails with the error which triggered this conversation</li>
</ul>
<p>Thus on my system the code in <code>upgrade-postgresql</code> needs to be like this to make <code>pg_upgradecluster</code> work:</p>
<div class="codehilite"><pre><span></span><code>if pg_lsclusters -h | grep -qE &quot;^$UPGRADE_TO\s+main\b&quot;; then
    pg_dropcluster &quot;$UPGRADE_TO&quot; main --stop
    mkdir -p /etc/postgresql/14/main/conf.d &amp;&amp; chown -R postgres:postgres /etc/postgresql/14
fi
</code></pre></div>



<a name="1549233"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549233" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549233">(Apr 17 2023 at 17:49)</a>:</h4>
<p><span class="user-mention" data-user-id="16301">@Harald Oest</span>: I just got around to testing this myself on a clean install of 5.5 on Ubuntu 20.04 with PostgreSQL 10 -- and I can't replicate.</p>
<p><span class="user-mention silent" data-user-id="16301">Harald Oest</span> <a href="#narrow/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails/near/1537872">said</a>:</p>
<blockquote>
<p>To sum things up:</p>
<ul>
<li><code>/home/zulip/deployments/current/scripts/setup/upgrade-postgresql</code> installs <code>postgresql-14</code></li>
<li>Package <code>postgresql-14</code> creates <code>/etc/postgresql/14</code> alongside all config files -and starts the service. This makes the version 14 cluster appear in the output of <code>pg_lsclusters -h</code></li>
<li>In <code>upgrade-postgresql</code> the detection if a cluster of the target version already exists kicks in and <code>pg_dopcluster</code> removes the version 14 cluster, including the config directory <code>/etc/postgresql/14</code></li>
</ul>
</blockquote>
<p>I agree with all those points -- putting an <code>exit 0</code> right before the call to <code>pg_upfradecluster</code> shows:</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">root@alexmv-testing-pg-upgrade:~# </span>dpkg<span class="w"> </span>--get-selections<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>postgresql-1
<span class="go">check-postgres                  install</span>
<span class="go">postgresql-10                   install</span>
<span class="go">postgresql-14                   install</span>
<span class="gp">root@alexmv-testing-pg-upgrade:~# </span>pg_lsclusters
<span class="go">Ver Cluster Port Status Owner    Data directory              Log file</span>
<span class="go">10  main    5432 online postgres /var/lib/postgresql/10/main /var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log</span>
<span class="gp">root@alexmv-testing-pg-upgrade:~# </span>ls<span class="w"> </span>/etc/postgresql
<span class="go">10</span>
</code></pre></div>
<p>However, the first step of <code>pg_upgradecluster</code> is to create a <em>new</em> cluster -- from <a href="#narrow/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails/near/1537750">your log</a>:</p>
<div class="codehilite"><pre><span></span><code>Stopping old cluster...
Creating new PostgreSQL cluster 14/main ...
</code></pre></div>
<p>And creating that new cluster should create <code>/etc/postgresql/14/main/conf.d</code>.  Here's the command it runs for me (UID/GUID may vary), and the output and end state:</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">root@alexmv-testing-pg-upgrade:~# </span>pg_createcluster<span class="w"> </span>-u<span class="w"> </span><span class="m">119</span><span class="w"> </span>-g<span class="w"> </span><span class="m">127</span><span class="w"> </span>--socketdir<span class="w"> </span>/var/run/postgresql<span class="w"> </span>--port<span class="w"> </span><span class="m">5433</span><span class="w"> </span>--no-status<span class="w"> </span><span class="m">14</span><span class="w"> </span>main<span class="w"> </span>--encoding<span class="w"> </span>UTF8<span class="w"> </span>--lc-collate<span class="w"> </span>C.UTF-8<span class="w"> </span>--lc-ctype<span class="w"> </span>C.UTF-8
<span class="go">Creating new PostgreSQL cluster 14/main ...</span>
<span class="go">/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main --auth-local peer --auth-host scram-sha-256 --no-instructions --encoding UTF8 --lc-collate C.UTF-8 --lc-ctype C.UTF-8</span>
<span class="go">The files belonging to this database system will be owned by user "postgres".</span>
<span class="go">This user must also own the server process.</span>

<span class="go">The database cluster will be initialized with locale "C.UTF-8".</span>
<span class="go">The default text search configuration will be set to "english".</span>

<span class="go">Data page checksums are disabled.</span>

<span class="go">fixing permissions on existing directory /var/lib/postgresql/14/main ... ok</span>
<span class="go">creating subdirectories ... ok</span>
<span class="go">selecting dynamic shared memory implementation ... posix</span>
<span class="go">selecting default max_connections ... 100</span>
<span class="go">selecting default shared_buffers ... 128MB</span>
<span class="go">selecting default time zone ... Etc/UTC</span>
<span class="go">creating configuration files ... ok</span>
<span class="go">running bootstrap script ... ok</span>
<span class="go">performing post-bootstrap initialization ... ok</span>
<span class="go">syncing data to disk ... ok</span>
<span class="gp">root@alexmv-testing-pg-upgrade:~# </span>ls<span class="w"> </span>/etc/postgresql
<span class="go">10  14</span>
<span class="gp">root@alexmv-testing-pg-upgrade:~# </span>ls<span class="w"> </span>/etc/postgresql/14
<span class="go">main</span>
<span class="gp">root@alexmv-testing-pg-upgrade:~# </span>ls<span class="w"> </span>/etc/postgresql/14/main/
<span class="go">conf.d  environment  pg_ctl.conf  pg_hba.conf  pg_ident.conf  postgresql.conf  start.conf</span>
</code></pre></div>
<p>In case it matters, this is with:</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">root@alexmv-testing-pg-upgrade:~# </span>apt-cache<span class="w"> </span>policy<span class="w"> </span>postgresql-common
<span class="go">postgresql-common:</span>
<span class="go">  Installed: 248.pgdg20.04+1</span>
<span class="go">  Candidate: 248.pgdg20.04+1</span>
<span class="go">  Version table:</span>
<span class="go"> *** 248.pgdg20.04+1 500</span>
<span class="go">        500 http://apt.postgresql.org/pub/repos/apt focal-pgdg/main amd64 Packages</span>
<span class="go">        100 /var/lib/dpkg/status</span>
<span class="go">     214ubuntu0.1 500</span>
<span class="go">        500 http://mirrors.digitalocean.com/ubuntu focal-updates/main amd64 Packages</span>
<span class="go">        500 http://security.ubuntu.com/ubuntu focal-security/main amd64 Packages</span>
<span class="go">     214 500</span>
<span class="go">        500 http://mirrors.digitalocean.com/ubuntu focal/main amd64 Packages</span>
</code></pre></div>



<a name="1549239"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549239" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549239">(Apr 17 2023 at 17:52)</a>:</h4>
<p><code>pg_createcluster</code> has this code in it:</p>
<div class="codehilite" data-code-language="Perl"><pre><span></span><code><span class="c1"># read defaults from /etc/postgresql-common/createcluster.conf</span>
<span class="nv">%defaultconf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">PgCommon::</span><span class="n">read_conf_file</span><span class="w"> </span><span class="p">(</span><span class="nv">$createclusterconf</span><span class="p">);</span>

<span class="c1"># ...</span>

<span class="c1"># handle other createcluster.conf parameters, including --pgoption parameters</span>
<span class="k">foreach</span><span class="w"> </span><span class="k">my</span><span class="w"> </span><span class="nv">$guc</span><span class="w"> </span><span class="p">(</span><span class="nb">sort</span><span class="w"> </span><span class="nb">keys</span><span class="w"> </span><span class="nv">%defaultconf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">next</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">$guc</span><span class="w"> </span><span class="o">=~</span><span class="sr"> /^(create_main_cluster|start_conf|data_directory|waldir|xlogdir|initdb_options|ssl)$/</span><span class="p">;</span>
<span class="w">    </span><span class="k">next</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">$guc</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">'logging_collector'</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">$version</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">8.3</span><span class="p">;</span>
<span class="w">    </span><span class="k">next</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">$guc</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">'cluster_name'</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">$version</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">9.5</span><span class="p">;</span>
<span class="w">    </span><span class="k">my</span><span class="w"> </span><span class="nv">$val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replace_v_c</span><span class="w"> </span><span class="p">(</span><span class="nv">$defaultconf</span><span class="p">{</span><span class="nv">$guc</span><span class="p">},</span><span class="w"> </span><span class="nv">$version</span><span class="p">,</span><span class="w"> </span><span class="nv">$cluster</span><span class="p">);</span>
<span class="w">    </span><span class="nv">$guc</span><span class="w"> </span><span class="o">=~</span><span class="w"> </span><span class="sr">s/^add_include/include/</span><span class="p">;</span><span class="w"> </span><span class="c1"># remove harness from include directives in createcluster.conf</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$guc</span><span class="w"> </span><span class="ow">eq</span><span class="w"> </span><span class="s">'include_dir'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">next</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$version</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">9.3</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$val</span><span class="w"> </span><span class="o">=~</span><span class="sr"> /^[\w.]+$/</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="s">"$confdir/$val"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># create directory relative to new config directory</span>
<span class="w">            </span><span class="nb">mkdir</span><span class="w"> </span><span class="s">"$confdir/$val"</span><span class="p">,</span><span class="w"> </span><span class="mo">0755</span><span class="p">;</span>
<span class="w">            </span><span class="n">lchown</span><span class="w"> </span><span class="nv">$owneruid</span><span class="p">,</span><span class="w"> </span><span class="nv">$ownergid</span><span class="p">,</span><span class="w"> </span><span class="s">"$confdir/$val"</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nn">PgCommon::</span><span class="n">set_conf_value</span><span class="w"> </span><span class="nv">$version</span><span class="p">,</span><span class="w"> </span><span class="nv">$cluster</span><span class="p">,</span><span class="w"> </span><span class="s">'postgresql.conf'</span><span class="p">,</span><span class="w"> </span><span class="nv">$guc</span><span class="p">,</span><span class="w"> </span><span class="nv">$val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>...which reads <code>/etc/postgresql-common/createcluster.conf</code> and based on that sets up <code>postgresql.conf</code> and <em>also</em> makes the empty <code>conf.d</code> directory.</p>
<p>Can you show the contents of <code>/etc/postgresql-common/createcluster.conf</code> ?</p>



<a name="1549323"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549323" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549323">(Apr 17 2023 at 18:39)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> , sure:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>root@zulip:/home/maint#<span class="w"> </span>cat<span class="w"> </span>/etc/postgresql-common/createcluster.conf
<span class="c1"># Default values for pg_createcluster(8)</span>

<span class="c1"># Create a "main" cluster when a new postgresql-x.y server package is installed</span>
<span class="c1">#create_main_cluster = true</span>

<span class="c1"># Default start.conf value, must be one of "auto", "manual", and "disabled".</span>
<span class="c1"># See pg_createcluster(8) for more documentation.</span>
<span class="c1">#start_conf = 'auto'</span>

<span class="c1"># In the following options, occurrences of '%v' are replaced by the major</span>
<span class="c1"># version number, and '%c' by the cluster name. Use '%%' for a literal '%'.</span>

<span class="c1"># Default data directory.</span>
<span class="c1">#data_directory = '/var/lib/postgresql/%v/%c'</span>

<span class="c1"># Default directory for transaction logs</span>
<span class="c1"># Unset by default, i.e. pg_xlog remains in the data directory.</span>
<span class="c1">#xlogdir = '/var/lib/postgresql/xlog/%v/%c/pg_xlog'</span>

<span class="c1"># Options to pass to initdb.</span>
<span class="c1">#initdb_options = ''</span>

<span class="c1"># All other options are copied into the new cluster's postgresql.conf</span>

<span class="nv">log_line_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'%%t '</span>
</code></pre></div>



<a name="1549325"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549325" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549325">(Apr 17 2023 at 18:42)</a>:</h4>
<p>OK, that looks like the problem.  So that means that <code>pg_createcluster</code> doesn't make the <code>conf.d</code> and <code>pg_upgradecluster</code> copies over the old cluster's config which <em>does</em> have a <code>include 'conf.d'</code> line in it, which means the new cluster fails to start.</p>



<a name="1549326"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549326" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549326">(Apr 17 2023 at 18:43)</a>:</h4>
<p>I don't know how you got that non-default <code>createcluster.conf</code>, but that's the proximal cause.</p>



<a name="1549327"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549327" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549327">(Apr 17 2023 at 18:44)</a>:</h4>
<p>We can attempt to paper over this, but it's fundamentally a <code>pg_upgradecluster</code> problem -- running <code>pg_upgradecluster</code> with that config, without any Zulip involvement, would also fail.</p>



<a name="1549328"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549328" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549328">(Apr 17 2023 at 18:44)</a>:</h4>
<p>What does <code>apt-cache policy postgresql-common</code> show?</p>



<a name="1549330"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549330" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549330">(Apr 17 2023 at 18:45)</a>:</h4>
<p>TBH i don't understand yet. What's the (correct) content of <code>createcluster.conf</code> on your system?</p>



<a name="1549332"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549332" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549332">(Apr 17 2023 at 18:46)</a>:</h4>
<p>Oh!  Sorry for not including that:</p>
<div class="codehilite"><pre><span></span><code>root@alexmv-testing-pg-upgrade:~# cat /etc/postgresql-common/createcluster.conf
# Default values for pg_createcluster(8)
# Occurrences of &#39;%v&#39; are replaced by the major version number,
# and &#39;%c&#39; by the cluster name. Use &#39;%%&#39; for a literal &#39;%&#39;.

# Create a &quot;main&quot; cluster when a new postgresql-x.y server package is installed
#create_main_cluster = true

# Default start.conf value, must be one of &quot;auto&quot;, &quot;manual&quot;, and &quot;disabled&quot;.
# See pg_createcluster(8) for more documentation.
#start_conf = &#39;auto&#39;

# Default data directory.
#data_directory = &#39;/var/lib/postgresql/%v/%c&#39;

# Default directory for transaction logs
# Unset by default, i.e. transaction logs remain in the data directory.
#waldir = &#39;/var/lib/postgresql/wal/%v/%c/pg_wal&#39;

# Options to pass to initdb.
#initdb_options = &#39;&#39;

# The following options are copied into the new cluster&#39;s postgresql.conf:

# Enable SSL by default (using the &quot;snakeoil&quot; certificates installed by the
# ssl-cert package, unless configured otherwise here)
ssl = on

# Show cluster name in process title
cluster_name = &#39;%v/%c&#39;

# Put stats_temp_directory on tmpfs (PG &lt;= 14)
stats_temp_directory = &#39;/var/run/postgresql/%v-%c.pg_stat_tmp&#39;

# Add prefix to log lines
log_line_prefix = &#39;%%m [%%p] %%q%%u@%%d &#39;

# Add &quot;include_dir&quot; in postgresql.conf
add_include_dir = &#39;conf.d&#39;

# Directory for additional createcluster config
include_dir &#39;/etc/postgresql-common/createcluster.d&#39;
</code></pre></div>



<a name="1549333"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549333" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549333">(Apr 17 2023 at 18:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails/near/1549328">said</a>:</p>
<blockquote>
<p>What does <code>apt-cache policy postgresql-common</code> show?</p>
</blockquote>
<p>Here we go:</p>
<div class="codehilite"><pre><span></span><code>root@zulip:/home/maint# apt-cache policy postgresql-common
postgresql-common:
  Installed: 248.pgdg20.04+1
  Candidate: 248.pgdg20.04+1
  Version table:
 *** 248.pgdg20.04+1 500
        500 http://apt.postgresql.org/pub/repos/apt focal-pgdg/main amd64 Packages
        100 /var/lib/dpkg/status
     214ubuntu0.1 500
        500 http://de.archive.ubuntu.com/ubuntu focal-updates/main amd64 Packages
        500 http://de.archive.ubuntu.com/ubuntu focal-updates/main i386 Packages
        500 http://security.ubuntu.com/ubuntu focal-security/main amd64 Packages
        500 http://security.ubuntu.com/ubuntu focal-security/main i386 Packages
     214 500
        500 http://de.archive.ubuntu.com/ubuntu focal/main amd64 Packages
        500 http://de.archive.ubuntu.com/ubuntu focal/main i386 Packages
</code></pre></div>



<a name="1549335"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549335" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549335">(Apr 17 2023 at 18:47)</a>:</h4>
<p>The important line is:</p>
<div class="codehilite"><pre><span></span><code>add_include_dir = &#39;conf.d&#39;
</code></pre></div>



<a name="1549339"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549339" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549339">(Apr 17 2023 at 18:48)</a>:</h4>
<p>Hm, OK.  So presumably your <code>createcluster.conf</code> is left over from a very old version of PostgreSQL?  I'm assuming you don't remember making any manual changes to it?</p>



<a name="1549347"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549347" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harald Oest <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549347">(Apr 17 2023 at 18:50)</a>:</h4>
<p>For that i'm sure, no manual changes. But as i mentioned at the beginning of this thread, it's an upgraded system. Strange things can happen with Ubuntu upgrades.</p>



<a name="1549408"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1549408" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1549408">(Apr 17 2023 at 19:47)</a>:</h4>
<p>Yeah.</p>
<p>I wonder if we should just detect a lack of <code>add_include_dir</code> in <code>/etc/postgresql-common/createcluster.conf</code> and error out, because the upgrade won't work?  This seems like a very niche corner case, and I'm worried about side effects from doing things like making <code>/etc/postgresql/14/main</code> before <code>pg_createcluster 14 main</code> is called.</p>



<a name="1576152"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1576152" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1576152">(May 24 2023 at 22:17)</a>:</h4>
<p>I think adding such a check and erroring out would be a reasonable thing to do here, though I don't know whether it's worth the effort when we've only seen this once.</p>



<a name="1576154"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1576154" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1576154">(May 24 2023 at 22:18)</a>:</h4>
<p>I think it's probably reasonable to close <a href="https://github.com/zulip/zulip/pull/24908">#24908</a> as resolved and move on, but I'd merge a PR to add such a check if <span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> thinks it's worth the time to write it.</p>



<a name="1577895"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%20postgresql%2010%20to%2014%20fails/near/1577895" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails.html#1577895">(May 26 2023 at 20:47)</a>:</h4>
<p>Yeah, I don't think this is worth generalizing.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>