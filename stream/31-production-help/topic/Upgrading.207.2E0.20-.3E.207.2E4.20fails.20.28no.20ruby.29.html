<html>
<head><meta charset="utf-8"><title>Upgrading 7.0 -&gt; 7.4 fails (no ruby) · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html">Upgrading 7.0 -&gt; 7.4 fails (no ruby)</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1649808"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1649808" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mattia Monga <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1649808">(Sep 29 2023 at 14:19)</a>:</h4>
<p>I tried to upgrade my Zulip server to the last version, but it fails because ruby is not installed (I'm on a Debian 12 Bookworm). Is this a missing dependency? I tried to manually install ruby, but it is not enough.</p>



<a name="1649822"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1649822" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1649822">(Sep 29 2023 at 14:30)</a>:</h4>
<p><span class="user-mention" data-user-id="27921">@Mattia Monga</span>: Can you paste the output from running the upgrade, in a <a href="https://zulip.com/help/code-blocks">code block</a>?</p>



<a name="1649839"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1649839" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mattia Monga <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1649839">(Sep 29 2023 at 14:46)</a>:</h4>
<div class="codehilite"><pre><span></span><code>2023-09-29 14:44:43,447 upgrade-zulip-stage-2: Installing hooks
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2023-09-29-16-40-04/./scripts/zulip-puppet-apply&quot;, line 32, in &lt;module&gt;
    setup_puppet_modules()
  File &quot;/home/zulip/deployments/2023-09-29-16-40-04/scripts/lib/puppet_cache.py&quot;, line 37, in setup_puppet_modules
    sha1sum = generate_sha1sum_puppet_modules()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/zulip/deployments/2023-09-29-16-40-04/scripts/lib/puppet_cache.py&quot;, line 25, in generate_sha1sum_puppet_modules
    data[&quot;puppet-version&quot;] = subprocess.check_output(
                             ^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python3.11/subprocess.py&quot;, line 466, in check_output
    return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python3.11/subprocess.py&quot;, line 548, in run
    with Popen(*popenargs, **kwargs) as process:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python3.11/subprocess.py&quot;, line 1024, in __init__
    self._execute_child(args, executable, preexec_fn, close_fds,
  File &quot;/usr/lib/python3.11/subprocess.py&quot;, line 1901, in _execute_child
    raise child_exception_type(errno_num, err_msg, err_filename)
FileNotFoundError: [Errno 2] No such file or directory: &#39;ruby&#39;
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2023-09-29-16-40-04/scripts/lib/upgrade-zulip-stage-2&quot;, line 390, in &lt;module&gt;
    subprocess.check_call(
  File &quot;/usr/lib/python3.11/subprocess.py&quot;, line 413, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./scripts/zulip-puppet-apply&#39;, &#39;--tags&#39;, &#39;hooks&#39;, &#39;--force&#39;]&#39; returned non-zero exit status 1.

Zulip upgrade failed (exit code 1)!
</code></pre></div>



<a name="1649842"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1649842" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mattia Monga <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1649842">(Sep 29 2023 at 14:46)</a>:</h4>
<p>Thank you <span class="user-mention" data-user-id="12178">@Alex Vandiver</span></p>



<a name="1649854"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1649854" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1649854">(Sep 29 2023 at 15:00)</a>:</h4>
<p>That's very odd.  Ruby is installed as a prerequisite to puppet, which has been a requirement for a very long time.</p>



<a name="1649855"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1649855" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1649855">(Sep 29 2023 at 15:00)</a>:</h4>
<p>Can you show:</p>
<div class="codehilite"><pre><span></span><code>which ruby

ls -l /usr/bin/ruby

dpkg --get-selections | grep ruby
</code></pre></div>



<a name="1649857"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1649857" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mattia Monga <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1649857">(Sep 29 2023 at 15:05)</a>:</h4>
<p>Yes, ruby is not installed. All the commands you suggested have an "empty" result. But if I install ruby I get another problem with puppet.</p>



<a name="1649862"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1649862" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1649862">(Sep 29 2023 at 15:08)</a>:</h4>
<p>I'm a little curious to investigate more how ruby came to not be installed, since whatever process may have broken other things.</p>



<a name="1649864"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1649864" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1649864">(Sep 29 2023 at 15:09)</a>:</h4>
<p><span class="user-mention" data-user-id="27921">@Mattia Monga</span>: Can you check <code>/var/log/apt/term.log.*</code> for anything involving ruby (un)installation?</p>



<a name="1650791"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1650791" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mattia Monga <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1650791">(Sep 30 2023 at 05:12)</a>:</h4>
<p>I've found traces of my installation (and then removal) of ruby, nothing else. But if it is required, shouldn't it be installed by the <code>upgrade-zulip</code> process?</p>



<a name="1650797"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1650797" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1650797">(Sep 30 2023 at 05:23)</a>:</h4>
<p>At the moment we only install it as part of <code>install</code>, not <code>upgrade-zulip</code>. In general, the upgrader assumes you started with a correctly installed system that is <a href="https://zulip.readthedocs.io/en/stable/production/requirements.html#general">only running Zulip</a>, and although there are various problems it will happen to correct, it can’t possibly account for all the ways someone else on the system might have broken it.</p>
<p>Run <code>apt-get install puppet</code> and try the upgrade again.</p>



<a name="1650847"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrading%207.0%20-%3E%207.4%20fails%20%28no%20ruby%29/near/1650847" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mattia Monga <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrading.207.2E0.20-.3E.207.2E4.20fails.20.28no.20ruby.29.html#1650847">(Sep 30 2023 at 06:49)</a>:</h4>
<p>That worked, thank you! I have no idea about why puppet has been uninstalled, the system provides just the zulip service.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>