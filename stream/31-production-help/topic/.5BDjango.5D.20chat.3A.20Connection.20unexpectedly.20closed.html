<html>
<head><meta charset="utf-8"><title>[Django] chat: Connection unexpectedly closed · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html">[Django] chat: Connection unexpectedly closed</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1365048"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365048" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365048">(Apr 12 2022 at 19:00)</a>:</h4>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">Logger</span> <span class="n">zulip</span><span class="o">.</span><span class="n">send_email</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">module</span> <span class="n">zerver</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">send_email</span> <span class="n">line</span> <span class="mi">288</span><span class="p">:</span>
<span class="n">Error</span> <span class="n">generated</span> <span class="n">by</span> <span class="n">Anonymous</span> <span class="n">user</span> <span class="p">(</span><span class="ow">not</span> <span class="n">logged</span> <span class="ow">in</span><span class="p">)</span> <span class="n">on</span> <span class="n">chat</span> <span class="n">deployment</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">391</span><span class="p">,</span> <span class="ow">in</span> <span class="n">getreply</span>
<span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">_MAXLINE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/socket.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">669</span><span class="p">,</span> <span class="ow">in</span> <span class="n">readinto</span>
<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span> <span class="n">timed</span> <span class="n">out</span>

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">File</span> <span class="s2">"/home/zulip/deployments/2022-04-11-21-43-40/zerver/lib/send_email.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">274</span><span class="p">,</span> <span class="ow">in</span> <span class="n">send_email</span>
<span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">mail</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/726c7d1d35d9cd61bb4b70e98167a1db7b0c524d/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">102</span><span class="p">,</span> <span class="ow">in</span> <span class="n">send_messages</span>
<span class="n">new_conn_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/726c7d1d35d9cd61bb4b70e98167a1db7b0c524d/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">62</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">open</span>
<span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="n">connection_params</span><span class="p">)</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">255</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
<span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">341</span><span class="p">,</span> <span class="ow">in</span> <span class="n">connect</span>
<span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getreply</span><span class="p">()</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">394</span><span class="p">,</span> <span class="ow">in</span> <span class="n">getreply</span>
<span class="k">raise</span> <span class="n">SMTPServerDisconnected</span><span class="p">(</span><span class="s2">"Connection unexpectedly closed: "</span>
<span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPServerDisconnected</span><span class="p">:</span> <span class="n">Connection</span> <span class="n">unexpectedly</span> <span class="n">closed</span><span class="p">:</span> <span class="n">timed</span> <span class="n">out</span>


<span class="n">Deployed</span> <span class="n">code</span><span class="p">:</span>
<span class="o">-</span> <span class="n">git</span><span class="p">:</span> <span class="mf">6.0</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="mi">96</span><span class="o">-</span><span class="n">g07c12e8a6c</span>
<span class="o">-</span> <span class="n">ZULIP_VERSION</span><span class="p">:</span> <span class="mf">6.0</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="mi">96</span><span class="o">-</span><span class="n">g07c12e8a6c</span>


<span class="n">Request</span> <span class="n">info</span><span class="p">:</span> <span class="n">none</span>
</code></pre></div>



<a name="1365049"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365049" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365049">(Apr 12 2022 at 19:00)</a>:</h4>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">Logger</span> <span class="n">zulip</span><span class="o">.</span><span class="n">send_email</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">module</span> <span class="n">zerver</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">send_email</span> <span class="n">line</span> <span class="mi">288</span><span class="p">:</span>
<span class="n">Error</span> <span class="n">generated</span> <span class="n">by</span> <span class="n">Anonymous</span> <span class="n">user</span> <span class="p">(</span><span class="ow">not</span> <span class="n">logged</span> <span class="ow">in</span><span class="p">)</span> <span class="n">on</span> <span class="n">chat</span> <span class="n">deployment</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">391</span><span class="p">,</span> <span class="ow">in</span> <span class="n">getreply</span>
<span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">_MAXLINE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/socket.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">669</span><span class="p">,</span> <span class="ow">in</span> <span class="n">readinto</span>
<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/ssl.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1241</span><span class="p">,</span> <span class="ow">in</span> <span class="n">recv_into</span>
<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/ssl.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1099</span><span class="p">,</span> <span class="ow">in</span> <span class="n">read</span>
<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sslobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span> <span class="n">The</span> <span class="n">read</span> <span class="n">operation</span> <span class="n">timed</span> <span class="n">out</span>

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">File</span> <span class="s2">"/home/zulip/deployments/2022-04-11-21-43-40/zerver/lib/send_email.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">274</span><span class="p">,</span> <span class="ow">in</span> <span class="n">send_email</span>
<span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">mail</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/726c7d1d35d9cd61bb4b70e98167a1db7b0c524d/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">102</span><span class="p">,</span> <span class="ow">in</span> <span class="n">send_messages</span>
<span class="n">new_conn_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/726c7d1d35d9cd61bb4b70e98167a1db7b0c524d/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">69</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">open</span>
<span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">707</span><span class="p">,</span> <span class="ow">in</span> <span class="n">login</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ehlo_or_helo_if_needed</span><span class="p">()</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">604</span><span class="p">,</span> <span class="ow">in</span> <span class="n">ehlo_or_helo_if_needed</span>
<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">200</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">299</span><span class="p">):</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">445</span><span class="p">,</span> <span class="ow">in</span> <span class="n">ehlo</span>
<span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getreply</span><span class="p">()</span>
<span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">394</span><span class="p">,</span> <span class="ow">in</span> <span class="n">getreply</span>
<span class="k">raise</span> <span class="n">SMTPServerDisconnected</span><span class="p">(</span><span class="s2">"Connection unexpectedly closed: "</span>
<span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPServerDisconnected</span><span class="p">:</span> <span class="n">Connection</span> <span class="n">unexpectedly</span> <span class="n">closed</span><span class="p">:</span> <span class="n">The</span> <span class="n">read</span> <span class="n">operation</span> <span class="n">timed</span> <span class="n">out</span>


<span class="n">Deployed</span> <span class="n">code</span><span class="p">:</span>
<span class="o">-</span> <span class="n">git</span><span class="p">:</span> <span class="mf">6.0</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="mi">96</span><span class="o">-</span><span class="n">g07c12e8a6c</span>
<span class="o">-</span> <span class="n">ZULIP_VERSION</span><span class="p">:</span> <span class="mf">6.0</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="mi">96</span><span class="o">-</span><span class="n">g07c12e8a6c</span>


<span class="n">Request</span> <span class="n">info</span><span class="p">:</span> <span class="n">none</span>
</code></pre></div>



<a name="1365082"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365082" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365082">(Apr 12 2022 at 19:31)</a>:</h4>
<p>I am not aware of any limitations inside Postal for mail deliveries, since the system was built for such.</p>



<a name="1365084"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365084" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365084">(Apr 12 2022 at 19:31)</a>:</h4>
<p>I would rather see a issue of latency maybe, or the time response set in Zulip to process the SMTP gateway replies.</p>



<a name="1365092"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365092" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365092">(Apr 12 2022 at 19:38)</a>:</h4>
<p>I can't entirely tell from those tracebacks, but it <em>looks</em> from the "Request info: none" that those are from a backend worker.  Can you double-check that the error is in <code>/var/log/zulip/events_email_senders.log</code>?</p>
<p>If so, this is the long-lived worker connection.  ISTR we have a task to let folks turn off this pooling, or make it cap out at some configurable number of minutes, because it's not configurable at the moment.</p>



<a name="1365101"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365101" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365101">(Apr 12 2022 at 19:49)</a>:</h4>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="ne">ConnectionResetError</span><span class="p">:</span> <span class="p">[</span><span class="n">Errno</span> <span class="mi">104</span><span class="p">]</span> <span class="n">Connection</span> <span class="n">reset</span> <span class="n">by</span> <span class="n">peer</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">30</span> <span class="mi">08</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mf">12.014</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">process_queue</span><span class="p">]</span> <span class="n">Worker</span> <span class="mi">0</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">queue</span> <span class="n">email_senders</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/current/manage.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">157</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">execute_from_command_line</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/current/manage.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">122</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute_from_command_line</span>
    <span class="n">utility</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">413</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fetch_command</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span><span class="o">.</span><span class="n">run_from_argv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">354</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run_from_argv</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">cmd_options</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">398</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2021-07-03-21-01-47/zerver/management/commands/process_queue.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">82</span><span class="p">,</span> <span class="ow">in</span> <span class="n">handle</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">get_worker</span><span class="p">(</span><span class="n">queue_name</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2021-07-03-21-01-47/zerver/worker/queue_processors.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">152</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get_worker</span>
    <span class="k">return</span> <span class="n">worker_classes</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]()</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2021-07-03-21-01-47/zerver/worker/queue_processors.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">628</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">:</span> <span class="n">EmailBackend</span> <span class="o">=</span> <span class="n">initialize_connection</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/backoff/_sync.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">94</span><span class="p">,</span> <span class="ow">in</span> <span class="n">retry</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">target</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2021-07-03-21-01-47/zerver/lib/send_email.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">279</span><span class="p">,</span> <span class="ow">in</span> <span class="n">initialize_connection</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">open</span><span class="p">():</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">67</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">open</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">starttls</span><span class="p">(</span><span class="n">keyfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_keyfile</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_certfile</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">783</span><span class="p">,</span> <span class="ow">in</span> <span class="n">starttls</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/ssl.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">500</span><span class="p">,</span> <span class="ow">in</span> <span class="n">wrap_socket</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslsocket_class</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/ssl.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1040</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_create</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/ssl.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1309</span><span class="p">,</span> <span class="ow">in</span> <span class="n">do_handshake</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sslobj</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
</code></pre></div>



<a name="1365103"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365103" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365103">(Apr 12 2022 at 19:51)</a>:</h4>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="mi">2022</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">21</span> <span class="mi">08</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mf">00.907</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">zulip</span><span class="o">.</span><span class="n">send_email</span><span class="p">]</span> <span class="n">Sending</span> <span class="n">missed_message</span> <span class="n">email</span> <span class="n">to</span> <span class="p">[</span><span class="s1">'stephan &lt;stephan@uhl-services.ch&gt;'</span><span class="p">]</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">27</span> <span class="mi">06</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">33.584</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">process_queue</span><span class="p">]</span> <span class="n">Worker</span> <span class="mi">0</span> <span class="n">disconnecting</span> <span class="kn">from</span> <span class="nn">queue</span> <span class="n">email_senders</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">27</span> <span class="mi">06</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">35.277</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">process_queue</span><span class="p">]</span> <span class="n">Worker</span> <span class="mi">0</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">queue</span> <span class="n">email_senders</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">27</span> <span class="mi">06</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">43.611</span> <span class="n">ERR</span>  <span class="p">[</span><span class="n">process_queue</span><span class="p">]</span> <span class="n">Unhandled</span> <span class="n">exception</span> <span class="kn">from</span> <span class="nn">queue</span><span class="p">:</span> <span class="n">email_senders</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">391</span><span class="p">,</span> <span class="ow">in</span> <span class="n">getreply</span>
    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">_MAXLINE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/socket.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">669</span><span class="p">,</span> <span class="ow">in</span> <span class="n">readinto</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">recv_into</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span> <span class="n">timed</span> <span class="n">out</span>

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2022-02-10-10-21-52/zerver/management/commands/process_queue.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">24</span><span class="p">,</span> <span class="ow">in</span> <span class="n">log_and_exit_if_exception</span>
    <span class="k">yield</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2022-02-10-10-21-52/zerver/management/commands/process_queue.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">101</span><span class="p">,</span> <span class="ow">in</span> <span class="n">handle</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">get_worker</span><span class="p">(</span><span class="n">queue_name</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2022-02-10-10-21-52/zerver/worker/queue_processors.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">165</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get_worker</span>
    <span class="k">return</span> <span class="n">worker_classes</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]()</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2022-02-10-10-21-52/zerver/worker/queue_processors.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">732</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">:</span> <span class="n">EmailBackend</span> <span class="o">=</span> <span class="n">initialize_connection</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/backoff/_sync.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">94</span><span class="p">,</span> <span class="ow">in</span> <span class="n">retry</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">target</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2022-02-10-10-21-52/zerver/lib/send_email.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">305</span><span class="p">,</span> <span class="ow">in</span> <span class="n">initialize_connection</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">open</span><span class="p">():</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">62</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">open</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="n">connection_params</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">255</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
    <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">341</span><span class="p">,</span> <span class="ow">in</span> <span class="n">connect</span>
    <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getreply</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">394</span><span class="p">,</span> <span class="ow">in</span> <span class="n">getreply</span>
    <span class="k">raise</span> <span class="n">SMTPServerDisconnected</span><span class="p">(</span><span class="s2">"Connection unexpectedly closed: "</span>
<span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPServerDisconnected</span><span class="p">:</span> <span class="n">Connection</span> <span class="n">unexpectedly</span> <span class="n">closed</span><span class="p">:</span> <span class="n">timed</span> <span class="n">out</span>
<span class="n">Stack</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/current/manage.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">157</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">execute_from_command_line</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/current/manage.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">122</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute_from_command_line</span>
    <span class="n">utility</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">413</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fetch_command</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span><span class="o">.</span><span class="n">run_from_argv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">354</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run_from_argv</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">cmd_options</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">398</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2022-02-10-10-21-52/zerver/management/commands/process_queue.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">111</span><span class="p">,</span> <span class="ow">in</span> <span class="n">handle</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/contextlib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">131</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__exit__</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">throw</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2022-02-10-10-21-52/zerver/management/commands/process_queue.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">26</span><span class="p">,</span> <span class="ow">in</span> <span class="n">log_and_exit_if_exception</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">"Unhandled exception from queue: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">27</span> <span class="mi">06</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">50.081</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">process_queue</span><span class="p">]</span> <span class="n">Worker</span> <span class="mi">0</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">queue</span> <span class="n">email_senders</span>
</code></pre></div>



<a name="1365104"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365104" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365104">(Apr 12 2022 at 19:52)</a>:</h4>
<p>What is weird is that in last error, you can see there were like 2 hrs since last action, and then suddenly the timeouts</p>



<a name="1365105"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365105" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365105">(Apr 12 2022 at 19:53)</a>:</h4>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">21</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mf">38.932</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">process_queue</span><span class="p">]</span> <span class="n">Worker</span> <span class="mi">0</span> <span class="n">disconnecting</span> <span class="kn">from</span> <span class="nn">queue</span> <span class="n">email_senders</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">11</span> <span class="mi">21</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mf">12.688</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">process_queue</span><span class="p">]</span> <span class="n">Worker</span> <span class="mi">0</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">queue</span> <span class="n">email_senders</span>
</code></pre></div>
<p>these are last lines of code, beside the ones where users emails are visible for sent emails.</p>



<a name="1365108"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365108" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365108">(Apr 12 2022 at 19:56)</a>:</h4>
<p>Those last two lines are from a server restart, and normal for that.</p>



<a name="1365110"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365110" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365110">(Apr 12 2022 at 19:58)</a>:</h4>
<p>What's a little odd in this:</p>
<div class="codehilite"><pre><span></span><code>2022-03-27 06:01:35.277 INFO [process_queue] Worker 0 connecting to queue email_senders
2022-03-27 06:02:43.611 ERR  [process_queue] Unhandled exception from queue: email_senders
</code></pre></div>
<p>...is that ISTR that we only <em>make</em> the SMTP connection when we're actively going to send a message.  So that's a <em>new</em> connection that just got closed, which throws out my theory that this is the SMTP server garbage-collecting old connections.</p>



<a name="1365111"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365111" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365111">(Apr 12 2022 at 19:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="20576">Cosmic Sound</span> <a href="#narrow/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed/near/1365101">said</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="ne">ConnectionResetError</span><span class="p">:</span> <span class="p">[</span><span class="n">Errno</span> <span class="mi">104</span><span class="p">]</span> <span class="n">Connection</span> <span class="n">reset</span> <span class="n">by</span> <span class="n">peer</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">30</span> <span class="mi">08</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mf">12.014</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">process_queue</span><span class="p">]</span> <span class="n">Worker</span> <span class="mi">0</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">queue</span> <span class="n">email_senders</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/current/manage.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">157</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">execute_from_command_line</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/current/manage.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">122</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute_from_command_line</span>
    <span class="n">utility</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">413</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fetch_command</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span><span class="o">.</span><span class="n">run_from_argv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">354</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run_from_argv</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">cmd_options</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">398</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2021-07-03-21-01-47/zerver/management/commands/process_queue.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">82</span><span class="p">,</span> <span class="ow">in</span> <span class="n">handle</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">get_worker</span><span class="p">(</span><span class="n">queue_name</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2021-07-03-21-01-47/zerver/worker/queue_processors.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">152</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get_worker</span>
    <span class="k">return</span> <span class="n">worker_classes</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]()</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2021-07-03-21-01-47/zerver/worker/queue_processors.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">628</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">:</span> <span class="n">EmailBackend</span> <span class="o">=</span> <span class="n">initialize_connection</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/backoff/_sync.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">94</span><span class="p">,</span> <span class="ow">in</span> <span class="n">retry</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">target</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2021-07-03-21-01-47/zerver/lib/send_email.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">279</span><span class="p">,</span> <span class="ow">in</span> <span class="n">initialize_connection</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">open</span><span class="p">():</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">67</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">open</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">starttls</span><span class="p">(</span><span class="n">keyfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_keyfile</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_certfile</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/smtplib.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">783</span><span class="p">,</span> <span class="ow">in</span> <span class="n">starttls</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/ssl.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">500</span><span class="p">,</span> <span class="ow">in</span> <span class="n">wrap_socket</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslsocket_class</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/ssl.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1040</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_create</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/usr/lib/python3.8/ssl.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1309</span><span class="p">,</span> <span class="ow">in</span> <span class="n">do_handshake</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sslobj</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
</code></pre></div><br>
</p>
</blockquote>
<p>Just noticed the date now, so this can maybe be ignored, since is quite old.</p>



<a name="1365112"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365112" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365112">(Apr 12 2022 at 19:59)</a>:</h4>
<p>Tangentially, that the emailed exception didn't have the useful part of the stack trace, and we had to dig it out of the logs, is a little frustrating.</p>



<a name="1365113"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365113" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365113">(Apr 12 2022 at 20:00)</a>:</h4>
<p>Thats true, would be way easier to have a full trace log inside digest.</p>



<a name="1365115"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365115" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365115">(Apr 12 2022 at 20:02)</a>:</h4>
<p>So AFAICT the <code>2022-03-27 06:02:43.611</code> exception is the SMTP server just dropping a new connection.  Which we do retry.  So I think the only potential thing that Zulip could be doing better here is not sending you the error.</p>



<a name="1365116"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365116" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365116">(Apr 12 2022 at 20:04)</a>:</h4>
<p>Oh, we need to broaden the retry exceptions on <a href="https://github.com/zulip/zulip/blob/35e27aef4a3c9700753149eb71768fc313889d8d/zerver/lib/send_email.py#L294-L299">https://github.com/zulip/zulip/blob/35e27aef4a3c9700753149eb71768fc313889d8d/zerver/lib/send_email.py#L294-L299</a></p>



<a name="1365117"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365117" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365117">(Apr 12 2022 at 20:06)</a>:</h4>
<p>That retries <code>OSError</code>, but that includes <code>ConnectionResetError</code>.  So we <em>did</em> retry.</p>



<a name="1365118"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365118" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365118">(Apr 12 2022 at 20:07)</a>:</h4>
<p>Ideally we should have logged that retry, I guess.  But that puts this squarely into "the SMTP service was down or not responding well" which I think <em>should</em> alert you.</p>



<a name="1365121"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365121" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365121">(Apr 12 2022 at 20:09)</a>:</h4>
<p>OK, so it makes a connection when it first starts the worker, in addition to when it sends mail.  We could probably not bother making the initial connection, but in some ways it's useful if it immediately tries the SMTP configuration you've set up, and immediately errors, instead of waiting for later.</p>



<a name="1365122"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365122" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365122">(Apr 12 2022 at 20:12)</a>:</h4>
<p>You said you're delivering mail via <a href="https://docs.postalserver.io/">Postal</a>?  I'd check the logs there to make sure everything was running as expected during those time periods.</p>



<a name="1365697"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Connection%20unexpectedly%20closed/near/1365697" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed.html#1365697">(Apr 13 2022 at 07:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed/near/1365122">said</a>:</p>
<blockquote>
<p>You said you're delivering mail via <a href="https://docs.postalserver.io/">Postal</a>?  I'd check the logs there to make sure everything was running as expected during those time periods.</p>
</blockquote>
<p>Nothing in Postal to correspond to that time and date.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>