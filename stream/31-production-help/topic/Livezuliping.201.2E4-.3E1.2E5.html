<html>
<head><meta charset="utf-8"><title>Livezuliping 1.4-&gt;1.5 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html">Livezuliping 1.4-&gt;1.5</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="152161"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152161" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152161">(Feb 15 2017 at 22:19)</a>:</h4>
<p>I'm going to be live zuliping an upgrade of the Akamai internal Zulip upgrade.</p>



<a name="152162"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152162" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152162">(Feb 15 2017 at 22:21)</a>:</h4>
<p>We're moving from 1.4.1 to 1.5.  Our infrastructure includes several local tweaks, including changes to the authentication workflow.</p>



<a name="152164"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152164" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152164">(Feb 15 2017 at 22:24)</a>:</h4>
<p>Additionally, our infrastructure does not have direct access to the internet.  This means many of the automated tools for upgrades will not work as intended.</p>



<a name="152166"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152166" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152166">(Feb 15 2017 at 22:31)</a>:</h4>
<p>I have manually vetted our changes with scripts/zulip-puppet-apply and saved the ones which we need to keep to another file.</p>



<a name="152168"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152168" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152168">(Feb 15 2017 at 22:36)</a>:</h4>
<p>The tarball is unpacking.</p>



<a name="152169"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152169" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152169">(Feb 15 2017 at 22:36)</a>:</h4>
<p>apt is running.</p>



<a name="152170"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152170" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152170">(Feb 15 2017 at 22:37)</a>:</h4>
<p>One thing we know from prior releases is that the method we use for connecting the server to the internet temporarily for the upgrade (proxychains) will contaminate Zulip when it starts.</p>



<a name="152171"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152171" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152171">(Feb 15 2017 at 22:37)</a>:</h4>
<p>So once the start has attempted, we need to completely shut things down and then bring them back up clean.</p>



<a name="152172"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152172" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152172">(Feb 15 2017 at 22:38)</a>:</h4>
<p>Currently, the upgrade script is downloading things from pip.</p>



<a name="152173"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152173" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152173">(Feb 15 2017 at 22:38)</a>:</h4>
<p>Do you maintain an local mirror of common packages? I've needed to work with customers on air-gapped networks before and it can be a real challenge, depending on how much room there is in the local policies.</p>



<a name="152174"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152174" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152174">(Feb 15 2017 at 22:38)</a>:</h4>
<p>The common stuff we do, but it's pip that kills us.</p>



<a name="152175"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152175" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152175">(Feb 15 2017 at 22:38)</a>:</h4>
<p>Watching this is very interesting, thank you!</p>



<a name="152176"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152176" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152176">(Feb 15 2017 at 22:39)</a>:</h4>
<p>I can bridge things to the internet with proxychains, which is handy, but it bites me in the ass every time if I forget that proxychains contaminates things.</p>



<a name="152177"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152177" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152177">(Feb 15 2017 at 22:39)</a>:</h4>
<p>(Everything that forks off of the original command upgrade_script has LD_PRELOAD messed with.  This will cause connections to "localhost" not do the right thing; rabbitmq and memcached tend to go crazy.)</p>



<a name="152178"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152178" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152178">(Feb 15 2017 at 22:39)</a>:</h4>
<p>It is helpful you can do that, government sites often can't.</p>



<a name="152179"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152179" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152179">(Feb 15 2017 at 22:40)</a>:</h4>
<p>Yes.  It's certainly easier than what we've had to do previously, which is (essentially) manually copy the files over by hand, and instead of running the upgrade scripts, step through them by hand.</p>



<a name="152180"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152180" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152180">(Feb 15 2017 at 22:40)</a>:</h4>
<p>Looks like we're now installing the static assets.</p>



<a name="152181"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152181" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152181">(Feb 15 2017 at 22:41)</a>:</h4>
<p>And puppet is running.</p>



<a name="152182"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152182" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152182">(Feb 15 2017 at 22:41)</a>:</h4>
<p>Notably, rabbitmq is erroring because of a long-standing bug with /etc/default/rabbitmq having problems when you specify the IPv4 address.</p>



<a name="152183"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152183" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152183">(Feb 15 2017 at 22:42)</a>:</h4>
<p>We fix this by removing the /etc/default/rabbitmq file altogether, but puppet replaces it during upgrades.</p>



<a name="152184"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152184" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152184">(Feb 15 2017 at 22:42)</a>:</h4>
<p>As expected, the upgrade script has errored out.</p>



<a name="152185"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152185" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152185">(Feb 15 2017 at 22:44)</a>:</h4>
<p>Now things begin to need to move quickly; commentary may slow.</p>



<a name="152186"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152186" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152186">(Feb 15 2017 at 22:44)</a>:</h4>
<p>I've stopped all the zulip services, since they're contaminated and half-upgraded.</p>



<a name="152187"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152187" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152187">(Feb 15 2017 at 22:44)</a>:</h4>
<p>This also means stopping rabbitmq, redis, and memcached.</p>



<a name="152189"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152189" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152189">(Feb 15 2017 at 22:48)</a>:</h4>
<p>rabbitmq is now having problems starting up.  We've seen this before, though it's never entirely sure what causes it.</p>



<a name="152191"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152191" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152191">(Feb 15 2017 at 23:04)</a>:</h4>
<p>The problem with rabbitmq was the creation of the /etc/rabbitmq-server/rabbitmq config file.</p>



<a name="152192"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152192" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152192">(Feb 15 2017 at 23:04)</a>:</h4>
<p>Again, long-standing issue.</p>



<a name="152193"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152193" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152193">(Feb 15 2017 at 23:04)</a>:</h4>
<p>The thing that we're having weird problems with is postgres, not rabbitmq.</p>



<a name="152194"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152194" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152194">(Feb 15 2017 at 23:08)</a>:</h4>
<p>Aha.  It appears puppet messed with the configs on the keys.</p>



<a name="152195"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152195" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152195">(Feb 15 2017 at 23:08)</a>:</h4>
<p>Fixing.</p>



<a name="152196"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152196" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152196">(Feb 15 2017 at 23:16)</a>:</h4>
<p>Postgres is back up</p>



<a name="152197"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152197" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152197">(Feb 15 2017 at 23:16)</a>:</h4>
<p>Resuming upgrade</p>



<a name="152201"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152201" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152201">(Feb 15 2017 at 23:20)</a>:</h4>
<p>Migrations running.</p>



<a name="152202"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152202" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152202">(Feb 15 2017 at 23:21)</a>:</h4>
<p>I'm currently manually walking through the upgrade step 2 script by hand, since I need to skip pip stuff now.</p>



<a name="152203"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152203" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152203">(Feb 15 2017 at 23:21)</a>:</h4>
<p>Migration ran into a problem with 0032.</p>



<a name="152204"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152204" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152204">(Feb 15 2017 at 23:21)</a>:</h4>
<p>BadImageError.  Investigating.</p>



<a name="152226"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152226" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152226">(Feb 15 2017 at 23:28)</a>:</h4>
<p>Not sure what's the deal there.</p>



<a name="152227"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152227" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152227">(Feb 15 2017 at 23:28)</a>:</h4>
<p>Skipping it for now.</p>



<a name="152228"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152228" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152228">(Feb 15 2017 at 23:28)</a>:</h4>
<p>Continuing with migrations.</p>



<a name="152250"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152250" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152250">(Feb 15 2017 at 23:33)</a>:</h4>
<p>The rest of the migrations went smoothly.</p>



<a name="152253"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152253" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152253">(Feb 15 2017 at 23:33)</a>:</h4>
<p>I then reapplied the local modifications.</p>



<a name="152254"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152254" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152254">(Feb 15 2017 at 23:34)</a>:</h4>
<p>Things appear to be back up; verifying that SSO still works.</p>



<a name="152256"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152256" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152256">(Feb 15 2017 at 23:34)</a>:</h4>
<p>SSO works.</p>



<a name="152271"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152271" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152271">(Feb 15 2017 at 23:56)</a>:</h4>
<p>Everything pretty much seems to work.</p>



<a name="152272"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152272" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152272">(Feb 15 2017 at 23:57)</a>:</h4>
<p>I'm going to end the liveblogging here, though I'll peek in tomorrow to see if anyone has any questions.</p>



<a name="152305"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152305" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152305">(Feb 16 2017 at 00:43)</a>:</h4>
<p><span class="user-mention" data-user-email="hlieberman@setec.io" data-user-id="110">@Harlan Lieberman-Berg</span> with rabbitmq, once you're on 1.5 there's a thing you can do to hardcode rabbitmq to use a fixed node name and thus (likely) stop having restart issues again</p>



<a name="152306"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152306" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152306">(Feb 16 2017 at 00:44)</a>:</h4>
<p>It's the default in 1.5, but there's no good way to migrate without a bit of manual operations</p>



<a name="152308"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152308" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152308">(Feb 16 2017 at 00:44)</a>:</h4>
<p>Re: 0032, that migration is intended to make the new larger avatar images that you can see on <a href="https://chat.zulip.org/#settings/your-account" target="_blank" title="https://chat.zulip.org/#settings/your-account">https://chat.zulip.org/#settings/your-account</a></p>



<a name="152309"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152309" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152309">(Feb 16 2017 at 00:45)</a>:</h4>
<p>So probably one of your avatar images has some problem with changing its format</p>



<a name="152312"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152312" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152312">(Feb 16 2017 at 00:45)</a>:</h4>
<p>I'd be curious for more debugging; that migration is harmless to skip though because the new avatar images aren't used in 1.5</p>



<a name="152313"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152313" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152313">(Feb 16 2017 at 00:45)</a>:</h4>
<p>(well, harmless for now, will be trouble in 1.6)</p>



<a name="152601"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152601" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GervaisdeM <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152601">(Feb 16 2017 at 13:48)</a>:</h4>
<p>is this thing you can do to RabbitMQ to make have it stop having restart issues documented somewhere? Can you point us to it?</p>



<a name="152603"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152603" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GervaisdeM <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152603">(Feb 16 2017 at 13:50)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> <img alt=":point_up:" class="emoji" src="/static/generated/emoji/images/emoji/point_up.png" title=":point_up:">  <img alt=":slightly_smiling_face:" class="emoji" src="/static/generated/emoji/images/emoji/slightly_smiling_face.png" title=":slightly_smiling_face:"></p>



<a name="152647"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152647" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152647">(Feb 16 2017 at 15:32)</a>:</h4>
<p>Re: 0032, I figured as much.  I've got a list of images which didn't convert properly; I'll take a look and see if I can figure out which one is causing the problems.</p>



<a name="152651"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152651" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152651">(Feb 16 2017 at 15:33)</a>:</h4>
<p>The RabbitMQ thing, I believe is IPv6 related.  Specifically, rm'ing the /etc/default/rabbitmq-server and /etc/rabbitmq fixes it.</p>



<a name="152942"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/152942" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#152942">(Feb 16 2017 at 20:30)</a>:</h4>
<p><span class="user-mention" data-user-email="gervais@demontbrun.com" data-user-id="70">@GervaisdeM</span> I haven't documented it in part because it'd be nice to have a few folks alpha test the procedure.  It will be something like this:</p>
<div class="codehilite"><pre><span></span>* Edit /etc/zulip/zulip.conf and add the below block to it.
* supervisorctl stop all
* /etc/init.d/rabbitmq-server stop
* apt-get purge rabbitmq-server # may not be needed
* scripts/setup/zulip-puppet-apply -f
* /etc/init.d/rabbitmq-server start # may not be needed
* scripts/setup/configure-rabbitmq
* supervisorctl start all
</pre></div>


<p><code>/etc/zulip/zulip.conf</code> lines:</p>
<div class="codehilite"><pre><span></span>[rabbitmq]
nodename = zulip@localhost
</pre></div>



<a name="170835"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/170835" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GervaisdeM <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#170835">(Mar 15 2017 at 14:57)</a>:</h4>
<p>FWIW, the above didn't help me. RabbitMQ does not start after a reboot. <img alt=":frowning:" class="emoji" src="/static/generated/emoji/images/emoji/unicode/1f626.png" title=":frowning:"> <br>
I wrote a crappy bash shell that checks if rabbitmq is running and starts it. It's in my crontab and runs at reboot.<br>
<code>@reboot /usr/bin/sudo /home/gervais/bin/crappy-rabbitmq-server-fix.sh</code></p>
<hr>
<p>Ugly, ugly, ugly, hack:</p>
<div class="codehilite"><pre><span></span>gervais@zulip:~/bin$ cat crappy-rabbitmq-server-fix.sh 
#!/bin/bash

/etc/init.d/rabbitmq-server status &gt; /dev/null 2&gt;&amp;1
result=`echo $?`
giveUpCount=30

while [ $result -ne 0 ] &amp;&amp; [ $giveUpCount -ge 0 ]; do
  /etc/init.d/rabbitmq-server start &gt; /dev/null 2&gt;&amp;1
  result=`echo $?`
  sleep 2
  let giveUpCount=giveUpCount-1
done
</pre></div>



<a name="170971"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/170971" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#170971">(Mar 15 2017 at 17:44)</a>:</h4>
<p><span class="user-mention" data-user-email="gervais@demontbrun.com" data-user-id="70">@GervaisdeM</span> are you running Ubuntu Trusty or Xenial?</p>



<a name="170986"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/170986" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GervaisdeM <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#170986">(Mar 15 2017 at 17:54)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> I'm still running on Trusty. Which leads to another question about upgrading... Is there an upgrade path to 16.04LTS?</p>



<a name="170993"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/170993" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#170993">(Mar 15 2017 at 17:57)</a>:</h4>
<p>We don't have an automated one.  The main tricky part is that we need to migrate from Postgres 9.3 to 9.5 as part of that process</p>



<a name="170994"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/170994" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#170994">(Mar 15 2017 at 17:58)</a>:</h4>
<p>We'd probably plan to move Trusty to 9.5 as the first stage of such a migration; I think if that were done it wouldn't be too hard to make work</p>



<a name="171729"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/171729" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GervaisdeM <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#171729">(Mar 16 2017 at 12:16)</a>:</h4>
<p>A little downtime doesn't bother me. Shouldn't postgres db's migrate fine with a minor version upgrade? Something automated is nice, but some detailed steps to follow would be a good start. Does such a list of steps exist?</p>



<a name="171822"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/171822" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#171822">(Mar 16 2017 at 17:54)</a>:</h4>
<p>We haven't written some, but I bet one could just follow the postgres upstream instructions</p>



<a name="171825"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Livezuliping%201.4-%3E1.5/near/171825" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Livezuliping.201.2E4-.3E1.2E5.html#171825">(Mar 16 2017 at 17:55)</a>:</h4>
<p>To make progress on this, we should attempt it on a test machine; (1) figure out how to add the right PPA for postgres 9.5, (2) build tsearch-extras for it, (3) try the postgres migration instructions.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>