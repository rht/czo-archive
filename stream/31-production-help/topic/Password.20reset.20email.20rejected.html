<html>
<head><meta charset="utf-8"><title>Password reset email rejected · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html">Password reset email rejected</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="626573"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/626573" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Shank <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#626573">(Aug 07 2018 at 05:03)</a>:</h4>
<p>One of my users tried to reset his password and it failed, giving him an Internal Server Error. I then got an email informing me "[Django] zulip: (554, b'Message rejected: Email address is not verified..."</p>



<a name="626574"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/626574" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Shank <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#626574">(Aug 07 2018 at 05:06)</a>:</h4>
<p>I'm using Amazon Simple Email Service, and it must be working since I get all the notifications of messages I received while offline, plus the email notifying me of the error...This particular email tells me that my identities failed AWS verification. The email address Zulip sends from changes each time (noreply-&lt;some code&gt;@my.zulip.domain), so I added my domain to SES.</p>



<a name="626575"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/626575" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Shank <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#626575">(Aug 07 2018 at 05:08)</a>:</h4>
<p>But still, the password reset email results in this error. Here's the traceback:</p>
<div class="codehilite"><pre><span></span>Logger django.request, from module django.core.handlers.exception line 135:
Error generated by Anonymous user (not logged in) on my.zulip.domain deployment

Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2018-08-04-06-44-17/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/exception.py&quot;, line 41, in inner
    response = get_response(request)
  File &quot;/home/zulip/deployments/2018-08-04-06-44-17/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/base.py&quot;, line 187, in _get_response
    response = self.process_exception_by_middleware(e, request)
  File &quot;/home/zulip/deployments/2018-08-04-06-44-17/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/base.py&quot;, line 185, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;./zerver/views/auth.py&quot;, line 890, in password_reset
    post_reset_redirect=&#39;/accounts/password/reset/done/&#39;)
  File &quot;/home/zulip/deployments/2018-08-04-06-44-17/zulip-py3-venv/lib/python3.5/site-packages/django/contrib/auth/views.py&quot;, line 54, in inner
    return func(*args, **kwargs)
  File &quot;/home/zulip/deployments/2018-08-04-06-44-17/zulip-py3-venv/lib/python3.5/site-packages/django/utils/decorators.py&quot;, line 149, in _wrapped_view
    response = view_func(request, *args, **kwargs)
  File &quot;/home/zulip/deployments/2018-08-04-06-44-17/zulip-py3-venv/lib/python3.5/site-packages/django/contrib/auth/views.py&quot;, line 306, in password_reset
    form.save(**opts)
  File &quot;./zerver/forms.py&quot;, line 249, in save
    context=context)
  File &quot;./zerver/lib/send_email.py&quot;, line 102, in send_email
    if mail.send() == 0:
  File &quot;/home/zulip/deployments/2018-08-04-06-44-17/zulip-py3-venv/lib/python3.5/site-packages/django/core/mail/message.py&quot;, line 348, in send
    return self.get_connection(fail_silently).send_messages([self])
  File &quot;/home/zulip/deployments/2018-08-04-06-44-17/zulip-py3-venv/lib/python3.5/site-packages/django/core/mail/backends/smtp.py&quot;, line 111, in send_messages
    sent = self._send(message)
  File &quot;/home/zulip/deployments/2018-08-04-06-44-17/zulip-py3-venv/lib/python3.5/site-packages/django/core/mail/backends/smtp.py&quot;, line 127, in _send
    self.connection.sendmail(from_email, recipients, message.as_bytes(linesep=&#39;\r\n&#39;))
  File &quot;/usr/lib/python3.5/smtplib.py&quot;, line 883, in sendmail
    raise SMTPDataError(code, resp)
smtplib.SMTPDataError: (554, b&#39;Message rejected: Email address is not verified. The following identities failed the check in region US-WEST-2: noreply-grav2ofh2h0ccklq27glw024@my.zulip.domain...&#39;)


Deployed code:
- git: 1.8.0-2234-gcf813b4
- ZULIP_VERSION: 1.8.1+git


Request info:
- path: /accounts/password/reset/
- POST: {&#39;csrfmiddlewaretoken&#39;: [&#39;**********&#39;], &#39;email&#39;: [&#39;my@email&#39;]}
- REMOTE_ADDR: &quot;[&#39;x.x.x.x&#39;]&quot;
- QUERY_STRING: &quot;[&#39;&#39;]&quot;
- SERVER_NAME: &quot;[&#39;&#39;]&quot;
</pre></div>



<a name="626989"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/626989" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#626989">(Aug 07 2018 at 21:18)</a>:</h4>
<p><span class="user-mention" data-user-id="6605">@Steve Shank</span> so, the email address that isn't verified is the outgoing email address.</p>



<a name="626991"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/626991" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#626991">(Aug 07 2018 at 21:20)</a>:</h4>
<p>(And we by default use randomized outgoing email addresses for noreply emails)</p>



<a name="626992"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/626992" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#626992">(Aug 07 2018 at 21:20)</a>:</h4>
<p>You can set:<br>
<code>ADD_TOKENS_TO_NOREPLY_ADDRESS = False</code><br>
in your settings if you need to turn that off.</p>



<a name="626994"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/626994" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#626994">(Aug 07 2018 at 21:21)</a>:</h4>
<p>(It's a security protection against a bad-for-security interaction between support ticket systems that let you create online accounts without verifying you control the email address you register with, and software like Zulip that supports letting anyone create an account in a private organization if they have an email address in the organization)</p>



<a name="626995"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/626995" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#626995">(Aug 07 2018 at 21:22)</a>:</h4>
<p>If you're not using that feature, you can just turn the setting off.  Otherwise, you need to figure out how to allow wildcards in your SES configuration (I haven't used SES, so don't know if that's feasible)</p>



<a name="627029"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/627029" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Shank <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#627029">(Aug 07 2018 at 22:06)</a>:</h4>
<p>Thanks Tim, that makes sense. I wonder why it's not working on a domain basis, though. You can also add send-from domains to SES and then any email should validate.</p>



<a name="627031"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/627031" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Shank <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#627031">(Aug 07 2018 at 22:07)</a>:</h4>
<p>What would be the risk of disabling that feature? I'm not quite sure I understood the rationale. Is there a page that explains it? Thanks</p>



<a name="627042"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/627042" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#627042">(Aug 07 2018 at 22:12)</a>:</h4>
<p>It's a bit complicated, but here's the main article on it:<br>
<a href="https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c" target="_blank" title="https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c">https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c</a></p>



<a name="627044"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Password%20reset%20email%20rejected/near/627044" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Password.20reset.20email.20rejected.html#627044">(Aug 07 2018 at 22:12)</a>:</h4>
<p>(Basically relies on the helpdesk software letting you get access sent to emails sent by <code>feedback@slack.com</code>)</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>