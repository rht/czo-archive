<html>
<head><meta charset="utf-8"><title>SAML: Issuer of the Assertion not found or multiple · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html">SAML: Issuer of the Assertion not found or multiple</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1040963"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1040963" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1040963">(Oct 19 2020 at 08:51)</a>:</h4>
<p>Hi :-)<br>
I configured SAML according to the docs, my IdP says that all my configuration work seems to be reasonable and they told me to contact you.<br>
When I try to login using SAML, I get a 500 Internal server error (POST to /complete/saml/) and a mail with the subject <code>[Django] host: Issuer of the Assertion not found or multiple.</code> and the following traceback:</p>
<div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/exception.py&quot;, line 34, in inner
    response = get_response(request)
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py&quot;, line 115, in _get_response
    response = self.process_exception_by_middleware(e, request)
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py&quot;, line 113, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/cache.py&quot;, line 44, in _wrapped_view_func
    response = view_func(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/csrf.py&quot;, line 54, in wrapped_view
    return view_func(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/social_django/utils.py&quot;, line 49, in wrapper
    return func(request, backend, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/social_django/views.py&quot;, line 31, in complete
    return do_complete(request.backend, _do_login, user=request.user,
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/social_core/actions.py&quot;, line 45, in do_complete
    user = backend.complete(user=user, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py&quot;, line 40, in complete
    return self.auth_complete(*args, **kwargs)
  File &quot;./zproject/backends.py&quot;, line 1909, in auth_complete
    idp_name = self.get_issuing_idp(SAMLResponse)
  File &quot;./zproject/backends.py&quot;, line 1792, in get_issuing_idp
    issuers = resp.get_issuers()
  File &quot;/srv/zulip-venv-cache/6f29ad6387ac30ebe6770916be3d39a90e77fc7b/zulip-py3-venv/lib/python3.8/site-packages/onelogin/saml2/response.py&quot;, line 425, in get_issuers
    raise OneLogin_Saml2_ValidationError(
onelogin.saml2.errors.OneLogin_Saml2_ValidationError: Issuer of the Assertion not found or multiple.
</code></pre></div>


<p>Any ideas where I could look for the error? Help would be greatly appreciated! :-)</p>



<a name="1041376"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1041376" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1041376">(Oct 19 2020 at 19:03)</a>:</h4>
<p>I haven't encountered that exception before; <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> might have ideas.</p>



<a name="1041379"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1041379" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1041379">(Oct 19 2020 at 19:04)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert</span> but I'd probably start with patching your Zulip installation to add print statement to at least determine whether it's none or multiple, since that'll likely be relevant for debugging further.</p>



<a name="1041405"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1041405" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1041405">(Oct 19 2020 at 19:15)</a>:</h4>
<p>It might also be worth manually looking through the SAMLResponse to see what's going on with the issuers. This seems more likely to be an issue on the IdP side if it's generating SAMLResponses with missing issuers or mutiple issuers  which isn't supported by our underlying saml libraries</p>



<a name="1041472"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1041472" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1041472">(Oct 19 2020 at 21:53)</a>:</h4>
<p>Thank you. I tried to analyze the SAML traffic, but I'm not really sure where the error occurred. So I took the FF addon SAML-tracer in order to get nicely formatted SAML traffic for you :-)<br>
zulip request:</p>
<div class="codehilite"><pre><span></span><code>&lt;samlp:AuthnRequest xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;
                    xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;
                    ID=&quot;ONELOGIN_[...]&quot;
                    Version=&quot;2.0&quot;
                    ProviderName=&quot;Zulip Chat&quot;
                    IssueInstant=&quot;2020-10-19T21:36:44Z&quot;
                    Destination=&quot;https://login.idp.de/idp/profile/SAML2/Redirect/SSO&quot;
                    ProtocolBinding=&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&quot;
                    AssertionConsumerServiceURL=&quot;https://zulip.host.de/complete/saml/&quot;
                    &gt;
    &lt;saml:Issuer&gt;https://zulip.host.de&lt;/saml:Issuer&gt;
    &lt;samlp:NameIDPolicy Format=&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&quot;
                        AllowCreate=&quot;true&quot;
                        /&gt;
    &lt;samlp:RequestedAuthnContext Comparison=&quot;exact&quot;&gt;
        &lt;saml:AuthnContextClassRef&gt;urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport&lt;/saml:AuthnContextClassRef&gt;
    &lt;/samlp:RequestedAuthnContext&gt;
&lt;/samlp:AuthnRequest&gt;
</code></pre></div>


<p>idp response:</p>
<div class="codehilite"><pre><span></span><code>&lt;saml2p:Response Destination=&quot;https://zulip.host.de/complete/saml/&quot;
                 ID=&quot;[...]&quot;
                 InResponseTo=&quot;ONELOGIN_[...]&quot;
                 IssueInstant=&quot;2020-10-19T21:36:44.587Z&quot;
                 Version=&quot;2.0&quot;
                 xmlns:saml2p=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;
                 &gt;
    &lt;saml2:Issuer xmlns:saml2=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;&gt;https://idp.host.de/idp/shibboleth&lt;/saml2:Issuer&gt;
    &lt;ds:Signature xmlns:ds=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;
        &lt;ds:SignedInfo&gt;
            &lt;ds:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot; /&gt;
            &lt;ds:SignatureMethod Algorithm=&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot; /&gt;
            &lt;ds:Reference URI=&quot;#_[...]&quot;&gt;
                &lt;ds:Transforms&gt;
                    &lt;ds:Transform Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot; /&gt;
                    &lt;ds:Transform Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot; /&gt;
                &lt;/ds:Transforms&gt;
                &lt;ds:DigestMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#sha256&quot; /&gt;
                &lt;ds:DigestValue&gt;[...]&lt;/ds:DigestValue&gt;
            &lt;/ds:Reference&gt;
        &lt;/ds:SignedInfo&gt;
        &lt;ds:SignatureValue&gt;[SIG]&lt;/ds:SignatureValue&gt;
        &lt;ds:KeyInfo&gt;
            &lt;ds:X509Data&gt;
                &lt;ds:X509Certificate&gt;[CERTIFICATE]&lt;/ds:X509Certificate&gt;
            &lt;/ds:X509Data&gt;
        &lt;/ds:KeyInfo&gt;
    &lt;/ds:Signature&gt;
    &lt;saml2p:Status&gt;
        &lt;saml2p:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Responder&quot; /&gt;
        &lt;saml2p:StatusMessage&gt;An error occurred.&lt;/saml2p:StatusMessage&gt;
    &lt;/saml2p:Status&gt;
&lt;/saml2p:Response&gt;
</code></pre></div>


<p>Can you see anything helpful there?</p>



<a name="1042054"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1042054" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1042054">(Oct 20 2020 at 12:44)</a>:</h4>
<p>What I see here looks okay in terms of the issuer (though I'm no expert on the SAML specification) - but this also doesn't seem to be a successful SAMLReseponse, after all you have</p>
<div class="codehilite"><pre><span></span><code>&lt;saml2p:StatusMessage&gt;An error occurred.&lt;/saml2p:StatusMessage&gt;
</code></pre></div>


<p>and Assertions about the user aren't sent. If this is what's being sent to Zulip on those login attempts that generated the <code>OneLogin_Saml2_ValidationError</code>, then that certainly cannot succeed - although admittely the error we're generating would be rather useless for communicating what's wrong</p>



<a name="1043559"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1043559" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1043559">(Oct 21 2020 at 15:31)</a>:</h4>
<p>Got it: The IdP needed also the certificate for the encryption of the Assertion...<br>
Thank you for your help! :-)</p>



<a name="1043811"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1043811" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1043811">(Oct 21 2020 at 17:57)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert</span> remind me -- what IdP software are you using?  I'd love to update the documentation to help the next person avoid the challenges you've been having configuring this by adding a guide for that IdP.</p>



<a name="1043918"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1043918" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1043918">(Oct 21 2020 at 20:19)</a>:</h4>
<p>Oh, I don't think that this is necessary because it's a special IdP service of my university. So no one else will use it :-)</p>



<a name="1043931"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML%3A%20Issuer%20of%20the%20Assertion%20not%20found%20or%20multiple/near/1043931" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.3A.20Issuer.20of.20the.20Assertion.20not.20found.20or.20multiple.html#1043931">(Oct 21 2020 at 20:23)</a>:</h4>
<p>OK, makes sense.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>