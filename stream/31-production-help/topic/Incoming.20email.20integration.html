<html>
<head><meta charset="utf-8"><title>Incoming email integration · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html">Incoming email integration</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="780969"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/780969" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oldinosor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#780969">(Aug 19 2019 at 16:34)</a>:</h4>
<p>Hi, I followed <a href="https://zulip.readthedocs.io/en/latest/production/email-gateway.html" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/email-gateway.html">https://zulip.readthedocs.io/en/latest/production/email-gateway.html</a> =&gt; everything done.<br>
Zulip is self-hosted. Streams, topics, push notifications work.<br>
DNS MX seems OK.<br>
I see the email address for each stream =&gt; seems also OK.<br>
But when I send an email to a stream, it is sent (no error message), but it never appears inside the stream.<br>
Any idea about what could go wrong or how and what to check?</p>



<a name="780974"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/780974" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#780974">(Aug 19 2019 at 17:55)</a>:</h4>
<p><span class="user-mention" data-user-id="13140">@Oldinosor</span> check <code>/var/log/mail.log</code> for errors first.</p>



<a name="780975"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/780975" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#780975">(Aug 19 2019 at 17:55)</a>:</h4>
<p>Are you on Ubuntu Bionic?  There's a configuration issue for that we'll be fixing in 2.0.5.</p>



<a name="781001"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/781001" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oldinosor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#781001">(Aug 19 2019 at 19:53)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Yes, Ubuntu 18.04 LTS. :-)<br>
Will have a look on  /var/log/mail.log</p>



<a name="781002"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/781002" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oldinosor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#781002">(Aug 19 2019 at 20:02)</a>:</h4>
<p>Same logs contents every minute:</p>
<div class="codehilite"><pre><span></span>Aug 19 19:53:47 zlwz postfix/master[1717]: warning: /usr/lib/postfix/sbin/smtpd: bad command startup -- throttling
Aug 19 19:54:47 zlwz postfix/smtpd[18154]: fatal: in parameter smtpd_relay_restrictions or smtpd_recipient_restrictions, specify at least one working instance of: reject_unauth_destination, defer_unauth_destination, reject, defer, defer_if_permit or check_relay_domains
Aug 19 19:54:48 zlwz postfix/master[1717]: warning: process /usr/lib/postfix/sbin/smtpd pid 18154 exit status 1
</pre></div>



<a name="781003"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/781003" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#781003">(Aug 19 2019 at 20:11)</a>:</h4>
<p>Yes, that's the config issue that'll be fixed in 2.0.5 <span class="user-mention" data-user-id="13140">@Oldinosor</span> <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="781004"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/781004" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oldinosor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#781004">(Aug 19 2019 at 20:13)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span>  All right, will wait the fix. Thanks! <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="818431"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/818431" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#818431">(Feb 19 2020 at 10:21)</a>:</h4>
<p>Hi, i configured mailgun for sending messages and configured the local postfix for integrating the incoming mails. all works so far. E-mails are sent and received. if you hide the message content in the e-mails, than zulip will missed message mails with</p>
<div class="codehilite"><pre><span></span>—
You are receiving this because you have email notifications enabled for this stream.
Reply in Zulip, or manage email preferences.

Do not reply to this message. This Zulip server is not configured to accept incoming emails (help).
</pre></div>


<p>If you reply to this mail, it is send into zulip without problems. Should't it be better to remove the reply-to address in this mails to prevent answering the email without knowing the content of the missed message?</p>



<a name="818436"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/818436" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cyphase <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#818436">(Feb 19 2020 at 11:06)</a>:</h4>
<p>I noticed this the other day when I set up incoming email integration on my instance; forgot to report it.</p>



<a name="818438"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/818438" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#818438">(Feb 19 2020 at 11:15)</a>:</h4>
<p>do you want to report it, or should i file an issue?</p>



<a name="818448"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/818448" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cyphase <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#818448">(Feb 19 2020 at 12:28)</a>:</h4>
<p><span class="user-mention" data-user-id="14849">@Ronny</span> You go ahead, I've already got a backlog of Zulip issues to report. <span aria-label="laughter tears" class="emoji emoji-1f602" role="img" title="laughter tears">:laughter_tears:</span></p>



<a name="818449"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/818449" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#818449">(Feb 19 2020 at 12:29)</a>:</h4>
<p><span aria-label="ok" class="emoji emoji-1f44c" role="img" title="ok">:ok:</span></p>



<a name="818456"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/818456" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#818456">(Feb 19 2020 at 13:07)</a>:</h4>
<p><code>Do not reply to this message. This Zulip server is not configured to accept incoming emails (help).</code> this is in the email despite the reply-to address working? Is it also in the emails if you're not hiding message content in them?</p>



<a name="818519"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/818519" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#818519">(Feb 19 2020 at 18:32)</a>:</h4>
<p><span class="user-mention" data-user-id="14849">@Ronny</span> this bug is fixed in master.</p>



<a name="1144569"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1144569" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donny Winston <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1144569">(Mar 26 2021 at 21:45)</a>:</h4>
<p>I'm self-hosting via the official <a href="https://marketplace.digitalocean.com/apps/zulip">Digital Ocean droplet</a> (basic regular-intel droplet at 4GB RAM), confirmed version 3.3 via <code>grep ZULIP_VERSION /home/zulip/deployments/current/version.py</code>. I was able to walk through <a href="https://zulip.readthedocs.io/en/stable/production/email-gateway.html">local delivery setup</a>. However, I asked a colleague to reply to a private message via email, and it didn't work. The relevant section of <code>/var/log/mail.log</code> seems to be:</p>
<div class="codehilite"><pre><span></span><code>Mar 26 04:21:29 zulip-ubuntu-s-2vcpu-4gb-sfo3-01 postfix/smtpd[529]: connect from mail-lj1-f173.google.com[209.85.208.173]
Mar 26 04:21:30 zulip-ubuntu-s-2vcpu-4gb-sfo3-01 postfix/smtpd[529]: NOQUEUE: reject: RCPT from mail-lj1-f173.google.com[209.85.208.173]: 554 5.7.1 &lt;mm4c52fb35931d2413
192d0cab5f07fa96@nmdc-zulip.polyneme.xyz&gt;: Relay access denied; from=&lt;username@lbl.gov&gt; to=&lt;mm4c52fb35931d2413192d0cab5f07fa96@nmdc-zulip.polyneme.xyz&gt; proto=ESMTP hel
o=&lt;mail-lj1-f173.google.com&gt;
Mar 26 04:21:31 zulip-ubuntu-s-2vcpu-4gb-sfo3-01 postfix/smtpd[529]: disconnect from mail-lj1-f173.google.com[209.85.208.173] ehlo=2 starttls=1 mail=1 rcpt=0/1 data=0/
1 quit=1 commands=5/7
Mar 26 04:24:51 zulip-ubuntu-s-2vcpu-4gb-sfo3-01 postfix/anvil[531]: statistics: max connection rate 1/60s for (smtp:209.85.208.173) at Mar 26 04:21:29
Mar 26 04:24:51 zulip-ubuntu-s-2vcpu-4gb-sfo3-01 postfix/anvil[531]: statistics: max connection count 1 for (smtp:209.85.208.173) at Mar 26 04:21:29
Mar 26 04:24:51 zulip-ubuntu-s-2vcpu-4gb-sfo3-01 postfix/anvil[531]: statistics: max cache size 1 at Mar 26 04:21:29
</code></pre></div>
<p>I substituted <code>username@lbl.gov</code> above for their email address, but it is a <code>@lbl.gov</code> email address and they use Google Apps to handle email, which is why the <code>.google.com</code> stuff.</p>
<p>There's also several <code>NOQUEUE: reject: RCPT from unknown[37.49.225.30]: 554 5.7.1 &lt;spameri@tiscali.it&gt;</code> lines, which makes sense, but the reply from my colleague isn't spam.</p>
<p>How can I best continue to troubleshoot this? Separately, do folks recommend a way for me to test a solution without roping in other people, e.g. have a bot message me so I can try to email in response?</p>



<a name="1144614"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1144614" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1144614">(Mar 26 2021 at 22:29)</a>:</h4>
<p><span class="user-mention" data-user-id="19442">@Donny Winston</span> this is the right place to ask, though some of the best folks to help aren't online right now.</p>



<a name="1144615"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1144615" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1144615">(Mar 26 2021 at 22:31)</a>:</h4>
<p>I would expect the issue to be with the <code>mailname</code> setup, since it's being rejected in <code>postfix</code>?</p>



<a name="1144617"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1144617" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1144617">(Mar 26 2021 at 22:33)</a>:</h4>
<p>A test user is the easiest way to orchestrate testing, but if making one is hard for account management reasons, you can make a bot user and have it send you private messages while you don't have Zulip open, and that should generate immediate emails of this form.</p>



<a name="1144638"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1144638" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1144638">(Mar 26 2021 at 23:05)</a>:</h4>
<p>Check that the <code>postfix.mailname</code> matches <code>nmdc-zulip.polyneme.xyz</code></p>



<a name="1144639"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1144639" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1144639">(Mar 26 2021 at 23:10)</a>:</h4>
<p>I suspect there's disagreement, from:</p>
<div class="codehilite"><pre><span></span><code>$ nc nmdc-zulip.polyneme.xyz 25
220 zulip-ubuntu-s-2vcpu-4gb-sfo3-01 ESMTP Postfix (Zulip)
</code></pre></div>



<a name="1145197"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1145197" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donny Winston <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1145197">(Mar 27 2021 at 13:55)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="12178">@Alex Vandiver</span> and <span class="user-mention" data-user-id="7">@Tim Abbott</span> ! I had no<code>[postfix]</code> section in <code>/etc/zulip/zulip.conf</code> because I thought my <code>emaildomain</code> was set as the same as my <code>hostname</code> as per <a href="https://zulip.readthedocs.io/en/stable/production/email-gateway.html">local delivery setup</a>, i.e. <code>dig +short nmdc-zulip.polyneme.xyz -t MX</code> yields <code>10 nmdc-zulip.polyneme.xyz.</code> for me. However, I neglected to properly set my hostname, as <span class="user-mention" data-user-id="12178">@Alex Vandiver</span> indicated! I followed the procedure <a href="https://www.digitalocean.com/community/questions/how-do-i-change-hostname">here</a> (corroborated <a href="https://www.digitalocean.com/community/questions/how-to-set-a-persistant-fqdn-for-an-ubuntu-18-04-droplet">here</a>) to change the hostname on my droplet, followed your advice <span class="user-mention" data-user-id="7">@Tim Abbott</span> to make a test user, and now the test user can reply via email! Huzzah! I suppose this issue could have been prevented by me naming my droplet with my intended FQDN on creation? Anyway, thank you so much for the help!</p>



<a name="1160324"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1160324" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1160324">(Apr 12 2021 at 10:48)</a>:</h4>
<p>Hi,</p>
<p>i configured the <a href="https://zulip.readthedocs.io/en/stable/production/email-gateway.html#local-delivery-setup">local delivery setup</a>, but the incoming mails are not send into zulip.<br>
I don't know why the delivery from postfix to zulip isn't working. Here is the postfix log:</p>
<div class="codehilite"><pre><span></span><code>Apr 12 12:36:43 knecht postfix/pipe[19226]: B39A420B52: to=&lt;zulip@localhost&gt;, orig_to=&lt;mm93ce8d900c1cef56712e02885efd00ef@zulip.my-domain-name.com&gt;, relay=zulip, delay=0.19, delays=0.11/0/0/0.08, dsn=4.4.2, status=deferred (Connection dropped: Internal server error. )
</code></pre></div>
<p>Hostname: <a href="http://knecht.my-domain-name.com">knecht.my-domain-name.com</a></p>
<p>EXTERNAL_HOST: <a href="http://zulip.my-domain-name.com">zulip.my-domain-name.com</a></p>
<p>MX resolves correctly:</p>
<div class="codehilite"><pre><span></span><code>dig +short zulip.my-domain-name.com
0 knecht.my-domain-name.com
</code></pre></div>
<p>Any ideas whats wrong? I found no hints about the "Connection dropped: Internal server error" - error.</p>



<a name="1160343"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1160343" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1160343">(Apr 12 2021 at 12:44)</a>:</h4>
<p>After investigating the problem:</p>
<p>The error comes from the script <a href="https://github.com/zulip/zulip/blob/master/scripts/lib/email-mirror-postfix">email-mirror-postfix</a>.</p>
<p>Postfix is directing the message to this script and the script is trying to create a request to </p>
<p><code>https://127.0.0.1/email_mirror_message</code>. </p>
<p>This fails with a http error </p>
<p><code>HTTP Error 404: Not Found</code>.</p>
<p>Any ideas why?</p>



<a name="1160799"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1160799" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1160799">(Apr 12 2021 at 20:16)</a>:</h4>
<p><span class="user-mention" data-user-id="14849">@Ronny</span> Is there anything in <code>/var/log/zulip/errors.log</code>?</p>



<a name="1161209"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1161209" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1161209">(Apr 13 2021 at 07:22)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> </p>
<p>There was only one entry with:</p>
<p><code>2021-04-12 13:16:13.893 WARN [] Method Not Allowed (GET): /email_mirror_message</code></p>
<p>And the nginx log shows sometimes:</p>
<p><code>127.0.0.1 - - [12/Apr/2021:13:19:23 +0200] "POST /email_mirror_message HTTP/1.1" 404 169 "-" "Python-urllib/3.7"</code></p>



<a name="1161273"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1161273" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1161273">(Apr 13 2021 at 11:27)</a>:</h4>
<p><span class="user-mention" data-user-id="14849">@Ronny</span>  Hmm that's strange, what version are you on? Is there anything unusual about your deployment/configuration?</p>



<a name="1161279"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1161279" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1161279">(Apr 13 2021 at 11:58)</a>:</h4>
<p><span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> </p>
<p>Hi,</p>
<p>after your hint about deployment/configuration, i thought about the setup more closely. I found the "error". </p>
<p>I added other sites to the nginx configuration which is hosted by the server. I temporary removed this sites and all is working!<br>
So the question is. How can i route incoming emails to zulip with multiple nginx sites enabled, so that <a href="https://127.0.0.1/email_mirror_message">https://127.0.0.1/email_mirror_message</a> is processed by the zulip-nginx-configuration?</p>



<a name="1161280"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1161280" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1161280">(Apr 13 2021 at 12:02)</a>:</h4>
<p>Hmm, not sure, perhaps someone else will help but we generally don't support running other things than Zulip on the same server, exactly because it often leads to mysterious and hard to debug symptoms like this</p>



<a name="1161283"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1161283" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1161283">(Apr 13 2021 at 12:16)</a>:</h4>
<p>i know, but this are only some static files to server. So maybe we can/should add <code>default_server</code> to the nginx config to process such requests, or can we add the <code>EXTERNAL_HOST</code> to the postfix/master.cf file? </p>
<p>If i add <code>default_server</code> to the nginx config, all works well, with multipe nginx config files.</p>
<p>If if add the <code>EXTERNAL_HOST</code> with option -d to <a href="http://master.cf">master.cf</a> i get a 403 forbidden error from nginx...</p>



<a name="1161323"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1161323" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Birds <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1161323">(Apr 13 2021 at 14:35)</a>:</h4>
<p>If you want it on the same server as other services, you would be better off using the docker container with nginx as a revers proxy as well as serving your other sites. Zulip requires its own server (or container) as it could also overwrite you Nginx settings at some point with an upgrade etc.</p>



<a name="1272815"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Incoming%20email%20integration/near/1272815" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donny Winston <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Incoming.20email.20integration.html#1272815">(Oct 27 2021 at 14:25)</a>:</h4>
<p>Following up here that I wanted to self-host a zulip realm again, and this time I was able to get incoming email integration working using the <a href="https://zulip.readthedocs.io/en/latest/production/email-gateway.html#polling-setup">Polling setup</a>. My setup details here in case anyone happens to use Fastmail as their email provider:</p>
<p>(I am working with the Zulip 4.5 digital ocean droplet)</p>
<div class="codehilite"><pre><span></span><code># in /etc/zulip/settings.py
EMAIL_GATEWAY_PATTERN = &quot;zulip.incoming+%s@polyneme.xyz&quot;
EMAIL_GATEWAY_LOGIN = &quot;donny@polyneme.xyz&quot;
EMAIL_GATEWAY_IMAP_SERVER = &quot;imap.fastmail.com&quot;
EMAIL_GATEWAY_IMAP_PORT = 993
EMAIL_GATEWAY_IMAP_FOLDER = &quot;zulip-incoming&quot;
</code></pre></div>
<p>Then, in my Fastmail settings, in Account -&gt; Password &amp; Security, I created a new app password for a new third-party app to use as my <code>email_gateway_password</code> for <code>/etc/zulip/zulip-secrets.conf</code>. I then restarted the zulip server.</p>
<p>Finally, in my Fastmail settings, in Customize -&gt; Filters &amp; Rules, I created a new rule &lt;to email address, begins with, zulip.incoming&gt; to move to a new folder (zulip-incoming). I then installed the cron job as in the Polling setup instructions.</p>
<p>(I already had a  wildcard alias *@polyneme.xyz on Fastmail to deliver everything to my main email address, but this is needed to ensure that messages to <code>EMAIL_GATEWAY_PATTERN</code> are accepted.</p>
<p>Hope this is helpful to folks!</p>
<p>Thank you Zulip team for making a great system with great self-hosting documentation!</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>