<html>
<head><meta charset="utf-8"><title>✔ 5.0.rc1 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html">✔ 5.0.rc1</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1346299"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346299" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346299">(Mar 16 2022 at 18:53)</a>:</h4>
<p>We upgraded the server today like we regularly do, by downloading and installing <a href="https://www.zulip.org/dist/releases/zulip-server-latest.tar.gz">https://www.zulip.org/dist/releases/zulip-server-latest.tar.gz</a><br>
Much to our surprise, that gave us 5.0rc1. Is that expected??</p>
<p>Anyway, so we are on 5.0rc1 now, and we are seeing sudden delivery failures for some users for what I guess are notification emails sent to end users. They look like this:</p>
<div class="codehilite" data-code-language="logger"><pre><span></span><code>Error generated by Anonymous user (not logged in) on zulip deployment

Traceback (most recent call last):
  File "/home/zulip/deployments/2022-03-16-14-18-05/zerver/lib/send_email.py", line 274, in send_email
    if connection.send_messages([mail]) == 0:
  File "/home/zulip/deployments/2022-03-16-14-18-05/zulip-py3-venv/lib/python3.7/site-packages/django/core/mail/backends/smtp.py", line 109, in send_messages
    sent = self._send(message)
  File "/home/zulip/deployments/2022-03-16-14-18-05/zulip-py3-venv/lib/python3.7/site-packages/django/core/mail/backends/smtp.py", line 125, in _send
    self.connection.sendmail(from_email, recipients, message.as_bytes(linesep='\r\n'))
  File "/usr/lib/python3.7/smtplib.py", line 881, in sendmail
    raise SMTPRecipientsRefused(senderrs)
smtplib.SMTPRecipientsRefused: {'first last &lt;last@company.com&gt;': (550, b'5.1.1 &lt;last@company.com&gt;: Recipient address rejected: User unknown in virtual mailbox table')}


Deployed code:
- git: None
- ZULIP_VERSION: 5.0-rc1```
</code></pre></div>



<a name="1346300"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346300" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346300">(Mar 16 2022 at 18:54)</a>:</h4>
<p>We're certainly comfortable with folks upgrading to 5.0-rc1 at this point; we expect minimal changes between now and 5.0 final.</p>



<a name="1346301"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346301" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346301">(Mar 16 2022 at 18:55)</a>:</h4>
<p><span class="user-mention" data-user-id="16223">@mouk</span> that error message is not familiar.</p>



<a name="1346302"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346302" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346302">(Mar 16 2022 at 18:55)</a>:</h4>
<p>The error message expresses that your outgoing email server is rejecting the email -- so I'd check logs on your mail server.</p>



<a name="1346304"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346304" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346304">(Mar 16 2022 at 18:56)</a>:</h4>
<p>We do have some changes in this code path in 5.0, namely using a reusable connection to the SMTP server rather than creating a new one for each outgoing email, but I don't see a reason why that would cause an issue of that form.</p>



<a name="1346314"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346314" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346314">(Mar 16 2022 at 18:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/5.2E0.2Erc1/near/1346302">said</a>:</p>
<blockquote>
<p>The error message expresses that your outgoing email server is rejecting the email -- so I'd check logs on your mail server.</p>
</blockquote>
<p>The accounts that zulip tries to send email to, are deactivated in AD. But zulip is supposed to catch that, right..? (we have always had userAccountControl in settings.py activated)</p>



<a name="1346317"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346317" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346317">(Mar 16 2022 at 19:00)</a>:</h4>
<p>I'm a little surprised, personally, that we're pushing an rc to <code>latest</code>.  I mean, if we're not pushing it to <code>latest</code> in <a class="stream-topic" data-stream-id="31" href="/#narrow/stream/31-production-help/topic/Docker.20container.20for.205.2E0-rc1.3F">#production help &gt; Docker container for 5.0-rc1?</a>, it's not clear why we are for the tarball.</p>
<p>But I also wrote the upload tool, and IIRC it doesn't have a "don't push to latest" flag, so perhaps this is my fault. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1346318"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346318" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346318">(Mar 16 2022 at 19:01)</a>:</h4>
<p><span class="user-mention" data-user-id="16223">@mouk</span>: Are they deactivated in Zulip?</p>



<a name="1346320"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346320" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346320">(Mar 16 2022 at 19:01)</a>:</h4>
<p>We did have some change in the codepath that controls what users get sent email, so that's where I'd suspect the culprit</p>



<a name="1346324"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346324" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346324">(Mar 16 2022 at 19:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/5.2E0.2Erc1/near/1346318">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="16223">mouk</span>: Are they deactivated in Zulip?</p>
</blockquote>
<p>I manually deactivated them after discovering the delivery failures. so they were NOT automatically deactivated, no. Not sure when these accounts were deactivated in AD, and how often zulip checks for deactivated AD accounts.</p>



<a name="1346366"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346366" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346366">(Mar 16 2022 at 19:28)</a>:</h4>
<p><span class="user-mention" data-user-id="16223">@mouk</span> is it possible you haven't configured <a href="https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#automatically-deactivating-users">https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#automatically-deactivating-users</a>?</p>



<a name="1346373"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346373" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346373">(Mar 16 2022 at 19:29)</a>:</h4>
<p>On the question of whether <code>latest</code> should have <code>5.0-rc1</code>, I'm not sure what the best policy should be. I'm more hesitant to do it with Docker, since that doesn't have as good testing in CI. It's probably simplest to remove it from the <code>latest</code> tag to give time to discuss the policy question.</p>



<a name="1346375"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346375" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346375">(Mar 16 2022 at 19:31)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> "userAccountControl": "userAccountControl" is activated. That should in theory be enough, as I understand it.</p>



<a name="1346379"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346379" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346379">(Mar 16 2022 at 19:34)</a>:</h4>
<p>Can you try running <code>manage.py sync_ldap_user_data</code> to see if that deactivates the user?</p>



<a name="1346391"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346391" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346391">(Mar 16 2022 at 19:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/5.2E0.2Erc1/near/1346379">said</a>:</p>
<blockquote>
<p>Can you try running <code>manage.py sync_ldap_user_data</code> to see if that deactivates the user?</p>
</blockquote>
<p>Running it now. We have approx 150 users, and it seem to take a very long time. It processed ("[zulip.sync_ldap_user_data] Updated <a href="mailto:userX@domain.com">userX@domain.com</a>") one users already, after running almost ten minutes. I will report here when there is more to report. (there is almost no cpu usage, network is fast, DCs are on the LAN, and the network is not overloaded)</p>



<a name="1346404"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346404" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346404">(Mar 16 2022 at 19:58)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  Update. My ldap server was set to REALM <a href="http://ad.domain.com">ad.domain.com</a>, and at the same time one AD DC was not reachable from the zulip server. After specifying one specific DC, sync_ldap_user_data runs fast now. Sorry about that. But the users are still activated.<br>
Should manually deactivated/activated users become deactivated again after running manage.py sync_ldap_user_data, or does a manual activation override the manage.py status flip?</p>



<a name="1346405"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346405" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346405">(Mar 16 2022 at 19:59)</a>:</h4>
<p>I believe that setting considers the LDAP database to be the source of truth, so it will reactivate anyone who has been deactivated only on the Zulip side (etc.) -- it's designed for a setting where you want to just manage which users exist in LDAP.</p>



<a name="1346407"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346407" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346407">(Mar 16 2022 at 20:03)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  Yes, good. That is also what I would expect. What I noticed: many users are processed (output to screen) by manage.py sync_ldap_user_data, but the AD deactivated users are NOT processed. (displayed to the screen) So they are skipped...</p>



<a name="1346478"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346478" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346478">(Mar 16 2022 at 20:55)</a>:</h4>
<p><span class="user-mention" data-user-id="16223">@mouk</span> I think you'll need to look at the actual LDAP query output to debug further. It seems possible that the specific mechanism you're using to deactivate users in AD makes deactivated users invisible to Zulip, rather than visible but with the deactivated flag.</p>



<a name="1346479"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346479" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346479">(Mar 16 2022 at 20:56)</a>:</h4>
<p>If that's the case, you should enable <code>LDAP_DEACTIVATE_NON_MATCHING_USERS</code>.</p>



<a name="1346481"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346481" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346481">(Mar 16 2022 at 20:57)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  I will check, but strange that this started since we upgraded to 5.0rc1.</p>



<a name="1346831"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346831" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346831">(Mar 17 2022 at 12:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/5.2E0.2Erc1/near/1346479">said</a>:</p>
<blockquote>
<p>If that's the case, you should enable <code>LDAP_DEACTIVATE_NON_MATCHING_USERS</code>.</p>
</blockquote>
<p>After trying that, we discovered that that setting disables <em>all</em> non-matching LDAP users, including external (manually invited) users. :-( Not what we need. ;-)</p>



<a name="1346832"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1346832" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1346832">(Mar 17 2022 at 12:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/5.2E0.2Erc1/near/1346478">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="16223">mouk</span> I think you'll need to look at the actual LDAP query output to debug further. It seems possible that the specific mechanism you're using to deactivate users in AD makes deactivated users invisible to Zulip, rather than visible but with the deactivated flag.</p>
</blockquote>
<p>The mechanism we use, is the regular AD checkbox to disable a user. It works everywhere, not sure why it doesn't work here and now. We're using samba AD (not microsoft AD). Anyway, if it's just me complaining, then it must be something specific on our end.<br>
Thanks for having had your attention! It's appreciated!</p>



<a name="1347101"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1347101" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1347101">(Mar 17 2022 at 19:58)</a>:</h4>
<p><span class="user-mention" data-user-id="16223">@mouk</span> yeah, I could have spelled this out more clearly, but Zulip's LDAP integration is conceptually stateless, which is convenient in many settings, but also means it cannot distinguish between a user who used to be visible to it via LDAP but no longer is and one who was never in LDAP.</p>



<a name="1347627"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1347627" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mouk <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1347627">(Mar 18 2022 at 07:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/5.2E0.2Erc1/near/1347101">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="16223">mouk</span> yeah, I could have spelled this out more clearly, but Zulip's LDAP integration is conceptually stateless, which is convenient in many settings, but also means it cannot distinguish between a user who used to be visible to it via LDAP but no longer is and one who was never in LDAP.</p>
</blockquote>
<p>Yep. Now we know that too :-) It just confused us, as the setting name has LDAP in it, so we thought it was for LDAP only. Anyway, no problem! :-)</p>



<a name="1347628"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%205.0.rc1/near/1347628" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.205.2E0.2Erc1.html#1347628">(Mar 18 2022 at 07:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="16223">mouk</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>