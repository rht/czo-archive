<html>
<head><meta charset="utf-8"><title>TornadoQueueClient lost connection to RabbitMQ · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html">TornadoQueueClient lost connection to RabbitMQ</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1486782"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/TornadoQueueClient%20lost%20connection%20to%20RabbitMQ/near/1486782" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vanessa Teague <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html#1486782">(Jan 07 2023 at 00:18)</a>:</h4>
<p>Hi, I upgraded to 6.0 on Ubuntu 20.04 recently. (I accidentally killed the update part way through, which may be contributing to the problem.)</p>
<p>The instance runs but is unstable - I get the error "TornadoQueueClient lost connection to RabbitMQ", which I see several other people have got but I don't see a good solution to. (Apologies if I've missed it - links welcome.)</p>
<p>Any help would be gratefully received. My logs are here:</p>
<p>2023-01-03 18:56:07.090 WARN [zulip.queue:9800] TornadoQueueClient lost connection to RabbitMQ, reconnecting in 2 secs...<br>
2023-01-03 18:56:09.170 WARN [zulip.queue:9800] TornadoQueueClient attempting to reconnect to RabbitMQ<br>
2023-01-03 19:59:01.015 WARN [zulip.queue:9800] TornadoQueueClient lost connection to RabbitMQ, reconnecting in 2 secs...<br>
2023-01-03 20:05:18.851 WARN [zulip.queue:9800] TornadoQueueClient attempting to reconnect to RabbitMQ<br>
2023-01-03 21:06:28.499 ERR  [pika.adapters.utils.connection_workflow:9800] AMQPConnector - reporting failure: AMQPConnectorSocketConnectError: timeout("TCP connection attempt timed out: '127.0.0.1'/(&lt;AddressFamily.AF_INET: 2&gt;, &lt;SocketKind.SOCK_STREAM: 1&gt;, 6, '', ('127.0.0.1', 5672))")<br>
2023-01-03 21:26:57.617 ERR  [pika.adapters.utils.connection_workflow:9800] AMQP connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - AMQPConnectorSocketConnectError: timeout("TCP connection attempt timed out: '127.0.0.1'/(&lt;AddressFamily.AF_INET: 2&gt;, &lt;SocketKind.SOCK_STREAM: 1&gt;, 6, '', ('127.0.0.1', 5672))"); first exception - None.<br>
2023-01-03 21:55:50.445 ERR  [pika.adapters.utils.connection_workflow:9800] AMQPConnectionWorkflow - reporting failure: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - AMQPConnectorSocketConnectError: timeout("TCP connection attempt timed out: '127.0.0.1'/(&lt;AddressFamily.AF_INET: 2&gt;, &lt;SocketKind.SOCK_STREAM: 1&gt;, 6, '', ('127.0.0.1', 5672))"); first exception - None<br>
2023-01-03 21:55:50.445 ERR  [pika.adapters.base_connection:9800] Full-stack connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - AMQPConnectorSocketConnectError: timeout("TCP connection attempt timed out: '127.0.0.1'/(&lt;AddressFamily.AF_INET: 2&gt;, &lt;SocketKind.SOCK_STREAM: 1&gt;, 6, '', ('127.0.0.1', 5672))"); first exception - None<br>
2023-01-03 21:55:50.445 ERR  [pika.adapters.base_connection:9800] Self-initiated stack bring-up failed: AMQPConnectionError: (AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - AMQPConnectorSocketConnectError: timeout("TCP connection attempt timed out: '127.0.0.1'/(&lt;AddressFamily.AF_INET: 2&gt;, &lt;SocketKind.SOCK_STREAM: 1&gt;, 6, '', ('127.0.0.1', 5672))"); first exception - None,)<br>
2023-01-03 21:55:50.446 WARN [zulip.queue:9800] TornadoQueueClient couldn't connect to RabbitMQ, retrying in 2 secs...<br>
2023-01-03 21:55:52.448 WARN [zulip.queue:9800] TornadoQueueClient attempting to reconnect to RabbitMQ<br>
2023-01-03 22:00:03.814 WARN [zulip.queue:9800] TornadoQueueClient lost connection to RabbitMQ, reconnecting in 2 secs...<br>
2023-01-03 22:11:09.527 WARN [zulip.queue:9800] TornadoQueueClient attempting to reconnect to RabbitMQ<br>
2023-01-03 23:14:56.990 WARN [zerver.lib.push_notifications] Mobile push notifications are not configured.<br>
  See <a href="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html">https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html</a><br>
2023-01-05 20:35:18.806 WARN [zulip.queue:9800] TornadoQueueClient lost connection to RabbitMQ, reconnecting in 2 secs...<br>
2023-01-05 20:35:19.825 ERR  [pika.connection:9800] Illegal close(200, 'Normal shutdown') request on &lt;ExceptionFreeTornadoConnection CLOSED transport=None params=&lt;ConnectionParameters host=127.0.0.1 port=5672 virtual_host=/ ssl=False&gt;&gt; because it was called while connection state=CLOSED.<br>
2023-01-05 20:36:55.713 WARN [zerver.lib.push_notifications] Mobile push notifications are not configured.<br>
  See <a href="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html">https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html</a><br>
2023-01-05 20:40:05.877 WARN [zulip.queue:9800] TornadoQueueClient lost connection to RabbitMQ, reconnecting in 2 secs...<br>
2023-01-05 20:40:06.901 ERR  [pika.connection:9800] Illegal close(200, 'Normal shutdown') request on &lt;ExceptionFreeTornadoConnection CLOSED transport=None params=&lt;ConnectionParameters host=127.0.0.1 port=5672 virtual_host=/ ssl=False&gt;&gt; because it was called while connection state=CLOSED.<br>
2023-01-05 20:41:49.065 WARN [zerver.lib.push_notifications] Mobile push notifications are not configured.<br>
  See <a href="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html">https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html</a><br>
2023-01-06 18:32:43.740 WARN [zulip.queue:9800] TornadoQueueClient lost connection to RabbitMQ, reconnecting in 2 secs...<br>
2023-01-06 18:32:45.822 WARN [zulip.queue:9800] TornadoQueueClient attempting to reconnect to RabbitMQ<br>
2023-01-07 00:04:22.047 WARN [zerver.lib.push_notifications] Mobile push notifications are not configured.<br>
  See <a href="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html">https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html</a></p>



<a name="1486813"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/TornadoQueueClient%20lost%20connection%20to%20RabbitMQ/near/1486813" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html#1486813">(Jan 07 2023 at 00:42)</a>:</h4>
<p>I'd check the rabbitmq logs - it looks like something there is unhappy and shutting it down.</p>



<a name="1486815"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/TornadoQueueClient%20lost%20connection%20to%20RabbitMQ/near/1486815" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html#1486815">(Jan 07 2023 at 00:43)</a>:</h4>
<p>Did you kill the update by hard shutting down the machine, by chance?  Folks have seen rabbitmq in bad states due to its queues getting corrupted.</p>



<a name="1486853"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/TornadoQueueClient%20lost%20connection%20to%20RabbitMQ/near/1486853" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vanessa Teague <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html#1486853">(Jan 07 2023 at 01:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ/near/1486815">said</a>:</p>
<blockquote>
<p>Did you kill the update by hard shutting down the machine, by chance?  Folks have seen rabbitmq in bad states due to its queues getting corrupted.</p>
</blockquote>
<p>Yes I did (by accident obviously).</p>



<a name="1486857"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/TornadoQueueClient%20lost%20connection%20to%20RabbitMQ/near/1486857" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html#1486857">(Jan 07 2023 at 01:12)</a>:</h4>
<p><span class="user-mention" data-user-id="25580">@Vanessa Teague</span>: Check <a class="stream-topic" data-stream-id="31" href="/#narrow/stream/31-production-help/topic/.E2.9C.94.20rabbitmq.20database.20corruption">#production help &gt; ✔ rabbitmq database corruption</a> for some things to check and do</p>



<a name="1486858"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/TornadoQueueClient%20lost%20connection%20to%20RabbitMQ/near/1486858" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html#1486858">(Jan 07 2023 at 01:13)</a>:</h4>
<p><code>/var/log/rabbitmq/startup_log</code> and the last page of <code>/var/log/rabbitmq/zulip@localhost.log</code> may have useful insight, but I suspect, like that user, you'll need to drop the rabbitmq database.  It corrupts itself easily when uncleanly shut down. <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="1486859"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/TornadoQueueClient%20lost%20connection%20to%20RabbitMQ/near/1486859" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html#1486859">(Jan 07 2023 at 01:14)</a>:</h4>
<p>Luckily, as noted there, this doesn't cause any data loss except processes that were pending in offline work queues (e.g. sending emails or push notifications).  All of the real data is safe in Postgres, which is significantly hardier.</p>



<a name="1486863"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/TornadoQueueClient%20lost%20connection%20to%20RabbitMQ/near/1486863" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html#1486863">(Jan 07 2023 at 01:15)</a>:</h4>
<p>Dropping the rabbitmq queues and re-creating them should be:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>sudo<span class="w"> </span>-u<span class="w"> </span>zulip<span class="w"> </span>~zulip/deployments/current/scripts/stop-server
service<span class="w"> </span>rabbitmq-server<span class="w"> </span>stop
rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/rabbitmq/mnesia/
service<span class="w"> </span>rabbitmq-server<span class="w"> </span>start
~zulip/deployments/current/scripts/setup/configure-rabbitmq
sudo<span class="w"> </span>-u<span class="w"> </span>zulip<span class="w"> </span>~zulip/deployments/current/scripts/start-server
</code></pre></div>



<a name="1486865"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/TornadoQueueClient%20lost%20connection%20to%20RabbitMQ/near/1486865" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vanessa Teague <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/TornadoQueueClient.20lost.20connection.20to.20RabbitMQ.html#1486865">(Jan 07 2023 at 01:19)</a>:</h4>
<p>Terrific, thankyou for your help.  I've run those commands and it seems to be good (so far...)</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>