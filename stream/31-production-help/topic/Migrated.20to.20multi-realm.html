<html>
<head><meta charset="utf-8"><title>Migrated to multi-realm · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html">Migrated to multi-realm</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1384493"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384493" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384493">(May 25 2022 at 16:00)</a>:</h4>
<p>I'm doing a prep to migrate an existing realm to a multi-realm on a different server and want to avoid gotchas. <br>
The specific example is migrating from <a href="http://seachat.semesteratsea.net">seachat.semesteratsea.net</a> to <a href="http://sp22.seachat.semesteratsea.org">sp22.seachat.semesteratsea.org</a> (the .net to .org AND adding the sp22 identifier in front.) Will being doing something similiar in a few months (once a semester) to create a multi-realm <a href="http://VoyageID.seachat.semesteratsea.org">VoyageID.seachat.semesteratsea.org</a> for our alumni communities. <br>
The other aspect that would change in this is enabling email authentication vs ldap once migrated. <br>
I'd like to preserve the streams public and private, as well as DM's for community members. <br>
I have images of the existing server and it currently has very low activity.  So I can take it offline, do reversions etc... <br>
We own wildcard certs for both domains.</p>
<p>Anyone see any gotchas/concerns?</p>



<a name="1384738"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384738" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384738">(May 26 2022 at 12:54)</a>:</h4>
<p>Sounds good to me I think. Will you be using our export/import system for moving the realm to the new server?</p>



<a name="1384752"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384752" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384752">(May 26 2022 at 15:18)</a>:</h4>
<p>That is what I was going to attempt first. <br>
This is the section of the docs I'm looking at: <a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html#data-export">https://zulip.readthedocs.io/en/latest/production/export-and-import.html#data-export</a><br>
The things I'm slightly unsure of, are the changing authentication method causing issues, the new realm being correct and keeping all the messages with the correct users.  I'll use the training wheels and give it a try here soon.</p>



<a name="1384757"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384757" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384757">(May 26 2022 at 15:58)</a>:</h4>
<p>You can test your intended authentication method  by setting up a test organization on the new server first and verifying that it works</p>



<a name="1384758"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384758" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384758">(May 26 2022 at 15:59)</a>:</h4>
<p>Actually, you can do a test run of importing as well - by making an initial export of the realm and trying to import it into the new server. And if that works well, then you can re-do it when doing the final switchover to the new server</p>



<a name="1384759"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384759" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384759">(May 26 2022 at 16:00)</a>:</h4>
<p>I think the most important thing to note for export/import is for both servers to be on the same version of Zulip, so that the data format of the export file is compatible</p>



<a name="1384761"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384761" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384761">(May 26 2022 at 16:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/Migrated.20to.20multi-realm/near/1384757">said</a>:</p>
<blockquote>
<p>You can test your intended authentication method  by setting up a test organization on the new server first and verifying that it works</p>
</blockquote>
<p>I know that email works, and ldap works, all the users have a valid email, however until this point a majority of the users login with a first.lastname vs an email address. If I turn off Ldap will those users with first.last now be able to login using their email field or how will that convert?</p>



<a name="1384783"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384783" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384783">(May 26 2022 at 16:32)</a>:</h4>
<p><span class="user-mention" data-user-id="18622">@Tyson Parker</span>  They'll be able to login using any auth method you have set up that authenticates them for the email address of their Zulip account. So e.g. yes, they can login with email+password - BUT on the condition that they actually have a password set for their account. I'm mentioning that, because if they've been logging in via ldap, then they may never have gotten their Zulip password set.</p>
<p>Or is this question for the new server, post-import? Because directly after importing users do <strong>not</strong> have passwords set - per <a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html#logging-in">https://zulip.readthedocs.io/en/latest/production/export-and-import.html#logging-in</a>, we don't export passwords. And as mentioned there, they can auth via a different method if enabled, or using password reset.</p>



<a name="1384785"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384785" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384785">(May 26 2022 at 16:48)</a>:</h4>
<p>I would expect that the email auth would be the only method on the new server.  <br>
In that case what user name would they use, the email address or the original user name?  (They'd be sent a pw reset email.</p>



<a name="1384790"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1384790" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1384790">(May 26 2022 at 17:27)</a>:</h4>
<p>Oh, in that case they should use email address. Zulip doesn't record the ldap username anywhere. When you use ldap, the username and password get sent to the ldap server - if successfully authenticated, Zulip just grabs the email address from ldap for its own purposes.</p>



<a name="1385048"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1385048" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1385048">(May 26 2022 at 21:31)</a>:</h4>
<p>Ok so once LDAP is turned off it should allow them to setup their pw with Email using the existing email field that is there from ldaps pull.  At which point they can update their own email if they choose and continue on access things from that point forward.</p>



<a name="1385115"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1385115" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1385115">(May 26 2022 at 22:36)</a>:</h4>
<p>I'm not sure the import/export tool should be required for this migration. One can use, for example, <code>./manage.py change_realm_subdomain</code>, to configure a realm to run on a subdomain.</p>



<a name="1385119"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1385119" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1385119">(May 26 2022 at 22:37)</a>:</h4>
<p><span class="user-mention" data-user-id="18622">@Tyson Parker</span> have you considered that approach? In theory, you should be able to just setup DNS for the new configuration, do the migration step noted above, and avoid the import/export step. (The import/export is mainly required if you're changing hardware, which maybe you are, though even there you could probably use <code>manage.py backup</code> this first time).</p>



<a name="1385133"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1385133" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1385133">(May 26 2022 at 22:45)</a>:</h4>
<p>I think the intent is to move it to a server which isn't on a boat, hence the export / import.</p>



<a name="1385153"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1385153" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1385153">(May 26 2022 at 22:59)</a>:</h4>
<p>Yeah, that makes sense <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1385479"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1385479" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1385479">(May 27 2022 at 14:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="18622">Tyson Parker</span> <a href="#narrow/stream/31-production-help/topic/Migrated.20to.20multi-realm/near/1385048">said</a>:</p>
<blockquote>
<p>Ok so once LDAP is turned off it should allow them to setup their pw with Email using the existing email field that is there from ldaps pull.  At which point they can update their own email if they choose and continue on access things from that point forward.</p>
</blockquote>
<p><span class="user-mention" data-user-id="18622">@Tyson Parker</span> Yeah, sounds right to me - you just want to make sure the email auth backend is enabled, and that the server is able to successfully send emails (to send the password reset links + the email change confirmation links, if any users elect to change their email address)</p>



<a name="1385480"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1385480" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1385480">(May 27 2022 at 14:22)</a>:</h4>
<p>This is the first run at this and it would become a process going forward.<br>
Basically end of a semester i'd move the contents of zulip from the domain <a href="http://seachat.semesteratsea.net">seachat.semesteratsea.net</a> to the shore based server that has the previous semesters cohorts messages. Resulting in a shore server with a realm for each semester like spring 2022, fall 2022, spring 2023 etc... in a format like sp22.semesteratsea.ORG (org for shore domains).  After the move is complete, I'd clear the cohort from the ship server and start fresh for the new semester. (All new staff/students each semester).<br>
From what I am reading it sounds feasible, I'm just wanting to make sure I don't miss a step before I run through it. Thanks for the feedback and clarifications yall!</p>



<a name="1387687"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1387687" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1387687">(Jun 02 2022 at 20:06)</a>:</h4>
<p>Ok I ran into an issue, unsure what I did incorrectly here. <br>
I got both of my instances to 6.0-dev-527-g3741c1c034<br>
on seachat.semesteratsea.NET I did an export via<br>
./manage.py export -r ''<br>
Moved that 8 GB file over to the new server running <a href="http://seachat.semesteratsea.org">seachat.semesteratsea.org</a> (Which was a new install and I had logged into Zulip fine with)<br>
Ran this set of commands with the goal of it importing into a new sub domain <a href="http://sp22.seachat.semesteratsea.org">sp22.seachat.semesteratsea.org</a><br>
cd ~<br>
tar -xf /tmp/zulip-export-no39frx7.tar.gz<br>
cd /home/zulip/deployments/current<br>
./manage.py import sp22 ~/zulip-export-no39frx7<br>
It ran for awhile then had a bunch of postgress errors.<br>
Tail of the screen log<br>
<a href="/user_uploads/2/69/lMPKy4u0uVdr6y3MR4VzLvK0/importfail1.txt">importfail1.txt</a></p>



<a name="1387694"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1387694" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1387694">(Jun 02 2022 at 20:17)</a>:</h4>
<p>May have answered my own question: Console had a out of memory and postgres was killed error. So I've bumped the server from 2 CPU 8 GB ram to 4 CPU 16 GB ram. <br>
I'm still unsure though if I need to do a step to create the subrealm first or does the import create it as well?</p>



<a name="1387696"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1387696" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1387696">(Jun 02 2022 at 20:19)</a>:</h4>
<p>Forgot to tag <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span>  if you have a few minutes to check my order of operations</p>



<a name="1387702"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1387702" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1387702">(Jun 02 2022 at 20:30)</a>:</h4>
<p>The import will make the realm.</p>



<a name="1388135"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1388135" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1388135">(Jun 03 2022 at 17:15)</a>:</h4>
<p>Next interesting issue, I didn't realize that I couldn't use my existing wildcard due to <em>.</em>.domain.com not being supported without buying or issuing another cert that is *.subdomain.domain.com. <br>
Thinking I can install certbot on the reverse proxy for this particular site?</p>



<a name="1390257"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Migrated%20to%20multi-realm/near/1390257" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tyson Parker <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Migrated.20to.20multi-realm.html#1390257">(Jun 08 2022 at 16:16)</a>:</h4>
<p>Was able to get certbot running on the web proxy. Looks like this part is complete.<br>
Next issue was that the old server used email/ldap authentication.  The export json file contains the valid emails, however if exported with ldap enabled the import would replace the email fields with a zulip created email like user&lt;id&gt;@&lt;zulipserver&gt; email. This fix that seams to a have worked is PRIOR to exporting from the old server, disable ldap in the manage organization interface. Then export. Now the import carried over the valid emails into the new subdomain allowing all the users to perform a password reset without having to fix all the users email address. </p>
<p>Hope this helps should anyone else try this.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>