<html>
<head><meta charset="utf-8"><title>backup · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html">backup</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="678506"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/678506" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kyrogue <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#678506">(Jan 04 2019 at 04:56)</a>:</h4>
<p>looking at the backup documentation</p>



<a name="678507"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/678507" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kyrogue <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#678507">(Jan 04 2019 at 04:56)</a>:</h4>
<div class="codehilite"><pre><span></span>Install new server as normal by downloading a Zulip release tarball and then using scripts/setup/install, you don’t need to run the initialize-database second stage which puts default data into the database.
</pre></div>


<p>i dont see a flag to specify intialize-database when runing the install script</p>



<a name="678508"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/678508" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kyrogue <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#678508">(Jan 04 2019 at 04:58)</a>:</h4>
<p>from the page <a href="https://zulip.readthedocs.io/en/latest/production/install.html#step-2-install-zulip" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/install.html#step-2-install-zulip">https://zulip.readthedocs.io/en/latest/production/install.html#step-2-install-zulip</a></p>



<a name="678643"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/678643" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#678643">(Jan 04 2019 at 16:12)</a>:</h4>
<p>Hmm, yeah I think we may have merged that step into the installer</p>



<a name="678645"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/678645" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#678645">(Jan 04 2019 at 16:12)</a>:</h4>
<p>On my phone but I can look in a bit.  Plan was to script this more fully anyway.</p>



<a name="679283"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/679283" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kyrogue <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#679283">(Jan 07 2019 at 04:06)</a>:</h4>
<p>yea so i've tried restoring, running scripts/setup/postgres-init-db</p>



<a name="679284"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/679284" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kyrogue <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#679284">(Jan 07 2019 at 04:06)</a>:</h4>
<p>drops zulip database, but now there is no instructions on what is needed to recreate the zulip database schema</p>



<a name="679285"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/679285" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kyrogue <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#679285">(Jan 07 2019 at 04:07)</a>:</h4>
<p>so that psql &lt; backup.sql can import back the data</p>



<a name="679298"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/679298" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#679298">(Jan 07 2019 at 04:46)</a>:</h4>
<p>I believe if you created a database dump with <code>pg_dump</code>, the database dump will have the schema creation logic.</p>



<a name="679302"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/679302" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#679302">(Jan 07 2019 at 06:15)</a>:</h4>
<p><span class="user-mention" data-user-id="9364">@kyrogue</span> check out <a href="https://github.com/zulip/zulip/pull/11204" target="_blank" title="https://github.com/zulip/zulip/pull/11204">https://github.com/zulip/zulip/pull/11204</a> -- I decided rather than helping you through this manually to work on scripting the backup process for everyone in our next release.</p>



<a name="679798"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/679798" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kyrogue <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#679798">(Jan 08 2019 at 04:38)</a>:</h4>
<p>this is what i have done</p>
<div class="codehilite"><pre><span></span><span class="nv">backup_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">/</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="nv">ZULIP_CONFIG_DIR</span><span class="o">=</span>/etc/zulip/
<span class="nv">ZULIP_DATABASE</span><span class="o">=</span>zulip
<span class="nv">ZULIP_LOCAL_UPLOADS_DIR</span><span class="o">=</span>/home/zulip/uploads/
<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -lt <span class="m">3</span> <span class="o">]</span>
<span class="k">then</span>
  usage
  <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$1</span>/<span class="nv">$2</span> <span class="o">]]</span>
<span class="k">then</span>
  mkdir -p <span class="nv">$1</span>/<span class="nv">$2</span>
<span class="k">fi</span>

<span class="k">function</span> backup_psql <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;performing pg_dump of </span><span class="nv">$ZULIP_DATABASE</span><span class="s2">&quot;</span>
  <span class="k">if</span> ! pg_dump <span class="nv">$ZULIP_DATABASE</span> &gt; <span class="nv">$backup_dir</span>/<span class="k">$(</span>date +%Y-%m-%d<span class="k">)</span>-daily.sql<span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Error: Failed to perform pg_dump of </span><span class="nv">$ZULIP_DATABASE</span><span class="s2">&quot;</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span>
    <span class="nb">exit</span> <span class="m">1</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function</span> backup_user_uploaded_files <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> -d <span class="nv">$ZULIP_LOCAL_UPLOADS_DIR</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;performing backup of </span><span class="nv">$ZULIP_LOCAL_UPLOADS_DIR</span><span class="s2">&quot;</span>
    <span class="nb">pushd</span> <span class="nv">$ZULIP_LOCAL_UPLOADS_DIR</span>
    <span class="k">if</span> ! tar -zcvf <span class="nv">$backup_dir</span>/<span class="k">$(</span>date +%Y-%m-%d<span class="k">)</span>-uploads-daily.tar.gz *<span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;Error: Failed to backup </span><span class="nv">$ZULIP_LOCAL_UPLOADS_DIR</span><span class="s2">&quot;</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span>
      <span class="nb">popd</span>
      <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="nb">popd</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function</span> backup_zulip_config_and_secrets <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> -d <span class="nv">$ZULIP_CONFIG_DIR</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;performing backup of </span><span class="nv">$ZULIP_CONFIG_DIR</span><span class="s2">&quot;</span>
    <span class="nb">pushd</span> <span class="nv">$ZULIP_CONFIG_DIR</span>
    <span class="k">if</span> ! tar -zcvf <span class="nv">$backup_dir</span>/<span class="k">$(</span>date +%Y-%m-%d<span class="k">)</span>-configs-daily.tar.gz *<span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;Error: Failed to backup </span><span class="nv">$ZULIP_CONFIG_DIR</span><span class="s2">&quot;</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span>
      <span class="nb">popd</span>
      <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="nb">popd</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1">#Delete backups older than defined</span>
find <span class="nv">$backup_dir</span> -maxdepth <span class="m">1</span> -mtime +<span class="nv">$3</span> -name <span class="s2">&quot;*-daily.*&quot;</span> -exec rm <span class="s1">&#39;{}&#39;</span> <span class="s1">&#39;;&#39;</span>

backup_psql
backup_user_uploaded_files
backup_zulip_config_and_secrets
</pre></div>



<a name="679799"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/679799" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kyrogue <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#679799">(Jan 08 2019 at 04:39)</a>:</h4>
<p>very simple, just backup the three mentioned directories, as a crontab entry daily</p>



<a name="680106"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/680106" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#680106">(Jan 08 2019 at 21:37)</a>:</h4>
<p>Yeah, that should work fine.  The main difference with the implementation I wrote is that your SQL archives aren't compressed</p>



<a name="680213"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/680213" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kyrogue <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#680213">(Jan 09 2019 at 01:15)</a>:</h4>
<p>ah right</p>



<a name="1394311"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/1394311" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Azure IT Support <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#1394311">(Jun 21 2022 at 07:08)</a>:</h4>
<p>hii, when i taking backup of zulip server than error is coming :su zulip -c '/home/zulip/deployments/current/manage.py backup'</p>



<a name="1394312"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/1394312" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Azure IT Support <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#1394312">(Jun 21 2022 at 07:08)</a>:</h4>
<p>error is coming : su: Authentication failure</p>



<a name="1394413"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/1394413" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#1394413">(Jun 21 2022 at 17:45)</a>:</h4>
<p>That means the user you're running that as doesn't have permissions to become the <code>zulip</code> user.  You need to run that command as root.</p>



<a name="1394415"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/backup/near/1394415" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/backup.html#1394415">(Jun 21 2022 at 17:46)</a>:</h4>
<p>Please also use <a href="https://zulip.com/help/code-blocks">code blocks</a> to show commands and errors, like:</p>
<div class="codehilite"><pre><span></span><code>I&#39;m getting this error when trying to take a backup:
```
su zulip -c &#39;/home/zulip/deployments/current/manage.py backup&#39;
su: Authentication failure
```
</code></pre></div>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>