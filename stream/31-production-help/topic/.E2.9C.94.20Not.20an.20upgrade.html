<html>
<head><meta charset="utf-8"><title>✔ Not an upgrade · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html">✔ Not an upgrade</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1356737"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356737" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356737">(Mar 31 2022 at 01:26)</a>:</h4>
<p>Could someone take a look at <a href="https://github.com/zulip/zulip/issues/21596">https://github.com/zulip/zulip/issues/21596</a> ?</p>



<a name="1356738"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356738" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356738">(Mar 31 2022 at 01:26)</a>:</h4>
<p>Looking!</p>
<p>And sorry for your login troubles -- we're working on that fix right now.</p>



<a name="1356739"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356739" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356739">(Mar 31 2022 at 01:27)</a>:</h4>
<p>Thanks!</p>



<a name="1356744"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356744" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356744">(Mar 31 2022 at 01:31)</a>:</h4>
<p>In the short term, you can pass <code>--skip-downgrade-check</code> to the upgrade</p>



<a name="1356745"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356745" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356745">(Mar 31 2022 at 01:32)</a>:</h4>
<p>But I think we need to drop the migrations in that squash, since <a href="https://github.com/zulip/zulip/commit/a21f2d771553d58a60dbfbbcb897b8e7e5f30ce3">a21f2d771553d58a60dbfbbcb897b8e7e5f30ce3</a> dropped the "replaces" on the migration</p>



<a name="1356746"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356746" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356746">(Mar 31 2022 at 01:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrade.20to.205.2E0.20fails/near/1356744">said</a>:</p>
<blockquote>
<p>In the short term, you can pass <code>--skip-downgrade-check</code> to the upgrade</p>
</blockquote>
<p>I think so too.<br>
But I keep the current situation because Zulip developers may want to try confirming their fix on my deploy. :-)<br>
If Zulip developers don't need to confirm their fix on my deploy, I'll use <code>--skip-downgrade-check</code>.</p>



<a name="1356756"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356756" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356756">(Mar 31 2022 at 01:48)</a>:</h4>
<p>This is the only one which is unexplained by the squashmigrations:</p>
<div class="codehilite"><pre><span></span><code>Migration (&#39;default&#39;, &#39;0005_auto_20160727_2333&#39;) missing in new version.
</code></pre></div>
<p>Which is confusing because AFAICT no migration named that is in the repo.  But there <em>is</em> a reference to that migration in <a href="https://github.com/zulip/zulip/commit/c493a0f02a271fd66280084cddfa9308351d9bc7">c493a0f02a271fd66280084cddfa9308351d9bc7</a>, in terms of allowing it in as a historical exception in "auto" migrations.  But the tree at that point <em>doesn't have</em> that migration.</p>



<a name="1356757"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356757" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356757">(Mar 31 2022 at 01:51)</a>:</h4>
<p>Ah, that's from social-app-django?</p>



<a name="1356762"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356762" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356762">(Mar 31 2022 at 01:54)</a>:</h4>
<p><a href="https://github.com/python-social-auth/social-app-django/pull/25">https://github.com/python-social-auth/social-app-django/pull/25</a> alleges that <code>('default', '0005_auto_20160727_2333')</code> never existed, which is evidently incorrect.</p>



<a name="1356767"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1356767" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1356767">(Mar 31 2022 at 01:57)</a>:</h4>
<p>For the <code>zerver</code> ones, I think we want to put that <code>replaces</code> back: <a href="https://github.com/zulip/zulip/pull/21622">#21622</a>.</p>



<a name="1357444"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1357444" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1357444">(Mar 31 2022 at 19:02)</a>:</h4>
<p>It appears <a href="https://github.com/zulip/zulip/pull/21622">#21622</a> is failing CI; we should figure out what's up since it'd be nice to have this fixed in 5.1.</p>



<a name="1357720"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1357720" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GervaisdeM <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1357720">(Mar 31 2022 at 23:34)</a>:</h4>
<p>Can't upgrade from 4.11 to 5.0. It fails whether I try the git method or the tarball</p>
<div class="codehilite"><pre><span></span><code>+ ln -nsf /srv/zulip-venv-cache/726c7d1d35d9cd61bb4b70e98167a1db7b0c524d/zulip-py3-venv /home/zulip/deployments/2022-03-31-20-24-15/zulip-py3-venv
Migration (&#39;zerver&#39;, &#39;0028_userprofile_tos_version&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0027_realm_default_language&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0007_userprofile_is_bot_active_indexes&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0026_delete_mituser&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0019_preregistrationuser_realm_creation&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0024_realm_allow_message_editing&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0008_preregistrationuser_upper_email_idx&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0025_realm_message_content_edit_limit&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0015_attachment&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0016_realm_create_stream_by_admins_only&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0017_userprofile_bot_type&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0011_remove_guardian&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0018_realm_emoji_message&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0020_add_tracking_attachment&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0021_migrate_attachment_data&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0004_userprofile_left_side_userlist&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0006_auto_20151123_2019&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0005_auto_20150920_1340&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0014_realm_emoji_url_length&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0022_subscription_pin_to_top&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0003_custom_indexes&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0013_realmemoji&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0006_zerver_userprofile_email_upper_idx&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0012_remove_appledevicetoken&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0002_django_1_8&#39;) missing in new version.
Migration (&#39;default&#39;, &#39;0005_auto_20160727_2333&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0010_delete_streamcolor&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0009_add_missing_migrations&#39;) missing in new version.
Migration (&#39;zerver&#39;, &#39;0023_userprofile_default_language&#39;) missing in new version.
2022-03-31 23:32:21.593 ERR  [] This is not an upgrade -- the current deployment (version 4.11) contains 29 database migrations which /home/zulip/deployments/2022-03-31-20-24-15 (version 5.0) does not.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-03-31-20-24-15/scripts/lib/upgrade-zulip-stage-2&quot;, line 222, in &lt;module&gt;
    subprocess.check_call(
  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 364, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2022-03-31-20-24-15/scripts/lib/check-database-compatibility.py&#39;]&#39; returned non-zero exit status 1.

Zulip upgrade failed (exit code 1)!

The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is available in /var/log/zulip/upgrade.log
</code></pre></div>
<p>Any idea why this is happening?</p>



<a name="1357725"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1357725" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1357725">(Mar 31 2022 at 23:36)</a>:</h4>
<p>This is <a href="https://github.com/zulip/zulip/pull/21596">#21596</a> -- installs which originally installed in very early versions think that they're not upgrades.</p>
<p>For that set of migrations, it is safe to continue.  You can work around this by passing <code>--skip-downgrade-check</code> to the upgrade.</p>



<a name="1357845"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1357845" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GervaisdeM <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1357845">(Apr 01 2022 at 01:34)</a>:</h4>
<p>Thanks!</p>



<a name="1358371"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1358371" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1358371">(Apr 01 2022 at 22:33)</a>:</h4>
<p>Pushed <a href="https://github.com/zulip/zulip/pull/21656">#21656</a> as an alternative to <a href="https://github.com/zulip/zulip/pull/21622">#21622</a>.</p>



<a name="1358722"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1358722" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1358722">(Apr 02 2022 at 07:01)</a>:</h4>
<p><span class="user-mention" data-user-id="147">@kou</span> <span class="user-mention" data-user-id="70">@GervaisdeM</span> I just wanted to let you know that this bug was fixed in the 5.1 release today.</p>



<a name="1358723"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1358723" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1358723">(Apr 02 2022 at 07:01)</a>:</h4>
<p>Thanks for reporting this!</p>



<a name="1358888"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1358888" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1358888">(Apr 02 2022 at 16:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> has marked this topic as resolved.</p>



<a name="1359022"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1359022" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1359022">(Apr 02 2022 at 21:56)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Thanks for notifying this! I could upgrade to 5.1 without <code>--skip-downgrade-check</code>!</p>



<a name="1522302"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Not%20an%20upgrade/near/1522302" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GervaisdeM <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Not.20an.20upgrade.html#1522302">(Mar 10 2023 at 17:29)</a>:</h4>
<p>Just seeing this now. Thanks for letting me know. I've upgraded a few times and had to put that flag back in. I'll remove it now so future upgrades run that check.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>