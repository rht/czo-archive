<html>
<head><meta charset="utf-8"><title>deployment error · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html">deployment error</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="633237"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/633237" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#633237">(Aug 17 2018 at 09:09)</a>:</h4>
<p>Hi there, I'm deploying zulip using docker-compose method from docker-zulip repository (zulip/docker-zulip:1.9.0-rc1-0).</p>



<a name="633238"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/633238" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#633238">(Aug 17 2018 at 09:11)</a>:</h4>
<p>After <code>docker-compose up</code>. I ran <code>manage.py generate_realm_creation_link</code> to create new realm, After fill all the information and submit. It lead to next page show <code>Internal Server Error</code></p>



<a name="633239"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/633239" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#633239">(Aug 17 2018 at 09:11)</a>:</h4>
<p>This is output of  <code>cat /var/log/zulip/errors.log</code></p>



<a name="633240"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/633240" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#633240">(Aug 17 2018 at 09:12)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span> <span class="mi">09</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mf">50.056</span> <span class="n">ERR</span>  <span class="p">[</span><span class="n">django</span><span class="o">.</span><span class="n">request</span><span class="p">]</span> <span class="n">Internal</span> <span class="n">Server</span> <span class="n">Error</span><span class="p">:</span> <span class="o">/</span><span class="n">accounts</span><span class="o">/</span><span class="n">register</span><span class="o">/</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;/home/zulip/deployments/2018-08-10-02-29-35/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/exception.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">41</span><span class="p">,</span> <span class="ow">in</span> <span class="n">inner</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/home/zulip/deployments/2018-08-10-02-29-35/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/base.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">187</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_get_response</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_exception_by_middleware</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/home/zulip/deployments/2018-08-10-02-29-35/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/base.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">185</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_get_response</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">wrapped_callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">callback_args</span><span class="p">,</span> <span class="o">**</span><span class="n">callback_kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;./zerver/decorator.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">127</span><span class="p">,</span> <span class="ow">in</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;./zerver/views/registration.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">200</span><span class="p">,</span> <span class="ow">in</span> <span class="n">accounts_register</span>
    <span class="n">realm</span> <span class="o">=</span> <span class="n">do_create_realm</span><span class="p">(</span><span class="n">string_id</span><span class="p">,</span> <span class="n">realm_name</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;./zerver/lib/actions.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3213</span><span class="p">,</span> <span class="ow">in</span> <span class="n">do_create_realm</span>
    <span class="n">admin_realm</span> <span class="o">=</span> <span class="n">get_system_bot</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">NOTIFICATION_BOT</span><span class="p">)</span><span class="o">.</span><span class="n">realm</span>
  <span class="n">File</span> <span class="s2">&quot;./zerver/lib/cache.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">166</span><span class="p">,</span> <span class="ow">in</span> <span class="n">func_with_caching</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;./zerver/models.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1741</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get_system_bot</span>
    <span class="k">return</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email__iexact</span><span class="o">=</span><span class="n">email</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
  <span class="n">File</span> <span class="s2">&quot;/home/zulip/deployments/2018-08-10-02-29-35/zulip-py3-venv/lib/python3.5/site-packages/django/db/models/query.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">380</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
<span class="n">zerver</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span> <span class="n">UserProfile</span> <span class="n">matching</span> <span class="n">query</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span>
</pre></div>



<a name="633242"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/633242" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#633242">(Aug 17 2018 at 09:19)</a>:</h4>
<p>This is the <code>docker-compose.yml</code> that I'm using:</p>



<a name="633243"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/633243" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#633243">(Aug 17 2018 at 09:19)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&#39;2&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">zulip-postgres-data</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">zulip-redis-data</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">zulip-data</span><span class="p p-Indicator">:</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">database</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;zulip/zulip-postgresql&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">zulip</span>
      <span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">zulip</span>
      <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">zulip</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;zulip-postgres-data:/var/lib/postgresql/data:rw&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">memcached</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;quay.io/sameersbn/memcached:latest&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
  <span class="l l-Scalar l-Scalar-Plain">rabbitmq</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;rabbitmq:3.5.5&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">zulip-rabbit</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">RABBITMQ_DEFAULT_USER</span><span class="p p-Indicator">:</span> <span class="s">&quot;zulip&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">RABBITMQ_DEFAULT_PASS</span><span class="p p-Indicator">:</span> <span class="s">&quot;zulip&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">redis</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;quay.io/sameersbn/redis:latest&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;zulip-redis-data:/var/lib/redis:rw&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">zulip</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">zulip/docker-zulip:1.9.0-rc1-0</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">context</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">./image</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;app:run&#39;</span><span class="p p-Indicator">]</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;8088:80&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">DISABLE_HTTPS</span><span class="p p-Indicator">:</span> <span class="s">&quot;True&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_EXTERNAL_HOST</span><span class="p p-Indicator">:</span> <span class="s">&quot;chat.my.domain&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_ZULIP_ADMINISTRATOR</span><span class="p p-Indicator">:</span> <span class="s">&quot;admin@mydomain.com&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_ALLOWED_HOSTS</span><span class="p p-Indicator">:</span> <span class="s">&quot;[</span><span class="nv"> </span><span class="s">&#39;localhost&#39;,</span><span class="nv"> </span><span class="s">&#39;chat.my.domain&#39;,</span><span class="nv"> </span><span class="s">&#39;127.0.0.1&#39;,</span><span class="nv"> </span><span class="s">&#39;.chat.my.domain&#39;,</span><span class="nv"> </span><span class="s">]&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">DB_HOST</span><span class="p p-Indicator">:</span> <span class="s">&quot;database&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">DB_HOST_PORT</span><span class="p p-Indicator">:</span> <span class="s">&quot;5432&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">DB_USER</span><span class="p p-Indicator">:</span> <span class="s">&quot;zulip&quot;</span>
      <span class="c1"># set to certbot to use Let&#39;s Encrypt SSL certificate</span>
      <span class="c1"># or self-signed for self-signed certificate</span>
      <span class="l l-Scalar l-Scalar-Plain">SSL_CERTIFICATE_GENERATION</span><span class="p p-Indicator">:</span> <span class="s">&quot;self-signed&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_MEMCACHED_LOCATION</span><span class="p p-Indicator">:</span> <span class="s">&quot;memcached:11211&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_RABBITMQ_HOST</span><span class="p p-Indicator">:</span> <span class="s">&quot;rabbitmq&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_REDIS_HOST</span><span class="p p-Indicator">:</span> <span class="s">&quot;redis&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SECRETS_rabbitmq_password</span><span class="p p-Indicator">:</span> <span class="s">&quot;zulip&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SECRETS_postgres_password</span><span class="p p-Indicator">:</span> <span class="s">&quot;zulip&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SECRETS_secret_key</span><span class="p p-Indicator">:</span> <span class="s">&quot;&lt;secret&gt;&quot;</span>
      <span class="c1"># setting outgoing email below</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_EMAIL_HOST</span><span class="p p-Indicator">:</span> <span class="s">&quot;smtp.gmail.com&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_EMAIL_HOST_USER</span><span class="p p-Indicator">:</span> <span class="s">&quot;secret&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SECRETS_email_password</span><span class="p p-Indicator">:</span> <span class="s">&quot;&lt;secret&gt;&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_EMAIL_PORT</span><span class="p p-Indicator">:</span> <span class="s">&quot;587&quot;</span>
      <span class="c1"># It seems that the email server needs to use ssl or tls and can&#39;t be used without it</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_EMAIL_USE_SSL</span><span class="p p-Indicator">:</span> <span class="s">&quot;False&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">SETTING_EMAIL_USE_TLS</span><span class="p p-Indicator">:</span> <span class="s">&quot;True&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">ZULIP_AUTH_BACKENDS</span><span class="p p-Indicator">:</span> <span class="s">&quot;EmailAuthBackend&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;zulip-data:/data:rw&quot;</span>
</pre></div>



<a name="633417"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/633417" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#633417">(Aug 17 2018 at 15:12)</a>:</h4>
<p><span class="user-mention" data-user-id="9107">@Quoc Hoang</span> it looks like your Docker image didn't do the initial database initialization on first startup.  Whether this happens is controlled by a hidden file <code>.initiated</code> in <code>/opt/docker/zulip/zulip</code> (or whatever path you configured; looks like <code>zulip-data</code>).  My guess is you at some point removed the database state data without removing the <code>.initiated</code> file.</p>



<a name="634775"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634775" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634775">(Aug 20 2018 at 03:42)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Thank you very much. I did remove <code>postgres</code> volume and run <code>docker-compose up</code> with intend to create new deployment.</p>



<a name="634782"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634782" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634782">(Aug 20 2018 at 03:57)</a>:</h4>
<p>But another problem appear, I cant create Organization with admin accout</p>



<a name="634783"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634783" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634783">(Aug 20 2018 at 03:57)</a>:</h4>
<p>Im going to describe it in detail</p>



<a name="634784"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634784" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634784">(Aug 20 2018 at 03:58)</a>:</h4>
<p>I have configured in docker-compose to use both Email and LDAP authentication method</p>



<a name="634786"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634786" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634786">(Aug 20 2018 at 04:00)</a>:</h4>
<div class="codehilite"><pre><span></span>version: &#39;2&#39;
volumes:
  zulip-postgres-data:
  zulip-redis-data:
  zulip-data:
services:
  database:
    container_name: zulip-postgresql
    image: &quot;zulip/zulip-postgresql&quot;
    environment:
      POSTGRES_DB: zulip
      POSTGRES_USER: zulip
      POSTGRES_PASSWORD: zulip
    volumes:
      - &quot;zulip-postgres-data:/var/lib/postgresql/data:rw&quot;
  memcached:
    image: &quot;quay.io/sameersbn/memcached:latest&quot;
    restart: always
  rabbitmq:
    image: &quot;rabbitmq:3.5.5&quot;
    hostname: zulip-rabbit
    restart: always
    environment:
        RABBITMQ_DEFAULT_USER: &quot;zulip&quot;
        RABBITMQ_DEFAULT_PASS: &quot;zulip&quot;
  redis:
    image: &quot;quay.io/sameersbn/redis:latest&quot;
    volumes:
      - &quot;zulip-redis-data:/var/lib/redis:rw&quot;
  zulip:
    container_name: zulip
    image: zulip/docker-zulip:1.9.0-rc1-0
    build:
      context: ./image
    command: [&#39;app:run&#39;]
    ports:
      - &quot;8088:80&quot;
    environment:
      DISABLE_HTTPS: &quot;True&quot;
      SETTING_EXTERNAL_HOST: &quot;chat.company-name.lan&quot;
      SETTING_ZULIP_ADMINISTRATOR: &quot;admin@company-name.com&quot;
      SETTING_ALLOWED_HOSTS: &quot;[ &#39;localhost&#39;, &#39;chat.company-name.lan&#39;, &#39;127.0.0.1&#39;, &#39;.chat.company-name.lan&#39;, ]&quot;
      DB_HOST: &quot;database&quot;
      DB_HOST_PORT: &quot;5432&quot;
      DB_USER: &quot;zulip&quot;
      # set to certbot to use Let&#39;s Encrypt SSL certificate
      # or self-signed for self-signed certificate
      SSL_CERTIFICATE_GENERATION: &quot;self-signed&quot;
      SETTING_MEMCACHED_LOCATION: &quot;memcached:11211&quot;
      SETTING_RABBITMQ_HOST: &quot;rabbitmq&quot;
      SETTING_REDIS_HOST: &quot;redis&quot;
      SECRETS_rabbitmq_password: &quot;zulip&quot;
      SECRETS_postgres_password: &quot;zulip&quot;
      SECRETS_secret_key: &quot;&lt;secret&gt;&quot;
      # setting outgoing email below
      SETTING_EMAIL_HOST: &quot;smtp.gmail.com&quot;
      SETTING_EMAIL_HOST_USER: &quot;&lt;mail&gt;&quot;
      SECRETS_email_password: &quot;&lt;password&gt;&quot;
      SETTING_EMAIL_PORT: &quot;587&quot;
      # It seems that the email server needs to use ssl or tls and can&#39;t be used without it
      SETTING_EMAIL_USE_SSL: &quot;False&quot;
      SETTING_EMAIL_USE_TLS: &quot;True&quot;
      ZULIP_AUTH_BACKENDS: &quot;EmailAuthBackend,ZulipLDAPAuthBackend&quot;
      # Uncomment this when configuring the mobile push notifications service
      SETTING_PUSH_NOTIFICATION_BOUNCER_URL: &#39;https://push.zulipchat.com&#39;
      # LDAP config, need further config in /etc/zulip/settings.py, readmore in Readme
      SETTING_AUTH_LDAP_SERVER_URI: &quot;ldaps://&lt;uri&gt;&quot;
      SETTING_AUTH_LDAP_BIND_DN: &quot;uid=zulip,cn=sysaccounts,cn=etc,dc=company-name,dc=com&quot;
      SECRETS_auth_ldap_bind_password: &quot;&lt;password&gt;&quot;
      SETTING_LDAP_EMAIL_ATTR: &quot;mail&quot;
      SETTING_AUTH_LDAP_USER_SEARCH: LDAPSearch(&quot;cn=users,cn=accounts,dc=company-name,dc=com&quot;,ldap.SCOPE_SUBTREE, &quot;(mail=%(user)s)&quot;)
    volumes:
      - &quot;zulip-data:/data:rw&quot;
</pre></div>



<a name="634787"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634787" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634787">(Aug 20 2018 at 04:01)</a>:</h4>
<p>What I did is:</p>



<a name="634789"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634789" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634789">(Aug 20 2018 at 04:04)</a>:</h4>
<div class="codehilite"><pre><span></span>1. docker-compose up
2. generate create organization link (generate_realm_creation_link)
3. Fill the form for register new realm, with email is an email that doesnt exist in LDAP system
4. Click sign up, it redirect to login page, i type email and password I just entered in sign up step, it said that email or password incorrect
</pre></div>



<a name="634790"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634790" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634790">(Aug 20 2018 at 04:05)</a>:</h4>
<p>But I enter an user that existing in LDAP, that user can access the organization.</p>



<a name="634791"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634791" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634791">(Aug 20 2018 at 04:05)</a>:</h4>
<p>The problem is all user from LDAp can log in, but there is no user is admin, so I cant change Organization setting</p>



<a name="634792"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634792" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634792">(Aug 20 2018 at 04:06)</a>:</h4>
<p>I login to the Database, it does create the realm but doesnt create admin user from that realm</p>



<a name="634793"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634793" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634793">(Aug 20 2018 at 04:07)</a>:</h4>
<p><a href="/user_uploads/2/c9/4XqfLIxvXzZQmVQOTG7A1htV/Screen-Shot-2018-08-20-at-11.06.41-AM.png" target="_blank" title="Screen-Shot-2018-08-20-at-11.06.41-AM.png">realm is created</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/c9/4XqfLIxvXzZQmVQOTG7A1htV/Screen-Shot-2018-08-20-at-11.06.41-AM.png" target="_blank" title="realm is created"><img data-src-fullsize="/thumbnail?url=user_uploads%2F2%2Fc9%2F4XqfLIxvXzZQmVQOTG7A1htV%2FScreen-Shot-2018-08-20-at-11.06.41-AM.png&amp;size=full" src="/thumbnail?url=user_uploads%2F2%2Fc9%2F4XqfLIxvXzZQmVQOTG7A1htV%2FScreen-Shot-2018-08-20-at-11.06.41-AM.png&amp;size=thumbnail"></a></div>



<a name="634794"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634794" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634794">(Aug 20 2018 at 04:08)</a>:</h4>
<p><a href="/user_uploads/2/43/kNwzDpYZ1PtiilMMqeFYnZEm/Screen-Shot-2018-08-20-at-11.07.10-AM.png" target="_blank" title="Screen-Shot-2018-08-20-at-11.07.10-AM.png">admin user when register is not created</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/43/kNwzDpYZ1PtiilMMqeFYnZEm/Screen-Shot-2018-08-20-at-11.07.10-AM.png" target="_blank" title="admin user when register is not created"><img data-src-fullsize="/thumbnail?url=user_uploads%2F2%2F43%2FkNwzDpYZ1PtiilMMqeFYnZEm%2FScreen-Shot-2018-08-20-at-11.07.10-AM.png&amp;size=full" src="/thumbnail?url=user_uploads%2F2%2F43%2FkNwzDpYZ1PtiilMMqeFYnZEm%2FScreen-Shot-2018-08-20-at-11.07.10-AM.png&amp;size=thumbnail"></a></div>



<a name="634795"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634795" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634795">(Aug 20 2018 at 04:18)</a>:</h4>
<p>When I login using email/password of an existing user from LDAP, I see a entry added to <code>zever_userprofile</code> table in postgresql (screenshot below)</p>



<a name="634796"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634796" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634796">(Aug 20 2018 at 04:18)</a>:</h4>
<p><a href="/user_uploads/2/ef/spGNS4qSLt03wV9ivm3ymYRx/Screen-Shot-2018-08-20-at-11.13.17-AM.jpg" target="_blank" title="Screen-Shot-2018-08-20-at-11.13.17-AM.jpg">LDAP user can login as normal user</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/ef/spGNS4qSLt03wV9ivm3ymYRx/Screen-Shot-2018-08-20-at-11.13.17-AM.jpg" target="_blank" title="LDAP user can login as normal user"><img data-src-fullsize="/thumbnail?url=user_uploads%2F2%2Fef%2FspGNS4qSLt03wV9ivm3ymYRx%2FScreen-Shot-2018-08-20-at-11.13.17-AM.jpg&amp;size=full" src="/thumbnail?url=user_uploads%2F2%2Fef%2FspGNS4qSLt03wV9ivm3ymYRx%2FScreen-Shot-2018-08-20-at-11.13.17-AM.jpg&amp;size=thumbnail"></a></div>



<a name="634797"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634797" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634797">(Aug 20 2018 at 04:25)</a>:</h4>
<p>I managed to use <code>/home/zulip/deployments/current/manage.py knight</code> to grant admin to a user, but that is just a quick workaround, I think you guys should investigate this.</p>



<a name="634798"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/634798" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#634798">(Aug 20 2018 at 04:26)</a>:</h4>
<p>Thanks</p>



<a name="635623"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/635623" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#635623">(Aug 20 2018 at 18:13)</a>:</h4>
<p><span class="user-mention" data-user-id="9107">@Quoc Hoang</span> our documentation recommends creating your first admin user using EmailAuthBackend, and then configuring LDAP if you want to use that, for this reason.</p>



<a name="635959"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/635959" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#635959">(Aug 21 2018 at 02:37)</a>:</h4>
<p>Thank <span class="user-mention" data-user-id="7">@Tim Abbott</span> , but I think I should not error if we use both Email, LDAP authentication at the first place, the user created in <code>create organization link</code> is clearly admin user and can be created. Application should support this case.</p>



<a name="635965"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/635965" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quoc Hoang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#635965">(Aug 21 2018 at 02:43)</a>:</h4>
<p>The current solution is quite complicated and can be automated, in case we deploy multiple zulip instances.<br>
You know it must be deploy with Email Auth -&gt; create organnization -&gt; go inside container, edit <code>setting.py</code> -&gt; restart server.</p>



<a name="636611"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/636611" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#636611">(Aug 21 2018 at 18:18)</a>:</h4>
<p><span class="user-mention" data-user-id="9107">@Quoc Hoang</span> can you explain a bit more your use case for deploying multiple instances?</p>



<a name="636612"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/636612" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#636612">(Aug 21 2018 at 18:19)</a>:</h4>
<p>(I would expect you'd only end up doing first-time database initialization once)</p>



<a name="636837"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/deployment%20error/near/636837" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/deployment.20error.html#636837">(Aug 21 2018 at 21:41)</a>:</h4>
<p>(I agree it'd be nice to support LDAP auth for the first user, but it's not a trivial thing to implement)</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>