<html>
<head><meta charset="utf-8"><title>upgrade-zulip 4.x -&gt; 5.7 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade-zulip.204.2Ex.20-.3E.205.2E7.html">upgrade-zulip 4.x -&gt; 5.7</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1469760"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade-zulip%204.x%20-%3E%205.7/near/1469760" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hung Pham (Phạm Tiến Hùng) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade-zulip.204.2Ex.20-.3E.205.2E7.html#1469760">(Nov 26 2022 at 02:45)</a>:</h4>
<p>Hi, I am upgrade Zulip from 4.x and face this error in the upgrade script</p>
<div class="codehilite" data-code-language="operations"><pre><span></span><code>  Apply all migrations: analytics, auth, confirmation, contenttypes, otp_static, otp_totp, sessions, social_django, two_factor, zerver
Running migrations:
  Applying zerver.0376_set_realmemoji_author_and_reupload_realmemoji...Traceback (most recent call last):
  File "./manage.py", line 151, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File "./manage.py", line 116, in execute_from_command_line
    utility.execute()
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py", line 440, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py", line 402, in run_from_argv
    self.execute(*args, **cmd_options)
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py", line 448, in execute
    output = self.handle(*args, **options)
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py", line 96, in wrapped
    res = handle_func(*args, **kwargs)
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/commands/migrate.py", line 349, in handle
    post_migrate_state = executor.migrate(
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/executor.py", line 135, in migrate
    state = self._migrate_all_forwards(
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/executor.py", line 167, in _migrate_all_forwards
    state = self.apply_migration(
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/executor.py", line 252, in apply_migration
    state = migration.apply(state, schema_editor)
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/migration.py", line 130, in apply
    operation.database_forwards(
  File "/srv/zulip-venv-cache/7bce584675a91f5ea66d1f1814748fdac0d2084b/zulip-py3-venv/lib/python3.8/site-packages/django/db/migrations/operations/special.py", line 193, in database_forwards
    self.code(from_state.apps, schema_editor)
  File "/home/zulip/deployments/2022-11-26-02-42-53/zerver/migrations/0376_set_realmemoji_author_and_reupload_realmemoji.py", line 26, in set_emoji_author
    realm_emoji.author_id = user_profile.id
AttributeError: 'NoneType' object has no attribute 'id'
Traceback (most recent call last):
  File "/home/zulip/deployments/2022-11-26-02-42-53/scripts/lib/upgrade-zulip-stage-2", line 464, in &lt;module&gt;
    subprocess.check_call(
  File "/usr/lib/python3.8/subprocess.py", line 364, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command '['./manage.py', 'migrate', '--noinput', '--skip-checks']' returned non-zero exit status 1.
</code></pre></div>
<p>Any help is appreciated!</p>



<a name="1469762"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade-zulip%204.x%20-%3E%205.7/near/1469762" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hung Pham (Phạm Tiến Hùng) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade-zulip.204.2Ex.20-.3E.205.2E7.html#1469762">(Nov 26 2022 at 03:12)</a>:</h4>
<p>Hi, I manually add a check in the migration script to avoid the case where <code>user_profile</code> is None. Seem to allow the upgrade to proceed normally.</p>



<a name="1469763"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade-zulip%204.x%20-%3E%205.7/near/1469763" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hung Pham (Phạm Tiến Hùng) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade-zulip.204.2Ex.20-.3E.205.2E7.html#1469763">(Nov 26 2022 at 03:13)</a>:</h4>
<p>Now I am running 6.0 successfully!</p>



<a name="1469765"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade-zulip%204.x%20-%3E%205.7/near/1469765" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade-zulip.204.2Ex.20-.3E.205.2E7.html#1469765">(Nov 26 2022 at 03:51)</a>:</h4>
<p>Thanks for the report. Opened <a href="https://github.com/zulip/zulip/pull/23669">#23669</a>.</p>



<a name="1471567"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade-zulip%204.x%20-%3E%205.7/near/1471567" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade-zulip.204.2Ex.20-.3E.205.2E7.html#1471567">(Nov 30 2022 at 14:53)</a>:</h4>
<p>Was going to mark this as resolved, but I noticed we didn't merge <a href="https://github.com/zulip/zulip/pull/23669">#23669</a> to <code>5.x</code> yet, should we do that?</p>



<a name="1471588"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade-zulip%204.x%20-%3E%205.7/near/1471588" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade-zulip.204.2Ex.20-.3E.205.2E7.html#1471588">(Nov 30 2022 at 16:18)</a>:</h4>
<p>I don't know that we're doing to do another 5.x release.  We should backport it to 6.x, though -- and it's tagged for that already.</p>



<a name="1471914"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade-zulip%204.x%20-%3E%205.7/near/1471914" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade-zulip.204.2Ex.20-.3E.205.2E7.html#1471914">(Dec 01 2022 at 00:15)</a>:</h4>
<p>I suppose it'd be harmless to backport it to the 5.x branch as well.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>