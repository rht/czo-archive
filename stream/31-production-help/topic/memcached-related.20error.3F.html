<html>
<head><meta charset="utf-8"><title>memcached-related error? · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html">memcached-related error?</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="909753"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909753" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dexter Taylor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909753">(Jun 20 2020 at 02:27)</a>:</h4>
<p>Good day all --</p>
<p>In the course of installing Zulip in my datacenter (backstory: 18.04 LTS; certs are already properly configured; postgres is up and receiving connections on the host) and netstat tells me Memcached is also listening on its designated port),</p>
<p>As a result of issuing this command:</p>
<hr>
<p>export EMAIL="&lt;valid email&gt;"<br>
export HOSTNAME="&lt;valid hostname&gt;"<br>
sudo -s ./zulip-server-*/scripts/setup/install --email=${EMAIL} --hostname=${HOSTNAME}</p>
<hr>
<p>I was getting this error:</p>
<hr>
<p>sudo tail /var/log/zulip/install.log<br>
CREATE DATABASE<br>
You are now connected to database "zulip" as user "postgres".<br>
CREATE SCHEMA zulip AUTHORIZATION zulip;<br>
CREATE SCHEMA<br>
++ dirname /home/ubuntu/downloads/zulip-server-2.1.4/scripts/setup/postgres-init-db</p>
<ul>
<li>/home/ubuntu/downloads/zulip-server-2.1.4/scripts/setup/flush-memcached<br>
Traceback (most recent call last):<br>
  File "/home/ubuntu/downloads/zulip-server-2.1.4/scripts/setup/flush-memcached", line 18, in &lt;module&gt;<br>
    behaviors=settings.CACHES["default"]["OPTIONS"]  # type: ignore # settings not typed properly<br>
pylibmc.SomeErrors: error 19 from flush_all: (0x28fd400) AUTHENTICATION FAILURE,  host: 127.0.0.1:11211 -&gt; libmemcached/sasl.cc:292</li>
</ul>
<hr>
<p>The fix was to open the file &lt;ZULIP_HOME&gt;/scripts/setup/flush-memcache</p>
<p>and comment out the lines:</p>
<p>username=settings.MEMCACHED_USERNAME,<br>
password=settings.MEMCACHED_PASSWORD,</p>
<p>This fixed the problem -- but it looks like email transport is now broken.</p>
<p>Question #1: What is a proper fix for this problem?<br>
Question #2: Did I in fact break email transport, or is something else going on?</p>
<p>Thanks for reading (I know this is a long one).</p>



<a name="909754"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909754" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dexter Taylor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909754">(Jun 20 2020 at 02:40)</a>:</h4>
<p>I should add that when I spin up Zulip, I can interact with it via the web app, but I also get a stream of errors emitted to the admin address:</p>
<hr>
<p>Logger django.pylibmc, from module django_pylibmc.memcached line 146:<br>
Error generated by Anonymous user (not logged in) on ip-10-0-1-178 deployment</p>
<p>Traceback (most recent call last):<br>
  File "/home/zulip/deployments/2020-06-15-17-40-15/zulip-py3-venv/lib/python3.6/site-packages/django_pylibmc/memcached.py", line 130, in get<br>
    return super(PyLibMCCache, self).get(key, default, version)<br>
  File "/home/zulip/deployments/2020-06-15-17-40-15/zulip-py3-venv/lib/python3.6/site-packages/django/core/cache/backends/memcached.py", line 79, in get<br>
    val = self._cache.get(key)<br>
pylibmc.Error: error 41 from memcached_get(:1:e37d7d97b1dc2de9cbc941941746d): (0x7ff5140310f0) AUTHENTICATION FAILURE,  host: 127.0.0.1:11211 -&gt; libmemcached/sasl.cc:292</p>
<p>During handling of the above exception, another exception occurred:</p>
<p>Traceback (most recent call last):<br>
  File "/home/zulip/deployments/2020-06-15-17-40-15/zulip-py3-venv/lib/python3.6/site-packages/django_pylibmc/memcached.py", line 140, in set<br>
    **COMPRESS_KWARGS)<br>
pylibmc.ServerDown: error 47 from memcached_set: (0x7ff5140310f0) SERVER HAS FAILED AND IS DISABLED UNTIL TIMED RETRY,  host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:720</p>
<p>Deployed code:</p>
<ul>
<li>ZULIP_VERSION: 2.1.3-9-g2b95f54593</li>
<li>version: 2.1.4</li>
</ul>
<hr>



<a name="909756"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909756" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909756">(Jun 20 2020 at 02:50)</a>:</h4>
<p><span class="user-mention" data-user-id="16315">@Dexter Taylor</span> the problem here is that memcached authentication is not working, likely because your system's hostname changed sometime after you first installed.   I believe this is fixed here: <a href="https://github.com/zulip/zulip/pull/15462">https://github.com/zulip/zulip/pull/15462</a> (which fixes the bug that made the system hostname part of the credentials used to authenticate with memcached).</p>
<p>Because it's just a cache, Zulip will run, albeit slower, without it, while emailing you lots of errors about it being broken.</p>



<a name="909761"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909761" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dexter Taylor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909761">(Jun 20 2020 at 03:18)</a>:</h4>
<p>Thank you Tim -- this is the direction I was headed in. So what I've just done is:</p>
<p>-- shut down the Zulip stack using supervisorctl<br>
-- created and installed valid SASL credentials for memcached<br>
-- verified that I could connect to memcached using that username and password</p>
<p>But of course my problem now is, I don't know what credentials Zulip is using to connect to memcached.  How do I access/configure that?</p>



<a name="909763"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909763" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909763">(Jun 20 2020 at 03:20)</a>:</h4>
<p><span class="user-mention" data-user-id="16315">@Dexter Taylor</span> our puppet rules generate the credentials.  Most of the logic in that PR is just ensuring the generating happens twice.</p>



<a name="909764"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909764" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909764">(Jun 20 2020 at 03:21)</a>:</h4>
<p>I can add it to our <code>2.1.x</code> branch, and then you can test <code>upgrade-zulip-from-git 2.1.x</code> fixes it for you (effectively QAing this change for our next release).  Would that work for you?</p>



<a name="909766"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909766" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909766">(Jun 20 2020 at 03:22)</a>:</h4>
<p>Just added it to that branch.</p>



<a name="909767"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909767" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909767">(Jun 20 2020 at 03:22)</a>:</h4>
<p>(Basically, the main reason it hasn't been merged/released is I wanted to get a full test that it fixes the problem for someone in exactly your situation)</p>



<a name="909768"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909768" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dexter Taylor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909768">(Jun 20 2020 at 03:26)</a>:</h4>
<p>ok, I'll try that now</p>



<a name="909769"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909769" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dexter Taylor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909769">(Jun 20 2020 at 03:28)</a>:</h4>
<p>where does the command </p>
<p>upgrade-zulip-from-git</p>
<p>live?</p>



<a name="909770"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909770" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909770">(Jun 20 2020 at 03:29)</a>:</h4>
<p><a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-a-git-repository">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-a-git-repository</a></p>



<a name="909778"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909778" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dexter Taylor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909778">(Jun 20 2020 at 03:45)</a>:</h4>
<p>Looks like that worked! Now zulip is sending invitation emails properly.</p>
<p>Thanks for your help! That was a lifesaver.</p>



<a name="909779"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909779" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909779">(Jun 20 2020 at 03:45)</a>:</h4>
<p>Great!</p>



<a name="909780"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909780" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909780">(Jun 20 2020 at 03:45)</a>:</h4>
<p>Thanks for verifying the fix <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="909781"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909781" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909781">(Jun 20 2020 at 03:46)</a>:</h4>
<p><span class="user-mention" data-user-id="699">@Anders Kaseorg</span> FYI.  Any objection to my releasing 2.1.7 with that your memcached PR tomorrow?</p>



<a name="909787"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909787" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909787">(Jun 20 2020 at 04:35)</a>:</h4>
<p>Sure; just be aware that it won’t work with the docker-zulip 2.1.6 docker-compose.yml.</p>



<a name="909788"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909788" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909788">(Jun 20 2020 at 04:58)</a>:</h4>
<p>Hmm, is the docker-compose.yml change to support it complex?</p>



<a name="909797"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/memcached-related%20error%3F/near/909797" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/memcached-related.20error.3F.html#909797">(Jun 20 2020 at 06:37)</a>:</h4>
<p>I expect we just need to duplicate the <code>zulip@$$HOSTNAME:$$MEMCACHED_PASSWORD</code> line as <code>zulip@localhost:$$MEMCACHED_PASSWORD</code>.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>