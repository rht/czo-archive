<html>
<head><meta charset="utf-8"><title>Creating a 2nd domain · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html">Creating a 2nd domain</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="806185"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806185" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806185">(Jan 03 2020 at 14:16)</a>:</h4>
<p>We have a need to allow a 3rd party access to our Zulip - however we want to keep them in a separate area on Zulip, while still allowing existing internal Zulip users access to everything on the server. I'm looking at <a href="https://zulip.readthedocs.io/en/latest/production/multiple-organizations.html" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/multiple-organizations.html">https://zulip.readthedocs.io/en/latest/production/multiple-organizations.html</a> but am unsure which approach I should be looking at. The 3rd party is just a handful of users so if we had to manually create their accounts that would be perfectly fine.</p>



<a name="806187"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806187" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cyphase <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806187">(Jan 03 2020 at 15:08)</a>:</h4>
<p>If you want them to be in the same Zulip organization as you and able to interact there, you may want to add them as Guest users. That way they can only see streams they're added to, although for now it will also let them see all the members in your Zulip organization.</p>



<a name="806190"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806190" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806190">(Jan 03 2020 at 16:46)</a>:</h4>
<p>Will this work even though we are using LDAP for our internal users? We are self-hosted.</p>



<a name="806197"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806197" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806197">(Jan 03 2020 at 17:53)</a>:</h4>
<p>Is there something we need to do to allow Zulip to send mail to other domains? Our Exchange is rejecting anything coming from Zulip going to an outside domain.</p>



<a name="806212"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806212" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806212">(Jan 03 2020 at 19:54)</a>:</h4>
<p><span class="user-mention" data-user-id="3275">@hb-it</span> on the email front, that's likely a configuration issue on your Exchange server's side.</p>



<a name="806218"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806218" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806218">(Jan 03 2020 at 20:00)</a>:</h4>
<p>Fixed that part I think by adding an Exchange Connector, so the signup emails are now flowing to my Gmail test accounts. However when I try to follow through and provide a new password as prompted, Zulip logins fail on the new account "Please enter a correct email and password. Note that both fields may be case-sensitive." even though I have tried several times with a correct password.</p>



<a name="806220"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806220" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806220">(Jan 03 2020 at 20:00)</a>:</h4>
<p>What Zulip version are you using?</p>



<a name="806221"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806221" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806221">(Jan 03 2020 at 20:00)</a>:</h4>
<p>And which LDAP configuration mode?</p>



<a name="806223"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806223" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806223">(Jan 03 2020 at 20:01)</a>:</h4>
<p>You can use <code>EmailAuthBackend</code> and LDAP on the same system, but only for email addresses that Zulip can prove are not  in the LDAP database; the LDAP changes in 2.1.0 make it possible to do that proof via an LDAP query (rather than just <code>LDAP_APPEND_DOMAIN</code>)</p>



<a name="806225"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806225" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806225">(Jan 03 2020 at 20:03)</a>:</h4>
<p>Zulip Server 2.1.1. Not sure what you mean by which LDAP mode, where do I check that?</p>



<a name="806232"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806232" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806232">(Jan 03 2020 at 20:27)</a>:</h4>
<p><span class="user-mention" data-user-id="3275">@hb-it</span> This is referring to the (A), (B) and (C) configuration types from <a href="https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#ldap-including-active-directory" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#ldap-including-active-directory">https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#ldap-including-active-directory</a></p>



<a name="806233"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806233" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806233">(Jan 03 2020 at 20:34)</a>:</h4>
<p>AUTH_LDAP_USER_SEARCH = LDAPSearch("CN=Users,DC=ourdomain,DC=com",<br>
    ldap.SCOPE_SUBTREE, "(sAMAccountName=%(user)s)")     is what we have setup in settings.py</p>



<a name="806234"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806234" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806234">(Jan 03 2020 at 20:37)</a>:</h4>
<p>No <code>LDAP_APPEND_DOMAIN</code> or <code>LDAP_EMAIL_ATTR</code>?</p>



<a name="806236"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806236" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806236">(Jan 03 2020 at 20:52)</a>:</h4>
<p>LDAP_APPEND_DOMAIN = ADMIN_DOMAIN,     LDAP_EMAIL_ATTR is not configured</p>



<a name="806237"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806237" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806237">(Jan 03 2020 at 21:04)</a>:</h4>
<p>That's configuration (B). In this case, you should be good to go if you enable EmailAuthBackend, with the restriction being that the 3rd party guest users must have emails outside the <code>ADMIN_DOMAIN</code>(since  <code>LDAP_APPEND_DOMAIN</code> emails are only allowed to be administered by ldap, not by the email backend).</p>



<a name="806239"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806239" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806239">(Jan 03 2020 at 21:23)</a>:</h4>
<p>I've uncommented EmailAuthBackend, all new users are still being rejected for an invalid password. The Notification bot is reporting the new user signups though.</p>



<a name="806240"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806240" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806240">(Jan 03 2020 at 21:28)</a>:</h4>
<p>Are their email addresses different from the <code>ADMIN_DOMAIN</code>? Can you run <code>manage.py shell</code> and in there check what <code>email_belongs_to_ldap</code> returns for their emails?</p>
<div class="codehilite"><pre><span></span>from zproject.backends import email_belongs_to_ldap
 email_belongs_to_ldap(get_realm(&quot;&quot;), &quot;address@example.com&quot;)
</pre></div>



<a name="806241"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806241" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806241">(Jan 03 2020 at 21:29)</a>:</h4>
<p>They are different, they are test gmail accounts.</p>



<a name="806242"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806242" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806242">(Jan 03 2020 at 21:30)</a>:</h4>
<p>I have to run atm, I will try the manage.py next. Thanks.</p>



<a name="806243"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806243" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806243">(Jan 03 2020 at 21:31)</a>:</h4>
<p>How do the generated logs in <code>/var/log/zulip/server.log</code> and  <code>/var/log/zulip/django.log</code> look when they try to log in?</p>



<a name="806426"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806426" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806426">(Jan 05 2020 at 11:47)</a>:</h4>
<p>No entries in either of those logs after failed logins.</p>



<a name="806427"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806427" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806427">(Jan 05 2020 at 12:12)</a>:</h4>
<p>When running the manage.py command above I am getting:</p>



<a name="806428"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806428" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806428">(Jan 05 2020 at 12:12)</a>:</h4>
<p>In [2]: from zproject.backends import email_belongs_to_ldap<br>
   ...:  email_belongs_to_ldap(get_realm(""), "<a href="mailto:address@example.com" title="mailto:address@example.com">address@example.com</a>")<br>
  File "&lt;ipython-input-2-8415901a2051&gt;", line 2<br>
    email_belongs_to_ldap(get_realm(""), "<a href="mailto:address@example.com" title="mailto:address@example.com">address@example.com</a>")<br>
    ^<br>
IndentationError: unexpected indent</p>



<a name="806578"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806578" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806578">(Jan 05 2020 at 20:39)</a>:</h4>
<p><span class="user-mention" data-user-id="3275">@hb-it</span> that error is just that the leading space in the second line of code Mateusz suggested was a typo.</p>



<a name="806648"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806648" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806648">(Jan 05 2020 at 23:26)</a>:</h4>
<p>Yeah, that leading space was a typo.<br>
Also, can you check if the user accounts are actually active? (Organization settings -&gt; Users)</p>



<a name="806778"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806778" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806778">(Jan 06 2020 at 12:55)</a>:</h4>
<p>In [6]: from zproject.backends import email_belongs_to_ldap<br>
   ...: email_belongs_to_ldap(get_realm(""), "<a href="mailto:my.tester@gmail.com" title="mailto:my.tester@gmail.com">my.tester@gmail.com</a>")<br>
Out[6]: False</p>
<p>The test accounts are showing up as active. On a related note, how do we change passwords for guest users?</p>



<a name="806831"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806831" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806831">(Jan 06 2020 at 18:34)</a>:</h4>
<p><span class="user-mention" data-user-id="3275">@hb-it</span> you can change a user's Zulip-side password on the command line using <code>manag.epy changepassword</code>.</p>



<a name="806844"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806844" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806844">(Jan 06 2020 at 18:43)</a>:</h4>
<p>Still rejecting passwords after trying that.</p>



<a name="806990"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806990" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806990">(Jan 07 2020 at 02:30)</a>:</h4>
<p>Hmm, I'm not able to reproduce this, email backend + ldap backend with LDAP_APPEND_DOMAIN seems to be working fine for me.<br>
But some logs must be getting generated on these login attempts,  in <code>django.log</code> and <code>server.log</code>, even if only rather uninformative stuff like:</p>
<div class="codehilite"><pre><span></span>2020-01-07 02:24:05.177 INFO [zr] 172.17.0.1      GET     200 108ms (db: 4ms/3q) /login/ (unauth via ?)
2020-01-07 02:24:07.600 INFO [zr] 172.17.0.1      SOCKET  408   0ms /socket/close [transport=websocket] (unknown via ?)
2020-01-07 02:24:07.601 INFO [zr] status=408, data=Timeout while waiting for authentication, uid=unknown
2020-01-07 02:24:13.140 INFO [zr] 172.17.0.1      POST    200  79ms (db: 12ms/6q) /accounts/login/ (unauth via ?)
2020-01-07 02:24:14.502 INFO [zr] 172.17.0.1      SOCKET  408   0ms /socket/close [transport=websocket] (unknown via ?)
2020-01-07 02:24:14.503 INFO [zr] status=408, data=Timeout while waiting for authentication, uid=unknown
2020-01-07 02:24:31.983 INFO [] Slow query: 172.17.0.1      GET     200 19.1s (mem: 9ms/17) (db: 103ms/38q) (+start: 21ms) / [1578363806:0] (jack@gmail.com via website) (jack@gmail.com)
2020-01-07 02:24:31.984 INFO [] Slow query: 172.17.0.1      GET     200  9.4s (db: 89ms/33q) / [1578363806:1] (jack@gmail.com via website) (jack@gmail.com)
2020-01-07 02:24:33.756 INFO [zr] 172.17.0.1      POST    200  74ms (db: 8ms/5q) /accounts/login/ (unauth via ?)
</pre></div>



<a name="806991"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/806991" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#806991">(Jan 07 2020 at 02:38)</a>:</h4>
<p>Also, can you try running this in <code>manage.py shell</code> (set the email and password values correctly and you can just copypaste the code into the shell)</p>
<div class="codehilite"><pre><span></span>from typing import Any

from django.conf import settings
from django.contrib.auth import authenticate

from zerver.models import get_user_by_delivery_email, get_realm
from zproject.backends import ZulipLDAPAuthBackend, EmailAuthBackend

realm = get_realm(&quot;&quot;)
email = &quot;jack@gmail.com&quot;  # set this
password = &quot;jack&quot;  # set this

user = get_user_by_delivery_email(email, realm)
print(&quot;User email: {} is_active: {}&quot;.format(user.email, user.is_active))

return_data = {}
result = authenticate(username=email, password=password,
                                             realm=realm, return_data=return_data)
print(&quot;Django authenticate() result: {}\nreturn_data:{}&quot;.format(result, return_data))

return_data = {}
result = EmailAuthBackend().authenticate(username=email, password=password,
                                         realm=realm, return_data=return_data)
print(&quot;EmailAuthBackend.authenticate() result: {}\nreturn_data:{}&quot;.format(result, return_data))
</pre></div>



<a name="807050"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/807050" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#807050">(Jan 07 2020 at 12:57)</a>:</h4>
<p>User email: <a href="mailto:jack@gmail.com" title="mailto:jack@gmail.com">jack@gmail.com</a> is_active: True<br>
Django authenticate() result: None<br>
return_data:{'no_matching_ldap_user': True}<br>
EmailAuthBackend.authenticate() result: None<br>
return_data:{}</p>



<a name="807051"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/807051" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#807051">(Jan 07 2020 at 13:00)</a>:</h4>
<p>Nothing is added to either of those logs when I log in with a test user.</p>



<a name="807053"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/807053" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#807053">(Jan 07 2020 at 13:23)</a>:</h4>
<p>Huh, getting <code>None</code> from the <code>EmailAuthBackend.authenticate()</code> call is weird. If there was some configuration issue, or in general anything to do with a bad interaction with ldap, then this authenticate call should succeed anyway. Can you try this in the shell? (appended a bit extra debugging lines to the code) <span class="user-mention" data-user-id="3275">@hb-it</span> </p>
<div class="codehilite"><pre><span></span>from typing import Any

from django.conf import settings
from django.contrib.auth import authenticate

from zerver.models import get_user_by_delivery_email, get_realm
from zproject.backends import ZulipLDAPAuthBackend, EmailAuthBackend, common_get_active_user

realm = get_realm(&quot;&quot;)
email = &quot;jack@gmail.com&quot;  # set this
password = &quot;jack&quot;  # set this

user = get_user_by_delivery_email(email, realm)
print(&quot;User email: {} is_active: {}&quot;.format(user.email, user.is_active))

return_data = {}
result = authenticate(username=email, password=password,
                                             realm=realm, return_data=return_data)
print(&quot;Django authenticate() result: {}\nreturn_data:{}&quot;.format(result, return_data))

return_data = {}
result = EmailAuthBackend().authenticate(username=email, password=password,
                                         realm=realm, return_data=return_data)
print(&quot;EmailAuthBackend.authenticate() result: {}\nreturn_data:{}&quot;.format(result, return_data))

print(&quot;common_get_active_user: {}&quot;.format(common_get_active_user(email, realm)))
print(&quot;Check_password: {}&quot;.format(user.check_password(password)))
</pre></div>


<p>(Remember to set the <code>email</code> and <code>password</code>)</p>



<a name="807055"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/807055" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#807055">(Jan 07 2020 at 13:30)</a>:</h4>
<p>User email: <a href="mailto:jack@gmail.com" title="mailto:jack@gmail.com">jack@gmail.com</a> is_active: True<br>
Django authenticate() result: &lt;UserProfile: <a href="mailto:jack@gmail.com" title="mailto:jack@gmail.com">jack@gmail.com</a> &lt;Realm:  2&gt;&gt;<br>
return_data:{}<br>
EmailAuthBackend.authenticate() result: &lt;UserProfile: <a href="mailto:jack@gmail.com" title="mailto:jack@gmail.com">jack@gmail.com</a> &lt;Realm:  2&gt;&gt;<br>
return_data:{}<br>
common_get_active_user: &lt;UserProfile: <a href="mailto:jack@gmail.com" title="mailto:jack@gmail.com">jack@gmail.com</a> &lt;Realm:  2&gt;&gt;<br>
Check_password: True</p>



<a name="807056"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Creating%20a%202nd%20domain/near/807056" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hb-it <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Creating.20a.202nd.20domain.html#807056">(Jan 07 2020 at 13:35)</a>:</h4>
<p>Changed the password again just to be sure, and now it's working. I'm not sure why, but I'll take it. Thanks very much again for the help. :-)</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>