<html>
<head><meta charset="utf-8"><title>✔ relaying denied · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html">✔ relaying denied</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1274064"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1274064" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IanH <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1274064">(Oct 29 2021 at 20:06)</a>:</h4>
<p>Hi there, I just installed Zulip at home. I have a somewhat unique setup where Zulip is behind a reverse proxy. That reverse proxy server (Cloudron) runs several other apps which also use Mailgun. When using the same mailgun credentials in Zulip, I get Relaying Denied. I've gone through the troubleshooting steps but I can't figure out what's wrong and why only Zulip won't work when the other things will on the same physical hardware on the same network.</p>



<a name="1274134"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1274134" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1274134">(Oct 29 2021 at 21:59)</a>:</h4>
<p><span class="user-mention" data-user-id="16458">@IanH</span> <a href="https://help.mailgun.com/hc/en-us/articles/360012360833-Why-Did-I-Receive-Relaying-Denied-">https://help.mailgun.com/hc/en-us/articles/360012360833-Why-Did-I-Receive-Relaying-Denied-</a> might be helpful.</p>



<a name="1274527"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1274527" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IanH <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1274527">(Oct 31 2021 at 21:22)</a>:</h4>
<p>I double checked my credentials and the URL but everything was correct</p>



<a name="1274762"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1274762" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1274762">(Nov 01 2021 at 18:09)</a>:</h4>
<p><span class="user-mention" data-user-id="16458">@IanH</span> one possibility is that Zulip is sending from a different <code>From</code> address than your other software, and you need to configure Mailgun to accept that sender.</p>



<a name="1274763"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1274763" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1274763">(Nov 01 2021 at 18:09)</a>:</h4>
<p>If that doesn't work, I'd try asking Mailgun support for help.</p>



<a name="1274765"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1274765" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1274765">(Nov 01 2021 at 18:09)</a>:</h4>
<p>The second bullet in <a href="https://zulip.readthedocs.io/en/latest/production/email.html#troubleshooting">https://zulip.readthedocs.io/en/latest/production/email.html#troubleshooting</a> is the issue I have in mind.</p>



<a name="1274885"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1274885" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1274885">(Nov 01 2021 at 20:15)</a>:</h4>
<p>Can you show the output from <a href="https://zulip.readthedocs.io/en/latest/production/email.html#troubleshooting">the <code>send_test_email</code> command</a>?  My first guess is that one of the confgs is typo'd and as such not actually providing the right (or any) auth.</p>
<p>Another possibility, based on your "at home", is that Mailgun doesn't allow direct SMTP connections from a consumer (e.g. cable) IP address, which is a restriction that some SMTP servers enforce to limit spam.  It'd surprise me if mailgun did that and didn't document that on their "relaying denied" FAQ, however.</p>



<a name="1275062"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275062" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IanH <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275062">(Nov 02 2021 at 00:22)</a>:</h4>
<p>yeah, here's the log:</p>
<div class="codehilite"><pre><span></span><code>Failed to send mails: (550, b&#39;5.7.1 Relaying denied&#39;, &#39;admin@domain.tools&#39;)

Full SMTP log follows:
connect: to (&#39;smtp.mailgun.org&#39;, 587) None
reply: b&#39;220 Mailgun Influx ready\r\n&#39;
reply: retcode (220); Msg: b&#39;Mailgun Influx ready&#39;
connect: b&#39;Mailgun Influx ready&#39;
send: &#39;ehlo zulip\r\n&#39;
reply: b&#39;250-smtp-out-n04.prod.us-east-1.postgun.com\r\n&#39;
reply: b&#39;250-AUTH PLAIN LOGIN\r\n&#39;
reply: b&#39;250-SIZE 52428800\r\n&#39;
reply: b&#39;250-8BITMIME\r\n&#39;
reply: b&#39;250-SMTPUTF8\r\n&#39;
reply: b&#39;250-PIPELINING\r\n&#39;
reply: b&#39;250 STARTTLS\r\n&#39;
reply: retcode (250); Msg: b&#39;smtp-out-n04.prod.us-east-1.postgun.com\nAUTH PLAIN LOGIN\nSIZE 52428800\n8BITMIME\nSMTPUTF8\nPIPELINING\nSTARTTLS&#39;
send: &#39;STARTTLS\r\n&#39;
reply: b&#39;220 Go ahead\r\n&#39;
reply: retcode (220); Msg: b&#39;Go ahead&#39;
send: &#39;ehlo zulip\r\n&#39;
reply: b&#39;250-smtp-out-n04.prod.us-east-1.postgun.com\r\n&#39;
reply: b&#39;250-AUTH PLAIN LOGIN\r\n&#39;
reply: b&#39;250-SIZE 52428800\r\n&#39;
reply: b&#39;250-8BITMIME\r\n&#39;
reply: b&#39;250-SMTPUTF8\r\n&#39;
reply: b&#39;250 PIPELINING\r\n&#39;
reply: retcode (250); Msg: b&#39;smtp-out-n04.prod.us-east-1.postgun.com\nAUTH PLAIN LOGIN\nSIZE 52428800\n8BITMIME\nSMTPUTF8\nPIPELINING&#39;
send: &#39;mail FROM:&lt;admin@domain.tools&gt; size=616\r\n&#39;
reply: b&#39;550 5.7.1 Relaying denied\r\n&#39;
reply: retcode (550); Msg: b&#39;5.7.1 Relaying denied&#39;
send: &#39;rset\r\n&#39;

Email sending failed!
</code></pre></div>



<a name="1275063"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275063" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IanH <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275063">(Nov 02 2021 at 00:23)</a>:</h4>
<p>I currently have email set to:</p>
<div class="codehilite"><pre><span></span><code>EMAIL_HOST = &#39;smtp.mailgun.org&#39;
EMAIL_HOST_USER = &#39;rosa@mail.domain.tools&#39;

## Passwords and secrets are not stored in this file.  The password
## for user EMAIL_HOST_USER goes in `/etc/zulip/zulip-secrets.conf`.
## In that file, set `email_password`.  For example:
# email_password = abcd1234

## EMAIL_USE_TLS and EMAIL_PORT are required for most SMTP providers.
EMAIL_USE_TLS = True
EMAIL_PORT = 587

## The noreply address to be used as the sender for certain generated
## emails.  Messages sent to this address could contain sensitive user
## data and should not be delivered anywhere.  The default is
## e.g. noreply-{token}@zulip.example.com (if EXTERNAL_HOST is
## zulip.example.com).  There are potential security issues if you set
## ADD_TOKENS_TO_NOREPLY_ADDRESS=False to remove the token; see
## https://zulip.readthedocs.io/en/latest/production/email.html for details.
ADD_TOKENS_TO_NOREPLY_ADDRESS = False
#TOKENIZED_NOREPLY_EMAIL_ADDRESS = &quot;noreply-{token}@example.com&quot;
## NOREPLY_EMAIL_ADDRESS is the sender for noreply emails that don&#39;t
## contain confirmation links (where the security problem fixed by
## ADD_TOKENS_TO_NOREPLY_ADDRESS does not exist), as well as for
## confirmation emails when ADD_TOKENS_TO_NOREPLY_ADDRESS=False.
NOREPLY_EMAIL_ADDRESS = &#39;noreply@doamin.tools&#39;
</code></pre></div>



<a name="1275066"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275066" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IanH <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275066">(Nov 02 2021 at 00:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/relaying.20denied/near/1274885">said</a>:</p>
<blockquote>
<p>Another possibility, based on your "at home", is that Mailgun doesn't allow direct SMTP connections from a consumer (e.g. cable) IP address, which is a restriction that some SMTP servers enforce to limit spam.  It'd surprise me if mailgun did that and didn't document that on their "relaying denied" FAQ, however.</p>
</blockquote>
<p>Other applications I host at home can send/receive mail without a problem (but they aren't behind the same reverse proxy Zulip is, if that matters)</p>



<a name="1275070"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275070" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275070">(Nov 02 2021 at 00:34)</a>:</h4>
<p>I don't see an attempt at auth there, unless you elided it.  Does <code>egrep '^email_password\s*=\s*\S+' /etc/zulip/zulip-secrets.conf</code> match any lines?</p>



<a name="1275072"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275072" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275072">(Nov 02 2021 at 00:34)</a>:</h4>
<p>(don't show the output, if so, because that's your password)</p>



<a name="1275079"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275079" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IanH <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275079">(Nov 02 2021 at 00:38)</a>:</h4>
<p>oh my god, well I fixed email and also figured out why twitter embeds wouldn't work. zulip/secrets.conf is not zulip/zullip-secrets.conf , sorry for the false alarm folks, I can't believe I didn't notice that earlier</p>



<a name="1275083"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275083" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275083">(Nov 02 2021 at 00:39)</a>:</h4>
<p>No worries. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1275085"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275085" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275085">(Nov 02 2021 at 00:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="16458">IanH</span> has marked this topic as resolved.</p>



<a name="1275086"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275086" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275086">(Nov 02 2021 at 00:40)</a>:</h4>
<p>I wonder if setting <code>EMAIL_HOST_USER</code> but not the <code>email_password</code> secret should throw a warning or error in the logs.</p>



<a name="1275088"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275088" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IanH <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275088">(Nov 02 2021 at 00:41)</a>:</h4>
<p>good idea, I can post it in feeback if it's not there</p>



<a name="1275099"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20relaying%20denied/near/1275099" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20relaying.20denied.html#1275099">(Nov 02 2021 at 00:46)</a>:</h4>
<p><a class="stream-topic" data-stream-id="9" href="/#narrow/stream/9-issues/topic/.E2.9C.94.20.27Last.20active.27.20not.20worked">#issues &gt; ✔ 'Last active' not worked</a> has a bit of a related problem, but a bad hostname instead.</p>
<p>I think it's worth starting a topic in <a class="stream" data-stream-id="137" href="/#narrow/stream/137-feedback">#feedback</a> about if and when we want to do a configuration reasonableness check, particularly for email.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>