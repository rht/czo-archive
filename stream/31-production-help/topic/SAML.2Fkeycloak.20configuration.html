<html>
<head><meta charset="utf-8"><title>SAML/keycloak configuration · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html">SAML/keycloak configuration</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="814298"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/814298" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ChemSmith <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#814298">(Feb 04 2020 at 00:28)</a>:</h4>
<p>Hi guys,<br>
Wondering if it's possible to configure SAML SSO login using environmental variables or if I need to handcraft a config and tell the container to not configure the config?</p>



<a name="814305"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/814305" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#814305">(Feb 04 2020 at 00:44)</a>:</h4>
<p><span class="user-mention" data-user-id="14082">@ChemSmith</span> I would guess it'll be really painful to try to configure SAML via environment variables.</p>



<a name="814306"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/814306" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#814306">(Feb 04 2020 at 00:44)</a>:</h4>
<p>You can try using the MANUAL_CONFIGURATION setting (Which we have plans to work on soon)</p>



<a name="814324"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/814324" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ChemSmith <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#814324">(Feb 04 2020 at 00:54)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Thanks, I'd figured as much but thought I'd get confirmation first.</p>



<a name="814351"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/814351" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ChemSmith <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#814351">(Feb 04 2020 at 01:28)</a>:</h4>
<p>On a related note has anyone successfully setup Keycloak as a SAML IdP for Zulip?</p>



<a name="814361"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/814361" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ChemSmith <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#814361">(Feb 04 2020 at 03:41)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> getting the container to spin up with an external settings.py is way more work than it should be (I still haven't actually managed to do it). I'm wondering if a better way to do it would be to just volume mount settings.py from the host into the container directly into /etc/zulip/settings.py but otherwise let the entrypoint script setup up everything else (rather than linking all of /etc/zulip from /data). I will look into modifying the entrypoint script tonight to allow this.</p>



<a name="814485"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/814485" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#814485">(Feb 04 2020 at 21:29)</a>:</h4>
<p><span class="user-mention" data-user-id="14082">@ChemSmith</span> yeah, making that work nicely is one of the things I'm hoping <span class="user-mention" data-user-id="52">@Vishnu Ks</span> will make happen over the next few weeks.  For the moment, I'd definitely recommend using our standard installation approach for SAML.</p>



<a name="817560"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/817560" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#817560">(Feb 17 2020 at 15:48)</a>:</h4>
<p>As I can see in README: An alternative approach is to set MANUAL_CONFIGURATION: "True" and LINK_SETTINGS_TO_DATA in docker-compose.yml. <br>
Is LINK_SETTINGS_TO_DATA particular ENV? Or just example? Anyway, Do I have to set path to setting.py? and If I bind /etc/zulip (volumes:) contained setting.py, do I need to specify LINK_SETTINGS_TO_DATA ?</p>



<a name="817565"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/817565" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#817565">(Feb 17 2020 at 15:56)</a>:</h4>
<p>additionl qusetion :) How to pass setting from docker-compose env to setting.py if that setting in setting.py must be present as dict?  Most settings in Zulip are just strings, but some are lists (etc.) if it is list it is clear, need to use comma-separated. if is it dict?</p>



<a name="817935"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/817935" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#817935">(Feb 18 2020 at 19:35)</a>:</h4>
<p><span class="user-mention" data-user-id="14868">@Максим Декин</span> I'd recommend using <code>MANUAL_CONFIGURATION</code> for that use case.  The Docker model of passing data via environment variables isn't super compatible with more complex configuration like dictionaries.</p>



<a name="818480"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818480" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818480">(Feb 19 2020 at 16:22)</a>:</h4>
<p>ok, it works. I was able to configure LDAP by changing paramerts in setting.py.  But Now I am trying to configure SAML auth (it is my main purpose) and I can not succeed in this task. I read manual and try more and more, but it doesn’t work. I have a lot of other applications I had configured SAML but not Zulip. I couldn`t find any examples in internet (my saml provider is WSO2IS). The main problem is no redirect to SAML provider when I click button  on the form. I watch requests and respons in Chrome Developer Tools</p>



<a name="818481"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818481" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818481">(Feb 19 2020 at 16:22)</a>:</h4>
<p><a href="/user_uploads/2/f3/5AhBTZMaufRSY8RdFOWJuLZa/image.png" target="_blank" title="image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/f3/5AhBTZMaufRSY8RdFOWJuLZa/image.png" target="_blank" title="image.png"><img src="/user_uploads/2/f3/5AhBTZMaufRSY8RdFOWJuLZa/image.png"></a></div>



<a name="818482"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818482" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818482">(Feb 19 2020 at 16:23)</a>:</h4>
<p>nothing happens after sending :)<br>
<a href="/user_uploads/2/87/Urrb2OqCliFrIYiPt6fUzg9N/image.png" target="_blank" title="image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/87/Urrb2OqCliFrIYiPt6fUzg9N/image.png" target="_blank" title="image.png"><img src="/user_uploads/2/87/Urrb2OqCliFrIYiPt6fUzg9N/image.png"></a></div>



<a name="818483"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818483" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818483">(Feb 19 2020 at 16:41)</a>:</h4>
<p><span class="user-mention" data-user-id="14868">@Максим Декин</span> can you show /var/log/zulip/errors.log and and what gets generated in /var/log/zulip/server.log when you do this?</p>



<a name="818816"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818816" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818816">(Feb 20 2020 at 06:23)</a>:</h4>
<p>in django.log<br>
2020-02-20 06:10:57.713 INFO [zr] 172.17.230.153  GET     302  32ms (db: 1ms/1q) /login/saml/ (unauth via ?)<br>
[pid: 171|app: 0|req: 600/1171] 172.23.0.1 () {68 vars in 1485 bytes} [Thu Feb 20 06:10:57 2020] GET /login/saml/subdomain=&amp;is_signup=0&amp;multiuse_object_key=&amp;idp=idp_name =&gt; generated 0 bytes in 34 msecs (HTTP/1.1 302) 8 headers in 434 bytes (2 switches on core 0)<br>
2020-02-20 06:10:57.744 INFO [zr] 172.17.230.153  GET     200  13ms (db: 2ms/1q) /login/ (unauth via ?)</p>
<p>the same in server.log<br>
2020-02-20 06:10:57.667 INFO [zr] 172.17.230.153  GET     302   1ms /accounts/login/social/saml/idp_name (unauth via ?)<br>
2020-02-20 06:10:57.682 INFO [] /login/saml/ : Bad idp param.<br>
2020-02-20 06:10:57.713 INFO [zr] 172.17.230.153  GET     302  32ms (db: 1ms/1q) /login/saml/ (unauth via ?)<br>
2020-02-20 06:10:57.744 INFO [zr] 172.17.230.153  GET     200  13ms (db: 2ms/1q) /login/ (unauth via ?)</p>
<p>no entries in file in error.log</p>



<a name="818817"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818817" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818817">(Feb 20 2020 at 06:25)</a>:</h4>
<p><a href="/user_uploads/2/97/Wd7fEXmoJTUmJSX2RsjpjLtJ/image.png" target="_blank" title="image.png">image.png</a> <br>
Setting on the idp side</p>
<div class="message_inline_image"><a href="/user_uploads/2/97/Wd7fEXmoJTUmJSX2RsjpjLtJ/image.png" target="_blank" title="image.png"><img src="/user_uploads/2/97/Wd7fEXmoJTUmJSX2RsjpjLtJ/image.png"></a></div>



<a name="818834"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818834" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818834">(Feb 20 2020 at 10:48)</a>:</h4>
<p>Can you try with this patch:</p>
<div class="codehilite"><pre><span></span>diff --git a/zproject/backends.py b/zproject/backends.py
index 771a21f980..75696657db 100644
--- a/zproject/backends.py
+++ b/zproject/backends.py
@@ -1392,10 +1392,10 @@ class SAMLAuthBackend(SocialAuthMixin, SAMLAuth):
         try:
             idp_name = self.strategy.request_data()[&#39;idp&#39;]
             auth = self._create_saml_auth(idp=self.get_idp(idp_name))
-        except KeyError:
+        except KeyError as e:
             # If the above raise KeyError, it means invalid or no idp was specified,
             # we should log that and redirect to the login page.
-            logging.info(&quot;/login/saml/ : Bad idp param.&quot;)
+            logging.info(&quot;/login/saml/ : Bad idp param: {}.&quot;.format(e))
             return reverse(&#39;zerver.views.auth.login_page&#39;,
                            kwargs = {&#39;template_name&#39;: &#39;zerver/login.html&#39;})
</pre></div>


<p>and see the logs generated with that? The point of this is to make the error log a bit more informative.</p>



<a name="818898"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818898" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818898">(Feb 20 2020 at 14:39)</a>:</h4>
<p>patch applied. thx it helps to find out the reason!<br>
error : Bad idp param: 'IDP must contain x509cert or x509certMulti'</p>



<a name="818908"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818908" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818908">(Feb 20 2020 at 15:01)</a>:</h4>
<p>Are things working after fixing that cert issue?</p>



<a name="818913"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818913" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818913">(Feb 20 2020 at 15:15)</a>:</h4>
<p>No ) I fix permission for cert<br>
I run Zulip in Docker so I can not change owner for /etc/zulip/saml/ beacause zulip user is not exist in host OS (outside the container). To fix it I had to change permission on cert on 777<br>
nothing changed, I can not login via SAML. BUT errors dissapeared from logs :( and I can not see what is going on  :(</p>



<a name="818914"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818914" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818914">(Feb 20 2020 at 15:24)</a>:</h4>
<p>So nothing is getting logged now, but you're getting redirected back to the login page?</p>
<p>Are the attribute statements configured correctly?</p>



<a name="818915"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818915" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818915">(Feb 20 2020 at 15:26)</a>:</h4>
<p>Though something should probably be getting logged if it was about attribute statements <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="818916"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818916" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818916">(Feb 20 2020 at 15:30)</a>:</h4>
<p>good question :)<br>
I tried to correlate the settings from the example with my settings. That's what came out of it.<br>
in setting.py I didnt change any parametrs:<br>
<a href="/user_uploads/2/14/FntJUGsdhjJCx_1kL0Duo21z/image.png" target="_blank" title="image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/14/FntJUGsdhjJCx_1kL0Duo21z/image.png" target="_blank" title="image.png"><img src="/user_uploads/2/14/FntJUGsdhjJCx_1kL0Duo21z/image.png"></a></div>



<a name="818918"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818918" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818918">(Feb 20 2020 at 15:34)</a>:</h4>
<p>on the Idp side:<br>
<a href="/user_uploads/2/7a/gsMt6VJQ7O-VyRhuvJMU9CZa/image.png" target="_blank" title="image.png">image.png</a><br>
or instead email, last_name, first_name do I have to put something esle?</p>
<div class="message_inline_image"><a href="/user_uploads/2/7a/gsMt6VJQ7O-VyRhuvJMU9CZa/image.png" target="_blank" title="image.png"><img src="/user_uploads/2/7a/gsMt6VJQ7O-VyRhuvJMU9CZa/image.png"></a></div>



<a name="818919"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818919" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818919">(Feb 20 2020 at 15:36)</a>:</h4>
<p>I will try to reboot container  at this nigth :) now users are working...</p>



<a name="818920"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818920" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818920">(Feb 20 2020 at 15:36)</a>:</h4>
<p>That should probably be correct.<br>
There really is absolutely no message getting logged now on login attempts? <span aria-label="hear no evil" class="emoji emoji-1f649" role="img" title="hear no evil">:hear_no_evil:</span> Once we figure out what this issue is, I'll make sure this case is covered by some logging <span aria-label="confounded" class="emoji emoji-1f616" role="img" title="confounded">:confounded:</span></p>



<a name="818921"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818921" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818921">(Feb 20 2020 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/818914" title="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/818914">said</a>:</p>
<blockquote>
<p>So nothing is getting logged now, but you're getting redirected back to the login page?</p>
<p>Are the attribute statements configured correctly?</p>
</blockquote>
<p>yes. I was redirected back to login page...</p>



<a name="818922"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/818922" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#818922">(Feb 20 2020 at 15:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/818920" title="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/818920">said</a>:</p>
<blockquote>
<p>That should probably be correct.<br>
There really is absolutely no message getting logged now on login attempts? <span aria-label="hear no evil" class="emoji emoji-1f649" role="img" title="hear no evil">:hear_no_evil:</span> Once we figure out what this issue is, I'll make sure this case is covered by some logging <span aria-label="confounded" class="emoji emoji-1f616" role="img" title="confounded">:confounded:</span></p>
</blockquote>
<p>After the reboot, I will still investigate</p>



<a name="819420"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/819420" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#819420">(Feb 21 2020 at 09:55)</a>:</h4>
<p>After reboot I can see errors again.<br>
the same error: /login/saml/ : Bad idp param: 'IDP must contain x509cert or x509certMulti'. <br>
There is only one cert in /etc/zulip/saml/idps/ <br>
It is the public cert of Idp - zchat.crt<br>
I`ve got it by export from wso2carbon.jks (Java key store in WSO2IS )<br>
export command: keytool -export -alias wso2carbon.cert -keystore wso2carbon.jks -file zchat.crt<br>
wso2carbon.cert is chosen in SP settings on the Idp side.<br>
<a href="/user_uploads/2/c7/_uYYBP-FvPuiUxH9KhVY_87-/image.png" target="_blank" title="image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/c7/_uYYBP-FvPuiUxH9KhVY_87-/image.png" target="_blank" title="image.png"><img src="/user_uploads/2/c7/_uYYBP-FvPuiUxH9KhVY_87-/image.png"></a></div>



<a name="819597"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/819597" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#819597">(Feb 21 2020 at 17:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="14868">Максим Декин</span> Did perhaps the file permissions get reset on restart?</p>



<a name="821320"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/821320" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#821320">(Feb 25 2020 at 06:38)</a>:</h4>
<p>No, It didnt. I check every time.</p>



<a name="822164"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822164" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822164">(Feb 26 2020 at 10:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/819597" title="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/819597">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="14868">Максим Декин</span> Did perhaps the file permissions get reset on restart?</p>
</blockquote>
<p>Hi, I do not lose hope to configure SAML :)<br>
Please answer the questions, it make me clear about saml configuration in zulip. </p>
<p>SOCIAL_AUTH_SAML_ENABLED_IDPS as dict can contains more the one saml configuration, isnt it?<br>
if so, "idp_name" - I can set any name, isnt it? (even if I have only one saml configuration)</p>
<p>Do I need to chage "idp_name"? Because in documentation I see: "The "x509cert" attribute is automatically read from /etc/zulip/saml/idps/{idp_name}.crt"</p>
<p>for example: I need give the name "myidp" instead of "idp_name" then I heed to rename my cert file to "myidp.crt", Is it right?<br>
If no, then what name do I give to my crtificate file.</p>
<p>And question about "entity_id" - What is that if it is not a idp name on the saml provider side? What do I need to set?</p>
<p>SOCIAL_AUTH_SAML_ENABLED_IDPS = {<br>
    "idp_name": {<br>
        # Configure entity_id and url according to information provided to you by your IdP:<br>
        "entity_id": "zchat",<br>
        "url": "<a href="https://is.vols-vl.ru/samlsso" target="_blank" title="https://is.vols-vl.ru/samlsso">https://is.vols-vl.ru/samlsso</a>",<br>
        # The part below corresponds to what's likely referred to as something like<br>
        # "Attribute Statements" (with Okta as your IdP) or "Attribute Mapping" (with G Suite).<br>
        # The names on the right side need to correspond to the names under which<br>
        # the IdP will send the user attributes. With these defaults, it's expected<br>
        # that the user's email will be sent with the "email" attribute name,<br>
        # the first name and the last name with the "first_name", "last_name" attribute names.<br>
        "attr_user_permanent_id": "email",<br>
        "attr_first_name": "first_name",<br>
        "attr_last_name": "last_name",<br>
        "attr_username": "email",<br>
        "attr_email": "email",<br>
        # The "x509cert" attribute is automatically read from<br>
        # /etc/zulip/saml/idps/{idp_name}.crt; don't specify it here.<br>
        "display_name": "Auth SAML in VOLS",<br>
    }<br>
}</p>



<a name="822231"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822231" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822231">(Feb 26 2020 at 15:18)</a>:</h4>
<p><span class="user-mention" data-user-id="14868">@Максим Декин</span> Yes, the .crt file name needs to match the name. <code>"entity_id"</code> is the standard SAML <code>EntityId</code> attribute (of the IdP)  - <a href="https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata" target="_blank" title="https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata">https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata</a> - you should be able to get it from the IdP.</p>



<a name="822612"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822612" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822612">(Feb 27 2020 at 07:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822231" title="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822231">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="14868">Максим Декин</span> Yes, the .crt file name needs to match the name. <code>"entity_id"</code> is the standard SAML <code>EntityId</code> attribute (of the IdP)  - <a href="https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata" target="_blank" title="https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata">https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata</a> - you should be able to get it from the IdP.</p>
</blockquote>
<p>You sad - Yes, the .crt file name needs to match the name. "entity_id" -  But it`s wrong :) In Documentation <a href="https://zulip.readthedocs.io/en/latest/production/authentication-methods.html" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/authentication-methods.html">https://zulip.readthedocs.io/en/latest/production/authentication-methods.html</a> We can see that .crt file name needs to match the "idp_name" not "entity_id" . Please look at docs.<br>
so, let me repeat question: Do I need change "idp_name" in the section SOCIAL_AUTH_SAML_ENABLED_IDPS = {} of the setting.py? What is "idp_name " ? What the name do I have to set as "idp_name"?</p>
<p>There are no questions about "entity_id" :)</p>



<a name="822656"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822656" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822656">(Feb 27 2020 at 09:27)</a>:</h4>
<p>I guess "idp_name" does not mean anything important, so I changed it to "zulip" and renamed .crt file to zulip.crt<br>
and Now SAML auth is working, but only for existed users. I mean, if user is registered, I can login to app, otherwise application invites to register new user.<br>
<a href="/user_uploads/2/5d/KLX-6hQrp4P9_YD7z_M_kVko/image.png" target="_blank" title="image.png">image.png</a><br>
I click continiue and I'am getting redirected back to login page.</p>
<div class="message_inline_image"><a href="/user_uploads/2/5d/KLX-6hQrp4P9_YD7z_M_kVko/image.png" target="_blank" title="image.png"><img src="/user_uploads/2/5d/KLX-6hQrp4P9_YD7z_M_kVko/image.png"></a></div><p>what's logs can help to get clear? What does not allow to register a new user after SAML auth ?</p>



<a name="822657"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822657" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822657">(Feb 27 2020 at 09:43)</a>:</h4>
<blockquote>
<p>Yes, the .crt file name needs to match the name. "entity_id" is the standard SAML EntityId attribute (of the IdP) - <a href="https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata" target="_blank" title="https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata">https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata</a> - you should be able to get it from the IdP.</p>
</blockquote>
<p>Those were answers to your two questions - you asked about .crt file name, and about what "entity_id" is <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span>  </p>
<p>Hmm, I'm not aware of any registration-specific issues. Could this be an issue with your organization settings not allowing registration? If not, can you check the logs again?</p>



<a name="822663"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822663" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822663">(Feb 27 2020 at 10:35)</a>:</h4>
<p>Could this be an issue with your organization settings not allowing registration? - I haven't seen any setting in "Organisation Setting" to manage user registration (allow/disallow and so on). I could`n find in documentation too. Where is this setting?</p>
<p>-----LOG-----<br>
2020-02-27 10:17:00.277 INFO [zr] 172.17.230.153  GET     200  30ms (db: 3ms/6q) /accounts/do_confirm/beg4t6vogl4f83tv4t9xrzxf (unauth via ?)<br>
[pid: 6199|app: 0|req: 16/42] 172.23.0.1 () {70 vars in 1736 bytes} [Thu Feb 27 10:17:00 2020] GET /accounts/do_confirm/beg4t6vogl4f83tv4t9xrzxf?full_name=officeadmin+officeadmin =&gt; generated 2450 bytes in 32 msecs (HTTP/1.1 200) 5 headers in 319 bytes (1 switches on core 0)</p>
<p>2020-02-27 10:17:00.381 DEBG [django_auth_ldap] search_s('ou=Users,ou=Uvv,dc=ot,dc=ru', 2, '(mail=%(email)s)') returned 1 objects: cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru<br>
2020-02-27 10:17:00.395 DEBG [django_auth_ldap] search_s('ou=Users,ou=Uvv,dc=ot,dc=ru', 2, '(mail=%(user)s)') returned 1 objects: cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru<br>
2020-02-27 10:17:00.402 DEBG [django_auth_ldap] search_s('cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru', 0, '(objectClass=*)') returned 1 objects: cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru<br>
2020-02-27 10:17:00.457 DEBG [django_auth_ldap] search_s('ou=Users,ou=Uvv,dc=ot,dc=ru', 2, '(mail=%(email)s)') returned 1 objects: cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru</p>
<p>2020-02-27 10:17:00.458 DEBG [django_auth_ldap] Rejecting empty password for <a href="mailto:officeadmin@rosseti.digital" title="mailto:officeadmin@rosseti.digital">officeadmin@rosseti.digital</a></p>
<p>2020-02-27 10:17:00.471 INFO [zr] 172.17.230.153  POST    302 116ms (db: 9ms/7q) /accounts/register/ (unauth via ?)<br>
[pid: 6196|app: 0|req: 4/43] 172.23.0.1 () {76 vars in 1571 bytes} [Thu Feb 27 10:17:00 2020] POST /accounts/register/ =&gt; generated 0 bytes in 118 msecs (HTTP/1.1 302) 6 headers in 376 bytes (1 switches on core 0)</p>
<p>2020-02-27 10:17:00.540 INFO [zr] 172.17.230.153  GET     200  57ms (db: 1ms/1q) /accounts/login/ (unauth via ?)<br>
[pid: 6199|app: 0|req: 17/44] 172.23.0.1 () {70 vars in 1480 bytes} [Thu Feb 27 10:17:00 2020] GET /accounts/login/?email=officeadmin%40rosseti.digital =&gt; generated 10102 bytes in 60 msecs (HTTP/1.1 200) 7 headers in 423 bytes (1 switches on core 0)</p>
<p>---END LOG----<br>
Whay after SAML auth does zulip try LDAP? Of couse password is empty, password exists in saml flow only.</p>
<p>P.S. If I login via LDAP from begin, then new user registeration is successfully.  LDAP works always because I have to fill password feald in the login form  :)</p>



<a name="822665"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822665" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822665">(Feb 27 2020 at 11:01)</a>:</h4>
<ol>
<li>Do you have your ldap config with the LDAP_APPEND_DOMAIN?</li>
<li>Does this user exist in ldap?</li>
</ol>
<p>For the registration settings, can you go to Manage organization -&gt; Organization permissions? These settings could be relevant:<br>
<a href="/user_uploads/2/28/VL12ZmGSJ1o_I9PCRu7dHzMa/image.png" target="_blank" title="image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/28/VL12ZmGSJ1o_I9PCRu7dHzMa/image.png" target="_blank" title="image.png"><img src="/user_uploads/2/28/VL12ZmGSJ1o_I9PCRu7dHzMa/image.png"></a></div>



<a name="822666"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822666" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822666">(Feb 27 2020 at 11:04)</a>:</h4>
<p>upd. I got working registration user after SAML auth<br>
To get SAML auth work correctly including user registration, It is necessary to enable only SAML auth backend.<br>
 In documentation <a href="https://zulip.readthedocs.io/en/latest/production/authentication-methods.html" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/authentication-methods.html">https://zulip.readthedocs.io/en/latest/production/authentication-methods.html</a></p>
<ol start="6">
<li>Enable the zproject.backends.SAMLAuthBackend auth backend, in AUTHENTICATION_BACKENDS in /etc/zulip/settings.py.</li>
</ol>
<p>Shoud be changed to:<br>
Enable the zproject.backends.SAMLAuthBackend auth backend, in AUTHENTICATION_BACKENDS in /etc/zulip/settings.py.  AND DISABLE ANY OTHERS.</p>
<p>for example:<br>
AUTHENTICATION_BACKENDS = (<br>
    #'zproject.backends.EmailAuthBackend',  # Email and password; just requires SMTP setup<br>
    # 'zproject.backends.GoogleAuthBackend',  # Google auth, setup below<br>
    # 'zproject.backends.GitHubAuthBackend',  # GitHub auth, setup below<br>
    # 'zproject.backends.AzureADAuthBackend',  # Microsoft Azure Active Directory auth, setup below<br>
    'zproject.backends.SAMLAuthBackend', # SAML, setup below<br>
    #'zproject.backends.ZulipLDAPAuthBackend',  # LDAP, setup below<br>
    # 'zproject.backends.ZulipRemoteUserBackend',  # Local SSO, setup docs on readthedocs<br>
)  # type: Tuple[str, ...]</p>



<a name="822667"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822667" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822667">(Feb 27 2020 at 11:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822231" title="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822231">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="14868">Максим Декин</span> Yes, the .crt file name needs to match the name. <code>"entity_id"</code> is the standard SAML <code>EntityId</code> attribute (of the IdP)  - <a href="https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata" target="_blank" title="https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata">https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata</a> - you should be able to get it from the IdP.</p>
</blockquote>
<p>It is not obvious that I have to change the "idp_name" of SOCIAL_AUTH_SAML_ENABLED_IDPS  in setting.py to something, and  rename the certificate according to that. "idp_name" seems a parameter that cannot be changed.</p>



<a name="822669"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822669" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822669">(Feb 27 2020 at 11:25)</a>:</h4>
<blockquote>
<p>It is not obvious that I have to change the "idp_name" of SOCIAL_AUTH_SAML_ENABLED_IDPS in setting.py to something, and rename the certificate according to that. "idp_name" seems a parameter that cannot be changed.</p>
</blockquote>
<p>I'll try to improve those instructions, thanks!</p>
<blockquote>
<p>To get SAML auth work correctly including user registration, It is necessary to enable only SAML auth backend.</p>
</blockquote>
<p>It's not quite that way. SAML has no problem with other backends. What I believe was the issue here was that this SAML user is in your ldap directory (unless I'm wrong in this assumption?). Users that are in ldap can only be managed by the ldap backend, so trying to access them via other backends may not work. That's why disabling the ldap backend fixed the issue for you.</p>



<a name="822674"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822674" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822674">(Feb 27 2020 at 12:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822669" title="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822669">said</a>:</p>
<blockquote>
<blockquote>
<p>It is not obvious that I have to change the "idp_name" of SOCIAL_AUTH_SAML_ENABLED_IDPS in setting.py to something, and rename the certificate according to that. "idp_name" seems a parameter that cannot be changed.</p>
</blockquote>
<p>I'll try to improve those instructions, thanks!</p>
<blockquote>
<p>To get SAML auth work correctly including user registration, It is necessary to enable only SAML auth backend.</p>
</blockquote>
<p>It's not quite that way. SAML has no problem with other backends. What I believe was the issue here was that this SAML user is in your ldap directory (unless I'm wrong in this assumption?). Users that are in ldap can only be managed by the ldap backend, so trying to access them via other backends may not work. That's why disabling the ldap backend fixed the issue for you.</p>
</blockquote>
<p>You are right. It is the same domain/ldap and the same user.  But it's not obvious  that I can not use both backend. As usual organisation have one LDAP/AD. At the beginig the admin configures LDAP as the easiest way. Next, if organisation want to use saml, admin start configuring SAML auth and face the challenge :) he doesn't know that he must disable LDAP auth backend. <br>
I think it must to be in documentation too.</p>
<p>Anyway, I'm appreciated you support. I don’t think I would solve SAML problems without your help. Thank you very much!</p>



<a name="822699"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/822699" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#822699">(Feb 27 2020 at 14:28)</a>:</h4>
<p>We have a TODO in the code to show a proper error message in this case (user trying to register via non-ldap backend, with an email that belongs to ldap). Time to fix that I guess <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span> I'll add it to the top of my queue, since it should be very fast.</p>



<a name="823473"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/823473" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#823473">(Feb 28 2020 at 16:20)</a>:</h4>
<p><span class="user-mention" data-user-id="14868">@Максим Декин</span> I looked through our doc and see that in <a href="https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#saml" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#saml">https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#saml</a> point 3, we do mention:</p>
<blockquote>
<p>Set the outer idp_name key to be an identifier for your IdP, e.g. testshib or okta. This field appears in URLs for parts of your Zulip server’s SAML authentication flow</p>
</blockquote>
<p>Does that sound okay and you simply missed it by accident, or could we make this stuff clearer somehow?</p>



<a name="823496"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/823496" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Максим Декин <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#823496">(Feb 28 2020 at 17:30)</a>:</h4>
<p>first of all english is not my native and I can misunderstandin something. I'll try explain about wso2is provider :)</p>
<p>"Set the outer idp_name key to be an identifier for your IdP" - Yes, I saw it, but the fact is that it was not clear wich setting in WSO2IS is identifier for IdP.<br>
I guess that it can be any name and should not correspond to any settings in WSO2IS, so I used the same name (zchat) on both sides as a precaution :) </p>
<p>"The IdP should provide the url and entity_id values." - This also caused some difficulty in understanding. This parameter we can see only in IdP's metadata.xml by URL. At the begin I tryed to set it as "zchat" I thought it is Service Provider Name (see the screen)<br>
<a href="/user_uploads/2/10/gZGl-Wikf48jSUd8StVQRylz/image.png" target="_blank" title="image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/10/gZGl-Wikf48jSUd8StVQRylz/image.png" target="_blank" title="image.png"><img src="/user_uploads/2/10/gZGl-Wikf48jSUd8StVQRylz/image.png"></a></div>



<a name="1224790"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224790" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224790">(Jul 04 2021 at 07:41)</a>:</h4>
<p>hi, hope its ok to "hijack" this topic? but it fits exactly.. if not, let me know and i create a new one..</p>
<p>i got the two (zulip, keycloak) linked and it redirects me to my keycloak to sign in.. i sign in, get redirected back and land on the login page.. the auth log tells me:</p>
<p><code>WARN [zulip.auth.saml] SAML got invalid email argument.</code></p>
<p>and i googled the hell outta it.. some say they changed the names to saml identity names, some say, i need to configure my idp to actually send the attributes.. but there is nothing on how to do that and how to figure out the saml identity names..</p>
<p>i am using the latest keycloak (14.0.0) and the latest zulip (4.3)</p>
<p>does anyone a hint maybe on what i screwed up?</p>



<a name="1224807"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224807" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224807">(Jul 04 2021 at 13:05)</a>:</h4>
<p><span class="user-mention" data-user-id="20964">@Andreas</span> Sorry for the delay, I noticed your question on github but couldn't answer at that moment. I guess your problem is with the keycloak mapper for your email property. I am still using Keycloak 13 but I don't think that they changed something essential in the meanwhile. </p>
<p>First take a look at my configuration of zulip SAML: <a href="/user_uploads/2/c1/SaflvFLCX9dEbe-V4lNB58mW/Bildschirmfoto-2021-07-04-um-14.58.06.png">Bildschirmfoto-2021-07-04-um-14.58.06.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/2/c1/SaflvFLCX9dEbe-V4lNB58mW/Bildschirmfoto-2021-07-04-um-14.58.06.png" title="Bildschirmfoto-2021-07-04-um-14.58.06.png"><img src="/user_uploads/2/c1/SaflvFLCX9dEbe-V4lNB58mW/Bildschirmfoto-2021-07-04-um-14.58.06.png"></a></div><p>Notice that <code>attribute_user_permanent_id</code> does not work yet, as Zulip always takes the email attribute as permanent ID. I think, <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> said they wanted to support this feature soon, so SAML users are able to change their email addresses.</p>
<p>Second, have a look at my configuration of the mail mapper: <a href="/user_uploads/2/a4/BgUgsF_WGRB9_khAnCI7kgAP/Bildschirmfoto-2021-07-04-um-15.03.01.png">Bildschirmfoto-2021-07-04-um-15.03.01.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/a4/BgUgsF_WGRB9_khAnCI7kgAP/Bildschirmfoto-2021-07-04-um-15.03.01.png" title="Bildschirmfoto-2021-07-04-um-15.03.01.png"><img src="/user_uploads/2/a4/BgUgsF_WGRB9_khAnCI7kgAP/Bildschirmfoto-2021-07-04-um-15.03.01.png"></a></div>



<a name="1224809"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224809" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224809">(Jul 04 2021 at 13:18)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="20570">@Lumrenion</span> ! thx again.. nah, no need to sorry.. i just didnt wanna annoy and thought maybe someone else in here has an idea..</p>
<p>i set up the mapper and double checked the config.. now it doesnt complain about the email anymore but throws me to: <a href="/user_uploads/2/79/47CI226Cmv17iBcYWL9L581w/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/2/79/47CI226Cmv17iBcYWL9L581w/image.png" title="image.png"><img src="/user_uploads/2/79/47CI226Cmv17iBcYWL9L581w/image.png"></a></div><p>error log tells me:</p>
<div class="codehilite"><pre><span></span><code>2021-07-04 13:17:57.622 ERR  [django.request] Internal Server Error: /complete/saml/
Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/exception.py&quot;, line 47, in inner
    response = get_response(request)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py&quot;, line 181, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/cache.py&quot;, line 44, in _wrapped_view_func
    response = view_func(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/csrf.py&quot;, line 54, in wrapped_view
    return view_func(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_django/utils.py&quot;, line 49, in wrapper
    return func(request, backend, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_django/views.py&quot;, line 31, in complete
    return do_complete(request.backend, _do_login, user=request.user,
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/actions.py&quot;, line 45, in do_complete
    user = backend.complete(user=user, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py&quot;, line 40, in complete
    return self.auth_complete(*args, **kwargs)
  File &quot;/home/zulip/deployments/2021-07-01-17-34-40/./zproject/backends.py&quot;, line 2204, in auth_complete
    result = super().auth_complete(*args, **kwargs)
  File &quot;/home/zulip/deployments/2021-07-01-17-34-40/./zproject/backends.py&quot;, line 1610, in auth_complete
    return super().auth_complete(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/saml.py&quot;, line 333, in auth_complete
    return self.strategy.authenticate(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_django/strategy.py&quot;, line 107, in authenticate
    return authenticate(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/debug.py&quot;, line 42, in sensitive_variables_wrapper
    return func(*func_args, **func_kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/auth/__init__.py&quot;, line 76, in authenticate
    user = backend.authenticate(request, **credentials)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py&quot;, line 80, in authenticate
    return self.pipeline(pipeline, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py&quot;, line 83, in pipeline
    out = self.run_pipeline(pipeline, pipeline_index, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py&quot;, line 113, in run_pipeline
    result = func(*args, **out) or {}
  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/pipeline/partial.py&quot;, line 30, in wrapper
    out = func(strategy=strategy,
  File &quot;/home/zulip/deployments/2021-07-01-17-34-40/./zproject/backends.py&quot;, line 1443, in social_auth_associate_user
    user_profile = social_associate_user_helper(backend, return_data, *args, **kwargs)
  File &quot;/home/zulip/deployments/2021-07-01-17-34-40/./zproject/backends.py&quot;, line 1417, in social_associate_user_helper
    raise AssertionError(&quot;Social auth backend doesn&#39;t provide name&quot;)
AssertionError: Social auth backend doesn&#39;t provide name
</code></pre></div>
<p>meine dankbarkeit würde dich ewig verfolgen, wenn du darauf auch ne antwort hättest :D</p>



<a name="1224810"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224810" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224810">(Jul 04 2021 at 13:23)</a>:</h4>
<p>is there a way to dump out the response from the auth server? to see like what it actually sends out?<br>
i kinda feel like flying blind..</p>



<a name="1224811"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224811" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224811">(Jul 04 2021 at 13:24)</a>:</h4>
<p>I had this error with my keycloak test account. Turned out, that account did not have a first name and last name. Once set, I was able to log in with that account. So make sure your keyclak user you are trying to login with has those two attributes filled and double check your attribute mappers for those too:<br>
<a href="/user_uploads/2/e8/kaRcuW5xLwPTIcCVgiuEOlqt/Bildschirmfoto-2021-07-04-um-15.23.01.png">Bildschirmfoto-2021-07-04-um-15.23.01.png</a> <a href="/user_uploads/2/f1/hMd7qEml14rdtj0cHM69_U7W/Bildschirmfoto-2021-07-04-um-15.23.09.png">Bildschirmfoto-2021-07-04-um-15.23.09.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/e8/kaRcuW5xLwPTIcCVgiuEOlqt/Bildschirmfoto-2021-07-04-um-15.23.01.png" title="Bildschirmfoto-2021-07-04-um-15.23.01.png"><img src="/user_uploads/2/e8/kaRcuW5xLwPTIcCVgiuEOlqt/Bildschirmfoto-2021-07-04-um-15.23.01.png"></a></div><div class="message_inline_image"><a href="/user_uploads/2/f1/hMd7qEml14rdtj0cHM69_U7W/Bildschirmfoto-2021-07-04-um-15.23.09.png" title="Bildschirmfoto-2021-07-04-um-15.23.09.png"><img src="/user_uploads/2/f1/hMd7qEml14rdtj0cHM69_U7W/Bildschirmfoto-2021-07-04-um-15.23.09.png"></a></div>



<a name="1224812"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224812" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224812">(Jul 04 2021 at 13:24)</a>:</h4>
<p>awesome, thx man! very much appreciate your help here!</p>



<a name="1224814"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224814" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224814">(Jul 04 2021 at 13:25)</a>:</h4>
<p>do you also have a mapper for username? is it just <code>username</code> or is it <code>userName</code>?</p>



<a name="1224815"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224815" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224815">(Jul 04 2021 at 13:26)</a>:</h4>
<p><a href="/user_uploads/2/a7/rZPBRgbBBKRUEkaNApX6kqub/Bildschirmfoto-2021-07-04-um-15.26.15.png">Bildschirmfoto-2021-07-04-um-15.26.15.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/a7/rZPBRgbBBKRUEkaNApX6kqub/Bildschirmfoto-2021-07-04-um-15.26.15.png" title="Bildschirmfoto-2021-07-04-um-15.26.15.png"><img src="/user_uploads/2/a7/rZPBRgbBBKRUEkaNApX6kqub/Bildschirmfoto-2021-07-04-um-15.26.15.png"></a></div>



<a name="1224817"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224817" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224817">(Jul 04 2021 at 13:27)</a>:</h4>
<p>k, had it set that way.. thx!</p>



<a name="1224818"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224818" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224818">(Jul 04 2021 at 13:27)</a>:</h4>
<p>ah and... it works!!</p>



<a name="1224819"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224819" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224819">(Jul 04 2021 at 13:27)</a>:</h4>
<p>all those sweat and tears..</p>



<a name="1224822"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224822" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224822">(Jul 04 2021 at 13:35)</a>:</h4>
<p>I am glad I can contribute to this project with my experience and support at least <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1224852"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224852" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224852">(Jul 04 2021 at 14:44)</a>:</h4>
<p>Ahh interesting - perhaps zulip should handle the edge case of the IdP sending an empty name instead of throwing this error.</p>



<a name="1224865"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1224865" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1224865">(Jul 04 2021 at 14:58)</a>:</h4>
<p>It is common practice in several software to use the username as fallback display name if other names are empty. But if I remember correctly, we noticed that the username, which has a mapping configuration in Zulips SAML configuration, does not currently get saved in the Zulip database</p>



<a name="1225215"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1225215" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1225215">(Jul 05 2021 at 19:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="20570">Lumrenion</span> <a href="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/1224865">said</a>:</p>
<blockquote>
<p>It is common practice in several software to use the username as fallback display name if other names are empty. But if I remember correctly, we noticed that the username, which has a mapping configuration in Zulips SAML configuration, does not currently get saved in the Zulip database</p>
</blockquote>
<p>yeah, that's correct.</p>



<a name="1225217"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1225217" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1225217">(Jul 05 2021 at 19:12)</a>:</h4>
<p><span class="user-mention" data-user-id="20570">@Lumrenion</span> it'd be awesome if you'd be up for writing a short writeup for KeyCloak similar to what we have in <code>templates/zerver/help/saml-authentication.md</code> aka <a href="https://zulip.com/help/saml-authentication">https://zulip.com/help/saml-authentication</a> so that we can make this easy for others.</p>



<a name="1225219"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1225219" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1225219">(Jul 05 2021 at 19:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> and I are happy to do an editing pass, it'd just be nice for someone who's done this setup to do an initial writeup (even just in a message here).</p>



<a name="1225711"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1225711" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1225711">(Jul 06 2021 at 06:04)</a>:</h4>
<p>Yes, I will do this. Already did a writeup here <a href="https://github.com/zulip/zulip/issues/18659#issuecomment-855799758">https://github.com/zulip/zulip/issues/18659#issuecomment-855799758</a> and can reformat it to match the docs page. <span class="user-mention" data-user-id="20964">@Andreas</span> can you explain what information exactly was missing for you to get authentication setup on both sides, Zulip and Keycloak, working immediately?</p>



<a name="1225712"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1225712" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1225712">(Jul 06 2021 at 06:09)</a>:</h4>
<p><span class="user-mention" data-user-id="20570">@Lumrenion</span> the main thing was probably that the keycloak keys aint gonna cut it on the zulip side as well as you have to have your own mappers for the user attributes..</p>
<p>AND, thats something i was able to figure out myself ( <span aria-label="party ball" class="emoji emoji-1f38a" role="img" title="party ball">:party_ball:</span> ) you have to remove the default client scope <code>role_list</code>:</p>
<p><a href="user_uploads/2/ba/dlGps56BW2LXd2VTOeG5As8G/image.png">image.png</a></p>
<div class="message_inline_image"><a href="user_uploads/2/ba/dlGps56BW2LXd2VTOeG5As8G/image.png" title="image.png"><img src="user_uploads/2/ba/dlGps56BW2LXd2VTOeG5As8G/image.png"></a></div><p>and have your own role mapper set up:</p>
<p><a href="/user_uploads/2/b8/-qBfpbBQp1iCSmmV4nsiC0Cs/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/b8/-qBfpbBQp1iCSmmV4nsiC0Cs/image.png" title="image.png"><img src="/user_uploads/2/b8/-qBfpbBQp1iCSmmV4nsiC0Cs/image.png"></a></div>



<a name="1225713"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1225713" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1225713">(Jul 06 2021 at 06:20)</a>:</h4>
<p>I think you don‘t even need the roles mapper as Zulip currently does not support group mapping from SAML nor LDAP</p>



<a name="1225715"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1225715" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andreas <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1225715">(Jul 06 2021 at 06:22)</a>:</h4>
<p>ah, ok.. then just removing the scope might do the trick then..</p>



<a name="1226726"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1226726" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1226726">(Jul 07 2021 at 14:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/1224852">said</a>:</p>
<blockquote>
<p>Ahh interesting - perhaps zulip should handle the edge case of the IdP sending an empty name instead of throwing this error.</p>
</blockquote>
<p><a href="https://github.com/zulip/zulip/pull/19152">#19152</a> for fixing this one</p>



<a name="1247759"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1247759" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Cassar <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1247759">(Aug 18 2021 at 01:32)</a>:</h4>
<p>Hi all! Im trying to set up Keycloak SAML with Zulip and running into an issue where it says that authentication needs to be signed, however when i add a zulip pem file generated on the server to the SAML Keys (while also having the keycloak.cert file in the saml folder) I then get <code>Signature validation failed. SAML Response rejected.</code> Ive been debugging for a few hours now and am out of ideas. I'd be happy to provide any necessary info :)</p>



<a name="1247808"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1247808" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1247808">(Aug 18 2021 at 07:05)</a>:</h4>
<p>Hi, did you already check the PR I created to extend the documentation with instructions how to setup keycloak? <a href="https://github.com/zulip/zulip/pull/19245">https://github.com/zulip/zulip/pull/19245</a></p>
<p>The PR also explains, how to setup signed communication between keycloak and zulip</p>



<a name="1248395"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1248395" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1248395">(Aug 20 2021 at 14:02)</a>:</h4>
<p>Speaking of which, what's the status of that PR? I see it has some resolved comments, but is failing CI due to <a href="https://github.com/zulip/zulip/pull/19245/checks?check_run_id=3135454641">some linter errors</a>.  <span class="user-mention" data-user-id="20570">@Lumrenion</span> <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> can one of you clean those up?  I can then do a final polish review and get it integrated.</p>



<a name="1248399"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1248399" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1248399">(Aug 20 2021 at 14:08)</a>:</h4>
<p>If the content is fine and there are only formal errors, I can fix the linter errors. But tbh I don‘t understand, what those mean. It says </p>
<blockquote>
<p>Realms are referred to as Organizations in user-facing docs.</p>
</blockquote>
<p>Does it say I should not use the word „realm“? Well, but those ARE called so in Keycloak 🤷</p>



<a name="1248404"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1248404" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1248404">(Aug 20 2021 at 14:19)</a>:</h4>
<p><span class="user-mention" data-user-id="20570">@Lumrenion</span> ahh, if it's a keycloak concept, we should just add an exclude rule for it.  One can do that in <code>tools/linter_lib/custom_check.py</code> by searching for the error message, but we're happy to take care of that since it's a Zulip expertise thing if you're happy with the language.</p>



<a name="1248408"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1248408" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lumrenion <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1248408">(Aug 20 2021 at 14:20)</a>:</h4>
<p>Alright! I am happy with the language, but you are the native speaker after all :)</p>



<a name="1248417"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1248417" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1248417">(Aug 20 2021 at 15:31)</a>:</h4>
<p><span class="user-mention" data-user-id="20570">@Lumrenion</span> I pushed an update to the PR that addresses a bunch of formatting and language; can you check it for correctness issues I might have introduced?</p>



<a name="1248421"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/SAML/keycloak%20configuration/near/1248421" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration.html#1248421">(Aug 20 2021 at 16:15)</a>:</h4>
<p>Posted some comments as well</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>