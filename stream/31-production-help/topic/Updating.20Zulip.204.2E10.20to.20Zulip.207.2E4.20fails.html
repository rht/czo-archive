<html>
<head><meta charset="utf-8"><title>Updating Zulip 4.10 to Zulip 7.4 fails · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html">Updating Zulip 4.10 to Zulip 7.4 fails</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1647165"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647165" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647165">(Sep 26 2023 at 12:16)</a>:</h4>
<p>Hi all,</p>



<a name="1647166"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647166" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647166">(Sep 26 2023 at 12:18)</a>:</h4>
<p>I have tried to update Zulip 4.10 to Zulip 7.4, but I get the following error in the log:</p>
<div class="codehilite"><pre><span></span><code>Migrations which are currently applied, but missing in the new version:
  zerver - 0297_auto_20210224_0418
2023-09-26 12:12:35.866 ERR  [] This is not an upgrade -- the current deployment (version 4.10) contains 1 database migrations which /home/zulip/deployments/2023-09-26-12-07-12 (version 7.4) does not.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2023-09-26-12-07-12/scripts/lib/upgrade-zulip-stage-2&quot;, line 247, in &lt;module&gt;
    subprocess.check_call(
  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 364, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2023-09-26-12-07-12/scripts/lib/check-database-compatibility&#39;]&#39; returned non-zero exit status 1.
</code></pre></div>
<p>We are running Ubuntu 20.4 LTS and PostgreSQL 12.</p>
<p>Thanks a lot for your help and best regards,</p>
<p>Pascal</p>



<a name="1647178"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647178" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647178">(Sep 26 2023 at 13:10)</a>:</h4>
<p>I was able to update Zulip 4.10 to Zulip 4.11, but afterwards I get the same error again, when I try to update Zulip to 7.4 or 5.6.</p>



<a name="1647208"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647208" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647208">(Sep 26 2023 at 14:17)</a>:</h4>
<p><span class="user-mention" data-user-id="19114">@Pascal Schrafl</span>: Can you show:</p>
<div class="codehilite"><pre><span></span><code>ls ~zulip/deployments/*/zerver/migrations/0297*
</code></pre></div>



<a name="1647223"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647223" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647223">(Sep 26 2023 at 14:34)</a>:</h4>
<p>Hi Alex,</p>
<p>Here's the output:</p>
<div class="codehilite"><pre><span></span><code>user@server:~$ ls ~zulip/deployments/*/zerver/migrations/0297*
/home/zulip/deployments/2022-03-10-11-31-40/zerver/migrations/0297_draft.py
/home/zulip/deployments/2023-09-26-12-45-34/zerver/migrations/0297_draft.py
/home/zulip/deployments/current/zerver/migrations/0297_draft.py
/home/zulip/deployments/last/zerver/migrations/0297_draft.py
/home/zulip/deployments/next/zerver/migrations/0297_draft.py
</code></pre></div>
<p>Cheers, Pascal</p>



<a name="1647236"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647236" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647236">(Sep 26 2023 at 14:54)</a>:</h4>
<p>So it looks like your database has a migration applied to it which was nver part of the official product -- which is why the ugprade process is erroring out, since it's erring on the cautious side, and being worried about what it might be losing by not knowing about that migration.</p>
<p>We have very little way of knowing what was in that migration, unfortunately.  The options here are either to do some minor surgery to forget that there's a mystery migration, or to do more spelunking as to what might be different about your schema.</p>



<a name="1647241"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647241" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647241">(Sep 26 2023 at 14:57)</a>:</h4>
<p>I think it is likely that the migration is safe to ignore, but I don't want to just declare that for you.  IF you know anything about the history of the maintenance of this instance (e.g. was someone working on a customization with database changes?), that might affect your decision.</p>



<a name="1647254"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647254" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647254">(Sep 26 2023 at 15:12)</a>:</h4>
<p>I never changed anything on the database itself. We had some customization done, but this was using the API, not database changes. Would it help, if I would send you those 4 files as private message? In the past, the update always worked flawlessly without any issues, so I can't imagine, that anyone changed anything on the database.</p>



<a name="1647255"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647255" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647255">(Sep 26 2023 at 15:15)</a>:</h4>
<p>No, the 5 files you found are the <em>expected</em> database migration, which is named <code>0297_draft.py</code>.  Django was saying that at some point it had a file named <code>0297_auto_20210224_0418.py</code> installed -- and that name is associated with an automatically generated migration from someone running <code>./manage.py makemigrations</code> which is a step done during development after making modifications to the desired database schema.</p>



<a name="1647256"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647256" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647256">(Sep 26 2023 at 15:17)</a>:</h4>
<p>I think I'd suggest running (as the <code>zulip</code> user):</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/deployments/current
./manage.py<span class="w"> </span>dbshell
</code></pre></div>
<p>And then at that prompt:</p>
<div class="codehilite" data-code-language="SQL"><pre><span></span><code><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">django_migrations</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'zerver'</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'0297_auto_20210224_0418'</span><span class="p">;</span>
<span class="err">\</span><span class="n">q</span>
</code></pre></div>
<p>You should then be able to upgrade without issue.</p>



<a name="1647266"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647266" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647266">(Sep 26 2023 at 15:29)</a>:</h4>
<p>I will try this approach. Is there anything, I must check after that change?</p>



<a name="1647272"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647272" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647272">(Sep 26 2023 at 15:36)</a>:</h4>
<p>Nope.  That command is just adjusting the application's "memory" of what the names of database changes it's seen is.  We're telling it to not worry about having seen that migration, and the upgrade will now no longer flip out because it will no longer see any migration names it doesn't recognize.</p>



<a name="1647274"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647274" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647274">(Sep 26 2023 at 15:37)</a>:</h4>
<p>Thanks a lot! I will give it a try and will keep you posted. And is it correct, it doesn't break anything on the installation or messes up future updates, right?</p>



<a name="1647276"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647276" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647276">(Sep 26 2023 at 15:39)</a>:</h4>
<p>If there <em>were</em> significant changes in the migration we're telling it to forget about, then the upgrade may fail or the application may not work as expected.</p>



<a name="1647341"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647341" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647341">(Sep 26 2023 at 17:21)</a>:</h4>
<p>Hi Alex,</p>
<p>This is the code of the file, that's causing the issues. Perhaps it helps to find the issue. If you need the file 0296_remove_userprofile_short_name, please let me know.</p>
<p>Thanks and cheers,</p>
<p>Pascal</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="c1"># Generated by Django 2.2.14 on 2020-07-23 17:07</span>

<span class="kn">import</span> <span class="nn">django.db.models.deletion</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">migrations</span><span class="p">,</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="o">.</span><span class="n">Migration</span><span class="p">):</span>

    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">"zerver"</span><span class="p">,</span> <span class="s2">"0296_remove_userprofile_short_name"</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">migrations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"Draft"</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span>
                    <span class="s2">"id"</span><span class="p">,</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span>
                        <span class="n">auto_created</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">serialize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">"ID"</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="p">(</span><span class="s2">"topic"</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">60</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">"content"</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()),</span>
                <span class="p">(</span><span class="s2">"last_edit_time"</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                <span class="p">(</span>
                    <span class="s2">"recipient"</span><span class="p">,</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
                        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">on_delete</span><span class="o">=</span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">deletion</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span>
                        <span class="n">to</span><span class="o">=</span><span class="s2">"zerver.Recipient"</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">"user_profile"</span><span class="p">,</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
                        <span class="n">on_delete</span><span class="o">=</span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">deletion</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">),</span>
    <span class="p">]</span>
</code></pre></div>



<a name="1647376"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647376" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647376">(Sep 26 2023 at 17:49)</a>:</h4>
<p><span class="user-mention" data-user-id="19114">@Pascal Schrafl</span>: No, that's not the file that's causing problems.</p>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails/near/1647255">said</a>:</p>
<blockquote>
<p>No, the 5 files you found are the <em>expected</em> database migration, which is named <code>0297_draft.py</code>.  Django was saying that at some point it had a file named <code>0297_auto_20210224_0418.py</code> installed -- and that name is associated with an automatically generated migration from someone running <code>./manage.py makemigrations</code> which is a step done during development after making modifications to the desired database schema.</p>
</blockquote>



<a name="1647377"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647377" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647377">(Sep 26 2023 at 17:49)</a>:</h4>
<p>The command I gave you did not find the file we're looking for, which is <code>0297_auto_20210224_0418.py</code></p>



<a name="1647379"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647379" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647379">(Sep 26 2023 at 17:49)</a>:</h4>
<p>From its datestamp, it was created in February of 2021.</p>



<a name="1647433"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647433" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647433">(Sep 26 2023 at 18:25)</a>:</h4>
<p>Hi Alex,</p>



<a name="1647434"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647434" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647434">(Sep 26 2023 at 18:25)</a>:</h4>
<p>Thanks. I ran the following command:</p>



<a name="1647436"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647436" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647436">(Sep 26 2023 at 18:26)</a>:</h4>
<div class="codehilite"><pre><span></span><code>ls ~zulip/deployments/*/zerver/migrations/0297_auto_20210224_0418.py
ls: cannot access &#39;/home/zulip/deployments/*/zerver/migrations/0297_auto_20210224_0418.py&#39;: No such file or directory
</code></pre></div>
<p>Apparently, that file doesn't exist.</p>



<a name="1647438"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647438" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647438">(Sep 26 2023 at 18:26)</a>:</h4>
<p>Cheers, Pascal</p>



<a name="1647443"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647443" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647443">(Sep 26 2023 at 18:28)</a>:</h4>
<p>Yes, I know the file doesn't exist.  That's what I was attempting to determine <a href="#narrow/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails/near/1647208">when I asked you to run a command earlier</a>.</p>
<p>That's why we don't easily know what the migration had in it.</p>



<a name="1647444"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647444" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647444">(Sep 26 2023 at 18:28)</a>:</h4>
<p>So there is no way to find out, what the content of that file is and what it does?</p>



<a name="1647448"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647448" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647448">(Sep 26 2023 at 18:30)</a>:</h4>
<p>Not easily.  We could try to diff the schema in the database against the schema that we expect it to have (for example, using <a href="https://django-extensions.readthedocs.io/en/latest/sqldiff.html">something like <code>sqldiff</code></a>) but that's not going to trivial -- and from a quick skim of folks using that tool, it has some false-positives, so it's not clear how much help it would be.</p>



<a name="1647454"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647454" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647454">(Sep 26 2023 at 18:34)</a>:</h4>
<p>The weird thing is, that we have it on test and production server. We already updated Zulip before to 4.10 without any issues, so I'm puzzled, why it suddenly happens (especially, as the update from 4.10 to 4.11 works fine, and then it breaks, when I try to update to 5.6 or 7.4).</p>



<a name="1647456"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647456" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647456">(Sep 26 2023 at 18:37)</a>:</h4>
<p>We added the code in 5.0 to check for migrations that the new version doesn't recognize.  This prevents people from accidentally "upgrading" to an older version.  So your upgrade from 4.10 to 4.11 doesn't error out because it doesn't have this protection.</p>



<a name="1647458"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647458" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647458">(Sep 26 2023 at 18:39)</a>:</h4>
<p>I'm just afraid, that it will break something, when we ignore it and later have issues, that we can't fix anymore.</p>



<a name="1647461"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647461" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647461">(Sep 26 2023 at 18:42)</a>:</h4>
<p>You should do some investigation as to who was updating your instance in February 24th, 2021.  They may be able to tell you more about what changes they made to the instance.</p>
<p>I suspect, that if you're not aware of any changes, it's likely fine.  It sounds like you have a test instance -- if that has the same schema and data as your production instance, I suggest <a href="#narrow/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails/near/1647256">doing the fix I suggested above</a>, and upgrading it to 7.x to check it out and see how it goes.</p>
<p>If you don't have a test instance, you can <a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html">take a backup and restore it onto another server</a> to make one.</p>



<a name="1647466"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647466" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647466">(Sep 26 2023 at 18:43)</a>:</h4>
<p>I don't know how much more help we can provide for your instance which has unknown customizations.  Those are the routes forward that I can suggest.</p>
<p>You're welcome to contact <a href="mailto:sales@zulip.com">sales@zulip.com</a> if you'd like a support contract where we can help be more hands-on.</p>



<a name="1647475"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647475" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647475">(Sep 26 2023 at 18:51)</a>:</h4>
<p>Thanks a lot for your help. I will see, what I can do.</p>



<a name="1647973"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647973" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647973">(Sep 27 2023 at 08:57)</a>:</h4>
<p>Hi Alex,</p>



<a name="1647974"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1647974" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pascal Schrafl <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1647974">(Sep 27 2023 at 09:00)</a>:</h4>
<p>I rolled back the server and found the file 0297_auto_20210224_0418.py. Here's the content of it:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="c1"># Generated by Django 2.2.16 on 2021-02-24 04:18</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">migrations</span><span class="p">,</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="o">.</span><span class="n">Migration</span><span class="p">):</span>

    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">'zerver'</span><span class="p">,</span> <span class="s1">'0296_remove_userprofile_short_name'</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">migrations</span><span class="o">.</span><span class="n">AlterField</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="s1">'userprofile'</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">'color_scheme'</span><span class="p">,</span>
            <span class="n">field</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">]</span>
</code></pre></div>
<p>I recall, that one of our developers tried to set the default color to dark mode, and I assume, he ran that change. Can we safely ignore it?</p>
<p>Thanks and cheers,</p>
<p>Pascal</p>



<a name="1648062"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Updating%20Zulip%204.10%20to%20Zulip%207.4%20fails/near/1648062" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails.html#1648062">(Sep 27 2023 at 13:56)</a>:</h4>
<p>For purposes of not blocking the upgrade, yes.</p>
<p>So you should <a href="#narrow/stream/31-production-help/topic/Updating.20Zulip.204.2E10.20to.20Zulip.207.2E4.20fails/near/1647256">remove the record of that migration as detailed above</a>.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>