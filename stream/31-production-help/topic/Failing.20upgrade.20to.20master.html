<html>
<head><meta charset="utf-8"><title>Failing upgrade to master · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html">Failing upgrade to master</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="596873"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/596873" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert Hönig <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#596873">(Jun 08 2018 at 18:04)</a>:</h4>
<div class="codehilite"><pre><span></span>root@zulip-bots-playground:~# /home/zulip/deployments/current/scripts/upgrade-zulip-from-git master
2018-06-08 17:52:33,768 upgrade-zulip-from-git: Fetching the latest commits
2018-06-08 17:52:41,979 upgrade-zulip-stage-2: Upgrading system packages...
Hit:1 http://security.ubuntu.com/ubuntu xenial-security InRelease
Hit:2 http://nyc2.mirrors.digitalocean.com/ubuntu xenial InRelease
Hit:3 http://ppa.launchpad.net/tabbott/zulip/ubuntu xenial InRelease
Hit:4 http://nyc2.mirrors.digitalocean.com/ubuntu xenial-updates InRelease
Hit:5 http://nyc2.mirrors.digitalocean.com/ubuntu xenial-backports InRelease
Reading package lists... Done
Reading package lists... Done
Building dependency tree
Reading state information... Done
Calculating upgrade... Done
The following packages were automatically installed and are no longer required:
  grub-pc-bin linux-headers-4.4.0-104 linux-headers-4.4.0-104-generic linux-headers-4.4.0-108
  linux-headers-4.4.0-108-generic linux-headers-4.4.0-109 linux-headers-4.4.0-109-generic linux-headers-4.4.0-112
  linux-headers-4.4.0-112-generic linux-headers-4.4.0-119 linux-headers-4.4.0-119-generic linux-headers-4.4.0-121
  linux-headers-4.4.0-121-generic linux-image-4.4.0-104-generic linux-image-4.4.0-108-generic
  linux-image-4.4.0-109-generic linux-image-4.4.0-112-generic linux-image-4.4.0-119-generic
  linux-image-4.4.0-121-generic
Use &#39;apt autoremove&#39; to remove them.
The following packages have been kept back:
  open-vm-tools
0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.
+ apt-get -y install build-essential libffi-dev libfreetype6-dev zlib1g-dev libjpeg-dev libldap2-dev libmemcached-dev python3-dev python-dev python3-pip python-pip python-virtualenv python3-six python-six libxml2-dev libxslt1-dev libpq-dev virtualenv
Reading package lists... Done
Building dependency tree
Reading state information... Done
build-essential is already the newest version (12.1ubuntu2).
libffi-dev is already the newest version (3.2.1-4).
libjpeg-dev is already the newest version (8c-2ubuntu8).
libmemcached-dev is already the newest version (1.0.18-4.1).
python-six is already the newest version (1.10.0-3).
python3-dev is already the newest version (3.5.1-3).
python3-six is already the newest version (1.10.0-3).
libfreetype6-dev is already the newest version (2.6.1-0.1ubuntu2.3).
libldap2-dev is already the newest version (2.4.42+dfsg-2ubuntu3.3).
libpq-dev is already the newest version (9.5.13-0ubuntu0.16.04).
libxml2-dev is already the newest version (2.9.3+dfsg1-1ubuntu0.5).
libxslt1-dev is already the newest version (1.1.28-2.1ubuntu0.1).
python-dev is already the newest version (2.7.12-1~16.04).
zlib1g-dev is already the newest version (1:1.2.8.dfsg-2ubuntu4.1).
python-pip is already the newest version (8.1.1-2ubuntu0.4).
python-virtualenv is already the newest version (15.0.1+ds-3ubuntu1).
python3-pip is already the newest version (8.1.1-2ubuntu0.4).
virtualenv is already the newest version (15.0.1+ds-3ubuntu1).
The following packages were automatically installed and are no longer required:
  grub-pc-bin linux-headers-4.4.0-104 linux-headers-4.4.0-104-generic linux-headers-4.4.0-108
  linux-headers-4.4.0-108-generic linux-headers-4.4.0-109 linux-headers-4.4.0-109-generic linux-headers-4.4.0-112
  linux-headers-4.4.0-112-generic linux-headers-4.4.0-119 linux-headers-4.4.0-119-generic linux-headers-4.4.0-121
  linux-headers-4.4.0-121-generic linux-image-4.4.0-104-generic linux-image-4.4.0-108-generic
  linux-image-4.4.0-109-generic linux-image-4.4.0-112-generic linux-image-4.4.0-119-generic
  linux-image-4.4.0-121-generic
Use &#39;apt autoremove&#39; to remove them.
0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.
Using cached Python venv from /srv/zulip-venv-cache/c33157e33f152726906b020807f7608b05fc019e/zulip-py3-venv
+ sudo ln -nsf /srv/zulip-venv-cache/c33157e33f152726906b020807f7608b05fc019e/zulip-py3-venv /home/zulip/deployments/2018-06-08-17-52-33/zulip-py3-venv
+ ln -nsf zulip-py3-venv /home/zulip/deployments/2018-06-08-17-52-33/zulip-current-venv
v8.11.1 is already installed.
Now using node v8.11.1 (npm v5.6.0)
default -&gt; 8.11.1 (-&gt; v8.11.1)
Installing Yarn!
Yarn is already at the 1.7.0 version.
Generated Camo config file /etc/default/camo
generate_secrets: No new secrets to generate.
2018-06-08 17:53:11,998 upgrade-zulip-stage-2: Building static assets...
+ mkdir -p var/log
Cached version not found! Installing node modules.
+ mkdir -p /srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081
+ cp package.json yarn.lock /srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081
+ /home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/cd_exec /srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081 /srv/zulip-yarn/bin/yarn install --non-interactive --prod

Error running a subcommand of ./tools/update-prod-static: /home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/cd_exec /srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081 /srv/zulip-yarn/bin/yarn install --non-interactive --prod
Actual error output for the subcommand is just above this.

Traceback (most recent call last):
  File &quot;./tools/update-prod-static&quot;, line 37, in &lt;module&gt;
    setup_node_modules(production=True, stdout=fp, stderr=fp)
  File &quot;./tools/../scripts/lib/node_cache.py&quot;, line 65, in setup_node_modules
    copy_modules=copy_modules)
  File &quot;./tools/../scripts/lib/node_cache.py&quot;, line 98, in do_yarn_install
    run(cmd, stdout=stdout, stderr=stderr)
  File &quot;./tools/../scripts/lib/zulip_tools.py&quot;, line 163, in run
    subprocess.check_call(args, **kwargs)
  File &quot;/usr/lib/python3.5/subprocess.py&quot;, line 581, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/cd_exec&#39;, &#39;/srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081&#39;, &#39;/srv/zulip-yarn/bin/yarn&#39;, &#39;install&#39;, &#39;--non-interactive&#39;, &#39;--prod&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/upgrade-zulip-stage-2&quot;, line 81, in &lt;module&gt;
    preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python3.5/subprocess.py&quot;, line 581, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./tools/update-prod-static&#39;, &#39;--authors-not-required&#39;, &#39;--prev-deploy&#39;, &#39;/home/zulip/deployments/current&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/scripts/upgrade-zulip-from-git&quot;, line 71, in &lt;module&gt;
    deploy_path, &quot;--from-git&quot;] + deploy_options)
  File &quot;/usr/lib/python3.5/subprocess.py&quot;, line 581, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2018-06-08-17-52-33&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1
</pre></div>


<p>(This is for <a href="http://playground.zulipdev.org" target="_blank" title="http://playground.zulipdev.org">playground.zulipdev.org</a>.)</p>
<p>For some reason a <code>/var/log/zulip/upgrade.log</code> doesn't exist.</p>



<a name="596876"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/596876" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#596876">(Jun 08 2018 at 18:07)</a>:</h4>
<p>check <code>var/log/update-prod-static.log</code> inside <code>/home/zulip/deployments/next</code>.</p>



<a name="597546"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/597546" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert Hönig <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#597546">(Jun 11 2018 at 18:35)</a>:</h4>
<p>I tried running the upgrade script again and got a different error this time:</p>
<div class="codehilite"><pre><span></span>root@zulip-bots-playground:~# /home/zulip/deployments/current/scripts/upgrade-zulip-from-git master

...(excluded output because the message would have been too long)

2018-06-11 18:17:32,101 upgrade-zulip-stage-2: Applying database migrations...
Operations to perform:
  Apply all migrations: analytics, auth, confirmation, contenttypes, otp_static, otp_totp, sessions, sites, social_django, two_factor, zerver
Running migrations:
  Applying zerver.0170_submessage...Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/db/backends/utils.py&quot;, line 62, in execute
    return self.cursor.execute(sql)
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zerver/lib/db.py&quot;, line 33, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zerver/lib/db.py&quot;, line 20, in wrapper_execute
    return action(sql, params)
psycopg2.ProgrammingError: relation &quot;zerver_submessage&quot; already exists


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 25, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/__init__.py&quot;, line 364, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/__init__.py&quot;, line 356, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/base.py&quot;, line 283, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/base.py&quot;, line 330, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/commands/migrate.py&quot;, line 204, in handle
    fake_initial=fake_initial,
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/db/migrations/executor.py&quot;, line 115, in migrate
    state = self._migrate_all_forwards(state, plan, full_plan, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/db/migrations/executor.py&quot;, line 145, in _migrate_all_forwards
    state = self.apply_migration(state, migration, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/
</pre></div>



<a name="598075"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/598075" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert Hönig <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#598075">(Jun 12 2018 at 12:33)</a>:</h4>
<p>To give some background on this: Initially, I ran the upgrade script , but accidentally still had my <code>zulip.conf</code> set to a personal branch of mine, instead of zulip master. This error occurred after I re-ran it  a couple times on <code>zulip/master</code>.</p>



<a name="598354"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/598354" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#598354">(Jun 12 2018 at 18:05)</a>:</h4>
<p>Ah, that background helps.</p>
<p>It looks like the migration system is trying to run a migration <code>0170_submessage</code>, but you already have effectively run some version of that migration. Maybe your previous branch had that migration under another name?</p>



<a name="598356"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/598356" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#598356">(Jun 12 2018 at 18:07)</a>:</h4>
<p>Probably you want to sort out the migration situation directly, then rerun the upgrade script.</p>



<a name="599667"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/599667" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#599667">(Jun 14 2018 at 22:12)</a>:</h4>
<p><span class="user-mention" data-user-id="801">@Robert Hönig</span> <code>manage.py showmigrations</code>  is helpful</p>



<a name="599668"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/599668" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#599668">(Jun 14 2018 at 22:13)</a>:</h4>
<p>I think it's possibly you'll end up wanting to do some version of using <code>manage.py migrate --fake</code>, but it's hard to know without seeing where you're starting.</p>



<a name="599945"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/599945" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert Hönig <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#599945">(Jun 15 2018 at 18:30)</a>:</h4>
<p><span class="user-mention" data-user-id="73">@Tim April</span> thanks, <code>./manage.py migrate --fake</code> pointed in the right direction. What I think happeneed is that on my first trial, only one migration was applied to the database. I faked that  onemigration with <code>./manage.py migrate --fake zerver 0170</code>. Afterwards, running the normal upgrade script for a git repo worked fine.</p>



<a name="599946"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/599946" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert Hönig <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#599946">(Jun 15 2018 at 18:31)</a>:</h4>
<p>I meant <span class="user-mention" data-user-id="7">@Tim Abbott</span> .</p>



<a name="600074"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Failing%20upgrade%20to%20master/near/600074" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Failing.20upgrade.20to.20master.html#600074">(Jun 16 2018 at 12:15)</a>:</h4>
<p>Great <span class="emoji emoji-1f603" title="smiley">:smiley:</span></p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>