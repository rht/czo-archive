<html>
<head><meta charset="utf-8"><title>testing possible Zulip 1.4-&gt;1.5 RabbitMQ fix · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html">testing possible Zulip 1.4-&gt;1.5 RabbitMQ fix</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="158391"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158391" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158391">(Feb 27 2017 at 20:01)</a>:</h4>
<p>I'm trying the steps <span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> suggested for fixing prod RabbitMQ problems when upgrating 1.4 to 1.5. (In this conversation from yesterday <a href="https://chat.zulip.org/#narrow/stream/production.20help/subject/gmail.20for.20register" target="_blank" title="https://chat.zulip.org/#narrow/stream/production.20help/subject/gmail.20for.20register">https://chat.zulip.org/#narrow/stream/production.20help/subject/gmail.20for.20register</a>)</p>



<a name="158392"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158392" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158392">(Feb 27 2017 at 20:02)</a>:</h4>
<p>my first try didn't solve the problem, but here's what I did:</p>



<a name="158393"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158393" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158393">(Feb 27 2017 at 20:02)</a>:</h4>
<p>I rebooted my VM so it starts having rabbitmq trouble again.</p>



<a name="158394"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158394" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158394">(Feb 27 2017 at 20:02)</a>:</h4>
<p>Then do the recommended steps, as root, except supervisorctl as zulip. skip the "may not be needed" steps. Things that worked normally aren't shown with output.</p>



<a name="158395"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158395" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158395">(Feb 27 2017 at 20:03)</a>:</h4>
<p>Edit /etc/zulip/zulip.conf to add [rabbitmq] configuration<br>
<code>supervisorctl stop all</code><br>
<code>/etc/init.d/rabbitmq-server stop</code></p>



<a name="158397"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158397" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158397">(Feb 27 2017 at 20:04)</a>:</h4>
<div class="codehilite"><pre><span></span>root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts# ./zulip-puppet-apply -f
Warning: Could not retrieve fact fqdn
Error: Could not find class apt for minmi on node minmi
Error: Could not find class apt for minmi on node minmi
</pre></div>



<a name="158399"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158399" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158399">(Feb 27 2017 at 20:04)</a>:</h4>
<p><code>root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts/setup# ./configure-rabbitmq</code></p>



<a name="158400"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158400" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158400">(Feb 27 2017 at 20:04)</a>:</h4>
<p><code>supervisorctl start all</code></p>



<a name="158403"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158403" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158403">(Feb 27 2017 at 20:08)</a>:</h4>
<p>Now I'm going to try it again including the "maybe not" steps.</p>



<a name="158404"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158404" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158404">(Feb 27 2017 at 20:17)</a>:</h4>
<p>Here's the original note with the steps. On this try, I added the apt-get purge, which was fine. But then <code>rabbitmq-server start</code> and <code>configure-rabbitmq</code> failed.</p>
<ul>
<li>Edit /etc/zulip/zulip.conf and add the below block to it.</li>
<li>supervisorctl stop all</li>
<li>/etc/init.d/rabbitmq-server stop</li>
<li>apt-get purge rabbitmq-server # may not be needed</li>
<li>scripts/setup/zulip-puppet-apply -f</li>
<li>/etc/init.d/rabbitmq-server start # may not be needed</li>
<li>scripts/setup/configure-rabbitmq</li>
<li>supervisorctl start all</li>
</ul>
<p>[rabbitmq]<br>
nodename = zulip@localhost</p>



<a name="158405"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158405" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158405">(Feb 27 2017 at 20:17)</a>:</h4>
<p>this is how rabbitmq-server start failed</p>
<div class="codehilite"><pre><span></span>root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts# /etc/init.d/rabbitmq-server start
-bash: /etc/init.d/rabbitmq-server: No such file or directory
</pre></div>



<a name="158406"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158406" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158406">(Feb 27 2017 at 20:19)</a>:</h4>
<p>and this is how configure-rabbitmq failed</p>
<div class="codehilite"><pre><span></span>root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts/setup# ./configure-rabbitmq 
+++ dirname ./configure-rabbitmq
++ ./../get-django-setting RABBITMQ_USERNAME
+ RABBITMQ_USERNAME=zulip
+++ dirname ./configure-rabbitmq
++ ./../get-django-setting RABBITMQ_PASSWORD
+ RABBITMQ_PASSWORD=[pw hash]
+ sudo rabbitmqctl delete_user zulip
sudo: rabbitmqctl: command not found
+ true
+ sudo rabbitmqctl delete_user zulip
sudo: rabbitmqctl: command not found
+ true
+ sudo rabbitmqctl delete_user guest
sudo: rabbitmqctl: command not found
+ true
+ sudo rabbitmqctl add_user zulip [passwd hash]
sudo: rabbitmqctl: command not found
</pre></div>



<a name="158407"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158407" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158407">(Feb 27 2017 at 20:22)</a>:</h4>
<p>After that, I still see the same problem. and there is no /etc/init.d/rabbitmq-server to restart that way</p>



<a name="158408"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158408" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158408">(Feb 27 2017 at 20:29)</a>:</h4>
<p>Oh just to be clear, puppet still failed like it did the first time</p>
<div class="codehilite"><pre><span></span>root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts# ./zulip-puppet-apply -f
Warning: Could not retrieve fact fqdn
Error: Could not find class apt for minmi on node minmi
Error: Could not find class apt for minmi on node minmi
</pre></div>



<a name="158409"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158409" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158409">(Feb 27 2017 at 20:33)</a>:</h4>
<p>Here's the entire transcript of the second attempt</p>
<div class="codehilite"><pre><span></span>root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts/setup# su zulip
zulip@minmi:~/deployments/2017-02-25-04-24-20/scripts/setup$ supervisorctl stop all
process-fts-updates: stopped
zulip-tornado: stopped
zulip-workers:zulip_events_user_presence: stopped
zulip-workers:zulip_events_invites: stopped
zulip-workers:zulip_events_signups: stopped
zulip-workers:zulip_events_embed_links: stopped
zulip-workers:zulip_events_user_activity: stopped
zulip-workers:zulip_events_error_reports: stopped
zulip-workers:zulip_deliver_enqueued_emails: stopped
zulip-senders:zulip_events_message_sender-0: stopped
zulip-senders:zulip_events_message_sender-1: stopped
zulip-senders:zulip_events_message_sender-2: stopped
zulip-senders:zulip_events_message_sender-3: stopped
zulip-senders:zulip_events_message_sender-4: stopped
zulip-django: stopped
zulip-workers:zulip_events_feedback_messages: stopped
zulip-workers:zulip_events_email_mirror: stopped
zulip-workers:zulip_events_user_activity_interval: stopped
zulip-workers:zulip_events_missedmessage_emails: stopped
zulip-workers:zulip_events_slow_queries: stopped
zulip-workers:zulip_events_missedmessage_mobile_notifications: stopped
zulip-workers:zulip_events_digest_emails: stopped
zulip@minmi:~/deployments/2017-02-25-04-24-20/scripts/setup$ exit
exit
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts/setup# /etc/init.d/rabbitmq-server stop
 * Stopping message broker rabbitmq-server
 * message broker already stopped
   ...done.
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts/setup# apt-get purge rabbitmq-server
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following packages were automatically installed and are no longer required:
  apache2-data erlang-asn1 erlang-base erlang-corba erlang-crypto
  erlang-diameter erlang-edoc erlang-eldap erlang-erl-docgen erlang-eunit
  erlang-ic erlang-inets erlang-mnesia erlang-nox erlang-odbc erlang-os-mon
  erlang-parsetools erlang-percept erlang-public-key erlang-runtime-tools
  erlang-snmp erlang-ssh erlang-ssl erlang-syntax-tools erlang-tools
  erlang-webtool erlang-xmerl libodbc1
Use &#39;apt-get autoremove&#39; to remove them.
The following packages will be REMOVED:
  rabbitmq-server*
0 upgraded, 0 newly installed, 1 to remove and 2 not upgraded.
After this operation, 4,867 kB disk space will be freed.
Do you want to continue? [Y/n] y
(Reading database ... 82716 files and directories currently installed.)
Removing rabbitmq-server (3.2.4-1) ...
 * Stopping message broker rabbitmq-server
 * message broker already stopped
   ...done.
Purging configuration files for rabbitmq-server (3.2.4-1) ...
Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts/setup# cd ..
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts# ls
get-django-setting  lib                    README.md       upgrade-zulip
__init__.py         nagios                 restart-server  upgrade-zulip-from-git
__init__.pyc        purge-old-deployments  setup           zulip-puppet-apply
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts# ./zulip-puppet-apply -f
Warning: Could not retrieve fact fqdn
Error: Could not find class apt for minmi on node minmi
Error: Could not find class apt for minmi on node minmi
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts# /etc/init.d/rabbitmq-server start
-bash: /etc/init.d/rabbitmq-server: No such file or directory
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts# /etc/init.d/rabbitmq-server start
-bash: /etc/init.d/rabbitmq-server: No such file or directory
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts# ls
get-django-setting  lib                    README.md       upgrade-zulip
__init__.py         nagios                 restart-server  upgrade-zulip-from-git
__init__.pyc        purge-old-deployments  setup           zulip-puppet-apply
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts# cd setup/
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts/setup# ls
configure-rabbitmq   initialize-database  npm-wrapper       terminate-psql-sessions
flush-memcached      install              pgroonga-ppa.asc  zulip-ppa.asc
generate_secrets.py  node-wrapper         postgres-init-db
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts/setup# ./configure-rabbitmq 
+++ dirname ./configure-rabbitmq
++ ./../get-django-setting RABBITMQ_USERNAME
+ RABBITMQ_USERNAME=zulip
+++ dirname ./configure-rabbitmq
++ ./../get-django-setting RABBITMQ_PASSWORD
+ RABBITMQ_PASSWORD=[pw hash]
+ sudo rabbitmqctl delete_user zulip
sudo: rabbitmqctl: command not found
+ true
+ sudo rabbitmqctl delete_user zulip
sudo: rabbitmqctl: command not found
+ true
+ sudo rabbitmqctl delete_user guest
sudo: rabbitmqctl: command not found
+ true
+ sudo rabbitmqctl add_user zulip [pw hash]
sudo: rabbitmqctl: command not found
root@minmi:/home/zulip/deployments/2017-02-25-04-24-20/scripts/setup# su zulip
zulip@minmi:~/deployments/2017-02-25-04-24-20/scripts/setup$ supervisorctl start all
zulip-django: started
zulip-tornado: started
process-fts-updates: started
zulip-workers:zulip_events_feedback_messages: started
zulip-workers:zulip_events_user_presence: started
zulip-workers:zulip_events_invites: started
zulip-workers:zulip_events_signups: started
zulip-workers:zulip_events_email_mirror: started
zulip-workers:zulip_events_user_activity_interval: started
zulip-workers:zulip_events_missedmessage_emails: started
zulip-workers:zulip_events_slow_queries: started
zulip-workers:zulip_events_embed_links: started
zulip-workers:zulip_events_missedmessage_mobile_notifications: started
zulip-workers:zulip_events_digest_emails: started
zulip-workers:zulip_events_user_activity: started
zulip-workers:zulip_events_error_reports: started
zulip-workers:zulip_deliver_enqueued_emails: started
zulip-senders:zulip_events_message_sender-0: started
zulip-senders:zulip_events_message_sender-1: started
zulip-senders:zulip_events_message_sender-2: started
zulip-senders:zulip_events_message_sender-3: started
zulip-senders:zulip_events_message_sender-4: started
</pre></div>



<a name="158411"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158411" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158411">(Feb 27 2017 at 20:36)</a>:</h4>
<p>So at the moment it's still giving me the ConnectionClosed() errors. (Fortunately this is only a test system.)</p>



<a name="158438"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158438" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158438">(Feb 27 2017 at 23:15)</a>:</h4>
<p><span class="user-mention" data-user-email="zulip@feorlen.org" data-user-id="397">@Andrea  Longo</span> just started looking at this; I have a theory that <br>
<code>Error: Could not find class apt for minmi on node minmi</code> <br>
means that <code>zulip-puppet-apply</code> isn't doing anything.</p>



<a name="158439"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158439" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158439">(Feb 27 2017 at 23:16)</a>:</h4>
<p>What is in your <code>/etc/zulip/zulip.conf</code>?  I've never seen an error like that before, and so I suspect that you've done something unusual</p>



<a name="158440"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158440" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158440">(Feb 27 2017 at 23:17)</a>:</h4>
<p>One possibility I suppose is that I'm not sure running e.g. <code>./zulip-puppet-apply</code> (as opposed to running <code>./scripts/zulip-puppet-apply</code> from a parent directory) will definitely work with all of our commands, so you should try seeing if that's why you're having issues.</p>



<a name="158441"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158441" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158441">(Feb 27 2017 at 23:17)</a>:</h4>
<p>Since yesterday, I added the rabbitmq thing, but that's it</p>
<div class="codehilite"><pre><span></span>[machine]
puppet_classes = zulip::voyager, zulip::static_asset_compiler
deploy_type = voyager

[deployment]
git_repo_url = https://github.com/feorlen/zulip.git

[rabbitmq]
nodename = zulip@localhost
</pre></div>



<a name="158442"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158442" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158442">(Feb 27 2017 at 23:17)</a>:</h4>
<p>The other possibility is that the <code>/root/zulip</code> symlink doesn't exist</p>



<a name="158443"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158443" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158443">(Feb 27 2017 at 23:17)</a>:</h4>
<p>OK, your <code>puppet_classes</code> looks normal</p>



<a name="158444"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158444" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158444">(Feb 27 2017 at 23:17)</a>:</h4>
<p>What is <code>ls -ld /root/zulip</code>?</p>



<a name="158445"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158445" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158445">(Feb 27 2017 at 23:18)</a>:</h4>
<p><code>lrwxrwxrwx 1 root root 28 Feb 14 18:41 /root/zulip -&gt; /home/zulip/deployments/next</code></p>



<a name="158448"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158448" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158448">(Feb 27 2017 at 23:20)</a>:</h4>
<p>that looks normal as well</p>



<a name="158449"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158449" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158449">(Feb 27 2017 at 23:20)</a>:</h4>
<p>Should those steps been done differently? As/not root or something?</p>



<a name="158450"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158450" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158450">(Feb 27 2017 at 23:21)</a>:</h4>
<p>I stopped and started Zulip as zulip, but the other things as root</p>



<a name="158451"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158451" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158451">(Feb 27 2017 at 23:21)</a>:</h4>
<p>OK I just did some manual testing on a prod host; the problem is <code>scripts/zulip-puppet-apply</code> needs to be run that way</p>



<a name="158452"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158452" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158452">(Feb 27 2017 at 23:21)</a>:</h4>
<p>You can't <code>cd scripts/</code> and run things from there</p>



<a name="158453"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158453" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158453">(Feb 27 2017 at 23:21)</a>:</h4>
<p>from that specific location</p>



<a name="158454"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158454" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158454">(Feb 27 2017 at 23:21)</a>:</h4>
<p>You can also run <code>/home/zulip/deployments/current/scripts/zulip-puppet-apply</code></p>



<a name="158455"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158455" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158455">(Feb 27 2017 at 23:22)</a>:</h4>
<p>So I think it's a bug specifically with running it as <code>./zulip-puppet-apply</code></p>



<a name="158456"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158456" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158456">(Feb 27 2017 at 23:22)</a>:</h4>
<p>I'll try it again</p>



<a name="158457"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158457" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158457">(Feb 27 2017 at 23:23)</a>:</h4>
<p>Looks like we need to do this:</p>
<div class="codehilite"><pre><span></span>diff --git a/scripts/zulip-puppet-apply b/scripts/zulip-puppet-apply
index ecf0a67..75c8879 100755
--- a/scripts/zulip-puppet-apply
+++ b/scripts/zulip-puppet-apply
@@ -30,7 +30,7 @@ for pclass in re.split(r&#39;\s*,\s*&#39;, config.get(&#39;machine&#39;, &#39;puppet_classes&#39;)):
     puppet_config += &quot;include %s\n&quot; % (pclass,)

 # We use the puppet configuration from the same Zulip checkout as this script
-puppet_module_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), &quot;puppet&quot;)
+puppet_module_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath((__file__)))), &quot;puppet&quot;)
 puppet_cmd = [&quot;puppet&quot;, &quot;apply&quot;, &quot;--modulepath&quot;, puppet_module_path, &quot;-e&quot;, puppet_config]
 puppet_cmd += extra_args
</pre></div>



<a name="158458"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158458" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158458">(Feb 27 2017 at 23:26)</a>:</h4>
<p>I'll fix that; did you not also get an exception?  When I tried running it that way, I got:</p>
<div class="codehilite"><pre><span></span># ./zulip-puppet-apply 
Warning: Could not retrieve fact fqdn
Error: Could not find class apt for zulip on node zulip
Error: Could not find class apt for zulip on node zulip
Traceback (most recent call last):
  File &quot;./zulip-puppet-apply&quot;, line 38, in &lt;module&gt;
    subprocess.check_call(puppet_cmd + [&#39;--noop&#39;, &#39;--show_diff&#39;])
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;puppet&#39;, &#39;apply&#39;, &#39;--modulepath&#39;, &#39;puppet&#39;, &#39;-e&#39;, &#39;\nExec { path =&gt; &quot;/usr/sbin:/usr/bin:/sbin:/bin&quot; }\ninclude apt\ninclude zulip::voyager\ninclude zulip::static_asset_compiler\n&#39;, &#39;--noop&#39;, &#39;--show_diff&#39;]&#39; returned non-zero exit status 1
</pre></div>



<a name="158459"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158459" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158459">(Feb 27 2017 at 23:26)</a>:</h4>
<p>Maybe it doesn't show the exception with <code>-f</code>?</p>



<a name="158462"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158462" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158462">(Feb 27 2017 at 23:27)</a>:</h4>
<p>I didn't see an exception from that, guess not</p>



<a name="158463"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158463" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158463">(Feb 27 2017 at 23:27)</a>:</h4>
<p>So now puppet did something</p>



<a name="158465"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158465" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158465">(Feb 27 2017 at 23:27)</a>:</h4>
<div class="codehilite"><pre><span></span>root@minmi:/# /home/zulip/deployments/current/scripts/zulip-puppet-apply -f
Warning: Could not retrieve fact fqdn
Notice: Compiled catalog for minmi in environment production in 1.68 seconds
Notice: /Stage[main]/Zulip::Postgres_common/Exec[disable_logrotate]/returns: executed successfully
Notice: /Stage[main]/Zulip::Postgres_appdb_tuned/File[/etc/sysctl.d/40-postgresql.conf]/content: content changed &#39;{md5}fd4e1c28da044ec25d858e409792298d&#39; to &#39;{md5}6f2ffcaea13b6f884e2b521a80ea9888&#39;
Notice: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[sysctl_p]: Triggered &#39;refresh&#39; from 1 events
Notice: /Stage[main]/Zulip::Memcached/File[/etc/memcached.conf]/content: content changed &#39;{md5}22778c0db2128b67bc42dc94b2218624&#39; to &#39;{md5}f2925a318ae365a4ee4365face52bf93&#39;
Notice: /Stage[main]/Zulip::Memcached/Service[memcached]: Triggered &#39;refresh&#39; from 1 events
Notice: /Stage[main]/Zulip::Rabbit/File[/etc/rabbitmq]/ensure: created
Notice: /Stage[main]/Zulip::Rabbit/File[/etc/rabbitmq/rabbitmq-env.conf]/ensure: defined content as &#39;{md5}863d88c92c9462114602ff665f524f0e&#39;
Notice: /Stage[main]/Zulip::Rabbit/Package[rabbitmq-server]/ensure: ensure changed &#39;purged&#39; to &#39;present&#39;
Notice: /Stage[main]/Zulip::Rabbit/File[/etc/rabbitmq/rabbitmq.config]/ensure: defined content as &#39;{md5}2dd16948c9f36d8797732cb4c9e43bc8&#39;
Notice: /Stage[main]/Zulip::Rabbit/File[/etc/default/rabbitmq-server]/content: content changed &#39;{md5}7cc5216f193f6be1cb32c45021197b39&#39; to &#39;{md5}d0d028b94fbee9c1f4ff98e109cce3f4&#39;
Notice: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[pg_ctlcluster 9.3 main restart]: Triggered &#39;refresh&#39; from 1 events
Notice: Finished catalog run in 11.51 seconds
</pre></div>



<a name="158466"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158466" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158466">(Feb 27 2017 at 23:28)</a>:</h4>
<p>That looks better.</p>



<a name="158483"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158483" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158483">(Feb 27 2017 at 23:34)</a>:</h4>
<p>Ok that looks much better!</p>



<a name="158485"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158485" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158485">(Feb 27 2017 at 23:34)</a>:</h4>
<p>Everything looks normal now, I'll try rebooting the host to check.</p>



<a name="158487"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158487" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158487">(Feb 27 2017 at 23:35)</a>:</h4>
<p>yay</p>



<a name="158489"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158489" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158489">(Feb 27 2017 at 23:35)</a>:</h4>
<p>So I wasn't in the correct directory to execute the commands (or didn't do it by full path)</p>



<a name="158490"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158490" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158490">(Feb 27 2017 at 23:37)</a>:</h4>
<p>Whoops. It's doing it again after reboot.</p>



<a name="158493"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158493" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158493">(Feb 27 2017 at 23:45)</a>:</h4>
<p>Ok, one more time. Here's what I did, and now to reboot and see if it sticks</p>
<div class="codehilite"><pre><span></span>root@minmi:~# 
root@minmi:~# su zulip
zulip@minmi:/root$ supervisorctl stop all
zulip-workers:zulip_deliver_enqueued_emails: stopped
process-fts-updates: stopped
zulip-workers:zulip_events_user_presence: stopped
zulip-workers:zulip_events_invites: stopped
zulip-workers:zulip_events_embed_links: stopped
zulip-tornado: stopped
zulip-workers:zulip_events_signups: stopped
zulip-workers:zulip_events_email_mirror: stopped
zulip-workers:zulip_events_user_activity_interval: stopped
zulip-workers:zulip_events_missedmessage_emails: stopped
zulip-workers:zulip_events_slow_queries: stopped
zulip-workers:zulip_events_missedmessage_mobile_notifications: stopped
zulip-workers:zulip_events_digest_emails: stopped
zulip-workers:zulip_events_user_activity: stopped
zulip-workers:zulip_events_error_reports: stopped
zulip-senders:zulip_events_message_sender-0: stopped
zulip-senders:zulip_events_message_sender-1: stopped
zulip-senders:zulip_events_message_sender-2: stopped
zulip-senders:zulip_events_message_sender-3: stopped
zulip-senders:zulip_events_message_sender-4: stopped
zulip-django: stopped
zulip-workers:zulip_events_feedback_messages: stopped
zulip@minmi:/root$ exit
exit
root@minmi:~# /etc/init.d/rabbitmq-server stop
 * Stopping message broker rabbitmq-server
 * message broker already stopped
   ...done.
root@minmi:~# apt-get purge rabbitmq-server
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following packages were automatically installed and are no longer required:
  apache2-data erlang-asn1 erlang-base erlang-corba erlang-crypto
  erlang-diameter erlang-edoc erlang-eldap erlang-erl-docgen erlang-eunit
  erlang-ic erlang-inets erlang-mnesia erlang-nox erlang-odbc erlang-os-mon
  erlang-parsetools erlang-percept erlang-public-key erlang-runtime-tools
  erlang-snmp erlang-ssh erlang-ssl erlang-syntax-tools erlang-tools
  erlang-webtool erlang-xmerl libodbc1
Use &#39;apt-get autoremove&#39; to remove them.
The following packages will be REMOVED:
  rabbitmq-server*
0 upgraded, 0 newly installed, 1 to remove and 2 not upgraded.
After this operation, 4,867 kB disk space will be freed.
Do you want to continue? [Y/n] y
(Reading database ... 82716 files and directories currently installed.)
Removing rabbitmq-server (3.2.4-1) ...
 * Stopping message broker rabbitmq-server
 * message broker already stopped
   ...done.
Purging configuration files for rabbitmq-server (3.2.4-1) ...
Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
root@minmi:~# pwd
/root
root@minmi:~# /home/zulip/deployments/current/scripts/setup/zulip-puppet-apply -f
-bash: /home/zulip/deployments/current/scripts/setup/zulip-puppet-apply: No such file or directory
root@minmi:~# /home/zulip/deployments/current/scripts/zulip-puppet-apply -f
Warning: Could not retrieve fact fqdn
Notice: Compiled catalog for minmi in environment production in 1.52 seconds
Notice: /Stage[main]/Zulip::Postgres_common/Exec[disable_logrotate]/returns: executed successfully
Notice: /Stage[main]/Zulip::Rabbit/File[/etc/rabbitmq]/ensure: created
Notice: /Stage[main]/Zulip::Rabbit/File[/etc/rabbitmq/rabbitmq-env.conf]/ensure: defined content as &#39;{md5}863d88c92c9462114602ff665f524f0e&#39;
Notice: /Stage[main]/Zulip::Rabbit/Package[rabbitmq-server]/ensure: ensure changed &#39;purged&#39; to &#39;present&#39;
Notice: /Stage[main]/Zulip::Rabbit/File[/etc/rabbitmq/rabbitmq.config]/ensure: defined content as &#39;{md5}2dd16948c9f36d8797732cb4c9e43bc8&#39;
Notice: /Stage[main]/Zulip::Rabbit/File[/etc/default/rabbitmq-server]/content: content changed &#39;{md5}7cc5216f193f6be1cb32c45021197b39&#39; to &#39;{md5}d0d028b94fbee9c1f4ff98e109cce3f4&#39;
Notice: Finished catalog run in 8.41 seconds
root@minmi:~# /home/zulip/deployments/current/scripts/setup/configure-rabbitmq 
+++ dirname /home/zulip/deployments/current/scripts/setup/configure-rabbitmq
++ /home/zulip/deployments/current/scripts/setup/../get-django-setting RABBITMQ_USERNAME
+ RABBITMQ_USERNAME=zulip
+++ dirname /home/zulip/deployments/current/scripts/setup/configure-rabbitmq
++ /home/zulip/deployments/current/scripts/setup/../get-django-setting RABBITMQ_PASSWORD
+ RABBITMQ_PASSWORD=721d56ec73bf96ea1a17289753efed89dc058725d141f1578f7424131c938a7a
+ sudo rabbitmqctl delete_user zulip
Deleting user &quot;zulip&quot; ...
Error: no_such_user: zulip
+ true
+ sudo rabbitmqctl delete_user zulip
Deleting user &quot;zulip&quot; ...
Error: no_such_user: zulip
+ true
+ sudo rabbitmqctl delete_user guest
Deleting user &quot;guest&quot; ...
...done.
+ sudo rabbitmqctl add_user zulip 721d56ec73bf96ea1a17289753efed89dc058725d141f1578f7424131c938a7a
Creating user &quot;zulip&quot; ...
...done.
+ sudo rabbitmqctl set_user_tags zulip administrator
Setting tags for user &quot;zulip&quot; to [administrator] ...
...done.
+ sudo rabbitmqctl set_permissions -p / zulip &#39;.*&#39; &#39;.*&#39; &#39;.*&#39;
Setting permissions for user &quot;zulip&quot; in vhost &quot;/&quot; ...
...done.
root@minmi:~# su zulip
zulip@minmi:/root$ supervisorctl start all
zulip-django: started
zulip-tornado: started
process-fts-updates: started
zulip-workers:zulip_events_feedback_messages: started
zulip-workers:zulip_events_user_presence: started
zulip-workers:zulip_events_invites: started
zulip-workers:zulip_events_signups: started
zulip-workers:zulip_events_email_mirror: started
zulip-workers:zulip_events_user_activity_interval: started
zulip-workers:zulip_events_missedmessage_emails: started
zulip-workers:zulip_events_slow_queries: started
zulip-workers:zulip_events_embed_links: started
zulip-workers:zulip_events_missedmessage_mobile_notifications: started
zulip-workers:zulip_events_digest_emails: started
zulip-workers:zulip_events_user_activity: started
zulip-workers:zulip_events_error_reports: started
zulip-workers:zulip_deliver_enqueued_emails: started
zulip-senders:zulip_events_message_sender-0: started
zulip-senders:zulip_events_message_sender-1: started
zulip-senders:zulip_events_message_sender-2: started
zulip-senders:zulip_events_message_sender-3: started
zulip-senders:zulip_events_message_sender-4: started
zulip@minmi:/root$ tail -f /var/log/zulip/server.log 
2017-02-27 18:44:35,472 INFO     127.0.0.1       GET     200   9ms /api/v1/events [1488239055:0/0] (minmi-zulip@feorlen.org via internal)
2017-02-27 18:44:35,900 INFO     64.81.53.74     GET     200  1.3s (mem: 35ms/14) (db: 86ms/27q) (+start: 6.7s) / [1488239055:0] (minmi-zulip@feorlen.org via website)
2017-02-27 18:44:36,542 INFO     64.81.53.74     POST    200  41ms (db: 2ms/2q) (+start: 13ms) /json/users/me/presence (minmi-zulip@feorlen.org via website)
2017-02-27 18:44:36,740 INFO     64.81.53.74     SOCKET  200   0ms /socket/open [transport=websocket] (unknown via ?)
2017-02-27 18:44:36,772 INFO     64.81.53.74     SOCKET  200   8ms (db: 2ms/2q) /socket/auth [transport=websocket] (minmi-zulip@feorlen.org via ?)
2017-02-27 18:44:37,568 INFO     64.81.53.74     GET     200 253ms (mem: 20ms/15) (db: 41ms/15q) (+start: 807ms) /json/messages (minmi-zulip@feorlen.org via website)
2017-02-27 18:44:39,656 INFO     Tornado   4.4% busy over the past  5.4 seconds
2017-02-27 18:44:44,657 INFO     Tornado   2.3% busy over the past 10.4 seconds
2017-02-27 18:44:48,664 INFO     64.81.53.74     GET     200 119ms (db: 2ms/8q) (+start: 753ms) /json/messages (minmi-zulip@feorlen.org via website)
2017-02-27 18:44:50,657 INFO     Tornado   1.5% busy over the past 16.4 seconds
^C
zulip@minmi:/root$ 
</pre></div>



<a name="158495"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158495" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sampriti Panda <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158495">(Feb 27 2017 at 23:46)</a>:</h4>
<p>Off topic but, why isn't Zulip collapsing this message?</p>



<a name="158497"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158497" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sampriti Panda <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158497">(Feb 27 2017 at 23:46)</a>:</h4>
<p>Ok it did collapse it, but only after I sent ^ this message</p>



<a name="158499"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158499" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158499">(Feb 27 2017 at 23:47)</a>:</h4>
<p>hmm you got that too? I thought it was just me because I wrote it. I clicked on the topic name again and it did</p>



<a name="158502"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158502" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sampriti Panda <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158502">(Feb 27 2017 at 23:47)</a>:</h4>
<p>Yes, I guess when the latest message is sent, it doesn't collapse it.</p>



<a name="158503"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158503" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158503">(Feb 27 2017 at 23:48)</a>:</h4>
<p>Rebooted, and now it's busted again.</p>



<a name="158504"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158504" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158504">(Feb 27 2017 at 23:48)</a>:</h4>
<p><span class="user-mention" data-user-email="sampdingo@hotmail.com" data-user-id="720">@Sampriti Panda</span> I think there's basically a bug where it doesn't collapse the latest message.  Open an issue?</p>



<a name="158506"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158506" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158506">(Feb 27 2017 at 23:49)</a>:</h4>
<p><span class="user-mention" data-user-email="zulip@feorlen.org" data-user-id="397">@Andrea  Longo</span> more detail would be useful?</p>



<a name="158508"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158508" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158508">(Feb 27 2017 at 23:49)</a>:</h4>
<p>Did rabbitmq-server not start?</p>



<a name="158511"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158511" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158511">(Feb 27 2017 at 23:50)</a>:</h4>
<div class="codehilite"><pre><span></span>root@minmi:~# /etc/init.d/rabbitmq-server status
Status of node zulip@localhost ...
Error: unable to connect to node zulip@localhost: nodedown

DIAGNOSTICS
===========

nodes in question: [zulip@localhost]

hosts, their running nodes and ports:
- localhost: [{rabbitmqctl3764,42726}]

current node details:
- node name: rabbitmqctl3764@minmi
- home dir: /var/lib/rabbitmq
- cookie hash: c6LbFBQK+TVuBi3YXkDCrg==
</pre></div>



<a name="158513"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158513" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158513">(Feb 27 2017 at 23:50)</a>:</h4>
<p>Seems not, unless I'm supposed to have something other than zulip@localhost</p>



<a name="158514"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158514" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158514">(Feb 27 2017 at 23:51)</a>:</h4>
<p><code>ls -l /var/lib/rabbitmq/mnesia</code> ?</p>



<a name="158515"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158515" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158515">(Feb 27 2017 at 23:51)</a>:</h4>
<p>Try starting it from <code>/etc/init.d</code>?</p>



<a name="158516"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158516" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158516">(Feb 27 2017 at 23:51)</a>:</h4>
<div class="codehilite"><pre><span></span>root@minmi:~# ls -l /var/lib/rabbitmq/mnesia
total 8
drwxr-xr-x 5 rabbitmq rabbitmq 4096 Feb 27 23:44 zulip@localhost
drwxr-xr-x 2 rabbitmq rabbitmq 4096 Feb 27 23:43 zulip@localhost-plugins-expand
</pre></div>



<a name="158517"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158517" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158517">(Feb 27 2017 at 23:51)</a>:</h4>
<p>In theory the Debian package should do that for you</p>



<a name="158519"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158519" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158519">(Feb 27 2017 at 23:51)</a>:</h4>
<p>May be worth checking system logs to see why it didn't start</p>



<a name="158520"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158520" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158520">(Feb 27 2017 at 23:52)</a>:</h4>
<p>Like, did it try starting and fail, or did it not try</p>



<a name="158521"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158521" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158521">(Feb 27 2017 at 23:52)</a>:</h4>
<p>lemme see. it's started now</p>



<a name="158525"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158525" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158525">(Feb 27 2017 at 23:53)</a>:</h4>
<div class="codehilite"><pre><span></span>-rw-r--r-- 1 root     root         0 Feb 27 23:46 shutdown_err
-rw-r--r-- 1 rabbitmq rabbitmq   423 Feb 27 23:46 zulip@localhost-sasl.log
-rw-r--r-- 1 root     root        55 Feb 27 23:46 shutdown_log
-rw-r--r-- 1 rabbitmq rabbitmq     0 Feb 27 23:51 startup_err
-rw-r--r-- 1 rabbitmq rabbitmq   341 Feb 27 23:52 startup_log
-rw-r--r-- 1 rabbitmq rabbitmq 13050 Feb 27 23:52 zulip@localhost.log
root@minmi:/var/log/rabbitmq# cat startup_log

              RabbitMQ 3.2.4. Copyright (C) 2007-2013 GoPivotal, Inc.
  ##  ##      Licensed under the MPL.  See http://www.rabbitmq.com/
  ##  ##
  ##########  Logs: /var/log/rabbitmq/zulip@localhost.log
  ######  ##        /var/log/rabbitmq/zulip@localhost-sasl.log
  ##########
              Starting broker... completed with 0 plugins.
</pre></div>



<a name="158526"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158526" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sampriti Panda <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158526">(Feb 27 2017 at 23:53)</a>:</h4>
<blockquote>
<p><span class="user-mention" data-user-email="sampdingo@hotmail.com" data-user-id="720">@Sampriti Panda</span> I think there's basically a bug where it doesn't collapse the latest message.  Open an issue?</p>
</blockquote>
<p>Couldn't reproduce it myself for some reason.</p>



<a name="158527"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158527" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158527">(Feb 27 2017 at 23:55)</a>:</h4>
<p>recent lines from <a href="mailto:zulip@localhost.log" title="mailto:zulip@localhost.log">zulip@localhost.log</a> </p>
<div class="codehilite"><pre><span></span>=ERROR REPORT==== 27-Feb-2017::23:46:05 ===
AMQP connection &lt;0.409.0&gt; (running), channel 0 - error:
{amqp_error,connection_forced,
            &quot;broker forced connection closure with reason &#39;shutdown&#39;&quot;,none}

=ERROR REPORT==== 27-Feb-2017::23:46:05 ===
AMQP connection &lt;0.314.0&gt; (running), channel 0 - error:
{amqp_error,connection_forced,
            &quot;broker forced connection closure with reason &#39;shutdown&#39;&quot;,none}

=INFO REPORT==== 27-Feb-2017::23:46:05 ===
Halting Erlang VM

=INFO REPORT==== 27-Feb-2017::23:52:00 ===
Starting RabbitMQ 3.2.4 on Erlang R16B03
Copyright (C) 2007-2013 GoPivotal, Inc.
Licensed under the MPL.  See http://www.rabbitmq.com/

=INFO REPORT==== 27-Feb-2017::23:52:00 ===
node           : zulip@localhost
home dir       : /var/lib/rabbitmq
config file(s) : /etc/rabbitmq/rabbitmq.config
cookie hash    : c6LbFBQK+TVuBi3YXkDCrg==
log            : /var/log/rabbitmq/zulip@localhost.log
sasl log       : /var/log/rabbitmq/zulip@localhost-sasl.log
database dir   : /var/lib/rabbitmq/mnesia/zulip@localhost

=INFO REPORT==== 27-Feb-2017::23:52:00 ===
Limiting to approx 924 file handles (829 sockets)

=INFO REPORT==== 27-Feb-2017::23:52:01 ===
Memory limit set to 1580MB of 3951MB total.

=INFO REPORT==== 27-Feb-2017::23:52:01 ===
Disk free limit set to 50MB

=INFO REPORT==== 27-Feb-2017::23:52:01 ===
msg_store_transient: using rabbit_msg_store_ets_index to provide index

=INFO REPORT==== 27-Feb-2017::23:52:01 ===
msg_store_persistent: using rabbit_msg_store_ets_index to provide index

=INFO REPORT==== 27-Feb-2017::23:52:01 ===
started TCP Listener on 127.0.0.1:5672

=INFO REPORT==== 27-Feb-2017::23:52:01 ===
Server startup complete; 0 plugins started.

=INFO REPORT==== 27-Feb-2017::23:52:04 ===
accepting AMQP connection &lt;0.262.0&gt; (127.0.0.1:59138 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:07 ===
accepting AMQP connection &lt;0.272.0&gt; (127.0.0.1:59140 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:08 ===
accepting AMQP connection &lt;0.281.0&gt; (127.0.0.1:59142 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:09 ===
accepting AMQP connection &lt;0.290.0&gt; (127.0.0.1:59144 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:09 ===
accepting AMQP connection &lt;0.299.0&gt; (127.0.0.1:59146 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:10 ===
accepting AMQP connection &lt;0.308.0&gt; (127.0.0.1:59148 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:10 ===
accepting AMQP connection &lt;0.317.0&gt; (127.0.0.1:59150 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:11 ===
accepting AMQP connection &lt;0.326.0&gt; (127.0.0.1:59152 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:12 ===
accepting AMQP connection &lt;0.336.0&gt; (127.0.0.1:59154 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:12 ===
accepting AMQP connection &lt;0.345.0&gt; (127.0.0.1:59156 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:12 ===
accepting AMQP connection &lt;0.354.0&gt; (127.0.0.1:59158 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:12 ===
accepting AMQP connection &lt;0.363.0&gt; (127.0.0.1:59160 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:12 ===
accepting AMQP connection &lt;0.372.0&gt; (127.0.0.1:59162 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:13 ===
accepting AMQP connection &lt;0.381.0&gt; (127.0.0.1:59164 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:13 ===
accepting AMQP connection &lt;0.390.0&gt; (127.0.0.1:59166 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:13 ===
accepting AMQP connection &lt;0.399.0&gt; (127.0.0.1:59168 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:13 ===
accepting AMQP connection &lt;0.408.0&gt; (127.0.0.1:59170 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:13 ===
accepting AMQP connection &lt;0.417.0&gt; (127.0.0.1:59172 -&gt; 127.0.0.1:5672)

=INFO REPORT==== 27-Feb-2017::23:52:13 ===
accepting AMQP connection &lt;0.426.0&gt; (127.0.0.1:59174 -&gt; 127.0.0.1:5672)
</pre></div>



<a name="158528"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158528" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158528">(Feb 27 2017 at 23:55)</a>:</h4>
<p>This is only a test machine, I can make you a login</p>



<a name="158529"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158529" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158529">(Feb 27 2017 at 23:58)</a>:</h4>
<p><span class="user-mention" data-user-email="sampdingo@hotmail.com" data-user-id="720">@Sampriti Panda</span> did that message stay open for you just now? I had to reload the page before it would collapse. I wonder if it has anything to do with code formatting.</p>



<a name="158532"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158532" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sampriti Panda <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158532">(Feb 28 2017 at 00:00)</a>:</h4>
<p><span class="user-mention" data-user-email="zulip@feorlen.org" data-user-id="397">@Andrea  Longo</span> can you resend that message in <a class="stream" data-stream-id="7" href="/#narrow/stream/test%20here">#test here</a></p>



<a name="158533"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158533" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sampriti Panda <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158533">(Feb 28 2017 at 00:00)</a>:</h4>
<p>I didn't have Zulip open when you sent it.</p>



<a name="158559"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158559" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158559">(Feb 28 2017 at 00:06)</a>:</h4>
<p>Yeah, let's move the collapsing testing elsewhere.  But I have noticed it not working when messages first show up sometimes, so there's definitely a bug; just may be a bit more subtle than "always doesn't work"</p>



<a name="158560"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158560" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158560">(Feb 28 2017 at 00:06)</a>:</h4>
<p><span class="user-mention" data-user-email="zulip@feorlen.org" data-user-id="397">@Andrea  Longo</span> the thing I want you to check (and maybe rebooting again makes this easy) is whether anything shows up in the rabbitmq logs post-reboot if your reboot</p>



<a name="158561"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158561" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158561">(Feb 28 2017 at 00:06)</a>:</h4>
<p>I think it's possible that just the systemd/upstart settings for rabbitmq are wrong and so it's not trying to start rabbitmq on boot</p>



<a name="158562"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158562" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158562">(Feb 28 2017 at 00:07)</a>:</h4>
<p>let me try and watch it</p>



<a name="158563"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158563" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158563">(Feb 28 2017 at 00:10)</a>:</h4>
<div class="codehilite"><pre><span></span>root@minmi:/var/log/rabbitmq# tail startup_err 

Crash dump was written to: erl_crash.dump
Kernel pid terminated (application_controller) ({application_start_failure,kernel,{{shutdown,{failed_to_start_child,net_sup,{shutdown,{failed_to_start_child,net_kernel,{&#39;EXIT&#39;,nodistribution}}}}},{k
</pre></div>



<a name="158564"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158564" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158564">(Feb 28 2017 at 00:10)</a>:</h4>
<div class="codehilite"><pre><span></span>root@minmi:/var/log/rabbitmq# tail startup_log 
{error_logger,{{2017,2,28},{0,8,42}},&quot;Protocol: ~tp: register/listen error: ~tp~n&quot;,[&quot;inet_tcp&quot;,econnrefused]}
{error_logger,{{2017,2,28},{0,8,42}},crash_report,[[{initial_call,{net_kernel,init,[&#39;Argument__1&#39;]}},{pid,&lt;0.21.0&gt;},{registered_name,[]},{error_info,{exit,{error,badarg},[{gen_server,init_it,6,[{file,&quot;gen_server.erl&quot;},{line,320}]},{proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,239}]}]}},{ancestors,[net_sup,kernel_sup,&lt;0.10.0&gt;]},{messages,[]},{links,[#Port&lt;0.93&gt;,&lt;0.18.0&gt;]},{dictionary,[{longnames,false}]},{trap_exit,true},{status,running},{heap_size,376},{stack_size,27},{reductions,803}],[]]}
{error_logger,{{2017,2,28},{0,8,42}},supervisor_report,[{supervisor,{local,net_sup}},{errorContext,start_error},{reason,{&#39;EXIT&#39;,nodistribution}},{offender,[{pid,undefined},{name,net_kernel},{mfargs,{net_kernel,start_link,[[rabbitmqprelaunch1729,shortnames]]}},{restart_type,permanent},{shutdown,2000},{child_type,worker}]}]}
{error_logger,{{2017,2,28},{0,8,42}},supervisor_report,[{supervisor,{local,kernel_sup}},{errorContext,start_error},{reason,{shutdown,{failed_to_start_child,net_kernel,{&#39;EXIT&#39;,nodistribution}}}},{offender,[{pid,undefined},{name,net_sup},{mfargs,{erl_distribution,start_link,[]}},{restart_type,permanent},{shutdown,infinity},{child_type,supervisor}]}]}
{error_logger,{{2017,2,28},{0,8,42}},crash_report,[[{initial_call,{application_master,init,[&#39;Argument__1&#39;,&#39;Argument__2&#39;,&#39;Argument__3&#39;,&#39;Argument__4&#39;]}},{pid,&lt;0.9.0&gt;},{registered_name,[]},{error_info,{exit,{{shutdown,{failed_to_start_child,net_sup,{shutdown,{failed_to_start_child,net_kernel,{&#39;EXIT&#39;,nodistribution}}}}},{kernel,start,[normal,[]]}},[{application_master,init,4,[{file,&quot;application_master.erl&quot;},{line,133}]},{proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,239}]}]}},{ancestors,[&lt;0.8.0&gt;]},{messages,[{&#39;EXIT&#39;,&lt;0.10.0&gt;,normal}]},{links,[&lt;0.8.0&gt;,&lt;0.7.0&gt;]},{dictionary,[]},{trap_exit,true},{status,running},{heap_size,376},{stack_size,27},{reductions,117}],[]]}
{error_logger,{{2017,2,28},{0,8,42}},std_info,[{application,kernel},{exited,{{shutdown,{failed_to_start_child,net_sup,{shutdown,{failed_to_start_child,net_kernel,{&#39;EXIT&#39;,nodistribution}}}}},{kernel,start,[normal,[]]}}},{type,permanent}]}
{&quot;Kernel pid terminated&quot;,application_controller,&quot;{application_start_failure,kernel,{{shutdown,{failed_to_start_child,net_sup,{shutdown,{failed_to_start_child,net_kernel,{&#39;EXIT&#39;,nodistribution}}}}},{kernel,start,[normal,[]]}}}&quot;}
</pre></div>



<a name="158565"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158565" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158565">(Feb 28 2017 at 00:11)</a>:</h4>
<p>before reboot startup_err was empty</p>



<a name="158570"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158570" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158570">(Feb 28 2017 at 00:43)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> I need to go out for a bit, I'll be back online in about two hours. I wonder if there's anything meaningful in that dump file.</p>



<a name="158573"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158573" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158573">(Feb 28 2017 at 00:47)</a>:</h4>
<p>interesting</p>



<a name="158611"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158611" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158611">(Feb 28 2017 at 02:47)</a>:</h4>
<p>All I'm getting out of the dump is something Erlang failed to start, which we already knew. Here's the beginning of it: </p>
<div class="codehilite"><pre><span></span>=erl_crash_dump:0.3
Tue Feb 28 00:08:43 2017
Slogan: Kernel pid terminated (application_controller) ({application_start_failure,kernel,{{shutdown
,{failed_to_start_child,net_sup,{shutdown,{failed_to_start_child,net_kernel,{&#39;EXIT&#39;,nodistribution}}
}}},{k
System version: Erlang R16B03 (erts-5.10.4) [source] [64-bit] [smp:2:2] [async-threads:10] [kernel-p
oll:false]
Compiled: Tue Aug 19 16:45:11 2014
Taints: 
Atoms: 4350
=memory
total: 9008176
processes: 3396304
processes_used: 3385640
system: 5611872
atom: 132249
atom_used: 109484
binary: 138552
code: 2625370
ets: 64264
</pre></div>



<a name="158612"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158612" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158612">(Feb 28 2017 at 02:48)</a>:</h4>
<p>I'm not seeing anything in the regular system logs besides something in boot.log that says rabbitmq failed</p>
<div class="codehilite"><pre><span></span> * Starting PostgreSQL 9.3 database server       ^[[128G ^M^[[122G[ OK ]
Starting memcached: memcached.
 ^[[33m*^[[39;49m FAILED - check /var/log/rabbitmq/startup_\{log, _err\}
 * Starting message broker rabbitmq-server       ^[[128G ^M^[[122G[^[[31mfail^[[39;49m]
Starting redis-server: redis-server.
</pre></div>



<a name="158613"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158613" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158613">(Feb 28 2017 at 02:50)</a>:</h4>
<p><a href="mailto:zulip@localhost-sasl.log" title="mailto:zulip@localhost-sasl.log">zulip@localhost-sasl.log</a> has "shutdown_error" but the timing says it's right after system boot. So it's rabbitmq shutting down? That doesn't match with other reports of it being terminated (I guess)</p>
<div class="codehilite"><pre><span></span>=SUPERVISOR REPORT==== 28-Feb-2017::00:08:18 ===
     Supervisor: {&lt;0.530.0&gt;,rabbit_channel_sup_sup}
     Context:    shutdown_error
     Reason:     shutdown
     Offender:   [{nb_children,1},
                  {name,channel_sup},
                  {mfargs,{rabbit_channel_sup,start_link,[]}},
                  {restart_type,temporary},
                  {shutdown,infinity},
                  {child_type,supervisor}]


=SUPERVISOR REPORT==== 28-Feb-2017::00:08:18 ===
     Supervisor: {&lt;0.310.0&gt;,rabbit_channel_sup_sup}
     Context:    shutdown_error
     Reason:     shutdown
     Offender:   [{nb_children,1},
                  {name,channel_sup},
                  {mfargs,{rabbit_channel_sup,start_link,[]}},
                  {restart_type,temporary},
                  {shutdown,infinity},
                  {child_type,supervisor}]


=SUPERVISOR REPORT==== 28-Feb-2017::00:08:18 ===
     Supervisor: {&lt;0.356.0&gt;,rabbit_channel_sup_sup}
     Context:    shutdown_error
     Reason:     shutdown
     Offender:   [{nb_children,1},
                  {name,channel_sup},
                  {mfargs,{rabbit_channel_sup,start_link,[]}},
                  {restart_type,temporary},
                  {shutdown,infinity},
                  {child_type,supervisor}]
</pre></div>



<a name="158614"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158614" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158614">(Feb 28 2017 at 02:53)</a>:</h4>
<p>cron keeps running<code>check-rabbitmq-consumers</code> and <code>check-rabbitmq-queue</code>, I guess that's expected. syslog isn't reporting errors.</p>



<a name="158615"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158615" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158615">(Feb 28 2017 at 02:54)</a>:</h4>
<p>I figure if I kick rabbitmq again it will resolve, but then fail on reboot once more.</p>



<a name="158616"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158616" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158616">(Feb 28 2017 at 02:57)</a>:</h4>
<p>If it's the hostname causing the problem, is that an actual configuration error or something known to be flaky? (I'm borrowing the domain name and Digital Ocean account, so I didn't set up the DNS. But the person who did knows a lot more about it than I do.)</p>



<a name="158619"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158619" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158619">(Feb 28 2017 at 03:11)</a>:</h4>
<p>When I try searching for that Kernel pid terminated message, I get something about an Ubuntu erlang bug from a few years ago: "epmd does not support binding to an IPv4 address anymore"<br>
<a href="https://bugs.launchpad.net/ubuntu/+source/erlang/+bug/1374109" target="_blank" title="https://bugs.launchpad.net/ubuntu/+source/erlang/+bug/1374109">https://bugs.launchpad.net/ubuntu/+source/erlang/+bug/1374109</a></p>



<a name="158620"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158620" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158620">(Feb 28 2017 at 03:16)</a>:</h4>
<p>Same search turns up <a href="https://github.com/zulip/zulip/issues/76" target="_blank" title="https://github.com/zulip/zulip/issues/76">zulip cannot start after restarting the server</a>, where a commenter has a workaround. But it's several years old, so I would think it would be long past</p>



<a name="158658"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158658" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158658">(Feb 28 2017 at 06:08)</a>:</h4>
<p><span class="user-mention" data-user-email="zulip@feorlen.org" data-user-id="397">@Andrea  Longo</span> what is in /etc/hosts on this system?</p>



<a name="158770"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158770" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158770">(Feb 28 2017 at 12:52)</a>:</h4>
<p>/etc/hosts says it's managed, the contents match the template (<code>127.0.1.1 $fqdn $hostname</code>) which appears to be normal for Digital Ocean. $fqdn is only showing the hostname, although changing that to the actual fqdn doesn't help. (Editing /etc/hosts persists across reboots, so maybe not so managed?) </p>
<div class="codehilite"><pre><span></span>root@minmi:~# dnsdomainname
grumpyoldunixgeek.com
root@minmi:/var/log/rabbitmq# hostname
minmi
root@minmi:/var/log/rabbitmq# cat /etc/hosts
# Your system has configured &#39;manage_etc_hosts&#39; as True.
[comments]

127.0.1.1 minmi.grumpyoldunixgeek.com minmi
127.0.0.1 localhost

[ipv6 stuff edited]
</pre></div>



<a name="158774"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158774" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158774">(Feb 28 2017 at 13:08)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> everything I've tried so far results in needing to restart rabbitmq after reboot. This is a standard DO Ubuntu 14.04 droplet, it seems like it shouldn't be that complicated. (Famous last words.)</p>



<a name="158887"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/158887" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#158887">(Feb 28 2017 at 17:27)</a>:</h4>
<p>hmm, weird</p>



<a name="159074"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/159074" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#159074">(Feb 28 2017 at 23:38)</a>:</h4>
<p>I need to re-install Zulip on this machine to work on a different issue, but presumably I can recreate this situation at any time. (I have the tarball I used originally.)</p>



<a name="159076"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/159076" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#159076">(Feb 28 2017 at 23:39)</a>:</h4>
<p>OK; I think given the sequence that ended up happening here, we'll probably want to retest from scratch anyway</p>



<a name="159078"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/159078" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#159078">(Feb 28 2017 at 23:40)</a>:</h4>
<p>Is there anything worth capturing now before I re-install?</p>



<a name="159080"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/159080" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#159080">(Feb 28 2017 at 23:44)</a>:</h4>
<p>I think the logs you posted are pretty complete</p>



<a name="159082"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/159082" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea  Longo <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#159082">(Feb 28 2017 at 23:46)</a>:</h4>
<p>I'll give this another try in a few days. Hopefully that will prove more enlightening.</p>



<a name="164952"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/164952" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antarishk Rajput <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#164952">(Mar 09 2017 at 14:12)</a>:</h4>
<blockquote>
<p>I'll fix that; did you not also get an exception?  When I tried running it that way, I got:</p>
</blockquote>
<p># ./zulip-puppet-apply <br>
Warning: Could not retrieve fact fqdn<br>
Error: Could not find class apt for zulip on node zulip<br>
Error: Could not find class apt for zulip on node zulip<br>
Traceback (most recent call last):<br>
  File "./zulip-puppet-apply", line 38, in &lt;module&gt;<br>
    subprocess.check_call(puppet_cmd + ['--noop', '--show_diff'])<br>
  File "/usr/lib/python2.7/subprocess.py", line 540, in check_call<br>
    raise CalledProcessError(retcode, cmd)<br>
subprocess.CalledProcessError: Command '['puppet', 'apply', '--modulepath', 'puppet', '-e', '\nExec { path =&gt; "/usr/sbin:/usr/bin:/sbin:/bin" }\ninclude apt\ninclude zulip::voyager\ninclude zulip::static_asset_compiler\n', '--noop', '--show_diff']' returned non-zero exit status 1</p>
<div class="codehilite"><pre><span></span>
</pre></div>


<p>I am facing the same error, Can somebody please show the right path to get out of it</p>



<a name="165030"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/165030" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#165030">(Mar 09 2017 at 19:01)</a>:</h4>
<p><code>cd ..; ./scripts/zulip-puppet-apply</code> :)</p>



<a name="165031"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/165031" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#165031">(Mar 09 2017 at 19:01)</a>:</h4>
<p>I guess <span class="user-mention" data-user-email="ldlenka95@gmail.com" data-user-id="1918">@Antarishk Rajput</span> since you seem to not be online right now</p>



<a name="165899"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/testing%20possible%20Zulip%201.4-%3E1.5%20RabbitMQ%20fix/near/165899" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antarishk Rajput <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/testing.20possible.20Zulip.201.2E4-.3E1.2E5.20RabbitMQ.20fix.html#165899">(Mar 11 2017 at 07:02)</a>:</h4>
<p>Thank You Tom ,  It worked , i will inform if i get further errors</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>