<html>
<head><meta charset="utf-8"><title>su: system error · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html">su: system error</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1129548"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1129548" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jennifer Hwang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1129548">(Mar 10 2021 at 19:39)</a>:</h4>
<p>I've been working on deploying zulip on Render (<a href="https://render.com/">https://render.com/</a>). Zulip fails configuring here: <a href="https://github.com/zulip/docker-zulip/blob/master/entrypoint.sh#L277">https://github.com/zulip/docker-zulip/blob/master/entrypoint.sh#L277</a></p>
<p>It's a little confusing since the user is set to zulip here (<a href="https://github.com/zulip/docker-zulip/blob/master/Dockerfile#L25">https://github.com/zulip/docker-zulip/blob/master/Dockerfile#L25</a>) and the <a href="http://entrypoint.sh">entrypoint.sh</a> script is run further down the Dockerfile here: <a href="https://github.com/zulip/docker-zulip/blob/master/Dockerfile#L85">https://github.com/zulip/docker-zulip/blob/master/Dockerfile#L85</a></p>
<p>Has anyone else run into this? I'm still investigating whether it's because a difference in Render's environment vs. other contexts. </p>
<p>This is the full log:</p>
<div class="codehilite"><pre><span></span><code>Mar 9 04:00:56 PM  === Begin Initial Configuration Phase ===
Mar 9 04:00:56 PM  Preparing and linking the uploads folder ...
Mar 9 04:00:56 PM  Prepared and linked the uploads directory.
Mar 9 04:00:56 PM  Executing nginx configuration ...
Mar 9 04:00:56 PM  Nginx configuration succeeded.
Mar 9 04:00:56 PM  Certificates configuration succeeded.
Mar 9 04:00:56 PM  Setting database configuration ...
Mar 9 04:00:56 PM  Setting key &quot;REMOTE_POSTGRES_HOST&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;REMOTE_POSTGRES_PORT&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;REMOTE_POSTGRES_SSLMODE&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Database configuration succeeded.
Mar 9 04:00:56 PM  Setting Zulip secrets ...
Mar 9 04:00:56 PM  Generating Zulip secrets ...
Mar 9 04:00:56 PM  generate_secrets: No new secrets to generate.
Mar 9 04:00:56 PM  Secrets generation succeeded.
Mar 9 04:00:56 PM  Zulip secrets configuration succeeded.
Mar 9 04:00:56 PM  Activating authentication backends ...
Mar 9 04:00:56 PM  Setting key &quot;AUTHENTICATION_BACKENDS&quot;, type &quot;array&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Adding authentication backend &quot;EmailAuthBackend&quot;.
Mar 9 04:00:56 PM  Authentication backend activation succeeded.
Mar 9 04:00:56 PM  Executing Zulip configuration ...
Mar 9 04:00:56 PM  Setting key &quot;EMAIL_HOST_USER&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;EXTERNAL_HOST&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;MEMCACHED_LOCATION&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;RABBITMQ_HOST&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;RABBITMQ_USER&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;RATE_LIMITING&quot;, type &quot;bool&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;REDIS_HOST&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;REDIS_PORT&quot;, type &quot;integer&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  Setting key &quot;ZULIP_ADMINISTRATOR&quot;, type &quot;string&quot; in file &quot;/etc/zulip/settings.py&quot;.
Mar 9 04:00:56 PM  su: System error
Mar 9 04:00:56 PM  Error in the Zulip configuration. Exiting.
</code></pre></div>



<a name="1129589"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1129589" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1129589">(Mar 10 2021 at 20:38)</a>:</h4>
<p><span class="user-mention" data-user-id="19148">@Jennifer Hwang</span> hmm, I haven't seen that error, but googling finds this: <a href="https://github.com/cri-o/cri-o/issues/3803">https://github.com/cri-o/cri-o/issues/3803</a></p>



<a name="1129590"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1129590" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1129590">(Mar 10 2021 at 20:39)</a>:</h4>
<p>I believe that is trying to drop permissions from <code>root</code> to the <code>zulip</code> user inside the container; so you should be able to attach a shell and debug that.  I'd guess it's some security setting you have configured conflicting with doing so using <code>su</code>.</p>



<a name="1129692"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1129692" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jennifer Hwang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1129692">(Mar 10 2021 at 22:03)</a>:</h4>
<p>Thanks Tim! That link is really useful! I'll give that a shot</p>



<a name="1129722"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1129722" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1129722">(Mar 10 2021 at 22:31)</a>:</h4>
<p>As a sidenote, I should mention we're not particularly proud of the <code>docker-zulip</code> implementation, as we adopted it from a community contributor and haven't fully modernized/adapted it, so certainly feel free to propose changes to how it works.</p>



<a name="1130646"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1130646" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jennifer Hwang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1130646">(Mar 12 2021 at 07:02)</a>:</h4>
<p>Thanks for letting me know! On that note <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> , I did figure out why the <code>su: system error</code> was happening! The link you sent was very relevant. We don't provide the CAP_AUDIT_WRITE capability in our docker run security contexts. This errors for zulip set up, since the user is the <code>root</code> user for most of the <a href="http://entrypoint.sh">entrypoint.sh</a> script then drops to the <code>zulip</code> user for a handful of set up scripts.</p>
<p>It would be nice if we could avoid adding that capability. I was wondering if it would be a good idea to restructure <code>entrypoint.sh</code>such that everything that requires the root is done in a separate script run from the Dockerfile and cached as part of the image. That way everything in <code>entrypoint.sh</code> can be run as the <code>zulip</code> user . I'm not very experienced with Dockerfiles (or bash scripts for that matter), so let me know if this makes sense or if there's a better approach!</p>



<a name="1130778"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1130778" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1130778">(Mar 12 2021 at 09:29)</a>:</h4>
<p><span class="user-mention" data-user-id="19148">@Jennifer Hwang</span> I think the challenge is that most of the steps that we need to do as the <code>zulip</code> user are things like initializing the database, which we can't do during container startup, because those need to run against the actual database container you're going to use.</p>



<a name="1130781"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1130781" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1130781">(Mar 12 2021 at 09:30)</a>:</h4>
<p>Oh, I guess you're thinking about moving the non-<code>zulip</code> user pieces (aka the <code>root</code> pieces).  That's a bit harder to audit, since I can't just search for <code>sudo</code>.</p>



<a name="1130783"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1130783" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1130783">(Mar 12 2021 at 09:32)</a>:</h4>
<p>Can you talk a bit about what CAP_AUDIT_WRITE does and why containers can't have it?  It'll be helpful for thinking about the design space.</p>



<a name="1130785"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1130785" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1130785">(Mar 12 2021 at 09:33)</a>:</h4>
<p>One thing to be aware of is even if we could change <code>entrypoint.sh</code>, there may be other places where we make the assumption that code can drop permissions.  Possibly they're only in scripts that wouldn't run in a production docker instance, but I'm not sure -- e.g. our backup restore script does that.</p>



<a name="1131243"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131243" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jennifer Hwang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131243">(Mar 12 2021 at 16:43)</a>:</h4>
<blockquote>
<p>Oh, I guess you're thinking about moving the non-zulip user pieces (aka the root pieces). That's a bit harder to audit, since I can't just search for sudo.</p>
</blockquote>
<p>Yes, this is what I was thinking! </p>
<blockquote>
<p>Can you talk a bit about what CAP_AUDIT_WRITE does and why containers can't have it? It'll be helpful for thinking about the design space.</p>
</blockquote>
<p>CAP_AUDIT_WRITE enables writing records to the kernel auditing log. The one reference I could find on potential security concerns is <code>CAP_AUDIT_WRITE may also allow the contained process to falsify logs or DOS the audit system</code> from <a href="https://blog.lizzie.io/linux-containers-in-500-loc.html">https://blog.lizzie.io/linux-containers-in-500-loc.html</a> </p>
<blockquote>
<p>One thing to be aware of is even if we could change <a href="http://entrypoint.sh">entrypoint.sh</a>, there may be other places where we make the assumption that code can drop permissions. Possibly they're only in scripts that wouldn't run in a production docker instance, but I'm not sure -- e.g. our backup restore script does that.</p>
</blockquote>
<p>This is a really good point! I hadn't thought of that. It sounds like changing <code>entrypoint.sh</code> might be an undertaking, and there might still be problems from executing other operational scripts. Are there other potential solutions that come to mind other than adding CAP_AUDIT_WRITE?</p>



<a name="1131485"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131485" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131485">(Mar 12 2021 at 21:16)</a>:</h4>
<p><span class="user-mention" data-user-id="19148">@Jennifer Hwang</span> I guess you can ask around with your team (which surely has more docker expertise than I do) as to whether there are other ways Docker systems offer for running scripts as a different user than using <code>su</code> inside the container.</p>



<a name="1131486"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131486" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131486">(Mar 12 2021 at 21:16)</a>:</h4>
<p>Also, maybe it's possible to patch <code>su</code> or pass an option or something so as to not require <code>CAP_AUDIT_WRITE</code>?</p>



<a name="1131550"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131550" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jennifer Hwang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131550">(Mar 12 2021 at 22:33)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="7">@Tim Abbott</span> ! That's super helpful. I'll investigate those options.</p>



<a name="1131552"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131552" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131552">(Mar 12 2021 at 22:37)</a>:</h4>
<p>This may be an Ubuntu 18.04 bug that was fixed in Ubuntu 20.04:</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span>docker run --cap-drop audit_write --rm -it ubuntu:18.04 su
<span class="go">su: System error</span>
<span class="gp">$ </span>docker run --cap-drop audit_write --rm -it ubuntu:20.04 su
<span class="gp">root@aaa5182b10c9:/#</span>
</code></pre></div>



<a name="1131553"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131553" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131553">(Mar 12 2021 at 22:39)</a>:</h4>
<p>So see if changing <code>FROM ubuntu:18.04 as base</code> to <code>FROM ubuntu:20.04 as base</code> works. I haven’t tried this with docker-zulip so it will probably fail in some trivial way, but it should be possible to get this working since Zulip itself runs fine on Ubuntu 20.04.</p>



<a name="1131554"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131554" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jennifer Hwang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131554">(Mar 12 2021 at 22:40)</a>:</h4>
<p>oh man! if this works, I will be so happy! Thanks for the suggestion <span class="user-mention" data-user-id="699">@Anders Kaseorg</span></p>



<a name="1131587"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131587" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131587">(Mar 12 2021 at 23:17)</a>:</h4>
<p>It's probably a good idea to just upgrade docker-zulip to 20.04 as the base image.</p>



<a name="1131590"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131590" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jennifer Hwang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131590">(Mar 12 2021 at 23:29)</a>:</h4>
<p>That just worked <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span> <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span> </p>
<p>I'm happy to push a PR if that sounds good to you? I was going to test it out on docker compose as well and click around, but if there's anything in particular to look out for or do, let me know!</p>



<a name="1131591"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131591" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jennifer Hwang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131591">(Mar 12 2021 at 23:30)</a>:</h4>
<p>Also, <span class="user-mention" data-user-id="699">@Anders Kaseorg</span> , how did you think of it being an Ubuntu 18.04 bug as a possibility? I'm not sure I would have ever realized that myself, so I'd love to learn how I can figure that out in the future.</p>



<a name="1131594"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131594" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131594">(Mar 12 2021 at 23:39)</a>:</h4>
<p>Sure a PR would be welcome.</p>
<p>I noticed that the <a href="https://github.com/cri-o/cri-o/issues/3803#issuecomment-634872526">resolution</a> in Tim’s bug link was “seems like a problem with the debian image as this doesn't happen in the latest image”, which suggested it must have been fixed at some point.</p>



<a name="1131595"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/su%3A%20system%20error/near/1131595" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jennifer Hwang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/su.3A.20system.20error.html#1131595">(Mar 12 2021 at 23:47)</a>:</h4>
<p>Good eye! Thanks again for taking a look and finding that! <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>