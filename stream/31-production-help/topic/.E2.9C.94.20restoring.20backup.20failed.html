<html>
<head><meta charset="utf-8"><title>✔ restoring backup failed · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html">✔ restoring backup failed</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1593510"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593510" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593510">(Jun 15 2023 at 01:57)</a>:</h4>
<p>My self-built server failed to upgrade from 7.0 to 7.1.<br>
I made a backup before the upgrade and created a new server with the same environment as the previous 7.0. When I restored the backup, it prompted the following error:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Notice:<span class="w"> </span>/Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Postgresql_base/Exec<span class="o">[</span>create_pgroonga_extension<span class="o">]</span>/returns:<span class="w"> </span>DETAIL:<span class="w">  </span>Could<span class="w"> </span>not<span class="w"> </span>open<span class="w"> </span>extension<span class="w"> </span>control<span class="w"> </span>file<span class="w"> </span><span class="s2">"/usr/share/postgresql/15/extension/pgroonga.control"</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory.
Notice:<span class="w"> </span>/Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Postgresql_base/Exec<span class="o">[</span>create_pgroonga_extension<span class="o">]</span>/returns:<span class="w"> </span>HINT:<span class="w">  </span>The<span class="w"> </span>extension<span class="w"> </span>must<span class="w"> </span>first<span class="w"> </span>be<span class="w"> </span>installed<span class="w"> </span>on<span class="w"> </span>the<span class="w"> </span>system<span class="w"> </span>where<span class="w"> </span>PostgreSQL<span class="w"> </span>is<span class="w"> </span>running.
Error:<span class="w"> </span><span class="s1">'bash -c '</span>cat<span class="w"> </span>/usr/share/postgresql/12/pgroonga_setup.sql<span class="w"> </span><span class="p">|</span><span class="w"> </span>su<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="s2">"psql -v ON_ERROR_STOP=1 zulip"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>touch<span class="w"> </span>/usr/share/postgresql/12/pgroonga_setup.sql.applied<span class="s1">''</span><span class="w"> </span>returned<span class="w"> </span><span class="m">3</span><span class="w"> </span>instead<span class="w"> </span>of<span class="w"> </span>one<span class="w"> </span>of<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span>
Error:<span class="w"> </span>/Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Postgresql_base/Exec<span class="o">[</span>create_pgroonga_extension<span class="o">]</span>/returns:<span class="w"> </span>change<span class="w"> </span>from<span class="w"> </span><span class="s1">'notrun'</span><span class="w"> </span>to<span class="w"> </span><span class="o">[</span><span class="s1">'0'</span><span class="o">]</span><span class="w"> </span>failed:<span class="w"> </span><span class="s1">'bash -c '</span>cat<span class="w"> </span>/usr/share/postgresql/12/pgroonga_setup.sql<span class="w"> </span><span class="p">|</span><span class="w"> </span>su<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="s2">"psql -v ON_ERROR_STOP=1 zulip"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>touch<span class="w"> </span>/usr/share/postgresql/12/pgroonga_setup.sql.applied<span class="s1">''</span><span class="w"> </span>returned<span class="w"> </span><span class="m">3</span><span class="w"> </span>instead<span class="w"> </span>of<span class="w"> </span>one<span class="w"> </span>of<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span>
Notice:<span class="w"> </span>/Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Supervisor/Service<span class="o">[</span>supervisor<span class="o">]</span>:<span class="w"> </span>Triggered<span class="w"> </span><span class="s1">'refresh'</span><span class="w"> </span>from<span class="w"> </span><span class="m">2</span><span class="w"> </span>events
Notice:<span class="w"> </span>Applied<span class="w"> </span>catalog<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span>.92<span class="w"> </span>seconds

Subcommand<span class="w"> </span>of<span class="w"> </span>/home/zulip/deployments/current/scripts/setup/restore-backup<span class="w"> </span>failed<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>status<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>/home/zulip/deployments/2023-06-15-09-38-12/scripts/zulip-puppet-apply<span class="w"> </span>-f
Actual<span class="w"> </span>error<span class="w"> </span>output<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>subcommand<span class="w"> </span>is<span class="w"> </span>just<span class="w"> </span>above<span class="w"> </span>this.
</code></pre></div>



<a name="1593511"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593511" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593511">(Jun 15 2023 at 01:59)</a>:</h4>
<p>Did you old host have PostgreSQL 15, or PostgreSQL 12?</p>



<a name="1593514"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593514" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593514">(Jun 15 2023 at 02:00)</a>:</h4>
<p><span class="user-mention" data-user-id="23474">@FaZang</span>: How did you install the new server?</p>
<p>See the note in <a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html#backups-export-and-import">https://zulip.readthedocs.io/en/latest/production/export-and-import.html#backups-export-and-import</a> about how the new server needs to have <code>scripts/setup/install</code> run with <code>--postgresql-version</code> matching whatever the backup was taken on</p>



<a name="1593515"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593515" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593515">(Jun 15 2023 at 02:01)</a>:</h4>
<p>OK,TKS</p>



<a name="1593516"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593516" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593516">(Jun 15 2023 at 02:01)</a>:</h4>
<p>We'd also like to see what the upgrade failure was, once you get your server back up and restored on 7.0.</p>



<a name="1593519"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593519" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593519">(Jun 15 2023 at 02:06)</a>:</h4>
<p>the log like this</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>root@zulip4x:/home/admins#<span class="w"> </span>/home/zulip/deployments/current/scripts/upgrade-zulip<span class="w"> </span>zulip-server-latest.tar.gz
<span class="m">2023</span>-06-15<span class="w"> </span><span class="m">02</span>:05:20,252<span class="w"> </span>upgrade-zulip:<span class="w"> </span>Archiving<span class="w"> </span>the<span class="w"> </span>tarball<span class="w"> </span>under<span class="w"> </span>/home/zulip/archives
<span class="m">2023</span>-06-15<span class="w"> </span><span class="m">02</span>:05:20,521<span class="w"> </span>upgrade-zulip:<span class="w"> </span>Unpacking<span class="w"> </span>the<span class="w"> </span>tarball
<span class="m">2023</span>-06-15<span class="w"> </span><span class="m">02</span>:05:22,383<span class="w"> </span>upgrade-zulip-stage-2:<span class="w"> </span>Upgrading<span class="w"> </span>from<span class="w"> </span><span class="m">7</span>.0<span class="w"> </span>to<span class="w"> </span><span class="m">7</span>.1,<span class="w"> </span><span class="k">in</span><span class="w"> </span>/home/zulip/deployments/2023-06-15-10-05-20
Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/backends/base/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">289</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>ensure_connection
<span class="w">    </span>self.connect<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/utils/asyncio.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">26</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>inner
<span class="w">    </span><span class="k">return</span><span class="w"> </span>func<span class="o">(</span>*args,<span class="w"> </span>**kwargs<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/backends/base/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">270</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>connect
<span class="w">    </span>self.connection<span class="w"> </span><span class="o">=</span><span class="w"> </span>self.get_new_connection<span class="o">(</span>conn_params<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/utils/asyncio.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">26</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>inner
<span class="w">    </span><span class="k">return</span><span class="w"> </span>func<span class="o">(</span>*args,<span class="w"> </span>**kwargs<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/backends/postgresql/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">275</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>get_new_connection
<span class="w">    </span><span class="nv">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>self.Database.connect<span class="o">(</span>**conn_params<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/psycopg2/__init__.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">122</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>connect
<span class="w">    </span><span class="nv">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_connect<span class="o">(</span>dsn,<span class="w"> </span><span class="nv">connection_factory</span><span class="o">=</span>connection_factory,<span class="w"> </span>**kwasync<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-08-11-13-54/zerver/lib/db.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">49</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>__init__
<span class="w">    </span>super<span class="o">()</span>.__init__<span class="o">(</span>*args,<span class="w"> </span>**kwargs<span class="o">)</span>
psycopg2.OperationalError:<span class="w"> </span>connection<span class="w"> </span>to<span class="w"> </span>server<span class="w"> </span>on<span class="w"> </span>socket<span class="w"> </span><span class="s2">"/var/run/postgresql/.s.PGSQL.5432"</span><span class="w"> </span>failed:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
<span class="w">    </span>Is<span class="w"> </span>the<span class="w"> </span>server<span class="w"> </span>running<span class="w"> </span>locally<span class="w"> </span>and<span class="w"> </span>accepting<span class="w"> </span>connections<span class="w"> </span>on<span class="w"> </span>that<span class="w"> </span>socket?


The<span class="w"> </span>above<span class="w"> </span>exception<span class="w"> </span>was<span class="w"> </span>the<span class="w"> </span>direct<span class="w"> </span>cause<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>exception:

Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-15-10-05-20/../current/manage.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">150</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span>execute_from_command_line<span class="o">(</span>sys.argv<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-15-10-05-20/../current/manage.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">115</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>execute_from_command_line
<span class="w">    </span>utility.execute<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/core/management/__init__.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">436</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>execute
<span class="w">    </span>self.fetch_command<span class="o">(</span>subcommand<span class="o">)</span>.run_from_argv<span class="o">(</span>self.argv<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/core/management/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">412</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>run_from_argv
<span class="w">    </span>self.execute<span class="o">(</span>*args,<span class="w"> </span>**cmd_options<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/core/management/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">458</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>execute
<span class="w">    </span><span class="nv">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>self.handle<span class="o">(</span>*args,<span class="w"> </span>**options<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/core/management/commands/shell.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">117</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>handle
<span class="w">    </span>exec<span class="o">(</span>options<span class="o">[</span><span class="s2">"command"</span><span class="o">]</span>,<span class="w"> </span>globals<span class="o">())</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;string&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/utils/asyncio.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">26</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>inner
<span class="w">    </span><span class="k">return</span><span class="w"> </span>func<span class="o">(</span>*args,<span class="w"> </span>**kwargs<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/backends/base/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">330</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>cursor
<span class="w">    </span><span class="k">return</span><span class="w"> </span>self._cursor<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/backends/base/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">306</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_cursor
<span class="w">    </span>self.ensure_connection<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/utils/asyncio.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">26</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>inner
<span class="w">    </span><span class="k">return</span><span class="w"> </span>func<span class="o">(</span>*args,<span class="w"> </span>**kwargs<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/backends/base/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">288</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>ensure_connection
<span class="w">    </span>with<span class="w"> </span>self.wrap_database_errors:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/utils.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">91</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>__exit__
<span class="w">    </span>raise<span class="w"> </span>dj_exc_value.with_traceback<span class="o">(</span>traceback<span class="o">)</span><span class="w"> </span>from<span class="w"> </span>exc_value
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/backends/base/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">289</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>ensure_connection
<span class="w">    </span>self.connect<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/utils/asyncio.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">26</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>inner
<span class="w">    </span><span class="k">return</span><span class="w"> </span>func<span class="o">(</span>*args,<span class="w"> </span>**kwargs<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/backends/base/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">270</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>connect
<span class="w">    </span>self.connection<span class="w"> </span><span class="o">=</span><span class="w"> </span>self.get_new_connection<span class="o">(</span>conn_params<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/utils/asyncio.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">26</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>inner
<span class="w">    </span><span class="k">return</span><span class="w"> </span>func<span class="o">(</span>*args,<span class="w"> </span>**kwargs<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/django/db/backends/postgresql/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">275</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>get_new_connection
<span class="w">    </span><span class="nv">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>self.Database.connect<span class="o">(</span>**conn_params<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/12a6b0b3c715a99547489039de2d978c2cc15621/zulip-py3-venv/lib/python3.10/site-packages/psycopg2/__init__.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">122</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>connect
<span class="w">    </span><span class="nv">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_connect<span class="o">(</span>dsn,<span class="w"> </span><span class="nv">connection_factory</span><span class="o">=</span>connection_factory,<span class="w"> </span>**kwasync<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-08-11-13-54/zerver/lib/db.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">49</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>__init__
<span class="w">    </span>super<span class="o">()</span>.__init__<span class="o">(</span>*args,<span class="w"> </span>**kwargs<span class="o">)</span>
django.db.utils.OperationalError:<span class="w"> </span>connection<span class="w"> </span>to<span class="w"> </span>server<span class="w"> </span>on<span class="w"> </span>socket<span class="w"> </span><span class="s2">"/var/run/postgresql/.s.PGSQL.5432"</span><span class="w"> </span>failed:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
<span class="w">    </span>Is<span class="w"> </span>the<span class="w"> </span>server<span class="w"> </span>running<span class="w"> </span>locally<span class="w"> </span>and<span class="w"> </span>accepting<span class="w"> </span>connections<span class="w"> </span>on<span class="w"> </span>that<span class="w"> </span>socket?

Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-15-10-05-20/scripts/lib/upgrade-zulip-stage-2"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">210</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span><span class="nv">django_pg_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>subprocess.check_output<span class="o">(</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/usr/lib/python3.10/subprocess.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">420</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>check_output
<span class="w">    </span><span class="k">return</span><span class="w"> </span>run<span class="o">(</span>*popenargs,<span class="w"> </span><span class="nv">stdout</span><span class="o">=</span>PIPE,<span class="w"> </span><span class="nv">timeout</span><span class="o">=</span>timeout,<span class="w"> </span><span class="nv">check</span><span class="o">=</span>True,
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/usr/lib/python3.10/subprocess.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">524</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>run
<span class="w">    </span>raise<span class="w"> </span>CalledProcessError<span class="o">(</span>retcode,<span class="w"> </span>process.args,
subprocess.CalledProcessError:<span class="w"> </span>Command<span class="w"> </span><span class="s1">'['</span>../current/manage.py<span class="s1">', '</span>shell<span class="s1">', '</span>-c<span class="s1">', '</span>from<span class="w"> </span>django.db<span class="w"> </span>import<span class="w"> </span>connection<span class="p">;</span><span class="w"> </span>print<span class="o">(</span>int<span class="o">(</span>connection.cursor<span class="o">()</span>.connection.server_version/10000<span class="o">))</span><span class="s1">']'</span><span class="w"> </span>returned<span class="w"> </span>non-zero<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>status<span class="w"> </span><span class="m">1</span>.

Zulip<span class="w"> </span>upgrade<span class="w"> </span>failed<span class="w"> </span><span class="o">(</span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span><span class="m">1</span><span class="o">)</span>!

The<span class="w"> </span>upgrade<span class="w"> </span>process<span class="w"> </span>is<span class="w"> </span>designed<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>idempotent,<span class="w"> </span>so<span class="w"> </span>you<span class="w"> </span>can<span class="w"> </span>retry<span class="w"> </span>after<span class="w"> </span>resolving<span class="w"> </span>whatever<span class="w"> </span>issue<span class="w"> </span>caused<span class="w"> </span>the<span class="w"> </span>failure<span class="w"> </span><span class="o">(</span>there<span class="w"> </span>should<span class="w"> </span>be<span class="w"> </span>a<span class="w"> </span>traceback<span class="w"> </span>above<span class="o">)</span>.<span class="w"> </span>A<span class="w"> </span>log<span class="w"> </span>of<span class="w"> </span>this<span class="w"> </span>installation<span class="w"> </span>is<span class="w"> </span>available<span class="w"> </span><span class="k">in</span><span class="w"> </span>/var/log/zulip/upgrade.log
</code></pre></div>



<a name="1593521"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593521" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593521">(Jun 15 2023 at 02:07)</a>:</h4>
<p>If, as the <code>zulip</code> user, you run this:</p>
<div class="codehilite"><pre><span></span><code>/home/zulip/deployments/current/manage.py shell -c &#39;from django.db import connection; print(int(connection.cursor().connection.server_version/10000))&#39;
</code></pre></div>
<p>...what does it output?</p>



<a name="1593523"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593523" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593523">(Jun 15 2023 at 02:07)</a>:</h4>
<p>Ah, OK, the complete error message answers that.</p>



<a name="1593525"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593525" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593525">(Jun 15 2023 at 02:08)</a>:</h4>
<p>Is your PostgreSQL server on a different host -- or did you stop it before running the upgrade?</p>



<a name="1593526"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593526" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593526">(Jun 15 2023 at 02:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/restoring.20backup.20failed/near/1593525">发言道</a>：</p>
<blockquote>
<p>Is your PostgreSQL server on a different host -- or did you stop it before running the upgrade?</p>
</blockquote>
<p>Yes, when I backed up, I followed the instructions, stopped the zulip server, then ran the backup command, and the upgrade command.</p>



<a name="1593527"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593527" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593527">(Jun 15 2023 at 02:10)</a>:</h4>
<p>How did you stop the zulip server -- <code>./scripts/stop-server</code> ?  That wouldn't stop PostgreSQL, though.</p>



<a name="1593528"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593528" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593528">(Jun 15 2023 at 02:11)</a>:</h4>
<p><code>/home/zulip/deployments/current/scripts/stop-server</code></p>



<a name="1593529"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593529" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593529">(Jun 15 2023 at 02:13)</a>:</h4>
<p>Yeah, that should be fine.</p>



<a name="1593530"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593530" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593530">(Jun 15 2023 at 02:13)</a>:</h4>
<p>and ... after this ran <code>su zulip -c '/home/zulip/deployments/current/manage.py backup'</code></p>



<a name="1593531"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593531" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593531">(Jun 15 2023 at 02:13)</a>:</h4>
<p>Oh my God, I destroyed my host myself!</p>



<a name="1593532"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593532" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593532">(Jun 15 2023 at 02:14)</a>:</h4>
<p><span aria-label="smiling face with tear" class="emoji emoji-1f972" role="img" title="smiling face with tear">:smiling_face_with_tear:</span></p>



<a name="1593533"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593533" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593533">(Jun 15 2023 at 02:14)</a>:</h4>
<p>This may be related to an error we're trying to debug around pgroonga.</p>



<a name="1593534"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593534" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593534">(Jun 15 2023 at 02:14)</a>:</h4>
<p>You should still be able to reinstall 7.0 with postgresql 12, and restore your backup fine.</p>



<a name="1593535"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593535" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593535">(Jun 15 2023 at 02:15)</a>:</h4>
<p>Ok, thanks, I'll try it again.</p>



<a name="1593558"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593558" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593558">(Jun 15 2023 at 04:18)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> Thanks to your help, I managed to restore to version 7.0.</p>



<a name="1593559"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593559" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> FaZang <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593559">(Jun 15 2023 at 04:32)</a>:</h4>
<p>This is the recovery process</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>tar<span class="w"> </span>-xf<span class="w"> </span>zulip-server-latest-v7.0.tar.gz

sudo<span class="w"> </span>-s<span class="w"> </span>./zulip-server-*/scripts/setup/install<span class="w"> </span>--email<span class="o">=</span>your<span class="w"> </span>email<span class="w"> </span>--hostname<span class="o">=</span>your<span class="w"> </span>hostname<span class="w"> </span>--postgresql-version<span class="o">=</span><span class="m">12</span>

<span class="c1"># Install Chinese full-text indexing plugin for postgres</span>
ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>post
apt-get<span class="w"> </span>install<span class="w"> </span>postgresql-server-dev-12<span class="w"> </span>gcc<span class="w"> </span>g++<span class="w"> </span>cmake<span class="w"> </span>make<span class="w"> </span>-y
su<span class="w"> </span>root
git<span class="w"> </span>clone<span class="w"> </span>https://ghproxy.com/https://github.com/jaiminpan/pg_jieba
<span class="nb">cd</span><span class="w"> </span>pg_jieba
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive

mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
cmake<span class="w"> </span>-DPostgreSQL_TYPE_INCLUDE_DIR<span class="o">=</span>/usr/include/postgresql/12/server<span class="w"> </span>..
make
make<span class="w"> </span>install

cp<span class="w"> </span>/usr/lib/postgresql/15/lib/pg_jieba.so<span class="w"> </span>/usr/lib/postgresql/12/lib/pg_jieba.so
cp<span class="w"> </span>/usr/share/postgresql/15/extension/pg_jieba.control<span class="w"> </span>/usr/share/postgresql/12/extension/pg_jieba.control
cp<span class="w"> </span>/usr/share/postgresql/15/extension/pg_jieba--1.1.1.sql<span class="w"> </span>/usr/share/postgresql/12/extension/pg_jieba--1.1.1.sql
cp<span class="w"> </span>/usr/share/postgresql/15/tsearch_data/jieba_base.dict<span class="w"> </span>/usr/share/postgresql/12/tsearch_data/jieba_base.dict
cp<span class="w"> </span>/usr/share/postgresql/15/tsearch_data/jieba_hmm.model<span class="w"> </span>/usr/share/postgresql/12/tsearch_data/jieba_hmm.model
cp<span class="w"> </span>/usr/share/postgresql/15/tsearch_data/jieba_user.dict<span class="w"> </span>/usr/share/postgresql/12/tsearch_data/jieba_user.dict
cp<span class="w"> </span>/usr/share/postgresql/15/tsearch_data/jieba.stop<span class="w"> </span>/usr/share/postgresql/12/tsearch_data/jieba.stop
cp<span class="w"> </span>/usr/share/postgresql/15/tsearch_data/jieba.idf<span class="w"> </span>/usr/share/postgresql/12/tsearch_data/jieba.idf

<span class="c1"># Restore Backup</span>
su<span class="w"> </span>root
/home/zulip/deployments/current/scripts/setup/restore-backup<span class="w"> </span>/home/myname/zulip-v7.0-backup-2023-06-14-22-53-17-343lymm2.tar.gz
</code></pre></div>



<a name="1593560"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20restoring%20backup%20failed/near/1593560" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20restoring.20backup.20failed.html#1593560">(Jun 15 2023 at 04:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="23474">FaZang</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>