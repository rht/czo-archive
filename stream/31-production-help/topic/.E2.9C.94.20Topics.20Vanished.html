<html>
<head><meta charset="utf-8"><title>✔ Topics Vanished · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html">✔ Topics Vanished</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1418271"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418271" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418271">(Aug 11 2022 at 10:31)</a>:</h4>
<p>We had a resolved topic that we needed to unresolve. The yellow bar appeared when I was writing a reply so clicked unresolve.  I then added the update this appeared on screen.</p>



<a name="1418272"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418272" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418272">(Aug 11 2022 at 10:32)</a>:</h4>
<p>What was then odd was that I could see the new update in a new topic with the same name, unresolved but the orginal was there too. I went to move the new one to the old. Completed this and after it had done something, the original topic had vanished as had many others unrelated to this.</p>



<a name="1418273"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418273" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418273">(Aug 11 2022 at 10:32)</a>:</h4>
<p>They have just gone. This is a bit of a disaster. How can we recover those and debug what happened here.</p>



<a name="1418279"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418279" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418279">(Aug 11 2022 at 11:11)</a>:</h4>
<p>On inspecting the database, they've completely vanished.</p>



<a name="1418280"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418280" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418280">(Aug 11 2022 at 11:11)</a>:</h4>
<p>Restored from a backup but this is concerning either way.</p>



<a name="1418302"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418302" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418302">(Aug 11 2022 at 11:57)</a>:</h4>
<p>Do you have any log data from around that time? Version you are running? Which client were you using?</p>



<a name="1418442"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418442" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418442">(Aug 11 2022 at 21:26)</a>:</h4>
<p><span class="user-mention" data-user-id="21057">@Matt</span> thanks for the report; this seems surprising given how Zulip is designed. How did you check whether the messages disappeared from the database?</p>



<a name="1418443"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418443" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418443">(Aug 11 2022 at 21:27)</a>:</h4>
<p>What I think is most likely what happened is that there was some sort of web client bug that caused the confusing state, and reloading your browser window would have resulted in the topic appearing unresolved as expected.</p>



<a name="1418444"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418444" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418444">(Aug 11 2022 at 21:27)</a>:</h4>
<p>I don't think there's any mechanism through which it would be possible for resolving a topic to delete a message from the database.</p>



<a name="1418445"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418445" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418445">(Aug 11 2022 at 21:29)</a>:</h4>
<p>Now, there is one thing that could cause messages in many older topics in a stream to disappear, namely: <a href="https://zulip.com/help/message-retention-policy">https://zulip.com/help/message-retention-policy</a></p>



<a name="1418446"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418446" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418446">(Aug 11 2022 at 21:29)</a>:</h4>
<p>So I'd check if someone set a message retention policy for the stream or organization around the time of what you experienced.</p>



<a name="1418447"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418447" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418447">(Aug 11 2022 at 21:30)</a>:</h4>
<p>(If so, messages deleted by retention policy can be restored for about a month after deletion from the <code>archivedmessage</code> table, basically as protection against mistakes where someone didn't realize the implications of their policy soon after changing it)</p>



<a name="1418495"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418495" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418495">(Aug 11 2022 at 22:49)</a>:</h4>
<p>I checked in the database. A good 10+ topics had all just vanished. I restored from a backup to restore them. I did try and replicate but couldn't cause it to happen a second time.</p>



<a name="1418497"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418497" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418497">(Aug 11 2022 at 22:50)</a>:</h4>
<p>We don't delete any data at a retention period for this stream.</p>



<a name="1418509"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418509" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418509">(Aug 11 2022 at 23:02)</a>:</h4>
<p>Have checked the <code>archivedmessage</code> table too but they're not in there.</p>



<a name="1418539"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418539" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418539">(Aug 11 2022 at 23:28)</a>:</h4>
<p>How are you checking if they vanished? Are you using the message IDs, the topics, or something else?</p>



<a name="1418540"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418540" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418540">(Aug 11 2022 at 23:29)</a>:</h4>
<p>Well the topics are no where to be seen and searching for the content of the messages are no longer there at all.</p>



<a name="1418545"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418545" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418545">(Aug 11 2022 at 23:32)</a>:</h4>
<p>Well, as you can imagine, we're very careful to avoid code paths that could accidentally delete things, so I think it's most likely that what's happening is something more like "Messages were accidentally moved to a different stream", or the search query being used to find them isn't correct, without further evidence. One thing that would be compelling proof that they were actually deleted is if you get the message IDs from your backup and see whether those message IDs appear in your message table or not.</p>



<a name="1418546"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418546" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418546">(Aug 11 2022 at 23:32)</a>:</h4>
<p>(Since message IDs are not changed when moving messages)</p>



<a name="1418800"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418800" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418800">(Aug 12 2022 at 09:49)</a>:</h4>
<p>This appears to have happened again. Similar thing before, renamed a topic, both the old name and new name remained and then topics in another stream all vanished.</p>



<a name="1418919"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418919" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418919">(Aug 12 2022 at 19:38)</a>:</h4>
<p><span class="user-mention" data-user-id="21057">@Matt</span> very strange. I still don't see any mechanism through which this might happen. Do you run any bots that delete messages? <br>
Since you said you have backups, can you compare with the backups to figure out whether messages are actually being deleted or just ending up in an unexpected place?</p>
<p>And can you investigate your database for whether there are gaps in the sequence of message IDs? </p>
<p>Comparing these may be helpful, for example; only deleted messages will be missing:</p>
<div class="codehilite"><pre><span></span><code>$ ./manage.py dbshell
zulip=&gt; select max(id) from zerver_message;
 max
-----
 112
(1 row)

zulip=&gt; select count(*) from zerver_message;
 count
-------
   112
(1 row)
</code></pre></div>



<a name="1418920"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418920" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418920">(Aug 12 2022 at 19:38)</a>:</h4>
<p>Have you fixed your Notification Bot issue yet?</p>



<a name="1418921"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1418921" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1418921">(Aug 12 2022 at 19:39)</a>:</h4>
<p>I could imagine this being related, in that notification bot sends a message when moving topics between streams, and that code path could thus be throwing an exception and not completing.</p>



<a name="1419301"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1419301" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1419301">(Aug 13 2022 at 13:48)</a>:</h4>
<p>That is all resolved and renamed in the database and settings file. They started coming through normally  after testing but this occurred again after that.</p>



<a name="1419302"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1419302" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1419302">(Aug 13 2022 at 13:50)</a>:</h4>
<p>Restored backup:</p>
<div class="codehilite"><pre><span></span><code>zulip=&gt; select max(id) from zerver_message;
  max
--------
 247775
(1 row)

zulip=&gt; select count(*) from zerver_message;
 count
-------
 24978
(1 row)
</code></pre></div>
<p>Server with missing data:</p>
<div class="codehilite"><pre><span></span><code>zulip=&gt; select max(id) from zerver_message;
  max
--------
 247806
(1 row)

zulip=&gt; select count(*) from zerver_message;
 count
-------
 24841
(1 row)
</code></pre></div>
<p>I need to deep dive in to IDs again but have been a bit tight on time but the count seems to indicate a loss of messages but need to manually verify with the backup and last live db side by side.</p>



<a name="1419305"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1419305" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1419305">(Aug 13 2022 at 14:07)</a>:</h4>
<p>OK have confirmed, that a sample of IDs that I know vanished, are missing entirely. 247034-247043 are only on the backup. One of the topis had multiple posts too whereas most just have the one post.</p>



<a name="1419306"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1419306" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1419306">(Aug 13 2022 at 14:10)</a>:</h4>
<p>And they do not exist in archived messages (manually deleted stuff does).</p>



<a name="1419361"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1419361" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1419361">(Aug 13 2022 at 22:07)</a>:</h4>
<p><span class="user-mention" data-user-id="21057">@Matt</span> fascinating. Was this happening every time a topic was moved before fixing the notification bot detail? If so, it may be worth sending some test messages, noting their IDs, and then trying to check whether you can still reproduce.</p>



<a name="1419362"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1419362" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1419362">(Aug 13 2022 at 22:09)</a>:</h4>
<p>I still see no mechanism for how messages would be deleted by this operation; it does a <code>Message.objects.bulk_update</code> to change the <code>topic</code> and possibly <code>stream</code> fields for the messages (Depending if you're moving between streams), but there's no code path that does a delete here.</p>



<a name="1419543"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1419543" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1419543">(Aug 14 2022 at 21:02)</a>:</h4>
<p>I'll continue to investigate. Is it normal for two versions of Postgres to be running? Seems 12 and 14 are. I doubt this is related but this seems odd?</p>



<a name="1419815"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1419815" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1419815">(Aug 15 2022 at 21:28)</a>:</h4>
<p>That is not expected, but might happen if you upgraded postgres at some point and didn't shut down the old version? I'd expect only 14 is being used.</p>



<a name="1420689"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1420689" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1420689">(Aug 17 2022 at 11:11)</a>:</h4>
<p>Well this stopped happening. Have removed psql12 too but not sure if that was related or not. Such an odd issue but will mark resolved for now and re-open if it comes back to haunt me later.</p>



<a name="1420690"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Topics%20Vanished/near/1420690" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Topics.20Vanished.html#1420690">(Aug 17 2022 at 11:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="21057">Matt</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>