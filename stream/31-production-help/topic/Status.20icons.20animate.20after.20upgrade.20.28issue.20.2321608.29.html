<html>
<head><meta charset="utf-8"><title>Status icons animate after upgrade (issue #21608) · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html">Status icons animate after upgrade (issue #21608)</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1357180"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357180" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alfons RV <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357180">(Mar 31 2022 at 15:37)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="19257">@Alya Abbott</span> – here for issue <a href="https://github.com/zulip/zulip/issues/21608">https://github.com/zulip/zulip/issues/21608</a></p>



<a name="1357183"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357183" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alfons RV <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357183">(Mar 31 2022 at 15:38)</a>:</h4>
<p>Didn't know Tim had a quite involved partner-in-crime already <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span></p>



<a name="1357189"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357189" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alfons RV <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357189">(Mar 31 2022 at 15:41)</a>:</h4>
<p>Just let me know what kind of information you need from me for interactive debugging~</p>



<a name="1357203"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357203" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alya Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357203">(Mar 31 2022 at 16:10)</a>:</h4>
<p>Thank's for stopping by!</p>
<p>Folks, <span class="user-mention" data-user-id="9948">@Alfons RV</span> reported that:</p>
<blockquote>
<p>Animated emojis uploaded before version 5.x used as status emojis are currently always animating next to user names in the sidebar and message feed, not only on hover.</p>
<p>Newly uploaded, animated emojis have the desired behavior, only animating on hover.</p>
</blockquote>



<a name="1357422"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357422" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357422">(Mar 31 2022 at 18:50)</a>:</h4>
<p><span class="user-mention" data-user-id="9948">@Alfons RV</span>: Can you show <code>rabbitmqctl list_queues</code>, and your <code>/var/log/upgrade.log</code>?</p>



<a name="1357481"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357481" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alfons RV <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357481">(Mar 31 2022 at 19:25)</a>:</h4>
<p>I updated the GitHub issue with the logs <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> <br>
<span class="user-mention" data-user-id="12178">@Alex Vandiver</span></p>



<a name="1357497"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357497" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357497">(Mar 31 2022 at 19:40)</a>:</h4>
<p>Those logs are very revealing but I don't have any theory for how this outcome is possible; updated the issue description with my observations. .</p>



<a name="1357512"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357512" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alfons RV <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357512">(Mar 31 2022 at 19:56)</a>:</h4>
<p>Think I upgraded from v4.8. The easiest thing would obviously be to re-apply the migration and hoping it's maybe just a unicorn server heh</p>



<a name="1357514"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357514" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357514">(Mar 31 2022 at 20:08)</a>:</h4>
<p><span class="user-mention" data-user-id="9948">@Alfons RV</span> I think that's certainly a thing to try; if that indeed doesn't work, then we can try adding print statements to that <code>deferred_work</code> code until we figure out what's going wrong.</p>



<a name="1357517"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357517" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357517">(Mar 31 2022 at 20:09)</a>:</h4>
<p>Do you know how to reapply migrations?  It's basically:</p>
<div class="codehilite"><pre><span></span><code># Confirm that migration 0386 is the last one applied.
./manage.py showmigrations

# Tell the migrations database to apply zerver migration 0376
./manage.py migrate zerver 0375 --fake
./manage.py migrate zerver 0376
# Update migrations database to original 5.0 migration state
./manage.py migrate zerver 0386 --fake
</code></pre></div>



<a name="1357520"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357520" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alfons RV <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357520">(Mar 31 2022 at 20:12)</a>:</h4>
<p>Yeah – thanks! Zulip was the reason I started learning Django so I could eventually contribute to it more than just the docs<br>
Even tho we're only a few people &amp; I think it looks quite cool for now with animated "legacy emojis" – ngl <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span></p>



<a name="1357597"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357597" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357597">(Mar 31 2022 at 22:17)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>: We enqueue the work before we restart the worker.  I think it may consume the events before it knows how to handle them</p>



<a name="1357598"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357598" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357598">(Mar 31 2022 at 22:17)</a>:</h4>
<p>Yeah, the worker just throws away things it doesn't recognize</p>



<a name="1357599"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357599" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357599">(Mar 31 2022 at 22:18)</a>:</h4>
<p>So this will break for all 5.0 upgrades</p>



<a name="1357604"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357604" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357604">(Mar 31 2022 at 22:18)</a>:</h4>
<p>Oh, that's annoying.</p>



<a name="1357605"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357605" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357605">(Mar 31 2022 at 22:19)</a>:</h4>
<p>So in general we can't use this pattern for deferred migrations</p>



<a name="1357606"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357606" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357606">(Mar 31 2022 at 22:19)</a>:</h4>
<p>Wait, don't we stop all workers before running migrations, in the default configuration?</p>



<a name="1357607"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357607" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357607">(Mar 31 2022 at 22:19)</a>:</h4>
<p>Hm, yeah.  Something must have started them again</p>



<a name="1357613"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357613" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357613">(Mar 31 2022 at 22:21)</a>:</h4>
<p>I don't see the puppet application in there, either</p>



<a name="1357614"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357614" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357614">(Mar 31 2022 at 22:21)</a>:</h4>
<p><span class="user-mention" data-user-id="9948">@Alfons RV</span>: Is that the <em>complete, unmodified</em> upgrade log?</p>



<a name="1357615"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357615" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357615">(Mar 31 2022 at 22:22)</a>:</h4>
<p>Here's where we decide whether to shut down the server:</p>
<div class="codehilite"><pre><span></span><code>if (not args.skip_puppet or migrations_needed) and IS_SERVER_UP:
    # By default, we shut down the service to apply migrations and
    # Puppet changes, to minimize risk of issues due to inconsistent
    # state.
    shutdown_server()
</code></pre></div>



<a name="1357616"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357616" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357616">(Mar 31 2022 at 22:22)</a>:</h4>
<p>This looks like it's missing some lines between them:</p>
<div class="codehilite"><pre><span></span><code>Removing obsolete dictionary files:
2022-03-29 21:18:15,758 upgrade-zulip-stage-2: Applying database migrations...
</code></pre></div>



<a name="1357617"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357617" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357617">(Mar 31 2022 at 22:23)</a>:</h4>
<p>Yeah, agreed, we can wait for <span class="user-mention silent" data-user-id="9948">Alfons RV</span> to provide the rest of the log.</p>



<a name="1357618"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357618" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357618">(Mar 31 2022 at 22:23)</a>:</h4>
<p>Specifically, it's possible that puppet restarted supervisor, in which case it may have started things back up again</p>



<a name="1357620"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357620" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357620">(Mar 31 2022 at 22:25)</a>:</h4>
<p>Here's the gap when it was shut down, then starts back up again before migrations start:</p>
<div class="codehilite"><pre><span></span><code>2022-03-29 21:15:09.519 INFO [process_queue] Worker 0 disconnecting from queue deferred_work
2022-03-29 21:17:45.710 INFO [process_queue] Worker 0 connecting to queue deferred_work
</code></pre></div>



<a name="1357621"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357621" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357621">(Mar 31 2022 at 22:25)</a>:</h4>
<p>So I'm guessing puppet</p>



<a name="1357626"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357626" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357626">(Mar 31 2022 at 22:27)</a>:</h4>
<p>I think that explains it!  I'm pretty sure we had at least one configuration change in the 5.0 release cycle causing supervisord to restart.</p>



<a name="1357627"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357627" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357627">(Mar 31 2022 at 22:27)</a>:</h4>
<p>The only thing which triggers a restart of supervisor itself is ./puppet/zulip/templates/supervisor/supervisord.conf.erb which is unchanged</p>



<a name="1357628"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357628" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357628">(Mar 31 2022 at 22:28)</a>:</h4>
<p>I think I was thinking of <a href="https://github.com/zulip/zulip/commit/358a7fb0c61d2f1637c41ebb92d597e1df427ff5">358a7fb0c61d2f1637c41ebb92d597e1df427ff5</a>?</p>



<a name="1357629"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357629" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357629">(Mar 31 2022 at 22:28)</a>:</h4>
<p>Hm.  Though I don't know if a <code>update &amp;&amp; reread</code> of an affected but stopped service restarts it</p>



<a name="1357630"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357630" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357630">(Mar 31 2022 at 22:28)</a>:</h4>
<p>That doesn't do a restart of supervisor; that triffers a re-read and update, which only refreshes that supervisor service</p>



<a name="1357631"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357631" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357631">(Mar 31 2022 at 22:28)</a>:</h4>
<p>Yeah, hmm.</p>



<a name="1357632"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357632" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357632">(Mar 31 2022 at 22:29)</a>:</h4>
<p>Anyway I think that's potentially a solid theory. If that's accurate, then probably the fix would be to have a conditional stop-all-services in between here?</p>
<div class="codehilite"><pre><span></span><code>if not args.skip_puppet:
    logging.info(&quot;Applying Puppet changes...&quot;)
    subprocess.check_call([&quot;./scripts/zulip-puppet-apply&quot;, &quot;--force&quot;])
    subprocess.check_call([&quot;apt-get&quot;, &quot;-y&quot;, &quot;--allow-downgrades&quot;, &quot;upgrade&quot;])

if migrations_needed:
    logging.info(&quot;Applying database migrations...&quot;)
    subprocess.check_call([&quot;./manage.py&quot;, &quot;migrate&quot;, &quot;--noinput&quot;], preexec_fn=su_to_zulip)
</code></pre></div>



<a name="1357633"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357633" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357633">(Mar 31 2022 at 22:30)</a>:</h4>
<p>And then additionally we probably need to just duplicate the migration to cover servers that failed to reupload custom emoji the first time.</p>



<a name="1357634"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357634" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357634">(Mar 31 2022 at 22:31)</a>:</h4>
<p>We are already papering over this problem <a href="https://github.com/zulip/zulip/blob/main/scripts/lib/upgrade-zulip-stage-2#L369-L380">elsewhere in the upgrade script</a>:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="k">if</span> <span class="n">IS_SERVER_UP</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">skip_puppet</span><span class="p">:</span>
    <span class="c1"># Even if the server wasn't up previously, puppet might have</span>
    <span class="c1"># started it if there were supervisord configuration changes, so</span>
    <span class="c1"># we need to use restart-server if puppet ran.</span>
    <span class="n">restart_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"--fill-cache"</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">skip_tornado</span><span class="p">:</span>
        <span class="n">restart_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"--skip-tornado"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">less_graceful</span><span class="p">:</span>
        <span class="n">restart_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"--less-graceful"</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">"./scripts/restart-server"</span><span class="p">,</span> <span class="o">*</span><span class="n">restart_args</span><span class="p">],</span> <span class="n">preexec_fn</span><span class="o">=</span><span class="n">su_to_zulip</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">"./scripts/start-server"</span><span class="p">,</span> <span class="s2">"--fill-cache"</span><span class="p">],</span> <span class="n">preexec_fn</span><span class="o">=</span><span class="n">su_to_zulip</span><span class="p">)</span>
</code></pre></div>



<a name="1357635"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357635" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357635">(Mar 31 2022 at 22:31)</a>:</h4>
<p>Which should have pointed us at this potential badness</p>



<a name="1357636"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357636" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357636">(Mar 31 2022 at 22:31)</a>:</h4>
<p>Though it seems better to make puppet leave services in the right state, if we can</p>



<a name="1357639"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357639" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357639">(Mar 31 2022 at 22:33)</a>:</h4>
<p>But I just checked that changing any one supervisor worker definition causes *all( of them to start with <code>supervisorctl reread &amp;&amp; supervisorctl update</code></p>



<a name="1357640"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357640" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357640">(Mar 31 2022 at 22:33)</a>:</h4>
<p>Huh, I wouldn't have expected that sequence to start workers that were currently not running.</p>



<a name="1357641"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357641" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357641">(Mar 31 2022 at 22:34)</a>:</h4>
<p>The problem is the services are marked <code>autostart=true</code> which is right on startup, but not right during re-read</p>



<a name="1357642"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357642" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357642">(Mar 31 2022 at 22:36)</a>:</h4>
<div class="codehilite"><pre><span></span><code>root@alexmv-prod:~# supervisorctl reread &amp;&amp; supervisorctl update
zulip-workers: changed
zulip-workers: stopped
zulip-workers: updated process group
</code></pre></div>



<a name="1357643"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357643" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357643">(Mar 31 2022 at 22:37)</a>:</h4>
<p><a href="https://github.com/Supervisor/supervisor/blob/d76f548019745d1ef74a6f50c1d52c99575a32c8/supervisor/supervisorctl.py#L1223-L1231">https://github.com/Supervisor/supervisor/blob/d76f548019745d1ef74a6f50c1d52c99575a32c8/supervisor/supervisorctl.py#L1223-L1231</a></p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code>        <span class="k">for</span> <span class="n">gname</span> <span class="ow">in</span> <span class="n">changed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">valid_gnames</span> <span class="ow">and</span> <span class="n">gname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_gnames</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">supervisor</span><span class="o">.</span><span class="n">stopProcessGroup</span><span class="p">(</span><span class="n">gname</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">gname</span><span class="p">,</span> <span class="s2">"stopped"</span><span class="p">)</span>

            <span class="n">supervisor</span><span class="o">.</span><span class="n">removeProcessGroup</span><span class="p">(</span><span class="n">gname</span><span class="p">)</span>
            <span class="n">supervisor</span><span class="o">.</span><span class="n">addProcessGroup</span><span class="p">(</span><span class="n">gname</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">gname</span><span class="p">,</span> <span class="s2">"updated process group"</span><span class="p">)</span>
</code></pre></div>



<a name="1357644"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357644" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357644">(Mar 31 2022 at 22:38)</a>:</h4>
<p>So I don't see any way around this, short of making them not <code>autostart=true</code>.</p>
<p>We could make a different service which <em>is</em> <code>autostart=true</code> and starts everything else using start-server, but that seems hacky.</p>



<a name="1357645"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357645" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357645">(Mar 31 2022 at 22:38)</a>:</h4>
<p>And means that doing a <code>update &amp;&amp; re-read</code> will <em>stop</em> any service which is running -- as opposed to now, when it's pretty seamless.</p>



<a name="1357646"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357646" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357646">(Mar 31 2022 at 22:39)</a>:</h4>
<p>Yeah, it seems without forking supervisord or getting them to add new options, that direction is not super viable.</p>



<a name="1357647"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357647" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357647">(Mar 31 2022 at 22:39)</a>:</h4>
<p>I think it'd be pretty viable to have a duplicate <code>stop-server</code> call before the migrations with an appropriate conditional.</p>



<a name="1357648"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357648" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357648">(Mar 31 2022 at 22:40)</a>:</h4>
<p>Especially because we're now checking what services are running not using the <code>supervisord</code> slow to startup Python process, it probably wouldn't need to add material latency to the restart process,</p>



<a name="1357649"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357649" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357649">(Mar 31 2022 at 22:40)</a>:</h4>
<p>I love making more conflicts for my <a href="https://github.com/zulip/zulip/pull/21570">#21570</a>, sure. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1357650"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357650" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357650">(Mar 31 2022 at 22:41)</a>:</h4>
<p>How else will you get excuses to practice your rebase skills? <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1357658"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357658" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357658">(Mar 31 2022 at 22:52)</a>:</h4>
<p>The <em>other</em> option is that before applying puppet, we repoint "current"</p>



<a name="1357659"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357659" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357659">(Mar 31 2022 at 22:52)</a>:</h4>
<p>So that if it does start things up, they're the <em>new</em> code</p>



<a name="1357660"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357660" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357660">(Mar 31 2022 at 22:53)</a>:</h4>
<p>We don't want to repoint <code>current</code> until we're committed to completing the upgrade for error-handling reasons.</p>



<a name="1357661"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357661" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357661">(Mar 31 2022 at 22:53)</a>:</h4>
<p>Mmm, and we can't actually run that code until we've done migrations.</p>



<a name="1357662"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357662" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357662">(Mar 31 2022 at 22:54)</a>:</h4>
<p>Yeah, good point.</p>



<a name="1357663"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357663" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357663">(Mar 31 2022 at 22:55)</a>:</h4>
<p>The other direction we could go in is running migrations before puppet. I'm pretty sure the reason we don't do that is because <code>puppet</code> might in theory install some <code>apt</code> dependency that we need in order to run migrations.</p>



<a name="1357665"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357665" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357665">(Mar 31 2022 at 22:56)</a>:</h4>
<p>Oh, or more simply, that we need <code>postgres</code> configuration adjustments or whatever to run in order to do so.</p>



<a name="1357666"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357666" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357666">(Mar 31 2022 at 22:57)</a>:</h4>
<p>I feel like it could work to change that but it seems like a change that could have unforeseen consequences, so not something I'd want to backport.</p>



<a name="1357667"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357667" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357667">(Mar 31 2022 at 22:57)</a>:</h4>
<p>Yeah, agree.</p>



<a name="1357706"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357706" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357706">(Mar 31 2022 at 23:29)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/pull/21644">#21644</a>.</p>



<a name="1357739"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357739" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357739">(Mar 31 2022 at 23:55)</a>:</h4>
<p>I like that this cleans up some previously pretty weird conditionals.</p>



<a name="1357742"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357742" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357742">(Mar 31 2022 at 23:57)</a>:</h4>
<p>We may just want to plan to backport <a href="https://github.com/zulip/zulip/pull/21570">#21570</a> as a whole once we've given it more of a shake-down, and leave <a href="https://github.com/zulip/zulip/pull/21644">#21644</a> as the minimal fix that it is for now.</p>



<a name="1357775"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357775" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357775">(Apr 01 2022 at 00:21)</a>:</h4>
<p>Yeah, I'm fine with that plan.</p>



<a name="1357777"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357777" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357777">(Apr 01 2022 at 00:21)</a>:</h4>
<p>I've merged <a href="https://github.com/zulip/zulip/pull/21644">#21644</a>; feel free to backport.</p>



<a name="1357779"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357779" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357779">(Apr 01 2022 at 00:22)</a>:</h4>
<p>And I guess we still need to make the migration, but we should otherwise be ready to publish a 5.1 release?</p>



<a name="1357783"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357783" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357783">(Apr 01 2022 at 00:29)</a>:</h4>
<p>Opened <a href="https://github.com/zulip/zulip/pull/21647">https://github.com/zulip/zulip/pull/21647</a> for the migration. I have not done any manual testing.</p>



<a name="1357999"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1357999" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alfons RV <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1357999">(Apr 01 2022 at 09:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29/near/1357614">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="9948">Alfons RV</span>: Is that the <em>complete, unmodified</em> upgrade log?</p>
</blockquote>
<p>I updated my GitHub comment with the full upgrade log.</p>



<a name="1358363"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358363" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358363">(Apr 01 2022 at 22:24)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> <span class="user-mention silent" data-user-id="699">Anders Kaseorg</span> had the thought that we could delete those lines from migration 0376, which I think is a correct way to avoid the extra work of uploading twice on systems that upgrade directly to 5.1+. Thoughts?</p>



<a name="1358364"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358364" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358364">(Apr 01 2022 at 22:25)</a>:</h4>
<p>That sounds smart to me!</p>



<a name="1358366"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358366" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358366">(Apr 01 2022 at 22:25)</a>:</h4>
<p>I just merged and cherry-picked <a href="https://github.com/zulip/zulip/pull/21647">#21647</a></p>



<a name="1358367"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358367" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358367">(Apr 01 2022 at 22:25)</a>:</h4>
<p>So we can do that as a follow-up</p>



<a name="1358421"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358421" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358421">(Apr 01 2022 at 23:16)</a>:</h4>
<p>Sounds good. I think that follow-up is the only other thing we should consider doing before 5.1.</p>



<a name="1358515"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358515" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358515">(Apr 02 2022 at 00:08)</a>:</h4>
<p>I'll open a PR for that.</p>



<a name="1358516"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358516" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358516">(Apr 02 2022 at 00:08)</a>:</h4>
<p>Hang on<br>
Just about pushed</p>



<a name="1358517"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358517" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358517">(Apr 02 2022 at 00:08)</a>:</h4>
<p>ok</p>



<a name="1358518"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358518" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358518">(Apr 02 2022 at 00:09)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/pull/21658">#21658</a>.</p>



<a name="1358523"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358523" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358523">(Apr 02 2022 at 00:10)</a>:</h4>
<p>OK I'll fix a few things; I just prototyped that and your version will fail lint, but I like your comments better <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1358525"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358525" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358525">(Apr 02 2022 at 00:10)</a>:</h4>
<p>Want to start on the changelog?</p>



<a name="1358526"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358526" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358526">(Apr 02 2022 at 00:11)</a>:</h4>
<p>Heh.</p>
<p>Sure, will do.</p>



<a name="1358529"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358529" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358529">(Apr 02 2022 at 00:17)</a>:</h4>
<p>OK, pushed my updated version.</p>



<a name="1358720"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Status%20icons%20animate%20after%20upgrade%20%28issue%20%2321608%29/near/1358720" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Status.20icons.20animate.20after.20upgrade.20.28issue.20.2321608.29.html#1358720">(Apr 02 2022 at 07:00)</a>:</h4>
<p><span class="user-mention" data-user-id="9948">@Alfons RV</span> you should be able to upgrade to 5.1 for the fix to this bug.  Thanks for the report!</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>