<html>
<head><meta charset="utf-8"><title>upgrade · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html">upgrade</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="24853"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/24853" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#24853">(Sep 16 2016 at 17:54)</a>:</h4>
<p>This afternoon/evening, we're planning an upgrade of our fairly large (~2k users) Zulip installation from 1.3.12 to the latest (1.4.1)</p>



<a name="24855"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/24855" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#24855">(Sep 16 2016 at 17:54)</a>:</h4>
<p>Ooh, fun :).  What time?</p>



<a name="24856"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/24856" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#24856">(Sep 16 2016 at 17:55)</a>:</h4>
<p>That's flexible, if there are times that you would prefer. ;)</p>



<a name="24857"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/24857" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#24857">(Sep 16 2016 at 17:55)</a>:</h4>
<p>But, roughly, "after work EST".</p>



<a name="24858"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/24858" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#24858">(Sep 16 2016 at 17:56)</a>:</h4>
<p>OK.  I probably get busy around 6PM Pacific, so I guess I'd recommend going for "shortly after work"</p>



<a name="24859"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/24859" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#24859">(Sep 16 2016 at 17:57)</a>:</h4>
<p>Sure thing.</p>



<a name="24860"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/24860" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#24860">(Sep 16 2016 at 17:58)</a>:</h4>
<p>I'll make the announcement for 2PM PT?</p>



<a name="24861"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/24861" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#24861">(Sep 16 2016 at 18:00)</a>:</h4>
<p>sure, that works for me</p>



<a name="25089"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25089" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25089">(Sep 16 2016 at 20:58)</a>:</h4>
<p>Starting the upgrade now.</p>



<a name="25090"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25090" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25090">(Sep 16 2016 at 20:59)</a>:</h4>
<p>Cool!  </p>



<a name="25091"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25091" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25091">(Sep 16 2016 at 21:01)</a>:</h4>
<p>Interesting.</p>



<a name="25092"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25092" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25092">(Sep 16 2016 at 21:01)</a>:</h4>
<p>The unpack-zulip command is erroring.</p>



<a name="25093"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25093" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25093">(Sep 16 2016 at 21:01)</a>:</h4>
<p>traceback?</p>



<a name="25094"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25094" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25094">(Sep 16 2016 at 21:01)</a>:</h4>
<div class="codehilite"><pre>2016-09-16 21:01:02,053 upgrade-zulip: Unpacking the tarball
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2016-05-13-04-17-09/scripts/lib/unpack-zulip&quot;, line 25, in &lt;module&gt;
    subprocess.check_call([&quot;mv&quot;, glob.glob(os.path.join(extract_path, &quot;zulip-server-*&quot;))[0], deploy_path])
IndexError: list index out of range
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 46, in &lt;module&gt;
    preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 573, in check_output
    raise CalledProcessError(retcode, cmd, output=output)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2016-05-13-04-17-09/scripts/lib/unpack-zulip&#39;, &#39;/home/zulip/archives/zulip-1.4.1.tar.gz&#39;]&#39; returned non-zero exit status 1
</pre></div>



<a name="25095"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25095" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25095">(Sep 16 2016 at 21:01)</a>:</h4>
<p>you're going directly to 1.4.1 right?</p>



<a name="25096"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25096" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25096">(Sep 16 2016 at 21:01)</a>:</h4>
<p>Trying to, yes.</p>



<a name="25098"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25098" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25098">(Sep 16 2016 at 21:02)</a>:</h4>
<p>Hmm that's a new exception to me :)</p>



<a name="25102"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25102" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25102">(Sep 16 2016 at 21:02)</a>:</h4>
<p>And to me.  Bizarre.</p>



<a name="25105"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25105" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25105">(Sep 16 2016 at 21:02)</a>:</h4>
<p>should be pretty debuggable whatever it is...</p>



<a name="25106"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25106" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25106">(Sep 16 2016 at 21:03)</a>:</h4>
<p>I've confirmed the tarball extracts normally.</p>



<a name="25116"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25116" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25116">(Sep 16 2016 at 21:06)</a>:</h4>
<p>Aha.</p>



<a name="25117"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25117" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25117">(Sep 16 2016 at 21:06)</a>:</h4>
<p>The file needs to be named zulip-server-1.4.1.</p>



<a name="25118"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25118" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25118">(Sep 16 2016 at 21:06)</a>:</h4>
<p>The ones from github are just zulip-1.4.1</p>



<a name="25119"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25119" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25119">(Sep 16 2016 at 21:06)</a>:</h4>
<p>oh, don't use the things GitHub generates</p>



<a name="25120"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25120" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25120">(Sep 16 2016 at 21:06)</a>:</h4>
<p>You should always grab them from the <a href="http://zulip.org" target="_blank" title="http://zulip.org">zulip.org</a> links</p>



<a name="25121"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25121" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25121">(Sep 16 2016 at 21:06)</a>:</h4>
<p>Yup.</p>



<a name="25122"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25122" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25122">(Sep 16 2016 at 21:06)</a>:</h4>
<p>Grabbing now.</p>



<a name="25123"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25123" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25123">(Sep 16 2016 at 21:06)</a>:</h4>
<p>We need to figure out how to disable the github ones</p>



<a name="25124"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25124" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25124">(Sep 16 2016 at 21:07)</a>:</h4>
<p>I'll investigate that</p>



<a name="25125"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25125" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25125">(Sep 16 2016 at 21:10)</a>:</h4>
<p>Well it looks like we could upload our release tarballs to GitHub's release pages, but it requires using their API, not the webapp</p>



<a name="25126"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25126" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25126">(Sep 16 2016 at 21:10)</a>:</h4>
<p>It's amazing how half-baked GitHub is for being the thing everyone uses :)</p>



<a name="25142"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25142" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25142">(Sep 16 2016 at 21:17)</a>:</h4>
<p>Anyway, how's the upgrade going?</p>



<a name="25144"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25144" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25144">(Sep 16 2016 at 21:20)</a>:</h4>
<p>So far, so good.  I always forget that this host doesn't have internet access, and then have to remember how I setup the necessary SSH incantations to jump backwards.</p>



<a name="25145"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25145" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25145">(Sep 16 2016 at 21:20)</a>:</h4>
<p>But I've got that sorted now.</p>



<a name="25146"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25146" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25146">(Sep 16 2016 at 21:21)</a>:</h4>
<p>In the package upgrade step.</p>



<a name="25147"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25147" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25147">(Sep 16 2016 at 21:21)</a>:</h4>
<p>OK cool</p>



<a name="25148"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25148" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25148">(Sep 16 2016 at 21:23)</a>:</h4>
<p>pip installing now.</p>



<a name="25155"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25155" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25155">(Sep 16 2016 at 21:27)</a>:</h4>
<p>Well, I did get a set of errors.  Memcached.</p>



<a name="25156"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25156" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25156">(Sep 16 2016 at 21:27)</a>:</h4>
<p>traceback?</p>



<a name="25157"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25157" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25157">(Sep 16 2016 at 21:27)</a>:</h4>
<div class="codehilite"><pre>Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 29, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 338, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 330, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 390, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 441, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zerver/management/commands/fill_memcached_caches.py&quot;, line 21, in handle
    fill_remote_cache(cache)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zerver/lib/cache_helpers.py&quot;, line 95, in fill_remote_cache
    cache_set_many(items_for_remote_cache, timeout=3600*24*7)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zerver/lib/cache.py&quot;, line 183, in cache_set_many
    get_cache_backend(cache_name).set_many(items, timeout=timeout)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/cache/backends/memcached.py&quot;, line 154, in set_many
    self._cache.set_multi(safe_data, self.get_backend_timeout(timeout))
_pylibmc.ConnectionError: error 3 from memcached_set_multi: (24892464) CONNECTION FAILURE, host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:544
Traceback (most recent call last):
  File &quot;./scripts/restart-server&quot;, line 27, in &lt;module&gt;
    subprocess.check_call([&quot;python&quot;, &quot;./manage.py&quot;, &quot;fill_memcached_caches&quot;])
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;python&#39;, &#39;./manage.py&#39;, &#39;fill_memcached_caches&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/scripts/lib/upgrade-zulip-stage-2&quot;, line 84, in &lt;module&gt;
    subprocess.check_output([&quot;./scripts/restart-server&quot;], preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 573, in check_output
    raise CalledProcessError(retcode, cmd, output=output)
subprocess.CalledProcessError: Command &#39;[&#39;./scripts/restart-server&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 53, in &lt;module&gt;
    subprocess.check_call([os.path.abspath(&quot;./scripts/lib/upgrade-zulip-stage-2&quot;), deploy_path])
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2016-09-16-21-19-55/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2016-09-16-21-19-55&#39;]&#39; returned non-zero exit status 1
</pre></div>



<a name="25158"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25158" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25158">(Sep 16 2016 at 21:27)</a>:</h4>
<p>It looks like memcached didn't get started after the puppet refresh.</p>



<a name="25162"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25162" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25162">(Sep 16 2016 at 21:29)</a>:</h4>
<p>yep, that is what it looks like</p>



<a name="25163"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25163" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25163">(Sep 16 2016 at 21:29)</a>:</h4>
<p>Or didn't start quickly enough, if it did start</p>



<a name="25166"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25166" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25166">(Sep 16 2016 at 21:29)</a>:</h4>
<p>How should I resume where I was?</p>



<a name="25167"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25167" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25167">(Sep 16 2016 at 21:30)</a>:</h4>
<p>/home/zulip/deployments/next/scripts/restart-server</p>



<a name="25168"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25168" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25168">(Sep 16 2016 at 21:30)</a>:</h4>
<p>(that was on the last step that actually does the restart, basically)</p>



<a name="25169"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25169" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25169">(Sep 16 2016 at 21:30)</a>:</h4>
<p>Tons of "warning Session data corrupted" is spewing out.</p>



<a name="25170"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25170" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25170">(Sep 16 2016 at 21:31)</a>:</h4>
<p>But eventually it restarted.</p>



<a name="25171"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25171" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25171">(Sep 16 2016 at 21:31)</a>:</h4>
<p>what version were you on before?</p>



<a name="25172"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25172" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25172">(Sep 16 2016 at 21:31)</a>:</h4>
<p>1.3.12</p>



<a name="25173"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25173" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25173">(Sep 16 2016 at 21:32)</a>:</h4>
<div class="codehilite"><pre>ServerDown: error 47 from memcached_set: (34454752) SERVER HAS FAILED AND IS DISABLED UNTIL TIMED RETRY, host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:612
2016-09-16 17:32:20,070 ERROR    Internal Server Error: /json/users/me/pointer
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/handlers/base.py&quot;, line 108, in get_response
    response = middleware_method(request)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/middleware/locale.py&quot;, line 32, in process_request
    request, check_path=check_path)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/utils/translation/__init__.py&quot;, line 189, in get_language_from_request
    return _trans.get_language_from_request(request, check_path)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/utils/translation/trans_real.py&quot;, line 496, in get_language_from_request
    lang_code = request.session.get(LANGUAGE_SESSION_KEY)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/base.py&quot;, line 59, in get
    return self._session.get(key, default)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/base.py&quot;, line 181, in _get_session
    self._session_cache = self.load()
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/cached_db.py&quot;, line 48, in load
    self.get_expiry_age(expiry=s.expire_date))
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/cache/backends/memcached.py&quot;, line 91, in set
    if not self._cache.set(key, value, self.get_backend_timeout(timeout)):
ServerDown: error 47 from memcached_set: (34454752) SERVER HAS FAILED AND IS DISABLED UNTIL TIMED RETRY, host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:612
2016-09-16 17:32:20,118 ERROR    Internal Server Error: /json/users/me/pointer
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/handlers/base.py&quot;, line 108, in get_response
    response = middleware_method(request)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/middleware/locale.py&quot;, line 32, in process_request
    request, check_path=check_path)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/utils/translation/__init__.py&quot;, line 189, in get_language_from_request
    return _trans.get_language_from_request(request, check_path)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/utils/translation/trans_real.py&quot;, line 496, in get_language_from_request
    lang_code = request.session.get(LANGUAGE_SESSION_KEY)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/base.py&quot;, line 59, in get
    return self._session.get(key, default)
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/base.py&quot;, line 181, in _get_session
    self._session_cache = self.load()
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/cached_db.py&quot;, line 48, in load
    self.get_expiry_age(expiry=s.expire_date))
  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/cache/backends/memcached.py&quot;, line 91, in set
    if not self._cache.set(key, value, self.get_backend_timeout(timeout)):
ServerDown: error 47 from memcached_set: (34454752) SERVER HAS FAILED AND IS DISABLED UNTIL TIMED RETRY, host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:612
</pre></div>



<a name="25174"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25174" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25174">(Sep 16 2016 at 21:32)</a>:</h4>
<p>I suspect this is solved by "restart zulip"</p>



<a name="25175"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25175" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25175">(Sep 16 2016 at 21:32)</a>:</h4>
<p>yes, though I think it's interesting that your memcached seems to be having availability problems</p>



<a name="25176"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25176" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25176">(Sep 16 2016 at 21:33)</a>:</h4>
<p>Again, spewing Warning session data corrupted.</p>



<a name="25177"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25177" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25177">(Sep 16 2016 at 21:34)</a>:</h4>
<p>Still getting the same memcached error.</p>



<a name="25178"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25178" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25178">(Sep 16 2016 at 21:34)</a>:</h4>
<p>I don't have a good explanation for your session data corrupted problem.  The easiest explanation would be if somehow you ended up changing your /etc/zulip/zulip-secrets.py to use a different secret key</p>



<a name="25179"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25179" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25179">(Sep 16 2016 at 21:34)</a>:</h4>
<p>Check the logs for memcached</p>



<a name="25180"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25180" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25180">(Sep 16 2016 at 21:34)</a>:</h4>
<p>Empty.  Checking config...</p>



<a name="25181"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25181" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25181">(Sep 16 2016 at 21:34)</a>:</h4>
<p>I've basically not seen this happen before, but it seems pretty clear that your memcached is messed up in some way</p>



<a name="25185"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25185" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25185">(Sep 16 2016 at 21:39)</a>:</h4>
<p>Bizarre.</p>



<a name="25187"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25187" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25187">(Sep 16 2016 at 21:39)</a>:</h4>
<p>Any luck?</p>



<a name="25188"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25188" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25188">(Sep 16 2016 at 21:39)</a>:</h4>
<p>Not yet.</p>



<a name="25189"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25189" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25189">(Sep 16 2016 at 21:40)</a>:</h4>
<p>We did change some bits of how we configure memcached recently, that may be worth adjusting</p>



<a name="25190"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25190" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25190">(Sep 16 2016 at 21:40)</a>:</h4>
<p>in <code>zproject/settings.py</code>, search for <code>django.core.cache.backends.memcached.PyLibMCCache</code></p>



<a name="25191"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25191" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25191">(Sep 16 2016 at 21:40)</a>:</h4>
<p>(in /home/zulip/deployments/current)</p>



<a name="25192"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25192" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25192">(Sep 16 2016 at 21:40)</a>:</h4>
<p>And try commenting out the <code>OPTIONS</code> section</p>



<a name="25193"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25193" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25193">(Sep 16 2016 at 21:40)</a>:</h4>
<p>Memcached is working for me.</p>



<a name="25194"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25194" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25194">(Sep 16 2016 at 21:40)</a>:</h4>
<div class="codehilite"><pre>root@prod-infosec-zulip02:/var/mail# telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
add mykey 0 60 11
hello world
STORED
get mykey
VALUE mykey 0 11
hello world
END```
</pre></div>



<a name="25195"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25195" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25195">(Sep 16 2016 at 21:40)</a>:</h4>
<p>I can imagine that those settings are somehow problematic on your system</p>



<a name="25196"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25196" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25196">(Sep 16 2016 at 21:42)</a>:</h4>
<p>Same error.</p>



<a name="25197"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25197" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25197">(Sep 16 2016 at 21:42)</a>:</h4>
<p>(I assume you restarted the server in between?)</p>



<a name="25198"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25198" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25198">(Sep 16 2016 at 21:42)</a>:</h4>
<p>Yup.</p>



<a name="25199"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25199" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25199">(Sep 16 2016 at 21:42)</a>:</h4>
<p>Oh, can you disable your proxy configuration and then restart the server?</p>



<a name="25200"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25200" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25200">(Sep 16 2016 at 21:43)</a>:</h4>
<p>Did that already.</p>



<a name="25201"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25201" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25201">(Sep 16 2016 at 21:43)</a>:</h4>
<p>Oh, do you mean hard restart the whole box?</p>



<a name="25202"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25202" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25202">(Sep 16 2016 at 21:43)</a>:</h4>
<p>Oh, actually, disable your proxy configuration, and then restart supervisord</p>



<a name="25203"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25203" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25203">(Sep 16 2016 at 21:43)</a>:</h4>
<p>The problem is I bet that supervisord is caught running inside your http_proxy environment variables</p>



<a name="25204"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25204" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25204">(Sep 16 2016 at 21:43)</a>:</h4>
<p>Because you ran puppet with those options enabled</p>



<a name="25205"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25205" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25205">(Sep 16 2016 at 21:43)</a>:</h4>
<p>And so now everything it starts is inheriting that environment</p>



<a name="25206"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25206" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25206">(Sep 16 2016 at 21:44)</a>:</h4>
<p>Bingo.</p>



<a name="25207"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25207" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25207">(Sep 16 2016 at 21:44)</a>:</h4>
<p>sweet</p>



<a name="25208"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25208" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25208">(Sep 16 2016 at 21:44)</a>:</h4>
<p>I restarted everything under supervisord, but not supervisord itself.</p>



<a name="25209"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25209" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25209">(Sep 16 2016 at 21:45)</a>:</h4>
<p>I wonder what the best way to make that not happen is</p>



<a name="25210"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25210" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25210">(Sep 16 2016 at 21:46)</a>:</h4>
<p>maybe setting <code>http_proxy</code> and friends to blank inside our supervisord config would work</p>



<a name="25211"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25211" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25211">(Sep 16 2016 at 21:47)</a>:</h4>
<p>I'm also getting a cron error.</p>



<a name="25212"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25212" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25212">(Sep 16 2016 at 21:47)</a>:</h4>
<p>/bin/bash: /home/zulip/deployments/current/bin/write-rabbitmq-consumers-state-file: No such file or directory</p>



<a name="25213"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25213" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25213">(Sep 16 2016 at 21:47)</a>:</h4>
<p>What is the cron job that does that?  It might be something you added :)</p>



<a name="25214"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25214" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25214">(Sep 16 2016 at 21:48)</a>:</h4>
<p>rabbitmq-numconsumers?</p>



<a name="25215"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25215" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25215">(Sep 16 2016 at 21:48)</a>:</h4>
<div class="codehilite"><pre>p$ cat puppet/zulip/files/cron.d/rabbitmq-numconsumers 
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
USER=root

* * * * * root /home/zulip/deployments/current/scripts/nagios/check-rabbitmq-consumers
</pre></div>



<a name="25216"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25216" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25216">(Sep 16 2016 at 21:49)</a>:</h4>
<p>... weird.  Let me try rerunning the puppet apply.</p>



<a name="25217"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25217" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25217">(Sep 16 2016 at 21:49)</a>:</h4>
<p>Nope.</p>



<a name="25218"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25218" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25218">(Sep 16 2016 at 21:49)</a>:</h4>
<p>So clearly that didn't update.  What do you have as <code>puppet_classes</code> in /etc/zulip/zulip.conf</p>



<a name="25219"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25219" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25219">(Sep 16 2016 at 21:49)</a>:</h4>
<p>puppet_classes = zulip::base, zulip::apt_repository, zulip::app_frontend, zulip::memcached, zulip::redis, zulip::localhost_camo, zulip::postfix_localmail, zulip::apache_sso</p>



<a name="25220"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25220" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25220">(Sep 16 2016 at 21:49)</a>:</h4>
<p>Yeah, add <code>zulip::rabbit</code></p>



<a name="25221"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25221" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25221">(Sep 16 2016 at 21:50)</a>:</h4>
<p>Since you exploded our list manually, I guess you got broken when we split that out from <code>zulip::app_frontend</code></p>



<a name="25222"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25222" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25222">(Sep 16 2016 at 21:50)</a>:</h4>
<p>Yeah... do you remember why we did that?</p>



<a name="25223"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25223" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25223">(Sep 16 2016 at 21:50)</a>:</h4>
<p>There was something we wanted to remove.</p>



<a name="25224"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25224" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25224">(Sep 16 2016 at 21:50)</a>:</h4>
<p>Oh.</p>



<a name="25225"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25225" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25225">(Sep 16 2016 at 21:50)</a>:</h4>
<p>Right.</p>



<a name="25226"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25226" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25226">(Sep 16 2016 at 21:50)</a>:</h4>
<p>It was the rabbit bit, actually.</p>



<a name="25227"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25227" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25227">(Sep 16 2016 at 21:51)</a>:</h4>
<p>which piece?</p>



<a name="25228"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25228" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25228">(Sep 16 2016 at 21:51)</a>:</h4>
<p>Specifically, what you put in /etc/default/rabbitmq-server.</p>



<a name="25229"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25229" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25229">(Sep 16 2016 at 21:51)</a>:</h4>
<p>OK well what I'd do</p>



<a name="25230"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25230" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25230">(Sep 16 2016 at 21:51)</a>:</h4>
<p>is run zulip-puppet-apply in dry-run mode, to see what you're missing</p>



<a name="25231"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25231" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25231">(Sep 16 2016 at 21:51)</a>:</h4>
<p>I did the run and then did it by hand.</p>



<a name="25232"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25232" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25232">(Sep 16 2016 at 21:52)</a>:</h4>
<p>Yep that's what I was going to suggest :)</p>



<a name="25233"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25233" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25233">(Sep 16 2016 at 21:52)</a>:</h4>
<p>Great minds, &amp;c.</p>



<a name="25234"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25234" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25234">(Sep 16 2016 at 21:52)</a>:</h4>
<p>We're back up.</p>



<a name="25235"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25235" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25235">(Sep 16 2016 at 21:52)</a>:</h4>
<p>yay!</p>



<a name="25236"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25236" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25236">(Sep 16 2016 at 21:53)</a>:</h4>
<p>And to give you a bit of context for how important Zulip is, after the downtime, this exchange happened:</p>



<a name="25237"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25237" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25237">(Sep 16 2016 at 21:54)</a>:</h4>
<blockquote>
<p>Harlan Lieberman-Berg: Hello <span class="user-mention" data-user-email="*">@all</span>. We are planning on doing a Zulip upgrade today at 5PM Eastern, 9PM UTC. You may experience a short (&lt;5min) inaccessibility around that time.<br>
Person #1: Thank you, 5.<br>
Harlan Lieberman-Berg: Starting the upgrade now.<br>
Harlan Lieberman-Berg: That was a longer outage than we predicted; sorry everyone.<br>
Harlan Lieberman-Berg: We should be back up now.<br>
Person #2: /me grips the edge of her desk in frantic nervousness... and slowly relaxes<br>
Person #2: Thanks!</p>
</blockquote>



<a name="25238"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25238" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25238">(Sep 16 2016 at 21:54)</a>:</h4>
<p><img alt=":zulip:" class="emoji" src="/static/third/gemoji/images/emoji/zulip.png" title=":zulip:"> <br>
<img alt=":octopus:" class="emoji" src="/static/third/gemoji/images/emoji/octopus.png" title=":octopus:"> </p>



<a name="25239"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25239" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25239">(Sep 16 2016 at 21:56)</a>:</h4>
<p>So, now that you're on 1.4.x, it should be safe to do <code>apt</code> upgrades in general without risk of causing Zulip problems (well, unless you upgrade postgres, in which case you will need to restart the Zulip server after the upgrade for some services to reconnect)</p>



<a name="25240"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25240" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25240">(Sep 16 2016 at 21:56)</a>:</h4>
<p>Since we're no longer using any of the system Python packages</p>



<a name="25241"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25241" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25241">(Sep 16 2016 at 21:57)</a>:</h4>
<p>Opened <a href="https://github.com/zulip/zulip/issues/1807" target="_blank" title="https://github.com/zulip/zulip/issues/1807">https://github.com/zulip/zulip/issues/1807</a> for the http_proxy issue</p>



<a name="25242"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25242" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25242">(Sep 16 2016 at 21:57)</a>:</h4>
<p><a href="/user_uploads/2/7f/DvVI3eGUabbZwyNLsiG5rt_D/IMG_20151123_161808223.jpg" target="_blank" title="IMG_20151123_161808223.jpg">IMG_20151123_161808223.jpg</a> </p>
<div class="message_inline_image"><a href="/user_uploads/2/7f/DvVI3eGUabbZwyNLsiG5rt_D/IMG_20151123_161808223.jpg" target="_blank" title="IMG_20151123_161808223.jpg"><img src="/user_uploads/2/7f/DvVI3eGUabbZwyNLsiG5rt_D/IMG_20151123_161808223.jpg"></a></div>



<a name="25243"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25243" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25243">(Sep 16 2016 at 21:58)</a>:</h4>
<p><img alt=":heart:" class="emoji" src="/static/third/gemoji/images/emoji/heart.png" title=":heart:"> </p>



<a name="25244"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25244" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25244">(Sep 16 2016 at 21:58)</a>:</h4>
<p>Can you note <a href="https://github.com/zulip/zulip/pull/1807" target="_blank" title="https://github.com/zulip/zulip/pull/1807">#1807</a> in your upgrade checklist as a reminder for next time?  </p>



<a name="25245"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25245" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25245">(Sep 16 2016 at 21:58)</a>:</h4>
<p>Definitely.</p>



<a name="25246"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25246" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25246">(Sep 16 2016 at 22:00)</a>:</h4>
<p>Thanks for your help, Tim.</p>



<a name="25247"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25247" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25247">(Sep 16 2016 at 22:00)</a>:</h4>
<p>I think it's time for me to head home. :)</p>



<a name="25248"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25248" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25248">(Sep 16 2016 at 22:01)</a>:</h4>
<p>Have a great weekend! :)</p>



<a name="25249"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/25249" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#25249">(Sep 16 2016 at 22:01)</a>:</h4>
<p>You as well!</p>



<a name="142616"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/142616" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#142616">(Feb 01 2017 at 08:57)</a>:</h4>
<p>Just a quick one guys, I tried upgrading with the tar.gz file from github and I got a bunch of errors similar to <a href="https://github.com/zulip/zulip/issues/208" target="_blank" title="https://github.com/zulip/zulip/issues/208">issue 208</a>. However, once I got the upgrade file from <a href="https://www.zulip.org/dist/releases/" target="_blank" title="https://www.zulip.org/dist/releases/">dist/releases</a> all seems well...</p>



<a name="142891"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/142891" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#142891">(Feb 01 2017 at 17:33)</a>:</h4>
<p><span class="user-mention" data-user-id="133">@Bruce Lewin</span> oh, the GitHub auto-generated tarballs are not correct.  I guess it's time to look into whether we can make GitHub not post them</p>



<a name="142892"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/142892" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#142892">(Feb 01 2017 at 17:33)</a>:</h4>
<p>(There are static assets that need to be built as part of generating a release tarball)</p>



<a name="142950"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/142950" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#142950">(Feb 01 2017 at 17:48)</a>:</h4>
<p>OK I've added our actual release tarballs to GitHub to block it's broken autogenerated release tarballs from impacting anyone else.  Thanks for the report <span class="user-mention" data-user-id="133">@Bruce Lewin</span>!</p>



<a name="143336"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/143336" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#143336">(Feb 02 2017 at 02:55)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Thanks Tim... I was wondering why I was having trouble but it's not a surprise that github mangled the .tar.gz files!</p>



<a name="144069"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/144069" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#144069">(Feb 03 2017 at 07:31)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> Thanks Tim, I just ran the upgrade from <a href="https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz" target="_blank" title="https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz">https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz</a> without any hitches, well, apart from the usual </p>
<blockquote>
<p>sudo service supervisor stop<br>
sudo dpkg -P rabbitmq-server<br>
sudo apt-get install rabbitmq-server<br>
sudo /root/zulip/scripts/setup/configure-rabbitmq<br>
service supervisor start</p>
</blockquote>
<p>Is there any where in the browser to tell what version you're running btw, or do I have to check it on the command line/in the docs etc?</p>



<a name="144080"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/144080" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#144080">(Feb 03 2017 at 10:26)</a>:</h4>
<p>Hmmm, I've upgraded to 1.4.3 via github <a href="https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz" target="_blank" title="https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz">https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz</a><br>
But I don't see the emoji and preview icons in the compose box...<br>
Everything else seems fine though...<br>
Does anyone have any thoughts?</p>



<a name="144158"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/144158" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#144158">(Feb 03 2017 at 15:55)</a>:</h4>
<p>Emojis and preview icons will be part of the imminent 1.5 release.</p>



<a name="144332"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/144332" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#144332">(Feb 03 2017 at 17:52)</a>:</h4>
<p><span class="user-mention" data-user-email="showell30@yahoo.com" data-user-id="58">@Steve Howell</span> do you think we should toss in a <code>/version</code> endpoint that just returns the value in version.py?</p>



<a name="144360"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/144360" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sampriti Panda <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#144360">(Feb 03 2017 at 18:00)</a>:</h4>
<p>Probably an API endpoint would be better.</p>



<a name="144372"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/144372" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#144372">(Feb 03 2017 at 18:14)</a>:</h4>
<p>Yeah, I think a version endpoint is a good idea.  I thought at one point we talked about putting the version in page_params as well or in in some kind of "about" link.  We could probably put the version in tiny print in the help pages.</p>



<a name="144375"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/144375" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#144375">(Feb 03 2017 at 18:19)</a>:</h4>
<p>Note that version values will include release versions and also versions like <code>1.5.0+git</code> for if they're forked off of a release</p>



<a name="144381"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/144381" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#144381">(Feb 03 2017 at 18:24)</a>:</h4>
<p>Yeah, we'd want to be a bit careful about anything user-facing.</p>



<a name="144965"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/144965" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#144965">(Feb 05 2017 at 06:30)</a>:</h4>
<p>ok, so you guys think I'm on the right release for 1.4.3 and not seeing preview and emoji icons in the compose box is expected behaviour?</p>



<a name="145099"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/145099" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#145099">(Feb 05 2017 at 17:56)</a>:</h4>
<p>Yeah those features are new in 1.5</p>



<a name="146047"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146047" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146047">(Feb 07 2017 at 07:41)</a>:</h4>
<p>Ok, so I tried to upgrade to 1.5 and ran into an error as below...<br>
I've attached the <a href="/user_uploads/2/d2/1kUs7ZJgGZ3ZcyLZ9TJeF3wx/upgrade.log" target="_blank" title="upgrade.log">upgrade.log</a> <br>
Lines 1264 - 1273 seem to be the relevant ones I've pasted below...</p>
<div class="codehilite"><pre><span></span>2017-02-07 08:15:57,451 upgrade-zulip-stage-2: Installing static assets...
Cached version not found! Copying node modules.
+ rm -rf /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315
+ mkdir -p /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315
+ cp package.json /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315
+ cp -rT prod-static/serve/node_modules /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315/node_modules
cp: cannot stat &#39;prod-static/serve/node_modules&#39;: No such file or directory

[0;37;41mError running a subcommand of /home/zulip/deployments/2017-02-07-08-12-45/scripts/lib/upgrade-zulip-stage-2: cp -rT prod-static/serve/node_modules /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315/node_modules[0m
[0;37;41mActual error output for the subcommand is just above this.[0m
</pre></div>



<a name="146056"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146056" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146056">(Feb 07 2017 at 09:20)</a>:</h4>
<p>I have a similar problem. Tried upgrading both from <code>zulip</code> and <code>root</code> users, still no luck. Here's my output:</p>
<div class="codehilite"><pre><span></span>2017-02-07 12:15:38,188 upgrade-zulip-stage-2: Building static assets...
Cached version not found! Installing node modules.
+ rm -rf /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315

Error running a subcommand of ./tools/update-prod-static: rm -rf /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315
Actual error output for the subcommand is just above this.

Traceback (most recent call last):
  File &quot;./tools/update-prod-static&quot;, line 34, in &lt;module&gt;
    setup_node_modules(npm_args=[&#39;--production&#39;], stdout=fp, stderr=fp)
  File &quot;./tools/../scripts/lib/node_cache.py&quot;, line 38, in setup_node_modules
    copy_modules=copy_modules)
  File &quot;./tools/../scripts/lib/node_cache.py&quot;, line 66, in do_npm_install
    run(cmd, stdout=stdout, stderr=stderr)
  File &quot;./tools/../scripts/lib/zulip_tools.py&quot;, line 98, in run
    subprocess.check_call(args, **kwargs)
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;rm&#39;, &#39;-rf&#39;, &#39;/srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2017-02-07-12-15-26/scripts/lib/upgrade-zulip-stage-2&quot;, line 75, in &lt;module&gt;
    preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./tools/update-prod-static&#39;, &#39;--authors-not-required&#39;, &#39;--prev-deploy&#39;, &#39;/home/zulip/deployments/current&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;./scripts/upgrade-zulip-from-git&quot;, line 81, in &lt;module&gt;
    deploy_path, &quot;--from-git&quot;] + deploy_options)
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;sudo&#39;, &#39;/home/zulip/deployments/2017-02-07-12-15-26/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2017-02-07-12-15-26&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1
</pre></div>



<a name="146059"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146059" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146059">(Feb 07 2017 at 09:48)</a>:</h4>
<p>Could it be related to the fact I'm trying to upgrade a packaged-based installation via a <code>upgrade-zulip-from-git</code>? So I have a <code>tar.gz</code> package installed and now I would like to switch to git-based upgrades. Maybe a new version can't fetch the previous deployment's static files and is failing as a result? Anyway, the error message is completely cryptic.</p>



<a name="146060"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146060" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146060">(Feb 07 2017 at 09:49)</a>:</h4>
<p>hmmm... for what it's worth, I'm on package based and I think our errors are pretty similar...</p>



<a name="146061"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146061" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146061">(Feb 07 2017 at 09:50)</a>:</h4>
<p>Looking at the <code>update-prod-static.log</code>, I see a user really doesn't have the permissions (how come?), so I'll try granting <code>zulip</code> all the access that exists on the Earth.</p>



<a name="146062"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146062" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146062">(Feb 07 2017 at 09:51)</a>:</h4>
<p>ok, let me know if that helps... I sudo'ed from 1.4.1 to 1.4.2 and 1.4.3 without any problems...</p>



<a name="146063"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146063" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146063">(Feb 07 2017 at 09:51)</a>:</h4>
<p>sure, will do</p>



<a name="146064"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146064" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146064">(Feb 07 2017 at 09:52)</a>:</h4>
<p>did you run the upgrade from <code>root</code> btw?</p>



<a name="146065"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146065" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146065">(Feb 07 2017 at 09:52)</a>:</h4>
<p>no, the zulip user using sudo</p>



<a name="146066"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146066" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146066">(Feb 07 2017 at 09:52)</a>:</h4>
<p>okay, thanks</p>



<a name="146067"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146067" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146067">(Feb 07 2017 at 09:59)</a>:</h4>
<p>looks like the <code>zulip</code> user hasn't had permissions on the base <code>/srv</code> directory. Chowned the dir to him, the process advanced a bit further. Building modules now...</p>



<a name="146068"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146068" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146068">(Feb 07 2017 at 10:03)</a>:</h4>
<p>alright, it went all the way down to restarting Postgres and died, bringing down the Zulip itself. Still not giving up hope ... )</p>



<a name="146069"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146069" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146069">(Feb 07 2017 at 10:07)</a>:</h4>
<p>running the upgrade script one more time did the trick, we're now running 1.5!</p>



<a name="146070"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146070" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146070">(Feb 07 2017 at 10:10)</a>:</h4>
<p>nice....<br>
is this the chown command you ran?</p>
<div class="codehilite"><pre><span></span>sudo chown zulip:zulip /srv/
</pre></div>


<p>looking at the error message I got, do you think chowning /srv/ would work on my installation?</p>
<div class="codehilite"><pre><span></span>+ cp -rT prod-static/serve/node_modules /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315/node_modules
cp: cannot stat &#39;prod-static/serve/node_modules&#39;: No such file or directory
</pre></div>



<a name="146071"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146071" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146071">(Feb 07 2017 at 10:11)</a>:</h4>
<p>yes, with the exception I didn't change the group, just <code>chown zulip /srv</code></p>



<a name="146072"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146072" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146072">(Feb 07 2017 at 10:12)</a>:</h4>
<p>ok, let me try that...</p>



<a name="146073"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146073" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146073">(Feb 07 2017 at 10:13)</a>:</h4>
<p>Can't say for sure, but I remember getting strange <code>stat</code> errors on a nested file because on of the parent folders didn't have <code>x</code> permissions for the user.</p>



<a name="146074"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146074" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146074">(Feb 07 2017 at 10:13)</a>:</h4>
<p>Though it might be a completely different case</p>



<a name="146076"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146076" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146076">(Feb 07 2017 at 10:23)</a>:</h4>
<p>bugger, same error!</p>



<a name="146077"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146077" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Morozov <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146077">(Feb 07 2017 at 10:24)</a>:</h4>
<p>does your <code>/home/zulip/deployments/&lt;your&gt;/var/log</code> folder contain any cues?</p>



<a name="146081"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146081" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146081">(Feb 07 2017 at 10:41)</a>:</h4>
<p>I'm not sure, I've destroyed the instance :-( I'm going to restore from backup and will probably wait to see if anyone else has any suggestions...</p>



<a name="146153"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146153" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146153">(Feb 07 2017 at 17:35)</a>:</h4>
<p>looking at this now</p>



<a name="146154"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146154" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146154">(Feb 07 2017 at 17:35)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> </p>



<a name="146156"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146156" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146156">(Feb 07 2017 at 17:39)</a>:</h4>
<p>I think I know what's up; will post a release candidate tarball shortly.</p>



<a name="146157"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146157" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146157">(Feb 07 2017 at 17:40)</a>:</h4>
<p>Great, I'll probably give that a go tomorrow morning....</p>



<a name="146158"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146158" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146158">(Feb 07 2017 at 17:41)</a>:</h4>
<p>We stopped shipping <code>node_modules</code> in the tarballs because they made them 2x as big and weren't actually used (since the static assets had already been built from <code>node_modules</code>).  But we failed to remove the upgrade path to copy the no-longer-existent node_modules directory into place.</p>



<a name="146160"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146160" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146160">(Feb 07 2017 at 17:42)</a>:</h4>
<p>ahhhh, ok...</p>



<a name="146163"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146163" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146163">(Feb 07 2017 at 17:44)</a>:</h4>
<p>BTW there should be no downtime attached to a failed upgrade here; it'll just not have changed anything</p>



<a name="146164"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146164" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146164">(Feb 07 2017 at 17:44)</a>:</h4>
<p>I have a release candidate ready for testing</p>



<a name="146165"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146165" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146165">(Feb 07 2017 at 17:44)</a>:</h4>
<p>ok... I wasn't sure... either way I had a volume snapshot to go back to...</p>



<a name="146166"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146166" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146166">(Feb 07 2017 at 17:45)</a>:</h4>
<p>great, I'll test it out tomorrow....</p>



<a name="146167"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146167" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146167">(Feb 07 2017 at 17:45)</a>:</h4>
<p>I'm going to make a fresh instance so I can test and post it now </p>



<a name="146207"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146207" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146207">(Feb 07 2017 at 18:35)</a>:</h4>
<p>OK test complete, I'll be posting Zulip 1.5.1 with this fixed soon.  Thanks for the reports <span class="user-mention" data-user-email="bruce.lewin@brandreflections.com" data-user-id="133">@Bruce Lewin</span> and <span class="user-mention" data-user-email="am@kupo.la" data-user-id="299">@Alex Morozov</span>!</p>



<a name="146208"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146208" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146208">(Feb 07 2017 at 18:36)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> No worries!</p>



<a name="146258"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146258" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146258">(Feb 07 2017 at 19:40)</a>:</h4>
<p>OK, 1.5.1 is released fixing that issue.  Thanks again for the report!</p>



<a name="146260"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146260" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thomas Butter <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146260">(Feb 07 2017 at 19:42)</a>:</h4>
<p>I had the same issue with 1.5.0. Works fine with 1.5.1.</p>



<a name="146261"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146261" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146261">(Feb 07 2017 at 19:46)</a>:</h4>
<p>Thanks for confirming the problem is fixed for you :)</p>



<a name="146640"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146640" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146640">(Feb 08 2017 at 01:51)</a>:</h4>
<p>I'm updating to 1.5.1 from 1.4.3 but the following error is occurred:</p>
<div class="codehilite"><pre><span></span>/var/log/zulip/django.log 
----
Unknown command: &#39;runfcgi&#39;
Type &#39;manage.py help&#39; for usage.
</pre></div>



<a name="146641"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146641" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146641">(Feb 08 2017 at 01:51)</a>:</h4>
<p>Restart supervisord?  That sounds like it's trying to use the 1.4.3 supervisord config</p>



<a name="146642"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146642" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146642">(Feb 08 2017 at 01:53)</a>:</h4>
<p>How to restart supervisord? <code>sudo -H supervisorctl reload</code> is OK?</p>



<a name="146643"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146643" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146643">(Feb 08 2017 at 01:54)</a>:</h4>
<p>supervisord configuration may not be upgraded successfully?</p>
<div class="codehilite"><pre><span></span>% head -20 /etc/supervisor/conf.d/zulip.conf
; Supervisor config file.
; on Debian squeeze, place me in /etc/supervisor/conf.d/zulip.conf
;
; For more information on the config file, please see:
; http://supervisord.org/configuration.html
;
; Note: shell expansion (&quot;~&quot; or &quot;$HOME&quot;) is not supported.  Environment
; variables can be expanded using this syntax: &quot;%(ENV_HOME)s&quot;.

[fcgi-program:zulip-django]
command=python /home/zulip/deployments/current/manage.py runfcgi daemonize=False maxchildren=20 ; the program (relative uses PATH, can take args)
;process_name=%(program_name)s ; process_name expr (default %(program_name)s)
;numprocs=1                    ; number of processes copies to start (def 1)
;directory=/tmp                ; directory to cwd to before exec (def no cwd)
;umask=022                     ; umask for process (default None)
priority=100                   ; the relative start priority (default 999)
autostart=true                 ; start at supervisord start (default: true)
autorestart=true               ; whether/when to restart (default: unexpected)
;startsecs=1                   ; number of secs prog must stay running (def. 1)
;startretries=3                ; max # of serial start failures (default 3)
</pre></div>



<a name="146647"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146647" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146647">(Feb 08 2017 at 01:57)</a>:</h4>
<p>did the upgrade actually finish?  </p>



<a name="146648"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146648" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146648">(Feb 08 2017 at 01:57)</a>:</h4>
<p>Oh, you mentioned that /root/zulip didn't exist or something</p>



<a name="146649"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146649" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146649">(Feb 08 2017 at 01:57)</a>:</h4>
<p>Run <code>/root/zulip/scripts/zulip-puppet-apply</code> after making sure <code>/root/zulip</code> is a symlink to /home/zulip/deployments/next</p>



<a name="146650"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146650" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146650">(Feb 08 2017 at 01:57)</a>:</h4>
<p>The upgrade script finished successfully.</p>



<a name="146651"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146651" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146651">(Feb 08 2017 at 01:59)</a>:</h4>
<p>I'll try it.</p>



<a name="146652"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146652" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146652">(Feb 08 2017 at 01:59)</a>:</h4>
<p>I think if /root/zulip was not configured correctly, upgrading wouldn't have installed the configuration for the new release</p>



<a name="146653"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146653" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kou <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146653">(Feb 08 2017 at 02:01)</a>:</h4>
<p><code>/etc/supervisor/conf.d/zulip.conf</code> is upgraded to use WSGI. And our Zulip runs again. Thanks!</p>



<a name="146655"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146655" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146655">(Feb 08 2017 at 02:02)</a>:</h4>
<p>yay!</p>



<a name="146800"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146800" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146800">(Feb 08 2017 at 09:12)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> Morning Tim, 1.5.1 did the trick, thank you!</p>



<a name="146869"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/146869" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#146869">(Feb 08 2017 at 17:01)</a>:</h4>
<p>Great, thanks for reporting back! :)</p>



<a name="147905"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/147905" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#147905">(Feb 09 2017 at 21:36)</a>:</h4>
<p>Is the 1.4.1 =&gt; 1.4.3 upgrade code-only, or are there database changes?</p>



<a name="147906"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/147906" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#147906">(Feb 09 2017 at 21:36)</a>:</h4>
<p>I'm always shit-scared of doing upgrades in our env.</p>



<a name="147915"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/147915" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#147915">(Feb 09 2017 at 21:47)</a>:</h4>
<p>I am 80% sure it's code only.</p>



<a name="147920"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/147920" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#147920">(Feb 09 2017 at 21:52)</a>:</h4>
<p>1.4.1 -&gt; 1.4.3 is very safe:</p>
<div class="codehilite"><pre><span></span>$ git diff 1.4.1..1.4.3 --stat
 docs/changelog.md                     | 16 ++++++++++++++++
 puppet/zulip/files/logrotate/zulip    |  2 +-
 requirements/common.txt               |  2 +-
 tools/travis/success-http-headers.txt |  1 -
 zerver/tests/test_subs.py             | 23 +++++++++++++++++++++++
 zerver/views/streams.py               |  2 +-
 6 files changed, 42 insertions(+), 4 deletions(-)
</pre></div>



<a name="147922"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/147922" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#147922">(Feb 09 2017 at 21:53)</a>:</h4>
<p>OK.  I'll give it a shot tonight or tomorrow.</p>



<a name="147924"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/147924" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#147924">(Feb 09 2017 at 21:53)</a>:</h4>
<p>In general we've been very conservative about what we put in security update releases to make it easy to upgrade</p>



<a name="147926"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/147926" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Harlan Lieberman-Berg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#147926">(Feb 09 2017 at 21:53)</a>:</h4>
<p>We've managed to screw the pooch on minimal changes before.  Never doubt my competence at that. ;)</p>



<a name="148520"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/148520" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Dehnert <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#148520">(Feb 10 2017 at 05:33)</a>:</h4>
<p>o hai</p>



<a name="221004"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221004" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221004">(Jun 08 2017 at 04:31)</a>:</h4>
<p>Just successfully upgraded from 1.5 to 1.6 :-)<br>
Apart from the classic <code>sudo dpkg -P rabbitmq-server</code>, everything ran smoothly! Thanks guys :-)</p>



<a name="221007"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221007" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221007">(Jun 08 2017 at 04:33)</a>:</h4>
<p><span class="user-mention" data-user-email="bruce.lewin@brandreflections.com" data-user-id="133">@Bruce Lewin</span> it's interesting that you still are having rabbitmq-server issues.  Do you have a:</p>
<div class="codehilite"><pre><span></span>[rabbitmq]
nodename = zulip@localhost
</pre></div>


<p>entry in your <code>/etc/zulip/zulip.conf</code>?  That change (which requires a force-reinstall of rabbitmq to switch to) was something that we did and seems to have eliminated rabbitmq trouble for new installations.</p>



<a name="221023"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221023" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221023">(Jun 08 2017 at 04:51)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> Hi Tim, no, I only have these 3 lines...</p>
<div class="codehilite"><pre><span></span>[machine]
puppet_classes = zulip::voyager
deploy_type = voyager
</pre></div>


<p>Is it worth adding them in?</p>



<a name="221025"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221025" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221025">(Jun 08 2017 at 04:53)</a>:</h4>
<p>So if you add them in, and do a <code>/home/zulip/deployments/current/scripts/zulip-puppet-apply</code> (and probably reinstall rabbitmq-server), rabbitmq should be more stable afterwards (its main problem is it really doesn't like hostnames changing).</p>



<a name="221032"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221032" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221032">(Jun 08 2017 at 05:02)</a>:</h4>
<p>Ok, I updated zulip.conf and ran <code>zulip-puppet-apply</code> and everything seems fine... no need to re-install rabbitmq-server yet... do you recommend I do that in any case?</p>



<a name="221037"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221037" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221037">(Jun 08 2017 at 05:13)</a>:</h4>
<p>I bet it'll crash if you restart it</p>



<a name="221038"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221038" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221038">(Jun 08 2017 at 05:13)</a>:</h4>
<p>So, I guess if/when that happen, do that</p>



<a name="221039"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221039" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221039">(Jun 08 2017 at 05:14)</a>:</h4>
<p>Basically, the puppet command should have installed a config file telling rabbitmq to use a particular nodename, but it has no effect until rabbitmq is restarted</p>



<a name="221040"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221040" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221040">(Jun 08 2017 at 05:17)</a>:</h4>
<p>Ok, I ran a <code>/home/zulip/deployments/current/scripts/restart-server</code> and all was well....<br>
And then I did</p>
<div class="codehilite"><pre><span></span>sudo service supervisor stop
service supervisor start
</pre></div>


<p>Which also worked fine, as did another server restart....</p>



<a name="221041"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221041" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221041">(Jun 08 2017 at 05:18)</a>:</h4>
<p>did you <code>service restart rabbitmq-server</code> as part of this process?</p>



<a name="221042"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221042" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221042">(Jun 08 2017 at 05:18)</a>:</h4>
<p>If so, you should be good</p>



<a name="221044"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221044" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221044">(Jun 08 2017 at 05:19)</a>:</h4>
<p>Running <code>service restart rabbitmq-server</code> returns <code>restart: unrecognized service</code>?</p>



<a name="221047"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221047" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221047">(Jun 08 2017 at 05:21)</a>:</h4>
<p>Hrm, is there an <code>/etc/init.d/rabbitmq-server</code>?</p>



<a name="221049"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221049" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221049">(Jun 08 2017 at 05:22)</a>:</h4>
<p>Yeah, that file is there...</p>



<a name="221050"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221050" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221050">(Jun 08 2017 at 05:22)</a>:</h4>
<p>well, you can just run it instead of using the fancy <code>service</code> command; it's just a thin wrapper.  <code>/etc/init.d/rabbitmq-server restart</code> e.g.</p>



<a name="221051"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221051" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221051">(Jun 08 2017 at 05:23)</a>:</h4>
<p>ok, <code>/etc/init.d/rabbitmq-server restart</code> worked fine...</p>



<a name="221052"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221052" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221052">(Jun 08 2017 at 05:24)</a>:</h4>
<p>ok you should be all set then</p>



<a name="221054"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/221054" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bruce Lewin <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#221054">(Jun 08 2017 at 05:24)</a>:</h4>
<p>Great, thanks!</p>



<a name="450741"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/450741" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#450741">(Jan 16 2018 at 21:54)</a>:</h4>
<p>Did you just upgrade the server to <a href="https://github.com/zulip/zulip/commit/8530ed0b5e8ee8f62bceb5202ecf3e69c7bcf210" target="_blank" title="https://github.com/zulip/zulip/commit/8530ed0b5e8ee8f62bceb5202ecf3e69c7bcf210">the latest master commit</a> <span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> ? I was looking to upgrade our server to something recent but wondering what recent commit would be a good one.</p>



<a name="450754"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/450754" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#450754">(Jan 16 2018 at 21:58)</a>:</h4>
<p>I just did master.  I would probably wait a day for people to test with this version before doing an upgrade to a more production system, since this upgrade included a lot of changes.</p>



<a name="450828"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/450828" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#450828">(Jan 16 2018 at 22:22)</a>:</h4>
<p>Cool, thanks!</p>



<a name="452470"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452470" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452470">(Jan 17 2018 at 18:14)</a>:</h4>
<p>Is the zulip user password documented? It asked me for it when I was testing <code>upgrade-from-git</code> on a duplicate instance of our server</p>



<a name="452475"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452475" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452475">(Jan 17 2018 at 18:15)</a>:</h4>
<p>I ran it from another sudo user instead, but I've never encountered that before and usually I just run the scripts sudo su'd as zulip</p>



<a name="452479"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452479" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452479">(Jan 17 2018 at 18:15)</a>:</h4>
<p>(I could have also just changed the zulip user's pw, but...)</p>



<a name="452519"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452519" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452519">(Jan 17 2018 at 18:27)</a>:</h4>
<p><span class="user-mention" data-user-email="shidarin@gmail.com" data-user-id="3733">@Sean Wallitsch</span> we don't set a password for it.</p>



<a name="452520"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452520" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452520">(Jan 17 2018 at 18:27)</a>:</h4>
<p>So, you can set one, but we generally just add SSH keys for the user (you can also su from root if you prefer that model, or give it a password)</p>



<a name="452521"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452521" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452521">(Jan 17 2018 at 18:28)</a>:</h4>
<p>The <code>upgrade-from-git</code> script is intended to be run as root.</p>



<a name="452522"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452522" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452522">(Jan 17 2018 at 18:28)</a>:</h4>
<p>Our current permissions design is that we don't require the <code>zulip</code> use to be a sudoer.</p>



<a name="452529"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452529" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452529">(Jan 17 2018 at 18:29)</a>:</h4>
<p>Cool, thanks guys</p>



<a name="452530"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452530" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452530">(Jan 17 2018 at 18:30)</a>:</h4>
<p>What version are you currently on (pre-upgrade)?</p>



<a name="452532"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452532" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452532">(Jan 17 2018 at 18:30)</a>:</h4>
<p>I was on 1.7. Once I ran the upgrade script as root, everything went smooth</p>



<a name="452534"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452534" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452534">(Jan 17 2018 at 18:31)</a>:</h4>
<p>Huh, interesting. 1.7 should already have the check in <code>upgrade-zulip-from-git</code> that should have given you a good error message up front if you ran it as non-root.</p>



<a name="452541"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452541" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452541">(Jan 17 2018 at 18:33)</a>:</h4>
<p>If that was added in one of the last commits before the 1.7 release, we might have missed it. We were still on one of the 1.7 RCs. But if not, I didn't see one- just a request for the sudo pw</p>



<a name="452543"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452543" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452543">(Jan 17 2018 at 18:34)</a>:</h4>
<p>Ah, that's probably it -- looks like it was added just a few days before the release.</p>



<a name="452545"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452545" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452545">(Jan 17 2018 at 18:35)</a>:</h4>
<p>Sorry for the trouble then :) We moved off Zulip for a few months and are getting back into the swing of it.</p>



<a name="452546"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452546" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452546">(Jan 17 2018 at 18:35)</a>:</h4>
<p>Cool, mystery solved, and I won't worry about future installs running into the same thing. :)</p>



<a name="452547"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/452547" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Price <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#452547">(Jan 17 2018 at 18:35)</a>:</h4>
<p>No problem! Thanks for the report.</p>



<a name="890629"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/890629" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim April <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#890629">(May 29 2020 at 19:11)</a>:</h4>
<p>going from 2.0.6 to 2.1.4 i noticed a bug? or just unexpected behavior when operating on a machine that was in psql recovery mode (part of a primary/secondary psql setup)</p>
<div class="codehilite"><pre><span></span><code>2020-05-29 19:09:31,588 upgrade-zulip: Archiving the tarball under /home/zulip/archives
2020-05-29 19:09:31,868 upgrade-zulip: Unpacking the tarball
ERROR:  cannot execute DROP EXTENSION in a read-only transaction
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2020-05-29-19-09-31/scripts/lib/upgrade-zulip-stage-2&quot;, line 68, in &lt;module&gt;
    &#39;psql -v ON_ERROR_STOP=1 zulip -c &quot;DROP EXTENSION IF EXISTS tsearch_extras;&quot;&#39;])
  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 311, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;su&#39;, &#39;postgres&#39;, &#39;-c&#39;, &#39;psql -v ON_ERROR_STOP=1 zulip -c &quot;DROP EXTENSION IF EXISTS tsearch_extras;&quot;&#39;]&#39; returned non-zero exit status 1.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 58, in &lt;module&gt;
    + deploy_options)
  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 311, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2020-05-29-19-09-31/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2020-05-29-19-09-31&#39;, &#39;--skip-migrations&#39;]&#39; returned non-zero exit status 1.
</code></pre></div>



<a name="890630"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/890630" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim April <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#890630">(May 29 2020 at 19:11)</a>:</h4>
<p>it looks like its trying to check for the full text search extension, but the psql server is in recovery so it is unable to run that command</p>



<a name="890631"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/890631" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim April <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#890631">(May 29 2020 at 19:12)</a>:</h4>
<p>my work around will be to upgrade the primary fully and then to promote the secondary, do the upgrade and then recover it, but i figured i'd mention it here</p>



<a name="890746"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/890746" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#890746">(May 29 2020 at 21:08)</a>:</h4>
<p><span class="user-mention" data-user-id="73">@Tim April</span> I think it would have also worked to just skip that step of the upgrade tool on the secondary.</p>



<a name="890747"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/890747" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#890747">(May 29 2020 at 21:09)</a>:</h4>
<p>Thanks for the report; I'm not sure there's a code change we'll make in relation to this but it's good to know about.</p>



<a name="912935"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/912935" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giora Guttsait <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#912935">(Jun 24 2020 at 18:12)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Hi man, I have a zulip server running on-prem, pretty old one (v1.8 IIRC).<br>
It's running with <code>docker-compose</code>.</p>
<p>I would very much like to migrate to a newer version, but am unsure of what's the correct procedures for migrations when running with <code>docker-compose</code>.</p>
<p>I'm not a python developer and don't have much experience with Django, so I'm unsure of how it will handle the migrations.</p>
<p>What's the best migration plan? Do I have to migrate one version at a time, or just move on to the latest version?</p>
<p>And, considering I'm on <code>docker-compose</code>, is there a migration guide for that?</p>



<a name="912970"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/912970" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#912970">(Jun 24 2020 at 18:24)</a>:</h4>
<p><span class="user-mention" data-user-id="8449">@Giora Guttsait</span> see <a href="https://github.com/zulip/docker-zulip#upgrading-the-zulip-container">https://github.com/zulip/docker-zulip#upgrading-the-zulip-container</a></p>



<a name="912983"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/912983" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giora Guttsait <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#912983">(Jun 24 2020 at 18:30)</a>:</h4>
<p>So it runs <code>migrate</code> on its own? Wow, that's some kick ass UX man, couldn't be easier than that. I'll definitely try a migration <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span>🏻 Thanks a bunch for the quick reply!</p>



<a name="912989"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/912989" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giora Guttsait <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#912989">(Jun 24 2020 at 18:32)</a>:</h4>
<p>Do you suppose only the updated <code>zulip</code> image is needed, or should I bring along all the other images as well? Like the postgresql and stuff...</p>



<a name="913013"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/913013" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giora Guttsait <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#913013">(Jun 24 2020 at 18:41)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> looking at <a href="https://github.com/zulip/docker-zulip#upgrading-from-the-old-galexrtdocker-zulip">this</a> it looks like I would at least have to do a database migration, right?</p>



<a name="913016"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/913016" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#913016">(Jun 24 2020 at 18:42)</a>:</h4>
<p><span class="user-mention" data-user-id="8449">@Giora Guttsait</span> it depends what version you're upgrading from.</p>



<a name="913017"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/913017" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#913017">(Jun 24 2020 at 18:43)</a>:</h4>
<p>But if it's 1.8, yeah, I'd expect you to need to follow those extra instructions.</p>



<a name="953724"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953724" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953724">(Jul 24 2020 at 20:42)</a>:</h4>
<p>hi. trying to upgrade <br>
/home/zulip/deployments/current/scripts/upgrade-zulip-from-git 2.1.x<br>
to go from debian Stretch to Debian Buster<br>
but getting an error: look@ <a href="https://github.com/zulip/zulip/issues/15919">https://github.com/zulip/zulip/issues/15919</a></p>
<p>can anyone help me with this? thx</p>



<a name="953839"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953839" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953839">(Jul 24 2020 at 22:18)</a>:</h4>
<p><span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span> I haven't seen that error before.</p>



<a name="953840"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953840" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953840">(Jul 24 2020 at 22:19)</a>:</h4>
<p>Can you post <code>/var/log/zulip/upgrade.log</code>?  I suspect the actual problem is earlier than what you've posted there.</p>



<a name="953846"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953846" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953846">(Jul 24 2020 at 22:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/upgrade/near/953840">said</a>:</p>
<blockquote>
<p>Can you post <code>/var/log/zulip/upgrade.log</code>?  I suspect the actual problem is earlier than what you've posted there.</p>
</blockquote>
<p><a href="/user_uploads/2/83/_CDzR1z-Um3lCbTmTdHFKSW6/upgrade.log">upgrade.log</a></p>



<a name="953848"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953848" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953848">(Jul 24 2020 at 22:25)</a>:</h4>
<p><span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span> OK my guess is that you were previously running a commit from master; is that possible?</p>



<a name="953849"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953849" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953849">(Jul 24 2020 at 22:25)</a>:</h4>
<p>(And that commit has many migrations newer than what is present in the latest <code>2.1.x</code>)</p>



<a name="953850"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953850" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953850">(Jul 24 2020 at 22:26)</a>:</h4>
<p>If so, you can likely just skip step 1 in <a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-debian-stretch-to-debian-buster">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-debian-stretch-to-debian-buster</a> and proceed.</p>



<a name="953851"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953851" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953851">(Jul 24 2020 at 22:26)</a>:</h4>
<p>yes. i have been on master all the time</p>



<a name="953853"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953853" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953853">(Jul 24 2020 at 22:26)</a>:</h4>
<p>2020-07-24 20:28:07,693 upgrade-zulip-from-git: Fetching the latest commits<br>
2020-07-24 20:28:35,081 upgrade-zulip-stage-2: Unsupported platform: debian 9<br>
2020-07-24 20:28:35,081 upgrade-zulip-stage-2: Sorry! The support for your OS has been discontinued.<br>
Please upgrade your OS to a supported release first.<br>
See <a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-the-operating-system">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-the-operating-system</a><br>
Traceback (most recent call last):</p>



<a name="953854"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953854" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953854">(Jul 24 2020 at 22:26)</a>:</h4>
<p>And then upgrade to 3.0 once you've done the database upgrade documented there.</p>



<a name="953855"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953855" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953855">(Jul 24 2020 at 22:27)</a>:</h4>
<p>ok. i will try.</p>



<a name="953856"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/953856" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#953856">(Jul 24 2020 at 22:27)</a>:</h4>
<p>thx</p>



<a name="988399"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988399" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988399">(Aug 14 2020 at 14:52)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  i was trying to upgrade from 2.1.x to the git master...this error comes up</p>
<p><a href="/user_uploads/2/9e/DK4hgftBkXwH-hw5oX_itFDN/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/2/9e/DK4hgftBkXwH-hw5oX_itFDN/image.png" title="image.png"><img src="/user_uploads/2/9e/DK4hgftBkXwH-hw5oX_itFDN/image.png"></a></div><p>any suggestions? thx</p>



<a name="988402"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988402" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988402">(Aug 14 2020 at 14:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/upgrade/near/953854">said</a>:</p>
<blockquote>
<p>And then upgrade to 3.0 once you've done the database upgrade documented there.</p>
</blockquote>
<p>do I have to upgrade to 3.0 or could I also to git master?</p>



<a name="988454"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988454" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988454">(Aug 14 2020 at 15:59)</a>:</h4>
<p>also this one <a href="https://github.com/zulip/zulip/issues/16140">https://github.com/zulip/zulip/issues/16140</a></p>



<a name="988603"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988603" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988603">(Aug 14 2020 at 18:12)</a>:</h4>
<p><span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span> you should be able to go directly to master.</p>



<a name="988604"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988604" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988604">(Aug 14 2020 at 18:13)</a>:</h4>
<p>I think this is a bug in how that migration was updated for <code>orjson</code>, the new JSON parser we're using.</p>



<a name="988605"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988605" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988605">(Aug 14 2020 at 18:13)</a>:</h4>
<p>If you upgrade to 3.1 and then master, you won't see this; but we'll also fix that migration in master.</p>



<a name="988608"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988608" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988608">(Aug 14 2020 at 18:15)</a>:</h4>
<p>I think the fix should just be this:</p>
<div class="codehilite"><pre><span></span><code>diff --git a/zerver/migrations/0284_convert_realm_admins_to_realm_owners.py b/zerver/migrations/0284_convert_realm_admins_to_realm_owners.py
index 17bdcaaa90..753374b908 100644
--- a/zerver/migrations/0284_convert_realm_admins_to_realm_owners.py
+++ b/zerver/migrations/0284_convert_realm_admins_to_realm_owners.py
@@ -32,7 +32,7 @@ def set_realm_admins_as_realm_owners(apps: StateApps, schema_editor: DatabaseSch
                         UserProfile.ROLE_GUEST: 0}
         for value_dict in list(UserProfile.objects.filter(
                 realm=realm, is_bot=False, is_active=True).values(&#39;role&#39;).annotate(Count(&#39;role&#39;))):
-            human_counts[value_dict[&#39;role&#39;]] = value_dict[&#39;role__count&#39;]
+            human_counts[str(value_dict[&#39;role&#39;])] = value_dict[&#39;role__count&#39;]
         bot_count = UserProfile.objects.filter(realm=realm, is_bot=True, is_active=True).count()
         return {
             RealmAuditLog.ROLE_COUNT_HUMANS: human_counts,
</code></pre></div>



<a name="988623"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988623" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988623">(Aug 14 2020 at 18:23)</a>:</h4>
<p>OK, fixed merged as <a href="https://github.com/zulip/zulip/commit/f2c9ee80007a0e19393ab229a0cca52600edc01a">f2c9ee80007a0e19393ab229a0cca52600edc01a</a>.  Thanks for the report <span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span>; you should be able to just upgrade to master now that the fix to a regression in that migration since 3.1 has been merged.</p>



<a name="988626"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988626" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988626">(Aug 14 2020 at 18:24)</a>:</h4>
<p>I'll try it right now</p>



<a name="988644"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988644" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988644">(Aug 14 2020 at 18:31)</a>:</h4>
<p>everything was going great <span class="user-mention" data-user-id="7">@Tim Abbott</span> <br>
thank you very much for the very fast solution :-) <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="988671"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/988671" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#988671">(Aug 14 2020 at 18:44)</a>:</h4>
<p>Thanks for the report!  Reports like this help us avoid the upgrade from 2.x to 4.0 being broken in the future <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>.</p>



<a name="1136909"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1136909" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1136909">(Mar 19 2021 at 19:04)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="7">@Tim Abbott</span> <br>
was trying to upgrad from git master</p>
<div class="codehilite"><pre><span></span><code>root@chat: ~ # /home/zulip/deployments/current/scripts/upgrade-zulip-from-git master
i ｢wdm｣: Webpack compilation successful.
+ ./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates
+ ./manage.py compilemessages -v0
2021-03-19 18:32:02,692 upgrade-zulip-stage-2: Caching Zulip Git version...
2021-03-19 18:32:02,917 upgrade-zulip-stage-2: Checking for needed migrations
2021-03-19 18:32:08,868 upgrade-zulip-stage-2: Stopping Zulip...
zulip-workers:zulip_deliver_enqueued_emails: stopped
zulip-workers:zulip_deliver_scheduled_messages: stopped
zulip-workers:zulip_events_email_mirror: stopped
zulip-workers:zulip_events_email_senders: stopped
zulip-workers:zulip_events_missedmessage_mobile_notifications: stopped
zulip-workers:zulip_events_outgoing_webhooks: stopped
zulip-workers:zulip_events_invites: stopped
zulip-workers:zulip_events_user_activity_interval: stopped
zulip-workers:zulip_events_missedmessage_emails: stopped
zulip-workers:zulip_events_digest_emails: stopped
zulip-workers:zulip_events_user_activity: stopped
zulip-workers:zulip_events_user_presence: stopped
zulip-workers:zulip_events_embedded_bots: stopped
zulip-workers:zulip_events_deferred_work: stopped
zulip-workers:zulip_events_embed_links: stopped
zulip-workers:zulip_events_error_reports: stopped
zulip-django: stopped
zulip-tornado: stopped
2021-03-19 18:32:17,993 upgrade-zulip-stage-2: Applying Puppet changes...
Traceback (most recent call last):
  File &quot;./scripts/zulip-puppet-apply&quot;, line 10, in &lt;module&gt;
    import yaml
ModuleNotFoundError: No module named &#39;yaml&#39;
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2021-03-19-19-26-21/scripts/lib/upgrade-zulip-stage-2&quot;, line 310, in &lt;module&gt;
    subprocess.check_call([&quot;./scripts/zulip-puppet-apply&quot;, &quot;--force&quot;])
  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./scripts/zulip-puppet-apply&#39;, &#39;--force&#39;]&#39; returned non-zero exit status 1.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip-from-git&quot;, line 93, in &lt;module&gt;
    *deploy_options,
  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2021-03-19-19-26-21/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2021-03-19-19-26-21&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1.
</code></pre></div>



<a name="1136911"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1136911" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1136911">(Mar 19 2021 at 19:05)</a>:</h4>
<p>Well, the fix is <code>apt install python3-pyyaml</code> and then doing it again.</p>



<a name="1136913"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1136913" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1136913">(Mar 19 2021 at 19:06)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> the bug is that we need <code>pyyaml</code> in order to run <code>zulip-puppet-apply</code> -- I think the right fix might in part be to just move the <code>import yaml</code> inwards to only run in the <code>noop</code> state?  Not sure.</p>



<a name="1136914"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1136914" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1136914">(Mar 19 2021 at 19:07)</a>:</h4>
<p>you mean pip install pyyaml?<br>
because apt does not work</p>



<a name="1136916"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1136916" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1136916">(Mar 19 2021 at 19:08)</a>:</h4>
<p><code>apt install python3-yaml</code>, not <code>python3-pyyaml</code>.</p>



<a name="1136920"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1136920" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1136920">(Mar 19 2021 at 19:11)</a>:</h4>
<p>works fine. thx</p>



<a name="1136931"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1136931" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1136931">(Mar 19 2021 at 19:42)</a>:</h4>
<p>Moving it to right before it's used won't work -- we've only run the <code>--noop</code> version, so puppet hasn't installed <code>python3-yaml</code> yet.</p>
<p>I think we'd need to bootstrap this with an <code>apt-get install python3-yaml</code> in <code>upgrade-zulip-stage-2</code> before puppet.  For the same reason that the installer needs to install yaml before running zulip-puppet-apply, the upgrader needs to do the same.</p>



<a name="1136933"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1136933" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1136933">(Mar 19 2021 at 19:43)</a>:</h4>
<p>Or we just parse it out without importing <code>yaml</code> <span aria-label="scared" class="emoji emoji-1f628" role="img" title="scared">:scared:</span></p>



<a name="1137379"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1137379" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1137379">(Mar 20 2021 at 02:06)</a>:</h4>
<p>Well, with default options, we'll never run the <code>--noop</code> version.  But yeah, best would be the bootstrapping approach (with some sort of fast <code>[ -e </code> check to avoid making things slow)</p>



<a name="1138786"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1138786" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1138786">(Mar 22 2021 at 14:34)</a>:</h4>
<p>I've foud one issue when running this (<code>/home/zulip/deployments/current/scripts/upgrade-zulip-from-git master</code>), is that node is 12.18 and the upgrade seems to require &gt;=12.19 (this was on ubuntu 18.04). I had to manually install the latest stable version of 12.x and change the system to use <code>upgrade-zulip-from-git master</code>.<br>
(this is <strong>not</strong> a 'recommended' fix by any means...)</p>
<p><em>(not that it fixed my Android notification issue(s), but at this point I'm trying every/anything to help the server have the right versions (of whatever) to send those pushes to GCM <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> )</em></p>



<a name="1139141"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1139141" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1139141">(Mar 22 2021 at 18:17)</a>:</h4>
<p><span class="user-mention" data-user-id="19361">@Eric</span> Our upgrade script installs its preferred version of <code>node</code> (currently 14.16.0) itself and symlinks it into <code>/usr/local/bin/node</code>. Do you have a different version of <code>node</code> earlier in your <code>PATH</code>? If so, you should remove it.</p>



<a name="1139439"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1139439" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1139439">(Mar 22 2021 at 20:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="699">Anders Kaseorg</span> <a href="#narrow/stream/31-production-help/topic/upgrade/near/1139141">said</a>:</p>
<blockquote>
<p>Do you have a different version of <code>node</code> earlier in your <code>PATH</code>? If so, you should remove it.</p>
</blockquote>
<p><span class="user-mention" data-user-id="699">@Anders Kaseorg</span>  That's interesting, when I did an upgrade (<a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-to-a-release">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-to-a-release</a>), on an Ubuntu 18 VPS with 3.3 installed, the installer failed because it was trying to find node above 12.19, but could only find 12.18.</p>
<p>Unfortunatley I've deleted the entire server otherwise I'd go back and get the logs.</p>
<p>Is there a possibility the wrong version of <code>node</code> could cause issues with registering devices or managing them in Postgres?</p>



<a name="1139458"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1139458" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1139458">(Mar 22 2021 at 20:46)</a>:</h4>
<p>Unlikely; a production install only uses Node to compile the JavaScript bundles with Webpack and to render LaTeX messages with KaTeX.</p>



<a name="1162893"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1162893" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1162893">(Apr 15 2021 at 00:18)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> did we fix <code>upgrade-zulip-stage-2</code> for this issue yet?  If not we should make an issue and tag it as a blocker, since I think we'll get N reports of this if we post a release candidate and encourage folks to upgrade right now.</p>



<a name="1164152"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/upgrade/near/1164152" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/upgrade.html#1164152">(Apr 16 2021 at 01:56)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/pull/18179">#18179</a>.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>