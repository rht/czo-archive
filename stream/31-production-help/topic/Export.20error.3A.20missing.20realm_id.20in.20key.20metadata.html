<html>
<head><meta charset="utf-8"><title>Export error: missing realm_id in key metadata · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Export.20error.3A.20missing.20realm_id.20in.20key.20metadata.html">Export error: missing realm_id in key metadata</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1401643"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Export%20error%3A%20missing%20realm_id%20in%20key%20metadata/near/1401643" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Marko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Export.20error.3A.20missing.20realm_id.20in.20key.20metadata.html#1401643">(Jul 08 2022 at 15:34)</a>:</h4>
<p>Hi everyone! I was trying to do a data export of our zulip server, and import it to a fresh new zulip server. However, I am getting a error "AssertionError: Missing realm_id in key metadata: {}" during the export. Please see the complete traceback below:</p>
<div class="codehilite"><pre><span></span><code>Exporting realm:
2022-07-08 14:56:48.635 INFO [] Exporting data from get_realm_config()...
2022-07-08 14:56:48.635 INFO [] Exporting via export_from_config:  zerver_realm
2022-07-08 14:56:48.636 INFO [] Exporting via export_from_config:  zerver_defaultstream
2022-07-08 14:56:48.644 INFO [] Exporting via export_from_config:  zerver_customprofilefield
2022-07-08 14:56:48.649 INFO [] Exporting via export_from_config:  zerver_realmauditlog
2022-07-08 14:56:48.682 INFO [] Exporting via export_from_config:  zerver_realmemoji
2022-07-08 14:56:48.691 INFO [] Exporting via export_from_config:  zerver_realmdomain
2022-07-08 14:56:48.698 INFO [] Exporting via export_from_config:  zerver_realmfilter
2022-07-08 14:56:48.701 INFO [] Exporting via export_from_config:  zerver_realmplayground
2022-07-08 14:56:48.713 INFO [] Exporting via export_from_config:  zerver_client
2022-07-08 14:56:48.720 INFO [] Exporting via export_from_config:  zerver_realmuserdefault
2022-07-08 14:56:48.730 INFO [] Exporting via export_from_config:  zerver_userprofile
2022-07-08 14:56:48.734 INFO [] Exporting via export_from_config:  zerver_userprofile_mirrordummy
2022-07-08 14:56:48.979 INFO [] Exporting via export_from_config:  zerver_userprofile_crossrealm
2022-07-08 14:56:49.008 INFO [] Exporting via export_from_config:  zerver_service
2022-07-08 14:56:49.013 INFO [] Exporting via export_from_config:  zerver_botstoragedata
2022-07-08 14:56:49.017 INFO [] Exporting via export_from_config:  zerver_botconfigdata
2022-07-08 14:56:49.021 INFO [] Exporting via export_from_config:  _user_subscription
2022-07-08 14:56:49.030 INFO [] Exporting via export_from_config:  _user_recipient
2022-07-08 14:56:49.037 INFO [] Exporting via export_from_config:  _huddle_recipient
2022-07-08 14:56:49.037 INFO [] Exporting via export_from_config:  _huddle_subscription
2022-07-08 14:56:49.037 INFO [] Exporting via export_from_config:  zerver_huddle
2022-07-08 14:56:49.078 INFO [] Exporting via export_from_config:  zerver_alertword
2022-07-08 14:56:49.083 INFO [] Exporting via export_from_config:  zerver_customprofilefieldvalue
2022-07-08 14:56:49.090 INFO [] Exporting via export_from_config:  zerver_muteduser
2022-07-08 14:56:49.099 INFO [] Exporting via export_from_config:  zerver_useractivity
2022-07-08 14:56:49.161 INFO [] Exporting via export_from_config:  zerver_useractivityinterval
2022-07-08 14:56:52.091 INFO [] Exporting via export_from_config:  zerver_userhotspot
2022-07-08 14:56:52.103 INFO [] Exporting via export_from_config:  zerver_userpresence
2022-07-08 14:56:52.111 INFO [] Exporting via export_from_config:  zerver_userstatus
2022-07-08 14:56:52.117 INFO [] Exporting via export_from_config:  zerver_usertopic
2022-07-08 14:56:52.124 INFO [] Exporting via export_from_config:  zerver_usergroup
2022-07-08 14:56:52.262 INFO [] Exporting via export_from_config:  zerver_usergroupmembership
2022-07-08 14:56:52.268 INFO [] Exporting via export_from_config:  zerver_groupgroupmembership
2022-07-08 14:56:52.272 INFO [] Exporting via export_from_config:  zerver_stream
2022-07-08 14:56:52.279 INFO [] Exporting via export_from_config:  _stream_recipient
2022-07-08 14:56:52.283 INFO [] Exporting via export_from_config:  _stream_subscription
2022-07-08 14:56:52.301 INFO [] Exporting via export_from_config:  zerver_recipient
2022-07-08 14:56:52.301 INFO [] Deleted temporary _user_recipient
2022-07-08 14:56:52.301 INFO [] Deleted temporary _stream_recipient
2022-07-08 14:56:52.301 INFO [] Deleted temporary _huddle_recipient
2022-07-08 14:56:52.302 INFO [] Exporting via export_from_config:  zerver_subscription
2022-07-08 14:56:52.302 INFO [] Deleted temporary _user_subscription
2022-07-08 14:56:52.302 INFO [] Deleted temporary _stream_subscription
2022-07-08 14:56:52.302 INFO [] Deleted temporary _huddle_subscription
2022-07-08 14:56:52.302 INFO [] ...DONE with get_realm_config() data
2022-07-08 14:56:52.303 INFO [] Exporting uploaded files and avatars
2022-07-08 14:56:53.110 INFO [] Downloading upload files from tesi-zulip-uploads
Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 157, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;./manage.py&quot;, line 122, in execute_from_command_line
    utility.execute()
  File &quot;/srv/zulip-venv-cache/a30311a4e5879c676d7aa8276dd6be5dcb00b3d1/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py&quot;, line 413, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/srv/zulip-venv-cache/a30311a4e5879c676d7aa8276dd6be5dcb00b3d1/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/srv/zulip-venv-cache/a30311a4e5879c676d7aa8276dd6be5dcb00b3d1/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 398, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/management/commands/export.py&quot;, line 207, in handle
    export_realm_wrapper(
  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/lib/export.py&quot;, line 2248, in export_realm_wrapper
    tarball_path = do_export_realm(
  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/lib/export.py&quot;, line 1842, in do_export_realm
    export_uploads_and_avatars(realm, user=None, output_dir=output_dir)
  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/lib/export.py&quot;, line 1425, in export_uploads_and_avatars
    export_files_from_s3(
  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/lib/export.py&quot;, line 1588, in export_files_from_s3
    raise AssertionError(f&quot;Missing realm_id in key metadata: {key.metadata}&quot;)
AssertionError: Missing realm_id in key metadata: {}
</code></pre></div>
<p>I am using Wasabi (S3-compatible object storage) as my file upload backend. Any ideas?</p>
<p>Thanks!</p>



<a name="1401644"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Export%20error%3A%20missing%20realm_id%20in%20key%20metadata/near/1401644" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Export.20error.3A.20missing.20realm_id.20in.20key.20metadata.html#1401644">(Jul 08 2022 at 15:36)</a>:</h4>
<p><span class="user-mention" data-user-id="11031">@Marko</span> I haven't seen this error before, but I can speculate a bit about the problem.</p>



<a name="1401647"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Export%20error%3A%20missing%20realm_id%20in%20key%20metadata/near/1401647" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Export.20error.3A.20missing.20realm_id.20in.20key.20metadata.html#1401647">(Jul 08 2022 at 15:36)</a>:</h4>
<p>Zulip stores metadata in S3 when it uploads files -- basic details like what realm/organization the file is associated with.</p>



<a name="1401648"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Export%20error%3A%20missing%20realm_id%20in%20key%20metadata/near/1401648" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Export.20error.3A.20missing.20realm_id.20in.20key.20metadata.html#1401648">(Jul 08 2022 at 15:36)</a>:</h4>
<p>That assertion error suggests that the metadata cannot be read back out from your Wasabi S3 backend.</p>



<a name="1401649"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Export%20error%3A%20missing%20realm_id%20in%20key%20metadata/near/1401649" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Export.20error.3A.20missing.20realm_id.20in.20key.20metadata.html#1401649">(Jul 08 2022 at 15:37)</a>:</h4>
<p>So one possibility is that Wasabi does not correctly implement the S3 protocol and is just silently failing to store key metadata when Zulip requests that.</p>



<a name="1401651"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Export%20error%3A%20missing%20realm_id%20in%20key%20metadata/near/1401651" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Export.20error.3A.20missing.20realm_id.20in.20key.20metadata.html#1401651">(Jul 08 2022 at 15:40)</a>:</h4>
<p>I don't see obvious evidence of that being a known issue with Wasabi after a bit if research. I think the next thing I'd recommend trying is a bit of print-debugging to see whether the issue is isolated to one file or applies to all files.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>