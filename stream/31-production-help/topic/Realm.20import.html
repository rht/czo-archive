<html>
<head><meta charset="utf-8"><title>Realm import · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html">Realm import</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="800487"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800487" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800487">(Dec 04 2019 at 19:03)</a>:</h4>
<p>Hi,<br>
Currently I'm trying to move Zulip to new server but import command crash right at the beginning of the process.</p>
<div class="codehilite"><pre><span></span>Processing dump: /home/zulip/zulip ...
2019-12-04 18:59:22.691 INFO [] Importing realm dump /home/zulip/zulip
2019-12-04 18:59:22.691 INFO [] Importing realm data from /home/zulip/zulip/realm.json
2019-12-04 18:59:23.885 INFO [] Successfully imported &lt;class &#39;zerver.models.Stream&#39;&gt; from zerver_stream.
Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 46, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 364, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 356, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 283, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 330, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/management/commands/import.py&quot;, line 79, in handle
    realm = do_import_realm(path, subdomain, num_processes)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/import_realm.py&quot;, line 764, in do_import_realm
    logging.info(&quot;Adding to ID map: %s %s&quot; % (item[&#39;id&#39;], get_system_bot(item[&#39;email&#39;]).id))
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/cache.py&quot;, line 167, in func_with_caching
    val = func(*args, **kwargs)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/models.py&quot;, line 1882, in get_system_bot
    return UserProfile.objects.select_related().get(email__iexact=email.strip())
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py&quot;, line 380, in get
    self.model._meta.object_name
zerver.models.DoesNotExist: UserProfile matching query does not exist.
</pre></div>


<p>Any tips?</p>



<a name="800489"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800489" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800489">(Dec 04 2019 at 19:04)</a>:</h4>
<p>Both instances are running 2.0.7 but old one is... very old.</p>



<a name="800497"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800497" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800497">(Dec 04 2019 at 19:16)</a>:</h4>
<p><span class="user-mention" data-user-id="2617">@Paweł Jastrzębski</span> that looks like a system bot is missing.</p>



<a name="800498"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800498" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800498">(Dec 04 2019 at 19:17)</a>:</h4>
<p>Which would suggest the database isn't properly initialized prior to running the import.</p>



<a name="800499"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800499" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800499">(Dec 04 2019 at 19:17)</a>:</h4>
<p>Can you explain exactly how you setup the system you're importing into?</p>



<a name="800500"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800500" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800500">(Dec 04 2019 at 19:18)</a>:</h4>
<p>Steps 1-2 <a href="https://zulip.readthedocs.io/en/latest/production/install.html" target="_blank" title="https://zulip.readthedocs.io/en/latest/production/install.html">https://zulip.readthedocs.io/en/latest/production/install.html</a></p>



<a name="800501"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800501" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800501">(Dec 04 2019 at 19:18)</a>:</h4>
<p>Plus I replaced contents of <code>/etc/zulip</code> with configs from old server.</p>



<a name="800502"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800502" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800502">(Dec 04 2019 at 19:19)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> could this be a system bot that used to exist on the old server, but no longer gets created on newer versions?</p>



<a name="800503"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800503" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800503">(Dec 04 2019 at 19:19)</a>:</h4>
<p>Did you try running the import process, delete the database, and rerun again at any point?</p>



<a name="800504"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800504" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800504">(Dec 04 2019 at 19:19)</a>:</h4>
<p>That's certainly possible.</p>



<a name="800505"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800505" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800505">(Dec 04 2019 at 19:20)</a>:</h4>
<p><span class="user-mention" data-user-id="2617">@Paweł Jastrzębski</span> can you add  aprint statement to see what the email of the system bot in question is?</p>



<a name="800506"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800506" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800506">(Dec 04 2019 at 19:21)</a>:</h4>
<p>I deleted unfinished import with <code>realm.delete()</code> but every time it produce the same error.</p>



<a name="800507"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800507" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800507">(Dec 04 2019 at 19:21)</a>:</h4>
<p>Where to add it?</p>



<a name="800508"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800508" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800508">(Dec 04 2019 at 19:23)</a>:</h4>
<p>The line above this one: <code>logging.info("Adding to ID map: %s %s" % (item['id'], get_system_bot(item['email']).id))</code>; you can see the file and line number above.</p>



<a name="800509"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800509" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800509">(Dec 04 2019 at 19:23)</a>:</h4>
<p>OK. One moment.</p>



<a name="800510"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800510" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800510">(Dec 04 2019 at 19:25)</a>:</h4>
<p><code>notification-bot@zulip.com</code></p>



<a name="800513"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800513" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800513">(Dec 04 2019 at 19:40)</a>:</h4>
<div class="codehilite"><pre><span></span>INTERNAL_BOTS = [{&#39;var_name&#39;: &#39;NOTIFICATION_BOT&#39;,
                  &#39;email_template&#39;: &#39;notification-bot@%s&#39;,
                  &#39;name&#39;: &#39;Notification Bot&#39;},
</pre></div>


<p>should exist  on news installs too</p>



<a name="800517"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800517" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800517">(Dec 04 2019 at 19:43)</a>:</h4>
<p>This is only place in dump where I see that e-mail:</p>
<div class="codehilite"><pre><span></span>    &quot;zerver_userprofile_crossrealm&quot;:[
        {
            &quot;recipient_id&quot;:5,
            &quot;id&quot;:5,
            &quot;email&quot;:&quot;notification-bot@zulip.com&quot;
        },
        {
            &quot;recipient_id&quot;:24,
            &quot;id&quot;:13,
            &quot;email&quot;:&quot;email-bot@my.domain&quot;
        },
        {
            &quot;recipient_id&quot;:4,
            &quot;id&quot;:4,
            &quot;email&quot;:&quot;welcome-bot@zulip.com&quot;
        }
    ],
</pre></div>



<a name="800518"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800518" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800518">(Dec 04 2019 at 19:43)</a>:</h4>
<p><span class="user-mention" data-user-id="2617">@Paweł Jastrzębski</span> can you try in the django shell (<code>manage.py shell</code> as the zulip user in the directory with the current deployment) the line</p>
<div class="codehilite"><pre><span></span>get_system_bot(&quot;notification-bot@zulip.com&quot;)
</pre></div>



<a name="800519"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800519" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800519">(Dec 04 2019 at 19:44)</a>:</h4>
<div class="codehilite"><pre><span></span>In [1]: get_system_bot(&quot;notification-bot@zulip.com&quot;)
---------------------------------------------------------------------------
DoesNotExist                              Traceback (most recent call last)
&lt;ipython-input-1-48cbf9311d2a&gt; in &lt;module&gt;()
----&gt; 1 get_system_bot(&quot;notification-bot@zulip.com&quot;)

~/deployments/2019-11-22-09-58-06/zerver/lib/cache.py in func_with_caching(*args, **kwargs)
    165                 return val[0]
    166
--&gt; 167             val = func(*args, **kwargs)
    168
    169             cache_set(key, val, cache_name=cache_name, timeout=timeout)

~/deployments/2019-11-22-09-58-06/zerver/models.py in get_system_bot(email)
   1880 @cache_with_key(bot_profile_cache_key, timeout=3600*24*7)
   1881 def get_system_bot(email: str) -&gt; UserProfile:
-&gt; 1882     return UserProfile.objects.select_related().get(email__iexact=email.strip())
   1883
   1884 def get_user_by_id_in_realm_including_cross_realm(

~/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py in get(self, *args, **kwargs)
    378             raise self.model.DoesNotExist(
    379                 &quot;%s matching query does not exist.&quot; %
--&gt; 380                 self.model._meta.object_name
    381             )
    382         raise self.model.MultipleObjectsReturned(

DoesNotExist: UserProfile matching query does not exist.
</pre></div>



<a name="800520"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800520" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800520">(Dec 04 2019 at 19:46)</a>:</h4>
<p>So some basic DB initialization failed during setup?</p>



<a name="800521"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800521" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800521">(Dec 04 2019 at 19:46)</a>:</h4>
<p>I don't remember seeing any errors.</p>



<a name="800522"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800522" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800522">(Dec 04 2019 at 19:49)</a>:</h4>
<p>can you show</p>
<div class="codehilite"><pre><span></span>for bot in UserProfile.objects.filter(realm__string_id=&#39;zulipinternal&#39;):
     print(bot.email)
</pre></div>



<a name="800523"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800523" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800523">(Dec 04 2019 at 19:49)</a>:</h4>
<p>nothing</p>



<a name="800524"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800524" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800524">(Dec 04 2019 at 19:50)</a>:</h4>
<p>yeah, that's not right, bots should have been created on install <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="800525"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800525" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800525">(Dec 04 2019 at 19:50)</a>:</h4>
<p>OK. Any civilized way to re-init this instance? :-)</p>



<a name="800526"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800526" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800526">(Dec 04 2019 at 19:51)</a>:</h4>
<p>Just to be sure, does the realm exist:</p>
<div class="codehilite"><pre><span></span>get_realm(&quot;zulipinternal&quot;)
</pre></div>



<a name="800527"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800527" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800527">(Dec 04 2019 at 19:52)</a>:</h4>
<p>no output</p>



<a name="800528"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800528" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800528">(Dec 04 2019 at 19:53)</a>:</h4>
<p>but no error?</p>
<div class="codehilite"><pre><span></span>In [3]: get_realm(&quot;zulipinternal&quot;)
Out[3]: &lt;Realm: &lt;Realm: zulipinternal 1&gt;&gt;

In [4]: get_realm(&quot;zulipinternalkkk&quot;)
---------------------------------------------------------------------------
DoesNotExist                              Traceback (most recent call last)
&lt;ipython-input-4-34d13167adbd&gt; in &lt;module&gt;
----&gt; 1 get_realm(&quot;zulipinternalkkk&quot;)

~/deployments/2019-11-16-10-04-50/zerver/models.py in get_realm(string_id)
    520
    521 def get_realm(string_id: str) -&gt; Realm:
--&gt; 522     return Realm.objects.get(string_id=string_id)
    523
    524 def name_changes_disabled(realm: Optional[Realm]) -&gt; bool:

~/deployments/2019-11-16-10-04-50/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/manager.py in manager_method(self, *args, **kwargs)
     83         def create_method(name, method):
     84             def manager_method(self, *args, **kwargs):
---&gt; 85                 return getattr(self.get_queryset(), name)(*args, **kwargs)
     86             manager_method.__name__ = method.__name__
     87             manager_method.__doc__ = method.__doc__

~/deployments/2019-11-16-10-04-50/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py in get(self, *args, **kwargs)
    378             raise self.model.DoesNotExist(
    379                 &quot;%s matching query does not exist.&quot; %
--&gt; 380                 self.model._meta.object_name
    381             )
    382         raise self.model.MultipleObjectsReturned(

DoesNotExist: Realm matching query does not exist.
</pre></div>


<p>Should be something, or an error <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="800529"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800529" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800529">(Dec 04 2019 at 19:55)</a>:</h4>
<div class="codehilite"><pre><span></span>Successfully imported Zulip settings, models, and actions functions.

In [1]: get_realm(&quot;zulipinternal&quot;)

In [2]: get_realm(&quot;zulipinternalkkk&quot;)

In [3]:
</pre></div>



<a name="800530"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800530" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800530">(Dec 04 2019 at 19:59)</a>:</h4>
<div class="codehilite"><pre><span></span>        if Realm.objects.count() &gt; 0:
            print(&quot;Database already initialized; doing nothing.&quot;)
            return
        realm = Realm.objects.create(string_id=settings.SYSTEM_BOT_REALM)
</pre></div>


<p>how about this? This is an instance we don't have to worry about messing up, right?</p>



<a name="800531"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800531" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800531">(Dec 04 2019 at 19:59)</a>:</h4>
<p><code>zerver_realm</code> table is empty</p>



<a name="800532"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800532" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800532">(Dec 04 2019 at 20:00)</a>:</h4>
<p>yeah it is fresh instance without data</p>



<a name="800533"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800533" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800533">(Dec 04 2019 at 20:00)</a>:</h4>
<p>ok, we can try being adventurous then</p>



<a name="800534"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800534" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800534">(Dec 04 2019 at 20:01)</a>:</h4>
<p>hmm or instead of running that <span class="user-mention" data-user-id="2617">@Paweł Jastrzębski</span></p>



<a name="800535"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800535" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800535">(Dec 04 2019 at 20:01)</a>:</h4>
<p>Just try <code>manage.py initialize_voyager_db</code>?</p>



<a name="800536"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800536" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800536">(Dec 04 2019 at 20:01)</a>:</h4>
<div class="codehilite"><pre><span></span>In [3]: realm = Realm.objects.create(string_id=settings.SYSTEM_BOT_REALM)

In [4]: realm
Out[4]: &lt;Realm: &lt;Realm: zulip 4&gt;&gt;
</pre></div>



<a name="800537"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800537" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800537">(Dec 04 2019 at 20:01)</a>:</h4>
<p>too late ;p</p>



<a name="800538"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800538" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800538">(Dec 04 2019 at 20:02)</a>:</h4>
<p><code>realm.delete()</code> still in this shell</p>
<p>and then run that management command</p>



<a name="800539"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800539" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800539">(Dec 04 2019 at 20:02)</a>:</h4>
<div class="codehilite"><pre><span></span>zulip@balin:~/deployments/current$ ./manage.py initialize_voyager_db
Successfully populated database with initial data.
Please run ./manage.py generate_realm_creation_link to generate link for creating organization
</pre></div>



<a name="800540"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800540" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800540">(Dec 04 2019 at 20:03)</a>:</h4>
<p>Try importing now <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="800541"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800541" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800541">(Dec 04 2019 at 20:03)</a>:</h4>
<p><code>get_realm("zulipinternal")</code> still return nothing</p>



<a name="800542"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800542" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800542">(Dec 04 2019 at 20:04)</a>:</h4>
<p>and the tables are empty?</p>



<a name="800543"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800543" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800543">(Dec 04 2019 at 20:04)</a>:</h4>
<p>one record</p>



<a name="800544"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800544" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800544">(Dec 04 2019 at 20:04)</a>:</h4>
<div class="codehilite"><pre><span></span>zulip=&gt; select * from zerver_realm;
-[ RECORD 1 ]----------------------------------+------------------------------
id                                             | 5
name                                           |
emails_restricted_to_domains                   | f
invite_required                                | t
invite_by_admins_only                          | f
mandatory_topics                               | f
digest_emails_enabled                          | t
name_changes_disabled                          | f
date_created                                   | 2019-12-04 20:02:48.850264+00
deactivated                                    | f
notifications_stream_id                        |
create_stream_by_admins_only                   | f
allow_message_editing                          | t
message_content_edit_limit_seconds             | 600
default_language                               | en
string_id                                      | zulip
org_type                                       | 1
message_retention_days                         |
authentication_methods                         | 2147483647
waiting_period_threshold                       | 0
add_emoji_by_admins_only                       | f
icon_source                                    | G
icon_version                                   | 1
email_changes_disabled                         | f
description                                    |
inline_image_preview                           | t
inline_url_embed_preview                       | t
allow_edit_history                             | t
allow_message_deleting                         | f
signup_notifications_stream_id                 |
max_invites                                    |
message_visibility_limit                       |
upload_quota_gb                                |
send_welcome_emails                            | t
bot_creation_policy                            | 1
disallow_disposable_email_addresses            | t
allow_community_topic_editing                  | t
default_twenty_four_hour_time                  | f
video_chat_provider                            | Jitsi
google_hangouts_domain                         |
message_content_delete_limit_seconds           | 600
plan_type                                      | 1
email_address_visibility                       | 1
first_visible_message_id                       | 0
logo_source                                    | D
logo_version                                   | 1
zoom_api_key                                   |
zoom_api_secret                                |
zoom_user_id                                   |
message_content_allowed_in_email_notifications | t
night_logo_source                              | D
night_logo_version                             | 1
</pre></div>



<a name="800545"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800545" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800545">(Dec 04 2019 at 20:06)</a>:</h4>
<p><code>print(settings.SYSTEM_BOT_REALM)</code> in the shell?</p>



<a name="800546"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800546" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800546">(Dec 04 2019 at 20:07)</a>:</h4>
<p><code>zulip</code></p>



<a name="800547"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800547" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800547">(Dec 04 2019 at 20:07)</a>:</h4>
<p>Ah, this is 2.0.7, so I think this is right. Can you just try importing now?</p>



<a name="800548"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800548" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800548">(Dec 04 2019 at 20:08)</a>:</h4>
<p>OK.</p>



<a name="800549"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800549" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800549">(Dec 04 2019 at 20:08)</a>:</h4>
<div class="codehilite"><pre><span></span>zulip@balin:~/deployments/current$ ./manage.py import &#39;&#39; ~/zulip
Processing dump: /home/zulip/zulip ...
2019-12-04 20:08:28.081 INFO [] Importing realm dump /home/zulip/zulip
2019-12-04 20:08:28.081 INFO [] Importing realm data from /home/zulip/zulip/realm.json
2019-12-04 20:08:29.289 INFO [] Successfully imported &lt;class &#39;zerver.models.Stream&#39;&gt; from zerver_stream.
notification-bot@zulip.com
notification-bot@zulip.com
2019-12-04 20:08:29.296 INFO [] Adding to ID map: 5 7
email-bot@my.domain
email-bot@my.domain
Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 46, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 364, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 356, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 283, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 330, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/management/commands/import.py&quot;, line 79, in handle
    realm = do_import_realm(path, subdomain, num_processes)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/import_realm.py&quot;, line 766, in do_import_realm
    logging.info(&quot;Adding to ID map: %s %s&quot; % (item[&#39;id&#39;], get_system_bot(item[&#39;email&#39;]).id))
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/cache.py&quot;, line 167, in func_with_caching
    val = func(*args, **kwargs)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/models.py&quot;, line 1882, in get_system_bot
    return UserProfile.objects.select_related().get(email__iexact=email.strip())
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py&quot;, line 380, in get
    self.model._meta.object_name
zerver.models.DoesNotExist: UserProfile matching query does not exist.
</pre></div>



<a name="800550"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800550" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800550">(Dec 04 2019 at 20:09)</a>:</h4>
<p>this time it exploded on some old internal bot</p>



<a name="800551"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800551" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800551">(Dec 04 2019 at 20:09)</a>:</h4>
<p>custom one</p>



<a name="800552"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800552" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800552">(Dec 04 2019 at 20:09)</a>:</h4>
<p>I'm trying to remember why it exist.</p>



<a name="800553"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800553" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800553">(Dec 04 2019 at 20:11)</a>:</h4>
<p>I'm guessing it was used for EMAIL_GATEWAY.</p>



<a name="800554"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800554" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800554">(Dec 04 2019 at 20:12)</a>:</h4>
<p>Yeah. It was used as EMAIL_GATEWAY_BOT.</p>



<a name="800555"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800555" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800555">(Dec 04 2019 at 20:12)</a>:</h4>
<p>So how fix that? :-)</p>



<a name="800557"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800557" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800557">(Dec 04 2019 at 20:13)</a>:</h4>
<p>Drop it from <code>zerver_userprofile_crossrealm</code> and pray?</p>



<a name="800558"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800558" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800558">(Dec 04 2019 at 20:15)</a>:</h4>
<p>we could try adding it to the database manually</p>



<a name="800559"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800559" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800559">(Dec 04 2019 at 20:16)</a>:</h4>
<p>hmmm or in the import code in this snippet:</p>
<div class="codehilite"><pre><span></span>    for item in data[&#39;zerver_userprofile_crossrealm&#39;]:
        if item[&#39;email&#39;].startswith(&quot;emailgateway@&quot;):
</pre></div>



<a name="800560"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800560" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800560">(Dec 04 2019 at 20:17)</a>:</h4>
<p>Change that second conditional to <code>if item['email'].startswith("email-bot@"):</code>?</p>



<a name="800561"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800561" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800561">(Dec 04 2019 at 20:18)</a>:</h4>
<p>and retry importing</p>



<a name="800562"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800562" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800562">(Dec 04 2019 at 20:19)</a>:</h4>
<p>I looks like it is importing it.</p>



<a name="800563"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800563" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800563">(Dec 04 2019 at 20:19)</a>:</h4>
<p>But I'm quite sure it will explode somewhere else :-)</p>



<a name="800564"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800564" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800564">(Dec 04 2019 at 20:20)</a>:</h4>
<p>This is ~4y old instance. I not expected that import will go smoothly.</p>



<a name="800565"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800565" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800565">(Dec 04 2019 at 20:20)</a>:</h4>
<p>is instance need to be up for import?</p>



<a name="800566"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800566" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800566">(Dec 04 2019 at 20:20)</a>:</h4>
<p>because im getting tons of <code>MemcachedError</code> error 15 and 21 during avatar import</p>



<a name="800567"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800567" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800567">(Dec 04 2019 at 20:21)</a>:</h4>
<p>but it not crashed</p>



<a name="800568"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800568" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800568">(Dec 04 2019 at 20:22)</a>:</h4>
<p>now only parse 1799 json files with messages</p>



<a name="800571"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800571" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800571">(Dec 04 2019 at 20:26)</a>:</h4>
<p>(deleted)</p>



<a name="800572"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800572" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800572">(Dec 04 2019 at 20:27)</a>:</h4>
<p>If it fails from the MemcacheErrors, I think I'd just try wiping the server and installing again - because something clearly went wrong in the installation, and if the failure was more than just the <code>initialize_voyager_db</code> script not running, it's too hard to figure it out and whether it may cause the current errors. With a succesfull install, I'd repeat the import code change that we just did and try importing then <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="800573"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800573" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800573">(Dec 04 2019 at 20:28)</a>:</h4>
<p>I rather not wipe this server as some time was already invested to prepare it.</p>



<a name="800574"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800574" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800574">(Dec 04 2019 at 20:28)</a>:</h4>
<p>So lets keep that as last resort.</p>



<a name="800575"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800575" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800575">(Dec 04 2019 at 20:29)</a>:</h4>
<p>But it also mean that install script failed and not crashed.</p>



<a name="800576"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800576" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800576">(Dec 04 2019 at 20:31)</a>:</h4>
<p>Nothing weird in <code>/var/log/zulip/install.log</code>?</p>



<a name="800577"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800577" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800577">(Dec 04 2019 at 20:32)</a>:</h4>
<p>Sadly I wiped that logs some time ago.</p>



<a name="800578"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800578" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800578">(Dec 04 2019 at 20:32)</a>:</h4>
<p>But I don't remember seeing any errors during install.</p>



<a name="800579"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800579" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800579">(Dec 04 2019 at 20:33)</a>:</h4>
<p>If this test import will succeed I think I will nuke this VM anyway.</p>



<a name="800580"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800580" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800580">(Dec 04 2019 at 20:33)</a>:</h4>
<p>Better safe than sorry.</p>



<a name="800581"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800581" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800581">(Dec 04 2019 at 20:37)</a>:</h4>
<div class="codehilite"><pre><span></span>2019-12-04 20:35:50.269 INFO [] Successfully imported &lt;class &#39;analytics.models.RealmCount&#39;&gt; from analytics_realmcount.
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/db.py&quot;, line 32, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/db.py&quot;, line 19, in wrapper_execute
    return action(sql, params)
psycopg2.OperationalError: out of memory
DETAIL:  Failed on request of size 262144.
</pre></div>



<a name="800582"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800582" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800582">(Dec 04 2019 at 20:37)</a>:</h4>
<p>:-|</p>



<a name="800586"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800586" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800586">(Dec 04 2019 at 20:46)</a>:</h4>
<p>Seems like it happened in <code>import_analytics_data</code>?</p>



<a name="800587"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800587" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800587">(Dec 04 2019 at 20:47)</a>:</h4>
<div class="codehilite"><pre><span></span>def bulk_import_model(data: TableData, model: Any, dump_file_id: Optional[str]=None) -&gt; None:
    table = get_db_table(model)
    # TODO, deprecate dump_file_id
    model.objects.bulk_create(model(**item) for item in data[table])
    if dump_file_id is None:
        logging.info(&quot;Successfully imported %s from %s.&quot; % (model, table))
    else:
        logging.info(&quot;Successfully imported %s from %s[%s].&quot; % (model, table, dump_file_id))
</pre></div>


<p>Shouldn't we add batching in this function, to avoid these kinds of crashes for huge tables? <span class="user-mention" data-user-id="7">@Tim Abbott</span></p>



<a name="800589"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800589" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800589">(Dec 04 2019 at 20:47)</a>:</h4>
<p>my analytics.json have 400mb</p>



<a name="800591"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800591" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800591">(Dec 04 2019 at 20:55)</a>:</h4>
<p>also memcached is working correctly</p>



<a name="800592"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800592" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800592">(Dec 04 2019 at 20:57)</a>:</h4>
<p>Awful code, but I'm in a hurry, can you try replacing the function with this and importing again?</p>
<div class="codehilite"><pre><span></span>def bulk_import_model(data: TableData, model: Any, dump_file_id: Optional[str]=None) -&gt; None:
    table = get_db_table(model)
    # TODO, deprecate dump_file_id
    BATCH_SIZE = 100
    current_batch = []
    for item in data[table]:
        current_batch.append(item)
        if len(current_batch) &gt;= BATCH_SIZE:
            model.objects.bulk_create(model(**item) for item in current_batch)
            current_batch = []

    if len(current_batch) &gt;= 0:
        model.objects.bulk_create(model(**item) for item in current_batch)

    if dump_file_id is None:
        logging.info(&quot;Successfully imported %s from %s.&quot; % (model, table))
    else:
        logging.info(&quot;Successfully imported %s from %s[%s].&quot; % (model, table, dump_file_id))
</pre></div>



<a name="800593"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800593" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800593">(Dec 04 2019 at 20:57)</a>:</h4>
<p>in how big batches avatars are imported?</p>



<a name="800595"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800595" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800595">(Dec 04 2019 at 21:00)</a>:</h4>
<p>I replaced that function. We will know in few minutes.</p>



<a name="800596"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800596" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800596">(Dec 04 2019 at 21:00)</a>:</h4>
<p>We don't store the avatar data in the database I think (only file paths), so I doubt this was about it</p>



<a name="800597"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800597" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800597">(Dec 04 2019 at 21:06)</a>:</h4>
<p>Its looks like pylibmc is hitting some memcached limit and/or threading issue during avatar parsing.</p>



<a name="800603"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800603" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800603">(Dec 04 2019 at 21:13)</a>:</h4>
<p>How much memory does your system have?</p>



<a name="800604"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800604" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800604">(Dec 04 2019 at 21:13)</a>:</h4>
<p>16gb</p>



<a name="800605"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800605" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800605">(Dec 04 2019 at 21:22)</a>:</h4>
<p><span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> import completed.</p>



<a name="800606"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800606" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800606">(Dec 04 2019 at 21:23)</a>:</h4>
<p>And things look reasonable in the imported realm?</p>



<a name="800607"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800607" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800607">(Dec 04 2019 at 21:24)</a>:</h4>
<p>I would say no considering that Tornado can't connect to RabbitMQ</p>



<a name="800608"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800608" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800608">(Dec 04 2019 at 21:25)</a>:</h4>
<p>I presume that overwriting <code>zulip-secrets.conf</code> broken something.</p>



<a name="800609"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800609" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800609">(Dec 04 2019 at 21:25)</a>:</h4>
<p><code>rabbitmq_password</code> ?</p>



<a name="800610"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800610" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800610">(Dec 04 2019 at 21:26)</a>:</h4>
<p>Yeah, overwriting that would be problematic.</p>



<a name="800611"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800611" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800611">(Dec 04 2019 at 21:27)</a>:</h4>
<p>"If your new Zulip server is meant to fully replace a previous Zulip server, you may want to copy the contents of /etc/zulip to your new server to reuse the server-level configuration and secret keys from your old server."</p>



<a name="800612"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800612" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800612">(Dec 04 2019 at 21:27)</a>:</h4>
<p>This is quote from documentation.</p>



<a name="800615"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800615" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800615">(Dec 04 2019 at 21:32)</a>:</h4>
<p>OK. <code>./scripts/setup/configure-rabbitmq</code> fixed that</p>



<a name="800616"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800616" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800616">(Dec 04 2019 at 21:36)</a>:</h4>
<p>Hmm, yeah, that instruction should be adjusted I think</p>



<a name="800617"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800617" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800617">(Dec 04 2019 at 21:37)</a>:</h4>
<p>any other secret trap I should know?</p>



<a name="800618"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800618" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800618">(Dec 04 2019 at 21:41)</a>:</h4>
<p>Not any I'm aware of</p>



<a name="800624"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800624" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800624">(Dec 04 2019 at 22:02)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> OK. I think it is working correctly.</p>



<a name="800625"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800625" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800625">(Dec 04 2019 at 22:02)</a>:</h4>
<p>What a journey.</p>



<a name="800626"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800626" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800626">(Dec 04 2019 at 22:02)</a>:</h4>
<p>Avatars and logos declared in <code>Organization profile</code> not survived the import.</p>



<a name="800628"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800628" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800628">(Dec 04 2019 at 22:05)</a>:</h4>
<p>Yes, that's known... there's an issue open for that.</p>



<a name="800629"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800629" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800629">(Dec 04 2019 at 22:06)</a>:</h4>
<p>Also all links to custom emoji in older messages</p>



<a name="800630"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800630" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800630">(Dec 04 2019 at 22:07)</a>:</h4>
<p>have old realm id in url</p>



<a name="800631"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800631" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800631">(Dec 04 2019 at 22:08)</a>:</h4>
<p>I will make sure that real import will re-use old realm id.</p>



<a name="800633"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800633" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800633">(Dec 04 2019 at 22:28)</a>:</h4>
<p>Eh I forgot about most important part: Thank you for your help :-)</p>



<a name="800883"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800883" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800883">(Dec 07 2019 at 07:57)</a>:</h4>
<p>Well made my migration. Everything not counting analytics survived.</p>



<a name="800884"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800884" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800884">(Dec 07 2019 at 07:57)</a>:</h4>
<p><code>manage.py update_analytics_counts</code> return:</p>



<a name="800885"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800885" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800885">(Dec 07 2019 at 07:57)</a>:</h4>
<div class="codehilite"><pre><span></span>Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/db.py&quot;, line 32, in execute
    return wrapper_execute(self, super().execute, query, vars)
  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/db.py&quot;, line 19, in wrapper_execute
    return action(sql, params)
psycopg2.IntegrityError: duplicate key value violates unique constraint &quot;analytics_usercount_user_id_property_subgrou_0597562a_uniq&quot;
DETAIL:  Key (user_id, property, subgroup, end_time)=(9, messages_sent:is_bot:hour, false, 2015-11-25 11:00:00+00) already exists.
</pre></div>



<a name="800886"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800886" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800886">(Dec 07 2019 at 07:58)</a>:</h4>
<p>stats page don't display anything</p>



<a name="800887"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800887" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800887">(Dec 07 2019 at 07:58)</a>:</h4>
<div class="codehilite"><pre><span></span>2019-12-07 07:56:34.571 WARN [] User from realm  attempted to access /stats, but the computed start time: 2015-11-25 09:25:41.249450+00:00 (creation of realm or installation) is later than the computed end time: 0001-01-01 00:00:00+00:00 (last successful analytics update). Is the analytics cron job running?
</pre></div>



<a name="800929"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800929" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800929">(Dec 07 2019 at 19:24)</a>:</h4>
<p><span class="user-mention" data-user-id="2617">@Paweł Jastrzębski</span> just to be clear, what changes did you make to re-use the realm ID?  Just creating realms until the right ID came up?</p>



<a name="800930"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800930" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800930">(Dec 07 2019 at 19:25)</a>:</h4>
<p>I think I know what the bug analytics bug is; the FillState table (which keeps track of whether analytics data is up to date) wasn't transferred properly.</p>



<a name="800932"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800932" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800932">(Dec 07 2019 at 19:26)</a>:</h4>
<p>It should be possible to fix your analytics situation by just creating the right <code>FillState</code> records.</p>



<a name="800933"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800933" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800933">(Dec 07 2019 at 19:26)</a>:</h4>
<p>It's a bit tricky to define what "transferred properly" would mean importing into a server hosting other realms, but in the case where one's going from a server hosting a single realm to another one just wants to transfer the whole table.</p>



<a name="800934"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800934" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800934">(Dec 07 2019 at 19:27)</a>:</h4>
<p>Thanks for the report.  Are you up for potentially redoing the import?  If so I can put together a quick patch that should handle transferring <code>FillState</code></p>



<a name="800935"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800935" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800935">(Dec 07 2019 at 19:45)</a>:</h4>
<p>I opened <a href="https://github.com/zulip/zulip/issues/13486" target="_blank" title="https://github.com/zulip/zulip/issues/13486">https://github.com/zulip/zulip/issues/13486</a> to track fixing that issue properly.</p>



<a name="800936"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800936" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800936">(Dec 07 2019 at 19:46)</a>:</h4>
<p>(The organization avatar import issue is <a href="https://github.com/zulip/zulip/issues/11216" target="_blank" title="https://github.com/zulip/zulip/issues/11216">https://github.com/zulip/zulip/issues/11216</a>)</p>



<a name="800937"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800937" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800937">(Dec 07 2019 at 19:46)</a>:</h4>
<p><span class="user-mention" data-user-id="52">@Vishnu Ks</span> if you have time, these could be good projects for you.</p>



<a name="800938"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800938" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800938">(Dec 07 2019 at 19:49)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I dropped entire database and recreated it from scratch. So internal realm now have id 1 and imported 2 as in the old insance.</p>



<a name="800939"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800939" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800939">(Dec 07 2019 at 19:50)</a>:</h4>
<p>No. Another import is a no-go.</p>



<a name="800940"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800940" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800940">(Dec 07 2019 at 19:50)</a>:</h4>
<p>New instance is already in use.</p>



<a name="800941"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800941" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800941">(Dec 07 2019 at 19:59)</a>:</h4>
<p>So I can't fix it without another re-import?</p>



<a name="800942"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800942" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800942">(Dec 07 2019 at 20:01)</a>:</h4>
<p>I still can start old server and transplant raw SQL if needed/if possible.</p>



<a name="800943"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800943" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800943">(Dec 07 2019 at 20:07)</a>:</h4>
<p>huh also</p>



<a name="800944"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800944" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800944">(Dec 07 2019 at 20:07)</a>:</h4>
<p>old messages that highlighted me look like this:</p>



<a name="800945"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800945" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800945">(Dec 07 2019 at 20:07)</a>:</h4>
<p><a href="/user_uploads/2/7a/Fj6BJNWOi-iYAJf6AyieZb8h/pasted_image.png" target="_blank" title="pasted_image.png">pasted image</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/7a/Fj6BJNWOi-iYAJf6AyieZb8h/pasted_image.png" target="_blank" title="pasted image"><img src="/user_uploads/2/7a/Fj6BJNWOi-iYAJf6AyieZb8h/pasted_image.png"></a></div>



<a name="800946"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800946" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800946">(Dec 07 2019 at 20:08)</a>:</h4>
<p>New ones are OK.</p>



<a name="800947"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800947" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800947">(Dec 07 2019 at 20:08)</a>:</h4>
<p>What a humiliation... My own IT infrastructure consider me a bot :-D</p>



<a name="800948"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800948" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800948">(Dec 07 2019 at 20:09)</a>:</h4>
<p>Generally I feel there was no many people who did this process for so old instance.</p>



<a name="800949"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800949" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800949">(Dec 07 2019 at 20:18)</a>:</h4>
<p>It affects 2-3 first users in "normal" realm. Educated guess - it pulled data from crossrealm bots.</p>



<a name="800950"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800950" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800950">(Dec 07 2019 at 20:26)</a>:</h4>
<p>Yeah. It affects two first users from "normal" realm.</p>



<a name="800951"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800951" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800951">(Dec 07 2019 at 20:29)</a>:</h4>
<p>Unrelated question: Is <code>reminder-bot@zulip.com</code> is still used?</p>



<a name="800952"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800952" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800952">(Dec 07 2019 at 20:29)</a>:</h4>
<p>Because I see it on normal bot list for my realm.</p>



<a name="800954"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800954" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800954">(Dec 07 2019 at 20:47)</a>:</h4>
<p>Made quick dive in <code>zerver_message</code></p>



<a name="800955"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800955" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800955">(Dec 07 2019 at 20:47)</a>:</h4>
<p><code>content</code> and <code>rendered_content</code> contain proper tag</p>



<a name="800956"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800956" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800956">(Dec 07 2019 at 20:48)</a>:</h4>
<p><code>data-user-id=</code> in <code>rendered_content</code> is wrong</p>



<a name="800957"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800957" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800957">(Dec 07 2019 at 20:49)</a>:</h4>
<p>it is shifted by 2 for two users</p>



<a name="800958"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800958" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800958">(Dec 07 2019 at 20:52)</a>:</h4>
<p>Nope. I'm wrong. I think everybody is shifted.</p>



<a name="800959"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800959" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800959">(Dec 07 2019 at 20:53)</a>:</h4>
<p>That is bad.</p>



<a name="800960"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800960" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800960">(Dec 07 2019 at 20:58)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Every <code>data-user-id</code> in all <code>rendered_content</code> fields in <code>zerver_message</code> table is shifted.</p>



<a name="800961"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800961" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800961">(Dec 07 2019 at 20:58)</a>:</h4>
<p>That's part 1 in the issue <a href="https://github.com/zulip/zulip/issues/11293" target="_blank" title="https://github.com/zulip/zulip/issues/11293">https://github.com/zulip/zulip/issues/11293</a> and should be fixed, but I believe the fix is not included in 2.0.7. Will be in 2.1. Let me check to make sure</p>



<a name="800962"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800962" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800962">(Dec 07 2019 at 20:59)</a>:</h4>
<p>Profile name in tag is correct. But data-user-id is wrong.</p>



<a name="800963"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800963" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800963">(Dec 07 2019 at 21:02)</a>:</h4>
<p><span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> OK. And it will be fixed backwards?</p>



<a name="800964"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800964" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800964">(Dec 07 2019 at 21:05)</a>:</h4>
<p>I checked, yeah, it's not in 2.0.x, it's scheduled for 2.1. I believe it'll be fixed for new imports, it won't correct what's already imported.</p>



<a name="800965"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800965" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800965">(Dec 07 2019 at 21:05)</a>:</h4>
<p>Well then I'm fucked.</p>



<a name="800967"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800967" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800967">(Dec 07 2019 at 21:07)</a>:</h4>
<p>Import/Export documentation definitely require KNOWN ISSUES section.</p>



<a name="800968"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800968" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800968">(Dec 07 2019 at 21:08)</a>:</h4>
<p>If I would know in how bad state this mechanism is I would never tried to migrate this instance.</p>



<a name="800970"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800970" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800970">(Dec 07 2019 at 21:13)</a>:</h4>
<p>I also see that <code>span</code> no longer have <code>data-user-email</code> so I can't use it to fix it.</p>



<a name="800971"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/800971" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#800971">(Dec 07 2019 at 21:14)</a>:</h4>
<p>Can I even edit <code>rendered_content</code> in bulk? Or it will break something else.</p>



<a name="801072"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801072" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801072">(Dec 09 2019 at 06:16)</a>:</h4>
<p>Additionally I have multiple reports that import marked all messages as unread.</p>



<a name="801073"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801073" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801073">(Dec 09 2019 at 07:08)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span>  So, to sum up:</p>
<ul>
<li>Analytic import step don't parse JSON in batches and that can cause OOM errors.</li>
<li>Even then analytic import is broken due to missing information in export dump.</li>
<li>If new realmid is other that old then custom emoji links in old messages are broken.</li>
<li>Documentation missing information that reusing secrets from old instance require reinitialization of rabbitmq.</li>
<li>Realm logos (and realm name) are not part of export dump.</li>
<li>Import breaks all highlights in old messages.</li>
<li>For some users process reset status of read messages.</li>
<li>Memcached errors during import IMHO require some investigation.</li>
<li>Export don't work at all if old ream used custom <code>EMAIL_GATEWAY_BOT</code> but that was our fault and I don't think that is an error.</li>
</ul>



<a name="801074"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801074" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801074">(Dec 09 2019 at 07:09)</a>:</h4>
<p>Generally in my opinion documentation should be updated to clearly mark that Import/Export mechanism is not production ready.</p>



<a name="801075"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801075" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801075">(Dec 09 2019 at 07:11)</a>:</h4>
<p>Because this process corrupted my 4 year old realm and I probably can't make a rollback.</p>



<a name="801076"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801076" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801076">(Dec 09 2019 at 07:14)</a>:</h4>
<p>So i have two follow up questions:</p>
<ol>
<li>How I can fix my analytic module and if I can't how to nuke it so it start to collect data from scratch?</li>
<li>How to fix old highlights?</li>
</ol>



<a name="801077"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801077" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801077">(Dec 09 2019 at 07:15)</a>:</h4>
<p>Generally I blame mostly myself I not tested instance more during week when I prepared everything for this migration. But at the same time some of these problems were known (<a href="https://github.com/zulip/zulip/pull/11293" target="_blank" title="https://github.com/zulip/zulip/pull/11293">#11293</a> have almost year...) and yet there was no mention about them in documentation.</p>



<a name="801078"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801078" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801078">(Dec 09 2019 at 07:17)</a>:</h4>
<p>Also it would be nice to have manage.py command to set all messages read realm-wide.</p>



<a name="801091"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801091" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801091">(Dec 09 2019 at 11:22)</a>:</h4>
<p>Sigh. People receive notifications from not their conversations.</p>



<a name="801092"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801092" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801092">(Dec 09 2019 at 11:23)</a>:</h4>
<p>I going to make emergency rollback.</p>



<a name="801095"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801095" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801095">(Dec 09 2019 at 11:39)</a>:</h4>
<p>I have users who receive mobile notifications not from their accounts...</p>



<a name="801096"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801096" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801096">(Dec 09 2019 at 11:39)</a>:</h4>
<p>How the hell is even possible?</p>



<a name="801100"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801100" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801100">(Dec 09 2019 at 11:47)</a>:</h4>
<p>This is complete disaster.</p>



<a name="801102"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801102" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801102">(Dec 09 2019 at 11:55)</a>:</h4>
<p>There is something wrong with avatars too.</p>



<a name="801103"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801103" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801103">(Dec 09 2019 at 11:56)</a>:</h4>
<p>Some people see somebody else avatar as their own.</p>



<a name="801104"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801104" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801104">(Dec 09 2019 at 11:56)</a>:</h4>
<p>But only them - rest see it correctly.</p>



<a name="801106"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801106" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801106">(Dec 09 2019 at 11:56)</a>:</h4>
<p>And it is not client side cache issue.</p>



<a name="801114"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801114" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801114">(Dec 09 2019 at 13:13)</a>:</h4>
<p><code>bankrupt_users</code> is a command i was looking for</p>



<a name="801255"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801255" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801255">(Dec 10 2019 at 01:06)</a>:</h4>
<p><span class="user-mention" data-user-id="2617">@Paweł Jastrzębski</span> sorry for the trouble, and thanks for all the reports.  I don't believe other folks have experienced similar issues doing this process, so I'm wondering what the difference is.  Can you talk about what versions the two servers were running and any details about differences in the set of realms hosted on the two servers?</p>



<a name="801261"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801261" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801261">(Dec 10 2019 at 01:36)</a>:</h4>
<p>Just making sure we have all of these tracked:</p>
<blockquote>
<p>Analytic import step don't parse JSON in batches and that can cause OOM errors.</p>
</blockquote>
<p><span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> can you submit a PR for this since it looks like you already investigated and written a patch earlier in this thread?  <a href="#narrow/stream/31-production-help/topic/Realm.20import/near/800592" title="#narrow/stream/31-production-help/topic/Realm.20import/near/800592">https://chat.zulip.org/#narrow/stream/31-production-help/topic/Realm.20import/near/800592</a>.</p>
<blockquote>
<p>Memcached errors during import IMHO require some investigation.</p>
</blockquote>
<p>Likely caused by the system being under RAM pressure.  I've updated our recommend to suggest shutting down the Zulip server while one does an import if the system has limited free RAM: <a href="https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34" target="_blank" title="https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34">79604c781742ed9ddafd995d213bf80040900c34</a>.</p>
<blockquote>
<p>Even then analytic import is broken due to missing information in export dump.  </p>
</blockquote>
<p>This is <a href="https://github.com/zulip/zulip/issues/13486" target="_blank" title="https://github.com/zulip/zulip/issues/13486">https://github.com/zulip/zulip/issues/13486</a>.  Probably you'll get a decent result if you just skip importing the analytics data (it can be rebuilt from other tables).  Deleting via  <code>RealmCount.objects.all.delete()</code> and similarly for <code>UserCount</code> and <code>StreamCount</code> is likely to be an effective immediate workaround, as then it'll just regenerate the data from scratch.  But once <a href="https://github.com/zulip/zulip/pull/13486" target="_blank" title="https://github.com/zulip/zulip/pull/13486">#13486</a> is done we will have a cleaner fix that I would recommend if you're not in a hurry.</p>
<blockquote>
<p>If new realmid is other that old then custom emoji links in old messages are broken.</p>
</blockquote>
<p><span class="user-mention" data-user-id="52">@Vishnu Ks</span> I think this is an issue very similar to <a href="https://github.com/zulip/zulip/commit/ce1d6044db446673fc86795028918c415c4d160f" target="_blank" title="https://github.com/zulip/zulip/commit/ce1d6044db446673fc86795028918c415c4d160f">ce1d6044db446673fc86795028918c415c4d160f</a>; would you be up for taking this up?  I don't have time to open an issue for this right now but it should be straightforward given what we've already implemented.</p>
<blockquote>
<p>Documentation missing information that reusing secrets from old instance require reinitialization of rabbitmq.</p>
</blockquote>
<p>Fixed in <a href="https://github.com/zulip/zulip/commit/6ca56f81f225c53c0eb6108007b0bcdd08fdf461" target="_blank" title="https://github.com/zulip/zulip/commit/6ca56f81f225c53c0eb6108007b0bcdd08fdf461">6ca56f81f225c53c0eb6108007b0bcdd08fdf461</a>.</p>
<blockquote>
<p>Realm logos (and realm name) are not part of export dump.</p>
</blockquote>
<p>This is <a href="https://github.com/zulip/zulip/issues/11216" target="_blank" title="https://github.com/zulip/zulip/issues/11216">https://github.com/zulip/zulip/issues/11216</a>.  I don't consider it to be a high priority because it's easy to fix manually, but it'd be nice to do it right for visual polish reasons.  I think it's on <span class="user-mention" data-user-id="52">@Vishnu Ks</span>'s TODO list.</p>
<blockquote>
<p>Import breaks all highlights in old messages.</p>
</blockquote>
<p>This was fixed in master months ago, and the fix is present in Zulip 2.1-rc1.  I suppose we should have suggested upgrading to the release candidate first if we'd thought of this.  </p>
<blockquote>
<p>For some users process reset status of read messages.</p>
</blockquote>
<p>Can you provide details on this?  I don't understand a mechanism for how that would happen, given that we just preserve the flags from before the import in the migration...</p>
<blockquote>
<p>Export don't work at all if old ream used custom <code>EMAIL_GATEWAY_BOT</code> but that was our fault and I don't think that is an error.</p>
</blockquote>
<p>Yeah, that's not a recommended configuration or one that we still document, but I still consider it a bug.  Opened <a href="https://github.com/zulip/zulip/pull/13496" target="_blank" title="https://github.com/zulip/zulip/pull/13496">#13496</a> since I think the fix is likely simple.</p>
<blockquote>
<p>There is something wrong with avatars too.</p>
</blockquote>
<p>We fixed an issue with avatars and the S3 file upload backend in the import process in master a few months ago, so this is likely already fixed for Zulip 2.1-rc1.  Are you using that backend?  It's also possible you're seeing a browser caching issue if you're using the same hostname for your new server (since you'd have different avatars at the same filename?).</p>
<blockquote>
<p>I have users who receive mobile notifications not from their accounts...</p>
</blockquote>
<p>Yuck, thanks for reporting this!  I think I know exactly why this happened; it is an unintended consequence of copying over <code>zulip-secrets.conf</code> with users' IDs being renumbered; the protocol with the push notification bouncer server identifies whose devices to push to via <code>(zulip_org_id, user_id)</code> pairs, and by copying that file, you'll end up with the <code>zulip_org_id</code> (and its corresponding secret) being preserved with the <code>user_id</code> values being scrambled.  This is fixable in the short term by clearing push notifications bouncer state; simplest is to just delete the <code>zulip_org_*</code> settings in <code>zulip-secrets.conf</code> and re-register for push notifications.  And I'll update the documentation to warn about this issue.</p>



<a name="801269"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801269" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801269">(Dec 10 2019 at 01:58)</a>:</h4>
<p>I merged <a href="https://github.com/zulip/zulip/commit/c6fe6cf0a47cd61c0005aa099b9f7fa16d96f603" target="_blank" title="https://github.com/zulip/zulip/commit/c6fe6cf0a47cd61c0005aa099b9f7fa16d96f603">c6fe6cf0a47cd61c0005aa099b9f7fa16d96f603</a> to address the bundle of issues caused by copying <code>zulip-secrets.conf</code>.   I think that recommend was more or less wrong, having been incorrectly copied from the backups situation (where it was correct).</p>



<a name="801270"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801270" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801270">(Dec 10 2019 at 01:59)</a>:</h4>
<p><span class="user-mention" data-user-id="2617">@Paweł Jastrzębski</span> out of curiousity, why didn't you use the backups system for this migration?  We recommend it pretty strongly for most use cases (including most any where copying secrets might be relevant).  </p>
<p>In any case, thanks again for all of these reports.  While some of them are already fixed for our next release, others are not.</p>



<a name="801296"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801296" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801296">(Dec 10 2019 at 06:22)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Both instances were using 2.0.7. But old one was really old. ~2m messages, 400 users, Ubuntu 14.04 and that was Zulip updated release after release starting from 2015-11-25.</p>



<a name="801297"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801297" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801297">(Dec 10 2019 at 06:23)</a>:</h4>
<p>I used full import/export procedure as new server had newer psql. Now I know that I should make copy of old VM update system there to align psql versions and use normal backup mechanism.</p>



<a name="801298"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801298" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801298">(Dec 10 2019 at 06:25)</a>:</h4>
<p>That lesson cost me 3 days of production data :-P</p>



<a name="801299"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801299" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801299">(Dec 10 2019 at 06:27)</a>:</h4>
<blockquote>
<p>Likely caused by the system being under RAM pressure. I've updated our recommend to suggest shutting down the Zulip server while one does an import if the system has limited free RAM: <a href="https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34" target="_blank" title="https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34">79604c781742ed9ddafd995d213bf80040900c34</a>.</p>
</blockquote>
<p>During import process new machine had ~15gb of free ram. I didn't keep full stack but all of them were MemcachedError error 15 and 21</p>



<a name="801300"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801300" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801300">(Dec 10 2019 at 06:29)</a>:</h4>
<blockquote>
<p>Can you provide details on this? I don't understand a mechanism for how that would happen, given that we just preserve the flags from before the import in the migration...</p>
</blockquote>
<p>Sadly I can't. As I not replicated this issue. Few users after login in to new instance had all messages from X years marked as unread.</p>



<a name="801301"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801301" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801301">(Dec 10 2019 at 06:31)</a>:</h4>
<p>I was wrong about avatar issue. It was browser cache issue. Still only ~10% of users were affected.</p>



<a name="801302"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801302" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801302">(Dec 10 2019 at 06:37)</a>:</h4>
<p>So to confirm. If I use normal backup and restore it on different machine I don't need to reset mobile notification secrets?</p>



<a name="801306"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801306" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801306">(Dec 10 2019 at 06:58)</a>:</h4>
<blockquote>
<p>So to confirm. If I use normal backup and restore it on different machine I don't need to reset mobile notification secrets?</p>
</blockquote>
<p><span class="user-mention" data-user-id="2617">@Paweł Jastrzębski</span> well, that would have been correct if we'd done that in the first place; I think at this point it's likely that you will need to reset the mobile notification secrets after getting the rest of the state how you want it, because some devices could have registered for push notifications with the "new" user IDs over the last 3 days.</p>



<a name="801307"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801307" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801307">(Dec 10 2019 at 07:00)</a>:</h4>
<blockquote>
<blockquote>
<p>Likely caused by the system being under RAM pressure. I've updated our recommend to suggest shutting down the Zulip server while one does an import if the system has limited free RAM: <a href="https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34" target="_blank" title="https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34">79604c781742ed9ddafd995d213bf80040900c34</a>.</p>
</blockquote>
<p>During import process new machine had ~15gb of free ram. I didn't keep full stack but all of them were MemcachedError error 15 and 21</p>
</blockquote>
<p>OK, that should have been plenty of RAM; which suggests the issue is likely some sort of actual bug.  If you do see the stack traces again, I'd appreciate your posting them here.  We've migrated organizations with 2M+ messages before with this process, but not a long of them.</p>



<a name="801308"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801308" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801308">(Dec 10 2019 at 07:00)</a>:</h4>
<p>I don't have any plans to touch this import/export mechanism again. Ever :-P</p>



<a name="801309"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801309" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801309">(Dec 10 2019 at 07:03)</a>:</h4>
<blockquote>
<blockquote>
<p>Can you provide details on this? I don't understand a mechanism for how that would happen, given that we just preserve the flags from before the import in the migration...</p>
</blockquote>
<p>Sadly I can't. As I not replicated this issue. Few users after login in to new instance had all messages from X years marked as unread.</p>
</blockquote>
<p>So, I'm guessing the cause here is actually that those messages had never been marked as read.  We had some bugs in older Zulip releases that could result in unread messages being leaked (basically lost in the scrollback if the user never read that stream, for example) where it'd be hard to find them and mark them as read.  And a detail in how the import process sets the place one lands when loading the app after the import process is that it'll take them to the oldest (unmuted) unread message, causing those ancient unread messages to become "relevant" again.  Zulip 2.1 reworks the system in a way that should help users do a 1-time clear of those old unread messages, ending up in a reasonable state.</p>



<a name="801310"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801310" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801310">(Dec 10 2019 at 07:04)</a>:</h4>
<p>So I should now remove mobile keys from old instance that is now running. Run registration again and to be sure nuke all sessions?</p>



<a name="801311"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801311" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801311">(Dec 10 2019 at 07:06)</a>:</h4>
<p>(deleted)</p>



<a name="801312"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801312" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801312">(Dec 10 2019 at 07:06)</a>:</h4>
<p>For mobile keys, yes I'd remove the mobile keys and re-register on the restored server to avoid further push notifications delivery issues.</p>



<a name="801314"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801314" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801314">(Dec 10 2019 at 07:07)</a>:</h4>
<p>OK. I will do this immediately.</p>



<a name="801315"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801315" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801315">(Dec 10 2019 at 07:19)</a>:</h4>
<p>Well done that and now I can't login to mobile client at all.</p>



<a name="801316"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801316" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801316">(Dec 10 2019 at 07:19)</a>:</h4>
<p>It is stuck on google account selection.</p>



<a name="801317"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801317" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801317">(Dec 10 2019 at 07:20)</a>:</h4>
<p>web client is working correctly</p>



<a name="801318"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801318" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801318">(Dec 10 2019 at 07:20)</a>:</h4>
<p>OK. I'm in. Login process was just loooong.</p>



<a name="801320"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801320" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801320">(Dec 10 2019 at 07:26)</a>:</h4>
<div class="codehilite"><pre><span></span>./manage.py register_server --rotate-key
./scripts/restart-server
./manage.py logout_all_users
</pre></div>


<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I presume that should be enough?</p>



<a name="801348"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801348" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801348">(Dec 10 2019 at 10:47)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Well this process broken something.</p>



<a name="801349"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801349" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801349">(Dec 10 2019 at 10:47)</a>:</h4>
<p>Login on Android over Google OAuth now timeout.</p>



<a name="801350"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801350" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801350">(Dec 10 2019 at 10:48)</a>:</h4>
<div class="codehilite"><pre><span></span>2019-12-10 10:48:37.540 WARN [] User error converting Google oauth2 login to token: {
  &quot;error&quot;: &quot;invalid_grant&quot;,
  &quot;error_description&quot;: &quot;Bad Request&quot;
}
</pre></div>



<a name="801351"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801351" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801351">(Dec 10 2019 at 10:49)</a>:</h4>
<p>web login is not affected</p>



<a name="801353"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801353" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801353">(Dec 10 2019 at 10:51)</a>:</h4>
<p>After few attempts login is successful.</p>



<a name="801364"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801364" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801364">(Dec 10 2019 at 14:51)</a>:</h4>
<p>Whatever it was - it stopped.</p>



<a name="801376"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801376" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801376">(Dec 10 2019 at 17:06)</a>:</h4>
<p><span class="user-mention" data-user-id="2617">@Paweł Jastrzębski</span> I think <code>register_server --rotate-key</code> isn't sufficient -- that just rotates the secret/password, not removes the identity.</p>



<a name="801378"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801378" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801378">(Dec 10 2019 at 17:11)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  So how do that properly?</p>



<a name="801383"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801383" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801383">(Dec 10 2019 at 17:17)</a>:</h4>
<p>Just delete the <code>zulip_org_*</code> entries from <code>zulip-secrets.conf</code> and do <code>manage.py register_server</code>.</p>



<a name="801385"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801385" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801385">(Dec 10 2019 at 17:17)</a>:</h4>
<p>That was my first guess but: <a href="https://github.com/zulip/zulip/blob/master/zerver/management/commands/register_server.py#L37" target="_blank" title="https://github.com/zulip/zulip/blob/master/zerver/management/commands/register_server.py#L37">https://github.com/zulip/zulip/blob/master/zerver/management/commands/register_server.py#L37</a></p>



<a name="801387"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801387" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801387">(Dec 10 2019 at 17:18)</a>:</h4>
<p><code>register_server</code> expect them to be already set</p>



<a name="801390"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801390" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801390">(Dec 10 2019 at 17:19)</a>:</h4>
<p>i will just regenerate them manually using snippets from <code>generate_secrets.py</code></p>



<a name="801395"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801395" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801395">(Dec 10 2019 at 17:23)</a>:</h4>
<p>yep that worked</p>



<a name="801398"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801398" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801398">(Dec 10 2019 at 17:26)</a>:</h4>
<p>And mobile login issue is back.</p>



<a name="801399"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801399" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801399">(Dec 10 2019 at 17:27)</a>:</h4>
<p>I need 3 minutes to log the mobile client.</p>



<a name="801401"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801401" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801401">(Dec 10 2019 at 17:28)</a>:</h4>
<p>But hopefully push notifications are now intact.</p>



<a name="801403"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801403" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801403">(Dec 10 2019 at 17:33)</a>:</h4>
<p>Well thank you very much for help <span class="user-mention" data-user-id="7">@Tim Abbott</span>. Hopefully everything is working now and I can attempt to find will to retry migration process using "normal" backups.</p>



<a name="801404"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801404" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801404">(Dec 10 2019 at 17:33)</a>:</h4>
<p>But I doubt I will have any maintenance window this month.</p>



<a name="801405"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801405" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801405">(Dec 10 2019 at 17:37)</a>:</h4>
<p>That android login look like auth endpoint on zulip side is timeouting and return nothing. After that timeout client refresh and everything start to work.</p>



<a name="801407"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801407" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801407">(Dec 10 2019 at 17:39)</a>:</h4>
<p>hm</p>



<a name="801408"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/801408" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#801408">(Dec 10 2019 at 17:39)</a>:</h4>
<p><a href="https://github.com/zulip/zulip-mobile/issues/3708" target="_blank" title="https://github.com/zulip/zulip-mobile/issues/3708">https://github.com/zulip/zulip-mobile/issues/3708</a></p>



<a name="851258"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851258" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851258">(Apr 10 2020 at 18:40)</a>:</h4>
<p>So just small update. After few months we finished that move to new server.</p>



<a name="851259"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851259" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851259">(Apr 10 2020 at 18:40)</a>:</h4>
<p>We synced Zulip version on old and new server and used normal backup mechanic.</p>



<a name="851260"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851260" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851260">(Apr 10 2020 at 18:41)</a>:</h4>
<p>Only problem we found is a fact that old database used <code>tsearch-extras</code></p>



<a name="851261"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851261" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851261">(Apr 10 2020 at 18:42)</a>:</h4>
<p>And new server was missing that extension - as expected.</p>



<a name="851264"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851264" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851264">(Apr 10 2020 at 18:44)</a>:</h4>
<p>So until I manually installed <code>postgresql-10-tsearch-extras_0.4bionic2_amd64.deb</code> import was failing.</p>



<a name="851265"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851265" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851265">(Apr 10 2020 at 18:45)</a>:</h4>
<p>Yeah, this is a known bug.  It's somewhat difficult to script removing the <code>tsearch_extras</code> extension from the database because it requires root acces to do so.</p>



<a name="851266"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851266" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851266">(Apr 10 2020 at 18:45)</a>:</h4>
<p>I suppose we should at least document the fix for this, since the manual fix is easy.</p>



<a name="851267"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851267" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851267">(Apr 10 2020 at 18:46)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/issues/13612" title="https://github.com/zulip/zulip/issues/13612">https://github.com/zulip/zulip/issues/13612</a></p>



<a name="851274"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851274" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851274">(Apr 10 2020 at 18:58)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="851277"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851277" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paweł Jastrzębski <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851277">(Apr 10 2020 at 19:00)</a>:</h4>
<p>So I can safely drop extension on new server?</p>



<a name="851294"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Realm%20import/near/851294" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Realm.20import.html#851294">(Apr 10 2020 at 19:15)</a>:</h4>
<p>Yep!</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>