<html>
<head><meta charset="utf-8"><title>Upgrade 1.3.10 -&gt; 1.6.0 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html">Upgrade 1.3.10 -&gt; 1.6.0</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="228365"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/228365" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#228365">(Jun 15 2017 at 15:03)</a>:</h4>
<p>Hello, We are using the amazing Zulip software in production for a while.<br>
I can see you are working a lot and we want to upgrade from a old version 1.3.10.<br>
Is there  any secure procedure?</p>



<a name="228472"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/228472" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#228472">(Jun 15 2017 at 16:06)</a>:</h4>
<p><span class="user-mention" data-user-email="eherraiz@apsl.net" data-user-id="2669">@Edu Herraiz</span> the documented upgrade process at <a href="http://zulip.readthedocs.io/en/latest/prod-maintain-secure-upgrade.html#upgrading" target="_blank" title="http://zulip.readthedocs.io/en/latest/prod-maintain-secure-upgrade.html#upgrading">http://zulip.readthedocs.io/en/latest/prod-maintain-secure-upgrade.html#upgrading</a> is secure.  I'd probably recommend given that you're starting with such an old version, that you do 1.4, then 1.5, then 1.6, rather than upgrading the whole way at once.   Each of those 3 major releases has release notes on the <code>zulip-announce</code> archives that you read for any notes / important information you might want before upgrading.</p>



<a name="229546"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/229546" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#229546">(Jun 16 2017 at 07:08)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> Thank you!</p>



<a name="229819"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/229819" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#229819">(Jun 16 2017 at 15:51)</a>:</h4>
<p>I have problems applying some migrations in zerver app:</p>
<div class="codehilite"><pre><span></span>  Applying zerver.0041_create_attachments_for_old_messages...Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 29, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 367, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 359, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 294, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 345, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/core/management/commands/migrate.py&quot;, line 204, in handle
    fake_initial=fake_initial,
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 115, in migrate
    state = self._migrate_all_forwards(state, plan, full_plan, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 145, in _migrate_all_forwards
    state = self.apply_migration(state, migration, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 244, in apply_migration
    state = migration.apply(state, schema_editor)
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/db/migrations/migration.py&quot;, line 129, in apply
    operation.database_forwards(self.app_label, schema_editor, old_state, project_state)
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zulip-venv/lib/python2.7/site-packages/django/db/migrations/operations/special.py&quot;, line 189, in database_forwards
    self.code(from_state.apps, schema_editor)
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/zerver/migrations/0041_create_attachments_for_old_messages.py&quot;, line 28, in check_and_create_attachments
    is_message_realm_public = not stream.invite_only and not stream.realm.is_zephyr_mirror_realm
AttributeError: &#39;Realm&#39; object has no attribute &#39;is_zephyr_mirror_realm&#39;
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2017-06-16-17-48-38/scripts/lib/upgrade-zulip-stage-2&quot;, line 122, in &lt;module&gt;
    subprocess.check_call([&quot;./manage.py&quot;, &quot;migrate&quot;, &quot;--noinput&quot;], preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;migrate&#39;, &#39;--noinput&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 53, in &lt;module&gt;
    subprocess.check_call([os.path.abspath(&quot;./scripts/lib/upgrade-zulip-stage-2&quot;), deploy_path])
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2017-06-16-17-48-38/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2017-06-16-17-48-38&#39;]&#39; returned non-zero exit status 1
</pre></div>



<a name="229825"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/229825" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#229825">(Jun 16 2017 at 16:00)</a>:</h4>
<p>Can you do this:</p>
<div class="codehilite"><pre><span></span>grep is_zephyr /home/zulip/deployments/2017-06-16-17-48-38/zerver/models.py
</pre></div>



<a name="230074"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/230074" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#230074">(Jun 16 2017 at 18:09)</a>:</h4>
<p>I haven't seen that exception before, but I think that you can just replace <code>stream.realm.is_zephyr_mirror_realm</code> with <code>False</code> and rerun the migration</p>



<a name="233239"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233239" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233239">(Jun 21 2017 at 14:47)</a>:</h4>
<p><span class="user-mention" data-user-email="showell@zulipchat.com" data-user-id="58">@Steve Howell</span></p>
<div class="codehilite"><pre><span></span>root@vater16:~# grep is_zephyr /home/zulip/deployments/2017-06-16-17-48-38/zerver/models.py
    def is_zephyr_mirror_realm(self):
        return self.is_zephyr_mirror_realm
        return self.is_zephyr_mirror_realm
        return not self.invite_only and not self.realm.is_zephyr_mirror_realm
</pre></div>



<a name="233240"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233240" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233240">(Jun 21 2017 at 14:47)</a>:</h4>
<p><span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> Let me see...</p>



<a name="233245"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233245" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233245">(Jun 21 2017 at 14:54)</a>:</h4>
<p><span class="user-mention" data-user-email="eherraiz@apsl.net" data-user-id="2669">@Edu Herraiz</span> Thanks!  That is a strange...it seems like the attribute is right there in the code.</p>



<a name="233252"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233252" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233252">(Jun 21 2017 at 14:56)</a>:</h4>
<p>I tried with the <span class="user-mention" data-user-email="tabbott@zulipchat.com" data-user-id="7">@Tim Abbott</span> indications, but...:</p>
<div class="codehilite"><pre><span></span>2017-06-21 16:54:43,219 upgrade-zulip-stage-2: Applying database migrations...
Operations to perform:
  Apply all migrations: analytics, auth, confirmation, contenttypes, guardian, sessions, sites, social_django, zerver
Running migrations:
  Applying zerver.0041_create_attachments_for_old_messages...Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 29, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 367, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 359, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 294, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 345, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/core/management/commands/migrate.py&quot;, line 204, in handle
    fake_initial=fake_initial,
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 115, in migrate
    state = self._migrate_all_forwards(state, plan, full_plan, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 145, in _migrate_all_forwards
    state = self.apply_migration(state, migration, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 244, in apply_migration
    state = migration.apply(state, schema_editor)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/migrations/migration.py&quot;, line 129, in apply
    operation.database_forwards(self.app_label, schema_editor, old_state, project_state)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/migrations/operations/special.py&quot;, line 189, in database_forwards
    self.code(from_state.apps, schema_editor)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zerver/migrations/0041_create_attachments_for_old_messages.py&quot;, line 33, in check_and_create_attachments
    realm=user_profile.realm, is_realm_public=is_message_realm_public)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 85, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 399, in create
    obj.save(force_insert=True, using=self.db)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 796, in save
    force_update=force_update, update_fields=update_fields)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 824, in save_base
    updated = self._save_table(raw, cls, force_insert, force_update, using, update_fields)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 908, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/models/base.py&quot;, line 947, in _do_insert
    using=using, raw=raw)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/models/manager.py&quot;, line 85, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1045, in _insert
    return query.get_compiler(using=using).execute_sql(return_id)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 1054, in execute_sql
    cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 94, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zulip-venv/lib/python2.7/site-packages/django/db/backends/utils.py&quot;, line 64, in execute
    return self.cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zerver/lib/db.py&quot;, line 32, in execute
    return wrapper_execute(self, super(TimeTrackingCursor, self).execute, query, vars)
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/zerver/lib/db.py&quot;, line 19, in wrapper_execute
    return action(sql, params)
django.db.utils.DataError: value too long for type character varying(100)

Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2017-06-21-16-54-01/scripts/lib/upgrade-zulip-stage-2&quot;, line 122, in &lt;module&gt;
    subprocess.check_call([&quot;./manage.py&quot;, &quot;migrate&quot;, &quot;--noinput&quot;], preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;migrate&#39;, &#39;--noinput&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 53, in &lt;module&gt;
    subprocess.check_call([os.path.abspath(&quot;./scripts/lib/upgrade-zulip-stage-2&quot;), deploy_path])
  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call
    raise CalledProcessError(retcode, cmd)
</pre></div>



<a name="233253"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233253" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233253">(Jun 21 2017 at 14:59)</a>:</h4>
<p>Well, that's progress, because the new error is something we know about. :) and :(</p>



<a name="233254"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233254" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233254">(Jun 21 2017 at 15:00)</a>:</h4>
<p>:-D Nice! There is any solution we can apply?</p>



<a name="233255"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233255" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233255">(Jun 21 2017 at 15:01)</a>:</h4>
<p>I forget the exact details from the last time I helped somebody fix this, but essentially there's a really long filename or something.</p>



<a name="233256"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233256" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233256">(Jun 21 2017 at 15:03)</a>:</h4>
<p>I am starting to wonder if it makes sense to stagger your upgrade a bit to deal with these migration nuisances.</p>



<a name="233257"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233257" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233257">(Jun 21 2017 at 15:11)</a>:</h4>
<p>Let's try this patch:</p>
<div class="codehilite"><pre><span></span><span class="o">-</span>                <span class="n">attachment</span> <span class="o">=</span> <span class="n">Attachment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<span class="o">-</span>                    <span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path_id</span><span class="p">),</span> <span class="n">path_id</span><span class="o">=</span><span class="n">path_id</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="n">user_profile</span><span class="p">,</span>
<span class="o">-</span>                    <span class="n">realm</span><span class="o">=</span><span class="n">user_profile</span><span class="o">.</span><span class="n">realm</span><span class="p">,</span> <span class="n">is_realm_public</span><span class="o">=</span><span class="n">is_message_realm_public</span><span class="p">)</span>
<span class="o">-</span>                <span class="n">attachment</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="o">+</span>                <span class="k">try</span><span class="p">:</span>
<span class="o">+</span>                    <span class="n">attachment</span> <span class="o">=</span> <span class="n">Attachment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<span class="o">+</span>                        <span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path_id</span><span class="p">),</span> <span class="n">path_id</span><span class="o">=</span><span class="n">path_id</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="n">user_profile</span><span class="p">,</span>
<span class="o">+</span>                        <span class="n">realm</span><span class="o">=</span><span class="n">user_profile</span><span class="o">.</span><span class="n">realm</span><span class="p">,</span> <span class="n">is_realm_public</span><span class="o">=</span><span class="n">is_message_realm_public</span><span class="p">)</span>
<span class="o">+</span>                    <span class="n">attachment</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="o">+</span>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="o">+</span>                    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>



<a name="233259"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233259" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233259">(Jun 21 2017 at 15:13)</a>:</h4>
<p>It's pretty harmless if there a few attachments where we don't track them.  This table is mostly used for archiving purposes, and you will probably only orphan a few files.</p>



<a name="233262"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233262" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233262">(Jun 21 2017 at 15:20)</a>:</h4>
<div class="codehilite"><pre><span></span> id |                    file_name                    |                                   path_id                                    |          create_time          | owner_id | is_realm_public | realm_id
----+-------------------------------------------------+------------------------------------------------------------------------------+-------------------------------+----------+-----------------+----------
  1 | Simulator Screen Shot 16 Jun 2017, 11.17.25.png | 2/3f/hFVpLOfw3tA14hOJvFxw76f7/Simulator-Screen-Shot-16-Jun-2017-11.17.25.png | 2017-06-16 09:18:02.596888+00 |       15 | t               |        2
  2 | Screen Shot 2017-06-16 at 11.28.23.png          | 2/e0/8w68yLztx9yPofoEBSFlKv71/Screen-Shot-2017-06-16-at-11.28.23.png         | 2017-06-16 09:28:38.58967+00  |       15 | t               |        2
  3 | Screenshot_20170616-114121.png                  | 2/af/IN2W2wQQqVgPaSf44A_mLIwp/Screenshot_20170616-114121.png                 | 2017-06-16 09:41:30.145345+00 |        7 | t               |        2
  4 | pasted_image.png                                | 2/f9/o7m1PYfzTtZ_34cwdTFDPMWu/pasted_image.png                               | 2017-06-16 09:53:10.162088+00 |        9 | t               |        2
(4 rows)
</pre></div>



<a name="233264"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233264" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233264">(Jun 21 2017 at 15:20)</a>:</h4>
<p>I can't see a attachments with a very large name</p>



<a name="233266"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233266" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233266">(Jun 21 2017 at 15:20)</a>:</h4>
<p>select * from zerver_attachment;</p>



<a name="233274"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233274" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233274">(Jun 21 2017 at 15:24)</a>:</h4>
<p>seems not working the try/except:</p>
<div class="codehilite"><pre><span></span>Running migrations:
  Applying zerver.0041_create_attachments_for_old_messages...value too long for type character varying(100)

Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 29, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 367, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 359, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 294, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 345, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/core/management/commands/migrate.py&quot;, line 204, in handle
    fake_initial=fake_initial,
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 115, in migrate
    state = self._migrate_all_forwards(state, plan, full_plan, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 145, in _migrate_all_forwards
    state = self.apply_migration(state, migration, fake=fake, fake_initial=fake_initial)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 244, in apply_migration
    state = migration.apply(state, schema_editor)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/migrations/migration.py&quot;, line 129, in apply
    operation.database_forwards(self.app_label, schema_editor, old_state, project_state)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/migrations/operations/special.py&quot;, line 189, in database_forwards
    self.code(from_state.apps, schema_editor)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zerver/migrations/0041_create_attachments_for_old_messages.py&quot;, line 24, in check_and_create_attachments
    user_profile = message.sender
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/models/fields/related_descriptors.py&quot;, line 179, in __get__
    rel_obj = qs.get()
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 379, in get
    num = len(clone)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 238, in __len__
    self._fetch_all()
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 1087, in _fetch_all
    self._result_cache = list(self.iterator())
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/models/query.py&quot;, line 54, in __iter__
    results = compiler.execute_sql()
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/models/sql/compiler.py&quot;, line 835, in execute_sql
    cursor.execute(sql, params)
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/backends/utils.py&quot;, line 59, in execute
    self.db.validate_no_broken_transaction()
  File &quot;/home/zulip/deployments/2017-06-21-17-23-36/zulip-venv/lib/python2.7/site-packages/django/db/backends/base/base.py&quot;, line 428, in validate_no_broken_transaction
    &quot;An error occurred in the current transaction. You can&#39;t &quot;
django.db.transaction.TransactionManagementError: An error occurred in the current transaction. You can&#39;t execute queries until the end of the &#39;atomic&#39; block.
</pre></div>



<a name="233284"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233284" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233284">(Jun 21 2017 at 15:34)</a>:</h4>
<p>Ok, I think we're ready for extreme measures.  The whole 0041 migration is pretty much an optional thing until you actually want to do archiving.  So we should just short-circuit all the code by putting <code>return</code> on line 16 at the start of the function.  This should let you get unblocked.  And then we can come back and figure out how to get that table populated later.  I can't make a 100% guarantee this will work, but I'm like 90% sure, since this isn't a structural migration.</p>



<a name="233285"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233285" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233285">(Jun 21 2017 at 15:36)</a>:</h4>
<p>jejeje, Before read your option I was tried with:</p>
<div class="codehilite"><pre><span></span>#            if path_id is not None:
#                try:
#                    attachment = Attachment.objects.create(
#                        file_name=os.path.basename(path_id), path_id=path_id, owner=user_profile,
#                        realm=user_profile.realm, is_realm_public=is_message_realm_public)
#                    attachment.messages.add(message)
#                except Exception as e:
#                    print(e)
</pre></div>



<a name="233286"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233286" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233286">(Jun 21 2017 at 15:36)</a>:</h4>
<p>and the migration is complete. I can see the 1.6.0 version running</p>



<a name="233287"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233287" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233287">(Jun 21 2017 at 15:36)</a>:</h4>
<p>:-D</p>



<a name="233288"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233288" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233288">(Jun 21 2017 at 15:36)</a>:</h4>
<p>Awesome!</p>



<a name="233289"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233289" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233289">(Jun 21 2017 at 15:37)</a>:</h4>
<p>I think I misread your earlier response.</p>



<a name="233290"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233290" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233290">(Jun 21 2017 at 15:38)</a>:</h4>
<p>Amazing support using Zulip!!</p>



<a name="233291"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233291" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233291">(Jun 21 2017 at 15:38)</a>:</h4>
<p>But I'm glad it's working now.</p>



<a name="233292"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233292" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edu Herraiz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233292">(Jun 21 2017 at 15:38)</a>:</h4>
<p>Thanks a lot!</p>



<a name="233293"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%201.3.10%20-%3E%201.6.0/near/233293" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.201.2E3.2E10.20-.3E.201.2E6.2E0.html#233293">(Jun 21 2017 at 15:38)</a>:</h4>
<p>You're more than welcome. :)</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>