<html>
<head><meta charset="utf-8"><title>✔ prod-static =&gt; static ? · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html">✔ prod-static =&gt; static ?</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1331631"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331631" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331631">(Feb 18 2022 at 22:35)</a>:</h4>
<p>I run my deployment close to main-branch, and when I sync'd recently my production deploy died. Tracking it down, the server (1) started looking for static assets in /home/zulip/prod-static and also, (2) prod-static/ now appears as static/ ?  I worked around this with a symlink... I run a substantial fork but which doesn't touch any of this stuff, i.e. no reason for upgrade to have failed.?</p>
<p>hope this helps!</p>
<div class="codehilite"><pre><span></span><code>zulip@zulip-prod:~$ pwd
/home/zulip
zulip@zulip-prod:~$ ls -l
total 452
drwxrwxr-x   2 zulip zulip   4096 Dec 28 01:00 backups
drwxr-xr-x  21 zulip zulip   4096 Feb 18 22:05 deployments
...
lrwxrwxrwx   1 zulip zulip     38 Feb 18 20:53 prod-static -&gt; /home/zulip/deployments/current/static
</code></pre></div>



<a name="1331632"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331632" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331632">(Feb 18 2022 at 22:36)</a>:</h4>
<p><code>prod-static</code> is not the same as <code>static</code> and should not be symlinked to it.</p>



<a name="1331633"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331633" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331633">(Feb 18 2022 at 22:37)</a>:</h4>
<p><code>prod-static</code> contains the compiled assets built by Webpack that are needed by the frontend. <code>static</code> has source code that’s not directly usable directly in browsers.</p>



<a name="1331634"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331634" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331634">(Feb 18 2022 at 22:38)</a>:</h4>
<p>The installation and upgrade scripts take care of creating and managing <code>prod-static</code>. You should never have to interact with it manually.</p>



<a name="1331697"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331697" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331697">(Feb 18 2022 at 23:09)</a>:</h4>
<p>thx!  that's helpful.  sorry for my confusion. I re-ran update-prod-static and got an error:</p>
<div class="codehilite"><pre><span></span><code>zulip@zulip-prod:~/deployments/current$ ./tools/update-prod-static
Using cached node modules from /srv/zulip-npm-cache/10018430ec99696630f7fe801e297da3568f5e5a/node_modules
+ ./tools/setup/emoji/build_emoji
build_emoji: Using cached emojis from /srv/zulip-emoji-cache/76d8e5872dd7c78dcf785dd75373945447aeb71c/emoji
+ ./scripts/setup/inline_email_css.py
+ ./tools/setup/generate_zulip_bots_static_files.py
+ ./tools/setup/build_pygments_data
+ ./tools/setup/build_timezone_values
+ ./tools/webpack --quiet
+ ./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates
Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 157, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;./manage.py&quot;, line 122, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2022-02-18-20-39-08/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py&quot;, line 413, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2022-02-18-20-39-08/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2022-02-18-20-39-08/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 398, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2022-02-18-20-39-08/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 187, in handle
    collected = self.collect()
  File &quot;/home/zulip/deployments/2022-02-18-20-39-08/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 114, in collect
    handler(path, prefixed_path, storage)
  File &quot;/home/zulip/deployments/2022-02-18-20-39-08/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 347, in copy_file
    with source_storage.open(path) as source_file:
  File &quot;/home/zulip/deployments/2022-02-18-20-39-08/zulip-py3-venv/lib/python3.8/site-packages/django/core/files/storage.py&quot;, line 38, in open
    return self._open(name, mode)
  File &quot;/home/zulip/deployments/2022-02-18-20-39-08/zulip-py3-venv/lib/python3.8/site-packages/django/core/files/storage.py&quot;, line 243, in _open
    return File(open(self.path(name), mode))
FileNotFoundError: [Errno 2] No such file or directory: &#39;/home/zulip/deployments/2022-02-18-20-39-08/static/generated/emoji/images/emoji/candle.png&#39;

Error running a subcommand of ./tools/update-prod-static: ./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates
Actual error output for the subcommand is just above this.
</code></pre></div>



<a name="1331702"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331702" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331702">(Feb 18 2022 at 23:17)</a>:</h4>
<p>each run I get a different complaint...</p>
<div class="codehilite"><pre><span></span><code>zulip@zulip-prod:~/deployments/current$ ./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates
Traceback (most recent call last):
...
FileNotFoundError: [Errno 2] No such file or directory: &#39;/home/zulip/deployments/2022-02-18-20-39-08/static/generated/emoji/images/emoji/black_large_square.png&#39;
zulip@zulip-prod:~/deployments/current$ ./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates
...
FileNotFoundError: [Errno 2] No such file or directory: &#39;/home/zulip/deployments/2022-02-18-20-39-08/static/generated/emoji/images/emoji/heavy_check_mark.png&#39;
</code></pre></div>



<a name="1331703"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331703" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331703">(Feb 18 2022 at 23:21)</a>:</h4>
<p>None of these are things you’re supposed to run yourself. The interface you’re supposed to use is <code>upgrade-zulip-from-git</code>. See our documentation on <a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#making-changes">making changes</a>.</p>



<a name="1331708"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331708" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331708">(Feb 18 2022 at 23:36)</a>:</h4>
<p>I know!!!  but I don't know what to do - update-zulip-from-git is succeeding but leaving my system corrupted.  thx! for the help.</p>



<a name="1331709"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331709" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331709">(Feb 18 2022 at 23:37)</a>:</h4>
<p>(I've run <code>update-zulip-from-git </code> without incident for months)</p>



<a name="1331710"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331710" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331710">(Feb 18 2022 at 23:38)</a>:</h4>
<p>Based on that most recent error, maybe try deleting /srv/zulip-emoji-cache and re-running <code>upgrade-zulip-from-git</code>?</p>



<a name="1331711"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331711" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331711">(Feb 18 2022 at 23:39)</a>:</h4>
<p>To be clear, you should also delete that <code>prod-static</code> symlink if you haven’t already.</p>



<a name="1331712"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331712" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331712">(Feb 18 2022 at 23:41)</a>:</h4>
<div class="codehilite"><pre><span></span><code>2022-02-18 20:39:08,688 upgrade-zulip-from-git: Fetching the latest commits
2022-02-18 20:39:10,773 upgrade-zulip-stage-2: Upgrading system packages...
Hit:1 http://us-central1.gce.archive.ubuntu.com/ubuntu focal InRelease
Get:2 http://us-central1.gce.archive.ubuntu.com/ubuntu focal-updates InRelease [114 kB]
Get:3 http://us-central1.gce.archive.ubuntu.com/ubuntu focal-backports InRelease [108 kB]
Hit:4 https://packages.cloud.google.com/apt google-cloud-ops-agent-focal-all InRelease
Hit:5 http://security.ubuntu.com/ubuntu focal-security InRelease
Hit:6 http://ppa.launchpad.net/groonga/ppa/ubuntu focal InRelease
Hit:7 http://apt.postgresql.org/pub/repos/apt focal-pgdg InRelease
Hit:8 https://packages.groonga.org/ubuntu focal InRelease
Fetched 222 kB in 1s (300 kB/s)
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
Calculating upgrade...
The following package was automatically installed and is no longer required:
  libnuma1
Use &#39;sudo apt autoremove&#39; to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
+ apt-get -y install build-essential libffi-dev libfreetype6-dev zlib1g-dev libjpeg-dev libldap2-dev python3-dev python3-pip virtualenv libxml2-dev libxslt1-dev libpq-dev libssl-dev libmagic1 libyaml-dev libxmlsec1-dev pkg-config jq libsasl2-dev
Reading package lists...
Building dependency tree...
Reading state information...
libffi-dev is already the newest version (3.3-4).
libjpeg-dev is already the newest version (8c-2ubuntu8).
libmagic1 is already the newest version (1:5.38-4).
libsasl2-dev is already the newest version (2.1.27+dfsg-2).
libxmlsec1-dev is already the newest version (1.2.28-2).
libxslt1-dev is already the newest version (1.1.34-4).
libyaml-dev is already the newest version (0.2.2-1).
pkg-config is already the newest version (0.29.1-0ubuntu4).
python3-dev is already the newest version (3.8.2-0ubuntu2).
build-essential is already the newest version (12.8ubuntu1.1).
libfreetype6-dev is already the newest version (2.10.1-2ubuntu0.1).
libldap2-dev is already the newest version (2.4.49+dfsg-2ubuntu1.8).
libssl-dev is already the newest version (1.1.1f-1ubuntu2.10).
libxml2-dev is already the newest version (2.9.10+dfsg-5ubuntu0.20.04.1).
zlib1g-dev is already the newest version (1:1.2.11.dfsg-2ubuntu1.2).
jq is already the newest version (1.6-1ubuntu0.20.04.1).
python3-pip is already the newest version (20.0.2-5ubuntu1.6).
virtualenv is already the newest version (20.0.17-1ubuntu0.4).
libpq-dev is already the newest version (14.2-1.pgdg20.04+1).
The following package was automatically installed and is no longer required:
  libnuma1
Use &#39;sudo apt autoremove&#39; to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Using cached Python venv from /srv/zulip-venv-cache/33d83727c0b2e4c40a132c9ee3d9109a5c2feab1/zulip-py3-venv
+ ln -nsf /srv/zulip-venv-cache/33d83727c0b2e4c40a132c9ee3d9109a5c2feab1/zulip-py3-venv /home/zulip/deployments/2022-02-18-20-39-08/zulip-py3-venv
generate_secrets: No new secrets to generate.
2022-02-18 20:39:19,463 upgrade-zulip-stage-2: Building static assets...
Cached version not found! Installing node modules.
+ /srv/zulip-yarn/bin/yarn install --non-interactive --frozen-lockfile --prod
yarn install v1.22.17
[1/4] Resolving packages...
[2/4] Fetching packages...
[3/4] Linking dependencies...
warning &quot;@types/webpack-dev-server &gt; webpack-dev-server &gt; http-proxy-middleware@2.0.2&quot; has unmet peer dependency &quot;@types/express@^4.17.13&quot;.
warning &quot;swagger-parser &gt; @apidevtools/swagger-parser@10.0.3&quot; has unmet peer dependency &quot;openapi-types@&gt;=7&quot;.
[4/4] Building fresh packages...
warning Ignored scripts due to flag.
Done in 15.77s.
Using cached node modules from /srv/zulip-npm-cache/10018430ec99696630f7fe801e297da3568f5e5a/node_modules
+ ./tools/setup/emoji/build_emoji
build_emoji: Using cached emojis from /srv/zulip-emoji-cache/76d8e5872dd7c78dcf785dd75373945447aeb71c/emoji
+ ./scripts/setup/inline_email_css.py
+ ./tools/setup/generate_zulip_bots_static_files.py
+ ./tools/setup/build_pygments_data
+ ./tools/setup/build_timezone_values
+ ./tools/webpack --quiet
+ ./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates
+ ./manage.py compilemessages -v0
2022-02-18 20:42:12,386 upgrade-zulip-stage-2: Caching Zulip Git version...
2022-02-18 20:42:13,421 upgrade-zulip-stage-2: Checking for needed migrations
2022-02-18 20:42:22,204 upgrade-zulip-stage-2: Stopping Zulip...
process-fts-updates: stopped
zulip-django: stopped
zulip-tornado: stopped
zulip-workers:zulip_events_embed_links: stopped
zulip-workers:zulip_events_error_reports: stopped
zulip-workers:zulip_events_invites: stopped
zulip-workers:zulip_events_email_senders: stopped
zulip-workers:zulip_events_missedmessage_emails: stopped
zulip-workers:zulip_events_user_activity: stopped
zulip-workers:zulip_events_user_activity_interval: stopped
zulip-workers:zulip_events_user_presence: stopped
zulip-workers:zulip_events_deferred_work: stopped
zulip-workers:zulip_events_digest_emails: stopped
zulip-workers:zulip_events_email_mirror: stopped
zulip-workers:zulip_events_embedded_bots: stopped
zulip-workers:zulip_events_missedmessage_mobile_notifications: stopped
zulip-workers:zulip_events_outgoing_webhooks: stopped
zulip_deliver_scheduled_emails: stopped
zulip_deliver_scheduled_messages: stopped

ESC[92mZulip stopped successfully!ESC[0m
2022-02-18 20:42:36,162 upgrade-zulip-stage-2: Applying Puppet changes...
ESC[mNotice: Compiled catalog for zulip-prod.us-central1-a.c.zulipcraze.internal in environment production in 2.82 secondsESC[0m
ESC[mNotice: /Stage[main]/Zulip::Apt_repository/Exec[setup_apt_repo]/returns: executed successfullyESC[0m
ESC[mNotice: /Stage[main]/Zulip::App_frontend_base/File[/home/zulip/prod-static]/ensure: ensure changed &#39;link&#39; to &#39;directory&#39;ESC[0m
ESC[mNotice: Applied catalog in 6.74 secondsESC[0m
Reading package lists...
Building dependency tree...
Reading state information...
Calculating upgrade...
The following package was automatically installed and is no longer required:
  libnuma1
Use &#39;sudo apt autoremove&#39; to remove it.
The following packages will be DOWNGRADED:
  postgresql-12 postgresql-13 postgresql-client-12 postgresql-client-13
  postgresql-client-14
0 upgraded, 0 newly installed, 5 downgraded, 0 to remove and 0 not upgraded.
Need to get 34.4 MB of archives.
After this operation, 117 kB disk space will be freed.
Get:1 https://apt-archive.postgresql.org/pub/repos/apt focal-pgdg-archive/main amd64 postgresql-client-12 amd64 12.9-2.pgdg20.04+1 [1426 kB]
Get:2 https://apt-archive.postgresql.org/pub/repos/apt focal-pgdg-archive/main amd64 postgresql-12 amd64 12.9-2.pgdg20.04+1 [14.8 MB]
Get:3 https://apt-archive.postgresql.org/pub/repos/apt focal-pgdg-archive/main amd64 postgresql-client-13 amd64 13.5-2.pgdg20.04+1 [1508 kB]
Get:4 https://apt-archive.postgresql.org/pub/repos/apt focal-pgdg-archive/main amd64 postgresql-13 amd64 13.5-2.pgdg20.04+1 [15.0 MB]
Get:5 https://apt-archive.postgresql.org/pub/repos/apt focal-pgdg-archive/main amd64 postgresql-client-14 amd64 14.1-2.pgdg20.04+1 [1602 kB]
Preconfiguring packages ...
Fetched 34.4 MB in 2s (15.8 MB/s)
dpkg: warning: downgrading postgresql-client-12 from 12.10-1.pgdg20.04+1 to 12.9-2.pgdg20.04+1
(Reading database ... ^M(Reading database ... 5%^M(Reading database ... 10%^M(Reading database ... 15%^M(Reading database ... 20%^M(Reading database ... 25%^M(Reading database ... 30%^M(Reading database ... 35%^M(Reading database ... 40%^M(Reading database ... 45%^M(Reading database ... 50%^M(Reading database ... 55%^M(Reading database ... 60%^M(Reading database ... 65%^M(Reading database ... 70%^M(Reading database ... 75%^M(Reading database ... 80%^M(Reading database ... 85%^M(Reading database ... 90%^M(Reading database ... 95%^M(Reading database ... 100%^M(Reading database ... 177996 files and directories currently installed.)
Preparing to unpack .../postgresql-client-12_12.9-2.pgdg20.04+1_amd64.deb ...
Unpacking postgresql-client-12 (12.9-2.pgdg20.04+1) over (12.10-1.pgdg20.04+1) ...
dpkg: warning: downgrading postgresql-12 from 12.10-1.pgdg20.04+1 to 12.9-2.pgdg20.04+1
Preparing to unpack .../postgresql-12_12.9-2.pgdg20.04+1_amd64.deb ...
Unpacking postgresql-12 (12.9-2.pgdg20.04+1) over (12.10-1.pgdg20.04+1) ...
dpkg: warning: downgrading postgresql-client-13 from 13.6-1.pgdg20.04+1 to 13.5-2.pgdg20.04+1
Preparing to unpack .../postgresql-client-13_13.5-2.pgdg20.04+1_amd64.deb ...
Unpacking postgresql-client-13 (13.5-2.pgdg20.04+1) over (13.6-1.pgdg20.04+1) ...
dpkg: warning: downgrading postgresql-13 from 13.6-1.pgdg20.04+1 to 13.5-2.pgdg20.04+1
Preparing to unpack .../postgresql-13_13.5-2.pgdg20.04+1_amd64.deb ...
Unpacking postgresql-13 (13.5-2.pgdg20.04+1) over (13.6-1.pgdg20.04+1) ...
dpkg: warning: downgrading postgresql-client-14 from 14.2-1.pgdg20.04+1 to 14.1-2.pgdg20.04+1
Preparing to unpack .../postgresql-client-14_14.1-2.pgdg20.04+1_amd64.deb ...
Unpacking postgresql-client-14 (14.1-2.pgdg20.04+1) over (14.2-1.pgdg20.04+1) ...
Setting up postgresql-client-14 (14.1-2.pgdg20.04+1) ...
Setting up postgresql-client-13 (13.5-2.pgdg20.04+1) ...
Setting up postgresql-client-12 (12.9-2.pgdg20.04+1) ...
Setting up postgresql-13 (13.5-2.pgdg20.04+1) ...
Setting up postgresql-12 (12.9-2.pgdg20.04+1) ...
Processing triggers for postgresql-common (238.pgdg20.04+1) ...
Building PostgreSQL dictionaries from installed myspell/hunspell packages...
  en_us
</code></pre></div>



<a name="1331713"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331713" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331713">(Feb 18 2022 at 23:42)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Removing obsolete dictionary files:
2022-02-18 20:43:16,552 upgrade-zulip-stage-2: Restarting Zulip...
2022-02-18 20:43:16,643 restart-server: Filling memcached caches
2022-02-18 20:43:23.295 INFO [] Successfully populated user cache!  Consumed 1 remote cache queries (0.05 time)
2022-02-18 20:43:23.303 INFO [] Successfully populated client cache!  Consumed 1 remote cache queries (0.0 time)
2022-02-18 20:43:23.330 INFO [] Successfully populated stream cache!  Consumed 1 remote cache queries (0.01 time)
2022-02-18 20:43:23.338 INFO [] Successfully populated huddle cache!  Consumed 1 remote cache queries (0.0 time)
2022-02-18 20:43:23.365 INFO [] Successfully populated session cache!  Consumed 1 remote cache queries (0.01 time)
2022-02-18 20:43:24,236 restart-server: Restarting zulip-workers:zulip_events_deferred_work
zulip-workers:zulip_events_deferred_work: ERROR (not running)
zulip-workers:zulip_events_deferred_work: started
2022-02-18 20:43:25,514 restart-server: Restarting zulip-workers:zulip_events_digest_emails
zulip-workers:zulip_events_digest_emails: ERROR (not running)
zulip-workers:zulip_events_digest_emails: started
2022-02-18 20:43:26,878 restart-server: Restarting zulip-workers:zulip_events_email_mirror
zulip-workers:zulip_events_email_mirror: ERROR (not running)
zulip-workers:zulip_events_email_mirror: started
2022-02-18 20:43:28,273 restart-server: Restarting zulip-workers:zulip_events_email_senders
zulip-workers:zulip_events_email_senders: ERROR (not running)
zulip-workers:zulip_events_email_senders: started
2022-02-18 20:43:29,669 restart-server: Restarting zulip-workers:zulip_events_embed_links
zulip-workers:zulip_events_embed_links: ERROR (not running)
zulip-workers:zulip_events_embed_links: started
2022-02-18 20:43:31,049 restart-server: Restarting zulip-workers:zulip_events_embedded_bots
zulip-workers:zulip_events_embedded_bots: ERROR (not running)
zulip-workers:zulip_events_embedded_bots: started
2022-02-18 20:43:32,486 restart-server: Restarting zulip-workers:zulip_events_error_reports
zulip-workers:zulip_events_error_reports: ERROR (not running)
zulip-workers:zulip_events_error_reports: started
2022-02-18 20:43:33,886 restart-server: Restarting zulip-workers:zulip_events_invites
zulip-workers:zulip_events_invites: ERROR (not running)
zulip-workers:zulip_events_invites: started
2022-02-18 20:43:35,282 restart-server: Restarting zulip-workers:zulip_events_missedmessage_emails
zulip-workers:zulip_events_missedmessage_emails: ERROR (not running)
zulip-workers:zulip_events_missedmessage_emails: started
2022-02-18 20:43:36,705 restart-server: Restarting zulip-workers:zulip_events_missedmessage_mobile_notifications
2022-02-18 20:43:36,705 restart-server: Restarting zulip-workers:zulip_events_missedmessage_mobile_notifications
zulip-workers:zulip_events_missedmessage_mobile_notifications: ERROR (not running)
zulip-workers:zulip_events_missedmessage_mobile_notifications: started
2022-02-18 20:43:38,120 restart-server: Restarting zulip-workers:zulip_events_outgoing_webhooks
zulip-workers:zulip_events_outgoing_webhooks: ERROR (not running)
zulip-workers:zulip_events_outgoing_webhooks: started
2022-02-18 20:43:39,541 restart-server: Restarting zulip-workers:zulip_events_user_activity
zulip-workers:zulip_events_user_activity: ERROR (not running)
zulip-workers:zulip_events_user_activity: started
2022-02-18 20:43:40,937 restart-server: Restarting zulip-workers:zulip_events_user_activity_interval
zulip-workers:zulip_events_user_activity_interval: ERROR (not running)
zulip-workers:zulip_events_user_activity_interval: started
2022-02-18 20:43:42,393 restart-server: Restarting zulip-workers:zulip_events_user_presence
zulip-workers:zulip_events_user_presence: ERROR (not running)
zulip-workers:zulip_events_user_presence: started
2022-02-18 20:43:43,807 restart-server: Restarting zulip_deliver_scheduled_emails
zulip_deliver_scheduled_emails: ERROR (not running)
zulip_deliver_scheduled_emails: started
2022-02-18 20:43:45,212 restart-server: Restarting zulip_deliver_scheduled_messages
zulip_deliver_scheduled_messages: ERROR (not running)
zulip_deliver_scheduled_messages: started
2022-02-18 20:43:46,588 restart-server: Restarting process-fts-updates
process-fts-updates: ERROR (not running)
process-fts-updates: started
2022-02-18 20:43:48,669 restart-server: Restarting Tornado process
zulip-tornado: started
2022-02-18 20:43:50,056 restart-server: Restarting django server
zulip-django: ERROR (not running)
zulip-django: started
2022-02-18 20:43:52,281 restart-server: Done!
ESC[92mZulip restarted successfully!ESC[0m
2022-02-18 20:43:52,303 upgrade-zulip-stage-2: Upgrade complete!
2022-02-18 20:43:52,303 upgrade-zulip-stage-2: Purging old deployments...
+ rm -rf /home/zulip/deployments/2022-02-03-18-21-16
Deployments cleaned successfully...
Cleaning orphaned/unused caches...
Cleaning unused venv caches...
+ rm -rf /srv/zulip-venv-cache/53df1e47e5d1cfe7e5b71ad8fb8d60d801b11198
Cleaning unused node modules caches...
+ rm -rf /srv/zulip-npm-cache/bf7f60b504d510878a3d0eb1f2a77d3ea670bbef
Cleaning unused emoji caches...
Done!
</code></pre></div>



<a name="1331714"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331714" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331714">(Feb 18 2022 at 23:42)</a>:</h4>
<p>That all looks fine to me.</p>



<a name="1331715"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331715" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331715">(Feb 18 2022 at 23:43)</a>:</h4>
<p>It even fixed your symlink back to a directory:</p>
<p><code>Notice: /Stage[main]/Zulip::App_frontend_base/File[/home/zulip/prod-static]/ensure: ensure changed 'link' to 'directory'</code></p>



<a name="1331736"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331736" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331736">(Feb 19 2022 at 00:21)</a>:</h4>
<p>haha, actually that was the tail of <code>/var/log/zulip/upgrade.log</code> but no worries, I'll rerun <code>/home/zulip/deployments/current/scripts/upgrade-zulip-from-git</code> and report what happens... I ran it many times...</p>



<a name="1331737"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331737" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331737">(Feb 19 2022 at 00:23)</a>:</h4>
<p>hereya go - same error:</p>
<div class="codehilite"><pre><span></span><code>+ ./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates
Traceback (most recent call last):
  File &quot;./manage.py&quot;, line 157, in &lt;module&gt;
    execute_from_command_line(sys.argv)
  File &quot;./manage.py&quot;, line 122, in execute_from_command_line
    utility.execute()
  File &quot;/home/zulip/deployments/2022-02-19-00-20-00/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py&quot;, line 413, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File &quot;/home/zulip/deployments/2022-02-19-00-20-00/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv
    self.execute(*args, **cmd_options)
  File &quot;/home/zulip/deployments/2022-02-19-00-20-00/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 398, in execute
    output = self.handle(*args, **options)
  File &quot;/home/zulip/deployments/2022-02-19-00-20-00/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 187, in handle
    collected = self.collect()
  File &quot;/home/zulip/deployments/2022-02-19-00-20-00/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 114, in collect
    handler(path, prefixed_path, storage)
  File &quot;/home/zulip/deployments/2022-02-19-00-20-00/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 347, in copy_file
    with source_storage.open(path) as source_file:
  File &quot;/home/zulip/deployments/2022-02-19-00-20-00/zulip-py3-venv/lib/python3.8/site-packages/django/core/files/storage.py&quot;, line 38, in open
    return self._open(name, mode)
  File &quot;/home/zulip/deployments/2022-02-19-00-20-00/zulip-py3-venv/lib/python3.8/site-packages/django/core/files/storage.py&quot;, line 243, in _open
    return File(open(self.path(name), mode))
FileNotFoundError: [Errno 2] No such file or directory: &#39;/home/zulip/deployments/2022-02-19-00-20-00/static/generated/emoji/images/emoji/cloud_with_lightning_and_rain.png&#39;

Error running a subcommand of ./tools/update-prod-static: ./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates
Actual error output for the subcommand is just above this.

2022-02-19 00:22:54,992 upgrade-zulip-stage-2: Failed to build static assets.
2022-02-19 00:22:54,992 upgrade-zulip-stage-2: Usually the cause is insufficient free RAM to run webpack.
2022-02-19 00:22:54,992 upgrade-zulip-stage-2: Try stopping the Zulip server (scripts/stop-server) and trying again.

Zulip upgrade failed (exit code 1)!

The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is available in /var/log/zulip/upgrade.log
</code></pre></div>



<a name="1331757"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331757" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331757">(Feb 19 2022 at 00:39)</a>:</h4>
<p>Is that after deleting /srv/zulip-emoji-cache?</p>



<a name="1331789"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331789" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331789">(Feb 19 2022 at 02:38)</a>:</h4>
<div class="codehilite"><pre><span></span><code>zulip@zulip-prod:~/deployments/current$ sudo mv /srv/zulip-emoji-cache/  /srv/zulip-emoji-cache.bak

zulip@zulip-prod:~/deployments/current$ sudo /home/zulip/deployments/current/scripts/upgrade-zulip-from-git  --remote-url https://github.com/asah/zulip.git forecast.chat
2022-02-19 02:36:19,642 upgrade-zulip-from-git: Fetching the latest commits
2022-02-19 02:36:20,259 upgrade-zulip-from-git: Upgrading to b4fecccbc3708b4f1c1b2858c8f346416e9ef2a9, in /home/zulip/deployments/2022-02-19-02-36-19
2022-02-19 02:36:21,622 upgrade-zulip-stage-2: Upgrading system packages...
Hit:1 http://us-central1.gce.archive.ubuntu.com/ubuntu focal InRelease
Hit:2 http://us-central1.gce.archive.ubuntu.com/ubuntu focal-updates InRelease
Get:3 http://us-central1.gce.archive.ubuntu.com/ubuntu focal-backports InRelease [108 kB]
Hit:5 https://packages.cloud.google.com/apt google-cloud-ops-agent-focal-all InRelease
Hit:4 https://apt-archive.postgresql.org/pub/repos/apt focal-pgdg-archive InRelease
Hit:6 http://ppa.launchpad.net/groonga/ppa/ubuntu focal InRelease
Hit:7 http://security.ubuntu.com/ubuntu focal-security InRelease
Hit:8 http://apt.postgresql.org/pub/repos/apt focal-pgdg InRelease
Hit:9 https://packages.groonga.org/ubuntu focal InRelease
Fetched 108 kB in 1s (118 kB/s)
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
Calculating upgrade...
The following package was automatically installed and is no longer required:
  libnuma1
Use &#39;sudo apt autoremove&#39; to remove it.
The following packages will be upgraded:
  snapd
1 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
1 standard security update
Need to get 34.3 MB of archives.
After this operation, 16.4 kB of additional disk space will be used.
Get:1 http://us-central1.gce.archive.ubuntu.com/ubuntu focal-updates/main amd64 snapd amd64 2.54.3+20.04.1ubuntu0.1 [34.3 MB]
Fetched 34.3 MB in 1s (40.2 MB/s)
(Reading database ... 177995 files and directories currently installed.)
Preparing to unpack .../snapd_2.54.3+20.04.1ubuntu0.1_amd64.deb ...
Unpacking snapd (2.54.3+20.04.1ubuntu0.1) over (2.54.3+20.04.1) ...
Setting up snapd (2.54.3+20.04.1ubuntu0.1) ...
snapd.failure.service is a disabled or a static unit, not starting it.
snapd.snap-repair.service is a disabled or a static unit, not starting it.
Processing triggers for man-db (2.9.1-1) ...
Processing triggers for dbus (1.12.16-2ubuntu2.1) ...
Processing triggers for mime-support (3.64ubuntu1) ...
+ apt-get -y install build-essential libffi-dev libfreetype6-dev zlib1g-dev libjpeg-dev libldap2-dev python3-dev python3-pip virtualenv libxml2-dev libxslt1-dev libpq-dev libssl-dev libmagic1 libyaml-dev libxmlsec1-dev pkg-config jq libsasl2-dev
Reading package lists...
Building dependency tree...
Reading state information...
libffi-dev is already the newest version (3.3-4).
libjpeg-dev is already the newest version (8c-2ubuntu8).
libmagic1 is already the newest version (1:5.38-4).
libsasl2-dev is already the newest version (2.1.27+dfsg-2).
libxmlsec1-dev is already the newest version (1.2.28-2).
libxslt1-dev is already the newest version (1.1.34-4).
libyaml-dev is already the newest version (0.2.2-1).
pkg-config is already the newest version (0.29.1-0ubuntu4).
python3-dev is already the newest version (3.8.2-0ubuntu2).
build-essential is already the newest version (12.8ubuntu1.1).
libfreetype6-dev is already the newest version (2.10.1-2ubuntu0.1).
libldap2-dev is already the newest version (2.4.49+dfsg-2ubuntu1.8).
libssl-dev is already the newest version (1.1.1f-1ubuntu2.10).
libxml2-dev is already the newest version (2.9.10+dfsg-5ubuntu0.20.04.1).
zlib1g-dev is already the newest version (1:1.2.11.dfsg-2ubuntu1.2).
jq is already the newest version (1.6-1ubuntu0.20.04.1).
python3-pip is already the newest version (20.0.2-5ubuntu1.6).
virtualenv is already the newest version (20.0.17-1ubuntu0.4).
libpq-dev is already the newest version (14.2-1.pgdg20.04+1).
The following package was automatically installed and is no longer required:
  libnuma1
Use &#39;sudo apt autoremove&#39; to remove it.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Using cached Python venv from /srv/zulip-venv-cache/33d83727c0b2e4c40a132c9ee3d9109a5c2feab1/zulip-py3-venv
+ ln -nsf /srv/zulip-venv-cache/33d83727c0b2e4c40a132c9ee3d9109a5c2feab1/zulip-py3-venv /home/zulip/deployments/2022-02-19-02-36-19/zulip-py3-venv
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-02-19-02-36-19/scripts/lib/check-database-compatibility.py&quot;, line 20, in &lt;module&gt;
    django.setup()
  File &quot;/srv/zulip-venv-cache/33d83727c0b2e4c40a132c9ee3d9109a5c2feab1/zulip-py3-venv/lib/python3.8/site-packages/django/__init__.py&quot;, line 24, in setup
    apps.populate(settings.INSTALLED_APPS)
  File &quot;/srv/zulip-venv-cache/33d83727c0b2e4c40a132c9ee3d9109a5c2feab1/zulip-py3-venv/lib/python3.8/site-packages/django/apps/registry.py&quot;, line 122, in populate
    app_config.ready()
  File &quot;/home/zulip/deployments/2022-02-19-02-36-19/zerver/apps.py&quot;, line 24, in ready
    import zerver.signals
  File &quot;/home/zulip/deployments/2022-02-19-02-36-19/zerver/signals.py&quot;, line 12, in &lt;module&gt;
    from zerver.lib.actions import do_set_zoom_token
  File &quot;/home/zulip/deployments/2022-02-19-02-36-19/zerver/lib/actions.py&quot;, line 63, in &lt;module&gt;
    from zerver.lib.bulk_create import bulk_create_users
  File &quot;/home/zulip/deployments/2022-02-19-02-36-19/zerver/lib/bulk_create.py&quot;, line 7, in &lt;module&gt;
    from zerver.lib.streams import render_stream_description
  File &quot;/home/zulip/deployments/2022-02-19-02-36-19/zerver/lib/streams.py&quot;, line 14, in &lt;module&gt;
    from zerver.lib.markdown import markdown_convert
  File &quot;/home/zulip/deployments/2022-02-19-02-36-19/zerver/lib/markdown/__init__.py&quot;, line 55, in &lt;module&gt;
    from zerver.lib.emoji import EMOTICON_RE, codepoint_to_name, name_to_codepoint, translate_emoticons
  File &quot;/home/zulip/deployments/2022-02-19-02-36-19/zerver/lib/emoji.py&quot;, line 22, in &lt;module&gt;
    with open(emoji_codes_path, &quot;rb&quot;) as fp:
FileNotFoundError: [Errno 2] No such file or directory: &#39;/home/zulip/deployments/2022-02-19-02-36-19/zerver/lib/../../static/generated/emoji/emoji_codes.json&#39;
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-02-19-02-36-19/scripts/lib/upgrade-zulip-stage-2&quot;, line 220, in &lt;module&gt;
    subprocess.check_call(
  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 364, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2022-02-19-02-36-19/scripts/lib/check-database-compatibility.py&#39;]&#39; returned non-zero exit status 1.

Zulip upgrade failed (exit code 1)!

The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is available in /var/log/zulip/upgrade.log
</code></pre></div>



<a name="1331791"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331791" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331791">(Feb 19 2022 at 02:39)</a>:</h4>
<p>(thx! for the help)</p>



<a name="1331792"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331792" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331792">(Feb 19 2022 at 02:41)</a>:</h4>
<p>Hmm. That looks like a bug in <code>check-database-compatibility.py</code>.</p>



<a name="1331797"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331797" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331797">(Feb 19 2022 at 02:48)</a>:</h4>
<p>The bug being that it is doing an import that assumes the emoji are already in place?</p>



<a name="1331798"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331798" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331798">(Feb 19 2022 at 02:48)</a>:</h4>
<p>Seems like a possible bug, yeah.</p>



<a name="1331864"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1331864" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1331864">(Feb 19 2022 at 09:53)</a>:</h4>
<p>Likely culprit? Committed 16 days ago.</p>
<p><a href="https://github.com/zulip/zulip/blame/main/scripts/lib/upgrade-zulip-stage-2#L217">https://github.com/zulip/zulip/blame/main/scripts/lib/upgrade-zulip-stage-2#L217</a></p>
<p><a href="https://github.com/zulip/zulip/commit/8da60986314996051fa6c174800b331c61bf8794">https://github.com/zulip/zulip/commit/8da60986314996051fa6c174800b331c61bf8794</a></p>
<p>Thx!<br>
<span class="user-mention" data-user-id="12178">@Alex Vandiver</span></p>



<a name="1332753"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1332753" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1332753">(Feb 22 2022 at 18:55)</a>:</h4>
<p>check-database-compatibility is calling <code>django.setup()</code> so it can inspect the database state, but the act of importing <code>zerver/lib/emoji.py</code> causes it to try to load <code>emoji_codes.json</code>.</p>
<p>We can move the database check top be yet later, after building static assets, but that will necessarily mean it will be after we may have stopped the server, which feels unfortunate.</p>
<p>Is there anything that prevents us from lazily loading the emoji data, instead of doing it at import time?</p>



<a name="1332851"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1332851" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1332851">(Feb 22 2022 at 20:15)</a>:</h4>
<p>I think nothing prevents us from lazy-loading emoji data other than the potential desire to validate that the server is going to work on first startup.</p>



<a name="1332852"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1332852" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1332852">(Feb 22 2022 at 20:16)</a>:</h4>
<p>Concretely, that probably means we could lazy-load it and it make <code>zproject/wsgi.py</code> call whatever functions triggers a non-lazy load instead and have the experience be better for all scripts that don't need to access emoji?</p>



<a name="1332854"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1332854" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1332854">(Feb 22 2022 at 20:17)</a>:</h4>
<p>(We might find we need to do something similar with other <code>webpack</code> outputs as well, but I think likely not since they are more likely to be only accessed when rendering webpages)</p>



<a name="1332870"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1332870" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1332870">(Feb 22 2022 at 20:58)</a>:</h4>
<p>If I had to “blame” this on something, it would be that our giant monolithic <code>zerver.lib.actions</code> has to be imported in its entirety when we need a single action from it—in this case, the <code>do_set_zoom_token</code> in <code>zerver.signals</code>.</p>
<p>If we like the separation between actions and views, we should split <code>zerver/lib/actions.py</code> into a <code>zerver/actions</code> directory.</p>



<a name="1332919"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1332919" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1332919">(Feb 22 2022 at 22:06)</a>:</h4>
<p>Such a split is I think the next major backend file structure reorganization I'd like to see us do.  It'll take some care choosing how to do said split and making naming choice -- I think roughly we want to parallel the naming we use in <code>zerver/lib</code> and in <code>zerver/views</code>.</p>



<a name="1333216"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333216" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333216">(Feb 23 2022 at 03:34)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/pull/21220">#21220</a> severs this import chain and adds a CI check to keep it that way.</p>



<a name="1333219"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333219" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333219">(Feb 23 2022 at 03:36)</a>:</h4>
<p>Hmm yeah that lgtm.</p>



<a name="1333224"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333224" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333224">(Feb 23 2022 at 03:48)</a>:</h4>
<p>Evidently there’s another chain.</p>



<a name="1333225"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333225" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333225">(Feb 23 2022 at 03:50)</a>:</h4>
<p><code>zerver/migrations/0206_stream_rendered_description.py</code> imports <code>zerver.lib.streams</code>, which migrations are not supposed to do.</p>



<a name="1333228"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333228" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333228">(Feb 23 2022 at 04:11)</a>:</h4>
<p>We can move that to an in-function import, but I think that one has no real alternative.</p>



<a name="1333233"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333233" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333233">(Feb 23 2022 at 04:22)</a>:</h4>
<p>How about switching it to do <code>html.escape(stream.description)</code> and scheduling a deferred job for the full Markdown rendering?</p>



<a name="1333234"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333234" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333234">(Feb 23 2022 at 04:22)</a>:</h4>
<p>I suppose that could be OK; but is there any downside to doing the in-function import instead?</p>



<a name="1333235"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333235" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333235">(Feb 23 2022 at 04:22)</a>:</h4>
<p>(We have a half dozen migrations that import product code for one reason or another; this won't be the only one)</p>



<a name="1333236"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333236" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333236">(Feb 23 2022 at 04:29)</a>:</h4>
<p>The Django docs give <a href="https://docs.djangoproject.com/en/3.2/topics/migrations/#historical-models">clear warnings</a> that you shouldn’t import models directly from migrations. I’m not a fan of violating expected invariants and then being given the burden of explaining exactly what will go wrong as a result of those violations.</p>



<a name="1333237"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333237" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333237">(Feb 23 2022 at 04:32)</a>:</h4>
<p>Well, I understand what's going on here and why it won't produce invalid output.</p>
<p>But more importantly, the migration in question was new in Zulip 2.0 and you likely can't even directly upgrade to <code>main</code> from 1.9, so it likely no longer matters what code that migration runs.</p>



<a name="1333238"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333238" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333238">(Feb 23 2022 at 04:32)</a>:</h4>
<p>For that reason, I wouldn't want to spend time on cleaning that old migration up; better would be to just do the work to allow us to <code>squashmigrations</code> and effectively delete it.</p>



<a name="1333239"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333239" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333239">(Feb 23 2022 at 04:37)</a>:</h4>
<p>Maybe you have an argument for why this abstraction violation doesn’t currently produce invalid output. Are you re-evaluating that argument every time you review a PR that changes apparently unrelated code that might interact with it (all code transitively imported from <code>zerver.lib.streams</code>)?</p>



<a name="1333240"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333240" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333240">(Feb 23 2022 at 04:38)</a>:</h4>
<p>It doesn't matter what code is imported from there <code>zerver.lib.streams</code>, just what <code>render_stream_description</code> does.</p>



<a name="1333241"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333241" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333241">(Feb 23 2022 at 04:39)</a>:</h4>
<p>That’s clearly not the case; we have top-level code that does all sorts of things, or we wouldn’t be talking about this now.</p>



<a name="1333243"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333243" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333243">(Feb 23 2022 at 04:39)</a>:</h4>
<p>Here's the set of migrations affected by this:</p>
<div class="codehilite"><pre><span></span><code>  - id: dont-import-models-in-migrations
    patterns:
      - pattern-not: from zerver.lib.redis_utils import get_redis_client
      - pattern-not: from zerver.models import filter_pattern_validator
      - pattern-not: from zerver.models import filter_format_validator
      - pattern-not: from zerver.models import generate_email_token_for_stream
      - pattern-either:
          - pattern: from zerver import $X
          - pattern: from analytics import $X
          - pattern: from confirmation import $X
    message: &quot;Don&#39;t import models or other code in migrations; see https://zulip.readthedocs.io/en/latest/subsystems/schema-migrations.html&quot;
    languages: [python]
    severity: ERROR
    paths:
      include:
        - &quot;**/migrations&quot;
      exclude:
        - zerver/migrations/0032_verify_all_medium_avatar_images.py
        - zerver/migrations/0104_fix_unreads.py
        - zerver/migrations/0206_stream_rendered_description.py
        - zerver/migrations/0209_user_profile_no_empty_password.py
        - zerver/migrations/0260_missed_message_addresses_from_redis_to_db.py
        - zerver/migrations/0376_set_realmemoji_author_and_reupload_realmemoji.py
        - pgroonga/migrations/0002_html_escape_subject.py
</code></pre></div>



<a name="1333245"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333245" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333245">(Feb 23 2022 at 04:41)</a>:</h4>
<p>All but the last 3 are not actually run in current <code>main</code> and can be addressed by effectively deleting the migrations (ideally using the <code>squashmigrations</code> system).</p>



<a name="1333246"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1333246" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1333246">(Feb 23 2022 at 04:43)</a>:</h4>
<p>What Django is warning about is that the migrations system is designed to use the format of models from a checkpoint in the migration sequence; so code in migrations will have an incompatible idea of the database model with the normal code. Calling code that happens to import <code>models.py</code> but whose behavior does not depend on the format of models is an abstraction violation, but will run without issue.</p>
<p>Ideally, we wouldn't have migrations like this, but sometimes it's the best way to avoid a great deal of extra work or copied code.</p>



<a name="1334579"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1334579" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1334579">(Feb 24 2022 at 22:32)</a>:</h4>
<p><span class="user-mention" data-user-id="21154">@Adam S</span> The <code>check-database-compatibility.py</code> problem you ran into is now fixed (<a href="https://github.com/zulip/zulip/pull/21220">#21220</a>).</p>



<a name="1337743"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1337743" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Sah <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1337743">(Mar 02 2022 at 14:23)</a>:</h4>
<p><span class="user-mention" data-user-id="699">@Anders Kaseorg</span>  confirmed - deployment worked.  <em>THANKS</em> !!!  cc <span class="user-mention" data-user-id="7">@Tim Abbott</span></p>



<a name="1337744"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20prod-static%20%3D%3E%20static%20%3F/near/1337744" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20prod-static.20.3D.3E.20static.20.3F.html#1337744">(Mar 02 2022 at 14:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="21154">Adam S</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>