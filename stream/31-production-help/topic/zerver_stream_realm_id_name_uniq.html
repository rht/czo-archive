<html>
<head><meta charset="utf-8"><title>zerver_stream_realm_id_name_uniq · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html">zerver_stream_realm_id_name_uniq</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1225972"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1225972" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1225972">(Jul 06 2021 at 19:20)</a>:</h4>
<p>When trying to upgrade from Docker image 3.1 to 4.0 I get the following error.</p>
<div class="codehilite"><pre><span></span><code>django.db.utils.IntegrityError: could not create unique index &quot;zerver_stream_realm_id_name_uniq&quot;
DETAIL:  Key (realm_id, upper(name::text))=(2, !DEACTIVATED:TEST) is duplicated.

  Applying zerver.0302_case_insensitive_stream_name_index...Zulip migration failed with exit code 1. Exiting.
</code></pre></div>



<a name="1225981"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1225981" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1225981">(Jul 06 2021 at 19:32)</a>:</h4>
<p>That says that your database got duplicated stream names somehow.  What's the upgrade history of this instance?  Has it had any manual changes to the database?</p>



<a name="1225986"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1225986" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1225986">(Jul 06 2021 at 19:34)</a>:</h4>
<p>Not that I know of, I'll ask our team as we have a developer that creates a custom image for us.</p>



<a name="1225990"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1225990" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1225990">(Jul 06 2021 at 19:37)</a>:</h4>
<p>:nod:  The fix is likely to adjust the stream names of the duplicates.  You can find out how wide-spread the issue is via running (by way of <code>./manage dbshell</code>):</p>
<div class="codehilite"><pre><span></span><code>select count(*), realm_id, upper(name) from zerver_stream group by 2, 3 having count(*) &gt; 1
</code></pre></div>
<p>It is likely that this is just that one deactivated "test" stream, but good to check.</p>



<a name="1229969"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229969" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229969">(Jul 12 2021 at 23:32)</a>:</h4>
<p>Was able to change one of the database entries and that fixed the problem.<br>
We now have a new issue as follows </p>
<div class="codehilite"><pre><span></span><code>zulip_1 | 2021-07-12 23:07:25,603 INFO success: process-fts-updates entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
zulip_1 | 2021-07-12 23:07:25,603 INFO exited: process-fts-updates (exit status 1; not expected
</code></pre></div>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> you wouldn't know how I can start troubleshooting this one</p>



<a name="1229970"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229970" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229970">(Jul 12 2021 at 23:34)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="9" href="/#narrow/stream/9-issues/topic/zerver_stream_realm_id_name_uniq">#issues &gt; zerver_stream_realm_id_name_uniq</a> by <span class="user-mention silent" data-user-id="12178">Alex Vandiver</span></p>



<a name="1229972"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229972" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229972">(Jul 12 2021 at 23:36)</a>:</h4>
<p>First off, your duplicate-row issue above was quite probably related to <a href="https://github.com/zulip/zulip/pull/18847">#18847</a> -- if you've not seen that, please take a gander.</p>
<p>For the process-fts-updates error, can you show <code>/var/log/zulip/fts-updates.log</code>?  I don't recall where that lives in the Docker equivalent, but I can look it up if you're not finding it.</p>



<a name="1229973"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229973" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229973">(Jul 12 2021 at 23:37)</a>:</h4>
<p>I'll have a look right now see if I can find it</p>



<a name="1229974"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229974" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229974">(Jul 12 2021 at 23:41)</a>:</h4>
<p>finding the following msg </p>
<div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;/usr/local/bin/process_fts_updates&quot;, line 168, in &lt;module&gt;
    conn = psycopg2.connect(**pg_args)
  File &quot;/usr/lib/python3/dist-packages/psycopg2/__init__.py&quot;, line 127, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: could not connect to server: No such file or directory
        Is the server running locally and accepting
        connections on Unix domain socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;?
</code></pre></div>
<p>odd looks like everything should be up</p>
<div class="codehilite"><pre><span></span><code>2bac6a7ffa77   zulip/zulip-postgresql                                    &quot;docker-entrypoint.s…&quot;   33 minutes ago   Up 33 minutes   5432/tcp                                   zulip-server_database_1
5a6b131d96fd   rabbitmq:3.7.7                                            &quot;docker-entrypoint.s…&quot;   33 minutes ago   Up 33 minutes   4369/tcp, 5671-5672/tcp, 25672/tcp         zulip-server_rabbitmq_1
2b90dc26bb3d   redis:alpine                                              &quot;docker-entrypoint.s…&quot;   33 minutes ago   Up 33 minutes   6379/tcp                                   zulip-server_redis_1
1de49b7d9d2e   memcached:alpine                                          &quot;docker-entrypoint.s…&quot;   33 minutes ago   Up 33 minutes   11211/tcp                                  zulip-server_memcached_1
e26693d0bbd1   zulip-server:v4.3.0.0   &quot;/sbin/entrypoint.sh…&quot;   33 minutes ago   Up 33 minutes   0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp   zulip-server_zulip_1
</code></pre></div>



<a name="1229981"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229981" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229981">(Jul 12 2021 at 23:50)</a>:</h4>
<p>It looks like it's trying to connect over the socket, not over the TCP port.  This is 4.x, not master?</p>



<a name="1229982"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229982" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229982">(Jul 12 2021 at 23:50)</a>:</h4>
<p>Ah, yeah, says 4.3.0</p>



<a name="1229988"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229988" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229988">(Jul 12 2021 at 23:59)</a>:</h4>
<p>Is there away to force it to use one or the other</p>



<a name="1229992"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229992" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229992">(Jul 13 2021 at 00:04)</a>:</h4>
<p>We changed how this logic works in master, but not in 4.3.  From my skim of the Docker code, it looks like it should be setting <code>REMOTE_POSTGRES_HOST = 127.0.0.1</code> in the <code>/etc/zulip/settings.py</code> that it builds in <code>entrypoint.sh</code>.</p>



<a name="1229994"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1229994" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1229994">(Jul 13 2021 at 00:05)</a>:</h4>
<p>Do you see any output to that effect when the <code>zulip-server</code> image starts up?</p>



<a name="1230006"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230006" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230006">(Jul 13 2021 at 00:14)</a>:</h4>
<p>I don't think that will work as the zulip-postgres container is separate from the zulip-server. I had it set to <code>REMOTE_POSTGRES_HOST = database</code><br>
I'll give it a shot though</p>



<a name="1230009"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230009" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230009">(Jul 13 2021 at 00:15)</a>:</h4>
<p>It certainly needs to be set to something that resolves.  You're right that in the docker-compose world., it's a separate host.</p>



<a name="1230010"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230010" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230010">(Jul 13 2021 at 00:15)</a>:</h4>
<p>So zulip-server container crashes right away as can't connect to database</p>



<a name="1230011"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230011" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230011">(Jul 13 2021 at 00:16)</a>:</h4>
<p>I'll flip it back</p>



<a name="1230014"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230014" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230014">(Jul 13 2021 at 00:16)</a>:</h4>
<p>any other suggestions ?</p>



<a name="1230016"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230016" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230016">(Jul 13 2021 at 00:17)</a>:</h4>
<p>The question is why process-fts-updates isn't correctly reading the config that is being written</p>



<a name="1230017"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230017" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230017">(Jul 13 2021 at 00:18)</a>:</h4>
<p>We can try dropping in a version that has some more debugging in it</p>



<a name="1230019"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230019" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230019">(Jul 13 2021 at 00:22)</a>:</h4>
<p>Try replacing <code>/usr/local/bin/process_fts_updates</code> with this version, which has a couple debugging statements in it:<br>
<a href="/user_uploads/2/dd/9-eVK1PRp9CPRWCLsEezc7ZA/process_fts_updates">process_fts_updates</a> </p>
<p>Alternately, the diff is:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git puppet/zulip/files/postgresql/process_fts_updates puppet/zulip/files/postgresql/process_fts_updates</span>
<span class="gh">index 8da1ae79a6..ababfd2bd3 100755</span>
<span class="gd">--- puppet/zulip/files/postgresql/process_fts_updates</span>
<span class="gi">+++ puppet/zulip/files/postgresql/process_fts_updates</span>
<span class="gu">@@ -95,7 +95,8 @@ try:</span>
     if settings.REMOTE_POSTGRES_PORT != "":
         pg_args["port"] = settings.REMOTE_POSTGRES_PORT
     USING_PGROONGA = settings.USING_PGROONGA
<span class="gd">-except ImportError:</span>
<span class="gi">+except ImportError as e:</span>
<span class="gi">+    logging.warning("Failed to import django settings: %s", e)</span>
     # process_fts_updates also supports running locally on a remote
     # PostgreSQL server; in that case, one can just connect to localhost
     USING_PGROONGA = False
<span class="gu">@@ -126,6 +127,8 @@ if "host" in pg_args:</span>
 else:
     pg_args["user"] = "zulip"

<span class="gi">+logging.warning("Got pg_args: %r", pg_args)</span>
<span class="gi">+</span>
 conn = None

 retries = 1
</code></pre></div>



<a name="1230022"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230022" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230022">(Jul 13 2021 at 00:23)</a>:</h4>
<p>okay try this in just abit , dinner time for me.</p>



<a name="1230082"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230082" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230082">(Jul 13 2021 at 03:17)</a>:</h4>
<p>Okay swapped out the <code>process_fts_updates</code> file by mounting the new one you gave me. When checking docker logs </p>
<div class="codehilite"><pre><span></span><code>=== Begin Initial Configuration Phase ===
Preparing and linking the uploads folder ...
Prepared and linked the uploads directory.
Executing nginx configuration ...
Nginx configuration succeeded.
Certificates configuration succeeded.
Auto backup enabled.
=== End Initial Configuration Phase ===
=== Begin Bootstrap Phase ===
Waiting for database server to allow connections ...
Wild Test
Executing Zulip first start init ...
First Start Init not needed. Continuing.
Migrating Zulip to new version ...
Operations to perform:
  Apply all migrations: analytics, auth, confirmation, contenttypes, otp_static, otp_totp, sessions, social_django, two_factor, zerver
Running migrations:
  No migrations to apply.
  Your models in app(s): &#39;zerver&#39; have changes that are not yet reflected in a migration, and so won&#39;t be applied.
  Run &#39;manage.py makemigrations&#39; to make new migrations, and then re-run &#39;manage.py migrate&#39; to apply them.
Zulip migration succeeded.
Post setup scripts execution ...
No post-setup.d folder found. Continuing.
=== End Bootstrap Phase ===
=== Begin Run Phase ===
Starting Zulip using supervisor with &quot;/etc/supervisor/supervisord.conf&quot; config ...

Certbot is not scheduled to run.
2021-07-13 03:13:52,671 CRIT Supervisor is running as root.  Privileges were not dropped because no user is specified in the config file.  If you intend to run as root, you can set user=root in the config file to avoid this message.
2021-07-13 03:13:52,671 WARN No file matches via include &quot;/etc/supervisor/conf.d/*.conf&quot;
2021-07-13 03:13:52,671 INFO Included extra file &quot;/etc/supervisor/conf.d/zulip/cron.conf&quot; during parsing
2021-07-13 03:13:52,671 INFO Included extra file &quot;/etc/supervisor/conf.d/zulip/nginx.conf&quot; during parsing
2021-07-13 03:13:52,671 INFO Included extra file &quot;/etc/supervisor/conf.d/zulip/zulip-once.conf&quot; during parsing
2021-07-13 03:13:52,671 INFO Included extra file &quot;/etc/supervisor/conf.d/zulip/zulip.conf&quot; during parsing
2021-07-13 03:13:52,671 INFO Included extra file &quot;/etc/supervisor/conf.d/zulip/zulip_db.conf&quot; during parsing
2021-07-13 03:13:52,697 INFO RPC interface &#39;supervisor&#39; initialized
2021-07-13 03:13:52,698 CRIT Server &#39;unix_http_server&#39; running without any HTTP authentication checking
2021-07-13 03:13:52,698 INFO supervisord started with pid 1
2021-07-13 03:13:53,701 INFO spawned: &#39;zulip-django&#39; with pid 28
2021-07-13 03:13:53,703 INFO spawned: &#39;zulip-tornado&#39; with pid 29
2021-07-13 03:13:53,706 INFO spawned: &#39;process-fts-updates&#39; with pid 30
2021-07-13 03:13:53,715 INFO spawned: &#39;cron&#39; with pid 31
2021-07-13 03:13:53,719 INFO spawned: &#39;nginx&#39; with pid 32
2021-07-13 03:13:53,733 INFO spawned: &#39;zulip_deliver_scheduled_emails&#39; with pid 33
2021-07-13 03:13:53,743 INFO spawned: &#39;zulip_deliver_scheduled_messages&#39; with pid 34
2021-07-13 03:13:53,755 INFO spawned: &#39;zulip_events_deferred_work&#39; with pid 35
2021-07-13 03:13:53,785 INFO spawned: &#39;zulip_events_digest_emails&#39; with pid 36
2021-07-13 03:13:53,796 INFO spawned: &#39;zulip_events_email_mirror&#39; with pid 37
2021-07-13 03:13:53,800 INFO spawned: &#39;zulip_events_embed_links&#39; with pid 38
2021-07-13 03:13:53,832 INFO spawned: &#39;zulip_events_embedded_bots&#39; with pid 39
2021-07-13 03:13:53,836 INFO spawned: &#39;zulip_events_error_reports&#39; with pid 40
2021-07-13 03:13:53,880 INFO spawned: &#39;zulip_events_invites&#39; with pid 41
2021-07-13 03:13:53,916 INFO spawned: &#39;zulip_events_email_senders&#39; with pid 42
2021-07-13 03:13:53,967 INFO spawned: &#39;zulip_events_missedmessage_emails&#39; with pid 43
2021-07-13 03:13:54,056 INFO spawned: &#39;zulip_events_missedmessage_mobile_notifications&#39; with pid 44
2021-07-13 03:13:54,060 INFO spawned: &#39;zulip_events_outgoing_webhooks&#39; with pid 45
2021-07-13 03:13:54,116 INFO spawned: &#39;zulip_events_user_activity&#39; with pid 46
2021-07-13 03:13:54,168 INFO spawned: &#39;zulip_events_user_activity_interval&#39; with pid 47
2021-07-13 03:13:54,220 INFO spawned: &#39;zulip_events_user_presence&#39; with pid 48
2021-07-13 03:13:54,272 INFO reaped unknown pid 26
2021-07-13 03:13:55,282 INFO success: zulip-django entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,282 INFO success: zulip-tornado entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,282 INFO success: process-fts-updates entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,282 INFO success: cron entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,282 INFO success: nginx entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,282 INFO success: zulip_deliver_scheduled_emails entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,282 INFO success: zulip_deliver_scheduled_messages entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,283 INFO success: zulip_events_deferred_work entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,283 INFO success: zulip_events_digest_emails entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,283 INFO success: zulip_events_email_mirror entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,283 INFO success: zulip_events_embed_links entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,283 INFO success: zulip_events_embedded_bots entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,283 INFO success: zulip_events_error_reports entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,283 INFO success: zulip_events_invites entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,283 INFO success: zulip_events_email_senders entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,284 INFO success: zulip_events_missedmessage_emails entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,284 INFO success: zulip_events_missedmessage_mobile_notifications entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,284 INFO success: zulip_events_outgoing_webhooks entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,284 INFO success: zulip_events_user_activity entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,284 INFO success: zulip_events_user_activity_interval entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2021-07-13 03:13:55,284 INFO success: zulip_events_user_presence entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
</code></pre></div>



<a name="1230094"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230094" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230094">(Jul 13 2021 at 03:41)</a>:</h4>
<p>Also noticed this in the error.log</p>
<div class="codehilite"><pre><span></span><code>2021-07-13 03:38:07.505 ERR  [django.request] Internal Server Error: /login/
Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/5a025c2397f3097648d641486caebf5ac226f263/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/exception.py&quot;, line 47, in inner
    response = get_response(request)
  File &quot;/srv/zulip-venv-cache/5a025c2397f3097648d641486caebf5ac226f263/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py&quot;, line 181, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;./zerver/lib/request.py&quot;, line 390, in _wrapped_view_func
    return view_func(request, *args, **kwargs)
  File &quot;./zerver/views/auth.py&quot;, line 757, in login_page
    extra_context.update(login_context(request))
  File &quot;./zerver/context_processors.py&quot;, line 187, in login_context
    realm_description = get_realm_rendered_description(realm)
  File &quot;./zerver/lib/cache.py&quot;, line 204, in func_with_caching
    val = func(*args, **kwargs)
  File &quot;./zerver/lib/realm_description.py&quot;, line 14, in get_realm_rendered_description
    return markdown_convert(realm_description_raw, message_realm=realm, no_previews=True)
  File &quot;./zerver/lib/markdown/__init__.py&quot;, line 2681, in markdown_convert
    ret = do_convert(
  File &quot;./zerver/lib/markdown/__init__.py&quot;, line 2560, in do_convert
    maybe_update_markdown_engines(linkifiers_key, email_gateway)
  File &quot;./zerver/lib/markdown/__init__.py&quot;, line 2370, in maybe_update_markdown_engines
    linkifiers = linkifiers_for_realm(linkifiers_key)
  File &quot;./zerver/models.py&quot;, line 964, in linkifiers_for_realm
    per_request_linkifiers_cache[realm_id] = linkifiers_for_realm_remote_cache(realm_id)
  File &quot;./zerver/lib/cache.py&quot;, line 181, in func_with_caching
    val = cache_get(key, cache_name=cache_name)
  File &quot;./zerver/lib/cache.py&quot;, line 263, in cache_get
    ret = cache_backend.get(final_key)
  File &quot;/srv/zulip-venv-cache/5a025c2397f3097648d641486caebf5ac226f263/zulip-py3-venv/lib/python3.8/site-packages/django/core/cache/backends/memcached.py&quot;, line 77, in get
    return self._cache.get(key, default)
  File &quot;/srv/zulip-venv-cache/5a025c2397f3097648d641486caebf5ac226f263/zulip-py3-venv/lib/python3.8/site-packages/bmemcached/client/replicating.py&quot;, line 43, in get
    value, cas = server.get(key)
  File &quot;/srv/zulip-venv-cache/5a025c2397f3097648d641486caebf5ac226f263/zulip-py3-venv/lib/python3.8/site-packages/bmemcached/protocol.py&quot;, line 451, in get
    raise MemcachedException(&#39;Code: %d Message: %s&#39; % (status, extra_content), status)
bmemcached.exceptions.MemcachedException: (&quot;Code: 32 Message: b&#39;Auth failure.&#39;&quot;, 32)
</code></pre></div>



<a name="1230319"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230319" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230319">(Jul 13 2021 at 16:20)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> I tried this morning also REINDEX the database but got the following again</p>
<div class="codehilite"><pre><span></span><code>zulip=# REINDEX DATABASE zulip;
ERROR:  could not create unique index &quot;zerver_useractivity_user_profile_id_client_i_7a77114d_uniq&quot;
DETAIL:  Key (user_profile_id, client_id, query)=(26, 8, /api/v1/fetch_api_key) is duplicated.
</code></pre></div>



<a name="1230320"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230320" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230320">(Jul 13 2021 at 16:22)</a>:</h4>
<p>The updated debug logging would show up in <code>/var/log/zulip/fts-updates.log</code>.  But it seems not able that memcached is _also_ having auth problems, which is essentially what process-fts-updates is having.  Has anything changed about your secrets or configuration file?</p>



<a name="1230321"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230321" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230321">(Jul 13 2021 at 16:25)</a>:</h4>
<p>Yeah, it's expected that a <code>REINDEX</code> may turn up duplicates if you fell prey to <a href="https://github.com/zulip/zulip/pull/18847">#18847</a>.  <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span>  Unfortunately, there's no magic bullet for those -- you'll need to resolve them by hand.  For that one, you can remove the duplicated row.</p>



<a name="1230623"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1230623" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1230623">(Jul 13 2021 at 23:22)</a>:</h4>
<p>I haven't changed secrets at all just the docker zulip-server image from 3.x to 4.x</p>



<a name="1231173"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1231173" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1231173">(Jul 14 2021 at 19:49)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> I went through and changed duplicated names to ?test at the end. Also REINDEX the database which now pass. Still getting "Internal server error"</p>



<a name="1231225"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1231225" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1231225">(Jul 14 2021 at 20:32)</a>:</h4>
<p>The reindex is a separate problem from the server errors.  I'm glad we've got that solved.</p>
<p>Can you show the contents of <code>/var/log/zulip/fts-updates.log</code> which should have the updated logging?</p>



<a name="1235068"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1235068" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1235068">(Jul 20 2021 at 21:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq/near/1231225">said</a>:</p>
<blockquote>
<p>The reindex is a separate problem from the server errors.  I'm glad we've got that solved.</p>
<p>Can you show the contents of <code>/var/log/zulip/fts-updates.log</code> which should have the updated logging?</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>2021-07-13 23:43:40,158 WARNING: Got pg_args: {&#39;host&#39;: &#39;database&#39;, &#39;password&#39;: &#39;xxxxxxxxxxxxx&#39;, &#39;user&#39;: &#39;zulip&#39;, &#39;dbname&#39;: &#39;zulip&#39;, &#39;sslmode&#39;: &#39;prefer&#39;, &#39;connect_timeout&#39;: &#39;600&#39;}
2021-07-13 23:43:40,162 DEBUG: process_fts_updates: listening for search index updates
2021-07-13 23:43:40,164 DEBUG: process_fts_updates: Processed 0 rows catching up
2021-07-14 03:31:48,208 WARNING: Got pg_args: {&#39;host&#39;: &#39;database&#39;, &#39;password&#39;: &#39;xxxxxxxxxx&#39;, &#39;user&#39;: &#39;zulip&#39;, &#39;dbname&#39;: &#39;zulip&#39;, &#39;sslmode&#39;: &#39;prefer&#39;, &#39;connect_timeout&#39;: &#39;600&#39;}
2021-07-14 03:31:48,225 DEBUG: process_fts_updates: listening for search index updates
2021-07-14 03:31:48,227 DEBUG: process_fts_updates: Processed 0 rows catching up
2021-07-14 19:44:58,933 WARNING: Got pg_args: {&#39;host&#39;: &#39;database&#39;, &#39;password&#39;: &#39;xxxxxxxxxxxxxxxx&#39;, &#39;user&#39;: &#39;zulip&#39;, &#39;dbname&#39;: &#39;zulip&#39;, &#39;sslmode&#39;: &#39;prefer&#39;, &#39;connect_timeout&#39;: &#39;600&#39;}
2021-07-14 19:44:58,942 DEBUG: process_fts_updates: listening for search index updates
2021-07-14 19:44:58,944 DEBUG: process_fts_updates: Processed 0 rows catching up
2021-07-18 06:01:19,800 WARNING: Got pg_args: {&#39;host&#39;: &#39;database&#39;, &#39;password&#39;: &#39;xxxxxxxxxxxxxx&#39;, &#39;user&#39;: &#39;zulip&#39;, &#39;dbname&#39;: &#39;zulip&#39;, &#39;sslmode&#39;: &#39;prefer&#39;, &#39;connect_timeout&#39;: &#39;600&#39;}
2021-07-18 06:01:19,813 DEBUG: process_fts_updates: listening for search index updates
2021-07-18 06:01:19,815 DEBUG: process_fts_updates: Processed 0 rows catching up
</code></pre></div>



<a name="1235072"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1235072" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1235072">(Jul 20 2021 at 21:38)</a>:</h4>
<p>I know username and password are correct</p>



<a name="1235077"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1235077" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1235077">(Jul 20 2021 at 21:44)</a>:</h4>
<p>Looks like attached to the same network </p>
<div class="codehilite"><pre><span></span><code>docker network inspect zulip-server_default -f &quot;{{json .Containers }}&quot;
{&quot;2b085de620c3c35a2a12dd78155d25c3a1579da3c8fb2ea3be2a7d04db6edaf8&quot;:{&quot;Name&quot;:&quot;zulip-server_zulip_1&quot;,&quot;EndpointID&quot;:&quot;e4ac8d9d6b14aebb0a9adaf0090f8d64a2a2496e6e7b568f6dc15391734eb17a&quot;,&quot;MacAddress&quot;:&quot;02:42:ac:1c:00:04&quot;,&quot;IPv4Address&quot;:&quot;172.28.0.4/16&quot;,&quot;IPv6Address&quot;:&quot;&quot;},&quot;2f6259b16ceb992cc1ee689da9afb9ce877bd7ff4d0bca4b6ff5a31b524e9e43&quot;:{&quot;Name&quot;:&quot;zulip-server_database_1&quot;,&quot;EndpointID&quot;:&quot;4c7c11b905a0abd7fa688d64631df0db6b668fd93043b37c649dedd24729daab&quot;,&quot;MacAddress&quot;:&quot;02:42:ac:1c:00:05&quot;,&quot;IPv4Address&quot;:&quot;172.28.0.5/16&quot;,&quot;IPv6Address&quot;:&quot;&quot;},&quot;47cf0362bac862380710c68d3564da0fbcd0085f9e30424ec40919e2b37caa53&quot;:{&quot;Name&quot;:&quot;zulip-server_memcached_1&quot;,&quot;EndpointID&quot;:&quot;dabd68b769bb56d5ea0da3233ba9c8db16457be7cbab54a8a117645da91fecd4&quot;,&quot;MacAddress&quot;:&quot;02:42:ac:1c:00:02&quot;,&quot;IPv4Address&quot;:&quot;172.28.0.2/16&quot;,&quot;IPv6Address&quot;:&quot;&quot;},&quot;4e4741e11c0b6ec8420f00fab96f8a7beabe5a0fddcd0972c6a129b50c40fb80&quot;:{&quot;Name&quot;:&quot;zulip-server_redis_1&quot;,&quot;EndpointID&quot;:&quot;4d5bae85cfeb2a2c0f08b76ab5dd75ac5a47de16a172d78a78e1252d75a35e91&quot;,&quot;MacAddress&quot;:&quot;02:42:ac:1c:00:03&quot;,&quot;IPv4Address&quot;:&quot;172.28.0.3/16&quot;,&quot;IPv6Address&quot;:&quot;&quot;},&quot;7b84927738eeb9d9c013e1f514f6ff6dd9786c8d0c4256ca6424cd5a82e8457a&quot;:{&quot;Name&quot;:&quot;zulip-server_rabbitmq_1&quot;,&quot;EndpointID&quot;:&quot;d776e57900ea4adfd16879b09fd9a096e02d5ef39fc47d1c10387c1cdf35e232&quot;,&quot;MacAddress&quot;:&quot;02:42:ac:1c:00:06&quot;,&quot;IPv4Address&quot;:&quot;172.28.0.6/16&quot;,&quot;IPv6Address&quot;:&quot;&quot;}}
</code></pre></div>



<a name="1235081"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1235081" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1235081">(Jul 20 2021 at 21:46)</a>:</h4>
<p>Ran test from within zulip container </p>
<div class="codehilite"><pre><span></span><code>root@2b085de620c3:/# psql -h database -U zulip
Password for user zulip:
psql (13.3 (Ubuntu 13.3-1.pgdg20.04+1), server 10.11)
Type &quot;help&quot; for help.

zulip=# \l
                                 List of databases
   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges
-----------+----------+----------+------------+------------+-----------------------
 postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
           |          |          |            |            | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
           |          |          |            |            | postgres=CTc/postgres
 zulip     | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
(4 rows)
</code></pre></div>



<a name="1235082"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1235082" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blair MacInnis <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1235082">(Jul 20 2021 at 21:47)</a>:</h4>
<p>So its able to connect and see.</p>



<a name="1235125"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1235125" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1235125">(Jul 20 2021 at 22:23)</a>:</h4>
<p>Well, it was previously giving the error:</p>
<div class="codehilite"><pre><span></span><code>psycopg2.OperationalError: could not connect to server: No such file or directory
        Is the server running locally and accepting
        connections on Unix domain socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;?
</code></pre></div>
<p>..so it looks like something has improved and <code>process-fts-updatres</code> is happily connecting to the database now.</p>
<p>Are you still seeing internal server errors?</p>



<a name="1235126"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver_stream_realm_id_name_uniq/near/1235126" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver_stream_realm_id_name_uniq.html#1235126">(Jul 20 2021 at 22:23)</a>:</h4>
<p>Those logs in <code>/var/log/zulip/fts-updates.log</code> look like I would expect for it running successfully.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>