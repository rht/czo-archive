<html>
<head><meta charset="utf-8"><title>Upgrade from git failed · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html">Upgrade from git failed</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1224709"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1224709" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1224709">(Jul 03 2021 at 21:09)</a>:</h4>
<div class="codehilite"><pre><span></span><code>root@chat:/home/zulip/deployments/current# /home/zulip/deployments/current/scripts/upgrade-zulip-from-git master
2021-07-03 21:01:47,462 upgrade-zulip-from-git: Cloning the repository
2021-07-03 21:02:15,288 upgrade-zulip-from-git: Fetching the latest commits
2021-07-03 21:02:17,715 upgrade-zulip-stage-2: Upgrading system packages...
Hit:1 http://ppa.launchpad.net/groonga/ppa/ubuntu focal InRelease
Hit:2 http://apt.postgresql.org/pub/repos/apt focal-pgdg InRelease
Hit:3 http://archive.ubuntu.com/ubuntu focal InRelease
Get:4 http://archive.ubuntu.com/ubuntu focal-updates InRelease [114 kB]
Get:5 http://archive.ubuntu.com/ubuntu focal-backports InRelease [101 kB]
Get:6 http://security.ubuntu.com/ubuntu focal-security InRelease [114 kB]
Hit:7 https://packages.groonga.org/ubuntu focal InRelease
Fetched 328 kB in 1s (254 kB/s)
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
Calculating upgrade...
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
+ apt-get -y install build-essential libffi-dev libfreetype6-dev zlib1g-dev libjpeg-dev libldap2-dev python3-dev python3-pip virtualenv libxml2-dev libxslt1-dev libpq-dev libssl-dev libmagic1 libyaml-dev libxmlsec1-dev pkg-config jq libsasl2-dev
Reading package lists...
Building dependency tree...
Reading state information...
libffi-dev is already the newest version (3.3-4).
libjpeg-dev is already the newest version (8c-2ubuntu8).
libmagic1 is already the newest version (1:5.38-4).
libsasl2-dev is already the newest version (2.1.27+dfsg-2).
libxmlsec1-dev is already the newest version (1.2.28-2).
libxslt1-dev is already the newest version (1.1.34-4).
libyaml-dev is already the newest version (0.2.2-1).
pkg-config is already the newest version (0.29.1-0ubuntu4).
python3-dev is already the newest version (3.8.2-0ubuntu2).
build-essential is already the newest version (12.8ubuntu1.1).
libfreetype6-dev is already the newest version (2.10.1-2ubuntu0.1).
libldap2-dev is already the newest version (2.4.49+dfsg-2ubuntu1.8).
libssl-dev is already the newest version (1.1.1f-1ubuntu2.4).
libxml2-dev is already the newest version (2.9.10+dfsg-5ubuntu0.20.04.1).
zlib1g-dev is already the newest version (1:1.2.11.dfsg-2ubuntu1.2).
jq is already the newest version (1.6-1ubuntu0.20.04.1).
python3-pip is already the newest version (20.0.2-5ubuntu1.5).
virtualenv is already the newest version (20.0.17-1ubuntu0.4).
libpq-dev is already the newest version (13.3-1.pgdg20.04+1).
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
+ rm -rf /srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv
+ mkdir -p /srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv
+ virtualenv -p python3 /srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv
created virtual environment CPython3.8.10.final.0-64 in 123ms
  creator CPython3Posix(dest=/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv, clear=False, global=False)
  seeder FromAppData(download=False, pip=latest, setuptools=latest, wheel=latest, pkg_resources=latest, via=copy, app_data_dir=/root/.local/share/virtualenv/seed-app-data/v1.0.1.debian.1)
  activators BashActivator,CShellActivator,FishActivator,PowerShellActivator,PythonActivator,XonshActivator
+ chown -R 0:0 /srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv
+ /srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/bin/pip install --force-reinstall --require-hashes -r /home/zulip/deployments/2021-07-03-21-01-47/requirements/pip.txt
Collecting wheel==0.36.2
  Using cached wheel-0.36.2-py2.py3-none-any.whl (35 kB)
Collecting pip==20.3.4
  Using cached pip-20.3.4-py2.py3-none-any.whl (1.5 MB)
Collecting setuptools==57.0.0
  Using cached setuptools-57.0.0-py3-none-any.whl (821 kB)
Installing collected packages: wheel, pip, setuptools
  Attempting uninstall: wheel
    Found existing installation: wheel 0.34.2
    Uninstalling wheel-0.34.2:
      Successfully uninstalled wheel-0.34.2
  Attempting uninstall: pip
    Found existing installation: pip 20.0.2
    Uninstalling pip-20.0.2:
      Successfully uninstalled pip-20.0.2
  Attempting uninstall: setuptools
    Found existing installation: setuptools 44.0.0
    Uninstalling setuptools-44.0.0:
      Successfully uninstalled setuptools-44.0.0
Successfully installed pip-20.3.4 setuptools-57.0.0 wheel-0.36.2
+ /srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/bin/pip install --use-deprecated=legacy-resolver --no-deps --require-hashes -r /home/zulip/deployments/2021-07-03-21-01-47/requirements/prod.txt
Ignoring dataclasses: markers &#39;python_version &lt; &quot;3.7&quot;&#39; don&#39;t match your environment
Ignoring importlib-metadata: markers &#39;python_version &lt; &quot;3.8&quot;&#39; don&#39;t match your environment
Collecting apns2==0.7.2
  Using cached apns2-0.7.2-py2.py3-none-any.whl (10.0 kB)
Collecting argon2-cffi==20.1.0
  Using cached argon2_cffi-20.1.0-cp35-abi3-manylinux1_x86_64.whl (97 kB)
Collecting asgiref==3.3.4
  Using cached asgiref-3.3.4-py3-none-any.whl (22 kB)
Collecting attrs==21.2.0
  Using cached attrs-21.2.0-py2.py3-none-any.whl (53 kB)
Collecting backcall==0.2.0
  Using cached backcall-0.2.0-py2.py3-none-any.whl (11 kB)
Collecting backoff==1.10.0
  Using cached backoff-1.10.0-py2.py3-none-any.whl (31 kB)
Collecting beautifulsoup4==4.9.3
  Using cached beautifulsoup4-4.9.3-py3-none-any.whl (115 kB)
Collecting boto3==1.17.89
  Downloading boto3-1.17.89-py2.py3-none-any.whl (131 kB)
Collecting botocore==1.20.89
  Downloading botocore-1.20.89-py2.py3-none-any.whl (7.6 MB)
Collecting cachetools==4.2.2
  Using cached cachetools-4.2.2-py3-none-any.whl (11 kB)
Collecting cchardet==2.1.7
  Using cached cchardet-2.1.7-cp38-cp38-manylinux2010_x86_64.whl (265 kB)
Collecting certifi==2021.5.30
  Downloading certifi-2021.5.30-py2.py3-none-any.whl (145 kB)
Collecting cffi==1.14.5
  Using cached cffi-1.14.5-cp38-cp38-manylinux1_x86_64.whl (411 kB)
Collecting chardet==4.0.0
  Using cached chardet-4.0.0-py2.py3-none-any.whl (178 kB)
Collecting cryptography==3.4.7
  Using cached cryptography-3.4.7-cp36-abi3-manylinux2014_x86_64.whl (3.2 MB)
Collecting cssselect==1.1.0
  Using cached cssselect-1.1.0-py2.py3-none-any.whl (16 kB)
Collecting cssutils==2.3.0
  Downloading cssutils-2.3.0-py3-none-any.whl (404 kB)
Collecting decorator==5.0.9
  Downloading decorator-5.0.9-py3-none-any.whl (8.9 kB)
Collecting defusedxml==0.6.0
  Using cached defusedxml-0.6.0-py2.py3-none-any.whl (23 kB)
Collecting dictpath==0.1.3
  Downloading dictpath-0.1.3-py3-none-any.whl (8.4 kB)
Collecting disposable-email-domains==0.0.65
  Downloading disposable_email_domains-0.0.65-py2.py3-none-any.whl (21 kB)
Collecting distro==1.5.0
  Using cached distro-1.5.0-py2.py3-none-any.whl (18 kB)
Collecting django-auth-ldap==2.0.0zulip1
  Using cached https://github.com/zulip/django-auth-ldap/archive/e26d0ef2a7ff77ab3fdd7b6578a76081f780778c.zip (66 kB)
  WARNING: Requested django-auth-ldap==2.0.0zulip1 from https://github.com/zulip/django-auth-ldap/archive/e26d0ef2a7ff77ab3fdd7b6578a76081f780778c.zip#egg=django-auth-ldap==2.0.0zulip1 (from -r /home/zulip/deployments/2021-07-03-21-01-47/requirements/prod.txt (line 237)), but installing version 2.0.0
Collecting django-bitfield==2.1.0
  Downloading django_bitfield-2.1.0-py2.py3-none-any.whl (18 kB)
Collecting django-bmemcached==0.3.0
  Using cached django-bmemcached-0.3.0.tar.gz (3.0 kB)
Collecting django-formtools==2.3
  Using cached django_formtools-2.3-py3-none-any.whl (148 kB)
Collecting django-otp==1.0.6
  Downloading django_otp-1.0.6-py3-none-any.whl (58 kB)
Collecting django-phonenumber-field==5.2.0
  Downloading django_phonenumber_field-5.2.0-py3-none-any.whl (60 kB)
Collecting django-sendfile2==0.6.0
  Using cached django-sendfile2-0.6.0.tar.gz (23 kB)
Collecting django-statsd-mozilla==0.4.0
  Using cached django_statsd_mozilla-0.4.0-py3-none-any.whl (18 kB)
Collecting django-two-factor-auth[call,phonenumberslite,sms]==1.13.1
  Using cached django_two_factor_auth-1.13.1-py2.py3-none-any.whl (197 kB)
Collecting django[argon2]==3.2.4
  Downloading Django-3.2.4-py3-none-any.whl (7.9 MB)
Collecting ecdsa==0.17.0
  Downloading ecdsa-0.17.0-py2.py3-none-any.whl (119 kB)
Collecting future==0.18.2
  Using cached future-0.18.2.tar.gz (829 kB)
Collecting h2==2.6.2
  Using cached h2-2.6.2-py2.py3-none-any.whl (71 kB)
Collecting hpack==3.0.0
  Using cached hpack-3.0.0-py2.py3-none-any.whl (38 kB)
Collecting html2text==2020.1.16
  Using cached html2text-2020.1.16-py3-none-any.whl (32 kB)
Collecting html5lib==1.1
  Using cached html5lib-1.1-py2.py3-none-any.whl (112 kB)
Collecting hyper==0.7.0
  Using cached hyper-0.7.0-py2.py3-none-any.whl (269 kB)
Collecting hyperframe==3.2.0
  Using cached hyperframe-3.2.0-py2.py3-none-any.whl (13 kB)
Collecting idna==2.10
  Using cached idna-2.10-py2.py3-none-any.whl (58 kB)
Collecting ipython-genutils==0.2.0
  Using cached ipython_genutils-0.2.0-py2.py3-none-any.whl (26 kB)
Collecting ipython==7.16.1
  Using cached ipython-7.16.1-py3-none-any.whl (785 kB)
Collecting isodate==0.6.0
  Using cached isodate-0.6.0-py2.py3-none-any.whl (45 kB)
Collecting jedi==0.17.2
  Using cached jedi-0.17.2-py2.py3-none-any.whl (1.4 MB)
Collecting jinja2==3.0.1
  Downloading Jinja2-3.0.1-py3-none-any.whl (133 kB)
Collecting jmespath==0.10.0
  Using cached jmespath-0.10.0-py2.py3-none-any.whl (24 kB)
Collecting jsonref==0.2
  Using cached jsonref-0.2-py3-none-any.whl (9.3 kB)
Collecting jsonschema==3.2.0
  Using cached jsonschema-3.2.0-py2.py3-none-any.whl (56 kB)
Collecting jsx-lexer==1.0.0
  Using cached jsx_lexer-1.0.0-py2.py3-none-any.whl (3.9 kB)
Collecting lazy-object-proxy==1.6.0
  Using cached lazy_object_proxy-1.6.0-cp38-cp38-manylinux1_x86_64.whl (58 kB)
Collecting lxml==4.6.3
  Using cached lxml-4.6.3-cp38-cp38-manylinux2014_x86_64.whl (6.8 MB)
Collecting markdown-include==0.6.0
  Using cached markdown-inc
</code></pre></div>



<a name="1224710"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1224710" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1224710">(Jul 03 2021 at 21:09)</a>:</h4>
<div class="codehilite" data-code-language="operations"><pre><span></span><code>  Apply all migrations: analytics, auth, confirmation, contenttypes, otp_static, otp_totp, sessions, social_django, two_factor, zerver
Running migrations:
  Applying zerver.0326_alter_realm_authentication_methods... OK
  Applying zerver.0327_realm_edit_topic_policy... OK
  Applying zerver.0328_migrate_to_edit_topic_policy... OK
  Applying zerver.0329_remove_realm_allow_community_topic_editing... OK
  Applying zerver.0330_linkifier_pattern_validator... OK
2021-07-03 21:05:21,734 upgrade-zulip-stage-2: Restarting Zulip...
2021-07-03 21:05:21,775 restart-server: Filling memcached caches
2021-07-03 21:05:23.156 INFO [] Successfully populated user cache!  Consumed 1 remote cache queries (0.01 time)
2021-07-03 21:05:23.158 INFO [] Successfully populated client cache!  Consumed 1 remote cache queries (0.0 time)
2021-07-03 21:05:23.162 INFO [] Successfully populated stream cache!  Consumed 1 remote cache queries (0.0 time)
2021-07-03 21:05:23.163 INFO [] Successfully populated huddle cache!  Consumed 1 remote cache queries (0.0 time)
2021-07-03 21:05:23.165 INFO [] Successfully populated session cache!  Consumed 1 remote cache queries (0.0 time)
2021-07-03 21:05:23,529 restart-server: Restarting zulip-workers:zulip_deliver_scheduled_emails
2021-07-03 21:05:24,673 restart-server: Restarting zulip-workers:zulip_deliver_scheduled_messages
2021-07-03 21:05:25,820 restart-server: Restarting zulip-workers:zulip_events_deferred_work
2021-07-03 21:05:26,965 restart-server: Restarting zulip-workers:zulip_events_digest_emails
2021-07-03 21:05:28,338 restart-server: Restarting zulip-workers:zulip_events_email_mirror
2021-07-03 21:05:29,490 restart-server: Restarting zulip-workers:zulip_events_email_senders
2021-07-03 21:05:30,870 restart-server: Restarting zulip-workers:zulip_events_embed_links
2021-07-03 21:05:32,015 restart-server: Restarting zulip-workers:zulip_events_embedded_bots
2021-07-03 21:05:33,356 restart-server: Restarting zulip-workers:zulip_events_error_reports
2021-07-03 21:05:34,538 restart-server: Restarting zulip-workers:zulip_events_invites
2021-07-03 21:05:35,855 restart-server: Restarting zulip-workers:zulip_events_missedmessage_emails
2021-07-03 21:05:37,093 restart-server: Restarting zulip-workers:zulip_events_missedmessage_mobile_notifications
2021-07-03 21:05:38,372 restart-server: Restarting zulip-workers:zulip_events_outgoing_webhooks
2021-07-03 21:05:39,629 restart-server: Restarting zulip-workers:zulip_events_user_activity
2021-07-03 21:05:40,900 restart-server: Restarting zulip-workers:zulip_events_user_activity_interval
2021-07-03 21:05:42,113 restart-server: Restarting zulip-workers:zulip_events_user_presence
2021-07-03 21:05:43,355 restart-server: Restarting zulip_deliver_scheduled_emails
Traceback (most recent call last):
  File "./scripts/restart-server", line 113, in &lt;module&gt;
    subprocess.check_call(["supervisorctl", "restart", worker])
  File "/usr/lib/python3.8/subprocess.py", line 364, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command '['supervisorctl', 'restart', 'zulip_deliver_scheduled_emails']' returned non-zero exit status 1.
Traceback (most recent call last):
  File "/home/zulip/deployments/2021-07-03-21-01-47/scripts/lib/upgrade-zulip-stage-2", line 309, in &lt;module&gt;
    subprocess.check_output(["./scripts/restart-server", "--fill-cache"], preexec_fn=su_to_zulip)
  File "/usr/lib/python3.8/subprocess.py", line 415, in check_output
    return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,
  File "/usr/lib/python3.8/subprocess.py", line 516, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command '['./scripts/restart-server', '--fill-cache']' returned non-zero exit status 1.
root@chat:/home/zulip/deployments/current#```
</code></pre></div>



<a name="1224712"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1224712" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1224712">(Jul 03 2021 at 21:13)</a>:</h4>
<p>when runned a second time,</p>



<a name="1224713"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1224713" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1224713">(Jul 03 2021 at 21:13)</a>:</h4>
<p>root@chat:/home/zulip/deployments/current# /home/zulip/deployments/current/scripts/upgrade-zulip-from-git master<br>
2021-07-03 21:11:13,133 upgrade-zulip-from-git: Fetching the latest commits<br>
2021-07-03 21:11:15,351 upgrade-zulip-stage-2: Upgrading system packages...<br>
Hit:1 <a href="http://archive.ubuntu.com/ubuntu">http://archive.ubuntu.com/ubuntu</a> focal InRelease<br>
Hit:2 <a href="http://archive.ubuntu.com/ubuntu">http://archive.ubuntu.com/ubuntu</a> focal-updates InRelease<br>
Hit:3 <a href="http://archive.ubuntu.com/ubuntu">http://archive.ubuntu.com/ubuntu</a> focal-backports InRelease<br>
Hit:4 <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> focal-security InRelease<br>
Hit:5 <a href="http://ppa.launchpad.net/groonga/ppa/ubuntu">http://ppa.launchpad.net/groonga/ppa/ubuntu</a> focal InRelease<br>
Hit:6 <a href="http://apt.postgresql.org/pub/repos/apt">http://apt.postgresql.org/pub/repos/apt</a> focal-pgdg InRelease<br>
Hit:7 <a href="https://packages.groonga.org/ubuntu">https://packages.groonga.org/ubuntu</a> focal InRelease<br>
Reading package lists...<br>
Reading package lists...<br>
Building dependency tree...<br>
Reading state information...<br>
Calculating upgrade...<br>
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.</p>
<ul>
<li>
<p>apt-get -y install build-essential libffi-dev libfreetype6-dev zlib1g-dev libjpeg-dev libldap2-dev python3-dev python3-pip virtualenv libxml2-dev libxslt1-dev libpq-dev libssl-dev libmagic1 libyaml-dev libxmlsec1-dev pkg-config jq libsasl2-dev<br>
Reading package lists...<br>
Building dependency tree...<br>
Reading state information...<br>
libffi-dev is already the newest version (3.3-4).<br>
libjpeg-dev is already the newest version (8c-2ubuntu8).<br>
libmagic1 is already the newest version (1:5.38-4).<br>
libsasl2-dev is already the newest version (2.1.27+dfsg-2).<br>
libxmlsec1-dev is already the newest version (1.2.28-2).<br>
libxslt1-dev is already the newest version (1.1.34-4).<br>
libyaml-dev is already the newest version (0.2.2-1).<br>
pkg-config is already the newest version (0.29.1-0ubuntu4).<br>
python3-dev is already the newest version (3.8.2-0ubuntu2).<br>
build-essential is already the newest version (12.8ubuntu1.1).<br>
libfreetype6-dev is already the newest version (2.10.1-2ubuntu0.1).<br>
libldap2-dev is already the newest version (2.4.49+dfsg-2ubuntu1.8).<br>
libssl-dev is already the newest version (1.1.1f-1ubuntu2.4).<br>
libxml2-dev is already the newest version (2.9.10+dfsg-5ubuntu0.20.04.1).<br>
zlib1g-dev is already the newest version (1:1.2.11.dfsg-2ubuntu1.2).<br>
jq is already the newest version (1.6-1ubuntu0.20.04.1).<br>
python3-pip is already the newest version (20.0.2-5ubuntu1.5).<br>
virtualenv is already the newest version (20.0.17-1ubuntu0.4).<br>
libpq-dev is already the newest version (13.3-1.pgdg20.04+1).<br>
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.<br>
Using cached Python venv from /srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv</p>
</li>
<li>
<p>ln -nsf /srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv /home/zulip/deployments/2021-07-03-21-11-13/zulip-py3-venv<br>
Node version 14.17.0 is already installed.<br>
generate_secrets: No new secrets to generate.<br>
2021-07-03 21:11:18,715 upgrade-zulip-stage-2: Building static assets...<br>
Cached version not found! Installing node modules.</p>
</li>
<li>
<p>/srv/zulip-yarn/bin/yarn install --non-interactive --frozen-lockfile --prod<br>
yarn install v1.22.10<br>
[1/4] Resolving packages...<br>
[2/4] Fetching packages...<br>
info <a href="mailto:fsevents@2.3.2">fsevents@2.3.2</a>: The platform "linux" is incompatible with this module.<br>
info "<a href="mailto:fsevents@2.3.2">fsevents@2.3.2</a>" is an optional dependency and failed compatibility check. Excluding it from installation.<br>
info <a href="mailto:fsevents@1.2.13">fsevents@1.2.13</a>: The platform "linux" is incompatible with this module.<br>
info "<a href="mailto:fsevents@1.2.13">fsevents@1.2.13</a>" is an optional dependency and failed compatibility check. Excluding it from installation.<br>
[3/4] Linking dependencies...<br>
warning "@formatjs/cli &gt; @vue/compiler-sfc@3.1.1" has unmet peer dependency "<a href="mailto:vue@3.1.1">vue@3.1.1</a>".<br>
warning "swagger-parser &gt; @apidevtools/swagger-parser@10.0.2" has unmet peer dependency "openapi-types@&gt;=7".<br>
[4/4] Building fresh packages...<br>
warning Ignored scripts due to flag.<br>
Done in 9.16s.<br>
Using cached node modules from /srv/zulip-npm-cache/f413e5f5d8bad3bbe0e4f4644dc41d88a8f9e871/node_modules</p>
</li>
<li>
<p>./tools/setup/emoji/build_emoji<br>
build_emoji: Using cached emojis from /srv/zulip-emoji-cache/6b1c0aff5d7a20084dc50f56491b07237b1ac5ec/emoji</p>
</li>
<li>
<p>./scripts/setup/inline_email_css.py</p>
</li>
<li>./tools/setup/generate_zulip_bots_static_files.py</li>
<li>./tools/setup/build_pygments_data</li>
<li>./tools/setup/build_timezone_values</li>
<li>
<p>./tools/webpack --quiet<br>
(node:1750019) V8: /srv/zulip-npm-cache/f413e5f5d8bad3bbe0e4f4644dc41d88a8f9e871/node_modules/ttf2woff2/jssrc/ttf2woff2.js:3 Invalid asm.js: Invalid member of stdlib<br>
(Use <code>node --trace-warnings ...</code> to show where the warning was created)<br>
i ｢wdm｣: Webpack compilation successful.</p>
</li>
<li>
<p>./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates</p>
</li>
<li>./manage.py compilemessages -v0<br>
2021-07-03 21:12:11,941 upgrade-zulip-stage-2: Caching Zulip Git version...<br>
2021-07-03 21:12:12,093 upgrade-zulip-stage-2: Checking for needed migrations<br>
2021-07-03 21:12:13,829 upgrade-zulip-stage-2: Stopping Zulip...<br>
process-fts-updates: ERROR (not running)<br>
zulip-django: ERROR (not running)<br>
zulip-tornado: ERROR (not running)<br>
zulip-workers:zulip_events_missedmessage_emails: stopped<br>
zulip-workers:zulip_deliver_scheduled_emails: stopped<br>
zulip-workers:zulip_deliver_scheduled_messages: stopped<br>
zulip-workers:zulip_events_email_mirror: stopped<br>
zulip-workers:zulip_events_missedmessage_mobile_notifications: stopped<br>
zulip-workers:zulip_events_error_reports: stopped<br>
zulip-workers:zulip_events_outgoing_webhooks: stopped<br>
zulip-workers:zulip_events_invites: stopped<br>
zulip-workers:zulip_events_email_senders: stopped<br>
zulip-workers:zulip_events_deferred_work: stopped<br>
zulip-workers:zulip_events_digest_emails: stopped<br>
zulip-workers:zulip_events_user_activity: stopped<br>
zulip-workers:zulip_events_user_activity_interval: stopped<br>
zulip-workers:zulip_events_embed_links: stopped<br>
zulip-workers:zulip_events_embedded_bots: stopped<br>
zulip-workers:zulip_events_user_presence: stopped<br>
zulip_deliver_scheduled_emails: ERROR (no such process)<br>
zulip_deliver_scheduled_messages: ERROR (no such process)<br>
Traceback (most recent call last):<br>
  File "./scripts/stop-server", line 51, in &lt;module&gt;<br>
    subprocess.check_call(["supervisorctl", "stop", *services])<br>
  File "/usr/lib/python3.8/subprocess.py", line 364, in check_call<br>
    raise CalledProcessError(retcode, cmd)<br>
subprocess.CalledProcessError: Command '['supervisorctl', 'stop', 'process-fts-updates', 'zulip-django', 'zulip-tornado', 'zulip-tornado:<em>', 'zulip-workers:</em>', 'zulip_deliver_scheduled_emails', 'zulip_deliver_scheduled_messages']' returned non-zero exit status 1.<br>
Traceback (most recent call last):<br>
  File "/home/zulip/deployments/2021-07-03-21-11-13/scripts/lib/upgrade-zulip-stage-2", line 265, in &lt;module&gt;<br>
    shutdown_server()<br>
  File "/home/zulip/deployments/2021-07-03-21-11-13/scripts/lib/upgrade-zulip-stage-2", line 109, in shutdown_server<br>
    subprocess.check_call(["./scripts/stop-server"], preexec_fn=su_to_zulip)<br>
  File "/usr/lib/python3.8/subprocess.py", line 364, in check_call<br>
    raise CalledProcessError(retcode, cmd)<br>
subprocess.CalledProcessError: Command '['./scripts/stop-server']' returned non-zero exit status 1.</li>
</ul>
<p>Zulip upgrade failed (exit code 1)!</p>
<p>The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is available in /var/log/zulip/upgrade.log</p>



<a name="1224717"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1224717" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1224717">(Jul 03 2021 at 21:20)</a>:</h4>
<div class="codehilite" data-code-language="root"><pre><span></span><code>Traceback (most recent call last):
  File "./manage.py", line 15, in &lt;module&gt;
    setup_path()
  File "/home/zulip/deployments/2021-06-09-16-41-55/scripts/lib/setup_path.py", line 14, in setup_path
    with open(activate_this) as f:
FileNotFoundError: [Errno 2] No such file or directory: '/home/zulip/deployments/2021-06-09-16-41-55/zulip-py3-venv/bin/activate_this.py'
Traceback (most recent call last):
  File "/home/zulip/deployments/last/scripts/restart-server", line 50, in &lt;module&gt;
    subprocess.check_call(
  File "/usr/lib/python3.8/subprocess.py", line 364, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command '['./manage.py', 'send_stats', 'incr', 'events.server_restart', '1625347189']' returned non-zero exit status 1.
root@chat:/home/zulip/deployments/current#
</code></pre></div>



<a name="1225222"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225222" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225222">(Jul 05 2021 at 19:14)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> do you think this could be the issue we were discussing the other day with not having a correct check for whether <code>zulip_deliver_scheduled_emails</code> should be running on the present system?</p>



<a name="1225223"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225223" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225223">(Jul 05 2021 at 19:14)</a>:</h4>
<p>If so, maybe we haven't merged the fix to master yet?</p>



<a name="1225225"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225225" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225225">(Jul 05 2021 at 19:15)</a>:</h4>
<p><span class="user-mention" data-user-id="20576">@Cosmic Sound</span>, what's the <code>/etc/zulip/zulip.conf</code> for that host?</p>



<a name="1225232"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225232" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225232">(Jul 05 2021 at 19:20)</a>:</h4>
<p>Will paste it here first thing <del>tomorrow</del> now :D</p>



<a name="1225234"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225234" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225234">(Jul 05 2021 at 19:20)</a>:</h4>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">ubuntu@chat:~$ </span>cat /etc/zulip/zulip.conf
<span class="go">[machine]</span>
<span class="go">puppet_classes = zulip::profile::standalone</span>
<span class="go">deploy_type = production</span>

<span class="go">[postgresql]</span>
<span class="go">version = 13</span>


<span class="go">[certbot]</span>
<span class="go">auto_renew = yes</span>

<span class="go">[rabbitmq]</span>
<span class="go">nodename = zulip@localhost</span>
</code></pre></div>



<a name="1225239"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225239" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225239">(Jul 05 2021 at 19:24)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>: standalone means it's not the problem from staging</p>



<a name="1225240"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225240" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225240">(Jul 05 2021 at 19:24)</a>:</h4>
<p>I can look more tomorrow</p>



<a name="1225241"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225241" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225241">(Jul 05 2021 at 19:24)</a>:</h4>
<p>OK.</p>



<a name="1225243"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225243" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225243">(Jul 05 2021 at 19:26)</a>:</h4>
<p>Guys meanwhile any idea how I return to normality with the server?</p>



<a name="1225244"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225244" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225244">(Jul 05 2021 at 19:26)</a>:</h4>
<p>As of last. intervention were on this beautiful screen that could be usefull to have a small debug trace option to have in place for admins and devs. <a href="/user_uploads/2/27/69OzPRChSsZP03BYTM4lI-0d/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/27/69OzPRChSsZP03BYTM4lI-0d/image.png" title="image.png"><img src="/user_uploads/2/27/69OzPRChSsZP03BYTM4lI-0d/image.png"></a></div>



<a name="1225245"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225245" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225245">(Jul 05 2021 at 19:26)</a>:</h4>
<p>Is there some safe rollback?</p>



<a name="1225285"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225285" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225285">(Jul 05 2021 at 21:12)</a>:</h4>
<p><span class="user-mention" data-user-id="20576">@Cosmic Sound</span> I'd expect <code>supervisorctl start all</code> to restart the server happily; the bug here is literally just in the step to start the server back up after the upgrade completed.</p>



<a name="1225286"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%20git%20failed/near/1225286" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.20git.20failed.html#1225286">(Jul 05 2021 at 21:12)</a>:</h4>
<p>Sorry we didn't mention this earlier; I hadn't noted that the state was the server down, as opposed to refusing to upgrade.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>