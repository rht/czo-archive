<html>
<head><meta charset="utf-8"><title>✔ error after upgrading postgresdb · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html">✔ error after upgrading postgresdb</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1523260"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523260" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523260">(Mar 13 2023 at 06:07)</a>:</h4>
<p>Hey team, I am upgrading our AWS-hosted zulip server (18.04 to 20.04) and I was following the instructions on <a href="https://zulip.readthedocs.io/en/latest/production/upgrade.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal">https://zulip.readthedocs.io/en/latest/production/upgrade.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal</a></p>
<p>Everything went well, until step 5, in particular when running this command:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>/home/zulip/deployments/current/scripts/lib/upgrade-zulip-stage-2<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>/home/zulip/deployments/current/<span class="w"> </span>--ignore-static-assets<span class="w"> </span>--audit-fts-indexes
</code></pre></div>
<p>I got the following error:</p>
<div class="codehilite"><pre><span></span><code>django.db.utils.OperationalError: connection to server on socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot; failed: FATAL:  role &quot;zulip&quot; does not exist

Traceback (most recent call last):
  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip-stage-2&quot;, line 249, in &lt;module&gt;
    migrations_output = subprocess.check_output(
  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 415, in check_output
    return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,
  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 516, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;showmigrations&#39;]&#39; returned non-zero exit status 1.
</code></pre></div>



<a name="1523261"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523261" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523261">(Mar 13 2023 at 06:07)</a>:</h4>
<p>I'm a bit stuck and don't know how to best proceed from here. Would appreciate any help, thank you!</p>



<a name="1523263"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523263" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523263">(Mar 13 2023 at 06:12)</a>:</h4>
<p>When I tried using the dbshell from manage.py I get the same error:</p>
<div class="codehilite"><pre><span></span><code>$ deployments/current/manage.py dbshell
psql: error: connection to server on socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot; failed: FATAL:  role &quot;zulip&quot; does not exist
&quot;psql -U zulip zulip&quot; returned non-zero exit status 2.
</code></pre></div>
<p>So it seems like my postgresdb is not running, <img alt=":shrug:" class="emoji" src="/user_avatars/2/emoji/images/31.png" title="shrug"></p>



<a name="1523264"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523264" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523264">(Mar 13 2023 at 06:17)</a>:</h4>
<p>hmm, I'm going to restart the server to see if it's just an issue with restarting PG, because the step 4 (<code>/home/zulip/deployments/current/scripts/setup/upgrade-postgresql</code>) ran with no problems...</p>



<a name="1523268"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523268" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523268">(Mar 13 2023 at 06:21)</a>:</h4>
<p>... nope, that didn't help. Same error as above</p>



<a name="1523273"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523273" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523273">(Mar 13 2023 at 06:35)</a>:</h4>
<p>so it seems postgres is running, but it's "empty". </p>
<p>I am able to access psql only if I run <code>sudo -U postgres psql</code>, but all other users don't have access</p>



<a name="1523274"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523274" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523274">(Mar 13 2023 at 06:36)</a>:</h4>
<div class="codehilite"><pre><span></span><code>~$ sudo -u zulip psql
psql: error: connection to server on socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot; failed: FATAL:  role &quot;zulip&quot; does not exist
</code></pre></div>



<a name="1523275"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523275" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523275">(Mar 13 2023 at 06:37)</a>:</h4>
<p>and when I look inside it looks pretty empty (no zulip db):</p>
<div class="codehilite"><pre><span></span><code>~$ sudo -u postgres psql
psql (15.2 (Ubuntu 15.2-1.pgdg20.04+1), server 13.10 (Ubuntu 13.10-1.pgdg20.04+1))
Type &quot;help&quot; for help.

postgres=# \l
                                             List of databases
   Name    |  Owner   | Encoding | Collate |  Ctype  | ICU Locale | Locale Provider |   Access privileges
-----------+----------+----------+---------+---------+------------+-----------------+-----------------------
 postgres  | postgres | UTF8     | C.UTF-8 | C.UTF-8 |            | libc            |
 template0 | postgres | UTF8     | C.UTF-8 | C.UTF-8 |            | libc            | =c/postgres          +
           |          |          |         |         |            |                 | postgres=CTc/postgres
 template1 | postgres | UTF8     | C.UTF-8 | C.UTF-8 |            | libc            | postgres=CTc/postgres+
           |          |          |         |         |            |                 | =c/postgres
(3 rows)
</code></pre></div>



<a name="1523373"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523373" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523373">(Mar 13 2023 at 13:46)</a>:</h4>
<p><span class="user-mention" data-user-id="8187">@Will Monge</span>: I assume that <code>REMOTE_POSTGRES_HOST</code> isn't set -- i.e. you're not using Amazon RDS, and your PostgreSQL database is on the same server?</p>
<p>It's likely that it looks empty because there are multiple versions of PostgreSQL installed, and <code>psql</code> is getting the wrong one.</p>
<p>Can you show <code>pg_lsclusters</code> ?</p>



<a name="1523397"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523397" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523397">(Mar 13 2023 at 14:34)</a>:</h4>
<p>thanks <span class="user-mention" data-user-id="12178">@Alex Vandiver</span> <br>
Yes, <code>REMOTE_POSTGRES_HOST</code> is not set, using the postgresdb that comes default with zulip on the same server.</p>
<p>I was looking through that, and yes, there were multiple versions, some of them broken. It's weird because this was a brand new server that I started earlier in the day with Ubuntu 18.04, installed zulip 4.6, loaded my backup, then upgraded to ubuntu 20.04 successfully, and then got stuck on that step. I'll try to run again today and inspect more closely the output of the <code>upgrade-postgres</code> command.</p>



<a name="1523398"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523398" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523398">(Mar 13 2023 at 14:38)</a>:</h4>
<p>When you do a new install, it defaults to PostgreSQL 14.  If you're using our <a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html#backups">backups</a>, restoring that will have reconfigured it to whatever the old server used, which probably left the PostgreSQL 14 around.</p>



<a name="1523400"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523400" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523400">(Mar 13 2023 at 14:39)</a>:</h4>
<p>I suspect that we need to improve the backup restoration code to clean up any other postgres installs before installing the one it wants.</p>



<a name="1523401"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523401" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523401">(Mar 13 2023 at 14:42)</a>:</h4>
<p>thank you for that. Would you recommend then, after restoring the backup, removing postgres 14? if so what is the best way to do so? thank you!</p>



<a name="1523402"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523402" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523402">(Mar 13 2023 at 14:42)</a>:</h4>
<p>If you're trying this again, check the value of <code>postgresql.version</code> in <code>/etc/zulip/zulip.conf</code> on the old server.  When you do the install on the new host, pass <code>--postgresql-version=13</code> or whatever the version is.</p>



<a name="1523407"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523407" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523407">(Mar 13 2023 at 14:45)</a>:</h4>
<p>I see the version on the old server is set to 10</p>



<a name="1523408"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523408" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523408">(Mar 13 2023 at 14:45)</a>:</h4>
<p><a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html#backups-export-and-import">https://zulip.readthedocs.io/en/latest/production/export-and-import.html#backups-export-and-import</a> notes this but I guess <a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html#restoring-backups">https://zulip.readthedocs.io/en/latest/production/export-and-import.html#restoring-backups</a> doesn't.</p>



<a name="1523409"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523409" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523409">(Mar 13 2023 at 14:46)</a>:</h4>
<p>Good time to upgrade, since PostgreSQL 10 is out of support, and Zulip 6.0 won't support it.</p>



<a name="1523410"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523410" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523410">(Mar 13 2023 at 14:47)</a>:</h4>
<p>Oh, wait.  Wrong tense -- you're presumably trying to upgrade to 6.1, so you can't install <code>--postgresql-version=10</code></p>



<a name="1523411"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523411" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523411">(Mar 13 2023 at 14:49)</a>:</h4>
<p>Presumably you're trying the postgresql upgrade step on a new server because you're trying to minimize downtime.</p>
<p>But it may be easiest to upgrade postgres on the old server, do an export, and then import that on the new server.  Because I don't think you can do this with out an intermediate step otherwise.</p>



<a name="1523412"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523412" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523412">(Mar 13 2023 at 14:50)</a>:</h4>
<p>right, I have ubuntu 18.04, postgres 10, and zulip 4.6. What is the proper order of upgrade here?</p>
<ol>
<li>upgrade to ubuntu 20.04</li>
<li>upgrade postgres to 13(?) using <code>/home/zulip/deployments/current/scripts/setup/upgrade-postgresql</code></li>
<li>then upgrade zulip to 6.1?</li>
</ol>



<a name="1523413"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523413" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523413">(Mar 13 2023 at 14:51)</a>:</h4>
<p>I'd swap steps 2 and 3.</p>



<a name="1523414"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523414" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523414">(Mar 13 2023 at 14:51)</a>:</h4>
<p>Hm, though I don't know if the upgrade will stop you if you're on PostgreSQL 10.</p>



<a name="1523415"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523415" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523415">(Mar 13 2023 at 14:51)</a>:</h4>
<p>oh, but doesn't zulip 5.x and above not support postgres10?</p>



<a name="1523416"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523416" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523416">(Mar 13 2023 at 14:52)</a>:</h4>
<p>6.x doesn't support PostgreSQL 10.</p>



<a name="1523417"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523417" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523417">(Mar 13 2023 at 14:52)</a>:</h4>
<p>So yeah, I think you're right on the ordering.  You can repeat the PostgreSQL upgrade after you're on 6.1 to take you up to PG 14.</p>



<a name="1523418"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523418" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523418">(Mar 13 2023 at 14:53)</a>:</h4>
<p>I am trying to run all this on a backup server (to then just swap folks from one to the other with minimal interruption, but some loss of recent messages)</p>



<a name="1523420"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523420" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523420">(Mar 13 2023 at 14:54)</a>:</h4>
<p>I believe that's the order I tried. But I'll try again and I'll be mindful of what versions of postgres I have at all times</p>



<a name="1523425"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523425" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523425">(Mar 13 2023 at 14:55)</a>:</h4>
<p>thank you! I'll try to post updates during today</p>



<a name="1523426"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523426" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523426">(Mar 13 2023 at 14:55)</a>:</h4>
<p>Starting with installing 4.6 with <code>--postgresql-version=10</code> is probably the trick.</p>



<a name="1523428"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523428" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523428">(Mar 13 2023 at 14:58)</a>:</h4>
<p>So to be explicit:</p>
<ul>
<li>install ubuntu 20.04</li>
<li>install zulip 4.6 <code>--postgresql-version=10</code></li>
<li><code>upgrade-postgresql</code> to pg13</li>
<li><code>upgrade-zulip</code> to 6.1</li>
<li>optionally go up to <a href="https://zulip.readthedocs.io/en/latest/production/upgrade.html#upgrading-from-ubuntu-20-04-focal-to-22-04-jammy">Ubuntu 22.04</a> and/or repeat <code>upgrade-postgresql</code> to give you pg14.</li>
</ul>



<a name="1523429"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523429" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523429">(Mar 13 2023 at 14:58)</a>:</h4>
<p>do you think I'd be able to restore the backup directly on a new server running 20.04 on which I've run an install zulip 4.6 with the <code>--postgresql-version=10</code> ?</p>



<a name="1523430"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523430" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523430">(Mar 13 2023 at 14:58)</a>:</h4>
<p>Yes.</p>



<a name="1523431"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523431" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523431">(Mar 13 2023 at 14:58)</a>:</h4>
<p>(nevermind, you just answered the question with your last message, thanks!)</p>



<a name="1523468"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523468" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523468">(Mar 13 2023 at 16:11)</a>:</h4>
<p>okay, I think we are progressing, but I ran into a new error.</p>
<p>I was following these steps:</p>
<ol>
<li>install ubuntu 20.04</li>
<li>install zulip 4.6 --postgresql-version=10</li>
<li>restore-backup</li>
<li>upgrade-postgresql to pg13</li>
<li>upgrade-zulip to 6.1</li>
</ol>
<p>I got the following error on step 3 (restoring the backup):</p>



<a name="1523469"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523469" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523469">(Mar 13 2023 at 16:11)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Notice: /Stage[main]/Zulip::Supervisor/Service[supervisor]: Triggered &#39;refresh&#39; from 2 events
Notice: Applied catalog in 8.65 seconds
+ pg_restore --dbname=zulip -- /tmp/zulip-restore-backup-o75w4j8z/zulip-backup/database
pg_restore: [archiver] unsupported version (1.14) in file header

Error running a subcommand of /home/zulip/deployments/current/scripts/setup/restore-backup: pg_restore --dbname=zulip -- /tmp/zulip-restore-backup-o75w4j8z/zulip-backup/database
Actual error output for the subcommand is just above this.
</code></pre></div>



<a name="1523470"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523470" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523470">(Mar 13 2023 at 16:12)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> , not sure if you are available/able to give me some advice on how to proceed. Thanks and sorry to keep pinging you!</p>



<a name="1523475"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523475" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523475">(Mar 13 2023 at 16:13)</a>:</h4>
<p>I'm not familiar with that error -- my only guess is that <code>/tmp/zulip-restore-backup-o75w4j8z/zulip-backup/database</code> isn't the format that postgres is expecting for some reason.  Double-check the versions of postgres on the export side and the import side match?</p>



<a name="1523478"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523478" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523478">(Mar 13 2023 at 16:16)</a>:</h4>
<p>so here is what I'm seeing on the old server (that generated the backup) and continues to run our zulip:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/etc/zulip/zulip.conf
<span class="o">[</span>machine<span class="o">]</span>
<span class="nv">puppet_classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>zulip::profile::standalone
<span class="nv">deploy_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>voyager

<span class="o">[</span>rabbitmq<span class="o">]</span>
<span class="nv">nodename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>zulip@localhost

<span class="o">[</span>certbot<span class="o">]</span>
<span class="nv">auto_renew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>yes

<span class="o">[</span>postgresql<span class="o">]</span>
<span class="nv">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>


$<span class="w"> </span>pg_lsclusters
Ver<span class="w"> </span>Cluster<span class="w"> </span>Port<span class="w"> </span>Status<span class="w"> </span>Owner<span class="w">    </span>Data<span class="w"> </span>directory<span class="w">              </span>Log<span class="w"> </span>file
<span class="m">10</span><span class="w">  </span>main<span class="w">    </span><span class="m">5432</span><span class="w"> </span>down<span class="w">   </span>postgres<span class="w"> </span>/var/lib/postgresql/10/main<span class="w"> </span>/var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log
<span class="m">13</span><span class="w">  </span>main<span class="w">    </span><span class="m">5432</span><span class="w"> </span>online<span class="w"> </span>postgres<span class="w"> </span>/var/lib/postgresql/13/main<span class="w"> </span>/var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log
</code></pre></div>



<a name="1523479"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523479" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523479">(Mar 13 2023 at 16:16)</a>:</h4>
<p>this seems weird, pg version 10 is down, and pg 13 is online... but the zulip.conf points to pg 10</p>



<a name="1523481"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523481" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523481">(Mar 13 2023 at 16:18)</a>:</h4>
<p>could this be because at some point we restored a zulip+pg10 backup on a new zulip+pg13 instance?</p>



<a name="1523482"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523482" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523482">(Mar 13 2023 at 16:18)</a>:</h4>
<p>do you have any advice on how to un-mess this?</p>



<a name="1523485"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523485" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523485">(Mar 13 2023 at 16:20)</a>:</h4>
<p>Looks like a happy postgres 13 situation.  I'd <code>s/10/13/</code> in the config file and <code>apt-get purge</code> any <code>dpkg --get-selections | grep postgresql | grep 10</code></p>



<a name="1523486"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523486" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523486">(Mar 13 2023 at 16:21)</a>:</h4>
<p>That's just cleanup on the old host.  You can skip it.</p>



<a name="1523488"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523488" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523488">(Mar 13 2023 at 16:21)</a>:</h4>
<p>The main thing is to <code>s/10/13/</code> in the new install instructions above.  And since it's already PG 13, I think you can simplify some steps.</p>



<a name="1523489"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523489" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523489">(Mar 13 2023 at 16:22)</a>:</h4>
<ol>
<li>install 20.04</li>
<li>Install zulip 4.6 <code>--postgresql-version=13</code></li>
<li>restore the backup</li>
<li>upgrade to 6.1</li>
<li>upgrade-postgresql and/or the OS to 22.04</li>
</ol>



<a name="1523491"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523491" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523491">(Mar 13 2023 at 16:22)</a>:</h4>
<p>thanks! will try that now!</p>



<a name="1523493"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523493" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523493">(Mar 13 2023 at 16:24)</a>:</h4>
<p>Actually, you will need to <code>s/10/13/</code> on the old host since we use the config file when installing on the new host</p>



<a name="1523494"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523494" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523494">(Mar 13 2023 at 16:24)</a>:</h4>
<p>actually, do I have to change the config file on the old server, then re-export a backup, and then use that clean pg13 backup on the new ubuntu20.04 instance running the new zulip+pg13 ?</p>



<a name="1523496"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523496" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523496">(Mar 13 2023 at 16:25)</a>:</h4>
<p>Yes.</p>



<a name="1523644"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523644" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523644">(Mar 13 2023 at 18:50)</a>:</h4>
<p>awesome, that worked!!</p>



<a name="1523646"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523646" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523646">(Mar 13 2023 at 18:51)</a>:</h4>
<p>last step is switching the DNS for those servers. Is there a way to re-trigger certbot through zulip's scripts/manage.py ?</p>



<a name="1523649"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523649" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523649">(Mar 13 2023 at 18:51)</a>:</h4>
<p>thank you SO much!! finally got a full upgrade! <span aria-label="praise" class="emoji emoji-1f64c" role="img" title="praise">:praise:</span> <span aria-label="praise" class="emoji emoji-1f64c" role="img" title="praise">:praise:</span> <span aria-label="praise" class="emoji emoji-1f64c" role="img" title="praise">:praise:</span></p>



<a name="1523654"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523654" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523654">(Mar 13 2023 at 18:54)</a>:</h4>
<p>I think you need to call <code>certbot</code>directly.</p>



<a name="1523657"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523657" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523657">(Mar 13 2023 at 18:58)</a>:</h4>
<p>gotcha</p>



<a name="1523763"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523763" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Monge <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523763">(Mar 13 2023 at 20:14)</a>:</h4>
<p>thanks again, Alex!</p>
<p>In case somebody in the future needs it, I was able to rerun certbot with :</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>sudo<span class="w"> </span>-s<span class="w">  </span><span class="c1"># If not already root</span>
/home/zulip/deployments/current/scripts/setup/setup-certbot<span class="w"> </span>--email<span class="o">=</span>EMAIL<span class="w"> </span>HOSTNAME<span class="w"> </span><span class="o">[</span>HOSTNAME2...<span class="o">]</span>
</code></pre></div>
<p>docs: <a href="https://zulip.readthedocs.io/en/stable/production/ssl-certificates.html#after-zulip-is-already-installed">https://zulip.readthedocs.io/en/stable/production/ssl-certificates.html#after-zulip-is-already-installed</a></p>



<a name="1523764"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20error%20after%20upgrading%20postgresdb/near/1523764" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20error.20after.20upgrading.20postgresdb.html#1523764">(Mar 13 2023 at 20:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="8187">Will Monge</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>