<html>
<head><meta charset="utf-8"><title>KeyError when importing data exported from zulip cloud · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html">KeyError when importing data exported from zulip cloud</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1615532"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1615532" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> n0099 <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1615532">(Jul 25 2023 at 11:52)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/issues/26349">https://github.com/zulip/zulip/issues/26349</a></p>
<blockquote>
<p>I've already upgraded and built the <code>docker-zulip</code> to <code>refs/remotes/origin/zulip-cloud-current</code> following <a href="https://github.com/zulip/docker-zulip/blob/main/UPGRADING.md#upgrading-from-a-git-repository">https://github.com/zulip/docker-zulip/blob/main/UPGRADING.md#upgrading-from-a-git-repository</a></p>
<p><div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mf">20.909</span> <span class="n">INFO</span> <span class="p">[]</span> <span class="n">Importing</span> <span class="n">attachment</span> <span class="n">data</span> <span class="kn">from</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">zulip</span><span class="o">/</span><span class="n">zulip</span><span class="o">-</span><span class="n">export</span><span class="o">-</span><span class="n">s5nsij46</span><span class="o">/</span><span class="n">attachment</span><span class="o">.</span><span class="n">json</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"./manage.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">150</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">execute_from_command_line</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"./manage.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">115</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute_from_command_line</span>
    <span class="n">utility</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">436</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fetch_command</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span><span class="o">.</span><span class="n">run_from_argv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">412</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run_from_argv</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">cmd_options</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">458</span><span class="p">,</span> <span class="ow">in</span> <span class="n">execute</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2023-07-25-08-34-03/zerver/management/commands/import.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">101</span><span class="p">,</span> <span class="ow">in</span> <span class="n">handle</span>
    <span class="n">do_import_realm</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2023-07-25-08-34-03/zerver/lib/import_realm.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1381</span><span class="p">,</span> <span class="ow">in</span> <span class="n">do_import_realm</span>
    <span class="n">import_attachments</span><span class="p">(</span><span class="n">attachment_data</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/home/zulip/deployments/2023-07-25-08-34-03/zerver/lib/import_realm.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1594</span><span class="p">,</span> <span class="ow">in</span> <span class="n">import_attachments</span>
    <span class="n">attachment</span><span class="p">[</span><span class="s2">"path_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_maps</span><span class="p">[</span><span class="s2">"attachment_path"</span><span class="p">][</span><span class="n">attachment</span><span class="p">[</span><span class="s2">"path_id"</span><span class="p">]]</span>
<span class="ne">KeyError</span><span class="p">:</span> <span class="s1">'45099/DCepzIc7ZRGbRjXXGG6xDNHC/image.png'</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="1615615"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1615615" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1615615">(Jul 25 2023 at 14:34)</a>:</h4>
<p><span class="user-mention" data-user-id="27436">@n0099</span>: Is there a <code>45099/DCepzIc7ZRGbRjXXGG6xDNHC/image.png</code> in your export tarball?</p>
<p>Are you willing to share (via DMs, if you prefer) the organization name in Zulip Cloud so I can check what the export generates?</p>



<a name="1615638"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1615638" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> n0099 <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1615638">(Jul 25 2023 at 14:55)</a>:</h4>
<p><a href="https://n0099.zulipchat.com">https://n0099.zulipchat.com</a></p>



<a name="1615640"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1615640" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> n0099 <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1615640">(Jul 25 2023 at 14:57)</a>:</h4>
<p>It's not exists in the exported tarball.</p>



<a name="1615833"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1615833" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1615833">(Jul 25 2023 at 19:05)</a>:</h4>
<p>I can replicate that it's missing in a fresh export; since the message matching it <em>is</em> in the export, that's clearly a bug.</p>



<a name="1616226"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1616226" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1616226">(Jul 26 2023 at 04:38)</a>:</h4>
<p><span class="user-mention" data-user-id="27436">@n0099</span>: We've determined that the file in question is missing from our S3 backing store, and we're investigating how that happened.  We'll let you know when we know more.</p>



<a name="1616291"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1616291" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> n0099 <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1616291">(Jul 26 2023 at 05:48)</a>:</h4>
<p>Thanks</p>



<a name="1616984"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1616984" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> n0099 <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1616984">(Jul 27 2023 at 07:17)</a>:</h4>
<p>and there's even more files that are missing from the exported tarball and s3 storage on <a href="https://n0099.zulipchat.com/user_uploads">https://n0099.zulipchat.com/user_uploads</a></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>jq<span class="w"> </span><span class="s1">'.zerver_attachment[].path_id'</span><span class="w"> </span>-r<span class="w"> </span>attachment.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-I<span class="w"> </span><span class="o">{}</span><span class="w"> </span>stat<span class="w"> </span>uploads/<span class="o">{}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>not
stat:<span class="w"> </span>cannot<span class="w"> </span>stat<span class="w"> </span><span class="s1">'uploads/45099/DCepzIc7ZRGbRjXXGG6xDNHC/image.png'</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
stat:<span class="w"> </span>cannot<span class="w"> </span>stat<span class="w"> </span><span class="s1">'uploads/45099/yOxd_PN4TxwIqAkTUBrTdREQ/25b850c5-eba2-4bd3-acf8-258a993d6e18.jpg'</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
stat:<span class="w"> </span>cannot<span class="w"> </span>stat<span class="w"> </span><span class="s1">'uploads/45099/QvhHXTIRhLyQ6yGbbp5N3v3G/Screenshot_20221012-084748.png'</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
stat:<span class="w"> </span>cannot<span class="w"> </span>stat<span class="w"> </span><span class="s1">'uploads/45099/OxaIFaTh1NMF6XvgTfYKoViQ/image.png'</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
stat:<span class="w"> </span>cannot<span class="w"> </span>stat<span class="w"> </span><span class="s1">'uploads/45099/pxUaYM8CQAcKsuMIM4vy2mIg/image.png'</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
stat:<span class="w"> </span>cannot<span class="w"> </span>stat<span class="w"> </span><span class="s1">'uploads/45099/gt-wxVqLRjI88qbZLUyk6NkS/image.png'</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
stat:<span class="w"> </span>cannot<span class="w"> </span>stat<span class="w"> </span><span class="s1">'uploads/45099/D30bw_Z6HlWwhGEyReYbicdJ/image.png'</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
stat:<span class="w"> </span>cannot<span class="w"> </span>stat<span class="w"> </span><span class="s1">'uploads/45099/aHGx810flcBoiAUiGbs29iEL/image.png'</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
</code></pre></div>



<a name="1616985"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1616985" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> n0099 <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1616985">(Jul 27 2023 at 07:40)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>comm<span class="w"> </span>-3<span class="w"> </span>&lt;<span class="o">(</span>jq<span class="w"> </span><span class="s1">'.zerver_attachment[].path_id'</span><span class="w"> </span>-r<span class="w"> </span>attachment.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="o">)</span><span class="w"> </span>&lt;<span class="o">(</span>find<span class="w"> </span>uploads<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d/<span class="w"> </span>-f2-<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>records.json<span class="o">)</span>
<span class="m">45099</span>/D30bw_Z6HlWwhGEyReYbicdJ/image.png
<span class="m">45099</span>/DCepzIc7ZRGbRjXXGG6xDNHC/image.png
<span class="m">45099</span>/OxaIFaTh1NMF6XvgTfYKoViQ/image.png
<span class="m">45099</span>/QvhHXTIRhLyQ6yGbbp5N3v3G/Screenshot_20221012-084748.png
<span class="m">45099</span>/aHGx810flcBoiAUiGbs29iEL/image.png
<span class="m">45099</span>/gt-wxVqLRjI88qbZLUyk6NkS/image.png
<span class="m">45099</span>/pxUaYM8CQAcKsuMIM4vy2mIg/image.png
<span class="m">45099</span>/yOxd_PN4TxwIqAkTUBrTdREQ/25b850c5-eba2-4bd3-acf8-258a993d6e18.jpg
</code></pre></div>



<a name="1616988"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1616988" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> n0099 <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1616988">(Jul 27 2023 at 08:07)</a>:</h4>
<p>To remove missing files from <code>attachment.json</code> to allow the importing:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>jq<span class="w"> </span><span class="s1">'del(.zerver_attachment[] | select(.path_id == $missing[]))'</span><span class="w"> </span>--argjson<span class="w"> </span>missing<span class="w"> </span><span class="s2">"</span><span class="k">$(</span>comm<span class="w"> </span>-3<span class="w"> </span>&lt;<span class="o">(</span>cat<span class="w"> </span>attachment.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">'.zerver_attachment[].path_id'</span><span class="w"> </span>-r<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="k">)</span><span class="s2"> &lt;(find uploads -type f | cut -d/ -f2- | sort | grep -v records.json) | jq --raw-input . | jq --slurp .)"</span><span class="w"> </span>-r<span class="w"> </span>attachment.json<span class="w"> </span>&gt;<span class="w"> </span>attachment.json.2
</code></pre></div>



<a name="1618501"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1618501" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1618501">(Aug 01 2023 at 15:12)</a>:</h4>
<p><span class="user-mention" data-user-id="27436">@n0099</span>: We've confirmed that we unfortunately improperly deleted a small number of files from S3 which should not have been deleted (<a href="https://github.com/zulip/zulip/pull/26377">#26377</a> has the gory details).  We do not have a way to reconstruct those files, sadly.</p>
<p>We'll be posting a blog post and sending out email to the affected users, yourself included, this week.</p>



<a name="1618502"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1618502" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> n0099 <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1618502">(Aug 01 2023 at 15:23)</a>:</h4>
<p>Sorry to hear that it's not only affecting my organization.</p>



<a name="1618504"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20when%20importing%20data%20exported%20from%20zulip%20cloud/near/1618504" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20when.20importing.20data.20exported.20from.20zulip.20cloud.html#1618504">(Aug 01 2023 at 15:32)</a>:</h4>
<p>We're extremely sorry to have lost the data. <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>
<p>Thank you for bringing it to our attention -- your report was what allowed us to find the issue.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>