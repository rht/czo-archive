<html>
<head><meta charset="utf-8"><title>Upgrade from 2.1.0 to 2.1.1 failed · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html">Upgrade from 2.1.0 to 2.1.1 failed</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="802959"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/802959" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oldinosor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#802959">(Dec 16 2019 at 09:39)</a>:</h4>
<p>Upgrade from 2.0.7 to 2.0.8 OK<br>
Upgrade from 2.0.8 to 2.1.0 OK<br>
Upgrade from 2.1.0 to 2.1.1 Error<br>
=====<br>
Error running a subcommand of ./tools/update-prod-static: /home/zulip/deployments/2019-12-16-09-13-04/scripts/lib/cd_exec /srv/zulip-npm-cache/43c758b0e1fe19f195fb127b645179154cef3d0a /srv/zulip-yarn/bin/yarn install --non-interactive --prod<br>
=====<br>
Same CPU Linux Ubuntu 18.04.3 LTS fully updated &amp; upgraded<br>
supervisorctl stop all OK<br>
All procedures followed<br>
Zulip still running after sudo reboot (I am using it right now).<br>
=====<br>
FYI I had also an error upgrading from 2.0.8 to 2.1.0 and it was probably not a memory issue <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span>  <span class="user-mention" data-user-id="7">@Tim Abbott</span>  <span class="user-mention" data-user-id="14099">@Mal</span>  <span class="user-mention" data-user-id="13725">@morevsky</span> . It was probably more a 100% upgraded OS issue since I had to apply ' apt-get dist-upgrade ' to solve it. And it worked with only 2 GB of memory.<br>
Any idea about this other error?</p>



<a name="802960"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/802960" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#802960">(Dec 16 2019 at 09:55)</a>:</h4>
<p><span class="user-mention" data-user-id="13140">@Oldinosor</span> Can you post more of the error? (including all the surrounding stuff) But I've seen this type of error resolved by having more available memory, so there's a good chance it's about that.</p>



<a name="802961"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/802961" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oldinosor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#802961">(Dec 16 2019 at 10:15)</a>:</h4>
<p>More of the error <span class="user-mention" data-user-id="10349">@Mateusz Mandera</span>  :<br>
=====<br>
2019-12-16 09:14:11,332 upgrade-zulip-stage-2: Building static assets...<br>
Cached version not found! Installing node modules.</p>
<ul>
<li>mkdir -p /srv/zulip-npm-cache/43c758b0e1fe19f195fb127b645179154cef3d0a</li>
<li>cp package.json yarn.lock /srv/zulip-npm-cache/43c758b0e1fe19f195fb127b645179154cef3d0a</li>
<li>/home/zulip/deployments/2019-12-16-09-13-04/scripts/lib/cd_exec /srv/zulip-npm-cache/43c758b0e1fe19f195fb127b645179154cef3d0a /srv/zulip-yarn/bin/yarn install --non-interactive --prod</li>
</ul>
<p>Error running a subcommand of ./tools/update-prod-static: /home/zulip/deployments/2019-12-16-09-13-04/scripts/lib/cd_exec /srv/zulip-npm-cache/43c758b0e1fe19f195fb127b645179154cef3d0a /srv/zulip-yarn/bin/yarn install --non-interactive --prod<br>
Actual error output for the subcommand is just above this.<br>
=====<br>
I am not fully convinced by the available memory solution.<br>
Especially with a machine stopped and restarted and all process stopped =&gt; no cache, no user...<br>
100% available for the upgrade.<br>
If it works for a large upgrade as 2.0.8 to 2.1.0, why on the same CPU with the same OS in the same conditions, wouldn't it work for a smallest upgrade as 2.1.0 to 2.1.1 ?</p>



<a name="803271"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/803271" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#803271">(Dec 17 2019 at 21:57)</a>:</h4>
<p><span class="user-mention" data-user-id="13140">@Oldinosor</span> the output contains a path to <code>update-prod-static.log</code>; that will have the actual error.</p>



<a name="803925"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/803925" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oldinosor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#803925">(Dec 22 2019 at 05:57)</a>:</h4>
<p><span class="user-mention" data-user-id="10349">@Mateusz Mandera</span> <span class="user-mention" data-user-id="7">@Tim Abbott</span> I tried again this morning after allocating 12 GB of memory to the CPU instead of 2 =&gt; same error.<br>
=====<br>
2019-12-22 05:51:21,637 upgrade-zulip-stage-2: Building static assets...<br>
Cached version not found! Installing node modules.</p>
<ul>
<li>/srv/zulip-yarn/bin/yarn install --non-interactive --frozen-lockfile --prod</li>
</ul>
<p>Error running a subcommand of ./tools/update-prod-static: /srv/zulip-yarn/bin/yarn install --non-interactive --frozen-lockfile --prod<br>
Actual error output for the subcommand is just above this.</p>
<p>Traceback (most recent call last):<br>
  File "./tools/update-prod-static", line 37, in &lt;module&gt;<br>
    setup_node_modules(production=True, stdout=fp, stderr=fp)<br>
  File "./tools/../scripts/lib/node_cache.py", line 66, in setup_node_modules<br>
    stderr=stderr)<br>
  File "./tools/../scripts/lib/node_cache.py", line 91, in do_yarn_install<br>
    cwd=target_path, stdout=stdout, stderr=stderr)<br>
  File "./tools/../scripts/lib/zulip_tools.py", line 200, in run<br>
    subprocess.check_call(args, **kwargs)<br>
  File "/usr/lib/python3.6/subprocess.py", line 311, in check_call<br>
    raise CalledProcessError(retcode, cmd)<br>
subprocess.CalledProcessError: Command '['/srv/zulip-yarn/bin/yarn', 'install', '--non-interactive', '--frozen-lockfile', '--prod']' returned non-zero exit status 1.<br>
Traceback (most recent call last):<br>
  File "/home/zulip/deployments/2019-12-22-05-50-32/scripts/lib/upgrade-zulip-stage-2", line 122, in &lt;module&gt;<br>
    preexec_fn=su_to_zulip)<br>
  File "/usr/lib/python3.6/subprocess.py", line 311, in check_call<br>
    raise CalledProcessError(retcode, cmd)<br>
subprocess.CalledProcessError: Command '['./tools/update-prod-static', '--authors-not-required', '--prev-deploy', '/home/zulip/deployments/current']' returned non-zero exit status 1.<br>
Traceback (most recent call last):<br>
  File "/home/zulip/deployments/current/scripts/lib/upgrade-zulip-from-git", line 69, in &lt;module&gt;<br>
    deploy_path, "--from-git"] + deploy_options)<br>
  File "/usr/lib/python3.6/subprocess.py", line 311, in check_call<br>
    raise CalledProcessError(retcode, cmd)<br>
subprocess.CalledProcessError: Command '['/home/zulip/deployments/2019-12-22-05-50-32/scripts/lib/upgrade-zulip-stage-2', '/home/zulip/deployments/2019-12-22-05-50-32', '--from-git']' returned non-zero exit status 1.</p>



<a name="804131"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/804131" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#804131">(Dec 23 2019 at 03:51)</a>:</h4>
<p><span class="user-mention" data-user-id="13140">@Oldinosor</span> that looks to me like <code>yarn install</code> is failing, which is often a networking issue.</p>



<a name="804157"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/804157" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oldinosor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#804157">(Dec 23 2019 at 07:15)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Thanks for the help. What kind of networking issues do you think about?</p>



<a name="804160"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/804160" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oldinosor <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#804160">(Dec 23 2019 at 07:42)</a>:</h4>
<p>Yarn current version on this machine is 1.19.1.<br>
The last Yarn stable version is 1.21.1. <a href="https://yarnpkg.com/lang/en/" target="_blank" title="https://yarnpkg.com/lang/en/">https://yarnpkg.com/lang/en/</a><br>
But when I use CLI, Ubuntu displays:<br>
0 packages can be updated.<br>
0 updates are security updates.<br>
Does the upgrade process tries to install yarn when it's already there?</p>



<a name="804188"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/804188" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#804188">(Dec 23 2019 at 17:49)</a>:</h4>
<p>Could it be some issue with the <code>--frozen-lockfile</code> option/<code>yarn.lock</code>? <span class="user-mention" data-user-id="699">@Anders Kaseorg</span></p>



<a name="804224"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/804224" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#804224">(Dec 24 2019 at 01:02)</a>:</h4>
<p><span class="user-mention" data-user-id="13140">@Oldinosor</span> You’ll need to check <code>/home/zulip/deployments/next/var/log/update-prod-static.log</code>.</p>



<a name="804753"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/804753" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#804753">(Dec 28 2019 at 20:07)</a>:</h4>
<p>Should we add code to e.g. <code>tail -n25 update-prod-static-log</code> when <code>update-prod-static</code> fails?  I had thought we had written that, but maybe it's only in our CI code.</p>



<a name="804754"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/804754" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#804754">(Dec 28 2019 at 20:07)</a>:</h4>
<p>Ahhh, indeed:</p>
<div class="codehilite"><pre><span></span>if ! env TRAVIS=1 ./tools/build-release-tarball travis; then
    echo &quot;Attempting to output failure logging data&quot;
    cat /tmp/tmp.*/update-prod-static.log || true
    exit 1
fi
</pre></div>



<a name="804755"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20from%202.1.0%20to%202.1.1%20failed/near/804755" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20from.202.2E1.2E0.20to.202.2E1.2E1.20failed.html#804755">(Dec 28 2019 at 20:10)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/issues/13584" target="_blank" title="https://github.com/zulip/zulip/issues/13584">https://github.com/zulip/zulip/issues/13584</a></p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>