<html>
<head><meta charset="utf-8"><title>Push notification problem · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html">Push notification problem</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1203622"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1203622" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edek Kredka <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1203622">(Jun 08 2021 at 11:45)</a>:</h4>
<p>Hi,</p>
<p>My enviroment: zulip run in docker, connection to internet via proxy</p>
<p>After last update to zulip version 4.2 I lost mobile push notification.<br>
Connection to internet is working properly. I try re register my server and tha operation was success. But when system try to send mobile push notification timeout is occurred. What can be wrong ?</p>
<p>'Logger root, from module zerver.worker.queue_processors line 354:<br>
Error generated by Anonymous user (not logged in) on e1631c66da56 deployment</p>
<p>Traceback (most recent call last):<br>
  File "/home/zulip/deployments/2021-06-03-21-00-31/zerver/worker/queue_processors.py", line 299, in do_consume<br>
    consume_func(events)<br>
  File "/home/zulip/deployments/2021-06-03-21-00-31/zerver/worker/queue_processors.py", line 339, in &lt;lambda&gt;<br>
    consume_func = lambda events: self.consume(events[0])<br>
  File "/home/zulip/deployments/2021-06-03-21-00-31/zerver/worker/queue_processors.py", line 666, in consume<br>
    handle_push_notification(event["user_profile_id"], event)<br>
  File "/home/zulip/deployments/2021-06-03-21-00-31/zerver/decorator.py", line 830, in wrapped_func<br>
    ret = func(*args, **kwargs)<br>
  File "/home/zulip/deployments/2021-06-03-21-00-31/zerver/lib/push_notifications.py", line 907, in handle_push_notification<br>
    send_notifications_to_bouncer(user_profile_id, apns_payload, gcm_payload, gcm_options)<br>
  File "/home/zulip/deployments/2021-06-03-21-00-31/zerver/lib/push_notifications.py", line 407, in send_notifications_to_bouncer<br>
    send_json_to_push_bouncer("POST", "push/notify", post_data)<br>
  File "/home/zulip/deployments/2021-06-03-21-00-31/zerver/lib/remote_server.py", line 104, in send_json_to_push_bouncer<br>
    send_to_push_bouncer(<br>
  File "/home/zulip/deployments/2021-06-03-21-00-31/zerver/lib/remote_server.py", line 57, in send_to_push_bouncer<br>
    res = requests.request(<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/requests/api.py", line 61, in request<br>
    return session.request(method=method, url=url, **kwargs)<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/requests/sessions.py", line 542, in request<br>
    resp = self.send(prep, **send_kwargs)<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/requests/sessions.py", line 655, in send<br>
    r = adapter.send(request, **kwargs)<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/requests/adapters.py", line 439, in send<br>
    resp = conn.urlopen(<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connectionpool.py", line 699, in urlopen<br>
    httplib_response = self._make_request(<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connectionpool.py", line 382, in _make_request<br>
    self._validate_conn(conn)<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connectionpool.py", line 1010, in _validate_conn<br>
    conn.connect()<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connection.py", line 353, in connect<br>
    conn = self._new_conn()<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connection.py", line 169, in _new_conn<br>
    conn = connection.create_connection(<br>
  File "/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/util/connection.py", line 86, in create_connection<br>
    sock.connect(sa)<br>
  File "/home/zulip/deployments/2021-06-03-21-00-31/zerver/worker/queue_processors.py", line 201, in timer_expired<br>
    raise WorkerTimeoutException(limit, event_count)<br>
zerver.worker.queue_processors.WorkerTimeoutException: Timed out after 30 seconds processing 1 events</p>
<p>Deployed code:</p>
<ul>
<li>git: None</li>
<li>ZULIP_VERSION: 4.3</li>
</ul>
<p>Request info: none<br>
'</p>



<a name="1203960"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1203960" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1203960">(Jun 08 2021 at 17:47)</a>:</h4>
<p><span class="user-mention" data-user-id="15773">@Edek Kredka</span>, can you show the output, run from your server, of:</p>
<div class="codehilite"><pre><span></span><code>curl -v https://push.zulipchat.com/api/v1/remotes/push/notify
</code></pre></div>



<a name="1203962"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1203962" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1203962">(Jun 08 2021 at 17:47)</a>:</h4>
<p>Also, what's the public IP of your server?  Feel free to PM me it if you'd prefer.</p>



<a name="1207432"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1207432" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1207432">(Jun 11 2021 at 21:15)</a>:</h4>
<p><span class="user-mention" data-user-id="15773">@Edek Kredka</span>: From PMs, it looks like Zulip isn't using your outgoing proxy.  Have you configured it according to <a href="https://zulip.readthedocs.io/en/latest/production/deployment.html#using-an-outgoing-http-proxy">https://zulip.readthedocs.io/en/latest/production/deployment.html#using-an-outgoing-http-proxy</a> ?</p>



<a name="1207434"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1207434" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1207434">(Jun 11 2021 at 21:16)</a>:</h4>
<p>If you were upgrading from &lt; 4.0, then it may have been accidentally working previously by picking up your existing environment variables, depending on how you started it.</p>
<p>We may want a bigger note in the upgrading docs about needing to explicitly set your outgoing proxy.</p>



<a name="1208380"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1208380" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edek Kredka <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1208380">(Jun 14 2021 at 07:36)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span>  thats true, wa are using proxy  ENV settings. <br>
I setup proxy setting by adding [http_proxy] section to zulip.conf file and apply changes,  but it did not help. Is there a possibility to check if zulip is using proxy settings ?</p>



<a name="1208656"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1208656" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1208656">(Jun 14 2021 at 16:23)</a>:</h4>
<p><span class="user-mention" data-user-id="15773">@Edek Kredka</span> what step did you take to apply changes?</p>



<a name="1209498"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1209498" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edek Kredka <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1209498">(Jun 15 2021 at 08:09)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  based on <a href="https://zulip.readthedocs.io/en/latest/production/deployment.html#using-an-outgoing-http-proxy">https://zulip.readthedocs.io/en/latest/production/deployment.html#using-an-outgoing-http-proxy</a></p>
<ol>
<li>add section [http_proxy] to /etc/zulip/zulip.conf</li>
</ol>
<p>[http_proxy]<br>
host = 192.168.215.9<br>
port = 1974</p>
<ol start="2">
<li>apply changes  by running /home/zulip/deployments/current/scripts/zulip-puppet-apply</li>
</ol>



<a name="1209825"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1209825" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1209825">(Jun 15 2021 at 18:51)</a>:</h4>
<p><span class="user-mention" data-user-id="15773">@Edek Kredka</span> ok; that should be all you need to do.  You can check whehter the configuration is being used by seeing whether <code>/etc/supervisor/conf.d/zulip/zulip.conf</code> has <code>HTTPS_proxy</code> lines.</p>



<a name="1209959"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1209959" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edek Kredka <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1209959">(Jun 15 2021 at 21:20)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  Sorry my mistake the push notification are already working :) <br>
 My suggestion was that pictures that were entered as http links were not displayed</p>



<a name="1310922"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1310922" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Hellerstedt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1310922">(Jan 17 2022 at 03:21)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="12178">@Alex Vandiver</span> do you have an example of what the output of  <code>curl -v https://push.zulipchat.com/api/v1/remotes/push/notify</code> should look like? I recently got around to upgrading some <code>4.3</code> servers to <code>4.8</code> and push has stopped working for me, I put up an issue with some more documentation <a href="https://github.com/zulip/zulip/issues/20772">here</a>.<br>
I'm wondering if the addition of Smokescreen is doing something strange, I did look through my <code>/etc/supervisor/conf.d/zulip/zulip.conf</code> and see in all the entries<br>
<code>environment=HTTP_proxy="http://localhost:4750",HTTPS_proxy="http://localhost:4750"</code><br>
server should be running in DMZ with no strange proxy stuff<br>
sorry to bother, thanks if you've got any clues for where I might look to chase down the problem</p>



<a name="1310927"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1310927" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Hellerstedt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1310927">(Jan 17 2022 at 04:27)</a>:</h4>
<p>Finally checked <code>supervisorctl status</code> and neither <code>go-camo</code> nor <code>smokescreen</code> were running (despite a server restart), but manually starting them again fixed this problem.</p>



<a name="1311071"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311071" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311071">(Jan 17 2022 at 19:35)</a>:</h4>
<p><span class="user-mention" data-user-id="22803">@Jack Hellerstedt</span>: Hm.  Is there anything in the supervisor or Zulip error logs that point to why camo and smokescreen weren't running?  Adding smokescreen to the supervisor config should have reloaded the config, and started the smokescreen process.</p>
<p>Can you post any of the stacktraces that you were getting?  Ideally we'd like this to go a good job of pointing a finger at the proxy.</p>
<p>But it's expected that the manual <code>curl</code> request with a GET with no credentials would give you a <code>Method not allowed</code> response.</p>



<a name="1311072"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311072" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311072">(Jan 17 2022 at 19:38)</a>:</h4>
<p>I guess, from the Github issue, the exception said "Bad Gateway" but seeing the full stacktrace may help if there are other details we can add.</p>



<a name="1311141"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311141" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Hellerstedt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311141">(Jan 18 2022 at 04:42)</a>:</h4>
<p>I run a daily backup:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>supervisorctl stop all
<span class="c1">## command to backup the zulip server</span>
su zulip -c <span class="s1">'/home/zulip/deployments/current/manage.py backup --output backup_filename</span>
<span class="s1">## restart server</span>
<span class="s1">su zulip -c '</span>/home/zulip/deployments/current/scripts/restart-server<span class="err">'</span>
</code></pre></div>
<p>it seems the <code>supervisor stop all</code> stops everything, but <code>restart-server</code> doesn't restart <code>smokescreen</code> and <code>go-camo</code> (logs said they were stopping gracefully, I had to stare at the timestamps to remember that I'm running a backup regularly)</p>
<p>I guess I can change those to <code>stop-server</code> and <code>start-server</code> on either side of the backup call, and <code>smokescreen</code> and <code>go-camo</code> should just run through that.  I guess it's worth noting that <code>restart-server</code> or <code>start-server</code> don't bring those two services back up if they've been stopped.</p>



<a name="1311416"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311416" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311416">(Jan 18 2022 at 21:23)</a>:</h4>
<p>Hm.  I think it's a reasonable expectation that <code>restart-server</code>/<code>start-server</code> would make sure that all of the needed services are running, even if we don't take them down with <code>stop-server</code>.  I think I agree that it should start smokscreen and camo if they're installed on the host, yeah.</p>



<a name="1311421"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311421" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311421">(Jan 18 2022 at 21:24)</a>:</h4>
<p>We don't bring those down on stop because they're stateless, and not affected by code deploys.</p>



<a name="1311424"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311424" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311424">(Jan 18 2022 at 21:25)</a>:</h4>
<p>Yeah, I think I agree that it's a bug to not start those services if they are expected to be running via supervisord.</p>



<a name="1311426"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311426" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311426">(Jan 18 2022 at 21:26)</a>:</h4>
<p>That said <span class="user-mention" data-user-id="22803">@Jack Hellerstedt</span>, you should probably update your script to do <code>stop-server</code> rather than <code>supervisorctl stop all</code>; the latter used to be our only documented mechanism for stopping a server, but <code>stop-server</code> is now preferred.</p>



<a name="1311505"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311505" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311505">(Jan 18 2022 at 22:47)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/pull/20832">#20832</a>.</p>



<a name="1311507"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311507" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311507">(Jan 18 2022 at 22:48)</a>:</h4>
<p><span class="user-mention" data-user-id="22803">@Jack Hellerstedt</span>: Did you have the stacktraces handy that were getting spit out?</p>



<a name="1311509"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311509" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Hellerstedt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311509">(Jan 18 2022 at 22:51)</a>:</h4>
<p>are you looking for the output of <code>pstack pid</code> ? Sorry I haven't pulled a stacktrace before.  Happy to stop <code>go-camo</code> &amp; <code>smokescreen</code> again and see what I get</p>



<a name="1311514"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311514" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311514">(Jan 18 2022 at 22:53)</a>:</h4>
<p>Oh, hm.  I assume <a href="https://github.com/zulip/zulip/pull/20772">#20772</a> was the full content of the email you were getting?  That doesn't have a stacktrace, which seems like its own big.</p>
<p>What did the errors in <code>/var/log/zulip/error.log</code> look like?</p>



<a name="1311518"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311518" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Hellerstedt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311518">(Jan 18 2022 at 22:59)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="m">2022</span>-01-17 <span class="m">02</span>:04:16.404 ERR  <span class="o">[</span>django.request<span class="o">]</span> Bad Gateway: /api/v1/users/me/apns_device_token
<span class="m">2022</span>-01-17 <span class="m">02</span>:43:42.521 ERR  <span class="o">[</span>django.request<span class="o">]</span> Bad Gateway: /api/v1/users/me/android_gcm_reg_id
<span class="m">2022</span>-01-17 <span class="m">02</span>:45:21.222 WARN <span class="o">[</span>zerver.worker.queue_processors<span class="o">]</span> Maximum retries exceeded <span class="k">for</span> trigger:42 event:push_notification
</code></pre></div>
<p>where the log was awash with that warning, replace <code>42</code> with presumably every other number'd user also getting a failed push</p>



<a name="1311526"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311526" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311526">(Jan 18 2022 at 23:05)</a>:</h4>
<p>Hm, OK.  "Bad Gateway" is really the specific problem.  We can maybe make things clearer by overriding something in <code>zerver.lib.outgoing_http</code> to make that hint more explicitly at Smokescreen or other proxy.  But we'd want to make sure that doesn't muddle things by pointing at smokescreen in cases where it <em>did</em> talk to a remote server, and <em>that</em> server returned the 502.</p>



<a name="1311527"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311527" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Hellerstedt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311527">(Jan 18 2022 at 23:10)</a>:</h4>
<p>in retrospect link previews were also not loading, but those failures to load weren't showing up anywhere in the logs when I was poking around trying to fix push</p>



<a name="1311529"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311529" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311529">(Jan 18 2022 at 23:12)</a>:</h4>
<p>Mmm, because that's a failure almost strictly on the browser end.  Zulip generates a link to camo, but doesn't need to talk to camo to do that.  The browser tries to follow the URL that is so generated, and nginx was probably spewing errors there talking to a down'd camo.</p>



<a name="1311530"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Push%20notification%20problem/near/1311530" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Push.20notification.20problem.html#1311530">(Jan 18 2022 at 23:12)</a>:</h4>
<p>But looking at the nginx logs generally isn't useful, so it makes sense that that wouldn't have been a thing to look at immedaitely.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>