<html>
<head><meta charset="utf-8"><title>user_uploads · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html">user_uploads</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="710081"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/710081" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AcidWeb <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#710081">(Mar 01 2019 at 09:52)</a>:</h4>
<p>Hi, after updating 1.9.0 -&gt; 1.9.2 all user_uploads/* return 404. Files are there. Upload mechanism works too.</p>



<a name="710082"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/710082" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AcidWeb <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#710082">(Mar 01 2019 at 09:54)</a>:</h4>
<p>In error.log of Zulip I see this type of errors <code>WARN [django.request] Not Found: /serve_uploads/2/6b/CvUgQ1rRpJrjwnH3Y_M5ufok/box.JPG</code></p>



<a name="710249"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/710249" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#710249">(Mar 01 2019 at 17:11)</a>:</h4>
<p><span class="user-mention" data-user-id="11510">@AcidWeb</span> hmm, that sounds like an issue with your <code>nginx</code> configuration.</p>



<a name="710250"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/710250" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#710250">(Mar 01 2019 at 17:12)</a>:</h4>
<p>Can you talk a bit about how precisely you did the upgrade?</p>



<a name="710252"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/710252" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#710252">(Mar 01 2019 at 17:12)</a>:</h4>
<p>And what upload backend you're using?</p>



<a name="710253"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/710253" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#710253">(Mar 01 2019 at 17:12)</a>:</h4>
<p>And maybe also what's in <code>/etc/zulip/zulip.conf</code>?</p>



<a name="711637"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711637" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711637">(Mar 02 2019 at 17:57)</a>:</h4>
<p>Just ran into the same issue going from 1.9.1 -&gt; 2.0.0 on Trusty</p>



<a name="711638"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711638" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711638">(Mar 02 2019 at 17:58)</a>:</h4>
<p>Upgraded via git, to the 2.0.0 tag</p>



<a name="711671"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711671" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711671">(Mar 02 2019 at 18:06)</a>:</h4>
<p>Impacts both new uploads and old uploads (like you said probably a server config issue)</p>



<a name="711672"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711672" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711672">(Mar 02 2019 at 18:06)</a>:</h4>
<p>Uploads don't trigger any errors, so they'll likely working</p>



<a name="711676"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711676" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711676">(Mar 02 2019 at 18:07)</a>:</h4>
<p><code>restart-server</code> script does not resolve, neither does rebooting the server itself..</p>



<a name="711678"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711678" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711678">(Mar 02 2019 at 18:08)</a>:</h4>
<p>conf.py:</p>
<div class="codehilite"><pre><span></span>[machine]
puppet_classes = zulip::voyager, zulip::static_asset_compiler
deploy_type = voyager
</pre></div>



<a name="711681"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711681" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711681">(Mar 02 2019 at 18:11)</a>:</h4>
<p>nginx.conf identical to <a href="https://github.com/zulip/zulip/blob/master/puppet/zulip/files/nginx/nginx.conf" target="_blank" title="https://github.com/zulip/zulip/blob/master/puppet/zulip/files/nginx/nginx.conf">Zulip's nginx.conf in repo</a></p>



<a name="711682"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711682" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711682">(Mar 02 2019 at 18:11)</a>:</h4>
<p>We're using a self signed cert</p>



<a name="711684"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711684" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711684">(Mar 02 2019 at 18:13)</a>:</h4>
<p>When I try to go to the URL of the image directly, it makes me authenticate- which I thought wasn't going to be supported on Trusty</p>



<a name="711685"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711685" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711685">(Mar 02 2019 at 18:14)</a>:</h4>
<p>(instead images would be served without regard to authentication)</p>



<a name="711691"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711691" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711691">(Mar 02 2019 at 18:26)</a>:</h4>
<p>Other parts of our nginx configuration files do not match the files I'm seeing at <a href="https://github.com/zulip/zulip/commits/master/puppet/zulip/files/nginx" target="_blank" title="https://github.com/zulip/zulip/commits/master/puppet/zulip/files/nginx">https://github.com/zulip/zulip/commits/master/puppet/zulip/files/nginx</a> </p>
<p>Edit: Ahh, this is because of the puppet install. Looking at nginx.pp trusty gets zulip-include-maybe/direct redirected to zulip-include/uploads.route</p>



<a name="711692"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711692" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711692">(Mar 02 2019 at 18:27)</a>:</h4>
<p>(nevermind)</p>



<a name="711693"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711693" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711693">(Mar 02 2019 at 18:28)</a>:</h4>
<p>I remember <a href="https://github.com/zulip/zulip/commit/efe85453039e9ef9e1a7a503e33d8b21e91e5fa9#diff-7f650084f892af5ba032222273d372e7" target="_blank" title="https://github.com/zulip/zulip/commit/efe85453039e9ef9e1a7a503e33d8b21e91e5fa9#diff-7f650084f892af5ba032222273d372e7">this commit</a> is were Zulip first started authenticating local uploads, but it has support for the older versions of nginx</p>



<a name="711696"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711696" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711696">(Mar 02 2019 at 18:33)</a>:</h4>
<p>Confirmed file uploads work, and the file is actually in the expected place. It's just not being served correctly</p>



<a name="711697"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711697" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711697">(Mar 02 2019 at 18:38)</a>:</h4>
<p>Content-Security-Policy was added in <a href="https://github.com/zulip/zulip/commit/d608a9d315a3dae90033d36cdf591eb3227ce30e#diff-9b57523c22e695172bd9a625be44ddfc" target="_blank" title="https://github.com/zulip/zulip/commit/d608a9d315a3dae90033d36cdf591eb3227ce30e#diff-9b57523c22e695172bd9a625be44ddfc">this commit</a> to uploads-route.direct, then further modified in <a href="https://github.com/zulip/zulip/commit/4898fe7ebc4e249e487a84b81cf2730cb24ced33#diff-9b57523c22e695172bd9a625be44ddfc" target="_blank" title="https://github.com/zulip/zulip/commit/4898fe7ebc4e249e487a84b81cf2730cb24ced33#diff-9b57523c22e695172bd9a625be44ddfc">this commit</a> but removing that line doesn't result in being able to view uploads (even after full reboot)</p>



<a name="711699"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711699" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711699">(Mar 02 2019 at 18:41)</a>:</h4>
<p>Self signed cert shouldn't be an issue, since images also fail on a machine with the self signed cert's organization certifier present (acts like a trusted cert for those machines)</p>



<a name="711703"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711703" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711703">(Mar 02 2019 at 18:50)</a>:</h4>
<p>And we've exhausted my ability to troubleshoot. Happy to help anyone attempting to debug the issue root around.</p>



<a name="711710"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711710" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711710">(Mar 02 2019 at 18:58)</a>:</h4>
<p>Created <a href="https://github.com/zulip/zulip/pull/11758" target="_blank" title="https://github.com/zulip/zulip/pull/11758">#11758</a></p>



<a name="711713"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711713" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711713">(Mar 02 2019 at 19:04)</a>:</h4>
<p><span class="user-mention" data-user-id="3733">@Sean Wallitsch</span> thanks for the rpeort</p>



<a name="711714"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711714" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711714">(Mar 02 2019 at 19:04)</a>:</h4>
<p>anytime</p>



<a name="711715"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711715" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711715">(Mar 02 2019 at 19:05)</a>:</h4>
<p>Did you say you're on Trusty?</p>



<a name="711716"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711716" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711716">(Mar 02 2019 at 19:05)</a>:</h4>
<p>Yup</p>



<a name="711717"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711717" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711717">(Mar 02 2019 at 19:05)</a>:</h4>
<p>What do you have in <code>/etc/nginx/zulip-include/uploads.route</code>?</p>



<a name="711718"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711718" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711718">(Mar 02 2019 at 19:06)</a>:</h4>
<div class="codehilite"><pre><span></span>location /user_uploads {
    add_header X-Content-Type-Options nosniff;
    add_header Content-Security-Policy &quot;default-src &#39;none&#39;; style-src &#39;self&#39; &#39;unsafe-inline&#39;; img-src &#39;self&#39;; object-src &#39;self&#39;; plugin-types application/pdf;&quot;;
    include /etc/nginx/zulip-include/uploads.types;
    alias /home/zulip/uploads/files;
}
</pre></div>



<a name="711719"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711719" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711719">(Mar 02 2019 at 19:07)</a>:</h4>
<p>do you have a block of this form in <code>zulip-enterprise.conf</code>?</p>
<div class="codehilite"><pre><span></span>    location /user_avatars {
        add_header X-Content-Type-Options nosniff;
        add_header Content-Security-Policy &quot;default-src &#39;none&#39; img-src &#39;self&#39;&quot;;
        include /etc/nginx/zulip-include/uploads.types;
        alias /home/zulip/uploads/avatars;
    }
</pre></div>



<a name="711720"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711720" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711720">(Mar 02 2019 at 19:07)</a>:</h4>
<p>In the <code>nginx</code> config?</p>



<a name="711722"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711722" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711722">(Mar 02 2019 at 19:08)</a>:</h4>
<p>yes</p>
<div class="codehilite"><pre><span></span>    location /user_avatars {
        add_header X-Content-Type-Options nosniff;
        add_header Content-Security-Policy &quot;default-src &#39;none&#39; img-src &#39;self&#39;&quot;;
        include /etc/nginx/zulip-include/uploads.types;
        alias /home/zulip/uploads/avatars;
    }
</pre></div>



<a name="711723"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711723" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711723">(Mar 02 2019 at 19:08)</a>:</h4>
<p>and at the bottom.. <code>include /etc/nginx/zulip-include/uploads.route;</code></p>



<a name="711724"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711724" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711724">(Mar 02 2019 at 19:09)</a>:</h4>
<p>Oh, I think I know what the bug is.</p>



<a name="711725"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711725" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711725">(Mar 02 2019 at 19:10)</a>:</h4>
<p>So, can you try commenting out this block of <code>/etc/nginx/zulip-include/app</code>:</p>
<div class="codehilite"><pre><span></span># Certain Django routes not under /api are shared between mobile and
# web and thus need API headers added.  We don&#39;t collapse this with the
# above block for /events, because regular expressions take priority over
# paths in nginx&#39;s order-of-operations, and we don&#39;t want to override the
# tornado stuff.
location ~ ^/(user_uploads|avatar|thumbnail)/ {
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Headers Authorization;
    add_header Access-Control-Allow-Methods &#39;GET, POST, DELETE, PUT, PATCH, HEAD&#39;;

    include uwsgi_params;
    uwsgi_pass django;
}
</pre></div>


<p>and reloading <code>nginx</code>?</p>



<a name="711726"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711726" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711726">(Mar 02 2019 at 19:10)</a>:</h4>
<p>I'll have a cleaner fix in 10 minutes</p>



<a name="711727"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711727" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711727">(Mar 02 2019 at 19:10)</a>:</h4>
<p>But worth verifying that works</p>



<a name="711728"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711728" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711728">(Mar 02 2019 at 19:11)</a>:</h4>
<p>on it</p>



<a name="711736"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711736" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711736">(Mar 02 2019 at 19:15)</a>:</h4>
<p>Works</p>



<a name="711739"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711739" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711739">(Mar 02 2019 at 19:17)</a>:</h4>
<p>cool, I'll work on a cleaner solution and plan to include that in a 2.0.1 this weekend</p>



<a name="711741"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711741" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711741">(Mar 02 2019 at 19:19)</a>:</h4>
<p>thanks a ton man</p>



<a name="711977"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711977" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711977">(Mar 03 2019 at 02:07)</a>:</h4>
<p><span class="user-mention" data-user-id="3733">@Sean Wallitsch</span> merged the cleaner solution, which it'd be great if you can verify.</p>



<a name="711988"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711988" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711988">(Mar 03 2019 at 02:37)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I'll upgrade the server later tonight and report back</p>



<a name="711994"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711994" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711994">(Mar 03 2019 at 05:16)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> upgrade repeatedly failed. </p>
<div class="codehilite"><pre><span></span>ubuntu@zulip:/etc/nginx/zulip-include$ cd /home/zulip/deployments/current/scripts/
ubuntu@zulip:/home/zulip/deployments/current/scripts$ sudo ./upgrade-zulip-from-git master
[snip]
+ cp -R node_modules/katex/dist/fonts /home/zulip/prod-static/node_modules/katex/dist/fonts
+ ./manage.py collectstatic --no-default-ignore --noinput -i assets -inode_modules -i styles -i templates

Error running a subcommand of ./tools/update-prod-static: ./manage.py collectstatic --no-default-ignore --noinput -i assets -inode_modules -i styles -i templates
Actual error output for the subcommand is just above this.

Traceback (most recent call last):
  File &quot;./tools/update-prod-static&quot;, line 85, in &lt;module&gt;
    stdout=fp, stderr=fp)
  File &quot;./tools/../scripts/lib/zulip_tools.py&quot;, line 196, in run
    subprocess.check_call(args, **kwargs)
  File &quot;/usr/lib/python3.4/subprocess.py&quot;, line 561, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;collectstatic&#39;, &#39;--no-default-ignore&#39;, &#39;--noinput&#39;, &#39;-i&#39;, &#39;assets&#39;, &#39;-inode_modules&#39;, &#39;-i&#39;, &#39;styles&#39;, &#39;-i&#39;, &#39;templates&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2019-03-02-20-55-46/scripts/lib/upgrade-zulip-stage-2&quot;, line 111, in &lt;module&gt;
    preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python3.4/subprocess.py&quot;, line 561, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./tools/update-prod-static&#39;, &#39;--authors-not-required&#39;, &#39;--prev-deploy&#39;, &#39;/home/zulip/deployments/current&#39;]&#39; returned non-zero exit status 1
Traceback (most recent call last):
  File &quot;./lib/upgrade-zulip-from-git&quot;, line 68, in &lt;module&gt;
    deploy_path, &quot;--from-git&quot;] + deploy_options)
  File &quot;/usr/lib/python3.4/subprocess.py&quot;, line 561, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2019-03-02-20-55-46/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2019-03-02-20-55-46&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1
</pre></div>



<a name="711996"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/711996" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#711996">(Mar 03 2019 at 05:32)</a>:</h4>
<p>trying to upgrade to 22381f9ce</p>



<a name="712280"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712280" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712280">(Mar 03 2019 at 18:05)</a>:</h4>
<p><span class="user-mention" data-user-id="3733">@Sean Wallitsch</span> interesting; can you post what you have in <code>var/log/update-prod-static.log</code> (from inside <code>/home/zulip/deployments/next</code>?</p>



<a name="712281"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712281" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712281">(Mar 03 2019 at 18:05)</a>:</h4>
<p>That should give what the actual error was in collecting static assets.</p>



<a name="712467"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712467" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712467">(Mar 04 2019 at 00:23)</a>:</h4>
<p>sorry, should have done that right off the bat.</p>



<a name="712469"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712469" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712469">(Mar 04 2019 at 00:26)</a>:</h4>
<div class="codehilite"><pre><span></span>    [1] ./static/third/zocial/zocial.eot 62 bytes {0} [built]
    [3] ./static/third/zocial/zocial.ttf 62 bytes {0} [built]
    [4] ./static/third/zocial/zocial.woff 63 bytes {0} [built]
    [6] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!./static/third/zocial/zocial.css 95.3 KiB {0} [built]
    [7] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/portico-styles.scss 121 KiB {0} [built]
        + 2 hidden modules
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/pygments.scss:
    Entrypoint mini-css-extract-plugin = *
    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/pygments.scss 16 KiB {0} [built]
        + 1 hidden module
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/reactions.scss:
    Entrypoint mini-css-extract-plugin = *
    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/reactions.scss 12.2 KiB {0} [built]
        + 1 hidden module
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/right-sidebar.scss:
    Entrypoint mini-css-extract-plugin = *
    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/right-sidebar.scss 8.1 KiB {0} [built]
        + 1 hidden module
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/settings.scss:
                 Asset       Size  Chunks             Chunk Names
    files/dropdown.png  370 bytes          [emitted]
    Entrypoint mini-css-extract-plugin = *
    [0] ./static/images/dropdown.png 64 bytes {0} [built]
    [3] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/settings.scss 74.9 KiB {0} [built]
        + 2 hidden modules
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/stats.scss:
    Entrypoint mini-css-extract-plugin = *
    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/stats.scss 8.53 KiB {0} [built]
        + 1 hidden module
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/subscriptions.scss:
                        Asset       Size  Chunks             Chunk Names
    files/preview-loading.png  808 bytes          [emitted]
    Entrypoint mini-css-extract-plugin = *
    [0] ./static/images/preview-loading.png 71 bytes {0} [built]
    [3] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/subscriptions.scss 43.6 KiB {0} [built]
        + 2 hidden modules
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/typing_notifications.scss:
    Entrypoint mini-css-extract-plugin = *
    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/typing_notifications.scss 854 bytes {0} [built]
        + 1 hidden module
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/user_circles.scss:
    Entrypoint mini-css-extract-plugin = *
    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/user_circles.scss 3.6 KiB {0} [built]
        + 1 hidden module
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/user_status.scss:
    Entrypoint mini-css-extract-plugin = *
    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/user_status.scss 1.37 KiB {0} [built]
        + 1 hidden module
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/widgets.scss:
    Entrypoint mini-css-extract-plugin = *
    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/widgets.scss 5 KiB {0} [built]
        + 1 hidden module
Child mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/zulip.scss:
    Entrypoint mini-css-extract-plugin = *
    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/zulip.scss 111 KiB {0} [built]
        + 1 hidden module
manage.py should not be run as root. Use `su root` to switch to the &#39;zulip&#39;
user before rerunning this, or use
  su root -c &#39;/home/zulip/deployments/2019-03-02-20-55-46/manage.py ...&#39;
to switch users and run this as a single command.
</pre></div>



<a name="712470"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712470" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712470">(Mar 04 2019 at 00:27)</a>:</h4>
<p>yet, I'm supposed to be running <code>./upgrade-zulip-from-git</code> with sudo, correct?</p>



<a name="712480"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712480" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712480">(Mar 04 2019 at 03:32)</a>:</h4>
<p><span class="user-mention" data-user-id="3733">@Sean Wallitsch</span> so my guess is the problem is that we made a change that makes running <code>upgrade-zulip-from-git</code> under <code>sudo</code> not work properly in some circumstances.  If I had to guess, it's <span class="user-mention" data-user-id="699">@Anders Kaseorg</span>'s work to make this function in <code>zulip_tools.py</code> taht's supposed to drop privileges from root to the <code>zulip</code> user:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">su_to_zulip</span><span class="p">(</span><span class="n">save_suid</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># type: (bool) -&gt; None</span>
    <span class="sd">&quot;&quot;&quot;Warning: su_to_zulip assumes that the zulip checkout is owned by</span>
<span class="sd">    the zulip user (or whatever normal user is running the Zulip</span>
<span class="sd">    installation).  It should never be run from the installer or other</span>
<span class="sd">    production contexts before /home/zulip/deployments/current is</span>
<span class="sd">    created.&quot;&quot;&quot;</span>
    <span class="n">pwent</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">get_zulip_uid</span><span class="p">())</span>
    <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_suid</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setresuid</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">pwent</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwent</span><span class="o">.</span><span class="n">pw_dir</span>
</pre></div>


<p>in <a href="https://github.com/zulip/zulip/commit/ebad0b7cbf391f326f4a63448ca71ddcdb1cc303" target="_blank" title="https://github.com/zulip/zulip/commit/ebad0b7cbf391f326f4a63448ca71ddcdb1cc303">ebad0b7cbf391f326f4a63448ca71ddcdb1cc303</a></p>



<a name="712481"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712481" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712481">(Mar 04 2019 at 03:32)</a>:</h4>
<p>Can you try doing a bit of print-debugging to see what <code>pw_uid</code>  is being userd here (in theory, this should be the UID of the <code>zulip</code> user)</p>



<a name="712510"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712510" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AcidWeb <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712510">(Mar 04 2019 at 06:16)</a>:</h4>
<p>I want just confirm that commenting that nginx config block also fixed issue for me on 1.9.2.</p>



<a name="712703"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712703" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Priyank Patel <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712703">(Mar 04 2019 at 16:13)</a>:</h4>
<p>I noticed one minor thing in the logs attached above in <a href="#narrow/stream/31-production-help/topic/user_uploads/near/711994" title="#narrow/stream/31-production-help/topic/user_uploads/near/711994">this message</a> about the <code>collecstatic</code> manage.py command:</p>
<div class="codehilite"><pre><span></span>+ ./manage.py collectstatic --no-default-ignore --noinput -i assets -inode_modules ...
</pre></div>


<p>There is no space after <code>-i</code> at <code>-inode_modules</code> which seems like a bug in how we pass argument for that part. I don't know if that make a lot of difference but just something I noticed.</p>



<a name="712707"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712707" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Priyank Patel <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712707">(Mar 04 2019 at 16:19)</a>:</h4>
<p>Looking at <code>tools/update-prod-static</code> we are missing a comma after on <a href="https://github.com/zulip/zulip/blob/7d12e2019de5bc2311ea8b1060ff917f8aa5c7c2/tools/update-prod-static#L84" target="_blank" title="https://github.com/zulip/zulip/blob/7d12e2019de5bc2311ea8b1060ff917f8aa5c7c2/tools/update-prod-static#L84">line 84</a> which causes <code>-inode_modules</code> and was introduced in <a href="https://github.com/zulip/zulip/commit/d71f2e7b9bd2e1e622237eee381b62813b8ecaaa" target="_blank" title="https://github.com/zulip/zulip/commit/d71f2e7b9bd2e1e622237eee381b62813b8ecaaa">d71f2e7b9bd2e1e622237eee381b62813b8ecaaa</a>.</p>



<a name="712710"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712710" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712710">(Mar 04 2019 at 16:29)</a>:</h4>
<p><span class="user-mention" data-user-id="4241">@Priyank</span> hmm, interesting.  It's possible that the argument parsing for <code>manage.py collectstatic</code> is such that this happens to work, but certainly we should change it.  I'm going to test fixing that to be how the code is clearly intended to read...</p>



<a name="712826"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712826" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712826">(Mar 04 2019 at 17:35)</a>:</h4>
<p>I can try some troubleshooting tonight</p>



<a name="712927"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712927" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712927">(Mar 04 2019 at 20:18)</a>:</h4>
<p>I've added print debugging and am attempting an upgrade</p>



<a name="712929"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712929" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712929">(Mar 04 2019 at 20:23)</a>:</h4>
<p>As expected, this doesn't seem to be changing to the user correctly.</p>
<div class="codehilite"><pre><span></span>su_to_zulip: pwent.pw_gid is 0
su_to_zulip: os.getgid is 0
su_to_zulip: os.setuid result: 0
su_to_zulip: $HOME set result: /root
</pre></div>


<p>the zulip id is 1002</p>
<p>my print statements:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">su_to_zulip</span><span class="p">(</span><span class="n">save_suid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># type: (bool) -&gt; None</span>
    <span class="sd">&quot;&quot;&quot;Warning: su_to_zulip assumes that the zulip checkout is owned by</span>
<span class="sd">    the zulip user (or whatever normal user is running the Zulip</span>
<span class="sd">    installation).  It should never be run from the installer or other</span>
<span class="sd">    production contexts before /home/zulip/deployments/current is</span>
<span class="sd">    created.&quot;&quot;&quot;</span>
    <span class="n">pwent</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">get_zulip_uid</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;su_to_zulip: pwent.pw_gid is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;su_to_zulip: os.getgid is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">save_suid</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting os.setresuid with: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">pwent</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setresuid</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">pwent</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;su_to_zulip: os.setresuid results: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getresuid</span><span class="p">()</span>
        <span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;su_to_zulip: os.setuid result: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwent</span><span class="o">.</span><span class="n">pw_dir</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;su_to_zulip: $HOME set result: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]))</span>
</pre></div>



<a name="712995"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/712995" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#712995">(Mar 04 2019 at 21:13)</a>:</h4>
<p><span class="user-mention" data-user-id="3733">@Sean Wallitsch</span> I guess it's <code>get_zulip_uid</code> you should be print-debugging.</p>



<a name="713000"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713000" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713000">(Mar 04 2019 at 21:25)</a>:</h4>
<p>yup.</p>



<a name="713001"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713001" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713001">(Mar 04 2019 at 21:25)</a>:</h4>
<p>after looking at how that's working, it's likely because all of these upgrade directories are being owned by root</p>



<a name="713002"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713002" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713002">(Mar 04 2019 at 21:26)</a>:</h4>
<p>the last directory to be owned by zulip was the 2.0 upgrade</p>



<a name="713003"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713003" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713003">(Mar 04 2019 at 21:26)</a>:</h4>
<div class="codehilite"><pre><span></span>drwxr-xr-x 26 zulip zulip 4096 Mar  2 09:27 2019-03-02-09-22-50/
drwxr-xr-x 24 root  root  4096 Mar  2 20:50 2019-03-02-20-48-46/
drwxr-xr-x 24 root  root  4096 Mar  2 20:53 2019-03-02-20-52-50/
drwxr-xr-x 24 root  root  4096 Mar  2 20:56 2019-03-02-20-55-46/
drwxr-xr-x 24 root  root  4096 Mar  4 12:21 2019-03-04-12-20-19/
</pre></div>



<a name="713005"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713005" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713005">(Mar 04 2019 at 21:26)</a>:</h4>
<p>I'm proceeding with the print debugging though</p>



<a name="713010"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713010" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713010">(Mar 04 2019 at 21:32)</a>:</h4>
<p>yup, eveerything during the upgrade is set as root....</p>
<div class="codehilite"><pre><span></span>filepath: /home/zulip/deployments/2019-03-04-13-31-05/scripts/lib/zulip_tools.py
file owner: 0
dir path: /home/zulip/deployments/2019-03-04-13-31-05/scripts/lib
dir owner 0
dir2 path: /home/zulip/deployments/2019-03-04-13-31-05/scripts
dir2 owner: 0
dir3 path: /home/zulip/deployments/2019-03-04-13-31-05
dir3 owner: 0
deploy root: /home/zulip/deployments/2019-03-04-13-31-05
filepath: /home/zulip/deployments/2019-03-04-13-31-05/scripts/lib/zulip_tools.py
file owner: 0
dir path: /home/zulip/deployments/2019-03-04-13-31-05/scripts/lib
dir owner 0
dir2 path: /home/zulip/deployments/2019-03-04-13-31-05/scripts
dir2 owner: 0
dir3 path: /home/zulip/deployments/2019-03-04-13-31-05
dir3 owner: 0
su_to_zulip: pwent.pw_gid is 0
su_to_zulip: os.getgid is 0
su_to_zulip: os.setuid result: 0
su_to_zulip: $HOME set result: /root
</pre></div>



<a name="713013"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713013" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713013">(Mar 04 2019 at 21:33)</a>:</h4>
<p>debugging code:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_deploy_root</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># This calls realpath twice to handle both symlinks and users</span>
    <span class="c1"># running our scripts with relative paths from a current working</span>
    <span class="c1"># directory of `scripts/`.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;filepath: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;file owner: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span><span class="o">.</span><span class="n">st_uid</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dir path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dir owner </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span><span class="o">.</span><span class="n">st_uid</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dir2 path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dir2 owner: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))))</span><span class="o">.</span><span class="n">st_uid</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dir3 path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dir3 owner: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))))</span><span class="o">.</span><span class="n">st_uid</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))))</span>

<span class="k">def</span> <span class="nf">get_zulip_uid</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;deploy root: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_deploy_root</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">get_deploy_root</span><span class="p">())</span><span class="o">.</span><span class="n">st_uid</span>
</pre></div>



<a name="713025"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713025" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713025">(Mar 04 2019 at 21:48)</a>:</h4>
<p>OK, weird -- how are you doing the upgrade?</p>



<a name="713026"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713026" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713026">(Mar 04 2019 at 21:48)</a>:</h4>
<p><code>ubuntu@zulip:/home/zulip/deployments/current/scripts$ sudo ./upgrade-zulip-from-git master</code></p>



<a name="713027"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713027" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713027">(Mar 04 2019 at 21:48)</a>:</h4>
<p>current is currently owned by the zulip user still</p>



<a name="713028"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713028" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713028">(Mar 04 2019 at 21:49)</a>:</h4>
<p>and this was how I upgraded to 2.0</p>



<a name="713030"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713030" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713030">(Mar 04 2019 at 21:49)</a>:</h4>
<p>I have a theory</p>



<a name="713032"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713032" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713032">(Mar 04 2019 at 21:49)</a>:</h4>
<p>So, on <a href="http://chat.zulip.org" target="_blank" title="http://chat.zulip.org">chat.zulip.org</a>, they are all owned by <code>zulip</code>.</p>



<a name="713033"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713033" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713033">(Mar 04 2019 at 21:50)</a>:</h4>
<p>But the logic for computing the zulip uid copies the user ID from the last deployment...</p>



<a name="713035"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713035" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713035">(Mar 04 2019 at 21:50)</a>:</h4>
<p>So if you got one owned by root somehow, you could get into this state where new ones preserve that.</p>



<a name="713036"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713036" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713036">(Mar 04 2019 at 21:52)</a>:</h4>
<p>hmm, let me rm all the other deployment dirs. do I need to redirect <code>next</code>?</p>



<a name="713037"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713037" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713037">(Mar 04 2019 at 21:52)</a>:</h4>
<p>Just chown them</p>



<a name="713038"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713038" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713038">(Mar 04 2019 at 21:52)</a>:</h4>
<p>It only uses the realpath of <code>current</code> (aka what the symlink points to) for this determination</p>



<a name="713039"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713039" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713039">(Mar 04 2019 at 21:54)</a>:</h4>
<p>current is owned by zulip already :/</p>



<a name="713040"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713040" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713040">(Mar 04 2019 at 21:54)</a>:</h4>
<p>The symlink is, but its destination is not</p>



<a name="713041"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713041" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713041">(Mar 04 2019 at 21:55)</a>:</h4>
<p>And we follow symlinks before reading the owner.</p>



<a name="713042"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713042" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713042">(Mar 04 2019 at 21:55)</a>:</h4>
<p>no, I meant, the deployment dir that current was pointing to</p>



<a name="713043"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713043" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713043">(Mar 04 2019 at 21:55)</a>:</h4>
<p>was already owned by zulip</p>



<a name="713045"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713045" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713045">(Mar 04 2019 at 21:56)</a>:</h4>
<div class="codehilite"><pre><span></span>drwxr-xr-x  9 zulip zulip 4096 Mar  4 13:32 ./
drwxr-xr-x 13 zulip zulip 4096 Apr 12  2018 ../
drwxr-xr-x 26 zulip zulip 4096 Nov  8 21:59 2018-11-09-13-53-50/
drwxr-xr-x 26 zulip zulip 4096 Mar  2 09:27 2019-03-02-09-22-50/
drwxr-xr-x 24 zulip zulip 4096 Mar  2 20:50 2019-03-02-20-48-46/
drwxr-xr-x 24 root  root  4096 Mar  2 20:53 2019-03-02-20-52-50/
drwxr-xr-x 24 root  root  4096 Mar  2 20:56 2019-03-02-20-55-46/
drwxr-xr-x 24 root  root  4096 Mar  4 12:21 2019-03-04-12-20-19/
drwxr-xr-x 24 root  root  4096 Mar  4 13:31 2019-03-04-13-31-05/
lrwxrwxrwx  1 zulip zulip   43 Mar  2 09:29 current -&gt; /home/zulip/deployments/2019-03-02-09-22-50/
lrwxrwxrwx  1 zulip zulip   43 Mar  2 09:29 last -&gt; /home/zulip/deployments/2018-11-09-13-53-50/
lrwxrwxrwx  1 root  root    43 Mar  4 13:31 next -&gt; /home/zulip/deployments/2019-03-04-13-31-05/
srwx------  1 zulip zulip    0 Mar  3 06:00 uwsgi-socket=
</pre></div>


<p>(I've only chown'd <code>2019-03-02-20-48-46</code> at this point)</p>



<a name="713046"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713046" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713046">(Mar 04 2019 at 21:57)</a>:</h4>
<p>all chown's complete. attempting upgrade</p>



<a name="713047"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713047" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713047">(Mar 04 2019 at 21:58)</a>:</h4>
<p>new deployment is still owned by root, so this one is about to fail</p>



<a name="713049"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713049" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713049">(Mar 04 2019 at 22:01)</a>:</h4>
<p>I'm assuming there's some installs that don't use the <code>zulip</code> user, otherwise we'd just be using <code>pwd.getpwnam('zulip').pw_uid</code></p>



<a name="713053"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713053" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713053">(Mar 04 2019 at 22:18)</a>:</h4>
<p>OK, well, <span class="user-mention" data-user-id="3733">@Sean Wallitsch</span> I'm about to merge a fix for this.</p>



<a name="713054"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713054" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713054">(Mar 04 2019 at 22:19)</a>:</h4>
<p>I can test immediately</p>



<a name="713055"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713055" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713055">(Mar 04 2019 at 22:19)</a>:</h4>
<p>or even your PR if you'd like</p>



<a name="713056"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713056" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713056">(Mar 04 2019 at 22:22)</a>:</h4>
<p>About to merge to master; is there an issue ID for this?</p>



<a name="713059"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713059" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713059">(Mar 04 2019 at 22:27)</a>:</h4>
<p>Appears not, fixed in <a href="https://github.com/zulip/zulip/commit/b3444354aacada3243df568e75d51846e04a8c34" target="_blank" title="https://github.com/zulip/zulip/commit/b3444354aacada3243df568e75d51846e04a8c34">b3444354aacada3243df568e75d51846e04a8c34</a></p>



<a name="713068"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713068" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713068">(Mar 04 2019 at 22:33)</a>:</h4>
<p>Sorry, had someone in my office. Attempting upgrade now</p>



<a name="713076"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713076" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713076">(Mar 04 2019 at 22:39)</a>:</h4>
<p>hmm, new error.</p>
<div class="codehilite"><pre><span></span>2019-03-04 22:36:47,559 upgrade-zulip-stage-2: Building static assets...
Traceback (most recent call last):
  File &quot;./tools/update-prod-static&quot;, line 34, in &lt;module&gt;
    os.makedirs(&quot;var/log&quot;, exist_ok=True)
  File &quot;/usr/lib/python3.4/os.py&quot;, line 227, in makedirs
    makedirs(head, mode, exist_ok)
  File &quot;/usr/lib/python3.4/os.py&quot;, line 237, in makedirs
    mkdir(name, mode)
PermissionError: [Errno 13] Permission denied: &#39;var&#39;
</pre></div>


<p>Hmm</p>
<p>this is likely running into an issue because all the new deployments are still showing up as belonging to root</p>



<a name="713078"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713078" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713078">(Mar 04 2019 at 22:41)</a>:</h4>
<p>the zulip user can't create ./var/log</p>



<a name="713079"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713079" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713079">(Mar 04 2019 at 22:44)</a>:</h4>
<p>and it's failing at an earlier step because we're actually getting the zulip user now</p>



<a name="713081"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713081" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713081">(Mar 04 2019 at 22:48)</a>:</h4>
<p>upgrade-zulip-from-git is what creates that dir. I at least have been looking at this wrong</p>



<a name="713082"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713082" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713082">(Mar 04 2019 at 22:48)</a>:</h4>
<p><del>it's not something that broke since 2.0, the upgrade script deployed broken in 2.0</del></p>



<a name="713083"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713083" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713083">(Mar 04 2019 at 22:48)</a>:</h4>
<p><del>since we use the current/ script</del></p>



<a name="713087"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713087" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713087">(Mar 04 2019 at 22:51)</a>:</h4>
<p><del>in 1.9, (when it was in <code>lib/</code>) the git clone looked like <a href="https://github.com/zulip/zulip/blob/1.9.0/scripts/lib/upgrade-zulip-from-git" target="_blank" title="https://github.com/zulip/zulip/blob/1.9.0/scripts/lib/upgrade-zulip-from-git">this</a>:</del></p>
<div class="codehilite"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">deploy_path</span> <span class="o">=</span> <span class="n">make_deploy_path</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">LOCAL_GIT_CACHE_DIR</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cloning the repository&quot;</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;clone&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">remote_url</span><span class="p">,</span> <span class="s2">&quot;--mirror&quot;</span><span class="p">,</span> <span class="n">LOCAL_GIT_CACHE_DIR</span><span class="p">],</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;chown&quot;</span><span class="p">,</span> <span class="s2">&quot;-R&quot;</span><span class="p">,</span> <span class="s2">&quot;zulip:zulip&quot;</span><span class="p">,</span> <span class="n">LOCAL_GIT_CACHE_DIR</span><span class="p">])</span>
</pre></div>



<a name="713088"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713088" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713088">(Mar 04 2019 at 22:53)</a>:</h4>
<p><del>in 2.0, it now looks like:</del></p>
<div class="codehilite"><pre><span></span>    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;clone&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="n">refname</span><span class="p">,</span> <span class="n">LOCAL_GIT_CACHE_DIR</span><span class="p">,</span> <span class="n">deploy_path</span><span class="p">],</span>
                          <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span>
                          <span class="n">preexec_fn</span><span class="o">=</span><span class="n">su_to_zulip</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">deploy_path</span><span class="p">)</span>
</pre></div>



<a name="713089"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713089" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713089">(Mar 04 2019 at 22:54)</a>:</h4>
<p><del>and the su_to_zulip is broken in my 2.0 deployment :D (for me at least)</del></p>



<a name="713090"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713090" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713090">(Mar 04 2019 at 22:56)</a>:</h4>
<p><del>I'm going to manually modify my upgrade-zulip-from-git script to remove the preexec_fn and use the old subprocess check. That'll get me to the working su_to_zulip function, and future upgrades won't need the manually modified script</del></p>



<a name="713091"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713091" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713091">(Mar 04 2019 at 23:03)</a>:</h4>
<p>nevermind most of that. We still do the manual chown in 2.0, if the <code>LOCAL_GIT_CACHE_DIR</code> doesn't exist</p>



<a name="713092"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713092" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713092">(Mar 04 2019 at 23:03)</a>:</h4>
<p>mine exists though, so it skips that check, and uses the (for me, in 2.0) broken su_to_zulip</p>



<a name="713093"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713093" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713093">(Mar 04 2019 at 23:03)</a>:</h4>
<p><del>I should be able to fix this by deleting the LOCAL_GIT_CACHE_DIR</del> nope, that alone doesn't work because it's followed by a bunch of git commands which attempt the broken su_to_zulip.</p>



<a name="713096"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713096" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713096">(Mar 04 2019 at 23:14)</a>:</h4>
<p>I've manually edited zulip_tools.py to return my zulip user's PID of 1002 for su_to_zulip</p>



<a name="713097"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713097" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713097">(Mar 04 2019 at 23:15)</a>:</h4>
<p>that was enough to fix "next"'s ownership issues</p>



<a name="713104"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713104" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713104">(Mar 04 2019 at 23:33)</a>:</h4>
<p>new error somewhere in <code>generate_zulip_bots_static_files.py</code></p>



<a name="713106"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713106" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713106">(Mar 04 2019 at 23:34)</a>:</h4>
<p>but no real error message in the console or logs..</p>



<a name="713111"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713111" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713111">(Mar 04 2019 at 23:43)</a>:</h4>
<p>and of course, all generate_zulip_bots_static_files does is copy files.. and all the permissions on it's destination are correct.</p>



<a name="713115"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713115" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713115">(Mar 04 2019 at 23:45)</a>:</h4>
<p>looks like it failed because it detected the bots_dir static files existed in ~/prod-static and tried to rmtree it</p>



<a name="713116"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713116" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713116">(Mar 04 2019 at 23:48)</a>:</h4>
<p>which failed, because root owns it.. due to all the other problems</p>



<a name="713120"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713120" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713120">(Mar 04 2019 at 23:53)</a>:</h4>
<p>We're upgraded and pointed at master now <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span></p>



<a name="713121"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713121" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713121">(Mar 04 2019 at 23:54)</a>:</h4>
<p>1) I had to manually edit zulip_tools.py to include <span class="user-mention" data-user-id="7">@Tim Abbott</span> 's latest changes, because otherwise the broken su_to_zulip function was being called<br>
2) I had to clear out all the 'root' files that the previous upgrade attempts had created<br>
3) I had to learn to let go.</p>



<a name="713140"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713140" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713140">(Mar 05 2019 at 00:21)</a>:</h4>
<p>Great, thanks for all the debugging details!</p>



<a name="713151"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/user_uploads/near/713151" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Wallitsch <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/user_uploads.html#713151">(Mar 05 2019 at 00:35)</a>:</h4>
<p>haha sorry for all the debugging details</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>