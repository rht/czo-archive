<html>
<head><meta charset="utf-8"><title>OOM on a1.large · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html">OOM on a1.large</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1332654"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332654" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332654">(Feb 22 2022 at 18:20)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  hi reaching out about this <a href="https://github.com/zulip/zulip/issues/21195#issuecomment-1048071212">https://github.com/zulip/zulip/issues/21195#issuecomment-1048071212</a></p>



<a name="1332655"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332655" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332655">(Feb 22 2022 at 18:21)</a>:</h4>
<p><span class="user-mention" data-user-id="23254">@Stpn</span> hi!  Moved this to a more appropriate topic.</p>



<a name="1332656"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332656" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332656">(Feb 22 2022 at 18:22)</a>:</h4>
<p>(And then it looks like you moved this to an old one).</p>



<a name="1332661"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332661" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332661">(Feb 22 2022 at 18:22)</a>:</h4>
<p>Have you tried restarting <code>rabbitmq</code> itself?</p>



<a name="1332663"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332663" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332663">(Feb 22 2022 at 18:23)</a>:</h4>
<p>yes, but it did hang up in ~24 hours</p>



<a name="1332667"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332667" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332667">(Feb 22 2022 at 18:24)</a>:</h4>
<p>please feel free to move this to any other topic</p>



<a name="1332672"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332672" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332672">(Feb 22 2022 at 18:26)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  is there any test I could run? b/c the service status returns nothing suspicious (to me at least)</p>



<a name="1332674"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332674" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332674">(Feb 22 2022 at 18:26)</a>:</h4>
<p>When it's hung, can you show the output of:</p>
<div class="codehilite"><pre><span></span><code>service rabbitmq-server status
ss -ltpn | grep 5672
</code></pre></div>



<a name="1332676"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332676" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332676">(Feb 22 2022 at 18:26)</a>:</h4>
<p>when it's hung the server is unresponsive, can't even SSH into it, have to restart (or force-restart it even)</p>



<a name="1332678"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332678" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332678">(Feb 22 2022 at 18:27)</a>:</h4>
<p>OK.  I guess what makes you point the finger at rabbitmq, then?</p>



<a name="1332681"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332681" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332681">(Feb 22 2022 at 18:27)</a>:</h4>
<p>it's the only error in the error.log ?</p>



<a name="1332683"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332683" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332683">(Feb 22 2022 at 18:29)</a>:</h4>
<p>It could just be a symptom of whatever is causing the CPU to lock up.</p>
<p>What's the instance type of the EC2 host?</p>



<a name="1332686"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332686" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332686">(Feb 22 2022 at 18:30)</a>:</h4>
<p>a1.large</p>



<a name="1332692"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332692" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332692">(Feb 22 2022 at 18:33)</a>:</h4>
<p>any chance you could advise how to debug the CPU lock?</p>



<a name="1332694"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332694" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332694">(Feb 22 2022 at 18:33)</a>:</h4>
<p>OK; we don't have a lot of reports (positive or negative) about running on ARM64 hosts in production -- support was only recently added for them.  I might suggest trying an AMD64 instance type and seeing if that resolves it.</p>



<a name="1332699"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332699" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332699">(Feb 22 2022 at 18:34)</a>:</h4>
<p>I see</p>



<a name="1332701"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332701" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332701">(Feb 22 2022 at 18:34)</a>:</h4>
<p>any advice on how to migrate Zulip seamlessly to another instance? or it'd be a pure AWS problem</p>



<a name="1332702"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332702" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332702">(Feb 22 2022 at 18:34)</a>:</h4>
<p>We're very interested in debugging the failure if it <em>is</em> ARM64-based, but that's just my first guess at the issue, not a certain diagnosis.</p>



<a name="1332705"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332705" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332705">(Feb 22 2022 at 18:35)</a>:</h4>
<p>I am down to provide any logs, just idk which <br>
we had maybe 5 of these failures in the last 1 week</p>



<a name="1332708"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332708" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332708">(Feb 22 2022 at 18:35)</a>:</h4>
<p>You'll need to install Zulip from scratch on the new instance, but you can use our export and import tooling to make the data transfer pretty painless:<br>
<a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html">https://zulip.readthedocs.io/en/latest/production/export-and-import.html</a></p>



<a name="1332709"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332709" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332709">(Feb 22 2022 at 18:35)</a>:</h4>
<p>it was happening on 4.9 and on 5.0 too</p>



<a name="1332711"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332711" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332711">(Feb 22 2022 at 18:35)</a>:</h4>
<p>I'd check kernel logs to see what those have to say</p>



<a name="1332720"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332720" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332720">(Feb 22 2022 at 18:37)</a>:</h4>
<div class="codehilite"><pre><span></span><code> oom_reaper: reaped process 2781 (python3), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB
</code></pre></div>
<p>I guess that answers it? ugh</p>



<a name="1332724"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332724" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332724">(Feb 22 2022 at 18:38)</a>:</h4>
<p>4G should be enough for a Zulip instance.</p>
<p>It's also surprising to me that an OOM makes the whole host unreachable.</p>



<a name="1332727"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332727" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332727">(Feb 22 2022 at 18:39)</a>:</h4>
<p>So likely the rabbitmq failures are because rabbitmq got taken down by the oom-killer, not any thing actually wrong with rabbitmq</p>



<a name="1332728"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332728" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332728">(Feb 22 2022 at 18:40)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Feb 22 05:46:43 ip-172-31-11-73 kernel: [144000.577084] oom-kill:constraint=CONSTRAINT_NONE,nodemask=(null),cpuset=/,mems_allowed=0,global_oom,task_memcg=/system.slice/supervisor.service,task=python3,pid=2781,uid=1001
Feb 22 05:46:43 ip-172-31-11-73 kernel: [144000.577109] Out of memory: Killed process 2781 (python3) total-vm:248340kB, anon-rss:153864kB, file-rss:1244kB, shmem-rss:0kB, UID:1001 pgtables:456kB oom_score_adj:0
Feb 22 05:46:43 ip-172-31-11-73 kernel: [144000.599199] oom_reaper: reaped process 2781 (python3), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB
</code></pre></div>
<p>this is full 3 lines before the hang-up</p>



<a name="1332732"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332732" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332732">(Feb 22 2022 at 18:41)</a>:</h4>
<p>The total-vm on that is only 1/4 of a GB.</p>



<a name="1332733"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332733" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332733">(Feb 22 2022 at 18:42)</a>:</h4>
<p>You can try switching ton a1.xlarge, on the hopes that that will give you enough memory overhead that when the memory bloats you can go looking around for the cause, rather than having an unresponsive host.</p>



<a name="1332737"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332737" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332737">(Feb 22 2022 at 18:43)</a>:</h4>
<p>Renamed the topic now that we have a better sense of the causes.</p>



<a name="1332741"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332741" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332741">(Feb 22 2022 at 18:45)</a>:</h4>
<p>Upgrading from a1.large to a1.xlarge should be a straightforward change, since it's the same arch -- see <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-resize.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-resize.html</a></p>



<a name="1332747"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332747" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332747">(Feb 22 2022 at 18:50)</a>:</h4>
<p>ok migrated<br>
let's see I guess :)</p>



<a name="1332749"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332749" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332749">(Feb 22 2022 at 18:52)</a>:</h4>
<p>Sounds good.  If you do see, via memory-size monitoring of the processes, a large step function increase in zulip's memory footprint, or a slow leak, we'd like to help diagnose that.</p>



<a name="1332754"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332754" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332754">(Feb 22 2022 at 18:56)</a>:</h4>
<p>thank you, will let you know</p>



<a name="1332756"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332756" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stpn <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332756">(Feb 22 2022 at 18:56)</a>:</h4>
<p>if you want I can log the memory footprint over the next few days, but I'd ask for a command to do that then</p>



<a name="1332782"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OOM%20on%20a1.large/near/1332782" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OOM.20on.20a1.2Elarge.html#1332782">(Feb 22 2022 at 19:13)</a>:</h4>
<p>You can use something like:</p>
<div class="codehilite"><pre><span></span><code>top -cbd 60 -o +%MEM | grep &quot;[l]oad average&quot; -A 16 &gt; memory-usage.log
</code></pre></div>
<p>...which will log the top-10 memory processes every 60s.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>