<html>
<head><meta charset="utf-8"><title>internal server error on single subdomain realm · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html">internal server error on single subdomain realm</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1403308"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1403308" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UNT Collaboration HUB <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1403308">(Jul 12 2022 at 16:40)</a>:</h4>
<p>Hello,</p>
<p>Can anyone help with this issue with a subdomain realm that's not working. We have several other subdomain realms that work fine. We are wondering if there's a database corruption error that needs to be repaired. We are receiving the following error when attempting to login to one of our subdomain installations:</p>
<p>Logger django.request, from module django.utils.log line 230:<br>
Error generated by Collaboration HUB Admin &lt;<a href="mailto:user10@untcemi.collaborationhub.chat">user10@untcemi.collaborationhub.chat</a>&gt; (Organization owner) on <a href="http://untcemi.collaborationhub.chat">untcemi.collaborationhub.chat</a> deployment</p>
<p>Traceback (most recent call last):<br>
 File "/srv/zulip-venv-cache/cf3d745490514640ac79ed6b24b6a4f3814fa701/zulip-py3-venv/lib/python3.7/site-packages/django/core/handlers/exception.py", line 47, in inner<br>
   response = get_response(request)<br>
 File "/srv/zulip-venv-cache/cf3d745490514640ac79ed6b24b6a4f3814fa701/zulip-py3-venv/lib/python3.7/site-packages/django/core/handlers/base.py", line 181, in _get_response<br>
   response = wrapped_callback(request, *callback_args, **callback_kwargs)<br>
 File "./zerver/views/home.py", line 129, in home<br>
   return zulip_login_required(home_real)(request)<br>
 File "./zerver/decorator.py", line 432, in _wrapped_view<br>
   return view_func(request, *args, **kwargs)<br>
 File "/srv/zulip-venv-cache/cf3d745490514640ac79ed6b24b6a4f3814fa701/zulip-py3-venv/lib/python3.7/site-packages/django/contrib/auth/decorators.py", line 21, in _wrapped_view<br>
   return view_func(request, *args, **kwargs)<br>
 File "./zerver/decorator.py", line 481, in _wrapped_view_func<br>
   return rate_limit()(view_func)(request, *args, **kwargs)<br>
 File "./zerver/decorator.py", line 984, in wrapped_func<br>
   return func(request, *args, **kwargs)<br>
 File "./zerver/views/home.py", line 230, in home_real<br>
   needs_tutorial=needs_tutorial,<br>
 File "./zerver/lib/home.py", line 153, in build_page_params_for_home_page_load<br>
   include_streams=False,<br>
 File "./zerver/lib/events.py", line 1347, in do_events_register<br>
   reactivate_user_if_soft_deactivated(user_profile)<br>
 File "./zerver/lib/soft_deactivation.py", line 307, in reactivate_user_if_soft_deactivated<br>
   add_missing_messages(user_profile)<br>
 File "./zerver/lib/soft_deactivation.py", line 186, in add_missing_messages<br>
   if stream_subscription_logs[-1].event_type == RealmAuditLog.SUBSCRIPTION_DEACTIVATED:<br>
IndexError: list index out of range</p>
<p>Deployed code:</p>
<ul>
<li>git: None</li>
<li>ZULIP_VERSION: 5.4</li>
</ul>
<p>Request info:</p>
<ul>
<li>path: /</li>
<li>GET: {}</li>
<li>REMOTE_ADDR: "129.120.67.52"</li>
<li>QUERY_STRING: ""</li>
<li>SERVER_NAME: ""</li>
</ul>
<p>Thank you in advance for your help,<br>
Agustin.</p>



<a name="1403342"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1403342" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1403342">(Jul 12 2022 at 17:22)</a>:</h4>
<p>Hi! Is the busted realm a new one, or one that worked previously?</p>



<a name="1403577"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1403577" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1403577">(Jul 12 2022 at 19:29)</a>:</h4>
<p>Also <span class="user-mention" data-user-id="24421">@UNT Collaboration HUB</span> can you explain the process through which this organization was created?</p>



<a name="1403895"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1403895" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UNT Collaboration HUB <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1403895">(Jul 13 2022 at 16:48)</a>:</h4>
<p>Hello <span class="user-mention" data-user-id="24078">@Matt Keller</span> !<br>
This realm worked previously.</p>



<a name="1403915"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1403915" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UNT Collaboration HUB <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1403915">(Jul 13 2022 at 17:56)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span>  We did a primary installation on an AWS Debian 10 server and set up subsequent sub-domain realms off that primary installation. The realm that is broken is one of the sub-domain realms. There are five others that are working fine.</p>



<a name="1404037"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1404037" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1404037">(Jul 13 2022 at 20:35)</a>:</h4>
<p><span class="user-mention" data-user-id="24421">@UNT Collaboration HUB</span> ok. Well, that exception suggests you have a user who is <code>long_term_idle</code> and is subscribed to a stream but doesn't have any <code>RealmAuditLog</code> entries (which are creating when subscribing to a stream).</p>



<a name="1404038"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1404038" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1404038">(Jul 13 2022 at 20:35)</a>:</h4>
<p>Is it possible that your team has done manual adjustments to the database via SQL? That could potentially explain this anomaly.</p>



<a name="1404039"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1404039" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1404039">(Jul 13 2022 at 20:36)</a>:</h4>
<p>Another possibility is that you upgraded the OS for the Postgres host system without using the right process, and have corrupted database indexes as a result. If that's the case, we can provide a link for how to fix it.</p>



<a name="1404343"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1404343" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UNT Collaboration HUB <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1404343">(Jul 13 2022 at 23:34)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> We were doing some testing for this realm with mail forwarding options and other interactions with streams via email, but I believe this only involved adjustments to the PHP config file. I’m not certain, but I believe this process included adding users on a testing basis that may not have interacted with any steams on a subscription basis. If we have a RealmAuditLog issue due to a long_term_idle, how would we verify and repair?</p>



<a name="1404454"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1404454" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1404454">(Jul 14 2022 at 00:33)</a>:</h4>
<p><span class="user-mention" data-user-id="24421">@UNT Collaboration HUB</span> well, the code that is failing is expects that a user who is subscribed to a stream has an audit log entry for having been subscribed, which is an invariant that should always be true if the Zulip database has not been tampered with.</p>



<a name="1404455"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1404455" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1404455">(Jul 14 2022 at 00:34)</a>:</h4>
<p>(The <code>long_term_idle</code> code path assumes this invariant has not been violated)</p>



<a name="1404490"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1404490" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UNT Collaboration HUB <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1404490">(Jul 14 2022 at 00:48)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> Thanks for this information. This is a beta version release for us and so we do not have a large database of information we are looking to preserve. With this in mind, should we try resetting the database or reinstalling the sub-domain realm altogether? If so, would we do this by simply following the subdomain realm installation procedure again?</p>



<a name="1404494"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1404494" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UNT Collaboration HUB <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1404494">(Jul 14 2022 at 00:50)</a>:</h4>
<p>Would that procedure be sufficient or do we need to somehow wipe the sub realm installation first?</p>



<a name="1405003"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1405003" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1405003">(Jul 14 2022 at 22:25)</a>:</h4>
<p><span class="user-mention" data-user-id="24421">@UNT Collaboration HUB</span> it's definitely possible to fix the database, but you'll need to get a support contract -- it'll require somewhat involved debugging by a Zulip developer to figure out the right way to correct this situation.</p>



<a name="1407041"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/internal%20server%20error%20on%20single%20subdomain%20realm/near/1407041" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UNT Collaboration HUB <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/internal.20server.20error.20on.20single.20subdomain.20realm.html#1407041">(Jul 19 2022 at 20:08)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> We are starting with a fresh install on a new server. Thank you very much for your help!</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>