<html>
<head><meta charset="utf-8"><title>error deactivating users via web/app · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/error.20deactivating.20users.20via.20web.2Fapp.html">error deactivating users via web/app</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1457021"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/error%20deactivating%20users%20via%20web/app/near/1457021" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/error.20deactivating.20users.20via.20web.2Fapp.html#1457021">(Oct 30 2022 at 13:24)</a>:</h4>
<p>Hi!<br>
Got this error when I tried to deactivate a user</p>
<div class="codehilite"><pre><span></span><code>Logger zerver.middleware.json_error_handler, from module zerver.middleware line 488:
Error generated by Fabian Tribrunner &lt;tribrunner@regiowert.at&gt; (Organization owner) on chat.regiowert.at deployment

Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/ae602e62cacf375c8e9c95291fbb2cfd2b63bed3/zulip-py3-venv/lib/python3.9/site-packages/django/core/handlers/base.py&quot;, line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;./zerver/lib/rest.py&quot;, line 39, in _wrapped_view_func
    response = view_func(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/ae602e62cacf375c8e9c95291fbb2cfd2b63bed3/zulip-py3-venv/lib/python3.9/site-packages/django/views/decorators/csrf.py&quot;, line 54, in wrapped_view
    return view_func(*args, **kwargs)
  File &quot;./zerver/lib/rest.py&quot;, line 203, in rest_dispatch
    return target_function(request, **kwargs)
  File &quot;/srv/zulip-venv-cache/ae602e62cacf375c8e9c95291fbb2cfd2b63bed3/zulip-py3-venv/lib/python3.9/site-packages/django/utils/decorators.py&quot;, line 133, in _wrapped_view
    response = view_func(request, *args, **kwargs)
  File &quot;./zerver/decorator.py&quot;, line 881, in _wrapped_view_func
    return view_func(request, user_profile, *args, **kwargs)
  File &quot;./zerver/decorator.py&quot;, line 641, in _wrapped_view_func
    return view_func(request, user_profile, *args, **kwargs)
  File &quot;./zerver/views/invite.py&quot;, line 108, in get_user_invites
    all_users = do_get_invites_controlled_by_user(user_profile)
  File &quot;./zerver/actions/invites.py&quot;, line 282, in do_get_invites_controlled_by_user
    expiry_date=get_invitation_expiry_date(invitee.confirmation.get()),
  File &quot;/srv/zulip-venv-cache/ae602e62cacf375c8e9c95291fbb2cfd2b63bed3/zulip-py3-venv/lib/python3.9/site-packages/django/db/models/manager.py&quot;, line 85, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/ae602e62cacf375c8e9c95291fbb2cfd2b63bed3/zulip-py3-venv/lib/python3.9/site-packages/django/db/models/query.py&quot;, line 650, in get
    raise self.model.DoesNotExist(
confirmation.models.Confirmation.DoesNotExist: Confirmation matching query does not exist.


Deployed code:
- git: 6.0-dev-2165-g925fa4ca50
- ZULIP_VERSION: 6.0-dev-2165-g925fa4ca50


Request info:
- path: /json/invites
- GET: {}
- REMOTE_ADDR: &quot;94.16.41.105&quot;
- QUERY_STRING: &quot;&quot;
- SERVER_NAME: &quot;&quot;
</code></pre></div>
<p>any ideas?</p>



<a name="1457022"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/error%20deactivating%20users%20via%20web/app/near/1457022" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Tribrunner <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/error.20deactivating.20users.20via.20web.2Fapp.html#1457022">(Oct 30 2022 at 13:29)</a>:</h4>
<div class="codehilite"><pre><span></span><code>su zulip -c &#39;/home/zulip/deployments/current/manage.py deactivate_user #USER@regiowert.at -f&#39;
</code></pre></div>
<p>works fine</p>



<a name="1457378"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/error%20deactivating%20users%20via%20web/app/near/1457378" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/error.20deactivating.20users.20via.20web.2Fapp.html#1457378">(Oct 31 2022 at 21:01)</a>:</h4>
<p><span class="user-mention" data-user-id="8768">@Fabian Tribrunner</span> It seems you have some invitations in the database with a bugged state - I'm not sure about the most likely cause of that, perhaps due to some old bugs that may have caused this <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I also opened <a href="https://github.com/zulip/zulip/pull/23394">#23394</a> with a quick fix for a possible, though unlikely, source of such a situation.</p>
<p>The best thing to do is probably to just delete these malformed objects. Can you run this in <code>manage.py shell</code> first so that we can have an idea how many such objects we're dealing with and to confirm it looks reasonable to delete them?</p>
<div class="codehilite"><pre><span></span><code>for prereg_user in PreregistrationUser.objects.filter(referred_by__isnull=False):
    try:
        prereg_user.confirmation.get()
    except Confirmation.DoesNotExist:
        print(f&quot;PreregistrationUser {prereg_user} missing the confirmation object&quot;)
</code></pre></div>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>