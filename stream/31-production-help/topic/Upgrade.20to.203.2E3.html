<html>
<head><meta charset="utf-8"><title>Upgrade to 3.3 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html">Upgrade to 3.3</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1149426"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1149426" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plankter <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1149426">(Apr 01 2021 at 07:42)</a>:</h4>
<p>We'd like to upgrade from Zulip 3.1 to 3.2 and then 3.3. Is it safe to do so?</p>
<p>We normally replicate the old setup and test it before doing the live upgrade. This time, we are unable to do so, because of the dependency of v. 3.1 on django-cookies-samesite. The 0.6.6 version is still missing.</p>



<a name="1149652"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1149652" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Birds <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1149652">(Apr 01 2021 at 15:32)</a>:</h4>
<p>This sounds like it belongs in <a class="stream" data-stream-id="31" href="/#narrow/stream/31-production-help">#production help</a> as its for help about upgrading production. <a class="stream" data-stream-id="21" href="/#narrow/stream/21-provision-help">#provision help</a> is for help about the zulip dev environment.</p>



<a name="1149659"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1149659" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plankter <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1149659">(Apr 01 2021 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="3715">Adam Birds</span>  I don't think I can move my message, though. Should I create a new one in <a class="stream" data-stream-id="31" href="/#narrow/stream/31-production-help">#production help</a> ?</p>



<a name="1149666"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1149666" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1149666">(Apr 01 2021 at 15:53)</a>:</h4>
<p>Yeah, currently only administrators can move messages between streams.</p>
<p>(<span class="user-mention" data-user-id="10242">@Sahil Batra</span> as a sidenote, we should make sure that the new Moderator role has this permission, since it's very useful)</p>



<a name="1149668"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1149668" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1149668">(Apr 01 2021 at 15:54)</a>:</h4>
<p>I'm not going to bother with this one since it is relevant to the above; our advice <span class="user-mention" data-user-id="15931">@Plankter</span> is always to upgrade to the latest within a stable release series (E.g. directly to <code>3.3</code>).</p>



<a name="1149669"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1149669" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1149669">(Apr 01 2021 at 15:54)</a>:</h4>
<p>(The changes in 3.x minor releases are tiny -- mostly backported import bug fixes and documentation)</p>



<a name="1149700"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1149700" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sahil Batra <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1149700">(Apr 01 2021 at 16:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/21-provision-help/topic/django-cookies-samesite/near/1149666">said</a>:</p>
<blockquote>
<p>Yeah, currently only administrators can move messages between streams.</p>
<p>(<span class="user-mention silent" data-user-id="10242">Sahil Batra</span> as a sidenote, we should make sure that the new Moderator role has this permission, since it's very useful)</p>
</blockquote>
<p>Yes I already have noted this, since this has been requested by many people.</p>



<a name="1149880"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1149880" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1149880">(Apr 01 2021 at 18:49)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="21" href="/#narrow/stream/21-provision-help/topic/Upgrade.20to.203.2E3">#provision help &gt; Upgrade to 3.3</a> by <span class="user-mention silent" data-user-id="699">Anders Kaseorg</span></p>



<a name="1154539"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1154539" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plankter <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1154539">(Apr 06 2021 at 10:54)</a>:</h4>
<p>We were able to upgrade from 3.1 to 3.3 on Debian, without a glitch. Prior to doing so, we practiced importing the 3.1. backup into a 3.2. installation. This worked too.</p>



<a name="1164393"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164393" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ankit Tharwani <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164393">(Apr 16 2021 at 09:50)</a>:</h4>
<p>Hi channel - while doing an upgrade to v3.3 in production, I ended up in this error on migration <code>zerver.0237_rename_zulip_realm_to_zulipinternal</code></p>
<div class="codehilite"><pre><span></span><code>  File &quot;/home/zulip/deployments/2021-04-16-01-07-16/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py&quot;, line 412, in get
    (self.model._meta.object_name, num)
__fake__.MultipleObjectsReturned: get() returned more than one UserProfile -- it returned 2!
</code></pre></div>
<p>i think i know what could be happening - there may be some dirty data issue with the user <code>welcome-bot@zulip.com</code> and line <a href="https://github.com/zulip/zulip/pull/28">#28</a> fails.</p>
<p>1) Is there a way to fix this?<br>
2) I am running a local PG instance - unsure how zulip authenticates to it to go in and debug the data - any advice?</p>
<p>Thanks for your help...</p>



<a name="1164412"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164412" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Birds <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164412">(Apr 16 2021 at 10:51)</a>:</h4>
<p><span class="user-mention" data-user-id="19657">@Ankit Tharwani</span> you should upgrade straight to 3.4 instead.</p>



<a name="1164696"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164696" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164696">(Apr 16 2021 at 16:01)</a>:</h4>
<p><span class="user-mention" data-user-id="19657">@Ankit Tharwani</span> you can probably change this line to <br>
<code>welcome_bot = UserProfile.objects.get(email="welcome-bot@zulip.com", realm=internal_realm)</code><br>
in order to get this to pass.  But you're probably also going to want to try to figure out how to remove the other <code>welcome-bot</code>.</p>



<a name="1164697"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164697" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164697">(Apr 16 2021 at 16:02)</a>:</h4>
<p><code>manage.py dbshell</code> and <code>manage.py shell</code> are the main ways to debug.  See <a href="https://zulip.readthedocs.io/en/latest/production/management-commands.html">https://zulip.readthedocs.io/en/latest/production/management-commands.html</a> for documentation on using those.</p>



<a name="1164700"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164700" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ankit Tharwani <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164700">(Apr 16 2021 at 16:02)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> thanks for your help... yes I figured there was a duplicate user for some reason and I went to postgres and changed the email for the duplicate for the time being...</p>
<p>is there a safe way to remove a redundant user?</p>



<a name="1164701"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164701" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ankit Tharwani <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164701">(Apr 16 2021 at 16:03)</a>:</h4>
<p>FYI - the migrations applied and the upgrade went successful :)</p>



<a name="1164820"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164820" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164820">(Apr 16 2021 at 17:53)</a>:</h4>
<p><span class="user-mention" data-user-id="19657">@Ankit Tharwani</span> you probably want just deactivate it using <code>do_deactivate_user</code> on a management shell.</p>



<a name="1164893"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164893" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ankit Tharwani <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164893">(Apr 16 2021 at 18:42)</a>:</h4>
<p>but <span class="user-mention" data-user-id="7">@Tim Abbott</span> wouldn't that still fetch it under <code>UserProfile.objects.get(email="welcome-bot@zulip.com", realm=internal_realm)</code> ? so deactivation alone might not do the job right?</p>



<a name="1164968"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164968" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164968">(Apr 16 2021 at 19:34)</a>:</h4>
<p><span class="user-mention" data-user-id="19657">@Ankit Tharwani</span> my guess is your duplicate is in another realm.</p>



<a name="1164971"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1164971" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1164971">(Apr 16 2021 at 19:34)</a>:</h4>
<p>I don't have time to help investigate more but you if you can find the second object in a management shell and print it, that'd make clear what needs to happen to clean it up properly.</p>



<a name="1165534"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%203.3/near/1165534" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.203.2E3.html#1165534">(Apr 17 2021 at 18:57)</a>:</h4>
<p>Deactivating will still mean things will break in the future when we finish and merge the migration creating system bots in every realm, by having this pre-existing duplicate UserProfile for the welcome bot in the realm - so we should probably figure out how to delete it here.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>