<html>
<head><meta charset="utf-8"><title>restore zulip · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html">restore zulip</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1102380"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102380" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jenish <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102380">(Jan 20 2021 at 04:51)</a>:</h4>
<p>how to restore my current zulip ???</p>



<a name="1102381"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102381" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jenish <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102381">(Jan 20 2021 at 04:51)</a>:</h4>
<p><a href="/user_uploads/2/2f/9z2P_1mRcrN5cpDgsLAHYIhP/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/2f/9z2P_1mRcrN5cpDgsLAHYIhP/image.png" title="image.png"><img src="/user_uploads/2/2f/9z2P_1mRcrN5cpDgsLAHYIhP/image.png"></a></div>



<a name="1102382"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102382" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jenish <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102382">(Jan 20 2021 at 04:53)</a>:</h4>
<p>I upgrade my ubuntu 18.04  into 20.04 then it give me this error so how I can restore my zulip server ???</p>



<a name="1102542"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102542" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gaurav Pandey (ligmitz) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102542">(Jan 20 2021 at 08:17)</a>:</h4>
<p>The error shows that the virtual environment is not setup for the current python version</p>



<a name="1102549"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102549" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102549">(Jan 20 2021 at 08:19)</a>:</h4>
<p><span class="user-mention" data-user-id="17897">@Jenish</span> did you follow this guide? <a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal</a></p>



<a name="1102550"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102550" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102550">(Jan 20 2021 at 08:20)</a>:</h4>
<p>If you want to play it safe, you can restore your system (if you made a snapshot backup) to the previous state before the upgrade, and then just follow <a href="https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal</a>.</p>



<a name="1102617"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102617" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jenish <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102617">(Jan 20 2021 at 08:58)</a>:</h4>
<p>but i forgot to take backup.</p>



<a name="1102619"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102619" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jenish <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102619">(Jan 20 2021 at 08:58)</a>:</h4>
<p>so now it possible to restore zulip</p>



<a name="1102626"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102626" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102626">(Jan 20 2021 at 09:59)</a>:</h4>
<p><span class="user-mention" data-user-id="17897">@Jenish</span> you should have taken backup. I suppose this is an expensive lesson for you. Since there is no way to turn back, you can just continue with step 4 and 5 in the guide I linked.</p>



<a name="1102637"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102637" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jenish <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102637">(Jan 20 2021 at 10:30)</a>:</h4>
<p>Okay</p>



<a name="1102685"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102685" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jenish <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102685">(Jan 20 2021 at 12:26)</a>:</h4>
<p><span class="user-mention" data-user-id="2328">@Rein Zustand</span> Thanks this was helpfully for me but I solved that issue</p>



<a name="1102686"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102686" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102686">(Jan 20 2021 at 12:27)</a>:</h4>
<p><span class="user-mention" data-user-id="17897">@Jenish</span>  what issue did you solve?</p>



<a name="1102687"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102687" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jenish <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102687">(Jan 20 2021 at 12:28)</a>:</h4>
<p>I reset my virtual environment</p>



<a name="1102693"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1102693" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1102693">(Jan 20 2021 at 13:00)</a>:</h4>
<p><span class="user-mention" data-user-id="17897">@Jenish</span> step 5 in the guide I linked already automatically does a virtualenv refresh.</p>



<a name="1103506"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1103506" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jenish <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1103506">(Jan 21 2021 at 04:44)</a>:</h4>
<p>Yes</p>



<a name="1122585"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122585" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tej Gill <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122585">(Feb 23 2021 at 02:58)</a>:</h4>
<p>Hello, this is sort of urgent if someone out there can provide some assistance. On our production server all of a sudden our users started to get an error message when they try to upload an attachment <code>An Unexpected error has occurred</code>. I couldn't find any answers on the forum as to what may have caused this error message. I decided to restore my server to previous backup, but unfortunately my restore process wouldn't get past the error below:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>+ dropdb --if-exists -- zulip
+ createdb -O zulip -T template0 -- zulip
generate_secrets: No new secrets to generate.
+ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq
+ <span class="nv">RABBITMQ_FLAGS</span><span class="o">=()</span>
+ <span class="s1">'['</span> -n <span class="s1">''</span> <span class="s1">']'</span>
+++ dirname /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq
++ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/../get-django-setting RABBITMQ_USERNAME
+ <span class="nv">RABBITMQ_USERNAME</span><span class="o">=</span>zulip
+++ dirname /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq
++ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/../get-django-setting RABBITMQ_PASSWORD
+ <span class="nv">RABBITMQ_PASSWORD</span><span class="o">=</span>f1c9276738089a62af4326bed103969636c5d92dbd6d18c3bd052307a9c2bab0
+ <span class="s1">'['</span> <span class="m">0</span> -eq <span class="m">0</span> <span class="s1">']'</span>
+ <span class="nv">RABBITMQCTL_COMMAND</span><span class="o">=</span>rabbitmqctl
+ rabbitmqctl delete_user zulip
Deleting user <span class="s2">"zulip"</span>
+ rabbitmqctl delete_user zulip
Deleting user <span class="s2">"zulip"</span>
Error: no_such_user: zulip
+ <span class="nb">true</span>
+ rabbitmqctl delete_user guest
Deleting user <span class="s2">"guest"</span>
Error: no_such_user: guest
+ <span class="nb">true</span>
+ rabbitmqctl add_user zulip f1c9276738089a62af4326bed103969636c5d92dbd6d18c3bd052307a9c2bab0
Creating user <span class="s2">"zulip"</span>
+ rabbitmqctl set_user_tags zulip administrator
Setting tags <span class="k">for</span> user <span class="s2">"zulip"</span> to <span class="o">[</span>administrator<span class="o">]</span>
+ rabbitmqctl set_permissions -p / zulip <span class="s1">'.*'</span> <span class="s1">'.*'</span> <span class="s1">'.*'</span>
Setting permissions <span class="k">for</span> user <span class="s2">"zulip"</span> <span class="k">in</span> vhost <span class="s2">"/"</span>
+ /home/zulip/deployments/2020-08-07-22-43-47/scripts/zulip-puppet-apply -f
Notice: Compiled catalog <span class="k">for</span> zulip-prod <span class="k">in</span> environment production <span class="k">in</span> <span class="m">1</span>.40 seconds
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Apt_repository/Exec<span class="o">[</span>setup_apt_repo<span class="o">]</span>/returns: executed successfully
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Tornado_sharding/File<span class="o">[</span>/etc/zulip/nginx_sharding.conf<span class="o">]</span>/owner: owner changed <span class="s1">'zulip'</span> to <span class="s1">'root'</span>
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Tornado_sharding/File<span class="o">[</span>/etc/zulip/nginx_sharding.conf<span class="o">]</span>/group: group changed <span class="s1">'zulip'</span> to <span class="s1">'root'</span>
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::App_frontend_base/File<span class="o">[</span>/etc/zulip/uwsgi.ini<span class="o">]</span>/owner: owner changed <span class="s1">'zulip'</span> to <span class="s1">'root'</span>
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::App_frontend_base/File<span class="o">[</span>/etc/zulip/uwsgi.ini<span class="o">]</span>/group: group changed <span class="s1">'zulip'</span> to <span class="s1">'root'</span>
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Supervisor/Service<span class="o">[</span>supervisor<span class="o">]</span>: Triggered <span class="s1">'refresh'</span> from <span class="m">2</span> events
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Nginx/Service<span class="o">[</span>nginx<span class="o">]</span>: Triggered <span class="s1">'refresh'</span> from <span class="m">2</span> events
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::App_frontend_base/Zulip::Safepackage<span class="o">[</span>postgresql-client<span class="o">]</span>/Package<span class="o">[</span>postgresql-client<span class="o">]</span>/ensure: created
Notice: Applied catalog <span class="k">in</span> <span class="m">17</span>.04 seconds
+ pg_restore -d zulip -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database
pg_restore: <span class="o">[</span>archiver<span class="o">]</span> unsupported version <span class="o">(</span><span class="m">1</span>.14<span class="o">)</span> <span class="k">in</span> file header

Error running a subcommand of /home/zulip/deployments/current/scripts/setup/restore-backup: pg_restore -d zulip -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database
Actual error output <span class="k">for</span> the subcommand is just above this.

Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"/home/zulip/deployments/current/scripts/setup/restore-backup"</span>, line <span class="m">163</span>, <span class="k">in</span> &lt;module&gt;
    restore_backup<span class="o">(</span>tarball_file<span class="o">)</span>
  File <span class="s2">"/home/zulip/deployments/current/scripts/setup/restore-backup"</span>, line <span class="m">148</span>, <span class="k">in</span> restore_backup
    run<span class="o">([</span><span class="s2">"pg_restore"</span>, <span class="s2">"-d"</span>, db<span class="o">[</span><span class="s2">"NAME"</span><span class="o">]</span>, <span class="s2">"--"</span>, db_dir<span class="o">]</span>, <span class="nv">cwd</span><span class="o">=</span><span class="s2">"/"</span>, <span class="nv">env</span><span class="o">=</span>postgres_env<span class="o">)</span>
  File <span class="s2">"/home/zulip/deployments/current/scripts/lib/zulip_tools.py"</span>, line <span class="m">198</span>, <span class="k">in</span> run
    subprocess.check_call<span class="o">(</span>args, **kwargs<span class="o">)</span>
  File <span class="s2">"/usr/lib/python3.6/subprocess.py"</span>, line <span class="m">311</span>, <span class="k">in</span> check_call
    raise CalledProcessError<span class="o">(</span>retcode, cmd<span class="o">)</span>
subprocess.CalledProcessError: Command <span class="s1">'['</span>pg_restore<span class="s1">', '</span>-d<span class="s1">', '</span>zulip<span class="s1">', '</span>--<span class="s1">', '</span>/tmp/zulip-restore-backup-_ouu520s/zulip-backup/database<span class="s1">']'</span> returned non-zero <span class="nb">exit</span> status <span class="m">1</span>.
</code></pre></div>
<p>Any help would be greatly appreciated.</p>



<a name="1122588"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122588" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tej Gill <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122588">(Feb 23 2021 at 03:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="13286">Tej Gill</span> <a href="#narrow/stream/31-production-help/topic/restore.20zulip/near/1122585">said</a>:</p>
<blockquote>
<p>Hello, this is sort of urgent if someone out there can provide some assistance. On our production server all of a sudden our users started to get an error message when they try to upload an attachment <code>An Unexpected error has occurred</code>. I couldn't find any answers on the forum as to what may have caused this error message. I decided to restore my server to previous backup, but unfortunately my restore process wouldn't get past the error below:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>+ dropdb --if-exists -- zulip
+ createdb -O zulip -T template0 -- zulip
generate_secrets: No new secrets to generate.
+ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq
+ <span class="nv">RABBITMQ_FLAGS</span><span class="o">=()</span>
+ <span class="s1">'['</span> -n <span class="s1">''</span> <span class="s1">']'</span>
+++ dirname /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq
++ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/../get-django-setting RABBITMQ_USERNAME
+ <span class="nv">RABBITMQ_USERNAME</span><span class="o">=</span>zulip
+++ dirname /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq
++ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/../get-django-setting RABBITMQ_PASSWORD
+ <span class="nv">RABBITMQ_PASSWORD</span><span class="o">=</span>f1c9276738089a62af4326bed103969636c5d92dbd6d18c3bd052307a9c2bab0
+ <span class="s1">'['</span> <span class="m">0</span> -eq <span class="m">0</span> <span class="s1">']'</span>
+ <span class="nv">RABBITMQCTL_COMMAND</span><span class="o">=</span>rabbitmqctl
+ rabbitmqctl delete_user zulip
Deleting user <span class="s2">"zulip"</span>
+ rabbitmqctl delete_user zulip
Deleting user <span class="s2">"zulip"</span>
Error: no_such_user: zulip
+ <span class="nb">true</span>
+ rabbitmqctl delete_user guest
Deleting user <span class="s2">"guest"</span>
Error: no_such_user: guest
+ <span class="nb">true</span>
+ rabbitmqctl add_user zulip f1c9276738089a62af4326bed103969636c5d92dbd6d18c3bd052307a9c2bab0
Creating user <span class="s2">"zulip"</span>
+ rabbitmqctl set_user_tags zulip administrator
Setting tags <span class="k">for</span> user <span class="s2">"zulip"</span> to <span class="o">[</span>administrator<span class="o">]</span>
+ rabbitmqctl set_permissions -p / zulip <span class="s1">'.*'</span> <span class="s1">'.*'</span> <span class="s1">'.*'</span>
Setting permissions <span class="k">for</span> user <span class="s2">"zulip"</span> <span class="k">in</span> vhost <span class="s2">"/"</span>
+ /home/zulip/deployments/2020-08-07-22-43-47/scripts/zulip-puppet-apply -f
Notice: Compiled catalog <span class="k">for</span> zulip-prod <span class="k">in</span> environment production <span class="k">in</span> <span class="m">1</span>.40 seconds
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Apt_repository/Exec<span class="o">[</span>setup_apt_repo<span class="o">]</span>/returns: executed successfully
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Tornado_sharding/File<span class="o">[</span>/etc/zulip/nginx_sharding.conf<span class="o">]</span>/owner: owner changed <span class="s1">'zulip'</span> to <span class="s1">'root'</span>
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Tornado_sharding/File<span class="o">[</span>/etc/zulip/nginx_sharding.conf<span class="o">]</span>/group: group changed <span class="s1">'zulip'</span> to <span class="s1">'root'</span>
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::App_frontend_base/File<span class="o">[</span>/etc/zulip/uwsgi.ini<span class="o">]</span>/owner: owner changed <span class="s1">'zulip'</span> to <span class="s1">'root'</span>
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::App_frontend_base/File<span class="o">[</span>/etc/zulip/uwsgi.ini<span class="o">]</span>/group: group changed <span class="s1">'zulip'</span> to <span class="s1">'root'</span>
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Supervisor/Service<span class="o">[</span>supervisor<span class="o">]</span>: Triggered <span class="s1">'refresh'</span> from <span class="m">2</span> events
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::Nginx/Service<span class="o">[</span>nginx<span class="o">]</span>: Triggered <span class="s1">'refresh'</span> from <span class="m">2</span> events
Notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Zulip::App_frontend_base/Zulip::Safepackage<span class="o">[</span>postgresql-client<span class="o">]</span>/Package<span class="o">[</span>postgresql-client<span class="o">]</span>/ensure: created
Notice: Applied catalog <span class="k">in</span> <span class="m">17</span>.04 seconds
+ pg_restore -d zulip -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database
<span class="sb">`</span>pg_restore: <span class="o">[</span>archiver<span class="o">]</span> unsupported version <span class="o">(</span><span class="m">1</span>.14<span class="o">)</span> <span class="k">in</span> file header<span class="sb">`</span>

Error running a subcommand of /home/zulip/deployments/current/scripts/setup/restore-backup: pg_restore -d zulip -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database
Actual error output <span class="k">for</span> the subcommand is just above this.

Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"/home/zulip/deployments/current/scripts/setup/restore-backup"</span>, line <span class="m">163</span>, <span class="k">in</span> &lt;module&gt;
    restore_backup<span class="o">(</span>tarball_file<span class="o">)</span>
  File <span class="s2">"/home/zulip/deployments/current/scripts/setup/restore-backup"</span>, line <span class="m">148</span>, <span class="k">in</span> restore_backup
    run<span class="o">([</span><span class="s2">"pg_restore"</span>, <span class="s2">"-d"</span>, db<span class="o">[</span><span class="s2">"NAME"</span><span class="o">]</span>, <span class="s2">"--"</span>, db_dir<span class="o">]</span>, <span class="nv">cwd</span><span class="o">=</span><span class="s2">"/"</span>, <span class="nv">env</span><span class="o">=</span>postgres_env<span class="o">)</span>
  File <span class="s2">"/home/zulip/deployments/current/scripts/lib/zulip_tools.py"</span>, line <span class="m">198</span>, <span class="k">in</span> run
    subprocess.check_call<span class="o">(</span>args, **kwargs<span class="o">)</span>
  File <span class="s2">"/usr/lib/python3.6/subprocess.py"</span>, line <span class="m">311</span>, <span class="k">in</span> check_call
    raise CalledProcessError<span class="o">(</span>retcode, cmd<span class="o">)</span>
subprocess.CalledProcessError: Command <span class="s1">'['</span>pg_restore<span class="s1">', '</span>-d<span class="s1">', '</span>zulip<span class="s1">', '</span>--<span class="s1">', '</span>/tmp/zulip-restore-backup-_ouu520s/zulip-backup/database<span class="s1">']'</span> returned non-zero <span class="nb">exit</span> status <span class="m">1</span>.
</code></pre></div>
<p>Any help would be greatly appreciated.</p>
<p><div class="codehilite"><pre><span></span><code>Output of `dpkg -l | grep postgres` is as follows
```bash
ii  check-postgres                             2.25.0-1.pgdg18.04+1                             all          script for monitoring PostgreSQL databases
ii  pgdg-keyring                               2018.2                                           all          keyring for apt.postgresql.org
ii  postgresql-10                              10.15-1.pgdg18.04+1                              amd64        object-relational SQL database, version 10 server
ii  postgresql-client                          13+225.pgdg18.04+1                               all          front-end programs for PostgreSQL (supported version)
ii  postgresql-client-10                       10.15-1.pgdg18.04+1                              amd64        front-end programs for PostgreSQL 10
ii  postgresql-client-12                       12.5-1.pgdg18.04+1                               amd64        front-end programs for PostgreSQL 12
ii  postgresql-client-13                       13.2-1.pgdg18.04+1                               amd64        front-end programs for PostgreSQL 13
ii  postgresql-client-common                   223.pgdg18.04+1                                  all          manager for multiple PostgreSQL client versions
ii  postgresql-common                          223.pgdg18.04+1                                  all          PostgreSQL database-cluster manager
```
</code></pre></div><br>
</p>
</blockquote>



<a name="1122589"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122589" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122589">(Feb 23 2021 at 03:06)</a>:</h4>
<p>I'm guessing it's picking up the postgres 10 client.</p>



<a name="1122590"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122590" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122590">(Feb 23 2021 at 03:09)</a>:</h4>
<p>You can try using <code>update_alternatives</code> to switch which one <code>pg_restore</code> runs</p>



<a name="1122591"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122591" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122591">(Feb 23 2021 at 03:11)</a>:</h4>
<p>Hm, looks like it's not in <code>update-alternatives</code></p>



<a name="1122592"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122592" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122592">(Feb 23 2021 at 03:13)</a>:</h4>
<p><span class="user-mention" data-user-id="13286">@Tej Gill</span>: Try</p>
<div class="codehilite"><pre><span></span><code>pg_restore -f zulip --cluster 13/main -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database
</code></pre></div>
<p>(assuming you're running pg 13, as the one with your data)</p>



<a name="1122593"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122593" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122593">(Feb 23 2021 at 03:14)</a>:</h4>
<p>Oh, hang on.  No, that's not right, your only server pg is 10</p>



<a name="1122594"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122594" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tej Gill <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122594">(Feb 23 2021 at 03:17)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> thank you for the quick reply. Would you happen to know what may have caused the <code>An unexpected error occurred</code> when trying to upload an attachment? Our users started reporting it in the later afternoon.</p>



<a name="1122595"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122595" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122595">(Feb 23 2021 at 03:17)</a>:</h4>
<p>Oh -- I think your data may have been <em>dumped</em> with pg 13 command-line tools, but it's picking up version 10 as the version of pg_restore to use, becauase that matches the running cluster<br>
And the version 10 <code>pg_restore</code> doesn't understand the version 13 data.</p>



<a name="1122596"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122596" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122596">(Feb 23 2021 at 03:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="13286">Tej Gill</span> <a href="#narrow/stream/31-production-help/topic/restore.20zulip/near/1122594">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> thank you for the quick reply. Would you happen to know what may have caused the <code>An unexpected error occurred</code> when trying to upload an attachment? Our users started reporting it in the later afternoon.</p>
</blockquote>
<p>What does <code>/var/log/zulip/error.log</code> say?</p>



<a name="1122597"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122597" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122597">(Feb 23 2021 at 03:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/restore.20zulip/near/1122595">said</a>:</p>
<blockquote>
<p>Oh -- I think your data may have been <em>dumped</em> with pg 13 command-line tools, but it's picking up version 10 as the version of pg_restore to use, becauase that matches the running cluster<br>
And the version 10 <code>pg_restore</code> doesn't understand the version 13 data.</p>
</blockquote>
<p>If so, this is a bug in our backup scripts, which need to make sure to use the same pg_backup binary when taking backups, due to a pg bug: <a href="https://stackoverflow.com/questions/59455783/pg-restore-archiver-unsupported-version-1-14-in-file-header">https://stackoverflow.com/questions/59455783/pg-restore-archiver-unsupported-version-1-14-in-file-header</a></p>



<a name="1122598"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122598" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tej Gill <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122598">(Feb 23 2021 at 03:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/restore.20zulip/near/1122596">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="13286">Tej Gill</span> <a href="#narrow/stream/31-production-help/topic/restore.20zulip/near/1122594">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> thank you for the quick reply. Would you happen to know what may have caused the <code>An unexpected error occurred</code> when trying to upload an attachment? Our users started reporting it in the later afternoon.</p>
</blockquote>
<p>What does <code>/var/log/zulip/error.log</code> say?</p>
</blockquote>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> I am seeing one error over and over again. not sure if that has something to do with anything</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>  File <span class="s2">"./zerver/lib/db.py"</span>, line <span class="m">33</span>, <span class="k">in</span> execute
    <span class="k">return</span> wrapper_execute<span class="o">(</span>self, super<span class="o">()</span>.execute, query, vars<span class="o">)</span>
  File <span class="s2">"./zerver/lib/db.py"</span>, line <span class="m">20</span>, <span class="k">in</span> wrapper_execute
    <span class="k">return</span> action<span class="o">(</span>sql, params<span class="o">)</span>
psycopg2.errors.UndefinedTable: relation <span class="s2">"django_session"</span> does not exist
LINE <span class="m">1</span>: ...ession_data<span class="s2">", "</span>django_session<span class="s2">"."</span>expire_date<span class="s2">" FROM "</span>django_se...
                                                             ^


The above exception was the direct cause of the following exception:

Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/core/handlers/exception.py"</span>, line <span class="m">34</span>, <span class="k">in</span> inner
    <span class="nv">response</span> <span class="o">=</span> get_response<span class="o">(</span>request<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/utils/deprecation.py"</span>, line <span class="m">93</span>, <span class="k">in</span> __call__
    <span class="nv">response</span> <span class="o">=</span> self.process_request<span class="o">(</span>request<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/middleware/locale.py"</span>, line <span class="m">21</span>, <span class="k">in</span> process_request
    <span class="nv">language</span> <span class="o">=</span> translation.get_language_from_request<span class="o">(</span>request, <span class="nv">check_path</span><span class="o">=</span>i18n_patterns_used<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/utils/translation/__init__.py"</span>, line <span class="m">236</span>, <span class="k">in</span> get_language_f
rom_request
    <span class="k">return</span> _trans.get_language_from_request<span class="o">(</span>request, check_path<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/utils/translation/trans_real.py"</span>, line <span class="m">532</span>, <span class="k">in</span> get_language
_from_request
    <span class="nv">lang_code</span> <span class="o">=</span> request.session.get<span class="o">(</span>LANGUAGE_SESSION_KEY<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/sessions/backends/base.py"</span>, line <span class="m">65</span>, <span class="k">in</span> get
    <span class="k">return</span> self._session.get<span class="o">(</span>key, default<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/sessions/backends/base.py"</span>, line <span class="m">194</span>, <span class="k">in</span> _get_sessi
on
    self._session_cache <span class="o">=</span> self.load<span class="o">()</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/sessions/backends/cached_db.py"</span>, line <span class="m">35</span>, <span class="k">in</span> load
    <span class="nv">s</span> <span class="o">=</span> self._get_session_from_db<span class="o">()</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/sessions/backends/db.py"</span>, line <span class="m">34</span>, <span class="k">in</span> _get_session_
from_db
    <span class="nv">expire_date__gt</span><span class="o">=</span>timezone.now<span class="o">()</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/manager.py"</span>, line <span class="m">82</span>, <span class="k">in</span> manager_method
    <span class="k">return</span> getattr<span class="o">(</span>self.get_queryset<span class="o">()</span>, name<span class="o">)(</span>*args, **kwargs<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py"</span>, line <span class="m">402</span>, <span class="k">in</span> get
    <span class="nv">num</span> <span class="o">=</span> len<span class="o">(</span>clone<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py"</span>, line <span class="m">256</span>, <span class="k">in</span> __len__
    self._fetch_all<span class="o">()</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py"</span>, line <span class="m">1242</span>, <span class="k">in</span> _fetch_all
    self._result_cache <span class="o">=</span> list<span class="o">(</span>self._iterable_class<span class="o">(</span>self<span class="o">))</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py"</span>, line <span class="m">55</span>, <span class="k">in</span> __iter__
    <span class="nv">results</span> <span class="o">=</span> compiler.execute_sql<span class="o">(</span><span class="nv">chunked_fetch</span><span class="o">=</span>self.chunked_fetch, <span class="nv">chunk_size</span><span class="o">=</span>self.chunk_size<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/sql/compiler.py"</span>, line <span class="m">1140</span>, <span class="k">in</span> execute_sql
    cursor.execute<span class="o">(</span>sql, params<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py"</span>, line <span class="m">67</span>, <span class="k">in</span> execute
    <span class="k">return</span> self._execute_with_wrappers<span class="o">(</span>sql, params, <span class="nv">many</span><span class="o">=</span>False, <span class="nv">executor</span><span class="o">=</span>self._execute<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py"</span>, line <span class="m">76</span>, <span class="k">in</span> _execute_with_wrappers
    <span class="k">return</span> executor<span class="o">(</span>sql, params, many, context<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py"</span>, line <span class="m">84</span>, <span class="k">in</span> _execute
    <span class="k">return</span> self.cursor.execute<span class="o">(</span>sql, params<span class="o">)</span>
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/utils.py"</span>, line <span class="m">89</span>, <span class="k">in</span> __exit__
    raise dj_exc_value.with_traceback<span class="o">(</span>traceback<span class="o">)</span> from exc_value
  File <span class="s2">"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py"</span>, line <span class="m">84</span>, <span class="k">in</span> _execute
    <span class="k">return</span> self.cursor.execute<span class="o">(</span>sql, params<span class="o">)</span>
  File <span class="s2">"./zerver/lib/db.py"</span>, line <span class="m">33</span>, <span class="k">in</span> execute
    <span class="k">return</span> wrapper_execute<span class="o">(</span>self, super<span class="o">()</span>.execute, query, vars<span class="o">)</span>
</code></pre></div>



<a name="1122599"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122599" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122599">(Feb 23 2021 at 03:41)</a>:</h4>
<p>That error looks like the <code>django_session</code> table doesn't exist.  Which is likely because recovering from backups, as a first step, dropped your current database.</p>



<a name="1122603"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122603" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122603">(Feb 23 2021 at 03:48)</a>:</h4>
<p><span class="user-mention" data-user-id="13286">@Tej Gill</span>: I believe your path forward is to try explicitly using the postgres-13 pg_restore on your backup.</p>
<div class="codehilite"><pre><span></span><code>export PATH=/usr/lib/postgresql/13/bin:$PATH
</code></pre></div>
<p>...then re-run the <code>scripts/setup/restore-backup</code> command you ran to produce what you pasted.</p>



<a name="1122613"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/restore%20zulip/near/1122613" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tej Gill <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/restore.20zulip.html#1122613">(Feb 23 2021 at 04:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/restore.20zulip/near/1122603">said</a>:</p>
<blockquote>
<p>Thanks <span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> I will try that and let you know how it goes</p>
</blockquote>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>