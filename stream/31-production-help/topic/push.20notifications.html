<html>
<head><meta charset="utf-8"><title>push notifications · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html">push notifications</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1329414"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329414" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bob Grabowsky <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329414">(Feb 15 2022 at 23:02)</a>:</h4>
<p>Hello and good day!   We run a self hosted zulip server and love it!   It has been running very well and we upgrade regularly.    Around the time of the latest release (zulip-server-4.9) something happened to our mobile push notifications and now they no longer work.   There are errors in /var/log/zulip/smokescreen.log that appear suspicious.   Any help you can provide would be much appreciated.  Thanks!</p>
<div class="codehilite"><pre><span></span><code>{&quot;id&quot;:&quot;xxxxxxxx redacted xxxxxxxxxxx&quot;,&quot;inbound_remote_addr&quot;:&quot;127.0.0.1:40444&quot;,&quot;level&quot;:&quot;error&quot;,&quot;msg&quot;:&quot;Timed out connecting to remote host: dial tcp [2600:1f18:414:db32:c9cb:cd72:b645:e647]:443: connect: connection timed out&quot;,&quot;project&quot;:&quot;&quot;,&quot;proxy_type&quot;:&quot;connect&quot;,&quot;requested_host&quot;:&quot;push.zulipchat.com:443&quot;,&quot;role&quot;:&quot;&quot;,&quot;start_time&quot;:&quot;2022-02-15T22:42:31.801377436Z&quot;,&quot;time&quot;:&quot;2022-02-15T17:44:41-05:00&quot;,&quot;trace_id&quot;:&quot;&quot;}
</code></pre></div>



<a name="1329431"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329431" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329431">(Feb 15 2022 at 23:06)</a>:</h4>
<p>A message was moved here from <a class="stream-topic" data-stream-id="9" href="/#narrow/stream/9-issues/topic/push.20notifications">#issues &gt; push notifications</a> by <span class="user-mention silent" data-user-id="12178">Alex Vandiver</span>.</p>



<a name="1329434"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329434" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329434">(Feb 15 2022 at 23:06)</a>:</h4>
<p>Does your host have a valid IPv6 address?</p>



<a name="1329439"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329439" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329439">(Feb 15 2022 at 23:09)</a>:</h4>
<p><span class="user-mention" data-user-id="23198">@Bob Grabowsky</span>: Can you show the output of the following?</p>
<div class="codehilite"><pre><span></span><code>curl -v -6 https://push.zulipchat.com/compatibility
</code></pre></div>



<a name="1329447"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329447" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bob Grabowsky <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329447">(Feb 15 2022 at 23:18)</a>:</h4>
<p>Here's the output, the command seems to have stalled</p>
<div class="codehilite"><pre><span></span><code># curl -v -6 https://push.zulipchat.com/compatibility
*   Trying 2600:1f18:414:db48:b25:16a9:4e0c:700a...
* TCP_NODELAY set
* connect to 2600:1f18:414:db48:b25:16a9:4e0c:700a port 443 failed: Connection timed out
*   Trying 2600:1f18:414:db16:8d4f:7e90:dcf0:4fd7...
* TCP_NODELAY set
* After 84746ms connect time, move on!
* connect to 2600:1f18:414:db16:8d4f:7e90:dcf0:4fd7 port 443 failed: Connection timed out
*   Trying 2600:1f18:414:db32:c9cb:cd72:b645:e647...
* TCP_NODELAY set
</code></pre></div>



<a name="1329450"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329450" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329450">(Feb 15 2022 at 23:20)</a>:</h4>
<p>So it looks like your server can't talk to IPv6 hosts, or there's a firewall in place.</p>
<p>Does Google work?</p>
<div class="codehilite"><pre><span></span><code>curl -v -6 https://google.com/
</code></pre></div>



<a name="1329451"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329451" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329451">(Feb 15 2022 at 23:21)</a>:</h4>
<p>And do you have an IPv6 address?</p>
<div class="codehilite"><pre><span></span><code>ip address | grep &#39;inet6.*global&#39;
</code></pre></div>



<a name="1329452"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329452" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329452">(Feb 15 2022 at 23:22)</a>:</h4>
<p>(that may show an IP, so you can PM me the result if you're not sure how to interpret it)</p>



<a name="1329456"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329456" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bob Grabowsky <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329456">(Feb 15 2022 at 23:30)</a>:</h4>
<div class="codehilite"><pre><span></span><code># curl -v -6 https://google.com/
*   Trying 2607:f8b0:4006:80b::200e...
* TCP_NODELAY set
* Immediate connect fail for 2607:f8b0:4006:80b::200e: Network is unreachable
* Closing connection 0
curl: (7) Couldn&#39;t connect to server
</code></pre></div>
<div class="codehilite"><pre><span></span><code># ip address | grep &#39;inet6.*global&#39;
    inet6 2604:a00:5:3383:216:3eff:fe03:64a4/64 scope global dynamic mngtmpaddr
</code></pre></div>



<a name="1329460"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329460" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329460">(Feb 15 2022 at 23:35)</a>:</h4>
<p>Yeah, that's a temporary IPv6 address, which I don't think is actually routable.</p>
<p>It's notable that smokescreen isn't using happy-eyeballs to work around the lack of ipv6.</p>



<a name="1329461"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329461" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329461">(Feb 15 2022 at 23:36)</a>:</h4>
<p>You're going to have to either disable IPv6, or get the host to have a real IPv6 address.</p>



<a name="1329463"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329463" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329463">(Feb 15 2022 at 23:42)</a>:</h4>
<p>Alternately, I think you can write out a Smokescreen config file, adjust the supervisorctl file to pass that as <code>--config</code>, and in that say:</p>
<div class="codehilite" data-code-language="YAML"><pre><span></span><code><span class="nt">network</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip4</span><span class="w"></span>
</code></pre></div>
<p>That's just from squinting at:<br>
<a href="https://github.com/stripe/smokescreen/blob/dc403015f563eadc556a61870c6ad327688abe88/pkg/smokescreen/config_loader.go#L34">https://github.com/stripe/smokescreen/blob/dc403015f563eadc556a61870c6ad327688abe88/pkg/smokescreen/config_loader.go#L34</a><br>
<a href="https://github.com/stripe/smokescreen/blob/dc403015f563eadc556a61870c6ad327688abe88/pkg/smokescreen/config_loader.go#L142">https://github.com/stripe/smokescreen/blob/dc403015f563eadc556a61870c6ad327688abe88/pkg/smokescreen/config_loader.go#L142</a></p>



<a name="1329464"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329464" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329464">(Feb 15 2022 at 23:42)</a>:</h4>
<p><code>mngtmpaddr</code> doesn’t mean this address is temporary. It means that the kernel manages other temporary addresses created from this one as a template (<a href="https://man7.org/linux/man-pages/man8/ip-address.8.html">ip-address(8)</a>).</p>



<a name="1329465"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329465" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329465">(Feb 15 2022 at 23:43)</a>:</h4>
<p>I have several such addresses here and my IPv6 works fine.</p>



<a name="1329466"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329466" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329466">(Feb 15 2022 at 23:44)</a>:</h4>
<p>Huh.  Are they also <code>dynamic</code>?  Is that just a marker of SLAAC?</p>



<a name="1329473"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329473" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329473">(Feb 15 2022 at 23:47)</a>:</h4>
<p>I think <code>dynamic</code> is either SLAAC or DHCPv6. I have</p>
<div class="codehilite"><pre><span></span><code>3: wlp0s20f3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 state UP qlen 1000
    inet6 2602:…/128 scope global dynamic noprefixroute
       valid_lft 29852sec preferred_lft 29852sec
    inet6 fdbb:…/128 scope global dynamic noprefixroute
       valid_lft 29852sec preferred_lft 29852sec
    inet6 fdbb:…/64 scope global temporary dynamic
       valid_lft 591451sec preferred_lft 72888sec
    inet6 fdbb:…/64 scope global mngtmpaddr noprefixroute
       valid_lft forever preferred_lft forever
    inet6 2602:…/64 scope global temporary dynamic
       valid_lft 591451sec preferred_lft 72888sec
    inet6 2602:…/64 scope global mngtmpaddr noprefixroute
       valid_lft forever preferred_lft forever
    inet6 fe80:…/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
</code></pre></div>



<a name="1329476"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329476" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329476">(Feb 15 2022 at 23:49)</a>:</h4>
<p>If debugging your network sounds fun, my next debugging step would be <code>mtr -6 google.com</code>.</p>



<a name="1329480"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329480" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329480">(Feb 15 2022 at 23:52)</a>:</h4>
<p>If I try to trace the address you posted from here, my trace ends at <code>2604:a00:21::202:3</code>. I assume that’s a firewall blocking inbound connections, which isn’t necessarily unusual, but if it’s also blocking outbound connections, that might give you an idea of who to complain to.</p>



<a name="1329552"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329552" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bob Grabowsky <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329552">(Feb 16 2022 at 00:51)</a>:</h4>
<p>Thank you for all of your suggestions and help!    I have contacted my provider about this IPv6 issue.   Is there any way that I can make this work with IPv4 only?  Again, thanks!</p>



<a name="1329559"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1329559" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1329559">(Feb 16 2022 at 00:59)</a>:</h4>
<p>The following is only lightly tested and will get overwritten on next <code>zulip-puppet-apply</code> (generally during upgrades):</p>
<ol>
<li>Create <code>/etc/zulip/smokescreen.yaml</code> containing:</li>
</ol>
<div class="codehilite" data-code-language="YAML"><pre><span></span><code><span class="nn">---</span><span class="w"></span>
<span class="nt">network</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip4</span><span class="w"></span>
</code></pre></div>
<ol start="2">
<li>Edit <code>/etc/supervisor/conf.d/zulip/smokescreen.conf</code> and add <code>--config-file /etc/zulip/smokescreen.yaml</code> to the second line.</li>
<li>Run <code>supervisorctl reread &amp;&amp; supervisorctl update</code></li>
</ol>



<a name="1355822"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355822" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355822">(Mar 30 2022 at 05:16)</a>:</h4>
<p>Hello!  Apologies for resurrecting an old thread but having a similar issue and hoped sharing some debugging efforts might garner some advice</p>
<p>I am a fairly amateur user and have just started up a VPS exposed directly to the internet and with static IPv4 and IPv6 addresses, and installed Zulip 5.0 according to the docs, including <a href="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html">https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html</a>.  It went very smoothly, the messaging works amazingly, and I'm really grateful for all the work that went into making Zulip!</p>
<p>One issue at the moment is that notifications of new messages to an account logged in on the Android app (installed from the Github apk download) from an account logged in on the desktop do not seem to go through.</p>
<p>The output of su zulip -c '/home/zulip/deployments/current/manage.py register_server' was (with specific info replaced with ***)</p>
<div class="codehilite"><pre><span></span><code>The following data will be submitted to the push notification service:
  contact_email: ***
  hostname: ***
  zulip_org_id: ***
  zulip_org_key: ***

To register, you must agree to the Zulipchat Terms of Service: https://zulip.com/terms/
Do you agree to the Terms of Service? [Y/n] Y

You&#39;ve successfully registered for the Mobile Push Notification Service!
To finish setup for sending push notifications:
- Restart the server, using /home/zulip/deployments/current/scripts/restart-server
- Return to the documentation to learn how to test push notifications
</code></pre></div>
<p>Restarted the server, then sent a message from an account logged in on the desktop to one logged in on the Android phone, and did not receive any notification.  On pulling up the app the message is immediately there to see.</p>
<p>The contents of /var/log/zulip/smokescreen.log include</p>
<div class="codehilite"><pre><span></span><code>{&quot;allow&quot;:true,&quot;decision_reason&quot;:&quot;Egress ACL is not configured&quot;,&quot;dns_lookup_time_
ms&quot;:0,&quot;enforce_would_deny&quot;:false,&quot;id&quot;:&quot;***&quot;,&quot;inbound_remote_add
r&quot;:&quot;127.0.0.1:49104&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;CANONICAL-PROXY-DECISION&quot;,&quot;project&quot;:&quot;
&quot;,&quot;proxy_type&quot;:&quot;connect&quot;,&quot;requested_host&quot;:&quot;push.zulipchat.com:443&quot;,&quot;role&quot;:&quot;&quot;,&quot;st
art_time&quot;:&quot;2022-03-30T04:41:27.714549031Z&quot;,&quot;time&quot;:&quot;2022-03-30T04:41:27Z&quot;,&quot;trace_
id&quot;:&quot;&quot;}
{&quot;bytes_in&quot;:6352,&quot;bytes_out&quot;:2154,&quot;conn_establish_time_ms&quot;:7,&quot;duration&quot;:4.980871
424,&quot;end_time&quot;:&quot;2022-03-30T04:41:32.07300846Z&quot;,&quot;error&quot;:&quot;&quot;,&quot;id&quot;:&quot;***
knng&quot;,&quot;inbound_remote_addr&quot;:&quot;127.0.0.1:49098&quot;,&quot;last_activity&quot;:&quot;2022-03-30T04:41:
27.180009012Z&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;CANONICAL-PROXY-CN-CLOSE&quot;,&quot;project&quot;:&quot;&quot;,&quot;pro
xy_type&quot;:&quot;connect&quot;,&quot;requested_host&quot;:&quot;push.zulipchat.com:443&quot;,&quot;role&quot;:&quot;&quot;,&quot;start_ti
me&quot;:&quot;2022-03-30T04:41:27.083724656Z&quot;,&quot;time&quot;:&quot;2022-03-30T04:41:32Z&quot;,&quot;trace_id&quot;:&quot;&quot;
}
</code></pre></div>
<p>Looking at that I wondered about those ports in the 127.0.0.1:49xxx range so I explicitly allowed them in the firewall (using ufw), but am still seeing the same errors and no notification on Android.  Also searched the smokescreen Github for "Egress ACL is not configured" and found where the error of that type is defined, but could not quite sort out how to back out where/why it is coming up in this case (sorry, like I said, fairly amateur here)</p>
<p>Although the precise nature of the error is different from Bob's thought I would check the advice he had been given to try curl -v -6 <a href="https://push.zulipchat.com/compatibility">https://push.zulipchat.com/compatibility</a> and that worked fine.</p>
<p>Any thoughts what part of my configuration may be askew, or any other logging information I can dig up to help with that?</p>
<p>Thank you!</p>



<a name="1355834"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355834" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355834">(Mar 30 2022 at 05:34)</a>:</h4>
<p>Those are normal smokescreen logs.  We're not explicitly configuring an egress ACL on smokescreen -- we're using it for its default configuration of denying private IP addresses, so those logs are normal for Smokescreen.</p>



<a name="1355835"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355835" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355835">(Mar 30 2022 at 05:35)</a>:</h4>
<p><span class="user-mention" data-user-id="23744">@Amit</span>: Is there anything relevant in the end of <code>/var/log/zulip/events_missedmessage_mobile_notifications.log</code> ?</p>



<a name="1355836"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355836" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355836">(Mar 30 2022 at 05:36)</a>:</h4>
<p>And the port 49104 is he <em>outgoing</em> TCP port (well, outbound from zulip, inbound to Smokescreen).  So there's no need to open it up in firewalls -- there's nothing listening there, nor does it need to be available.</p>



<a name="1355838"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355838" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355838">(Mar 30 2022 at 05:38)</a>:</h4>
<p><span class="user-mention" data-user-id="23744">@Amit</span>: And if you can DM me the IP address of your host, I can check the logs from the push bouncer.</p>



<a name="1355843"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355843" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355843">(Mar 30 2022 at 05:40)</a>:</h4>
<p>Thanks!  That log file does not seem to be there in /var/log/zulip, maybe that's a relevant symptom?<br>
I'll DM the IP address too</p>



<a name="1355844"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355844" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355844">(Mar 30 2022 at 05:40)</a>:</h4>
<p>If it's not there, can you show <code>supervisorctl status</code>?</p>



<a name="1355846"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355846" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355846">(Mar 30 2022 at 05:41)</a>:</h4>
<p>supervisorctl status gives</p>
<div class="codehilite"><pre><span></span><code>go-camo                            RUNNING   pid 26259, uptime 1:16:51
process-fts-updates                RUNNING   pid 28489, uptime 1:02:32
smokescreen                        RUNNING   pid 26260, uptime 1:16:51
zulip-django                       RUNNING   pid 28498, uptime 1:02:25
zulip-tornado                      RUNNING   pid 27240, uptime 1:15:33
zulip-workers:zulip_events         RUNNING   pid 28473, uptime 1:02:37
zulip_deliver_scheduled_emails     RUNNING   pid 28480, uptime 1:02:35
zulip_deliver_scheduled_messages   RUNNING   pid 28483, uptime 1:02:34
</code></pre></div>



<a name="1355847"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355847" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355847">(Mar 30 2022 at 05:42)</a>:</h4>
<p>OK, that's fine.</p>



<a name="1355848"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355848" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355848">(Mar 30 2022 at 05:42)</a>:</h4>
<p>Does the server have an IPv6 address?</p>



<a name="1355849"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355849" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355849">(Mar 30 2022 at 05:45)</a>:</h4>
<p>Check the logs in <code>/var/log/zulip/events.log</code> instead, since you're in the low-memory configuration where only a single worker handles all of the events</p>



<a name="1355851"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355851" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355851">(Mar 30 2022 at 05:47)</a>:</h4>
<p>It does have an IPv6 address, I'll DM that too<br>
/var/log/zulip/events.log has a lot of this over and over:</p>
<div class="codehilite"><pre><span></span><code>2022-03-30 04:41:03.635 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 9
2022-03-30 05:02:51.398 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 0 via FCM devices, 0 via APNs devices
</code></pre></div>
<p>To be precise the second entry there is repeated a few times</p>



<a name="1355853"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355853" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355853">(Mar 30 2022 at 05:50)</a>:</h4>
<p>The ids on those rows should match.  Are you mixing and matching rows in that copy/paste?</p>



<a name="1355854"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355854" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355854">(Mar 30 2022 at 05:52)</a>:</h4>
<p>Ah.  Have you logged back in on your device, after signing up for push notifications?</p>



<a name="1355855"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355855" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355855">(Mar 30 2022 at 05:53)</a>:</h4>
<p>Not sure how I muddled it but now that you say it, I think I did.  Here's the full block without trying to be fancy about it:</p>
<div class="codehilite"><pre><span></span><code>2022-03-30 04:41:03.635 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 9
2022-03-30 04:41:03.713 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 9 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-03-30 04:41:27.079 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 8
2022-03-30 04:41:27.181 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-03-30 04:53:12.870 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 8
2022-03-30 04:53:12.959 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-03-30 04:53:38.575 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 9
2022-03-30 04:53:38.684 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 9 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-03-30 04:58:35.048 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 8
2022-03-30 04:58:35.114 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-03-30 05:02:51.189 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 8
2022-03-30 05:02:51.398 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-03-30 05:05:50.713 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 8
2022-03-30 05:05:50.805 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-03-30 05:18:34.738 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 8
2022-03-30 05:18:34.845 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 0 via FCM devices, 0 via APNs devices
</code></pre></div>



<a name="1355857"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355857" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355857">(Mar 30 2022 at 05:53)</a>:</h4>
<p>From <a href="https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html">https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html</a> :</p>
<blockquote>
<p>If you or your users have already set up the Zulip mobile app, you’ll each need to log out and log back in again in order to start getting push notifications.</p>
</blockquote>
<p>Did you log out and back in again?</p>



<a name="1355858"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355858" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355858">(Mar 30 2022 at 05:55)</a>:</h4>
<p>Maybe another symptom that could help, in the "Manage Organization" menu from the gear icon, under "Default User Settings", the tooltip above the Mobile column of the Notification Triggers settings tells me that "Mobile push notifications are not configured on the server" - somehow it knows I've not set it up properly?</p>



<a name="1355859"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355859" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355859">(Mar 30 2022 at 05:56)</a>:</h4>
<p>Logged out and in a few times, I'll do it again to make doubly sure.</p>



<a name="1355860"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355860" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355860">(Mar 30 2022 at 05:58)</a>:</h4>
<p>Yeh, there's still no device registration happening.  But that message is ... notable.</p>



<a name="1355861"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355861" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355861">(Mar 30 2022 at 06:00)</a>:</h4>
<p>Just logged out on the desktop and for good measure closed out the browser (running incognito so hopefully no state leakage), and for good measure both logged out from and uninstalled/reinstalled the app on the Android before logging in again, same situation unfortunately<br>
New entry in the events.log similar to before:</p>
<div class="codehilite"><pre><span></span><code>2022-03-30 05:58:02.409 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 8
2022-03-30 05:58:02.477 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-03-30 05:58:10.841 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 8
2022-03-30 05:58:10.913 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 0 via FCM devices, 0 via APNs devices
</code></pre></div>
<p>(did send two messages which I'm assuming correspond to the two pairs there)</p>



<a name="1355864"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355864" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355864">(Mar 30 2022 at 06:07)</a>:</h4>
<p>I've just come across <a href="https://github.com/zulip/zulip-mobile/issues/3838">https://github.com/zulip/zulip-mobile/issues/3838</a> and am slightly kicking myself for not realizing not having GCM on my phone (have ?upgraded it to GrapheneOS which was probably out of my depth) might well be the issue</p>



<a name="1355865"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355865" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355865">(Mar 30 2022 at 06:09)</a>:</h4>
<p>You seem to have gotten it to go through now.</p>



<a name="1355868"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355868" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355868">(Mar 30 2022 at 06:10)</a>:</h4>
<p>Though I'm a little confused why you're seeing a banner saying it's not enabled, if it's sending the push bouncer messages successfully.</p>



<a name="1355875"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355875" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355875">(Mar 30 2022 at 06:15)</a>:</h4>
<p>For the sake of anybody who might come across this later, on the Android/Graphene device I've installed the Android apk in a user account that has Google Play Services enabled, and in that setting the events.log gives</p>
<div class="codehilite"><pre><span></span><code>2022-03-30 06:10:22.905 INFO [zerver.lib.push_notifications] Sending push notifi
cations to mobile clients for user 8
2022-03-30 06:10:23.031 INFO [zerver.lib.push_notifications] Sent mobile push no
tifications for user 8 through bouncer: 1 via FCM devices, 0 via APNs devices
</code></pre></div>
<p>which seems more successful :)</p>
<p>On the other hand for some reason the phone still doesn't pop up a notification, and re-verified that the tooltip/banner still thinks the server isn't set up to push notifications</p>



<a name="1355876"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355876" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355876">(Mar 30 2022 at 06:16)</a>:</h4>
<p>I think you're a little in uncharted territory here.  The server is sending a FCM/GCM push notification to the device-id.</p>



<a name="1355878"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355878" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355878">(Mar 30 2022 at 06:17)</a>:</h4>
<p>I guess we can check something on the server.  Can you screenshot the tooltip/banner you're seeing, to make sure it's what I think it is?</p>



<a name="1355879"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355879" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355879">(Mar 30 2022 at 06:17)</a>:</h4>
<p>Seems like, totally understand the issue seems to essentially be a very narrow edge case with Graphene.  Screenshot coming right up</p>



<a name="1355884"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355884" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355884">(Mar 30 2022 at 06:19)</a>:</h4>
<p>Oh, hm, I have a guess.  Since you uncommented <code>PUSH_NOTIFICATION_BOUNCER_URL</code>, did you restart the server?</p>



<a name="1355886"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355886" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355886">(Mar 30 2022 at 06:19)</a>:</h4>
<p>I believe I did restart the server, but will do now to be sure <a href="/user_uploads/2/e7/4SmbloYr1uDdNozTxcXKSQLK/zulip_banner_screenshot.png">zulip_banner_screenshot.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/e7/4SmbloYr1uDdNozTxcXKSQLK/zulip_banner_screenshot.png" title="zulip_banner_screenshot.png"><img src="/user_uploads/2/e7/4SmbloYr1uDdNozTxcXKSQLK/zulip_banner_screenshot.png"></a></div>



<a name="1355887"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355887" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355887">(Mar 30 2022 at 06:20)</a>:</h4>
<p>OK, that tooltip is just a straight-up bug.  You should ignore it.</p>



<a name="1355888"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355888" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355888">(Mar 30 2022 at 06:20)</a>:</h4>
<p>Let me file something for it.</p>



<a name="1355894"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355894" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355894">(Mar 30 2022 at 06:23)</a>:</h4>
<p>Filed <a href="https://github.com/zulip/zulip/pull/21602">#21602</a>.  I see the same here, which definitely has push notifications on.</p>



<a name="1355896"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355896" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355896">(Mar 30 2022 at 06:23)</a>:</h4>
<p>So I think this is down to the unique phone configuration you're running.</p>



<a name="1355898"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355898" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355898">(Mar 30 2022 at 06:24)</a>:</h4>
<p>Restarted, same tooltip.  Happy to have helped uncover something semi-real at least, and thank you for all the help!  I'll see if I can dig enough to find something on the Graphene side, and maybe someday the UnifiedPush method will make it into the main branch</p>



<a name="1355899"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355899" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355899">(Mar 30 2022 at 06:25)</a>:</h4>
<p>Sorry I can't help more!</p>



<a name="1355900"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355900" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355900">(Mar 30 2022 at 06:25)</a>:</h4>
<p>I'd suggest leaving a comment on the UnifiedPush issue you found, just for visibility.</p>



<a name="1355901"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355901" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355901">(Mar 30 2022 at 06:26)</a>:</h4>
<p><span class="user-mention" data-user-id="2187">@Greg Price</span> may have more insight into if there's a chance of getting it to work without UnifiedPush, but I'm outside my area of knowledge there.</p>



<a name="1355930"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1355930" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amit <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1355930">(Mar 30 2022 at 06:58)</a>:</h4>
<p>Again for future folk who may find this, just upgraded the mobile to the now-current version of GrapheneOS, and notifications work!</p>



<a name="1356361"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1356361" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1356361">(Mar 30 2022 at 18:52)</a>:</h4>
<p>It does feel like it would be useful for the mobile app to do some soft of end-to-end test when it logs in, which would let it know if push notifications are working as the server claims.</p>



<a name="1427666"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1427666" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1427666">(Aug 30 2022 at 11:44)</a>:</h4>
<p>Hello, we are self hosting zulip. Push notification used to work, but I haven't been getting any notification for several months. <br>
Zulip has been running great besides push notification.  We haven't upgraded since going live in Oct 2021.  I added PGroonga in Nov 2021, admin email password changed in Apr 2022.  That's about all we did to zulip server.</p>
<p>I have re-registered for push notification twice today (I hope that doesn't cause any problems.)  I logged out and in of iOS app several times, restarted zulip, but I don't receive any push notifications.  I did check mobile app settings to receive notifications.</p>
<p>Should I look into anywhere else?  Thank you!</p>
<p><code>curl -v -6 https://push.zulipchat.com/compatibility</code></p>
<div class="codehilite"><pre><span></span><code>*   Trying 2600:1f18:414:db00:cca8:6126:d621:5d7f:443...
* TCP_NODELAY set
* Connected to push.zulipchat.com (2600:1f18:414:db00:cca8:6126:d621:5d7f) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS handshake, Server key exchange (12):
* TLSv1.2 (IN), TLS handshake, Server finished (14):
* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):
* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.2 (OUT), TLS handshake, Finished (20):
* TLSv1.2 (IN), TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256
* ALPN, server accepted to use h2
* Server certificate:
*  subject: CN=zulipchat.com
*  start date: Jan 12 00:00:00 2022 GMT
*  expire date: Feb 10 23:59:59 2023 GMT
*  subjectAltName: host &quot;push.zulipchat.com&quot; matched cert&#39;s &quot;*.zulipchat.com&quot;
*  issuer: C=US; O=Amazon; OU=Server CA 1B; CN=Amazon
*  SSL certificate verify ok.
* Using HTTP2, server supports multi-use
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0
* Using Stream ID: 1 (easy handle 0x555d8a8bc8c0)
&gt; GET /compatibility HTTP/2
&gt; Host: push.zulipchat.com
&gt; user-agent: curl/7.68.0
&gt; accept: */*
&gt;
* Connection state changed (MAX_CONCURRENT_STREAMS == 128)!
&lt; HTTP/2 200
&lt; date: Tue, 30 Aug 2022 09:02:03 GMT
&lt; content-type: application/json
&lt; content-length: 30
&lt; server: nginx/1.18.0 (Ubuntu)
&lt; vary: Accept-Encoding
&lt; vary: Accept-Language, Cookie
&lt; content-language: en
&lt; strict-transport-security: max-age=15768000
&lt; x-frame-options: DENY
&lt; x-content-type-options: nosniff
&lt;
{&quot;result&quot;:&quot;success&quot;,&quot;msg&quot;:&quot;&quot;}
* Connection #0 to host push.zulipchat.com left intact
</code></pre></div>
<p><code>curl -v -6 https://google.com/</code></p>
<div class="codehilite"><pre><span></span><code>*   Trying 2404:6800:4003:c11::65:443...
* TCP_NODELAY set
* Connected to google.com (2404:6800:4003:c11::65) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
* TLSv1.3 (IN), TLS handshake, Certificate (11):
* TLSv1.3 (IN), TLS handshake, CERT verify (15):
* TLSv1.3 (IN), TLS handshake, Finished (20):
* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.3 (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384
* ALPN, server accepted to use h2
* Server certificate:
*  subject: CN=*.google.com
*  start date: Aug  8 08:17:43 2022 GMT
*  expire date: Oct 31 08:17:42 2022 GMT
*  subjectAltName: host &quot;google.com&quot; matched cert&#39;s &quot;google.com&quot;
*  issuer: C=US; O=Google Trust Services LLC; CN=GTS CA 1C3
*  SSL certificate verify ok.
* Using HTTP2, server supports multi-use
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0
* Using Stream ID: 1 (easy handle 0x564de0ea98c0)
&gt; GET / HTTP/2
&gt; Host: google.com
&gt; user-agent: curl/7.68.0
&gt; accept: */*
&gt;
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* old SSL session ID is stale, removing
* Connection state changed (MAX_CONCURRENT_STREAMS == 100)!
&lt; HTTP/2 302
&lt; location: https://www.google.com/sorry/index?continue=https://google.com/&amp;q=EhAkAGGAAAAA0AAAAAASvmABGPakt5gGIhCiQ48E0Jf7YiDqmu71-09lMgFy
&lt; date: Tue, 30 Aug 2022 09:03:50 GMT
&lt; pragma: no-cache
&lt; expires: Fri, 01 Jan 1990 00:00:00 GMT
&lt; cache-control: no-store, no-cache, must-revalidate
&lt; content-type: text/html; charset=UTF-8
&lt; server: HTTP server (unknown)
&lt; content-length: 327
&lt; x-xss-protection: 0
&lt; alt-svc: h3=&quot;:443&quot;; ma=2592000,h3-29=&quot;:443&quot;; ma=2592000,h3-Q050=&quot;:443&quot;; ma=2592000,h3-Q046=&quot;:443&quot;; ma=2592000,h3-Q043=&quot;:443&quot;; ma=2592000,quic=&quot;:443&quot;; ma=2592000; v=&quot;46,43&quot;
&lt;
&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;
&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;302 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF=&quot;https://www.google.com/sorry/index?continue=https://google.com/&amp;amp;q=EhAkAGGAAAAA0AAAAAASvmABGPakt5gGIhCiQ48E0Jf7YiDqmu71-09lMgFy&quot;&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;
* Connection #0 to host google.com left intact
</code></pre></div>
<p><code>ip address | grep 'inet6.*global'</code></p>
<div class="codehilite"><pre><span></span><code>    inet6 2400:6180:0:d0::12be:6001/64 scope global
</code></pre></div>
<p><code> supervisorctl status</code></p>
<div class="codehilite"><pre><span></span><code>process-fts-updates                RUNNING   pid 61813, uptime 1:13:52
zulip-django                       RUNNING   pid 61809, uptime 1:13:52
zulip-tornado                      RUNNING   pid 61810, uptime 1:13:52
zulip-workers:zulip_events         RUNNING   pid 61814, uptime 1:13:52
zulip_deliver_scheduled_emails     RUNNING   pid 61811, uptime 1:13:52
zulip_deliver_scheduled_messages   RUNNING   pid 61812, uptime 1:13:52
</code></pre></div>



<a name="1427830"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1427830" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1427830">(Aug 30 2022 at 17:52)</a>:</h4>
<p><span class="user-mention" data-user-id="21024">@Naomi</span> strange. Can you look at <code>/var/log/zulip/events_missedmessage_mobile_notifications.log</code>? That should have a line of log output every time push notifications are sent.</p>



<a name="1427832"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1427832" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1427832">(Aug 30 2022 at 17:52)</a>:</h4>
<p>Also, does the issue only affect you? One possibility is that you configured your mobile device to suppress mobile notifications from Zulip in the OS settings.</p>



<a name="1428342"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428342" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428342">(Aug 31 2022 at 00:37)</a>:</h4>
<p>Thank you, Tim!<br>
I don't see <code>/var/log/zulip/events_missedmessage_mobile_notifications.log</code> in the dir.  </p>
<p>Our Zulip Server</p>
<div class="codehilite"><pre><span></span><code>Version 5.0-dev-2285-g0cd68b895c
Forked from upstream at 5.0-dev-2232-g0ef5cb4813
</code></pre></div>
<p>Another user of our org is not getting mobile notification.  He used to get them, too, so I assume his mobile is configured to receive notifications.  I did check my mobile OS, zulip app, and zulip settings are configured to receive notifications.</p>
<p>I looked <code>/var/log/zulip/events.log</code></p>
<div class="codehilite"><pre><span></span><code>2022-05-13 03:55:56.345 INFO [zerver.lib.push_notifications] Sending push notifications to mobile clients for user 58
2022-05-13 03:55:57.447 INFO [zerver.lib.push_notifications] Sent mobile push notifications for user 58 through bouncer: 1 via FCM devices, 1 via APNs devices
2022-05-13 03:58:43.298 INFO [zerver.lib.push_notifications] Sending push notifications to mobile clients for user 58
2022-05-13 03:58:44.597 INFO [zerver.lib.push_notifications] Sent mobile push notifications for user 58 through bouncer: 1 via FCM devices, 1 via APNs devices
2022-05-13 04:04:20.416 INFO [zerver.lib.push_notifications] Sending push notifications to mobile clients for user 11
2022-05-13 04:04:21.632 INFO [zerver.lib.push_notifications] Sent mobile push notifications for user 11 through bouncer: 0 via FCM devices, 2 via APNs devices
</code></pre></div>
<p>These are the last lines mentioning push notifications which are from 3 months ago.</p>



<a name="1428401"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428401" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428401">(Aug 31 2022 at 04:49)</a>:</h4>
<p><span class="user-mention" data-user-id="21024">@Naomi</span> fascinating! So it sounds like your server is not trying to send push notifications at all.</p>



<a name="1428402"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428402" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428402">(Aug 31 2022 at 04:49)</a>:</h4>
<p>One thing to check is this: <code>./scripts/get-django-setting PUSH_NOTIFICATION_BOUNCER_URL</code>.</p>



<a name="1428403"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428403" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428403">(Aug 31 2022 at 04:50)</a>:</h4>
<p>The other thing I'd recommend from reading that output is that you should upgrade to the latest 5.x release; you're missing some important security updates.</p>



<a name="1428404"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428404" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428404">(Aug 31 2022 at 04:51)</a>:</h4>
<p>(And that'll make it easier for us to provide further debugging advice, since you'd be on an official version)</p>



<a name="1428407"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428407" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428407">(Aug 31 2022 at 04:54)</a>:</h4>
<p>OK, I'll try to upgrade soon.  <br>
<del>But for now, <code>./scripts/get-django-setting PUSH_NOTIFICATION_BOUNCER_URL</code> is this a file?  Where can I find it?</del></p>



<a name="1428415"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428415" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428415">(Aug 31 2022 at 05:15)</a>:</h4>
<div class="codehilite"><pre><span></span><code>zulip@chat:~/deployments/current$ ./scripts/get-django-setting PUSH_NOTIFICATION_BOUNCER_URL
https://push.zulipchat.com
</code></pre></div>



<a name="1428638"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428638" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428638">(Aug 31 2022 at 17:09)</a>:</h4>
<p><span class="user-mention" data-user-id="21024">@Naomi</span> just to confirm, have you by any chance turned off mobile notifications in the settings UI? <a href="https://zulip.com/help/mobile-notifications">https://zulip.com/help/mobile-notifications</a></p>



<a name="1428961"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428961" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428961">(Sep 01 2022 at 01:10)</a>:</h4>
<p>All mobile notifications settings are turned on,  including <code>Send mobile notifications even if I'm online (useful for testing)</code>.</p>
<p>I just noticed our  outgoing email is not working somehow.  I have to look into that.  I assume email and push notification doesn't interfere.</p>



<a name="1428962"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1428962" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1428962">(Sep 01 2022 at 01:12)</a>:</h4>
<p>I'm getting ready to upgrade to 5.6.</p>



<a name="1429408"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429408" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429408">(Sep 01 2022 at 21:56)</a>:</h4>
<p><span class="user-mention" data-user-id="21024">@Naomi</span> can you run <code>rabbitmqctl list_queues</code> and <code>supervisorctl status</code> as root and post the output?</p>



<a name="1429409"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429409" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429409">(Sep 01 2022 at 21:56)</a>:</h4>
<p>I think the most likely explanation is that your <code>zulip_events</code> queue processor is not processing enqueued work.</p>



<a name="1429410"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429410" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429410">(Sep 01 2022 at 21:57)</a>:</h4>
<p>Restarting the zulip server with <code>restart-server</code> may fix the issue if so, depending on why that worker isn't running; otherwise I'd look at whatever the last things are in <code>events.log</code>, as it likely includes an exception that explains what went wrong.</p>



<a name="1429489"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429489" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429489">(Sep 02 2022 at 00:20)</a>:</h4>
<div class="codehilite"><pre><span></span><code>zone@chat:~$ sudo rabbitmqctl list_queues
[sudo] password for zone:
Timeout: 60.0 seconds ...
Listing queues for vhost / ...
name    messages
user_presence   371470
embedded_bots   0
deferred_work   0
outgoing_webhooks   0
email_mirror    0
email_senders   101
user_activity_interval  7212
invites 0
digest_emails   0
error_reports   0
missedmessage_mobile_notifications  2818
missedmessage_emails    2239
user_activity   1002360
notify_tornado  0
embed_links 0
</code></pre></div>
<div class="codehilite"><pre><span></span><code>zone@chat:~$ sudo supervisorctl status
process-fts-updates                RUNNING   pid 8864, uptime 12:59:42
zulip-django                       RUNNING   pid 8878, uptime 12:59:31
zulip-tornado                      RUNNING   pid 8870, uptime 12:59:39
zulip-workers:zulip_events         RUNNING   pid 8817, uptime 12:59:50
zulip_deliver_scheduled_emails     RUNNING   pid 8823, uptime 12:59:47
zulip_deliver_scheduled_messages   RUNNING   pid 8856, uptime 12:59:45
</code></pre></div>



<a name="1429491"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429491" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429491">(Sep 02 2022 at 00:23)</a>:</h4>
<p>I have restarted zulip twice or so in the last 2 days.</p>



<a name="1429520"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429520" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429520">(Sep 02 2022 at 03:50)</a>:</h4>
<p>I just fixed outgoing email by changing email password, and then restarting zulip.  Bunch of missed emails got sent.<br>
After this, looking at events.log, push notifications were sent to some of our users.  But I didn't receive push notifications.  </p>
<p>Is there easy way to look up user id number (not email or display name)?  I found out I'm user 58 in our org.  I want to know few other people's user id, so I can ask questions.</p>



<a name="1429523"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429523" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429523">(Sep 02 2022 at 04:24)</a>:</h4>
<p>Partial events.log after outgoing email started working.  I can DM you other part with our users emails, if you think it might help.  It's about 1500 lines.</p>
<div class="codehilite"><pre><span></span><code>2022-09-02 01:07:38.516 INFO [zerver.lib.push_notifications] Sent mobile push notifications for user 106 through bouncer: 1 via FCM devices, 0 via APNs devices
2022-09-02 01:07:38.644 INFO [zerver.lib.push_notifications] Sending push notifications to mobile clients for user 114
2022-09-02 01:07:39.765 INFO [zerver.lib.push_notifications] Sent mobile push notifications for user 114 through bouncer: 0 via FCM devices, 2 via APNs devices
2022-09-02 01:07:39.864 INFO [zerver.lib.push_notifications] Sending push notifications to mobile clients for user 117
2022-09-02 01:07:41.094 INFO [zerver.lib.push_notifications] Sent mobile push notifications for user 117 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-09-02 01:07:41.426 INFO [zerver.lib.push_notifications] Sending push notifications to mobile clients for user 121
2022-09-02 01:07:42.164 INFO [] Batch-processing 9 missedmessage_emails events for user 131
2022-09-02 01:07:42.529 INFO [zerver.lib.push_notifications] Sent mobile push notifications for user 121 through bouncer: 0 via FCM devices, 0 via APNs devices
2022-09-02 01:07:42.549 INFO [] Batch-processing 57 missedmessage_emails events for user 8
2022-09-02 01:07:43.145 INFO [] Batch-processing 8 missedmessage_emails events for user 12
2022-09-02 01:07:43.732 INFO [] Unexpected message access failure handling push notifications: 36 2775
2022-09-02 01:07:43.867 INFO [] Unexpected message access failure handling push notifications: 39 2775
</code></pre></div>



<a name="1429524"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429524" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429524">(Sep 02 2022 at 04:30)</a>:</h4>
<p>Last part of events.log.</p>
<div class="codehilite"><pre><span></span><code>2022-09-02 01:10:06.258 ERR  [pika.adapters.utils.io_services_utils] _AsyncBaseTransport._produce() failed, aborting connection: error=ConnectionResetError(104, &#39;Connection reset by peer&#39;); sock=&lt;socket.socket fd=47, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=(&#39;127.0.0.1&#39;, 46068)&gt;; Caller&#39;s stack:
Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 1103, in _on_socket_writable
    self._produce()
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 819, in _produce
    num_bytes_sent = self._sigint_safe_send(self._sock,
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 79, in retry_sigint_wrap
    return func(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 861, in _sigint_safe_send
    return sock.send(data)
ConnectionResetError: [Errno 104] Connection reset by peer
Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 1103, in _on_socket_writable
    self._produce()
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 819, in _produce
    num_bytes_sent = self._sigint_safe_send(self._sock,
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 79, in retry_sigint_wrap
    return func(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 861, in _sigint_safe_send
    return sock.send(data)
ConnectionResetError: [Errno 104] Connection reset by peer
2022-09-02 01:10:06.260 ERR  [pika.adapters.base_connection] connection_lost: StreamLostError: (&quot;Stream connection lost: ConnectionResetError(104, &#39;Connection reset by peer&#39;)&quot;,)
2022-09-02 01:10:06.264 ERR  [pika.adapters.blocking_connection] Unexpected connection close detected: StreamLostError: (&quot;Stream connection lost: ConnectionResetError(104, &#39;Connection reset by peer&#39;)&quot;,)
Exception in thread Thread-15:
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2021-10-02-12-56-04/zerver/lib/queue.py&quot;, line 199, in do_consume
    channel.basic_ack(max_processed, multiple=True)
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/blocking_connection.py&quot;, line 2112, in basic_ack
    self._flush_output()
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/blocking_connection.py&quot;, line 1335, in _flush_output
    self._connection._flush_output(lambda: self.is_closed, *waiters)
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/blocking_connection.py&quot;, line 523, in _flush_output
    raise self._closed_result.value.error
pika.exceptions.StreamLostError: Stream connection lost: ConnectionResetError(104, &#39;Connection reset by peer&#39;)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File &quot;/usr/lib/python3.8/threading.py&quot;, line 932, in _bootstrap_inner
    self.run()
  File &quot;/home/zulip/deployments/2021-10-02-12-56-04/zerver/management/commands/process_queue.py&quot;, line 105, in run
    self.worker.start()
  File &quot;/home/zulip/deployments/2021-10-02-12-56-04/zerver/worker/queue_processors.py&quot;, line 414, in start
    self.q.start_json_consumer(
  File &quot;/home/zulip/deployments/2021-10-02-12-56-04/zerver/lib/queue.py&quot;, line 208, in start_json_consumer
    self.ensure_queue(queue_name, do_consume)
  File &quot;/home/zulip/deployments/2021-10-02-12-56-04/zerver/lib/queue.py&quot;, line 164, in ensure_queue
    callback(self.channel)
  File &quot;/home/zulip/deployments/2021-10-02-12-56-04/zerver/lib/queue.py&quot;, line 201, in do_consume
    channel.basic_nack(max_processed, multiple=True)
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/blocking_connection.py&quot;, line 2133, in basic_nack
    self._impl.basic_nack(
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/channel.py&quot;, line 401, in basic_nack
    self._raise_if_not_open()
  File &quot;/srv/zulip-venv-cache/c3a4ec5672d9d2ec2fd8932c1bee310def9e4606/zulip-py3-venv/lib/python3.8/site-packages/pika/channel.py&quot;, line 1393, in _raise_if_not_open
    raise exceptions.ChannelWrongStateError(&#39;Channel is closed.&#39;)
pika.exceptions.ChannelWrongStateError: Channel is closed.
</code></pre></div>



<a name="1429870"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429870" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429870">(Sep 02 2022 at 22:28)</a>:</h4>
<p>User IDs are displayed in the UI in 5.0 and above, I think.</p>



<a name="1429873"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429873" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429873">(Sep 02 2022 at 22:28)</a>:</h4>
<p>Can you check how many items remain in your RabbitMQ queues?</p>



<a name="1429954"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1429954" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1429954">(Sep 03 2022 at 00:39)</a>:</h4>
<div class="codehilite"><pre><span></span><code>zone@chat:~$ sudo rabbitmqctl list_queues
[sudo] password for zone:
Timeout: 60.0 seconds ...
Listing queues for vhost / ...
name    messages
user_presence   372311
embedded_bots   0
deferred_work   0
outgoing_webhooks   0
email_mirror    0
email_senders   213
user_activity_interval  131
invites 0
digest_emails   0
error_reports   1
missedmessage_mobile_notifications  2331
missedmessage_emails    32
user_activity   874747
notify_tornado  0
embed_links 0
</code></pre></div>



<a name="1430888"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1430888" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1430888">(Sep 06 2022 at 19:19)</a>:</h4>
<p><span class="user-mention" data-user-id="21024">@Naomi</span> sorry for the delayed follow-up, I was travelling over the weekend. Those numbers should all be 0 in a healthy server.</p>



<a name="1430889"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1430889" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1430889">(Sep 06 2022 at 19:20)</a>:</h4>
<p>I think it's reasonably likely your actual problem is that your server has insufficient RAM for the usage level; I'd consider upgrading the RAM on the system to 8GB or more and then running <code>zulip-puppet-apply</code> doing so will configure Zulip to use a better mechanism for queue processors that requires &gt;4GB of RAM.</p>



<a name="1431222"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1431222" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1431222">(Sep 07 2022 at 02:40)</a>:</h4>
<p>Oh... we are on 2GB RAM server.  <br>
Do we really have to upgrade to 8GB RAM?<br>
Our  zulip is not so busy and currently we have 52 users only.  </p>
<p>Here's our memory usage graph from DigitalOcean over 14 days.<br>
<a href="/user_uploads/2/f0/W1s2UPADaQfZsgX-_GvS0bOh/Screen-Shot-2022-09-07-at-10.38.38.png">Screen-Shot-2022-09-07-at-10.38.38.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/2/f0/W1s2UPADaQfZsgX-_GvS0bOh/Screen-Shot-2022-09-07-at-10.38.38.png" title="Screen-Shot-2022-09-07-at-10.38.38.png"><img src="/user_uploads/2/f0/W1s2UPADaQfZsgX-_GvS0bOh/Screen-Shot-2022-09-07-at-10.38.38.png"></a></div><p>I have swap enabled.</p>
<div class="codehilite"><pre><span></span><code>zone@chat:~$ free -h
              total        used        free      shared  buff/cache   available
Mem:          1.9Gi       1.0Gi       182Mi        46Mi       758Mi       731Mi
Swap:         2.0Gi       1.4Gi       662Mi
</code></pre></div>



<a name="1431457"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1431457" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1431457">(Sep 07 2022 at 17:23)</a>:</h4>
<p><span class="user-mention" data-user-id="21024">@Naomi</span> it's likely 4GB is sufficient. Zulip runs its queue workers in a different way with 2GB of RAM than 4GB+, and I think given the issues you're seeing, it'll be far easier to debug with 4GB+, and will also mean whatever problem you're having only affects the one queue with the issue, not potentially all of them.</p>



<a name="1431956"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1431956" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1431956">(Sep 08 2022 at 03:34)</a>:</h4>
<p>If RAM requirement is indeed the issue, then <a href="https://zulip.readthedocs.io/en/latest/production/requirements.html">https://zulip.readthedocs.io/en/latest/production/requirements.html</a> needs to be updated to elaborate the issue for push notifications.</p>



<a name="1431969"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1431969" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1431969">(Sep 08 2022 at 05:26)</a>:</h4>
<p>Should I upgrade zulip first or RAM first?  <br>
Can I  output anything useful along the steps?  I can follow instruction if it helps.</p>
<p>Hi, Rein!</p>



<a name="1431986"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1431986" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1431986">(Sep 08 2022 at 06:28)</a>:</h4>
<p>I think it is faster to upgrade the RAM first, and so we can immediately see if it fixes the issue.</p>



<a name="1431998"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1431998" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1431998">(Sep 08 2022 at 06:38)</a>:</h4>
<p>OK.  It'll be a little while.</p>



<a name="1432543"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1432543" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1432543">(Sep 08 2022 at 20:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="2328">Rein Zustand</span> <a href="#narrow/stream/31-production-help/topic/push.20notifications/near/1431956">said</a>:</p>
<blockquote>
<p>If RAM requirement is indeed the issue, then <a href="https://zulip.readthedocs.io/en/latest/production/requirements.html">https://zulip.readthedocs.io/en/latest/production/requirements.html</a> needs to be updated to elaborate the issue for push notifications.</p>
</blockquote>
<p>It's definitely not the case that more RAM is required for push notifications. More RAM is already recommended for the size of the userbase on this particular system. I think it's likely that, as with the first issue that <span class="user-mention silent" data-user-id="21024">Naomi</span> tracked down (broken email sending configuration), there's some other problem here, but increasing RAM as we recommend will greatly simplify debugging anyway, so might as well do that first.</p>



<a name="1432721"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1432721" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1432721">(Sep 09 2022 at 03:45)</a>:</h4>
<p>I just upgraded to 4GB RAM.  Still zulip 5.0.</p>
<div class="codehilite"><pre><span></span><code>zone@chat:~$ sudo rabbitmqctl list_queues
Timeout: 60.0 seconds ...
Listing queues for vhost / ...
name    messages
user_presence   382982
embedded_bots   0
deferred_work   0
outgoing_webhooks   0
email_mirror    0
email_senders   0
user_activity_interval  0
invites 0
digest_emails   0
error_reports   0
missedmessage_mobile_notifications  1839
missedmessage_emails    0
user_activity   734995
notify_tornado  0
embed_links 0
</code></pre></div>



<a name="1432723"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1432723" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1432723">(Sep 09 2022 at 04:00)</a>:</h4>
<p>I just received push notification after 4 month!</p>
<div class="codehilite"><pre><span></span><code>zone@chat:~$ sudo rabbitmqctl list_queues
[sudo] password for zone:
Timeout: 60.0 seconds ...
Listing queues for vhost / ...
name    messages
user_presence   262410
embedded_bots   0
deferred_work   0
outgoing_webhooks   0
email_mirror    0
email_senders   0
user_activity_interval  0
invites 0
digest_emails   0
error_reports   0
missedmessage_mobile_notifications  0
missedmessage_emails    0
user_activity   1
notify_tornado  0
embed_links 0
</code></pre></div>



<a name="1432728"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1432728" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1432728">(Sep 09 2022 at 04:06)</a>:</h4>
<p>Anything to check before I upgrade to zulip 5.6?</p>



<a name="1432730"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1432730" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1432730">(Sep 09 2022 at 04:20)</a>:</h4>
<p>Maybe we should wait for a day and see how the server goes during the time? Also, <span class="user-mention silent" data-user-id="7">Tim Abbott</span> might want some logging details before the version upgrade (so that we don't have changes piled on top of changes, that it is harder to keep track of the causes).</p>



<a name="1432733"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1432733" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1432733">(Sep 09 2022 at 04:33)</a>:</h4>
<p>It looks like the queues are all clearing. I don't see any reason not to upgrade at this point.</p>



<a name="1432742"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1432742" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1432742">(Sep 09 2022 at 04:41)</a>:</h4>
<p>I noticed another thing.  Users active state had been unchanged from <code>not active</code> until the RAM upgrade.  I'd been thinking everyone turned privacy setting to not to show, but I see some of them being active, idle and last active time.</p>



<a name="1432743"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1432743" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1432743">(Sep 09 2022 at 04:44)</a>:</h4>
<p>Yeah there are a lot of things that are broken if queue processors are not running properly.</p>



<a name="1438832"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1438832" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1438832">(Sep 21 2022 at 14:49)</a>:</h4>
<p>Since upgrading the RAM is the solution here, maybe the symptoms described in this thread should be put in <a href="https://zulip.readthedocs.io/en/latest/production/requirements.html">https://zulip.readthedocs.io/en/latest/production/requirements.html</a> for easier troubleshooting?</p>



<a name="1438917"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1438917" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1438917">(Sep 21 2022 at 18:18)</a>:</h4>
<p>I don't think so. What we should do is add some guidance on <code>rabbitmqctl status</code> here: <a href="https://zulip.readthedocs.io/en/latest/production/troubleshooting.html">https://zulip.readthedocs.io/en/latest/production/troubleshooting.html</a></p>



<a name="1438920"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1438920" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1438920">(Sep 21 2022 at 18:18)</a>:</h4>
<p>I don't think someone who's having issues should be expected to go reread the system requirements page; the troubleshooting page is the place to go.</p>



<a name="1438921"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1438921" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1438921">(Sep 21 2022 at 18:19)</a>:</h4>
<p>As a sidenote, does our 500 page for self-hosted servers have a link to that page?</p>



<a name="1438922"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1438922" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1438922">(Sep 21 2022 at 18:19)</a>:</h4>
<p>I feel like that could be a fairly meaningful self-documentation feature.</p>



<a name="1439166"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439166" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439166">(Sep 22 2022 at 01:46)</a>:</h4>
<p>The requirements doc actually says this</p>
<blockquote>
<p>RAM: We recommended more RAM for larger installations:<br>
- With 25+ daily active users, 4 GB of RAM.<br>
- With 100+ daily active users, 8 GB of RAM.</p>
</blockquote>
<p>Also, I don't know how common it is for an organization to have enough RAM in the beginning, only for the active users to grow beyond the limit. What if there is a script that can be used to diagnose the health of the RAM load of the server? There is already a monitoring process for storage it seems.</p>



<a name="1439248"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439248" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Naomi <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439248">(Sep 22 2022 at 07:45)</a>:</h4>
<p>We have 52 users in our org, and daily active users are less than 20 for most of days.  Since the upgrade of zulip to 6.0, memory usage stays around 80 to 95% on a 4GB RAM server.  If we require 4GB RAM in our org, shouldn't minimum requirement for a zulip server 4GB RAM instead of 2GB?</p>



<a name="1439249"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439249" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439249">(Sep 22 2022 at 07:51)</a>:</h4>
<p>Almost every system will use more memory if it’s available, to improve performance with larger caches, for example. The way to check whether it will run with 2 GB is to try running it with 2 GB.</p>



<a name="1439346"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439346" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439346">(Sep 22 2022 at 15:50)</a>:</h4>
<p>Exactly. To be clear about the specific patterns for Zulip here:</p>
<ul>
<li>Zulip allocates more memory to <code>memcached</code> and the database on systems that have more total memory; this improves performance.</li>
<li>Zulip runs its queue processors in multithreaded mode, which requires less memory but is also much lower throughput, and has less isolation between different queues, on systems with less than 4GB or so of RAM.</li>
<li>This specific system had a set of problems, such as having broken outgoing email configuration, that caused some queues to backlog; this resulted in a problem for other queues, like the one that sends push notifications because of the isolation limitations of the multithreaded mode.</li>
</ul>



<a name="1439348"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439348" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439348">(Sep 22 2022 at 15:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/push.20notifications/near/1438921">said</a>:</p>
<blockquote>
<p>As a sidenote, does our 500 page for self-hosted servers have a link to that page?</p>
</blockquote>
<p>I'd like to return to the 500 page as a place we could improve things here; currently it's the same for Zulip Cloud and self-hosted servers:</p>
<p><a href="/user_uploads/2/94/Pi0xyn9f4Ps1jnwBAvWL3j-N/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/94/Pi0xyn9f4Ps1jnwBAvWL3j-N/image.png" title="image.png"><img src="/user_uploads/2/94/Pi0xyn9f4Ps1jnwBAvWL3j-N/image.png"></a></div>



<a name="1439349"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439349" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439349">(Sep 22 2022 at 15:55)</a>:</h4>
<p><span class="user-mention" data-user-id="19257">@Alya Abbott</span> let's do a project on tweaking that page's content; we should have its text be conditional on whether the server is self-hosted, and for that case, make sure it links to <a href="https://zulip.readthedocs.io/en/stable/production/troubleshooting.html">https://zulip.readthedocs.io/en/stable/production/troubleshooting.html</a>.</p>



<a name="1439350"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439350" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alya Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439350">(Sep 22 2022 at 16:05)</a>:</h4>
<p>Maybe something like this?</p>
<blockquote>
<p>Your Zulip chat cannot be loaded because the server is experiencing technical difficulties. This page will reload automatically when service is restored.</p>
<p>In the meantime, you can <a href="mailto:desdemona+admin@zulip.com">contact your server administrator</a> for support. If you administer this server, you may want to check out <a href="https://zulip.readthedocs.io/en/latest/production/troubleshooting.html">Zulip’s troubleshooting guide</a>. </p>
</blockquote>



<a name="1439351"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439351" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439351">(Sep 22 2022 at 16:07)</a>:</h4>
<p>Yeah that sounds pretty good for the self-hosted case. I think we probably want different text for Zulip Cloud.</p>



<a name="1439381"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439381" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alya Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439381">(Sep 22 2022 at 16:50)</a>:</h4>
<p>Ah, yeah, I didn't realize Zulip Cloud users see the same page. Let me take a pass at that.</p>



<a name="1439384"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439384" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alya Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439384">(Sep 22 2022 at 16:54)</a>:</h4>
<p>I think the first paragraph can be the same.</p>
<p>Ideally, we'd direct users to a status page, but we would need to implement that first. Is it useful for folks to contact support, or would we already know what's going on?</p>



<a name="1439392"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439392" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439392">(Sep 22 2022 at 17:04)</a>:</h4>
<p>It's useful to contact support. Obviously in a major outage, we'll be immediately aware, but sometimes there's an issue that affects just one user, and we're aware via exception monitoring but might not know what the user's doing to trigger the issue. In those cases, it can helpful to talk to that user if they're willing to understand what they're doing and reproduce. And in any case, I think it gives comfort to have a clear path forward.</p>



<a name="1439579"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439579" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alya Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439579">(Sep 22 2022 at 19:24)</a>:</h4>
<p>Here's a neutral formulation:</p>
<blockquote>
<p>In the meantime, you can contact Zulip support .</p>
</blockquote>



<a name="1439689"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1439689" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rein Zustand <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1439689">(Sep 22 2022 at 22:05)</a>:</h4>
<p>Putting the troubleshooting page upfront in the 500 page still doesn't address the fact that the piled up RabbitMQ queues symptom and its possible causes is not documented in the troubleshooting page.</p>



<a name="1441315"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/push%20notifications/near/1441315" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alya Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/push.20notifications.html#1441315">(Sep 26 2022 at 20:55)</a>:</h4>
<p>I filed <strong>Update text on 500 error page</strong> <a href="https://github.com/zulip/zulip/pull/23063">#23063</a>. (Someone else will need to address <span class="user-mention silent" data-user-id="2328">Rein Zustand</span> 's last point.)</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>