<html>
<head><meta charset="utf-8"><title>Upgrade to 5.4 from 5.3 fails · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html">Upgrade to 5.4 from 5.3 fails</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1405799"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1405799" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Harris <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1405799">(Jul 16 2022 at 09:16)</a>:</h4>
<p>Just tried today. Here's the resulting error output:</p>
<p>root@TRG-Zulip:~# curl -fLO <a href="https://download.zulip.com/server/zulip-server-latest.tar.gz">https://download.zulip.com/server/zulip-server-latest.tar.gz</a><br>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<br>
                                 Dload  Upload   Total   Spent    Left  Speed<br>
100 89.9M  100 89.9M    0     0  39.0M      0  0:00:02  0:00:02 --:--:-- 39.0M<br>
root@TRG-Zulip:~# /home/zulip/deployments/current/scripts/upgrade-zulip zulip-server-latest.tar.gz<br>
2022-07-16 09:13:55,215 upgrade-zulip: Archiving the tarball under /home/zulip/archives<br>
2022-07-16 09:13:55,548 upgrade-zulip: Unpacking the tarball<br>
2022-07-16 09:13:57,225 upgrade-zulip-stage-2: Upgrading system packages...<br>
Hit:2 <a href="http://mirrors.digitalocean.com/ubuntu">http://mirrors.digitalocean.com/ubuntu</a> focal InRelease<br>
Hit:3 <a href="https://repos.insights.digitalocean.com/apt/do-agent">https://repos.insights.digitalocean.com/apt/do-agent</a> main InRelease<br>
Hit:4 <a href="https://repos-droplet.digitalocean.com/apt/droplet-agent">https://repos-droplet.digitalocean.com/apt/droplet-agent</a> main InRelease<br>
Hit:5 <a href="http://mirrors.digitalocean.com/ubuntu">http://mirrors.digitalocean.com/ubuntu</a> focal-updates InRelease<br>
Hit:6 <a href="http://mirrors.digitalocean.com/ubuntu">http://mirrors.digitalocean.com/ubuntu</a> focal-backports InRelease<br>
Hit:7 <a href="http://ppa.launchpad.net/groonga/ppa/ubuntu">http://ppa.launchpad.net/groonga/ppa/ubuntu</a> focal InRelease<br>
Hit:8 <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> focal-security InRelease<br>
Hit:9 <a href="http://apt.postgresql.org/pub/repos/apt">http://apt.postgresql.org/pub/repos/apt</a> focal-pgdg InRelease<br>
Hit:1 <a href="https://apt-archive.postgresql.org/pub/repos/apt">https://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive InRelease<br>
Hit:10 <a href="https://packages.groonga.org/ubuntu">https://packages.groonga.org/ubuntu</a> bionic InRelease<br>
Reading package lists...<br>
Reading package lists...<br>
Building dependency tree...<br>
Reading state information...<br>
Calculating upgrade...<br>
The following packages were automatically installed and are no longer required:<br>
  libicu60 libllvm10 libllvm6.0 libopts25 libreadline7 libtinfo5<br>
  postgresql-client-12<br>
Use 'apt autoremove' to remove them.<br>
The following NEW packages will be installed:<br>
  libllvm9<br>
The following packages will be upgraded:<br>
  apt apt-transport-https apt-utils isc-dhcp-client isc-dhcp-common kmod<br>
  libapt-pkg6.0 libc-bin libc-dev-bin libc6 libc6-dev libkeyutils1 libkmod2<br>
  libmbim-glib4 libmbim-proxy libmm-glib0 libnss-systemd libpam-systemd<br>
  libpq-dev libpq5 libqmi-glib5 libqmi-proxy libsystemd0 libudev1<br>
  linux-firmware locales locales-all login openssh-client openssh-server<br>
  openssh-sftp-server passwd postgresql-client postgresql-client-common<br>
  postgresql-common sbsigntool snapd systemd systemd-sysv<br>
  ubuntu-advantage-tools udev unattended-upgrades update-notifier-common<br>
The following packages will be DOWNGRADED:<br>
  postgresql-13<br>
43 upgraded, 1 newly installed, 1 downgraded, 0 to remove and 0 not upgraded.<br>
E: Packages were downgraded and -y was used without --allow-downgrades.<br>
Traceback (most recent call last):<br>
  File "/home/zulip/deployments/2022-07-16-09-13-55/scripts/lib/upgrade-zulip-stage-2", line 231, in &lt;module&gt;<br>
    subprocess.check_call(["apt-get", "-y", "--with-new-pkgs", "upgrade"])<br>
  File "/usr/lib/python3.8/subprocess.py", line 364, in check_call<br>
    raise CalledProcessError(retcode, cmd)<br>
subprocess.CalledProcessError: Command '['apt-get', '-y', '--with-new-pkgs', 'upgrade']' returned non-zero exit status 100.</p>



<a name="1406410"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1406410" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1406410">(Jul 18 2022 at 19:50)</a>:</h4>
<p><span class="user-mention" data-user-id="18378">@Lee Harris</span> it looks like the issue here is something to do with your system's <code>apt</code> situation -- <code>apt upgrade</code> is failing. You should debug that, which is likely unrelated to Zulip, and then the upgrade tool should run fine.</p>



<a name="1406417"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1406417" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1406417">(Jul 18 2022 at 19:54)</a>:</h4>
<div class="codehilite"><pre><span></span><code>The following packages will be DOWNGRADED:
postgresql-13
</code></pre></div>
<p>This seems potentially related to the pin that we installed related to postgres -- <a href="https://github.com/zulip/zulip/commit/472e216cecc4538a57f2e60ee6629f57fdda6539">472e216cecc4538a57f2e60ee6629f57fdda6539</a> / <a href="https://github.com/zulip/zulip/commit/9c8d2b7be39314b41f04a1e1356942afe21ab223">9c8d2b7be39314b41f04a1e1356942afe21ab223</a>.</p>
<p><span class="user-mention" data-user-id="18378">@Lee Harris</span>: Can you show <code>apt-cache policy postgresql-13</code> ?</p>



<a name="1406420"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1406420" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1406420">(Jul 18 2022 at 19:58)</a>:</h4>
<p>We run <code>apt-get upgrade</code> before we run puppet, so the apt <code>zulip.pref</code> file is still in place then.  I'm not sure how you could get that file to be in place <em>without</em> having run the <code>apt-get upgrade --allow-downgrades</code> after puppet that dropped into place, though.</p>



<a name="1406803"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1406803" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Harris <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1406803">(Jul 19 2022 at 09:33)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="12178">@Alex Vandiver</span> <span class="user-mention" data-user-id="7">@Tim Abbott</span> </p>
<p>Here's what I have:</p>
<p>root@TRG-Zulip:~# apt-cache policy postgresql-13<br>
postgresql-13:<br>
  Installed: 13.6-1.pgdg20.04+1+b1<br>
  Candidate: 13.5-2.pgdg20.04+1<br>
  Version table:<br>
     13.7-1.pgdg20.04+1 500<br>
        500 <a href="http://apt.postgresql.org/pub/repos/apt">http://apt.postgresql.org/pub/repos/apt</a> focal-pgdg/main amd64 Packages<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
 *** 13.6-1.pgdg20.04+1+b1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
        100 /var/lib/dpkg/status<br>
     13.6-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13.5-2.pgdg20.04+1 1000<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13.5-1.pgdg20.04+1 1000<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13.4-4.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13.4-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13.3-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13.2-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13.1-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13.0-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13~rc1-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13~beta3-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13~beta2-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages<br>
     13~beta1-1.pgdg20.04+1 500<br>
        500 <a href="http://apt-archive.postgresql.org/pub/repos/apt">http://apt-archive.postgresql.org/pub/repos/apt</a> focal-pgdg-archive/main amd64 Packages</p>



<a name="1407250"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1407250" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1407250">(Jul 20 2022 at 00:09)</a>:</h4>
<p><span class="user-mention" data-user-id="18378">@Lee Harris</span>: OK, so the question is how you got into the state with the <code>zulip.pref</code> pin in place, but without <em>currently</em> having that version installed.</p>
<p>Was this initially installed as 5.4, or did you upgrade from something else to 5.4?</p>
<p><span class="user-mention" data-user-id="699">@Anders Kaseorg</span>, any guesses?</p>



<a name="1407261"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1407261" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1407261">(Jul 20 2022 at 00:23)</a>:</h4>
<p>Nope. The contents of <code>/var/log/apt/history.log</code>, <code>/var/log/zulip/install.log</code>, and <code>/var/log/zulip/upgrade.log</code> might have some clues.</p>



<a name="1407467"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1407467" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Harris <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1407467">(Jul 20 2022 at 11:20)</a>:</h4>
<p>This was originally a 4.7(?) installation, upgraded to 5.3 and now attempting to get to 5.4. All installed on a clean Digital Ocean droplet with nothing else whatsoever in place. Droplet was provisioned just for Zulip. Logs to follow…</p>



<a name="1407468"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1407468" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lee Harris <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1407468">(Jul 20 2022 at 11:32)</a>:</h4>
<p>following an apt upgrade, the 5.4 upgrade process worked fine.</p>



<a name="1413674"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrade%20to%205.4%20from%205.3%20fails/near/1413674" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrea Soc <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrade.20to.205.2E4.20from.205.2E3.20fails.html#1413674">(Aug 01 2022 at 13:46)</a>:</h4>
<p>same problel, solved <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>