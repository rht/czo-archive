<html>
<head><meta charset="utf-8"><title>500 Error : Cannot deactivate users after upgrade to Zulip 7 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/500.20Error.20.3A.20Cannot.20deactivate.20users.20after.20upgrade.20to.20Zulip.207.html">500 Error : Cannot deactivate users after upgrade to Zulip 7</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1607149"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/500%20Error%20%3A%20Cannot%20deactivate%20users%20after%20upgrade%20to%20Zulip%207/near/1607149" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> VS <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/500.20Error.20.3A.20Cannot.20deactivate.20users.20after.20upgrade.20to.20Zulip.207.html#1607149">(Jul 10 2023 at 18:38)</a>:</h4>
<p>Hello,</p>
<p>I am unable to deactivate users and view invited users after upgrading to Zulip 7. Here is the error that I'm getting:</p>
<div class="codehilite"><pre><span></span><code>2023-07-10 18:32:21.847 ERR  [django.request] Internal Server Error: /json/invites
2023-07-10 18:32:50.153 ERR  [zerver.middleware.json_error_handler] Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py&quot;, line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/lib/rest.py&quot;, line 39, in _wrapped_view_func
    response = view_func(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/csrf.py&quot;, line 56, in wrapper_view
    return view_func(*args, **kwargs)
  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/lib/rest.py&quot;, line 203, in rest_dispatch
    return target_function(request, **kwargs)
  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/utils/decorators.py&quot;, line 134, in _wrapper_view
    response = view_func(request, *args, **kwargs)
  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/decorator.py&quot;, line 889, in _wrapped_view_func
    return view_func(request, user_profile, *args, **kwargs)
  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/decorator.py&quot;, line 644, in _wrapped_view_func
    return view_func(request, user_profile, *args, **kwargs)
  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/views/invite.py&quot;, line 112, in get_user_invites
    all_users = do_get_invites_controlled_by_user(user_profile)
  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/actions/invites.py&quot;, line 358, in do_get_invites_controlled_by_user
    expiry_date=get_invitation_expiry_date(invitee.confirmation.get()),
  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/manager.py&quot;, line 87, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/query.py&quot;, line 637, in get
    raise self.model.DoesNotExist(
confirmation.models.Confirmation.DoesNotExist: Confirmation matching query does not exist.
</code></pre></div>



<a name="1607151"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/500%20Error%20%3A%20Cannot%20deactivate%20users%20after%20upgrade%20to%20Zulip%207/near/1607151" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/500.20Error.20.3A.20Cannot.20deactivate.20users.20after.20upgrade.20to.20Zulip.207.html#1607151">(Jul 10 2023 at 18:42)</a>:</h4>
<p>What version were you upgrading from?</p>



<a name="1607155"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/500%20Error%20%3A%20Cannot%20deactivate%20users%20after%20upgrade%20to%20Zulip%207/near/1607155" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/500.20Error.20.3A.20Cannot.20deactivate.20users.20after.20upgrade.20to.20Zulip.207.html#1607155">(Jul 10 2023 at 18:44)</a>:</h4>
<p>Can you run, as the <code>zulip</code> user:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/deployments/current
./manage.py<span class="w"> </span>dbshell
</code></pre></div>
<div class="codehilite" data-code-language="PostgreSQL SQL dialect"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">zerver_preregistrationuser</span><span class="mf">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">invited_at</span>
<span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">zerver_preregistrationuser</span>
<span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">confirmation_confirmation</span><span class="w"> </span><span class="k">on</span>
<span class="w">  </span><span class="n">content_type_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">django_content_type</span>
<span class="w">                      </span><span class="k">where</span><span class="w"> </span><span class="n">app_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'zerver'</span>
<span class="w">                      </span><span class="k">and</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'preregistrationuser'</span><span class="p">)</span>
<span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zerver_preregistrationuser</span><span class="mf">.</span><span class="n">id</span>
<span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">confirmation_confirmation</span><span class="mf">.</span><span class="n">id</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span>
<span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">invited_at</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">'1 hour'</span>
<span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mf">50</span><span class="p">;</span>
</code></pre></div>



<a name="1607157"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/500%20Error%20%3A%20Cannot%20deactivate%20users%20after%20upgrade%20to%20Zulip%207/near/1607157" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> VS <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/500.20Error.20.3A.20Cannot.20deactivate.20users.20after.20upgrade.20to.20Zulip.207.html#1607157">(Jul 10 2023 at 18:48)</a>:</h4>
<div class="codehilite"><pre><span></span><code> id  |          invited_at
-----+-------------------------------
  99 | 2022-06-30 17:09:09.784337+00
 180 | 2022-08-17 11:02:37.090769+00
 116 | 2022-07-14 10:56:17.196458+00
(3 rows)
</code></pre></div>



<a name="1607163"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/500%20Error%20%3A%20Cannot%20deactivate%20users%20after%20upgrade%20to%20Zulip%207/near/1607163" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/500.20Error.20.3A.20Cannot.20deactivate.20users.20after.20upgrade.20to.20Zulip.207.html#1607163">(Jul 10 2023 at 18:58)</a>:</h4>
<p>OK, those are old enough that we're not going to be able to get anything useful out of the access logs as to what caused this.</p>
<p>This is <a href="https://github.com/zulip/zulip/pull/21306">#21306</a> / <a href="https://github.com/zulip/zulip/pull/22025">#22025</a>.</p>



<a name="1607168"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/500%20Error%20%3A%20Cannot%20deactivate%20users%20after%20upgrade%20to%20Zulip%207/near/1607168" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/500.20Error.20.3A.20Cannot.20deactivate.20users.20after.20upgrade.20to.20Zulip.207.html#1607168">(Jul 10 2023 at 18:59)</a>:</h4>
<p>Your fix is, at the database prompt you're at:</p>
<div class="codehilite" data-code-language="PostgreSQL SQL dialect"><pre><span></span><code><span class="k">start</span><span class="w"> </span><span class="k">transaction</span><span class="p">;</span>
<span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">zerver_preregistrationuser_streams</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">preregistrationuser_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mf">99</span><span class="p">,</span><span class="w"> </span><span class="mf">116</span><span class="p">,</span><span class="w"> </span><span class="mf">180</span><span class="p">);</span>
<span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">zerver_preregistrationuser</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mf">99</span><span class="p">,</span><span class="w"> </span><span class="mf">116</span><span class="p">,</span><span class="w"> </span><span class="mf">180</span><span class="p">);</span>
<span class="k">commit</span><span class="p">;</span>
</code></pre></div>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>