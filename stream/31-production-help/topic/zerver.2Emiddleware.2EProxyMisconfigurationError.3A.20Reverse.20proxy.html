<html>
<head><meta charset="utf-8"><title>zerver.middleware.ProxyMisconfigurationError: Reverse proxy · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html">zerver.middleware.ProxyMisconfigurationError: Reverse proxy</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1604531"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604531" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604531">(Jul 05 2023 at 21:53)</a>:</h4>
<p>zerver.middleware.ProxyMisconfigurationError: Reverse proxy misconfiguration: No X-Forwarded-Proto header sent from trusted proxy 10.206.70.1</p>
<p>Hello.<br>
I was updating from 5.5. to 7.2 right now and I've encoutered following issue:</p>
<div class="codehilite"><pre><span></span><code>zerver.middleware.ProxyMisconfigurationError: Reverse proxy misconfiguration: No X-Forwarded-Proto header sent from trusted proxy 10.206.70.1
</code></pre></div>
<p>Does anyone have any idea how to proceed in this case?<br>
Cheers,</p>



<a name="1604557"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604557" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604557">(Jul 05 2023 at 22:01)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="9" href="/#narrow/stream/9-issues/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy">#issues &gt; zerver.middleware.ProxyMisconfigurationError: Reverse proxy</a> by <span class="user-mention silent" data-user-id="7">Tim Abbott</span>.</p>



<a name="1604559"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604559" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604559">(Jul 05 2023 at 22:02)</a>:</h4>
<p><span class="user-mention" data-user-id="27327">@Szymon Niemiec</span> see <a href="https://zulip.readthedocs.io/en/latest/production/deployment.html#configuring-zulip-to-trust-proxies">https://zulip.readthedocs.io/en/latest/production/deployment.html#configuring-zulip-to-trust-proxies</a>; I think you missed the second-to-last step in <a href="https://zulip.readthedocs.io/en/latest/overview/changelog.html#upgrade-notes-for-7-0">https://zulip.readthedocs.io/en/latest/overview/changelog.html#upgrade-notes-for-7-0</a>.</p>



<a name="1604585"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604585" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604585">(Jul 05 2023 at 22:46)</a>:</h4>
<p>Hello, thanks for the guidance.<br>
I've put in the reverse proxy IP into the config file, but i still see the 500 error.</p>



<a name="1604587"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604587" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604587">(Jul 05 2023 at 22:48)</a>:</h4>
<p><code>/var/log/nginx/error.log</code> shows prints like this:</p>
<div class="codehilite"><pre><span></span><code>error] 2734#2734: *35 connect() failed (111: Connection refused) while connecting to upstream, client: 10.206.70.1, server: , request: &quot;GET /json/events?dont_block=true&amp;queue_id=1688277641%3A5&amp;last_event_id=8596&amp;client_gravatar=true&amp;slim_presence=true HTTP/1.1&quot;, upstream: &quot;http://127.0.0.1:9800/json/events?dont_block=true&amp;queue_id=1688277641%3A5&amp;last_event_id=8596&amp;client_gravatar=true&amp;slim_presence=true
</code></pre></div>



<a name="1604590"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604590" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604590">(Jul 05 2023 at 22:52)</a>:</h4>
<p>I'd double-check your work; is 10.206.70.1 the proxy's IP and is that in the <code>loadbalancer_ips</code> configuration? And did you run <code>zulip-puppet-apply</code> after editing <code>zulip.conf</code>?</p>



<a name="1604603"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604603" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604603">(Jul 05 2023 at 23:04)</a>:</h4>
<p>Hello,<br>
It works!!!<br>
The problem I had is that my reverse proxy (nginx) was not setting X-Forwarded-Proto header, and that seems to be required.<br>
Sorry for the imprecise messages.<br>
Thank you for your helpfulness.<br>
BR,<br>
Szymek.</p>



<a name="1604607"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604607" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604607">(Jul 05 2023 at 23:08)</a>:</h4>
<p>The problem I had is that I was looking at <code>/var/log/nginx/error.log</code> whereas I should've been looking at  <code>/var/log/zulip/django.log</code></p>



<a name="1604609"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604609" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604609">(Jul 05 2023 at 23:10)</a>:</h4>
<p>In <code>django.log</code> file there was important hint <code>No X-Forwarded-Proto header sent from trusted proxy ....</code></p>



<a name="1604612"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604612" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604612">(Jul 05 2023 at 23:11)</a>:</h4>
<p>After reading this log I've added <code>proxy_set_header X-Forwarded-Proto https</code></p>



<a name="1604613"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604613" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604613">(Jul 05 2023 at 23:12)</a>:</h4>
<p>To my nginx configuration in front of zulip container</p>



<a name="1604614"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604614" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604614">(Jul 05 2023 at 23:12)</a>:</h4>
<p>And it finally worked</p>



<a name="1604616"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604616" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604616">(Jul 05 2023 at 23:13)</a>:</h4>
<p>So yeah, thank you again for guiding me</p>



<a name="1604623"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604623" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604623">(Jul 05 2023 at 23:20)</a>:</h4>
<p>Hm, we may need to increase the logging severity, then.  I thought I linked from those messages to the relevant docs page, too?</p>



<a name="1604629"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/zerver.middleware.ProxyMisconfigurationError%3A%20Reverse%20proxy/near/1604629" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Szymon Niemiec <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/zerver.2Emiddleware.2EProxyMisconfigurationError.3A.20Reverse.20proxy.html#1604629">(Jul 05 2023 at 23:29)</a>:</h4>
<p>Yeah, you did. I don't think there is anything to improve on your side. I think it's my carelessness in that i didn't realize that I should set not only <code>X-Forwarded-For</code> but also <code>X-Forwarded-Proto</code>. When you try to read quickly these two strings kinda blend into one. So yeah I should've be more careful in my reading.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>