<html>
<head><meta charset="utf-8"><title>✔ presence migration upgrading 6.2 to 7.0 · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html">✔ presence migration upgrading 6.2 to 7.0</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1583923"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1583923" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antti Kanes <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1583923">(Jun 02 2023 at 04:43)</a>:</h4>
<p>Yes I'm having the exact same error and ended up trying to bring the surroundings up to speed as your documentation suggests using Postresql 15 so I figured the constraint issue could've been related to me running 14 - and that's when problems started stackpiling. I was running Zulip 6.2 with pgroonga installed before.</p>



<a name="1583924"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1583924" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antti Kanes <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1583924">(Jun 02 2023 at 04:44)</a>:</h4>
<p>So as a note unrelated to this the database upgrade script is really dangerous to use as it just goes ahead and drops pg clusters</p>



<a name="1583925"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1583925" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antti Kanes <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1583925">(Jun 02 2023 at 04:44)</a>:</h4>
<p>Which might be worthwile to mention in the documentation at least :)</p>



<a name="1583927"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1583927" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antti Kanes <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1583927">(Jun 02 2023 at 04:45)</a>:</h4>
<p>Also restoring the backup done by the manage backup scripts isn't straightforward after this since the zulip role goes bye bye as well.</p>



<a name="1583928"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1583928" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antti Kanes <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1583928">(Jun 02 2023 at 04:48)</a>:</h4>
<p>We have a long upgrade path behind going back to at least version 1.8</p>



<a name="1583992"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1583992" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1583992">(Jun 02 2023 at 05:59)</a>:</h4>
<p>I also had 1.6 or 1.8 installed initially (I don't remember exactly)</p>



<a name="1584018"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584018" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584018">(Jun 02 2023 at 06:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/presence.20migration.20upgrading.206.2E2.20to.207.2E0/near/1583327">said</a>:</p>
<blockquote>
<p>I don't understand this migration well enough to say why it might be possible for that to happen, but I'm guessing this is the fix for the issue:</p>
<p><div class="codehilite"><pre><span></span><code>diff --git a/zerver/migrations/0443_userpresence_new_table_schema.py b/zerver/migrations/0443_userpresence_new_table_schema.py
index e4a7d3ca10..d1e5f3bdfe 100644
--- a/zerver/migrations/0443_userpresence_new_table_schema.py
+++ b/zerver/migrations/0443_userpresence_new_table_schema.py
@@ -33,6 +33,11 @@ def rename_indexes_constraints(
                     suffix = &quot;_idx&quot; if len(infodict[&quot;columns&quot;]) &gt; 1 else &quot;&quot;
                     is_index = True
                 new_name = schema_editor._create_index_name(new_table, infodict[&quot;columns&quot;], suffix)
+
+                if old_name == new_name:
+                    # Don&#39;t crash if these already have the right names.
+                    continue
+
                 if is_index:
                     raw_query = SQL(&quot;ALTER INDEX {old_name} RENAME TO {new_name}&quot;).format(
                         old_name=Identifier(old_name), new_name=Identifier(new_name)
</code></pre></div><br>
</p>
</blockquote>
<p>I tried to add your condition, unfortunately I got the same error again. I will attach the logs again, but it seems like the error has not changed<br>
<a href="/user_uploads/2/41/ymwLuVzm9jcvMdcPL4UWTKsS/upgrade.log">upgrade.log</a></p>



<a name="1584048"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584048" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584048">(Jun 02 2023 at 07:47)</a>:</h4>
<p>the problem we are solving is very similar to this one:<br>
<a href="https://code.djangoproject.com/ticket/23577">https://code.djangoproject.com/ticket/23577</a></p>
<p>I found this link in the file 0443_userpresence_new_table_schema.py on line 89 in the comments</p>



<a name="1584076"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584076" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584076">(Jun 02 2023 at 08:16)</a>:</h4>
<p>I tried to find something in the zerver_userpresence table with the name zerver_userpresenceo_user_profile_id_d75366d6_fk_zerver_us I didn't find anything, no indexes, nothing</p>



<a name="1584117"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584117" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584117">(Jun 02 2023 at 09:21)</a>:</h4>
<p>Hmm, yeah I don't think  <code>old_name == new_name</code> could even happen here, because they will always have a different prefix (<code>zerver_userpresence</code> vs <code>zerver_userpresenceo</code>/<code>zerver_userpresenceold</code> (apparently the <code>old</code> gets truncated a bit when generating a long contraint name, but that's not really a problem i think)).</p>
<p><span class="user-mention" data-user-id="23869">@Serg  Grishchenko</span> Can you show information about your table by running <code>\d zerver_userpresence</code> in <code>manage.py dbshell</code>?</p>
<p>And can you try running the upgrade with Tim's patch tweaked to have a print statement like this?<br>
(and then show us the output that it'll print during the migration - it should be on the standard output rather than the log file)</p>
<div class="codehilite"><pre><span></span><code>diff --git a/zerver/migrations/0443_userpresence_new_table_schema.py b/zerver/migrations/0443_userpresence_new_table_schema.py
index e4a7d3ca10..7faf50fef3 100644
--- a/zerver/migrations/0443_userpresence_new_table_schema.py
+++ b/zerver/migrations/0443_userpresence_new_table_schema.py
@@ -33,6 +33,12 @@ def rename_indexes_constraints(
                     suffix = &quot;_idx&quot; if len(infodict[&quot;columns&quot;]) &gt; 1 else &quot;&quot;
                     is_index = True
                 new_name = schema_editor._create_index_name(new_table, infodict[&quot;columns&quot;], suffix)
+
+                if old_name == new_name:
+                    # Don&#39;t crash if these already have the right names.
+                    continue
+
+                print(f&quot;Renaming {old_name} to {new_name}&quot;)
                 if is_index:
                     raw_query = SQL(&quot;ALTER INDEX {old_name} RENAME TO {new_name}&quot;).format(
                         old_name=Identifier(old_name), new_name=Identifier(new_name
</code></pre></div>
<p>That will help us see what exactly is going on in the migration. I wonder if e.g. there might be two different constraints that for some the migration ends up trying to give the same <code>new_name</code> <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="1584147"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584147" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584147">(Jun 02 2023 at 09:57)</a>:</h4>
<p><a href="/user_uploads/2/15/DW09WB24GEChVYVQVHRDAacj/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/15/DW09WB24GEChVYVQVHRDAacj/image.png" title="image.png"><img src="/user_uploads/2/15/DW09WB24GEChVYVQVHRDAacj/image.png"></a></div>



<a name="1584150"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584150" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584150">(Jun 02 2023 at 09:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/presence.20migration.20upgrading.206.2E2.20to.207.2E0/near/1584117">said</a>:</p>
<blockquote>
<p>Hmm, yeah I don't think  <code>old_name == new_name</code> could even happen here, because they will always have a different prefix (<code>zerver_userpresence</code> vs <code>zerver_userpresenceo</code>/<code>zerver_userpresenceold</code> (apparently the <code>old</code> gets truncated a bit when generating a long contraint name, but that's not really a problem i think)).</p>
<p><span class="user-mention silent" data-user-id="23869">Serg  Grishchenko</span> Can you show information about your table by running <code>\d zerver_userpresence</code> in <code>manage.py dbshell</code>?</p>
<p>And can you try running the upgrade with Tim's patch tweaked to have a print statement like this?<br>
(and then show us the output that it'll print during the migration - it should be on the standard output rather than the log file)</p>
<div class="codehilite"><pre><span></span><code>diff --git a/zerver/migrations/0443_userpresence_new_table_schema.py b/zerver/migrations/0443_userpresence_new_table_schema.py
index e4a7d3ca10..7faf50fef3 100644
--- a/zerver/migrations/0443_userpresence_new_table_schema.py
+++ b/zerver/migrations/0443_userpresence_new_table_schema.py
@@ -33,6 +33,12 @@ def rename_indexes_constraints(
                     suffix = &quot;_idx&quot; if len(infodict[&quot;columns&quot;]) &gt; 1 else &quot;&quot;
                     is_index = True
                 new_name = schema_editor._create_index_name(new_table, infodict[&quot;columns&quot;], suffix)
+
+                if old_name == new_name:
+                    # Don&#39;t crash if these already have the right names.
+                    continue
+
+                print(f&quot;Renaming {old_name} to {new_name}&quot;)
                 if is_index:
                     raw_query = SQL(&quot;ALTER INDEX {old_name} RENAME TO {new_name}&quot;).format(
                         old_name=Identifier(old_name), new_name=Identifier(new_name
</code></pre></div>
<p>That will help us see what exactly is going on in the migration. I wonder if e.g. there might be two different constraints that for some the migration ends up trying to give the same <code>new_name</code> <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>completed. the output above is in the message</p>



<a name="1584152"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584152" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584152">(Jun 02 2023 at 09:59)</a>:</h4>
<p>"And can you try running the upgrade with Tim's patch tweaked to have a print statement like this?"</p>
<p>I'll try it now</p>



<a name="1584155"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584155" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584155">(Jun 02 2023 at 10:01)</a>:</h4>
<p><a href="/user_uploads/2/52/9AUlOaZaFo7Dgu3pPyP_c_1B/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/52/9AUlOaZaFo7Dgu3pPyP_c_1B/image.png" title="image.png"><img src="/user_uploads/2/52/9AUlOaZaFo7Dgu3pPyP_c_1B/image.png"></a></div>



<a name="1584156"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584156" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584156">(Jun 02 2023 at 10:03)</a>:</h4>
<p><a href="/user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png">image.png</a><br>
I did, the error remained the same</p>
<div class="message_inline_image"><a href="/user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png" title="image.png"><img src="/user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png"></a></div>



<a name="1584161"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584161" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584161">(Jun 02 2023 at 10:28)</a>:</h4>
<p><span class="user-mention" data-user-id="23869">@Serg  Grishchenko</span> Hmm, it doesn't look in that screenshot <a href="user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png">https://chat.zulip.org/user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png</a> like the <code>print(f"Renaming {old_name} to {new_name}")</code> statement has been added like i suggested? Also just to clarify, for now the idea isn't that it's going to fix anything, but the output will give us information about what exactly the migration is doing, which might let us understand the cause of this.</p>
<div class="message_inline_image"><a href="user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png" title="https://chat.zulip.org/user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png"><img src="user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png"></a></div>



<a name="1584162"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584162" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584162">(Jun 02 2023 at 10:29)</a>:</h4>
<p>can you tell me where to register it? <br>
Line number or in what condition?</p>



<a name="1584163"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584163" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584163">(Jun 02 2023 at 10:39)</a>:</h4>
<p>done!<br>
<a href="/user_uploads/2/c5/J97e3blZjk2-X3g77gd9A_AE/image.png">image.png</a><br>
<a href="/user_uploads/2/ca/nbY_1e0ZEvdLs4opDlrwJS2Z/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/c5/J97e3blZjk2-X3g77gd9A_AE/image.png" title="image.png"><img src="/user_uploads/2/c5/J97e3blZjk2-X3g77gd9A_AE/image.png"></a></div><div class="message_inline_image"><a href="/user_uploads/2/ca/nbY_1e0ZEvdLs4opDlrwJS2Z/image.png" title="image.png"><img src="/user_uploads/2/ca/nbY_1e0ZEvdLs4opDlrwJS2Z/image.png"></a></div>



<a name="1584164"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584164" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584164">(Jun 02 2023 at 10:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/presence.20migration.20upgrading.206.2E2.20to.207.2E0/near/1584161">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="23869">Serg  Grishchenko</span> Hmm, it doesn't look in that screenshot <a href="user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png">https://chat.zulip.org/user_uploads/2/be/dc3DvlWae3i2kioSYm6Zd1uJ/image.png</a> like the <code>print(f"Renaming {old_name} to {new_name}")</code> statement has been added like i suggested? Also just to clarify, for now the idea isn't that it's going to fix anything, but the output will give us information about what exactly the migration is doing, which might let us understand the cause of this.</p>
</blockquote>
<p>in the screenshot, I did not quite highlight it, if an error occurs, it passes by the condition where the line with Remainig3</p>



<a name="1584165"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584165" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584165">(Jun 02 2023 at 10:41)</a>:</h4>
<p>this<br>
<a href="/user_uploads/2/93/lzm1rQVECH4yCSpo5GV7Ndm3/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/93/lzm1rQVECH4yCSpo5GV7Ndm3/image.png" title="image.png"><img src="/user_uploads/2/93/lzm1rQVECH4yCSpo5GV7Ndm3/image.png"></a></div>



<a name="1584183"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584183" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584183">(Jun 02 2023 at 11:13)</a>:</h4>
<p>2 last strings:<br>
Renaming3 zerver_userpresence_user_profile_id_b67b4092_fk to <strong>zerver_userpresenceo_user_profile_id_d75366d6_fk_zerver_us</strong><br>
Renaming3 zerver_userpresence_user_profile_id_b67b4092_fk_zerver_us to <strong>zerver_userpresenceo_user_profile_id_d75366d6_fk_zerver_us</strong></p>



<a name="1584190"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584190" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584190">(Jun 02 2023 at 11:30)</a>:</h4>
<p><strong>zerver_userpresence_user_profile_id_b67b4092_fk</strong> and <strong>zerver_userpresence_user_profile_id_b67b4092_fk_zerver_us</strong> to <strong>zerver_userpresenceo_user_profile_id_d75366d6_fk_zerver_us</strong></p>
<p>conflict</p>



<a name="1584208"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584208" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584208">(Jun 02 2023 at 11:43)</a>:</h4>
<p>Thanks, okay I think that tells us a lot about the problem! </p>
<p>So it seems there is a possibly redundant foreign key, causing the migration to try to rename two foreign keys to the same name. From the table info in <br>
<a href="/user_uploads/2/6d/vMKOtYsR0N6mDJsbp5lfqkjw/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/6d/vMKOtYsR0N6mDJsbp5lfqkjw/image.png" title="image.png"><img src="/user_uploads/2/6d/vMKOtYsR0N6mDJsbp5lfqkjw/image.png"></a></div><p>we see <code>zerver_userpresence_user_profile_id_b67b4092_fk</code> and <code>zerver_userpresence_user_profile_id_b67b4092_fk_zerver_us</code> that I think are the same foreign key twice, with a different name? And then confirmed by the migratoin output, both are being renamed to the same name:</p>
<div class="codehilite"><pre><span></span><code>Renaming3 zerver_userpresence_user_profile_id_b67b4092_fk to zerver_userpresenceo_user_profile_id_d75366d6_fk_zerver_us
Renaming3 zerver_userpresence_user_profile_id_b67b4092_fk_zerver_us to zerver_userpresenceo_user_profile_id_d75366d6_fk_zerver_us
</code></pre></div>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> <span class="user-mention" data-user-id="12178">@Alex Vandiver</span> I think the resolution that will let Serg proceed successfully will be to drop one of those foreign keys, can you double-check my thinking here? </p>
<p>The remaining questions are what could have caused this state with duplicate foreign keys for the affected deployments and how can we best fix that up? Should we just add some duplicate-fk detection at the beginning of the migration and drop the duplicate if found?</p>



<a name="1584214"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584214" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584214">(Jun 02 2023 at 11:50)</a>:</h4>
<p>Dropping the duplicate seems like good sense to me</p>



<a name="1584217"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584217" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584217">(Jun 02 2023 at 11:50)</a>:</h4>
<p>which key can be deleted? I would try this</p>



<a name="1584218"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584218" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584218">(Jun 02 2023 at 11:51)</a>:</h4>
<p>Huh, looks like a duplicate foreign key, not a duplicate index</p>



<a name="1584220"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584220" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584220">(Jun 02 2023 at 11:51)</a>:</h4>
<p>zerver_userpresence_user_profile_id_b67b4092_fk or  zerver_userpresence_user_profile_id_b67b4092_fk_zerver_us?</p>



<a name="1584256"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584256" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584256">(Jun 02 2023 at 12:26)</a>:</h4>
<p>Either should be fine, <code>zerver_userpresence_user_profile_id_b67b4092_fk</code> is the unusual one i guess compared to a typical server. You can do <code>ALTER TABLE zerver_userpresence DROP CONSTRAINT zerver_userpresence_user_profile_id_b67b4092_fk;</code> in <code>manage.py dbshell</code> and then re-run the migration and it should work fine now.</p>



<a name="1584263"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584263" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Serg  Grishchenko <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584263">(Jun 02 2023 at 12:34)</a>:</h4>
<blockquote>
<blockquote>
<p>ALTER TABLE zerver_userpresence DROP CONSTRAINT zerver_userpresence_user_profile_id_b67b4092_fk; &lt;&lt;<br>
thank you, the problem is solved. </p>
</blockquote>
</blockquote>
<p>Thank you so much)</p>



<a name="1584264"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584264" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584264">(Jun 02 2023 at 12:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="23869">Serg  Grishchenko</span> has marked this topic as resolved.</p>



<a name="1584270"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584270" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antti Kanes <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584270">(Jun 02 2023 at 12:51)</a>:</h4>
<p>Was about to mention I did <code>alter table zerver_userpresence drop constraint zerver_userpresence_user_profile_id_b67b4092_fk_zerver_us;</code> and this worked</p>



<a name="1584271"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584271" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antti Kanes <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584271">(Jun 02 2023 at 12:51)</a>:</h4>
<p>seems like same as suggested :).</p>



<a name="1584274"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584274" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584274">(Jun 02 2023 at 12:58)</a>:</h4>
<p>Yay, glad that it worked! Now we just have to figure out a reasonable PR to solve this  automatically</p>



<a name="1584323"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584323" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alfons RV <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584323">(Jun 02 2023 at 14:33)</a>:</h4>
<p>Why didn't running the SQL query work within the regular Postgres shell with <code>zulip</code> db selected, but have to use <code>su - zulip -c "/home/zulip/deployments/current/manage.py dbshell"</code>? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="1584360"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1584360" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1584360">(Jun 02 2023 at 15:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="9948">Alfons RV</span> <a href="#narrow/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0/near/1584323">said</a>:</p>
<blockquote>
<p>Why didn't running the SQL query work within the regular Postgres shell with <code>zulip</code> db selected, but have to use <code>su - zulip -c "/home/zulip/deployments/current/manage.py dbshell"</code>? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>Hmm, not sure, can you post the exact steps you followed for doing it in the regular postgres shell?</p>



<a name="1585203"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20presence%20migration%20upgrading%206.2%20to%207.0/near/1585203" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mateusz Mandera <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0.html#1585203">(Jun 05 2023 at 11:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="10349">Mateusz Mandera</span> <a href="#narrow/stream/31-production-help/topic/.E2.9C.94.20presence.20migration.20upgrading.206.2E2.20to.207.2E0/near/1584274">said</a>:</p>
<blockquote>
<p>Yay, glad that it worked! Now we just have to figure out a reasonable PR to solve this  automatically</p>
</blockquote>
<p>Opened <a href="https://github.com/zulip/zulip/pull/25887">#25887</a></p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>