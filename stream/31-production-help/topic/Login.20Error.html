<html>
<head><meta charset="utf-8"><title>Login Error · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html">Login Error</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1544434"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544434" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544434">(Apr 10 2023 at 19:32)</a>:</h4>
<p>Hi :) One of our users suddenly stumbled over the problem that they cannot login properly anymore. They try to login over Shibboleth, but after the (successful) login, they only get the "internal server error" page and the server sends such an exception to me:</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>Exception Message</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite"><pre><span></span><code>Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/084237fff2af10564fe96d2c02056d168f1e56b0/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/exception.py&quot;, line 55, in inner
    response = get_response(request)
  File &quot;/srv/zulip-venv-cache/084237fff2af10564fe96d2c02056d168f1e56b0/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py&quot;, line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File &quot;/home/zulip/deployments/2023-03-06-21-02-27/./zerver/views/home.py&quot;, line 131, in home
    return zulip_login_required(home_real)(request)
  File &quot;/home/zulip/deployments/2023-03-06-21-02-27/./zerver/decorator.py&quot;, line 426, in _wrapped_view
    return view_func(request, *args, **kwargs)
  File &quot;/srv/zulip-venv-cache/084237fff2af10564fe96d2c02056d168f1e56b0/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/auth/decorators.py&quot;, line 23, in _wrapped_view
    return view_func(request, *args, **kwargs)
  File &quot;/home/zulip/deployments/2023-03-06-21-02-27/./zerver/decorator.py&quot;, line 489, in _wrapped_view_func
    return view_func(request, *args, **kwargs)
  File &quot;/home/zulip/deployments/2023-03-06-21-02-27/./zerver/views/home.py&quot;, line 199, in home_real
    queue_id, page_params = build_page_params_for_home_page_load(
  File &quot;/home/zulip/deployments/2023-03-06-21-02-27/./zerver/lib/home.py&quot;, line 145, in build_page_params_for_home_page_load
    register_ret = do_events_register(
  File &quot;/home/zulip/deployments/2023-03-06-21-02-27/./zerver/lib/events.py&quot;, line 1458, in do_events_register
    reactivate_user_if_soft_deactivated(user_profile)
  File &quot;/home/zulip/deployments/2023-03-06-21-02-27/./zerver/lib/soft_deactivation.py&quot;, line 317, in reactivate_user_if_soft_deactivated
    add_missing_messages(user_profile)
  File &quot;/home/zulip/deployments/2023-03-06-21-02-27/./zerver/lib/soft_deactivation.py&quot;, line 194, in add_missing_messages
    if stream_subscription_logs[-1].event_type == RealmAuditLog.SUBSCRIPTION_DEACTIVATED:
IndexError: list index out of range


Deployed code:
- git: 6.0-980-gcca8417ad4
- ZULIP_VERSION: 6.0-980-gcca8417ad4


Request info:
- path: /
- GET: {}
- REMOTE_ADDR: &quot;[...]&quot;
- QUERY_STRING: &quot;&quot;
- SERVER_NAME: &quot;&quot;
</code></pre></div>
</div></div>
<p>I already restarted the server, but that didn't fix it. Is there something else I could try?</p>



<a name="1544441"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544441" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544441">(Apr 10 2023 at 19:36)</a>:</h4>
<p>Uh, huh.  Was this server an import?</p>



<a name="1544446"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544446" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544446">(Apr 10 2023 at 19:41)</a>:</h4>
<p>No, and the user is just a regular user. (And not a new one...)</p>



<a name="1544478"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544478" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544478">(Apr 10 2023 at 19:52)</a>:</h4>
<p>Is there a function to logout a single user given their <code>UserProfile</code> instance? Maybe that could fix it?</p>



<a name="1544479"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544479" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544479">(Apr 10 2023 at 19:54)</a>:</h4>
<p>No, being logged in is a function of the session, and sessions aren't indexed by user-id.</p>
<p>Regardless, this is about the "soft reactivation" step for users that haven't logged in for a while.  Logging them out won't help.</p>



<a name="1544482"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544482" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544482">(Apr 10 2023 at 19:55)</a>:</h4>
<p>The invariant which is being broken is that the user is subscribed to a stream without having an audit log record for that subscription -- or any audit log records for that user.</p>



<a name="1544485"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544485" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544485">(Apr 10 2023 at 19:55)</a>:</h4>
<p>That shouldn't be possible unless some database hackery has happened with the user.</p>



<a name="1544487"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544487" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544487">(Apr 10 2023 at 19:56)</a>:</h4>
<p>Hm, my bot just subribed them to a few streams. (That is actually the reason why the user tried to login.)</p>



<a name="1544488"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544488" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544488">(Apr 10 2023 at 19:56)</a>:</h4>
<p>How do you do the subscription?</p>



<a name="1544492"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544492" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544492">(Apr 10 2023 at 19:58)</a>:</h4>
<p>Like that: <a href="https://github.com/ro-i/tumcsbot/blob/79306552ea54b2e3b279f84270e8f48ee520a989/src/tumcsbot/plugins/subscribe.py#L169">https://github.com/ro-i/tumcsbot/blob/79306552ea54b2e3b279f84270e8f48ee520a989/src/tumcsbot/plugins/subscribe.py#L169</a></p>



<a name="1544499"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544499" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544499">(Apr 10 2023 at 20:03)</a>:</h4>
<p><a href="https://github.com/ro-i/tumcsbot/blob/79306552ea54b2e3b279f84270e8f48ee520a989/src/tumcsbot/client.py#L385-L388">https://github.com/ro-i/tumcsbot/blob/79306552ea54b2e3b279f84270e8f48ee520a989/src/tumcsbot/client.py#L385-L388</a><br>
calls <code>add_subscription</code> with <code>principals=[...]</code> which I don't think is an API that we provide:<br>
<a href="https://github.com/zulip/python-zulip-api/blob/main/zulip/zulip/__init__.py#L1406-L1415">https://github.com/zulip/python-zulip-api/blob/main/zulip/zulip/__init__.py#L1406-L1415</a></p>



<a name="1544502"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544502" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544502">(Apr 10 2023 at 20:08)</a>:</h4>
<p>Oh, hm, I sit corrected -- <code>users/me/subscriptions</code> does take <code>principals</code> (which seems very weird to me)</p>



<a name="1544504"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544504" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544504">(Apr 10 2023 at 20:08)</a>:</h4>
<p>But isn't that the documented behavior? <a href="https://zulip.com/api/subscribe">https://zulip.com/api/subscribe</a></p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="c1"># To subscribe other users to a stream, you may pass</span>
<span class="c1"># the `principals` argument, like so:</span>
<span class="n">user_id</span> <span class="o">=</span> <span class="mi">26</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">add_subscriptions</span><span class="p">(</span>
    <span class="n">streams</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"new stream"</span><span class="p">,</span> <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"New stream for testing"</span><span class="p">},</span>
    <span class="p">],</span>
    <span class="n">principals</span><span class="o">=</span><span class="p">[</span><span class="n">user_id</span><span class="p">],</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>



<a name="1544505"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544505" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544505">(Apr 10 2023 at 20:08)</a>:</h4>
<p>Yes ^^</p>



<a name="1544508"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544508" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544508">(Apr 10 2023 at 20:08)</a>:</h4>
<p>Why is it weird?</p>



<a name="1544510"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544510" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544510">(Apr 10 2023 at 20:09)</a>:</h4>
<p>The <code>me</code> in <code>users/me/subscriptions</code> has some certain implications to me as a reader of the API. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1544513"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544513" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544513">(Apr 10 2023 at 20:10)</a>:</h4>
<p>It is quite useful to subscribe multiple users at once :)</p>



<a name="1544514"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544514" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544514">(Apr 10 2023 at 20:11)</a>:</h4>
<p>Oh, for sure.</p>



<a name="1544516"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544516" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Neil Pilgrim (neiljp) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544516">(Apr 10 2023 at 20:12)</a>:</h4>
<p>I was confused why you needed a command (thinking <code>manage.py</code> commands), but then saw you're using the API anyhow :)</p>



<a name="1544519"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544519" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544519">(Apr 10 2023 at 20:17)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert (ro-i)</span>: Can you pop open a <code>./manage.py shell</code> and run (replacing realm and user email):</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">r</span> <span class="o">=</span> <span class="n">get_realm</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">get_user_by_delivery_email</span><span class="p">(</span><span class="s2">"alexmv@zulip.com"</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">realm</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
    <span class="n">modified_user</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">event_type__in</span><span class="o">=</span><span class="p">[</span>
        <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">SUBSCRIPTION_CREATED</span><span class="p">,</span>
        <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">SUBSCRIPTION_DEACTIVATED</span><span class="p">,</span>
        <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">SUBSCRIPTION_ACTIVATED</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</code></pre></div>



<a name="1544525"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544525" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544525">(Apr 10 2023 at 20:19)</a>:</h4>
<p>Sure, result is 61</p>



<a name="1544536"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544536" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544536">(Apr 10 2023 at 20:24)</a>:</h4>
<p>Pull the stream-ids of the recent streams you added the user to:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">stream_ids</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="n">fill</span> <span class="ow">in</span><span class="o">...</span><span class="p">]</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">realm</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
    <span class="n">modified_user</span><span class="o">=</span><span class="n">u</span><span class="p">,</span>
    <span class="n">event_type__in</span><span class="o">=</span><span class="p">[</span>
        <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">SUBSCRIPTION_CREATED</span><span class="p">,</span>
        <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">SUBSCRIPTION_DEACTIVATED</span><span class="p">,</span>
        <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">SUBSCRIPTION_ACTIVATED</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">modified_stream_id__in</span><span class="o">=</span><span class="n">stream_ids</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="n">events_by_stream_id</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
    <span class="n">events_by_stream_id</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">modified_stream_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">event_type</span><span class="p">)</span>
<span class="k">for</span> <span class="n">stream_id</span> <span class="ow">in</span> <span class="n">stream_ids</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">stream_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">events_by_stream_id</span><span class="p">[</span><span class="n">stream_id</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>



<a name="1544554"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544554" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544554">(Apr 10 2023 at 20:32)</a>:</h4>
<p>If you don't know the stream-ids, you can replace the first line with:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">stream_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub</span><span class="o">.</span><span class="n">recipient</span><span class="o">.</span><span class="n">type_id</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_profile</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">recipient__type</span><span class="o">=</span><span class="n">Recipient</span><span class="o">.</span><span class="n">STREAM</span><span class="p">)]</span>
</code></pre></div>



<a name="1544563"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544563" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544563">(Apr 10 2023 at 20:36)</a>:</h4>
<p>Hm, actually the user has been subscribed to 5 new streams... That would be the output for them:</p>
<div class="codehilite"><pre><span></span><code>1555: [301]
1556: [301]
1559: [301]
1558: [301]
1557: [301]
</code></pre></div>
<p>But with your second addition, I get</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>a long list</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite"><pre><span></span><code>1: [301]
214: [301]
216: [301]
298: [301]
311: [301, 303]
412: [301]
413: [301]
414: [301]
421: [301]
422: [301, 303]
565: [301]
868: []
916: [301, 303]
917: [301, 303]
931: [301]
932: [301]
933: [301]
934: [301]
935: [301]
936: [301]
937: [301]
1013: [301]
1014: [301]
1015: [301]
1016: [301]
1049: [301]
1088: [301]
1091: [303, 301]
1092: [301]
1093: [301]
1098: [303, 301]
1114: [301, 303]
1121: [303, 301]
1125: [301]
1129: [301]
1132: [301]
1137: [301]
1139: [301]
1144: [301]
1147: [301]
1154: [301]
1157: [301]
1160: [301, 303]
1164: [301]
1165: [301]
1166: [301]
1167: [301]
1227: [301]
1555: [301]
1556: [301]
1557: [301]
1558: [301]
1559: [301]
</code></pre></div>
</div></div>



<a name="1544567"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544567" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544567">(Apr 10 2023 at 20:37)</a>:</h4>
<p>OK, the <code>868: []</code> is the issue.  They're subscribed to that stream without an audit log entry for it.  Is there anything notable about that stream, or the history of it?</p>



<a name="1544589"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544589" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544589">(Apr 10 2023 at 20:48)</a>:</h4>
<p>And/or, you can see if other users in that stream are in the same state:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">868</span><span class="p">)</span>
<span class="n">user_ids_in_audit_log</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
    <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">realm</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
        <span class="n">event_type__in</span><span class="o">=</span><span class="p">[</span>
            <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">SUBSCRIPTION_CREATED</span><span class="p">,</span>
            <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">SUBSCRIPTION_DEACTIVATED</span><span class="p">,</span>
            <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">SUBSCRIPTION_ACTIVATED</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">modified_stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s2">"modified_user_id"</span><span class="p">)</span>
    <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">"modified_user_id"</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">subscribed_user_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
    <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">recipient__type</span><span class="o">=</span><span class="n">Recipient</span><span class="o">.</span><span class="n">STREAM</span><span class="p">,</span> <span class="n">recipient__type_id</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">"user_profile_id"</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">subscribed_user_ids</span> <span class="o">-</span> <span class="n">user_ids_in_audit_log</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</code></pre></div>



<a name="1544600"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544600" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544600">(Apr 10 2023 at 20:54)</a>:</h4>
<p>Hm, the streams doesn't seem to exist:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">streams</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_streams</span><span class="p">(</span><span class="n">include_all_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">[</span><span class="s2">"streams"</span><span class="p">]:</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s2">"stream_id"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">868</span><span class="p">:</span>
<span class="o">...</span>         <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="o">...</span>         <span class="k">break</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div>
<p>(<code>c</code> is a <code>zulip.Client</code> instance with my API key, so Owner permissions)</p>
<p>There are the following useres:</p>
<div class="codehilite"><pre><span></span><code>3238
7355
26
7291
7292
</code></pre></div>
<p>I know user id 26 :) Maybe I ask him about this stream. Maybe it's a private stream that has been improperly deleted? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="1544602"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544602" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544602">(Apr 10 2023 at 20:56)</a>:</h4>
<p>Does it exist on the server?</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">868</span><span class="p">)</span>
</code></pre></div>



<a name="1544603"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544603" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544603">(Apr 10 2023 at 20:56)</a>:</h4>
<p>But that seems like a plausible guess here.</p>



<a name="1544604"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544604" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544604">(Apr 10 2023 at 20:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Login.20Error/near/1544602">said</a>:</p>
<blockquote>
<p>Does it exist on the server?</p>
<p><div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">868</span><span class="p">)</span>
</code></pre></div><br>
</p>
</blockquote>
<p>Yes, like that:<br>
<code>Out[10]: &lt;Stream: &lt;Stream: 9e1ec35!DEACTIVATED:EIST22&gt;&gt;</code><br>
I don't think that this is supposed to be like that <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="1544605"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544605" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544605">(Apr 10 2023 at 20:57)</a>:</h4>
<p>That's what deactivated streams do look like.</p>



<a name="1544606"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544606" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544606">(Apr 10 2023 at 20:58)</a>:</h4>
<p>We rename them to preserve the ability to make a new stream wit the old name.</p>



<a name="1544607"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544607" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544607">(Apr 10 2023 at 20:59)</a>:</h4>
<p>But regardless, they were subscribed to it in some way that didn't leave audit log entries, which bears asking user 26 about.</p>



<a name="1544609"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544609" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544609">(Apr 10 2023 at 21:00)</a>:</h4>
<p>(deactivating a stream does not tamper with its audit log entries, for obvious reasons)</p>



<a name="1544612"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544612" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544612">(Apr 10 2023 at 21:02)</a>:</h4>
<p>Hm, so user 26 says that he was in the stream (without problems), and that he doesn't see the stream anymore...</p>



<a name="1544613"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544613" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544613">(Apr 10 2023 at 21:02)</a>:</h4>
<p>Seems regular so far</p>



<a name="1544618"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544618" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544618">(Apr 10 2023 at 21:07)</a>:</h4>
<p>What would happen if I completely removed the stream? Would that fix things?</p>



<a name="1544621"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544621" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544621">(Apr 10 2023 at 21:08)</a>:</h4>
<p>That's not really a supported operation, and would likely make things worse.</p>



<a name="1544623"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544623" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544623">(Apr 10 2023 at 21:09)</a>:</h4>
<p>We can insert synthetic subscription events for those users.</p>
<p>I'm also a little surprised this codepath is running for deactivated streams, but I guess we probably need that to have a consistent high-water mark that we've done user UserMessage backfill to.</p>



<a name="1544627"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544627" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544627">(Apr 10 2023 at 21:11)</a>:</h4>
<p>Bear in mind that if the stream is a private stream without shared history, inserting faked-up subscription events may give them access to messages they shouldn't have been able to read, depending on when you pick as the "subscription" time.</p>



<a name="1544629"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544629" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544629">(Apr 10 2023 at 21:12)</a>:</h4>
<p>Hence why it's a little of interest to us, probably, to know how the stream came to be.</p>
<p>But we can fudge a fix forward.</p>



<a name="1544646"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544646" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544646">(Apr 10 2023 at 21:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Login.20Error/near/1544627">said</a>:</p>
<blockquote>
<p>Bear in mind that if the stream is a private stream without shared history, inserting faked-up subscription events may give them access to messages they shouldn't have been able to read, depending on when you pick as the "subscription" time.</p>
</blockquote>
<p>That wouldn't be an issue in this case because the stream was public all the time.</p>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Login.20Error/near/1544629">said</a>:</p>
<blockquote>
<p>Hence why it's a little of interest to us, probably, to know how the stream came to be.</p>
</blockquote>
<p>Unfortunately I cannot really tell anything useful, I'm afraid. The only "odd" thing about this stream might be that it had restricted write permissions for a short time (during an exam). But I don't think that there is anything else...</p>



<a name="1544815"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544815" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544815">(Apr 11 2023 at 01:09)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert (ro-i)</span> do you when the stream in question was created?</p>



<a name="1544816"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1544816" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1544816">(Apr 11 2023 at 01:10)</a>:</h4>
<p>I seem to recall we had a bug a few years ago where the transaction structure wasn't correct, and so a request that failed partway through could lead to audit log entries not having been created.</p>



<a name="1545161"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1545161" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1545161">(Apr 11 2023 at 12:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/Login.20Error/near/1544815">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="17322">Robert (ro-i)</span> do you when the stream in question was created?</p>
</blockquote>
<p>I don't understand your question <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span></p>



<a name="1545262"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1545262" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Meyer <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1545262">(Apr 11 2023 at 14:47)</a>:</h4>
<p>Hi, I had the exact same problem today.</p>
<p>In my case, however, it was a completely normal stream. (so it wasn't a deactivated stream) After i found out the stream id, i de-subscribed the affected account from the stream via the zulip gui. Since then, the account can log in normally again.<br>
The information here has helped me a lot, thank you.</p>



<a name="1545275"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1545275" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1545275">(Apr 11 2023 at 15:03)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert (ro-i)</span>: I think Tim accidentally a word:</p>
<blockquote>
<p>do you <em>know</em> when the stream in question was created?</p>
</blockquote>



<a name="1545276"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1545276" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1545276">(Apr 11 2023 at 15:03)</a>:</h4>
<p><span class="user-mention" data-user-id="14062">@Alex Meyer</span>:  Interesting.  Same question to you -- do you know when the stream was created, or when the user might have joined it?</p>



<a name="1545619"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1545619" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1545619">(Apr 11 2023 at 20:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Login.20Error/near/1545275">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="17322">Robert (ro-i)</span>: I think Tim accidentally a word:</p>
<blockquote>
<p>do you <em>know</em> when the stream in question was created?</p>
</blockquote>
</blockquote>
<p>no, but there may be a way to find this out programmatically?</p>



<a name="1545943"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1545943" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Meyer <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1545943">(Apr 12 2023 at 06:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Login.20Error/near/1545276">schrieb</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="14062">Alex Meyer</span>:  Interesting.  Same question to you -- do you know when the stream was created, or when the user might have joined it?</p>
</blockquote>
<p>That must have been in 2019 or 2020.</p>



<a name="1548024"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1548024" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1548024">(Apr 14 2023 at 16:46)</a>:</h4>
<p>We just got another report of this, so we should consider if there's a migration we should be adding to insert synthetic subscriptions where possible (i.e. for streams that don't have hidden-history)</p>
<p>The above detection script found no instances of that failure mode on CZO or Zulip Cloud.</p>



<a name="1548065"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1548065" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1548065">(Apr 14 2023 at 17:34)</a>:</h4>
<p>We could theoretically attempt to address this at soft-reactivation-time, but I think it's probably better to do in one fell swoop, since it's restoring database consistency.</p>



<a name="1548127"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1548127" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1548127">(Apr 14 2023 at 18:28)</a>:</h4>
<p>Yeah, I'd be fine with a synthetic migration of that form; it can pass <code>backfilled=True</code> to mark the rows created that way.</p>



<a name="1548128"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1548128" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1548128">(Apr 14 2023 at 18:29)</a>:</h4>
<p>And I think that's a good path forward assuming we think the issue is that this was the consequence of our not having transactions in this code path as of 2020.</p>



<a name="1548131"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1548131" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1548131">(Apr 14 2023 at 18:31)</a>:</h4>
<p>I find it interesting that we don't have any such errors in Zulip Cloud, though.  That normally gets enough traffic to shake out things like this.</p>



<a name="1548140"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1548140" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1548140">(Apr 14 2023 at 18:42)</a>:</h4>
<p>Yeah. I suppose one class of transaction failure can be someone shutting down the server partway through an API request, and Zulip Cloud has very good uptime, so that class of failure might happen more often in self-hosted systems that have lower uptime requirements?</p>



<a name="1548149"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1548149" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1548149">(Apr 14 2023 at 18:46)</a>:</h4>
<p>Potentially!</p>



<a name="1548596"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1548596" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1548596">(Apr 15 2023 at 13:58)</a>:</h4>
<p>Is there a fix we could apply for an affected user in the short term?</p>



<a name="1549035"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1549035" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1549035">(Apr 17 2023 at 14:26)</a>:</h4>
<p>Yeah, you should be able to run the migration code manually to do the same backfill.  I'm planning to work up that code today.</p>



<a name="1551415"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551415" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551415">(Apr 19 2023 at 19:32)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert (ro-i)</span>: OK, give this a shot:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="kn">from</span> <span class="nn">zerver.lib.message</span> <span class="kn">import</span> <span class="n">get_last_message_id</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Min</span>

<span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">Stream</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
    <span class="n">subscribed_user_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">recipient_id</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">recipient_id</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
            <span class="s2">"user_profile_id"</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">user_ids_in_audit_log</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">realm</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">realm</span><span class="p">,</span>
            <span class="n">event_type__in</span><span class="o">=</span><span class="p">[</span>
                <span class="mi">301</span><span class="p">,</span>  <span class="c1"># RealmAuditLog.SUBSCRIPTION_CREATED</span>
                <span class="mi">302</span><span class="p">,</span>  <span class="c1"># RealmAuditLog.SUBSCRIPTION_ACTIVATED</span>
                <span class="mi">303</span><span class="p">,</span>  <span class="c1"># RealmAuditLog.SUBSCRIPTION_DEACTIVATED</span>
            <span class="p">],</span>
            <span class="n">modified_stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s2">"modified_user_id"</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">"modified_user_id"</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">user_ids_missing_events</span> <span class="o">=</span> <span class="n">subscribed_user_ids</span> <span class="o">-</span> <span class="n">user_ids_in_audit_log</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids_missing_events</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="n">backfills</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">user_ids_missing_events</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Backfilling subscription event for </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">stream</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">stream</span><span class="o">.</span><span class="n">realm</span><span class="o">.</span><span class="n">string_id</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="n">UserMessage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">user_profile_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">message__recipient</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">recipient_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
            <span class="n">earliest_date</span><span class="o">=</span><span class="n">Min</span><span class="p">(</span><span class="s2">"message__date_sent"</span><span class="p">),</span>
            <span class="n">earliest_message_id</span><span class="o">=</span><span class="n">Min</span><span class="p">(</span><span class="s2">"message_id"</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Assume we subscribed right before the first message we</span>
        <span class="c1"># saw -- or, if we don't see any, right now.  This makes</span>
        <span class="c1"># this safe for streams which do not have shared history.</span>
        <span class="k">if</span> <span class="n">aggregated</span><span class="p">[</span><span class="s2">"earliest_message_id"</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">event_last_message_id</span> <span class="o">=</span> <span class="n">aggregated</span><span class="p">[</span><span class="s2">"earliest_message_id"</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event_last_message_id</span> <span class="o">=</span> <span class="n">get_last_message_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">aggregated</span><span class="p">[</span><span class="s2">"earliest_date"</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">event_time</span> <span class="o">=</span> <span class="n">aggregated</span><span class="p">[</span><span class="s2">"earliest_date"</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event_time</span> <span class="o">=</span> <span class="n">timezone_now</span><span class="p">()</span>

        <span class="n">log_event</span> <span class="o">=</span> <span class="n">RealmAuditLog</span><span class="p">(</span>
            <span class="n">event_time</span><span class="o">=</span><span class="n">event_time</span><span class="p">,</span>
            <span class="n">event_last_message_id</span><span class="o">=</span><span class="n">event_last_message_id</span><span class="p">,</span>
            <span class="n">backfilled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">event_type</span><span class="o">=</span><span class="mi">301</span><span class="p">,</span>  <span class="c1"># RealmAuditLog.SUBSCRIPTION_CREATED</span>
            <span class="n">realm_id</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">realm_id</span><span class="p">,</span>
            <span class="n">modified_user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">modified_stream_id</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">backfills</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_event</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">log_event</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
    <span class="n">RealmAuditLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">backfills</span><span class="p">)</span>
</code></pre></div>



<a name="1551417"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551417" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551417">(Apr 19 2023 at 19:36)</a>:</h4>
<p>Thanks for the script! So I just run it? Or do I have to consider anything else?</p>



<a name="1551418"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551418" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551418">(Apr 19 2023 at 19:37)</a>:</h4>
<p>Open up <code>./manage.py shell</code> (as <code>zulip</code>, in <code>~/deployments/current</code>) and then paste that in.</p>



<a name="1551421"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551421" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551421">(Apr 19 2023 at 19:39)</a>:</h4>
<p><span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="1551422"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551422" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551422">(Apr 19 2023 at 19:40)</a>:</h4>
<p>I notify the affected user and check whether they can login again</p>



<a name="1551423"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551423" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551423">(Apr 19 2023 at 19:40)</a>:</h4>
<p>Did it print anything out?</p>



<a name="1551425"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551425" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551425">(Apr 19 2023 at 19:40)</a>:</h4>
<p>yes</p>



<a name="1551426"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551426" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551426">(Apr 19 2023 at 19:41)</a>:</h4>
<p>Should be a couple lines, not a huge wall, and it looks like it's talking about the right stream?</p>



<a name="1551429"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551429" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551429">(Apr 19 2023 at 19:42)</a>:</h4>
<p>Yes, three Streams were affected. one line for the first, and 5 for each of the other two :)</p>



<a name="1551437"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551437" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551437">(Apr 19 2023 at 19:49)</a>:</h4>
<p>I've pushed this as a migration in <a href="https://github.com/zulip/zulip/pull/25194">#25194</a>.</p>



<a name="1551501"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Login%20Error/near/1551501" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Login.20Error.html#1551501">(Apr 19 2023 at 20:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="17322">Robert (ro-i)</span> <a href="#narrow/stream/31-production-help/topic/Login.20Error/near/1551422">said</a>:</p>
<blockquote>
<p>I notify the affected user and check whether they can login again</p>
</blockquote>
<p>It works for them again! Thank you so much <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span></p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>