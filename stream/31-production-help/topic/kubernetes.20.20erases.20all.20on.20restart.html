<html>
<head><meta charset="utf-8"><title>kubernetes  erases all on restart · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html">kubernetes  erases all on restart</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1307595"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307595" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307595">(Jan 10 2022 at 21:52)</a>:</h4>
<p>I'm trying to deploy  zulip on an on premise cluster without success, as every time I restart the database gets recreated. Any ideas were I have to look at for knowing what is happening? Everything works except at restarting, is like it doesn't properly detect that it is already installed and creates the db again.</p>



<a name="1307613"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307613" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307613">(Jan 10 2022 at 22:01)</a>:</h4>
<p><span class="user-mention" data-user-id="22788">@Gabriel Díaz</span>: You're using <a href="https://github.com/zulip/docker-zulip">https://github.com/zulip/docker-zulip</a> ?</p>



<a name="1307614"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307614" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307614">(Jan 10 2022 at 22:02)</a>:</h4>
<p>Yes correct, I'm using this one</p>



<a name="1307616"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307616" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307616">(Jan 10 2022 at 22:02)</a>:</h4>
<p>Are you using one of the helm charts that folks have tinkered with?</p>



<a name="1307617"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307617" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307617">(Jan 10 2022 at 22:02)</a>:</h4>
<p>No without helm, I was trying to use the yaml in the kubernetes folder</p>



<a name="1307618"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307618" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307618">(Jan 10 2022 at 22:03)</a>:</h4>
<p>Is the Helm chart usable?</p>



<a name="1307619"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307619" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307619">(Jan 10 2022 at 22:03)</a>:</h4>
<p>:nod:  I think that means that most likely the postgres machine volume isn't set up right.  Can you show that part of your docker-compose, being sure to redact any passwords?</p>



<a name="1307620"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307620" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307620">(Jan 10 2022 at 22:04)</a>:</h4>
<p>"maybe" is the most recent status of the Helm chart that I recall.</p>



<a name="1307622"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307622" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307622">(Jan 10 2022 at 22:04)</a>:</h4>
<p><a class="stream-topic" data-stream-id="21" href="/#narrow/stream/21-provision-help/topic/K8.20and.20Helm">#provision help &gt; K8 and Helm</a> is the relevant topic</p>



<a name="1307623"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307623" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307623">(Jan 10 2022 at 22:05)</a>:</h4>
<p>Ok, I will try to provide that. I ended up making some changes as the provided example doesn't use deployments</p>



<a name="1307625"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307625" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307625">(Jan 10 2022 at 22:06)</a>:</h4>
<p>But I encountered same problem with the provided example, on every restart all gets wiped and doesn't detect that I even created the realm.</p>



<a name="1307626"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307626" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307626">(Jan 10 2022 at 22:06)</a>:</h4>
<p>I create the volumes with longhorn locally, single node kubernetes at this moment.</p>



<a name="1307634"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307634" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307634">(Jan 10 2022 at 22:16)</a>:</h4>
<p>I have zero context with k8s personally, so I can't help much, I'm afraid.</p>



<a name="1307635"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307635" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307635">(Jan 10 2022 at 22:19)</a>:</h4>
<p><a href="/user_uploads/2/2/q_-fhm9QsiN9hE9u3qhdWrdt/kubernetes-clean.yaml">kubernetes-clean.yaml</a> </p>
<p>Find attached the yaml that I first tried (having the same issue)</p>



<a name="1307636"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307636" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307636">(Jan 10 2022 at 22:20)</a>:</h4>
<p>I also noticed two additional issues. The setting PUSH_NOTIFICATION_BOUNCER_URL is indeed SETTING_PUSH_NOTIFICATION_BOUNCER_URL. If you just specify  PUSH_NOTIFICATION_BOUNCER_URL  it doesn't work as it doesnt get replaced in the zulip config file.</p>



<a name="1307637"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307637" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307637">(Jan 10 2022 at 22:22)</a>:</h4>
<p>And the volume mount for redis dind't match between the provided docker-compose and kubernetes sample files. In docker-compose the mount volume path is /data and in the kubernetes example is /var/lib/redis</p>



<a name="1307638"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307638" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307638">(Jan 10 2022 at 22:25)</a>:</h4>
<p>Pushed a fix for the push notification URL</p>



<a name="1307639"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307639" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307639">(Jan 10 2022 at 22:27)</a>:</h4>
<p>One difference is that the k8s and the docker configs use different redis images.</p>



<a name="1307640"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307640" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307640">(Jan 10 2022 at 22:27)</a>:</h4>
<p>I didn't realize that, I will have a look at it.</p>



<a name="1307642"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307642" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307642">(Jan 10 2022 at 22:31)</a>:</h4>
<p>Yeah, in my latest code I already put the redis:alpine and it dind't make any change. I tried to copy all docker-compose attributes as it seems much updated than the kubernetes example.</p>



<a name="1307644"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307644" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307644">(Jan 10 2022 at 22:31)</a>:</h4>
<p>Yeah indeed I also noticed and corrected another one, and is that the redis password is required, if not, it doesn't boot up properly.</p>



<a name="1307645"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307645" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307645">(Jan 10 2022 at 22:33)</a>:</h4>
<p>I think the problem is during the startup of the postgres image, I will try to catch the logs I can. Looking at the init script  of the postgres docker I dind't see anything suspicious, it just checks the existence of the PG_VERSION in the postgres volume to check if the database is already created or not.</p>



<a name="1307670"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307670" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307670">(Jan 10 2022 at 23:10)</a>:</h4>
<p>I have seen another issue, in the helm the volume path for postgress is /var/lib/postgresql/data, but in the example provided in kubernetes folder is /var/lib/postgresql</p>



<a name="1307671"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307671" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307671">(Jan 10 2022 at 23:11)</a>:</h4>
<p>I cannot use the path /var/lib/postgresql/data as if I do so I get this error and the pod never starts up:</p>
<p>zulip-postgres-8ff9659c4-vpzf9     0/1     CrashLoopBackOff   3          113s<br>
root@servidor:/home/gabriel/docker/kubernetes# kubectl logs zulip-postgres-8ff9659c4-vpzf9 -n zulip<br>
The files belonging to this database system will be owned by user "postgres".<br>
This user must also own the server process.</p>
<p>The database cluster will be initialized with locale "en_US.utf8".<br>
The default database encoding has accordingly been set to "UTF8".<br>
The default text search configuration will be set to "english".</p>
<p>Data page checksums are disabled.</p>
<p>initdb: directory "/var/lib/postgresql/data" exists but is not empty<br>
It contains a lost+found directory, perhaps due to it being a mount point.<br>
Using a mount point directly as the data directory is not recommended.<br>
Create a subdirectory under the mount point.</p>



<a name="1307672"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307672" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307672">(Jan 10 2022 at 23:14)</a>:</h4>
<p>Found related issue:</p>
<p><a href="https://stackoverflow.com/questions/51168558/how-to-mount-a-postgresql-volume-using-aws-ebs-in-kubernete">https://stackoverflow.com/questions/51168558/how-to-mount-a-postgresql-volume-using-aws-ebs-in-kubernete</a></p>



<a name="1307673"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307673" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307673">(Jan 10 2022 at 23:20)</a>:</h4>
<p>Solution in stackoverflow seems to be working, I will try if with that it survives to reboots. Corrected postgres volume mount to:</p>
<div class="codehilite"><pre><span></span><code>    volumeMounts:

      - name: data
        mountPath: /var/lib/postgresql/data
        subPath: postgres
</code></pre></div>



<a name="1307693"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307693" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307693">(Jan 11 2022 at 00:06)</a>:</h4>
<p>Found! Working and all persists after a restart!</p>



<a name="1307696"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307696" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307696">(Jan 11 2022 at 00:06)</a>:</h4>
<p>I will comment this on the k8s and helm topic</p>



<a name="1307704"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1307704" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1307704">(Jan 11 2022 at 00:11)</a>:</h4>
<p>Awesome.  And anything you think would be helpful documentation for the future, we'd love to have as a PR!</p>



<a name="1309961"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1309961" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1309961">(Jan 13 2022 at 22:54)</a>:</h4>
<p>I will try to do a PR tomorrow with my current kubernetes deployment and updating the documentation.</p>



<a name="1309962"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/kubernetes%20%20erases%20all%20on%20restart/near/1309962" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Díaz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/kubernetes.20.20erases.20all.20on.20restart.html#1309962">(Jan 13 2022 at 22:55)</a>:</h4>
<p>Found another issue due to the missing camo installation in the docker image. In order to giphy to work properly, this must be set in the config also:</p>
<div class="codehilite"><pre><span></span><code>    #Bugfix for missing camo installation in docker install

    - name: ZULIP_CUSTOM_SETTINGS
      value: &quot;CAMO_URI = &#39;&#39;&quot;
</code></pre></div>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>