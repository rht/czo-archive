<html>
<head><meta charset="utf-8"><title>Users display as offline · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html">Users display as offline</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1565488"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1565488" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The One <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1565488">(May 10 2023 at 00:49)</a>:</h4>
<p>Hello, I have a self hosted zulip and over night it appears that  all users status except for mine are showing as offline. Only the user logged on can see there own status as being logged on. Not sure what caused this sudden change.  Running zulip version 6.0.<br>
Any assistance would be appreciated.</p>



<a name="1565513"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1565513" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1565513">(May 10 2023 at 01:36)</a>:</h4>
<p>What does <code>supervisorctl status</code> show?</p>



<a name="1565564"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1565564" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1565564">(May 10 2023 at 03:16)</a>:</h4>
<p>This is probably the erlang upgrade.</p>



<a name="1565567"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1565567" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1565567">(May 10 2023 at 03:17)</a>:</h4>
<p>Mmm, maybe?  But the upgrading erlang does restart rabbitmq, and the workers do restart (modulo the new threading stuff in missedmessage_emails, but that's only in <code>main</code>)</p>



<a name="1567136"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567136" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pranav Ashok <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567136">(May 11 2023 at 16:04)</a>:</h4>
<p>I had the same problem. Additionally, the last seen status was being shown as <code>1 day ago</code> for a user who I interacted with a few hours ago. The problem was fixed after running the <code>restart-server</code>script.</p>



<a name="1567138"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567138" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567138">(May 11 2023 at 16:06)</a>:</h4>
<p>What version of Zulip?  Can you show what <code>/var/log/apt/history.log</code> contains?</p>



<a name="1567356"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567356" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567356">(May 11 2023 at 18:55)</a>:</h4>
<p><span class="user-mention" data-user-id="22053">@The One</span> just mentioning you to make sure you've seen the replies.</p>



<a name="1567441"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567441" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567441">(May 11 2023 at 19:36)</a>:</h4>
<p>And <span class="user-mention" data-user-id="26978">@Pranav Ashok</span> as well.</p>



<a name="1567485"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567485" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pranav Ashok <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567485">(May 11 2023 at 19:58)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Start-Date: 2023-05-02  06:56:06
Commandline: /usr/bin/unattended-upgrade
Upgrade: git:amd64 (1:2.25.1-1ubuntu3.10, 1:2.25.1-1ubuntu3.11)
End-Date: 2023-05-02  06:56:07

Start-Date: 2023-05-02  06:56:14
Commandline: /usr/bin/unattended-upgrade
Upgrade: git-man:amd64 (1:2.25.1-1ubuntu3.10, 1:2.25.1-1ubuntu3.11)
End-Date: 2023-05-02  06:56:17

Start-Date: 2023-05-05  06:24:55
Commandline: /usr/bin/unattended-upgrade
Upgrade: libruby2.7:amd64 (2.7.0-5ubuntu1.8, 2.7.0-5ubuntu1.9)
End-Date: 2023-05-05  06:24:55

Start-Date: 2023-05-05  06:25:03
Commandline: /usr/bin/unattended-upgrade
Upgrade: ruby2.7:amd64 (2.7.0-5ubuntu1.8, 2.7.0-5ubuntu1.9)
End-Date: 2023-05-05  06:25:04

Start-Date: 2023-05-07  06:08:12
Commandline: /usr/bin/unattended-upgrade
Upgrade: ruby2.7:amd64 (2.7.0-5ubuntu1.9, 2.7.0-5ubuntu1.10)
End-Date: 2023-05-07  06:08:13

Start-Date: 2023-05-07  06:08:20
Commandline: /usr/bin/unattended-upgrade
Upgrade: libruby2.7:amd64 (2.7.0-5ubuntu1.9, 2.7.0-5ubuntu1.10)
End-Date: 2023-05-07  06:08:21

Start-Date: 2023-05-10  06:50:52
Commandline: /usr/bin/unattended-upgrade
Upgrade: libfreetype6-dev:amd64 (2.10.1-2ubuntu0.2, 2.10.1-2ubuntu0.3), libfreetype6:amd64 (2.10.1-2ubuntu0.2, 2.10.1-2ubuntu0.3), libfreetype-dev:amd64 (2.10.1-2ubuntu0.2, 2.10.1-2ubuntu0.3)
End-Date: 2023-05-10  06:50:53

Start-Date: 2023-05-10  06:50:58
Commandline: /usr/bin/unattended-upgrade
Upgrade: erlang-public-key:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-tftp:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-os-mon:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-base:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-syntax-tools:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-tools:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-ftp:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-runtime-tools:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-xmerl:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-snmp:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-ssl:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-eldap:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-crypto:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-mnesia:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-parsetools:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-asn1:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2), erlang-inets:amd64 (1:22.2.7+dfsg-1, 1:22.2.7+dfsg-1ubuntu0.2)
</code></pre></div>



<a name="1567491"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567491" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567491">(May 11 2023 at 20:02)</a>:</h4>
<p>Was <time datetime="2023-05-10T06:50:58Z">2023-05-10T06:50:58-00:00</time> when you started having problems?  Can you show the end of <code>/var/log/zulip/errors.log</code>?</p>



<a name="1567496"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567496" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pranav Ashok <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567496">(May 11 2023 at 20:05)</a>:</h4>
<p>Here is the last part of the <code>errors.log</code>. Indeed, the erlang upgrade seems to coincide with the errors.</p>
<div class="codehilite"><pre><span></span><code>2023-05-10 06:57:40.056 ERR  [pika.adapters.base_connection] connection_lost: StreamLostError: (&quot;Stream connection lost: ConnectionResetError(104, &#39;Connection reset by peer&#39;)&quot;,)
2023-05-10 06:57:40.056 ERR  [pika.adapters.blocking_connection] Unexpected connection close detected: StreamLostError: (&quot;Stream connection lost: ConnectionResetError(104, &#39;Connection reset by peer&#39;)&quot;,)
2023-05-10 06:57:40.057 WARN [zulip.queue] Failed to send to rabbitmq, trying to reconnect and send again
2023-05-10 06:57:41.368 ERR  [pika.adapters.utils.io_services_utils] _AsyncBaseTransport._produce() failed, aborting connection: error=ConnectionResetError(104, &#39;Connection reset by peer&#39;); sock=&lt;socket.socket fd=27, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=(&#39;127.0.0.1&#39;, 43000)&gt;; Caller&#39;s stack:
Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/b2cdd20dd55ad18cd1e512082a3ec530e6b6ece9/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 1103, in _on_socket_writable
    self._produce()
  File &quot;/srv/zulip-venv-cache/b2cdd20dd55ad18cd1e512082a3ec530e6b6ece9/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 819, in _produce
    num_bytes_sent = self._sigint_safe_send(self._sock,
  File &quot;/srv/zulip-venv-cache/b2cdd20dd55ad18cd1e512082a3ec530e6b6ece9/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 79, in retry_sigint_wrap
    return func(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/b2cdd20dd55ad18cd1e512082a3ec530e6b6ece9/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 861, in _sigint_safe_send
    return sock.send(data)
ConnectionResetError: [Errno 104] Connection reset by peer
Traceback (most recent call last):
  File &quot;/srv/zulip-venv-cache/b2cdd20dd55ad18cd1e512082a3ec530e6b6ece9/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 1103, in _on_socket_writable
    self._produce()
  File &quot;/srv/zulip-venv-cache/b2cdd20dd55ad18cd1e512082a3ec530e6b6ece9/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 819, in _produce
    num_bytes_sent = self._sigint_safe_send(self._sock,
  File &quot;/srv/zulip-venv-cache/b2cdd20dd55ad18cd1e512082a3ec530e6b6ece9/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 79, in retry_sigint_wrap
    return func(*args, **kwargs)
  File &quot;/srv/zulip-venv-cache/b2cdd20dd55ad18cd1e512082a3ec530e6b6ece9/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/utils/io_services_utils.py&quot;, line 861, in _sigint_safe_send
    return sock.send(data)
ConnectionResetError: [Errno 104] Connection reset by peer
2023-05-10 06:57:41.369 ERR  [pika.adapters.base_connection] connection_lost: StreamLostError: (&quot;Stream connection lost: ConnectionResetError(104, &#39;Connection reset by peer&#39;)&quot;,)
2023-05-10 06:57:41.369 ERR  [pika.adapters.blocking_connection] Unexpected connection close detected: StreamLostError: (&quot;Stream connection lost: ConnectionResetError(104, &#39;Connection reset by peer&#39;)&quot;,)
2023-05-10 06:57:41.370 WARN [zulip.queue] Failed to send to rabbitmq, trying to reconnect and send again
</code></pre></div>



<a name="1567498"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567498" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pranav Ashok <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567498">(May 11 2023 at 20:06)</a>:</h4>
<p>I wasn't online much yesterday, so I noticed the problem only today afternoon UTC.</p>



<a name="1567503"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567503" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567503">(May 11 2023 at 20:12)</a>:</h4>
<p>If you look in <code>/var/log/apt/term.log</code>, do you see the following?</p>
<div class="codehilite"><pre><span></span><code>Searching for services which depend on erlang and should be stopped... found: rabbitmq-server.service.
Stopping services which depend on erlang
  rabbitmq-server.service: stopping... done.
Services stopped successfully.
Killing epmd... done.
Unpacking erlang-base (1:22.2.7+dfsg-1ubuntu0.2) over (1:22.2.7+dfsg-1) ...
Preparing to unpack .../17-libfreetype-dev_2.10.1-2ubuntu0.3_amd64.deb ...

[...]

Setting up erlang-base (1:22.2.7+dfsg-1ubuntu0.2) ...
Searching for services which depend on erlang and should be started... found: rabbitmq-server.service.
Starting services which depend on erlang
  rabbitmq-server.service: starting... done.
Services started successfully.
</code></pre></div>



<a name="1567506"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567506" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567506">(May 11 2023 at 20:13)</a>:</h4>
<p>If so, I think the remaining question is why the presence worker didn't come back after rabbitmq fell over.</p>



<a name="1567507"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567507" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567507">(May 11 2023 at 20:15)</a>:</h4>
<p>Can you show:</p>
<div class="codehilite"><pre><span></span><code>grep user_presence /var/log/supervisor/supervisord.log
</code></pre></div>



<a name="1567533"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567533" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pranav Ashok <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567533">(May 11 2023 at 20:39)</a>:</h4>
<p>Yes, it looks like <code>rabbitmq-server.service</code> successfully started after the upgrade. I have the same (or similar) lines in <code>term.log</code>. The grep doesn't give any results.  In fact, there are no entries for 2023-05-10 in <code>supervisord.log</code>.</p>
<div class="codehilite"><pre><span></span><code>2023-05-07 06:00:15,282 INFO waiting for zulip-tornado to stop
2023-05-07 06:00:15,884 INFO stopped: zulip-tornado (exit status 0)
2023-05-07 06:00:15,889 INFO spawned: &#39;zulip-tornado&#39; with pid 2957527
2023-05-07 06:00:17,033 INFO success: zulip-tornado entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2023-05-07 06:00:17,284 INFO waiting for zulip-django to stop
2023-05-07 06:00:18,310 INFO stopped: zulip-django (exit status 0)
2023-05-07 06:00:18,315 INFO spawned: &#39;zulip-django&#39; with pid 2957553
2023-05-07 06:00:19,982 INFO success: zulip-django entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2023-05-11 15:38:35,778 INFO waiting for zulip_events to stop
2023-05-11 15:38:36,277 INFO stopped: zulip_events (exit status 0)
2023-05-11 15:38:36,282 INFO spawned: &#39;zulip_events&#39; with pid 3311850
2023-05-11 15:38:37,284 INFO success: zulip_events entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
2023-05-11 15:38:37,475 INFO waiting for zulip_deliver_scheduled_emails to stop
</code></pre></div>



<a name="1567539"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567539" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567539">(May 11 2023 at 20:40)</a>:</h4>
<p>Ah, you're in the low-memory configuration, which means those exceptions didn't kill the whole process, just individual threads.</p>



<a name="1567541"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567541" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567541">(May 11 2023 at 20:41)</a>:</h4>
<p>Can you show the tail end of <code>/var/log/zulip/events_user_presence.log</code> ?</p>



<a name="1567569"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567569" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pranav Ashok <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567569">(May 11 2023 at 21:04)</a>:</h4>
<p>Interesting - didn't know about the low-memory configuration. Below what level of RAM does it trigger?</p>



<a name="1567574"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567574" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pranav Ashok <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567574">(May 11 2023 at 21:05)</a>:</h4>
<p>I don't have a <code>events_user_presence.log</code> file. Only <code>events.log</code> and <code>events_deliver_scheduled_emails.log</code>.</p>



<a name="1567577"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567577" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567577">(May 11 2023 at 21:05)</a>:</h4>
<p>Ah, right, since the logfile is done at the supervisor level.  Show the <code>events.log</code> from that timeframe?</p>



<a name="1567578"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567578" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567578">(May 11 2023 at 21:07)</a>:</h4>
<p>The low-memory config is used below 3500MiB RAM.</p>



<a name="1567580"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567580" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pranav Ashok <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567580">(May 11 2023 at 21:09)</a>:</h4>
<p>There were too many lines during the timeframe, so here is a <a href="https://pastebin.com/7SQZfP9m">pastebin paste</a>.</p>



<a name="1567591"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567591" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567591">(May 11 2023 at 21:17)</a>:</h4>
<p>Hm, OK.  Unfortunately, everything's muddled together, and it's very much not clear on the final state.</p>
<p>We may have to debug this by replicating it locally.  Our <em>expectation</em> is certainly that the workers would be robust to a rabbitmq restart, which seems to not be accurate.</p>



<a name="1567592"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567592" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567592">(May 11 2023 at 21:18)</a>:</h4>
<p>I see a <code>2023-05-10 06:51:07.149 INFO [process_queue] launching queue worker thread user_presence</code> but from what you observed, that must not have gotten into a happy state to consume from the queue.</p>



<a name="1567691"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567691" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The One <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567691">(May 11 2023 at 23:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Users.20display.20as.20offline/near/1565513">said</a>:</p>
<blockquote>
<p>What does <code>supervisorctl status</code> show?</p>
</blockquote>
<p><a href="/user_uploads/2/21/QotmauCcZBoQjGnhDAwtM7CS/Screenshot-2023-05-11-at-4.15.20-PM.png">Screenshot-2023-05-11-at-4.15.20-PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/21/QotmauCcZBoQjGnhDAwtM7CS/Screenshot-2023-05-11-at-4.15.20-PM.png" title="Screenshot-2023-05-11-at-4.15.20-PM.png"><img src="/user_uploads/2/21/QotmauCcZBoQjGnhDAwtM7CS/Screenshot-2023-05-11-at-4.15.20-PM.png"></a></div>



<a name="1567696"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567696" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The One <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567696">(May 11 2023 at 23:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Users.20display.20as.20offline/near/1567138">said</a>:</p>
<blockquote>
<p>What version of Zulip?  Can you show what <code>/var/log/apt/history.log</code> contains?</p>
</blockquote>
<p>I'm showing this:<br>
<a href="/user_uploads/2/86/_AhC9FOSZ4MnBtOqQvTa_MlA/Screenshot-2023-05-11-at-4.16.51-PM.png">Screenshot-2023-05-11-at-4.16.51-PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/86/_AhC9FOSZ4MnBtOqQvTa_MlA/Screenshot-2023-05-11-at-4.16.51-PM.png" title="Screenshot-2023-05-11-at-4.16.51-PM.png"><img src="/user_uploads/2/86/_AhC9FOSZ4MnBtOqQvTa_MlA/Screenshot-2023-05-11-at-4.16.51-PM.png"></a></div>



<a name="1567700"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567700" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The One <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567700">(May 11 2023 at 23:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/Users.20display.20as.20offline/near/1567356">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="22053">The One</span> just mentioning you to make sure you've seen the replies.</p>
</blockquote>
<p>Thanks <span class="user-mention" data-user-id="7">@Tim Abbott</span>   I'm seeing them now. I have ran some of the commands <span class="user-mention" data-user-id="12178">@Alex Vandiver</span>  requested and have posted the results.  So I'm assuming we don't have a fix for this at the moment?</p>



<a name="1567701"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567701" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567701">(May 11 2023 at 23:22)</a>:</h4>
<p>I expect restarting <code>zulip-workers:zulip-events</code> will fix the issue for your installation -- it sounds like the thread within that process that is responsible for presence updates is borked.</p>



<a name="1567702"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567702" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567702">(May 11 2023 at 23:22)</a>:</h4>
<p>The thing we don't have a fix for is how to prevent this from happening again the next time <code>erlang</code> or <code>rabbitmq-server</code> is upgraded and restarted, since it is a design goal to not have upgrading those packages able to break parts of the Zulip server.</p>



<a name="1567709"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567709" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The One <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567709">(May 11 2023 at 23:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/Users.20display.20as.20offline/near/1567701">said</a>:</p>
<blockquote>
<p>I expect restarting <code>zulip-workers:zulip-events</code> will fix the issue for your installation -- it sounds like the thread within that process that is responsible for presence updates is borked.</p>
</blockquote>
<p>Thanks, <span class="user-mention" data-user-id="7">@Tim Abbott</span> .   Sorry, I'm a linux noob. so if I just run <br>
<code>Supervisorctl restart</code>this should restart all services including the ones you mentioned , correct?</p>



<a name="1567712"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567712" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567712">(May 11 2023 at 23:42)</a>:</h4>
<p><a href="https://zulip.readthedocs.io/en/latest/production/troubleshooting.html">https://zulip.readthedocs.io/en/latest/production/troubleshooting.html</a> documents this stuff, but you can use <code>./scripts/restart-server</code> or <code>supervisorctl restart all</code> if you like; it'll just add a few seconds of downtime over just restarting the one service.</p>



<a name="1567721"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Users%20display%20as%20offline/near/1567721" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The One <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Users.20display.20as.20offline.html#1567721">(May 12 2023 at 00:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/Users.20display.20as.20offline/near/1567712">said</a>:</p>
<blockquote>
<p><a href="https://zulip.readthedocs.io/en/latest/production/troubleshooting.html">https://zulip.readthedocs.io/en/latest/production/troubleshooting.html</a> documents this stuff, but you can use <code>./scripts/restart-server</code> or <code>supervisorctl restart all</code> if you like; it'll just add a few seconds of downtime over just restarting the one service.</p>
</blockquote>
<p>Thanks, <span class="user-mention" data-user-id="7">@Tim Abbott</span>  <span class="user-mention" data-user-id="12178">@Alex Vandiver</span></p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>