<html>
<head><meta charset="utf-8"><title>Upgrades in unprivileged LXC container · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html">Upgrades in unprivileged LXC container</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1563118"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563118" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563118">(May 07 2023 at 01:14)</a>:</h4>
<p>I tried to upgrade from Zulip Server 6.1 to 7.0 beta1... it failed. I don't know why. I tried twice, same result. I'm running version 6.1 on Proxmox LXC Debian container. Glad I took a snapshot before attempting the upgrade.</p>



<a name="1563128"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563128" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563128">(May 07 2023 at 03:24)</a>:</h4>
<p><span class="user-mention" data-user-id="26472">@Louis-Marie Gendron</span> can you post the error that was printed when the upgrade failed?</p>



<a name="1563216"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563216" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563216">(May 07 2023 at 15:27)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I kept the upgrade.log:</p>
<p><a href="/user_uploads/2/92/sCbPZ2TNOe1uJdGslop5dInO/upgrade.log">upgrade.log</a></p>



<a name="1563463"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563463" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563463">(May 08 2023 at 13:20)</a>:</h4>
<p><span class="user-mention" data-user-id="26472">@Louis-Marie Gendron</span>: It looks like your upgrades to previous versions of Zulip have also failed:</p>
<div class="codehilite"><pre><span></span><code>2022-03-02 05:19:53,626 upgrade-zulip-stage-2: Applying Puppet changes...
Notice: Compiled catalog for chat.hs-mittweida.de in environment production in 1.68 seconds
Notice: /Stage[main]/Zulip::Smokescreen/Tidy[/usr/local/bin/smokescreen-*]: Tidying 1 files
Notice: /Stage[main]/Zulip::Golang/Zulip::External_dep[golang]/Tidy[/srv/zulip-golang-*]: Tidying 1 files
Notice: /Stage[main]/Zulip::Smokescreen/Zulip::External_dep[smokescreen-src]/Tidy[/srv/zulip-smokescreen-src-*]: Tidying 1 files
Notice: /Stage[main]/Zulip::Camo/Zulip::External_dep[go-camo]/Tidy[/srv/zulip-go-camo-*]: Tidying 1 files
Notice: /Stage[main]/Zulip::Apt_repository/Exec[setup_apt_repo]/returns: executed successfully
Notice: /Stage[main]/Zulip::Smokescreen/File[/usr/local/bin/smokescreen-dc403015f563eadc556a61870c6ad327688abe88-go-1.17.3]/ensure: removed
Notice: /Stage[main]/Zulip::Profile::App_frontend/File[/etc/nginx/sites-available/zulip-enterprise]/content: content changed &#39;{md5}75c790b7bb2704adc21dba01fe87245d&#39; to &#39;{md5}85f086aa6977456cc5f25612ecb199b9&#39;
Notice: /Stage[main]/Zulip::Profile::App_frontend/File[/etc/letsencrypt/renewal-hooks/deploy/001-nginx.sh]/ensure: defined content as &#39;{md5}980fe968383378cccb8fb8806611ea20&#39;
Notice: /Stage[main]/Zulip::Profile::App_frontend/Exec[fix-standalone-certbot]/returns: Saving debug log to /var/log/letsencrypt/letsencrypt.log
Notice: /Stage[main]/Zulip::Profile::App_frontend/Exec[fix-standalone-certbot]/returns: Plugins selected: Authenticator webroot, Installer None
Notice: /Stage[main]/Zulip::Profile::App_frontend/Exec[fix-standalone-certbot]/returns: Enter email address (used for urgent renewal and security notices) (Enter &#39;c&#39; to
Notice: /Stage[main]/Zulip::Profile::App_frontend/Exec[fix-standalone-certbot]/returns: cancel): An unexpected error occurred:
Notice: /Stage[main]/Zulip::Profile::App_frontend/Exec[fix-standalone-certbot]/returns: EOFError
Notice: /Stage[main]/Zulip::Profile::App_frontend/Exec[fix-standalone-certbot]/returns: Please see the logfiles in /var/log/letsencrypt for more details.
Error: &#39;/home/zulip/deployments/2022-03-02-06-19-17/scripts/lib/fix-standalone-certbot&#39; returned 1 instead of one of [0]
Error: /Stage[main]/Zulip::Profile::App_frontend/Exec[fix-standalone-certbot]/returns: change from &#39;notrun&#39; to [&#39;0&#39;] failed: &#39;/home/zulip/deployments/2022-03-02-06-19-17/scripts/lib/fix-standalone-certbot&#39; returned 1 instead of one of [0]
Error: /Stage[main]/Zulip::Nginx/Service[nginx]: Failed to call refresh: Systemd restart for nginx failed!
journalctl log for nginx:
-- Logs begin at Sun 2022-02-27 17:40:24 CET, end at Wed 2022-03-02 06:20:07 CET. --
Mar 02 06:20:07 chat systemd[1]: Stopping A high performance web server and a reverse proxy server...
Mar 02 06:20:07 chat systemd[1]: nginx.service: Succeeded.
Mar 02 06:20:07 chat systemd[1]: Stopped A high performance web server and a reverse proxy server.
Mar 02 06:20:07 chat systemd[1]: Starting A high performance web server and a reverse proxy server...
Mar 02 06:20:07 chat nginx[48267]: nginx: [emerg] BIO_new_file(&quot;/etc/ssl/certs/zulip.combined-chain.crt&quot;) failed (SSL: error:02001002:system library:fopen:No such file or directory:fopen(&#39;/etc/ssl/certs/zulip.combined-chain.crt&#39;,&#39;r&#39;) error:2006D080:BIO routines:BIO_new_file:no such file)
Mar 02 06:20:07 chat nginx[48267]: nginx: configuration file /etc/nginx/nginx.conf test failed
Mar 02 06:20:07 chat systemd[1]: nginx.service: Control process exited, code=exited, status=1/FAILURE
Mar 02 06:20:07 chat systemd[1]: nginx.service: Failed with result &#39;exit-code&#39;.
Mar 02 06:20:07 chat systemd[1]: Failed to start A high performance web server and a reverse proxy server.

Error: /Stage[main]/Zulip::Nginx/Service[nginx]: Systemd restart for nginx failed!
</code></pre></div>
<p>It looks like, from the cert presented by <a href="https://chat.hs-mittweida.de/">https://chat.hs-mittweida.de/</a>, that you're not using certbot.  Can you show (in a <a href="https://zulip.com/help/code-blocks">code block</a>) the output of running, as root:</p>
<div class="codehilite"><pre><span></span><code>ls /etc/letsencrypt/renewal/*.conf

certbot certificates
</code></pre></div>



<a name="1563588"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563588" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563588">(May 08 2023 at 16:03)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> doesn't look like my upgrade.log, I did not attempt to upgrade in march 2022.</p>
<div class="codehilite"><pre><span></span><code>2023-05-04 01:02:33,026 upgrade-zulip-stage-2: Applying Puppet changes...
</code></pre></div>



<a name="1563590"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563590" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563590">(May 08 2023 at 16:03)</a>:</h4>
<p>Grr.  Sorry, too many upgrade logs.   Let me look again.</p>



<a name="1563594"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563594" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563594">(May 08 2023 at 16:05)</a>:</h4>
<div class="codehilite"><pre><span></span><code>2023-05-04 01:03:53,230 upgrade-zulip-stage-2: Stopping Zulip...
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2023-05-03-21-01-18/./scripts/stop-server&quot;, line 53, in &lt;module&gt;
    services = list_supervisor_processes(services, only_running=True)
  File &quot;/home/zulip/deployments/2023-05-03-21-01-18/./scripts/../scripts/lib/supervisor.py&quot;, line 34, in list_supervisor_processes
    processes = rpc().supervisor.getAllProcessInfo()
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1116, in __call__
    return self.__send(self.__name, args)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1456, in __request
    response = self.__transport.request(
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1160, in request
    return self.single_request(host, handler, request_body, verbose)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1172, in single_request
    http_conn = self.send_request(host, handler, request_body, verbose)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1285, in send_request
    self.send_content(connection, request_body)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1315, in send_content
    connection.endheaders(request_body)
  File &quot;/usr/lib/python3.9/http/client.py&quot;, line 1250, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File &quot;/usr/lib/python3.9/http/client.py&quot;, line 1010, in _send_output
    self.send(msg)
  File &quot;/usr/lib/python3.9/http/client.py&quot;, line 950, in send
    self.connect()
  File &quot;/home/zulip/deployments/2023-05-03-21-01-18/./scripts/../scripts/lib/supervisor.py&quot;, line 10, in connect
    self.sock.connect(self.host)
FileNotFoundError: [Errno 2] No such file or directory
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2023-05-03-21-01-18/scripts/lib/upgrade-zulip-stage-2&quot;, line 528, in &lt;module&gt;
    shutdown_server()
  File &quot;/home/zulip/deployments/2023-05-03-21-01-18/scripts/lib/upgrade-zulip-stage-2&quot;, line 202, in shutdown_server
    subprocess.check_call([&quot;./scripts/stop-server&quot;], preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python3.9/subprocess.py&quot;, line 373, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./scripts/stop-server&#39;]&#39; returned non-zero exit status 1.
</code></pre></div>
<p>OK, so this is a failure talking to supervisor's socket.</p>



<a name="1563597"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563597" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563597">(May 08 2023 at 16:05)</a>:</h4>
<p>I assume <code>supervisorctl status</code> looks reasonable?</p>



<a name="1563599"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563599" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563599">(May 08 2023 at 16:07)</a>:</h4>
<p>What OS is this?  Can you show:</p>
<div class="codehilite"><pre><span></span><code>ls -ld /var/run /run /var/run/supervisor.sock
</code></pre></div>



<a name="1563670"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563670" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563670">(May 08 2023 at 16:58)</a>:</h4>
<p><code>supervisorctl status</code></p>
<blockquote>
<p>root@ct-zulip:~# supervisorctl status<br>
go-camo                                                         RUNNING   pid 600, uptime 2 days, 1:43:14<br>
process-fts-updates                                             RUNNING   pid 83643, uptime 1 day, 6:53:39<br>
smokescreen                                                     RUNNING   pid 601, uptime 2 days, 1:43:14<br>
zulip-django                                                    RUNNING   pid 83654, uptime 1 day, 6:53:35<br>
zulip-tornado                                                   RUNNING   pid 83646, uptime 1 day, 6:53:38<br>
zulip-workers:zulip_events_deferred_work                        RUNNING   pid 83500, uptime 1 day, 6:54:00<br>
zulip-workers:zulip_events_digest_emails                        RUNNING   pid 83505, uptime 1 day, 6:53:59<br>
zulip-workers:zulip_events_email_mirror                         RUNNING   pid 83510, uptime 1 day, 6:53:57<br>
zulip-workers:zulip_events_email_senders                        RUNNING   pid 83515, uptime 1 day, 6:53:56<br>
zulip-workers:zulip_events_embed_links                          RUNNING   pid 83520, uptime 1 day, 6:53:55<br>
zulip-workers:zulip_events_embedded_bots                        RUNNING   pid 83527, uptime 1 day, 6:53:53<br>
zulip-workers:zulip_events_error_reports                        RUNNING   pid 83532, uptime 1 day, 6:53:52<br>
zulip-workers:zulip_events_invites                              RUNNING   pid 83537, uptime 1 day, 6:53:51<br>
zulip-workers:zulip_events_missedmessage_emails                 RUNNING   pid 83542, uptime 1 day, 6:53:49<br>
zulip-workers:zulip_events_missedmessage_mobile_notifications   RUNNING   pid 83605, uptime 1 day, 6:53:48<br>
zulip-workers:zulip_events_outgoing_webhooks                    RUNNING   pid 83611, uptime 1 day, 6:53:47<br>
zulip-workers:zulip_events_user_activity                        RUNNING   pid 83616, uptime 1 day, 6:53:45<br>
zulip-workers:zulip_events_user_activity_interval               RUNNING   pid 83623, uptime 1 day, 6:53:44<br>
zulip-workers:zulip_events_user_presence                        RUNNING   pid 83628, uptime 1 day, 6:53:43<br>
zulip_deliver_scheduled_emails                                  RUNNING   pid 83633, uptime 1 day, 6:53:41<br>
zulip_deliver_scheduled_messages                                RUNNING   pid 83638, uptime 1 day, 6:53:40</p>
</blockquote>
<p><code>ls -ld /var/run /run /var/run/supervisor.sock</code></p>
<blockquote>
<p>drwxr-xr-x 18 root  root  580 May  8 12:52 /run<br>
lrwxrwxrwx  1 root  root    4 Dec 19 14:43 /var/run -&gt; /run<br>
srwx------  1 zulip zulip   0 May  6 11:10 /var/run/supervisor.sock</p>
</blockquote>
<p>It's running in a Proxmox LXC container : <br>
<code>OS: Debian GNU/Linux 11 (bullseye) x86_64</code> <code>Kernel: 5.15.107-1-pve</code></p>



<a name="1563857"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563857" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563857">(May 08 2023 at 19:06)</a>:</h4>
<p>Hm.  It seems like the LXC property is likely being the problematic part, but I don't think there's anything new in the 7.0 codepath vs 6.x which would be notable here.  And the UNIX socket exists as expected, and we're running as the <code>zulip</code> user.</p>



<a name="1563970"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1563970" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1563970">(May 08 2023 at 20:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/2-general/topic/Zulip.207.2E0.20upgrades/near/1563857">said</a>:</p>
<blockquote>
<p>Hm.  It seems like the LXC property is likely being the problematic part, but I don't think there's anything new in the 7.0 codepath vs 6.x which would be notable here.  And the UNIX socket exists as expected, and we're running as the <code>zulip</code> user.</p>
</blockquote>
<p>Does this means I'm stuck with 6.1? I won't be able to upgrade to 7.0 when final release is available?</p>



<a name="1564041"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1564041" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1564041">(May 08 2023 at 21:18)</a>:</h4>
<p>No, it means we're not sure what the problem is on your system yet.</p>



<a name="1564042"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1564042" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1564042">(May 08 2023 at 21:19)</a>:</h4>
<p>Yeah, we do want to get to the bottom of this, but we've been distracted wit a few other issues today.  I may have more things to try tomorrow.</p>



<a name="1564063"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1564063" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1564063">(May 08 2023 at 22:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/2-general/topic/Zulip.207.2E0.20upgrades/near/1564041">said</a>:</p>
<blockquote>
<p>No, it means we're not sure what the problem is on your system yet.</p>
</blockquote>
<p>Ok. No pressure then. Zulip Server 6.1 is working fine. I might be missing a package on my Debian LXC container? This is strange. Initial Zulip install was done with :</p>
<div class="codehilite"><pre><span></span><code>cd $(mktemp -d)
curl -fLO https://download.zulip.com/server/zulip-server-latest.tar.gz
tar -xf zulip-server-latest.tar.gz
</code></pre></div>
<p>then</p>
<div class="codehilite"><pre><span></span><code>./zulip-server-*/scripts/setup/install --certbot \
    --email=YOUR_EMAIL --hostname=YOUR_HOSTNAME
</code></pre></div>
<p>Users and messages were imported from RocketChat.</p>



<a name="1564064"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1564064" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1564064">(May 08 2023 at 22:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/2-general/topic/Zulip.207.2E0.20upgrades/near/1564042">said</a>:</p>
<blockquote>
<p>Yeah, we do want to get to the bottom of this, but we've been distracted wit a few other issues today.  I may have more things to try tomorrow.</p>
</blockquote>
<p>If I can help, let me know. I can always do a snapshot, try anything, and rollback if anything goes bad. My timezone is EDT and I'm working during the day, might not react instantly.</p>



<a name="1567936"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1567936" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1567936">(May 12 2023 at 12:25)</a>:</h4>
<p>Hi! Did you find time to investigate my failed attempt to upgrade to 7.0beta1?</p>



<a name="1567997"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1567997" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1567997">(May 12 2023 at 14:17)</a>:</h4>
<p><span class="user-mention" data-user-id="26472">@Louis-Marie Gendron</span>: It's a stumper!</p>
<p>Let's see -- what's the history of this instance?  You installed it at 6.1, and imported RocketChat data into it -- so it's never been upgraded before?</p>
<p>Can you try showing the output of:</p>
<div class="codehilite"><pre><span></span><code>su - zulip &#39;supervisorctl status&#39;
</code></pre></div>



<a name="1567998"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1567998" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1567998">(May 12 2023 at 14:22)</a>:</h4>
<p>And is this an <em>unprivileged</em> container?</p>



<a name="1568038"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568038" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568038">(May 12 2023 at 15:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/2-general/topic/Zulip.207.2E0.20upgrades/near/1567997">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="26472">Louis-Marie Gendron</span>: It's a stumper!</p>
<p>Let's see -- what's the history of this instance?  You installed it at 6.1, and imported RocketChat data into it -- so it's never been upgraded before?</p>
<p>Can you try showing the output of:</p>
<p><div class="codehilite"><pre><span></span><code>su - zulip &#39;supervisorctl status&#39;
</code></pre></div><br>
</p>
</blockquote>
<p>Exactly. First install ever was 6.1 and imported RocketChat. Never been upgraded.</p>



<a name="1568041"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568041" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568041">(May 12 2023 at 16:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/2-general/topic/Zulip.207.2E0.20upgrades/near/1567998">said</a>:</p>
<blockquote>
<p>And is this an <em>unprivileged</em> container?</p>
</blockquote>
<p>Yes, unprivileged.</p>
<p><a href="/user_uploads/2/27/2YSQXg_XQI9JpEIt2lZcNs7c/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/27/2YSQXg_XQI9JpEIt2lZcNs7c/image.png" title="image.png"><img src="/user_uploads/2/27/2YSQXg_XQI9JpEIt2lZcNs7c/image.png"></a></div>



<a name="1568043"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568043" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568043">(May 12 2023 at 16:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/2-general/topic/Zulip.207.2E0.20upgrades/near/1567997">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="26472">Louis-Marie Gendron</span>: It's a stumper!</p>
<p>Let's see -- what's the history of this instance?  You installed it at 6.1, and imported RocketChat data into it -- so it's never been upgraded before?</p>
<p>Can you try showing the output of:</p>
<p><div class="codehilite"><pre><span></span><code>su - zulip &#39;supervisorctl status&#39;
</code></pre></div><br>
</p>
</blockquote>
<p>Are you sure about the command? without single quote :</p>
<div class="codehilite"><pre><span></span><code>root@ct-zulip:~# su - zulip supervisorctl status
/usr/bin/supervisorctl: line 3: import: command not found
/usr/bin/supervisorctl: line 4: import: command not found
/usr/bin/supervisorctl: line 7: __requires__: command not found
/usr/bin/supervisorctl: line 9: try:: command not found
/usr/bin/supervisorctl: line 10: from: command not found
/usr/bin/supervisorctl: line 11: except: command not found
/usr/bin/supervisorctl: line 12: try:: command not found
/usr/bin/supervisorctl: line 13: from: command not found
/usr/bin/supervisorctl: line 14: except: command not found
/usr/bin/supervisorctl: line 15: from: command not found
/usr/bin/supervisorctl: supervisorctl: line 18: syntax error near unexpected token `(&#39;
/usr/bin/supervisorctl: supervisorctl: line 18: `def importlib_load_entry_point(spec, group, name):&#39;
</code></pre></div>



<a name="1568044"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568044" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568044">(May 12 2023 at 16:04)</a>:</h4>
<p>with single quote:</p>
<div class="codehilite"><pre><span></span><code>root@ct-zulip:~# su - zulip &#39;supervisorctl status&#39;
-bash: supervisorctl status: No such file or directory
</code></pre></div>



<a name="1568045"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568045" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568045">(May 12 2023 at 16:04)</a>:</h4>
<p>Ah, sorry:</p>
<div class="codehilite"><pre><span></span><code>su - zulip bash -c &#39;supervisorctl status&#39;
</code></pre></div>



<a name="1568046"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568046" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568046">(May 12 2023 at 16:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/2-general/topic/Zulip.207.2E0.20upgrades/near/1568045">said</a>:</p>
<blockquote>
<p>Ah, sorry:</p>
<div class="codehilite"><pre><span></span><code>su - zulip bash -c &#39;supervisorctl status&#39;
````
</code></pre></div>
<p>root@ct-zulip:~# su - zulip bash -c 'supervisorctl status'<br>
go-camo                                                         RUNNING   pid 603, uptime 23:20:36<br>
process-fts-updates                                             RUNNING   pid 609, uptime 23:20:36<br>
smokescreen                                                     RUNNING   pid 604, uptime 23:20:36<br>
zulip-django                                                    RUNNING   pid 605, uptime 23:20:36<br>
zulip-tornado                                                   RUNNING   pid 606, uptime 23:20:36<br>
zulip-workers:zulip_events_deferred_work                        RUNNING   pid 610, uptime 23:20:36<br>
zulip-workers:zulip_events_digest_emails                        RUNNING   pid 611, uptime 23:20:36<br>
zulip-workers:zulip_events_email_mirror                         RUNNING   pid 612, uptime 23:20:36<br>
zulip-workers:zulip_events_email_senders                        RUNNING   pid 617, uptime 23:20:36<br>
zulip-workers:zulip_events_embed_links                          RUNNING   pid 613, uptime 23:20:36<br>
zulip-workers:zulip_events_embedded_bots                        RUNNING   pid 614, uptime 23:20:36<br>
zulip-workers:zulip_events_error_reports                        RUNNING   pid 615, uptime 23:20:36<br>
zulip-workers:zulip_events_invites                              RUNNING   pid 616, uptime 23:20:36<br>
zulip-workers:zulip_events_missedmessage_emails                 RUNNING   pid 618, uptime 23:20:36<br>
zulip-workers:zulip_events_missedmessage_mobile_notifications   RUNNING   pid 619, uptime 23:20:36<br>
zulip-workers:zulip_events_outgoing_webhooks                    RUNNING   pid 620, uptime 23:20:36<br>
zulip-workers:zulip_events_user_activity                        RUNNING   pid 621, uptime 23:20:36<br>
zulip-workers:zulip_events_user_activity_interval               RUNNING   pid 622, uptime 23:20:36<br>
zulip-workers:zulip_events_user_presence                        RUNNING   pid 623, uptime 23:20:36<br>
zulip_deliver_scheduled_emails                                  RUNNING   pid 607, uptime 23:20:36<br>
zulip_deliver_scheduled_messages                                RUNNING   pid 608, uptime 23:20:36</p>
<p><div class="codehilite"><pre><span></span><code>
</code></pre></div><br>
</p>
</blockquote>



<a name="1568047"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568047" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568047">(May 12 2023 at 16:08)</a>:</h4>
<p>Hm.  And this fails?</p>
<div class="codehilite"><pre><span></span><code>sudo -i -u zulip
cd ~/deployments/current
./scripts/restart-server
</code></pre></div>
<p>(given your above report, I expect this will fail immediately and do nothing -- but if it works, it will result in a very short (seconds) interruption of service of Zulip)</p>



<a name="1568048"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568048" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568048">(May 12 2023 at 16:09)</a>:</h4>
<p>sudo is not installed on this LXC Debian container... the default user is root in this container.</p>



<a name="1568049"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568049" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568049">(May 12 2023 at 16:10)</a>:</h4>
<p>OK, so:</p>
<div class="codehilite"><pre><span></span><code>su - zulip
cd ~/deployments/current
./scripts/restart-server
</code></pre></div>



<a name="1568054"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568054" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568054">(May 12 2023 at 16:12)</a>:</h4>
<div class="codehilite"><pre><span></span><code>zulip@ct-zulip:~/deployments/current$ ./scripts/restart-server
2023-05-12 16:11:43,047 restart-server: Running syntax and database checks
System check identified no issues (15 silenced).
2023-05-12 16:11:44,334 restart-server: Restarting zulip-workers:zulip_events_deferred_work
zulip-workers:zulip_events_deferred_work: stopped
zulip-workers:zulip_events_deferred_work: started
2023-05-12 16:11:45,689 restart-server: Restarting zulip-workers:zulip_events_digest_emails
zulip-workers:zulip_events_digest_emails: stopped
zulip-workers:zulip_events_digest_emails: started
2023-05-12 16:11:47,045 restart-server: Restarting zulip-workers:zulip_events_email_mirror
zulip-workers:zulip_events_email_mirror: stopped
zulip-workers:zulip_events_email_mirror: started
2023-05-12 16:11:48,408 restart-server: Restarting zulip-workers:zulip_events_email_senders
zulip-workers:zulip_events_email_senders: stopped
zulip-workers:zulip_events_email_senders: started
2023-05-12 16:11:49,770 restart-server: Restarting zulip-workers:zulip_events_embed_links
zulip-workers:zulip_events_embed_links: stopped
zulip-workers:zulip_events_embed_links: started
2023-05-12 16:11:51,134 restart-server: Restarting zulip-workers:zulip_events_embedded_bots
zulip-workers:zulip_events_embedded_bots: stopped
zulip-workers:zulip_events_embedded_bots: started
2023-05-12 16:11:52,503 restart-server: Restarting zulip-workers:zulip_events_error_reports
zulip-workers:zulip_events_error_reports: stopped
zulip-workers:zulip_events_error_reports: started
2023-05-12 16:11:53,871 restart-server: Restarting zulip-workers:zulip_events_invites
zulip-workers:zulip_events_invites: stopped
zulip-workers:zulip_events_invites: started
2023-05-12 16:11:55,244 restart-server: Restarting zulip-workers:zulip_events_missedmessage_emails
zulip-workers:zulip_events_missedmessage_emails: stopped
zulip-workers:zulip_events_missedmessage_emails: started
2023-05-12 16:11:56,631 restart-server: Restarting zulip-workers:zulip_events_missedmessage_mobile_notifications
zulip-workers:zulip_events_missedmessage_mobile_notifications: stopped
zulip-workers:zulip_events_missedmessage_mobile_notifications: started
2023-05-12 16:11:58,015 restart-server: Restarting zulip-workers:zulip_events_outgoing_webhooks
zulip-workers:zulip_events_outgoing_webhooks: stopped
zulip-workers:zulip_events_outgoing_webhooks: started
2023-05-12 16:11:59,386 restart-server: Restarting zulip-workers:zulip_events_user_activity
zulip-workers:zulip_events_user_activity: stopped
zulip-workers:zulip_events_user_activity: started
2023-05-12 16:12:00,755 restart-server: Restarting zulip-workers:zulip_events_user_activity_interval
zulip-workers:zulip_events_user_activity_interval: stopped
zulip-workers:zulip_events_user_activity_interval: started
2023-05-12 16:12:02,130 restart-server: Restarting zulip-workers:zulip_events_user_presence
zulip-workers:zulip_events_user_presence: stopped
zulip-workers:zulip_events_user_presence: started
2023-05-12 16:12:03,489 restart-server: Restarting zulip_deliver_scheduled_emails
zulip_deliver_scheduled_emails: stopped
zulip_deliver_scheduled_emails: started
2023-05-12 16:12:05,581 restart-server: Restarting zulip_deliver_scheduled_messages
zulip_deliver_scheduled_messages: stopped
zulip_deliver_scheduled_messages: started
2023-05-12 16:12:06,707 restart-server: Restarting process-fts-updates
process-fts-updates: stopped
process-fts-updates: started
2023-05-12 16:12:08,005 restart-server: Restarting Tornado process
zulip-tornado: stopped
zulip-tornado: started
2023-05-12 16:12:09,370 restart-server: Restarting django server
zulip-django: stopped
zulip-django: started
2023-05-12 16:12:11,792 restart-server: Done!
Zulip restarted successfully!
</code></pre></div>



<a name="1568056"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568056" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568056">(May 12 2023 at 16:13)</a>:</h4>
<p>Oho!  That's fascinating.</p>



<a name="1568057"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568057" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568057">(May 12 2023 at 16:14)</a>:</h4>
<p>The story of my life!</p>



<a name="1568058"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568058" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568058">(May 12 2023 at 16:14)</a>:</h4>
<p>So this has to do with how we're attempting to drop privileges to the zulip user, from root, in the upgrade script.  The uid-mapping shenanigans of unprivileged containers are at fault here somehow.</p>



<a name="1568059"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568059" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568059">(May 12 2023 at 16:15)</a>:</h4>
<p>I saw beta2 is out,  should I try?</p>



<a name="1568060"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568060" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568060">(May 12 2023 at 16:16)</a>:</h4>
<p>There's nothing relevant to this that's changed in beta2.  You can give it a try, but I fully expect you'll see the exact same message.</p>
<p>The way we drop privileges has certainly not changed recently (or in years), so this isn't a regression (and thus probably not a release blocker).  But we're certainly still interested in solving it, to be clear!</p>
<p>Let me get you some python to try running.</p>



<a name="1568061"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568061" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568061">(May 12 2023 at 16:17)</a>:</h4>
<p>Ok! It's lunch time here... I'll be back in a few minutes.</p>



<a name="1568065"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568065" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568065">(May 12 2023 at 16:23)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="2" href="/#narrow/stream/2-general/topic/Zulip.207.2E0.20upgrades">#general &gt; Zulip 7.0 upgrades</a> by <span class="user-mention silent" data-user-id="12178">Alex Vandiver</span>.</p>



<a name="1568069"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568069" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568069">(May 12 2023 at 16:24)</a>:</h4>
<p>OK, try, as root, running <code>python3</code> and then pasting in:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pwd</span>

<span class="n">uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s2">"/home/zulip/deployments/current"</span><span class="p">)</span><span class="o">.</span><span class="n">st_uid</span>
<span class="nb">print</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="s2">"zulip"</span><span class="p">))</span>

<span class="n">pwent</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">pwent</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">socket</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">"/var/run/supervisor.sock"</span><span class="p">)</span>
</code></pre></div>



<a name="1568083"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568083" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568083">(May 12 2023 at 16:38)</a>:</h4>
<p>os.setgid(<strong>pewnt</strong>.pw_gid) ? a typo?</p>



<a name="1568084"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568084" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568084">(May 12 2023 at 16:39)</a>:</h4>
<p>Yup, sorry! (fixed above)</p>



<a name="1568088"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568088" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568088">(May 12 2023 at 16:40)</a>:</h4>
<p><a href="/user_uploads/2/ae/4CkVu9G8xNjMeq9trNBFXx7I/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/ae/4CkVu9G8xNjMeq9trNBFXx7I/image.png" title="image.png"><img src="/user_uploads/2/ae/4CkVu9G8xNjMeq9trNBFXx7I/image.png"></a></div>



<a name="1568089"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568089" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568089">(May 12 2023 at 16:40)</a>:</h4>
<p>...huh.  That all looks fine.</p>



<a name="1568090"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568090" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568090">(May 12 2023 at 16:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container/near/1568084">said</a>:</p>
<blockquote>
<p>Yup, sorry! (fixed above)</p>
</blockquote>
<p>wasn't sure if it was intentional.. ;)</p>



<a name="1568092"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568092" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568092">(May 12 2023 at 16:41)</a>:</h4>
<p>Either I'm doing something wrong, or that's exactly what was failing before, and isn't now.</p>



<a name="1568094"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568094" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568094">(May 12 2023 at 16:41)</a>:</h4>
<p>I guess try upgrading to beta2, and we'll see if it fails in the same way?</p>



<a name="1568095"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568095" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568095">(May 12 2023 at 16:42)</a>:</h4>
<p>Ok. I have still time before my first meeting in the afternoon...</p>



<a name="1568099"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568099" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568099">(May 12 2023 at 16:51)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Reading package lists...
Building dependency tree...
Reading state information...
Calculating upgrade...
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
2023-05-12 16:50:26,938 upgrade-zulip-stage-2: Stopping Zulip...
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2023-05-12-12-47-56/./scripts/stop-server&quot;, line 53, in &lt;module&gt;
    services = list_supervisor_processes(services, only_running=True)
  File &quot;/home/zulip/deployments/2023-05-12-12-47-56/./scripts/../scripts/lib/supervisor.py&quot;, line 34, in list_supervisor_processes
    processes = rpc().supervisor.getAllProcessInfo()
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1116, in __call__
    return self.__send(self.__name, args)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1456, in __request
    response = self.__transport.request(
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1160, in request
    return self.single_request(host, handler, request_body, verbose)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1172, in single_request
    http_conn = self.send_request(host, handler, request_body, verbose)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1285, in send_request
    self.send_content(connection, request_body)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1315, in send_content
    connection.endheaders(request_body)
  File &quot;/usr/lib/python3.9/http/client.py&quot;, line 1250, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File &quot;/usr/lib/python3.9/http/client.py&quot;, line 1010, in _send_output
    self.send(msg)
  File &quot;/usr/lib/python3.9/http/client.py&quot;, line 950, in send
    self.connect()
  File &quot;/home/zulip/deployments/2023-05-12-12-47-56/./scripts/../scripts/lib/supervisor.py&quot;, line 10, in connect
    self.sock.connect(self.host)
FileNotFoundError: [Errno 2] No such file or directory
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2023-05-12-12-47-56/scripts/lib/upgrade-zulip-stage-2&quot;, line 528, in &lt;module&gt;
    shutdown_server()
  File &quot;/home/zulip/deployments/2023-05-12-12-47-56/scripts/lib/upgrade-zulip-stage-2&quot;, line 202, in shutdown_server
    subprocess.check_call([&quot;./scripts/stop-server&quot;], preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python3.9/subprocess.py&quot;, line 373, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./scripts/stop-server&#39;]&#39; returned non-zero exit status 1.

Zulip upgrade failed (exit code 1)!

The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is available in /var/log/zulip/upgrade.log
</code></pre></div>



<a name="1568101"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568101" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568101">(May 12 2023 at 16:52)</a>:</h4>
<p>I was under the impression that I was further in the upgrade process, but it failed</p>



<a name="1568102"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568102" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568102">(May 12 2023 at 16:53)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Notice: Applied catalog in 0.11 seconds
2023-05-12 16:49:03,855 upgrade-zulip-stage-2: Pre-checking for puppet changes...
2023-05-12 16:49:06,735 upgrade-zulip-stage-2: Stopping Zulip...

Zulip stopped successfully!
2023-05-12 16:49:06,956 upgrade-zulip-stage-2: Applying Puppet changes...
</code></pre></div>



<a name="1568103"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568103" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568103">(May 12 2023 at 16:54)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Notice: /Stage[main]/Zulip::Camo/File[/etc/supervisor/conf.d/zulip/go-camo.conf]/content: content changed &#39;{md5}17eb93344d6ff117c06d25eaa1f18aba&#39; to &#39;{md5}ab8cff1263fb1ada6fef43b945cd7d9d&#39;
Notice: /Stage[main]/Zulip::Supervisor/Service[supervisor]: Triggered &#39;refresh&#39; from 3 events
Notice: /Stage[main]/Zulip::Supervisor/Exec[supervisor-restart]: Triggered &#39;refresh&#39; from 1 event
Notice: Applied catalog in 76.93 seconds
Reading package lists...
Building dependency tree...
Reading state information...
Calculating upgrade...
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
2023-05-12 16:50:26,938 upgrade-zulip-stage-2: Stopping Zulip...
Traceback (most recent call last):
</code></pre></div>



<a name="1568106"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568106" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568106">(May 12 2023 at 16:58)</a>:</h4>
<p>why is it trying to stop zulip server at this step? it is fully stopped. and the stop-server script in current is working, but at this step it's using this version : /home/zulip/deployments/2023-05-12-12-47-56/./scripts/stop-server</p>



<a name="1568109"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568109" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568109">(May 12 2023 at 16:59)</a>:</h4>
<p>I'm sorry, I'm a little confused with the multiple pastes in a row.  Can you upload <code>upgrade.log</code> so I can see everything next o each other?</p>



<a name="1568111"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568111" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568111">(May 12 2023 at 17:01)</a>:</h4>
<p><a href="/user_uploads/2/c8/DwF8DBnttW8b6aOw84Tr5FuZ/upgrade.log">upgrade.log</a></p>



<a name="1568112"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568112" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568112">(May 12 2023 at 17:02)</a>:</h4>
<p>I'm rolling back my snapshot.</p>



<a name="1568113"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568113" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568113">(May 12 2023 at 17:03)</a>:</h4>
<p>If you need me to try something. Just list the steps here and I will try later. Thanks for your help.</p>



<a name="1568117"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568117" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568117">(May 12 2023 at 17:06)</a>:</h4>
<p>now back on a working 6.1 server.</p>



<a name="1568122"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568122" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568122">(May 12 2023 at 17:11)</a>:</h4>
<div class="codehilite"><pre><span></span><code>2023-05-12 16:49:06,735 upgrade-zulip-stage-2: Stopping Zulip...

Zulip stopped successfully!
</code></pre></div>
<p>That's real weird, since I'd have expected (a) that to have the same failure mode as below, and (b) it show have some lines of output in between, for each of the services it's stopping.</p>
<p>I suppose one theory is that at the end of puppet:</p>
<div class="codehilite"><pre><span></span><code>Notice: /Stage[main]/Zulip::Supervisor/Service[supervisor]: Triggered &#39;refresh&#39; from 3 events
Notice: /Stage[main]/Zulip::Supervisor/Exec[supervisor-restart]: Triggered &#39;refresh&#39; from 1 event
Notice: Applied catalog in 76.93 seconds
Reading package lists...
Building dependency tree...
Reading state information...
Calculating upgrade...
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
2023-05-12 16:50:26,938 upgrade-zulip-stage-2: Stopping Zulip...
Traceback (most recent call last):
</code></pre></div>
<p>we're just restarting supervisor for config changes and it's not up yet?  It being a race would explain the inability to replicate, and the LXC stuff is all a red herring.</p>



<a name="1568125"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568125" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568125">(May 12 2023 at 17:13)</a>:</h4>
<p>And that restart is why we need to stop everything again.  We need to restart <code>supervisord</code> to pick up the config change, but when it comes back up it automatically starts back up all of its services -- so we need to stop them again. (<a href="https://github.com/zulip/zulip/commit/0af00a3233fc8964b1ba7c32e672b74d80889b89">0af00a3233fc8964b1ba7c32e672b74d80889b89</a>)</p>



<a name="1568130"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568130" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568130">(May 12 2023 at 17:17)</a>:</h4>
<p>One way to test this race condition theory is to run the upgrade twice, back to back.  The second time, puppet won't need to apply any changes, so it won't kick supervisor, and we can see if it is able to carry on.</p>



<a name="1568134"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568134" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568134">(May 12 2023 at 17:18)</a>:</h4>
<p>And the fix would be to have shutdown_server wait for the socket to be available.</p>



<a name="1568135"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568135" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568135">(May 12 2023 at 17:19)</a>:</h4>
<p>Yeah, OK, this replicates:</p>
<div class="codehilite"><pre><span></span><code>root@alexmv-prod:~# service supervisor stop
root@alexmv-prod:~# python3
Python 3.8.10 (default, Mar 13 2023, 10:26:41)
[GCC 9.4.0] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import socket
&gt;&gt;&gt; client = socket.socket( socket.AF_UNIX, socket.SOCK_STREAM )
&gt;&gt;&gt; client.connect(&quot;/var/run/supervisor.sock&quot;)
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
FileNotFoundError: [Errno 2] No such file or directory
</code></pre></div>



<a name="1568195"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568195" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568195">(May 12 2023 at 18:25)</a>:</h4>
<p>Pushed <a href="https://github.com/zulip/zulip/pull/25571">#25571</a>.</p>



<a name="1568316"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568316" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568316">(May 12 2023 at 20:27)</a>:</h4>
<p><span class="user-mention" data-user-id="26472">@Louis-Marie Gendron</span>: OK, this fix is now in <code>main</code>.  If you want to test it, you can <a href="https://zulip.readthedocs.io/en/latest/production/upgrade.html#upgrading-from-a-git-repository">upgrade to the latest <code>main</code></a>:</p>
<div class="codehilite"><pre><span></span><code>/home/zulip/deployments/current/scripts/upgrade-zulip-from-git main
</code></pre></div>
<p>That should fix your issue, and you can later upgrade from there to any very small set of changes between that and the official 7.0, expected in a week or so.</p>



<a name="1568317"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568317" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568317">(May 12 2023 at 20:27)</a>:</h4>
<p>Thank you for reporting this bug and helping us track it down!</p>



<a name="1568431"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568431" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568431">(May 12 2023 at 22:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container/near/1568316">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="26472">Louis-Marie Gendron</span>: OK, this fix is now in <code>main</code>.  If you want to test it, you can <a href="https://zulip.readthedocs.io/en/latest/production/upgrade.html#upgrading-from-a-git-repository">upgrade to the latest <code>main</code></a>:</p>
<div class="codehilite"><pre><span></span><code>/home/zulip/deployments/current/scripts/upgrade-zulip-from-git main
</code></pre></div>
<p>That should fix your issue, and you can later upgrade from there to any very small set of changes between that and the official 7.0, expected in a week or so.</p>
</blockquote>
<p>I tried just now to upgrade from git main, sadly it failed again.</p>



<a name="1568432"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568432" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568432">(May 12 2023 at 22:01)</a>:</h4>
<p>I'm trying a second time in a row to test your other theory.</p>



<a name="1568433"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568433" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568433">(May 12 2023 at 22:02)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Done in 2.8s
+ ./tools/setup/emoji/build_emoji
build_emoji: Using cached emojis from /srv/zulip-emoji-cache/d366bfece8df5a9a5683ca99386d943ae2b86097/emoji
+ ./tools/setup/generate_zulip_bots_static_files.py
+ ./tools/setup/build_pygments_data
+ ./tools/setup/build_timezone_values
+ ./tools/webpack --quiet
+ ./manage.py collectstatic -v0 --noinput
+ ./manage.py compilemessages -v0 &#39;--ignore=*&#39;
System check identified no issues (18 silenced).
2023-05-12 22:01:25,580 upgrade-zulip-stage-2: Checking for needed migrations
2023-05-12 22:01:26,244 upgrade-zulip-stage-2: Installing hooks
Notice: Compiled catalog for ct-zulip.desgends.com in environment production in 1.58 seconds
Notice: Applied catalog in 0.11 seconds
2023-05-12 22:01:29,001 upgrade-zulip-stage-2: Pre-checking for puppet changes...
2023-05-12 22:01:31,923 upgrade-zulip-stage-2: Stopping Zulip...
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2023-05-12-18-00-38/./scripts/stop-server&quot;, line 53, in &lt;module&gt;
    services = list_supervisor_processes(services, only_running=True)
  File &quot;/home/zulip/deployments/2023-05-12-18-00-38/./scripts/../scripts/lib/supervisor.py&quot;, line 47, in list_supervisor_processes
    processes = rpc().supervisor.getAllProcessInfo()
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1116, in __call__
    return self.__send(self.__name, args)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1456, in __request
    response = self.__transport.request(
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1160, in request
    return self.single_request(host, handler, request_body, verbose)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1172, in single_request
    http_conn = self.send_request(host, handler, request_body, verbose)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1285, in send_request
    self.send_content(connection, request_body)
  File &quot;/usr/lib/python3.9/xmlrpc/client.py&quot;, line 1315, in send_content
    connection.endheaders(request_body)
  File &quot;/usr/lib/python3.9/http/client.py&quot;, line 1250, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File &quot;/usr/lib/python3.9/http/client.py&quot;, line 1010, in _send_output
    self.send(msg)
  File &quot;/usr/lib/python3.9/http/client.py&quot;, line 950, in send
    self.connect()
  File &quot;/home/zulip/deployments/2023-05-12-18-00-38/./scripts/../scripts/lib/supervisor.py&quot;, line 21, in connect
    raise Exception(
Exception: Failed to connect to supervisor -- check that it is running, by running &#39;service supervisor status&#39;
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2023-05-12-18-00-38/scripts/lib/upgrade-zulip-stage-2&quot;, line 517, in &lt;module&gt;
    shutdown_server()
  File &quot;/home/zulip/deployments/2023-05-12-18-00-38/scripts/lib/upgrade-zulip-stage-2&quot;, line 202, in shutdown_server
    subprocess.check_call([&quot;./scripts/stop-server&quot;], preexec_fn=su_to_zulip)
  File &quot;/usr/lib/python3.9/subprocess.py&quot;, line 373, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./scripts/stop-server&#39;]&#39; returned non-zero exit status 1.

Zulip upgrade failed (exit code 1)!

The upgrade process is designed to be idempotent, so you can retry after resolving whatever issue caused the failure (there should be a traceback above). A log of this installation is available in /var/log/zulip/upgrade.log
</code></pre></div>



<a name="1568441"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568441" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568441">(May 12 2023 at 22:04)</a>:</h4>
<p><a href="/user_uploads/2/f4/6UFtjQu1WTzg2WZ9oYiaV6rQ/upgrade_git_main.log">upgrade_git_main.log</a></p>



<a name="1568443"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568443" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568443">(May 12 2023 at 22:05)</a>:</h4>
<p>my two tries are in the log file.</p>



<a name="1568451"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1568451" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1568451">(May 12 2023 at 22:16)</a>:</h4>
<p>Grrr.  That theory seemed so promising!</p>
<p>I'll take a look at the log files on Monday - thanks for providing those.</p>



<a name="1570468"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570468" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570468">(May 16 2023 at 20:00)</a>:</h4>
<p><span class="user-mention" data-user-id="26472">@Louis-Marie Gendron</span>: Yeah, I'm pretty stumped.  I don't have a theory for this part of the output, which should have more lines between the first two non-empty lines:</p>
<div class="codehilite"><pre><span></span><code>2023-05-12 21:57:22,867 upgrade-zulip-stage-2: Stopping Zulip...

Zulip stopped successfully!
2023-05-12 21:57:23,092 upgrade-zulip-stage-2: Applying Puppet changes...
</code></pre></div>
<p>And if this isn't a race, that means that supervisor is just failing to come up cleanly at the end of the puppet run.</p>
<p>If you're game to try another go at it, can you (after it fails) show the output of:</p>
<div class="codehilite"><pre><span></span><code>tail -n100 /var/log/supervisor/supervisord.log

service supervisor status
</code></pre></div>



<a name="1570842"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570842" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570842">(May 17 2023 at 02:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container/near/1570468">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="26472">Louis-Marie Gendron</span>: Yeah, I'm pretty stumped.  I don't have a theory for this part of the output, which should have more lines between the first two non-empty lines:</p>
<div class="codehilite"><pre><span></span><code>2023-05-12 21:57:22,867 upgrade-zulip-stage-2: Stopping Zulip...

Zulip stopped successfully!
2023-05-12 21:57:23,092 upgrade-zulip-stage-2: Applying Puppet changes...
</code></pre></div>
<p>And if this isn't a race, that means that supervisor is just failing to come up cleanly at the end of the puppet run.</p>
<p>If you're game to try another go at it, can you (after it fails) show the output of:</p>
<p><div class="codehilite"><pre><span></span><code>tail -n100 /var/log/supervisor/supervisord.log

service supervisor status
</code></pre></div><br>
</p>
</blockquote>
<p><a href="/user_uploads/2/5a/qeQQiHh3jUjfYWi5FWl-Bw0z/upgrade_git_main_2.log">upgrade_git_main_2.log</a><br>
<a href="/user_uploads/2/26/W2_1aau9LvPb_Kli_Xfp2Q0v/tail_n100_supervisord_right_after_fail.log">tail_n100_supervisord_right_after_fail.log</a></p>



<a name="1570844"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570844" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570844">(May 17 2023 at 02:14)</a>:</h4>
<p>It failed again, no surprise. After a quick snapshot rollback, Zulip Server 6.1 is running again.</p>
<p><a href="/user_uploads/2/2b/ka_8N5rLOHJQQ3M8WeH7MWji/healthy-zulip-6.1-service-supervisor-status.log">healthy-zulip-6.1-service-supervisor-status.log</a></p>



<a name="1570850"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570850" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570850">(May 17 2023 at 03:18)</a>:</h4>
<p>According to that <code>supervisord.log</code>, all of the supervisor processes (including ones not normally stopped by <code>./scripts/stop-server</code>) were stopped at <code>2023-05-16 21:56:26,378</code> through <code>2023-05-16 22:01:33,527</code>, several hours before you started the upgrade at <code>2023-05-17 01:58:43,619</code>.  Does that ring a bell at all?</p>



<a name="1570851"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570851" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570851">(May 17 2023 at 03:21)</a>:</h4>
<p>It also shows that indeed supervisord is not running after the upgrade, but frustratingly doesn't show anything in the logs about why.</p>



<a name="1570852"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570852" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570852">(May 17 2023 at 03:21)</a>:</h4>
<p>Oh, I wonder if the ulimit max-socket changes are maybe relevant?</p>



<a name="1570853"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570853" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570853">(May 17 2023 at 03:24)</a>:</h4>
<p>Looking at the <code>supervisorctl</code> logs more closely, the ordering and timing looks like a <code>./scripts/stop-server</code> at <code>2023-05-16 21:56:26,381</code> followed by a <code>supervisorctl stop all</code> at <code>2023-05-16 22:01:21,105</code> for the remaining services.</p>



<a name="1570881"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570881" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570881">(May 17 2023 at 04:04)</a>:</h4>
<p>It's my fault! Before taking a snapshot, I did execute /home/zulip/development/current/scripts/stop-server. I want to preserve integrity of the database. It's much easier to rollback to an healthy installation, if Zulip was doing nothing. And I dont want any users to post message while I try to mess with my installation.</p>



<a name="1570885"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570885" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570885">(May 17 2023 at 04:07)</a>:</h4>
<p>I could retry, but this time :</p>
<ol>
<li>stop Zulip</li>
<li>take a snapshot of the container</li>
<li>block client access to Zulip container</li>
<li>start Zulip</li>
<li>try to upgrade again and then check supervisord.log</li>
</ol>



<a name="1570886"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570886" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570886">(May 17 2023 at 04:07)</a>:</h4>
<p>No, that's fine!</p>



<a name="1570887"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570887" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570887">(May 17 2023 at 04:08)</a>:</h4>
<p>It was just an oddity I was trying to understand -- it's totally fine to have the system quiesced before running the upgrade.  I think we've pinned this down to "supervisor doesn't come back up after puppet is run"</p>



<a name="1570888"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570888" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570888">(May 17 2023 at 04:09)</a>:</h4>
<p>Did you also do a <code>supervisorctl stop all</code> at <code>2023-05-16 22:01:21,105</code>?</p>



<a name="1570890"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570890" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570890">(May 17 2023 at 04:11)</a>:</h4>
<p>No I did not execute that specific command... not knowingly</p>



<a name="1570891"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570891" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570891">(May 17 2023 at 04:12)</a>:</h4>
<p>Hm, OK.  Something stopped the rest of the services then.  I think there must be timezone shenanigans here, for the two logs to line up</p>



<a name="1570892"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570892" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570892">(May 17 2023 at 04:14)</a>:</h4>
<p>Yeah, <code>2023-05-16 22:01:21,105</code> lines up with when the puppet run happened, if there's a <code>-0400</code> time zone offset to the upgrade running puppet at around <code>2023-05-17 02:01:04,937</code> and taking 77 seconds.</p>



<a name="1570893"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570893" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570893">(May 17 2023 at 04:14)</a>:</h4>
<p>upgrade.log is not  GMT-4, but supervisorctl is.</p>



<a name="1570894"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570894" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570894">(May 17 2023 at 04:15)</a>:</h4>
<p>OK, so <code>supervisord</code> isn't starting cleanly after the puppet apply.  If you're down for <em>one more outage</em>, trying to use <code>journalctl</code> and/or <code>/usr/bin/supervisord -n -c /etc/supervisor/supervisord.conf</code> to determine why it's not coming up cleanly, after the failed upgrade runs puppet, should point us toward what we need.</p>



<a name="1570895"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570895" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570895">(May 17 2023 at 04:15)</a>:</h4>
<p>Before that, actually, can you show <code>ulimit -a</code>?</p>



<a name="1570896"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570896" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570896">(May 17 2023 at 04:16)</a>:</h4>
<p><code>ulimit -a</code> without any other actions? like live right now?</p>



<a name="1570897"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570897" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570897">(May 17 2023 at 04:16)</a>:</h4>
<p>Yeah, inside the container.  That just shows limits, it doesn't change anything.</p>



<a name="1570898"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570898" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570898">(May 17 2023 at 04:17)</a>:</h4>
<p>root@ct-zulip:~# ulimit -a<br>
real-time non-blocking time  (microseconds, -R) unlimited<br>
core file size              (blocks, -c) 0<br>
data seg size               (kbytes, -d) unlimited<br>
scheduling priority                 (-e) 0<br>
file size                   (blocks, -f) unlimited<br>
pending signals                     (-i) 243873<br>
max locked memory           (kbytes, -l) 64<br>
max memory size             (kbytes, -m) unlimited<br>
open files                          (-n) 40000<br>
pipe size                (512 bytes, -p) 8<br>
POSIX message queues         (bytes, -q) 819200<br>
real-time priority                  (-r) 0<br>
stack size                  (kbytes, -s) 8192<br>
cpu time                   (seconds, -t) unlimited<br>
max user processes                  (-u) 243873<br>
virtual memory              (kbytes, -v) unlimited<br>
file locks                          (-x) unlimited</p>



<a name="1570899"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570899" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570899">(May 17 2023 at 04:19)</a>:</h4>
<ol>
<li>stop Zulip</li>
<li>snapshot</li>
<li>upgrade attempt (git main)</li>
<li>when it fails : <code>journalctl</code> and  <code>/usr/bin/supervisord -n -c /etc/supervisor/supervisord.conf</code></li>
</ol>



<a name="1570900"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570900" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570900">(May 17 2023 at 04:20)</a>:</h4>
<p>Let me get you the right journalctl incant first.</p>



<a name="1570903"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570903" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570903">(May 17 2023 at 04:23)</a>:</h4>
<div class="codehilite"><pre><span></span><code>journalctl -eu supervisor.service
</code></pre></div>
<div class="codehilite"><pre><span></span><code>/usr/bin/supervisord -n -c /etc/supervisor/supervisord.conf
</code></pre></div>



<a name="1570904"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570904" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570904">(May 17 2023 at 04:24)</a>:</h4>
<p>immediatly after a failed upgrade attempt</p>



<a name="1570906"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570906" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570906">(May 17 2023 at 04:25)</a>:</h4>
<p>My strong belief at this point is that something in the container is interfering with out attempt to set a very-high filedescriptor ulimit, which is unnecessary for most instances, and we can set a config to default that lower and let folks scale it up.  But I'd like to know what the limit is being forced to for you, and which limit is being the problem -- it's <em>probably</em> the <code>minfds</code> setting but it could be the <code>/etc/systemd/system.conf.d/limits.conf</code> change.</p>



<a name="1570907"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570907" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570907">(May 17 2023 at 04:25)</a>:</h4>
<p>Yes.</p>



<a name="1570908"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570908" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570908">(May 17 2023 at 04:26)</a>:</h4>
<p>I expect the latter will bomb out with the same logs that the former shows, but I'm including both in case I'm wrong, so we get the most information we can from the attempt.</p>



<a name="1570909"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570909" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570909">(May 17 2023 at 04:26)</a>:</h4>
<p>ok. attempt in progress</p>



<a name="1570910"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570910" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570910">(May 17 2023 at 04:27)</a>:</h4>
<p>If the latter starts up cleanly by some miracle, you'll need to ^C out of it, and then you can do your restore from snapshot.</p>



<a name="1570911"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570911" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570911">(May 17 2023 at 04:27)</a>:</h4>
<p>Well, I guess it doesn't matter what you do or don't do before throwing everything away to restore from the snapshot. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1570912"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570912" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570912">(May 17 2023 at 04:29)</a>:</h4>
<p>It seems that you are in the same timezone as I...</p>



<a name="1570914"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570914" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570914">(May 17 2023 at 04:31)</a>:</h4>
<p>near point of failure</p>



<a name="1570915"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570915" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570915">(May 17 2023 at 04:33)</a>:</h4>
<p>May 17 00:26:18 ct-zulip supervisord[157]: 2023-05-17 00:26:18,267 INFO waiting for process-fts-updates to stop<br>
May 17 00:26:18 ct-zulip supervisord[157]: 2023-05-17 00:26:18,271 INFO stopped: process-fts-updates (terminated by SIGTERM)<br>
May 17 00:26:18 ct-zulip supervisord[157]: 2023-05-17 00:26:18,271 INFO waiting for zulip-django to stop<br>
May 17 00:26:19 ct-zulip supervisord[157]: 2023-05-17 00:26:19,284 INFO stopped: zulip-django (exit status 0)<br>
May 17 00:26:19 ct-zulip supervisord[157]: 2023-05-17 00:26:19,285 INFO waiting for zulip-tornado to stop<br>
May 17 00:26:19 ct-zulip supervisord[157]: 2023-05-17 00:26:19,540 INFO stopped: zulip-tornado (exit status 0)<br>
May 17 00:26:19 ct-zulip supervisord[157]: 2023-05-17 00:26:19,541 INFO waiting for zulip_events_deferred_work to stop<br>
May 17 00:26:19 ct-zulip supervisord[157]: 2023-05-17 00:26:19,781 INFO stopped: zulip_events_deferred_work (exit status 0)<br>
May 17 00:26:19 ct-zulip supervisord[157]: 2023-05-17 00:26:19,782 INFO waiting for zulip_events_digest_emails to stop<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,022 INFO stopped: zulip_events_digest_emails (exit status 0)<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,023 INFO waiting for zulip_events_email_mirror to stop<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,263 INFO stopped: zulip_events_email_mirror (exit status 0)<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,264 INFO waiting for zulip_events_email_senders to stop<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,508 INFO stopped: zulip_events_email_senders (exit status 0)<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,509 INFO waiting for zulip_events_embed_links to stop<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,751 INFO stopped: zulip_events_embed_links (exit status 0)<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,752 INFO waiting for zulip_events_embedded_bots to stop<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,993 INFO stopped: zulip_events_embedded_bots (exit status 0)<br>
May 17 00:26:20 ct-zulip supervisord[157]: 2023-05-17 00:26:20,994 INFO waiting for zulip_events_error_reports to stop<br>
May 17 00:26:21 ct-zulip supervisord[157]: 2023-05-17 00:26:21,234 INFO stopped: zulip_events_error_reports (exit status 0)<br>
May 17 00:26:21 ct-zulip supervisord[157]: 2023-05-17 00:26:21,236 INFO waiting for zulip_events_invites to stop<br>
May 17 00:26:21 ct-zulip supervisord[157]: 2023-05-17 00:26:21,477 INFO stopped: zulip_events_invites (exit status 0)<br>
May 17 00:26:21 ct-zulip supervisord[157]: 2023-05-17 00:26:21,478 INFO waiting for zulip_events_missedmessage_emails to stop<br>
May 17 00:26:21 ct-zulip supervisord[157]: 2023-05-17 00:26:21,719 INFO stopped: zulip_events_missedmessage_emails (exit status 0)<br>
May 17 00:26:21 ct-zulip supervisord[157]: 2023-05-17 00:26:21,720 INFO waiting for zulip_events_missedmessage_mobile_notifications to stop<br>
May 17 00:26:21 ct-zulip supervisord[157]: 2023-05-17 00:26:21,964 INFO stopped: zulip_events_missedmessage_mobile_notifications (exit status 0)<br>
May 17 00:26:21 ct-zulip supervisord[157]: 2023-05-17 00:26:21,965 INFO waiting for zulip_events_outgoing_webhooks to stop<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,206 INFO stopped: zulip_events_outgoing_webhooks (exit status 0)<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,207 INFO waiting for zulip_events_user_activity to stop<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,444 INFO stopped: zulip_events_user_activity (exit status 0)<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,445 INFO waiting for zulip_events_user_activity_interval to stop<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,685 INFO stopped: zulip_events_user_activity_interval (exit status 0)<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,686 INFO waiting for zulip_events_user_presence to stop<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,932 INFO stopped: zulip_events_user_presence (exit status 0)<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,933 INFO waiting for zulip_deliver_scheduled_emails to stop<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,940 INFO stopped: zulip_deliver_scheduled_emails (terminated by SIGTERM)<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,941 INFO waiting for zulip_deliver_scheduled_messages to stop<br>
May 17 00:26:22 ct-zulip supervisord[157]: 2023-05-17 00:26:22,948 INFO stopped: zulip_deliver_scheduled_messages (terminated by SIGTERM)<br>
May 17 00:31:12 ct-zulip supervisord[157]: 2023-05-17 00:31:12,413 INFO waiting for go-camo to stop<br>
May 17 00:31:13 ct-zulip supervisord[157]: 2023-05-17 00:31:13,416 INFO stopped: go-camo (exit status 0)<br>
May 17 00:31:13 ct-zulip supervisord[157]: 2023-05-17 00:31:13,419 INFO spawned: 'go-camo' with pid 15013<br>
May 17 00:31:13 ct-zulip supervisord[157]: 2023-05-17 00:31:13,420 INFO waiting for smokescreen to stop<br>
May 17 00:31:14 ct-zulip supervisord[157]: 2023-05-17 00:31:14,131 INFO stopped: smokescreen (exit status 0)<br>
May 17 00:31:14 ct-zulip supervisord[157]: 2023-05-17 00:31:14,133 INFO spawned: 'smokescreen' with pid 15021<br>
May 17 00:31:14 ct-zulip supervisord[157]: 2023-05-17 00:31:14,253 INFO waiting for go-camo to stop<br>
May 17 00:31:14 ct-zulip supervisord[157]: 2023-05-17 00:31:14,253 INFO waiting for smokescreen to stop<br>
May 17 00:31:14 ct-zulip supervisord[157]: 2023-05-17 00:31:14,254 INFO stopped: go-camo (exit status 0)<br>
May 17 00:31:16 ct-zulip supervisord[157]: 2023-05-17 00:31:16,810 INFO waiting for smokescreen to stop<br>
May 17 00:31:18 ct-zulip supervisord[157]: 2023-05-17 00:31:18,814 INFO waiting for smokescreen to stop<br>
May 17 00:31:20 ct-zulip supervisord[157]: 2023-05-17 00:31:20,818 INFO waiting for smokescreen to stop<br>
May 17 00:31:22 ct-zulip supervisord[157]: 2023-05-17 00:31:22,822 INFO waiting for smokescreen to stop<br>
May 17 00:31:24 ct-zulip supervisord[157]: 2023-05-17 00:31:24,825 WARN killing 'smokescreen' (15021) with SIGKILL<br>
May 17 00:31:24 ct-zulip supervisord[157]: 2023-05-17 00:31:24,826 INFO waiting for smokescreen to stop<br>
May 17 00:31:24 ct-zulip supervisord[157]: 2023-05-17 00:31:24,827 INFO stopped: smokescreen (terminated by SIGKILL)<br>
May 17 00:31:25 ct-zulip systemd[1]: Stopping Supervisor process control system for UNIX...<br>
May 17 00:31:25 ct-zulip supervisorctl[15039]: Shut down<br>
May 17 00:31:25 ct-zulip systemd[1]: supervisor.service: Succeeded.<br>
May 17 00:31:25 ct-zulip systemd[1]: Stopped Supervisor process control system for UNIX.<br>
May 17 00:31:25 ct-zulip systemd[1]: supervisor.service: Consumed 1min 2.796s CPU time.<br>
May 17 00:31:25 ct-zulip systemd[1]: Started Supervisor process control system for UNIX.<br>
May 17 00:31:26 ct-zulip supervisord[15040]: Error: The minimum number of file descriptors required to run this process is 1000000 as per the "minfds" command-line argument or config file setting. The current &gt;<br>
May 17 00:31:26 ct-zulip supervisord[15040]: For help, use /usr/bin/supervisord -h<br>
May 17 00:31:26 ct-zulip systemd[1]: supervisor.service: Main process exited, code=exited, status=2/INVALIDARGUMENT<br>
May 17 00:31:26 ct-zulip systemd[1]: supervisor.service: Failed with result 'exit-code'.<br>
May 17 00:32:16 ct-zulip systemd[1]: supervisor.service: Scheduled restart job, restart counter is at 1.<br>
May 17 00:32:16 ct-zulip systemd[1]: Stopped Supervisor process control system for UNIX.<br>
May 17 00:32:16 ct-zulip systemd[1]: Started Supervisor process control system for UNIX.<br>
May 17 00:32:16 ct-zulip supervisord[15117]: Error: The minimum number of file descriptors required to run this process is 1000000 as per the "minfds" command-line argument or config file setting. The current &gt;<br>
May 17 00:32:16 ct-zulip supervisord[15117]: For help, use /usr/bin/supervisord -h<br>
May 17 00:32:16 ct-zulip systemd[1]: supervisor.service: Main process exited, code=exited, status=2/INVALIDARGUMENT<br>
May 17 00:32:16 ct-zulip systemd[1]: supervisor.service: Failed with result 'exit-code'.</p>



<a name="1570916"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570916" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570916">(May 17 2023 at 04:33)</a>:</h4>
<p><code>ulimit -a</code>?</p>



<a name="1570918"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570918" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570918">(May 17 2023 at 04:34)</a>:</h4>
<p>Also seeing the end of the line that starts:</p>
<div class="codehilite"><pre><span></span><code>May 17 00:32:16 ct-zulip supervisord[15117]: Error: The minimum number of file descriptors required to run this process is 1000000 as per the &quot;minfds&quot; command-line argument or config file setting. The current &gt;
</code></pre></div>



<a name="1570924"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570924" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570924">(May 17 2023 at 04:35)</a>:</h4>
<p>root@ct-zulip:~# ulimit -a<br>
real-time non-blocking time  (microseconds, -R) unlimited<br>
core file size              (blocks, -c) 0<br>
data seg size               (kbytes, -d) unlimited<br>
scheduling priority                 (-e) 0<br>
file size                   (blocks, -f) unlimited<br>
pending signals                     (-i) 243873<br>
max locked memory           (kbytes, -l) 64<br>
max memory size             (kbytes, -m) unlimited<br>
open files                          (-n) 40000<br>
pipe size                (512 bytes, -p) 8<br>
POSIX message queues         (bytes, -q) 819200<br>
real-time priority                  (-r) 0<br>
stack size                  (kbytes, -s) 8192<br>
cpu time                   (seconds, -t) unlimited<br>
max user processes                  (-u) 243873<br>
virtual memory              (kbytes, -v) unlimited<br>
file locks                          (-x) unlimited</p>



<a name="1570927"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570927" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570927">(May 17 2023 at 04:35)</a>:</h4>
<p>root@ct-zulip:~# /usr/bin/supervisord -n -c /etc/supervisor/supervisord.conf<br>
Error: The minimum number of file descriptors required to run this process is 1000000 as per the "minfds" command-line argument or config file setting. The current environment will only allow you to open 1000000 file descriptors.  Either raise the number of usable file descriptors in your environment (see README.rst) or lower the minfds setting in the config file to allow the process to start.<br>
For help, use /usr/bin/supervisord -h</p>



<a name="1570928"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570928" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570928">(May 17 2023 at 04:37)</a>:</h4>
<p>root@ct-zulip:~# cat /etc/systemd/system.conf.d/limits.conf<br>
[Manager]<br>
DefaultLimitNOFILE=1000000</p>



<a name="1570929"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570929" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570929">(May 17 2023 at 04:38)</a>:</h4>
<p>OK, that's what we got; you can go ahead and restore from snapshot.</p>



<a name="1570930"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570930" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570930">(May 17 2023 at 04:41)</a>:</h4>
<p>Error: The minimum number of file descriptors required to run this process is 1000000 as per the "minfds" command-line argument or config file setting. The current environment will only allow you to open 1000000 file descriptors.  Either raise the number of usable file descriptors in your environment (see README.rst) or lower the minfds setting in the config file to allow the process to start</p>



<a name="1570932"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570932" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570932">(May 17 2023 at 04:41)</a>:</h4>
<p>journalctl was not wraping lines</p>



<a name="1570933"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570933" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570933">(May 17 2023 at 04:43)</a>:</h4>
<p>good. I'm back on Zulip Server 6.1</p>



<a name="1570935"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570935" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570935">(May 17 2023 at 04:46)</a>:</h4>
<p>The error of "you can't set it to <em>x</em>, the max is <em>x</em>" vaguely rings a bell, but I'll poke more tomorrow.</p>
<p>I suspect we'll tune down the minfds, since moving that up is really only relevant for very very large deploys.</p>



<a name="1570936"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570936" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570936">(May 17 2023 at 04:46)</a>:</h4>
<p>Thank you again for being so willing to try this repeatedly!</p>



<a name="1570938"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570938" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570938">(May 17 2023 at 04:48)</a>:</h4>
<p>Oho: <a href="#narrow/stream/9-issues/topic/Unable.20to.20start.20zulip/near/779097">https://chat.zulip.org/#narrow/stream/9-issues/topic/Unable.20to.20start.20zulip/near/779097</a></p>



<a name="1570946"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570946" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570946">(May 17 2023 at 04:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container/near/1570936">said</a>:</p>
<blockquote>
<p>Thank you again for being so willing to try this repeatedly!</p>
</blockquote>
<p>My pleasure... but I do have to gain something in helping you... The ability to easily upgrade to 7.0 when released.</p>



<a name="1570951"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570951" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570951">(May 17 2023 at 04:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container/near/1570938">said</a>:</p>
<blockquote>
<p>Oho: <a href="#narrow/stream/9-issues/topic/Unable.20to.20start.20zulip/near/779097">https://chat.zulip.org/#narrow/stream/9-issues/topic/Unable.20to.20start.20zulip/near/779097</a></p>
</blockquote>
<p>3 years ago? Want me to try that <code>lxc.prlimit.nofile: 50000</code> ?</p>



<a name="1570953"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570953" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570953">(May 17 2023 at 05:00)</a>:</h4>
<p>It'd need to be <code>1000000</code> for the latest bump</p>



<a name="1570958"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570958" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570958">(May 17 2023 at 05:06)</a>:</h4>
<p>root@ct-zulip:~# prlimit -p 1<br>
RESOURCE   DESCRIPTION                             SOFT      HARD UNITS<br>
AS         address space limit                unlimited unlimited bytes<br>
CORE       max core file size                         0 unlimited bytes<br>
CPU        CPU time                           unlimited unlimited seconds<br>
DATA       max data size                      unlimited unlimited bytes<br>
FSIZE      max file size                      unlimited unlimited bytes<br>
LOCKS      max number of file locks held      unlimited unlimited locks<br>
MEMLOCK    max locked-in-memory address space     65536     65536 bytes<br>
MSGQUEUE   max bytes in POSIX mqueues            819200    819200 bytes<br>
NICE       max nice prio allowed to raise             0         0<br>
NOFILE     max number of open files              524288    524288 files<br>
NPROC      max number of processes               243873    243873 processes<br>
RSS        max resident set size              unlimited unlimited bytes<br>
RTPRIO     max real-time priority                     0         0<br>
RTTIME     timeout for real-time tasks        unlimited unlimited microsecs<br>
SIGPENDING max number of pending signals         243873    243873 signals<br>
STACK      max stack size                       8388608 unlimited bytes</p>



<a name="1570960"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570960" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570960">(May 17 2023 at 05:10)</a>:</h4>
<p>with the  instruction in my container .conf :</p>
<p>root@ct-zulip:~# prlimit -p 1<br>
RESOURCE   DESCRIPTION                             SOFT      HARD UNITS<br>
AS         address space limit                unlimited unlimited bytes<br>
CORE       max core file size                         0 unlimited bytes<br>
CPU        CPU time                           unlimited unlimited seconds<br>
DATA       max data size                      unlimited unlimited bytes<br>
FSIZE      max file size                      unlimited unlimited bytes<br>
LOCKS      max number of file locks held      unlimited unlimited locks<br>
MEMLOCK    max locked-in-memory address space     65536     65536 bytes<br>
MSGQUEUE   max bytes in POSIX mqueues            819200    819200 bytes<br>
NICE       max nice prio allowed to raise             0         0<br>
NOFILE     max number of open files             1000000   1000000 files<br>
NPROC      max number of processes               243873    243873 processes<br>
RSS        max resident set size              unlimited unlimited bytes<br>
RTPRIO     max real-time priority                     0         0<br>
RTTIME     timeout for real-time tasks        unlimited unlimited microsecs<br>
SIGPENDING max number of pending signals         243873    243873 signals<br>
STACK      max stack size                       8388608 unlimited bytes</p>



<a name="1570961"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570961" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570961">(May 17 2023 at 05:14)</a>:</h4>
<p>I need to retire for the night, but that looks hopeful for a successful upgrade to me.</p>



<a name="1570964"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570964" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570964">(May 17 2023 at 05:15)</a>:</h4>
<p>almost there...</p>



<a name="1570966"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570966" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570966">(May 17 2023 at 05:16)</a>:</h4>
<p>I'm past point of failure... still upgrading</p>



<a name="1570967"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570967" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570967">(May 17 2023 at 05:16)</a>:</h4>
<p>Deployments cleaned successfully...<br>
Cleaning orphaned/unused caches...<br>
Cleaning unused venv caches...<br>
Cleaning unused node modules caches...<br>
Cleaning unused emoji caches...<br>
Done!</p>



<a name="1570968"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570968" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570968">(May 17 2023 at 05:18)</a>:</h4>
<p>Did I do a downgrade?<br>
<a href="/user_uploads/2/88/sE0viRcRGTlfV-n3p5N3qGrv/image.png">image.png</a><br>
6.0 isnt lower than 6.1?</p>
<div class="message_inline_image"><a href="/user_uploads/2/88/sE0viRcRGTlfV-n3p5N3qGrv/image.png" title="image.png"><img src="/user_uploads/2/88/sE0viRcRGTlfV-n3p5N3qGrv/image.png"></a></div>



<a name="1570969"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1570969" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1570969">(May 17 2023 at 05:19)</a>:</h4>
<p>You can answer tomorrow... damned... we already are tomorrow</p>



<a name="1571072"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571072" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571072">(May 17 2023 at 12:01)</a>:</h4>
<p>You did not downgrade - that's <code>main</code>.  It doesn't report as 7.0 because we haven't tagged that release yet.  So it reports as 2340 commits after 6.0.</p>



<a name="1571089"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571089" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571089">(May 17 2023 at 12:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container/near/1571072">said</a>:</p>
<blockquote>
<p>You did not downgrade - that's <code>main</code>.  It doesn't report as 7.0 because we haven't tagged that release yet.  So it reports as 2340 commits after 6.0.</p>
</blockquote>
<p>Seriously, thank you for all your effort, trying to figure out what was not working in my attempts to upgrade to 7.0betas.</p>



<a name="1571090"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571090" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571090">(May 17 2023 at 12:48)</a>:</h4>
<p>Could you explain why minfds or in my case lxc.prlimit.nofile is so important to be set to 1000000? Per supervisord documentation, the default value for minfds is 1024...  So why almost a thousand times bigger?</p>



<a name="1571091"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571091" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571091">(May 17 2023 at 12:50)</a>:</h4>
<p>And, don't know if it's a placebo effect, but with 1000000 I think it was quicker to get where it usually broke.</p>



<a name="1571153"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571153" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571153">(May 17 2023 at 14:49)</a>:</h4>
<p>Every connection requires a file descriptor for it -- in some cases, two (for example, nginx has one for each connection from a client, and another for the connection it then makes to django or tornado in the backend on the client's behalf, to proxy the request).  The default of 1024 means that deployments start getting connection failures if they have more than 400-500 clients at the same time.</p>
<p>There's very little <em>cost</em> to increasing the maximum number of file descriptors -- the limit is there mostly because services want to be able to control if they turn away clients (due to lack of available file descriptors) at high load, or attempt to service them and perhaps time out due to lack of CPU time to service the many connections.</p>
<p>We opted to just increase the limits across the board, in that it gives a large buffer for truly huge deployments (think Zulip Cloud) and makes the failure modes of small ones a little easier to reason about (admins are more likely to observe and understand CPU saturation, rather than random connection refused messages reported by clients).</p>
<p>However, the limits we set in <a href="https://github.com/zulip/zulip/commit/1c76036c61d86d4fc6a574b734e1d04ad0ab43a3">1c76036c61d86d4fc6a574b734e1d04ad0ab43a3</a> are pretty absurdly huge; we had to roll back one of the changes in <a href="https://github.com/zulip/zulip/commit/262b19346e4eb55e945bb627c28a5421a3d5d5b1">262b19346e4eb55e945bb627c28a5421a3d5d5b1</a> because it <em>did</em> have a cost.  I think the right fix is to also back out more of <a href="https://github.com/zulip/zulip/commit/1c76036c61d86d4fc6a574b734e1d04ad0ab43a3">1c76036c61d86d4fc6a574b734e1d04ad0ab43a3</a> and put it behind a config variable, since the existing (6.0 and before) values are already quite large.</p>



<a name="1571154"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571154" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571154">(May 17 2023 at 14:49)</a>:</h4>
<p>And yes, any performance changes are purely placebo.  <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1571161"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571161" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571161">(May 17 2023 at 15:20)</a>:</h4>
<p>Pushed <a href="https://github.com/zulip/zulip/pull/25641">#25641</a>.</p>



<a name="1571229"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571229" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571229">(May 17 2023 at 17:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container/near/1571161">said</a>:</p>
<blockquote>
<p>Pushed <a href="https://github.com/zulip/zulip/pull/25641">#25641</a>.</p>
</blockquote>
<p>If this is merged, my fix by setting <code>lxc.prlimit.nofile</code> to 1000000 won't be necessary anymore?</p>



<a name="1571230"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571230" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571230">(May 17 2023 at 17:00)</a>:</h4>
<p>Correct.</p>



<a name="1571233"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1571233" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1571233">(May 17 2023 at 17:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container/near/1571153">said</a>:</p>
<blockquote>
<p>Every connection requires a file descriptor for it -- in some cases, two (for example, nginx has one for each connection from a client, and another for the connection it then makes to django or tornado in the backend on the client's behalf, to proxy the request).  The default of 1024 means that deployments start getting connection failures if they have more than 400-500 clients at the same time.<br>
.....</p>
</blockquote>
<p>Thank you for this answer. Again thank you for your troubleshooting!</p>



<a name="1576388"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1576388" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis-Marie Gendron <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1576388">(May 25 2023 at 02:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container/near/1571161">said</a>:</p>
<blockquote>
<p>Pushed <a href="https://github.com/zulip/zulip/pull/25641">#25641</a>.</p>
</blockquote>
<p>Hi! the PR was merged on May 18th. So, it's safe to assume I could set <code>lxc.prlimit.nofile</code> back to it's default value? Earlier this evening I did another upgrade with 1M nofile from git main. I'm now running 6.0.2492.</p>



<a name="1576538"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1576538" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shahboz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1576538">(May 25 2023 at 10:26)</a>:</h4>
<p>Hello there,<br>
I following this guide to set up my development environment<br>
<a href="https://github.com/zulip/docker-zulip">https://github.com/zulip/docker-zulip</a></p>
<p>when I write docker-compose up </p>
<p>I get this never ending log</p>
<p><a href="/user_uploads/2/c7/bgnBj5Lo4d-Q4xjFHDGePimi/zulip_error.png">zulip_error.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/c7/bgnBj5Lo4d-Q4xjFHDGePimi/zulip_error.png" title="zulip_error.png"><img src="/user_uploads/2/c7/bgnBj5Lo4d-Q4xjFHDGePimi/zulip_error.png"></a></div><p>could someone tell me what I am doing wrong.</p>



<a name="1576539"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1576539" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shahboz <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1576539">(May 25 2023 at 10:27)</a>:</h4>
<p>I can share the content of my yml file as well</p>



<a name="1576788"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Upgrades%20in%20unprivileged%20LXC%20container/near/1576788" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Upgrades.20in.20unprivileged.20LXC.20container.html#1576788">(May 25 2023 at 19:15)</a>:</h4>
<p><span class="user-mention" data-user-id="26472">@Louis-Marie Gendron</span> we've not backported the change to the 6.x branch, I think, but if you've upgraded to <code>main</code>, you should have the fix.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>