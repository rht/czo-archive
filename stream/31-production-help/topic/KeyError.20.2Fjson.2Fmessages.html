<html>
<head><meta charset="utf-8"><title>KeyError /json/messages · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html">KeyError /json/messages</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1588014"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20/json/messages/near/1588014" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin René Back <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html#1588014">(Jun 07 2023 at 22:15)</a>:</h4>
<p>Hello folks! As directed from <a href="https://github.com/zulip/zulip/issues/25916#issuecomment-1581575882">https://github.com/zulip/zulip/issues/25916#issuecomment-1581575882</a> I am hving an issue after upgrading from 6.1 to 7.0</p>



<a name="1588017"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20/json/messages/near/1588017" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin René Back <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html#1588017">(Jun 07 2023 at 22:16)</a>:</h4>
<p>the main problem being the banner that zulip is not reachable but works just fine</p>



<a name="1588644"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20/json/messages/near/1588644" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html#1588644">(Jun 08 2023 at 15:58)</a>:</h4>
<p><span class="user-mention" data-user-id="27165">@Justin René Back</span>: Have you deleted messages or done any other manual database manipulation on this Zulip instance?</p>



<a name="1588661"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20/json/messages/near/1588661" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html#1588661">(Jun 08 2023 at 16:08)</a>:</h4>
<p>Alternately, did you upgrade the OS at the same time?</p>



<a name="1588665"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20/json/messages/near/1588665" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html#1588665">(Jun 08 2023 at 16:09)</a>:</h4>
<p>(and if you did, did you follow the <a href="https://zulip.readthedocs.io/en/latest/production/upgrade.html#upgrading-the-operating-system">OS upgrade instructions</a>?)</p>



<a name="1588745"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20/json/messages/near/1588745" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin René Back <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html#1588745">(Jun 08 2023 at 17:07)</a>:</h4>
<p>Negative, the database itself is not accessible except from the shell and its isolated container network. Zulip runs on docker</p>



<a name="1588747"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20/json/messages/near/1588747" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin René Back <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html#1588747">(Jun 08 2023 at 17:07)</a>:</h4>
<p>So no database manipulation was done</p>



<a name="1588783"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20/json/messages/near/1588783" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html#1588783">(Jun 08 2023 at 18:08)</a>:</h4>
<p>Are you using our docker-compose configuration, and thus the <code>zulip/zulip-postgresql:14</code> image?</p>
<p>What version did you start running Zulip?  Was it before 6.0?</p>



<a name="1592030"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/KeyError%20/json/messages/near/1592030" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin René Back <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/KeyError.20.2Fjson.2Fmessages.html#1592030">(Jun 13 2023 at 09:56)</a>:</h4>
<p>Sooo quick update, here is a solution to the issue, for anyone experiencing the same - Please backup your DB!</p>
<div class="codehilite"><pre><span></span><code>DELETE FROM zerver_usermessage
WHERE message_id IN (
    SELECT A.message_id
    FROM zerver_usermessage A
    LEFT JOIN zerver_message B ON A.message_id = B.id
    WHERE B.id IS NULL
);
</code></pre></div>
<p>What does this query do? In my case, I've had inconsistencies in the <code>usermessage</code> (A) table, messages in table A did not exist in Table <code>message</code> (B)</p>
<p>The query above deletes all rows where an entry does not exist in Table B - For me Server Errors Stopped and zulip works just fine.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>