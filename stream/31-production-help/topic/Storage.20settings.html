<html>
<head><meta charset="utf-8"><title>Storage settings · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html">Storage settings</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1616422"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616422" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616422">(Jul 26 2023 at 11:21)</a>:</h4>
<p>Hi,</p>
<p>when one wants to add S3 support, should we comment out LOCAL_UPLOADS_DIR in settings.py, and leave nly S3 variable, or both?</p>



<a name="1616425"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616425" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616425">(Jul 26 2023 at 11:30)</a>:</h4>
<p>Also I know minio is s3 compatible, yet havent seen anything mentioning it in docs, can we use Minio too?</p>



<a name="1616440"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616440" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616440">(Jul 26 2023 at 12:41)</a>:</h4>
<p>Also when I tried to migrate from local to S3, I got this:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>root@chat:/home/zulip/deployments/current#<span class="w"> </span>su<span class="w"> </span>zulip<span class="w"> </span>-c<span class="w"> </span><span class="s1">'/home/zulip/deployments/2023-06-21-06-31-02/manage.py transfer_uploads_to_s3'</span>
Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/manage.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">144</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span>log_management_command<span class="o">(</span>sys.argv,<span class="w"> </span>settings.MANAGEMENT_LOG_PATH<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/conf/__init__.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">102</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>__getattr__
<span class="w">    </span>self._setup<span class="o">(</span>name<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/conf/__init__.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">89</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_setup
<span class="w">    </span>self._wrapped<span class="w"> </span><span class="o">=</span><span class="w"> </span>Settings<span class="o">(</span>settings_module<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/conf/__init__.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">217</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>__init__
<span class="w">    </span><span class="nv">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>importlib.import_module<span class="o">(</span>self.SETTINGS_MODULE<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/usr/lib/python3.8/importlib/__init__.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">127</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>import_module
<span class="w">    </span><span class="k">return</span><span class="w"> </span>_bootstrap._gcd_import<span class="o">(</span>name<span class="o">[</span>level:<span class="o">]</span>,<span class="w"> </span>package,<span class="w"> </span>level<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;frozen importlib._bootstrap&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1014</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_gcd_import
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;frozen importlib._bootstrap&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">991</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_find_and_load
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;frozen importlib._bootstrap&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">975</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_find_and_load_unlocked
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;frozen importlib._bootstrap&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">671</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_load_unlocked
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;frozen importlib._bootstrap_external&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">848</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>exec_module
<span class="w">  </span>File<span class="w"> </span><span class="s2">"&lt;frozen importlib._bootstrap&gt;"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">219</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_call_with_frames_removed
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/zproject/settings.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">26</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span>from<span class="w"> </span>.configured_settings<span class="w"> </span>import<span class="w"> </span>*<span class="w">  </span><span class="c1"># noqa: F403 isort: skip</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/zproject/configured_settings.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">8</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span>from<span class="w"> </span>.default_settings<span class="w"> </span>import<span class="w"> </span>*<span class="w">  </span><span class="c1"># noqa: F403 isort: skip</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/zproject/default_settings.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">14</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span>from<span class="w"> </span>.prod_settings<span class="w"> </span>import<span class="w"> </span>EXTERNAL_HOST,<span class="w"> </span>ZULIP_ADMINISTRATOR
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/zproject/prod_settings.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">648</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span><span class="nv">S3_REGION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>eu-ovh
NameError:<span class="w"> </span>name<span class="w"> </span><span class="s1">'eu'</span><span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>defined
</code></pre></div>



<a name="1616458"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616458" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616458">(Jul 26 2023 at 12:52)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>root@chat:/etc/zulip#<span class="w"> </span>su<span class="w"> </span>zulip<span class="w"> </span>-c<span class="w"> </span><span class="s1">'/home/zulip/deployments/2023-06-21-06-31-02/manage.py transfer_uploads_to_s3'</span>
concurrent.futures.process._RemoteTraceback:
<span class="s2">"""</span>
<span class="s2">Traceback (most recent call last):</span>
<span class="s2">  File "</span>/usr/lib/python3.8/concurrent/futures/process.py<span class="s2">", line 239, in _process_worker</span>
<span class="s2">    r = call_item.fn(*call_item.args, **call_item.kwargs)</span>
<span class="s2">  File "</span>/home/zulip/deployments/2023-06-21-06-31-02/zerver/lib/transfer.py<span class="s2">", line 32, in _transfer_avatar_to_s3</span>
<span class="s2">    s3backend.upload_avatar_image(f, user, user)</span>
<span class="s2">  File "</span>/home/zulip/deployments/2023-06-21-06-31-02/zerver/lib/upload/s3.py<span class="s2">", line 317, in upload_avatar_image</span>
<span class="s2">    self.write_avatar_images(s3_file_name, target_user_profile, image_data, content_type)</span>
<span class="s2">  File "</span>/home/zulip/deployments/2023-06-21-06-31-02/zerver/lib/upload/s3.py<span class="s2">", line 268, in write_avatar_images</span>
<span class="s2">    upload_image_to_s3(</span>
<span class="s2">  File "</span>/home/zulip/deployments/2023-06-21-06-31-02/zerver/lib/upload/s3.py<span class="s2">", line 87, in upload_image_to_s3</span>
<span class="s2">    key.put(</span>
<span class="s2">  File "</span>/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/boto3/resources/factory.py<span class="s2">", line 580, in do_action</span>
<span class="s2">    response = action(self, *args, **kwargs)</span>
<span class="s2">  File "</span>/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/boto3/resources/action.py<span class="s2">", line 88, in __call__</span>
<span class="s2">    response = getattr(parent.meta.client, operation_name)(*args, **params)</span>
<span class="s2">  File "</span>/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/botocore/client.py<span class="s2">", line 530, in _api_call</span>
<span class="s2">    return self._make_api_call(operation_name, kwargs)</span>
<span class="s2">  File "</span>/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/botocore/client.py<span class="s2">", line 964, in _make_api_call</span>
<span class="s2">    raise error_class(parsed_response, operation_name)</span>
<span class="s2">botocore.exceptions.ClientError: An error occurred (AccessDenied) when calling the PutObject operation: There were headers present in the request which were not signed</span>
<span class="s2">"""</span>

The<span class="w"> </span>above<span class="w"> </span>exception<span class="w"> </span>was<span class="w"> </span>the<span class="w"> </span>direct<span class="w"> </span>cause<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>exception:

Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/manage.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">150</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span>execute_from_command_line<span class="o">(</span>sys.argv<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/manage.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">115</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>execute_from_command_line
<span class="w">    </span>utility.execute<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">436</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>execute
<span class="w">    </span>self.fetch_command<span class="o">(</span>subcommand<span class="o">)</span>.run_from_argv<span class="o">(</span>self.argv<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">412</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>run_from_argv
<span class="w">    </span>self.execute<span class="o">(</span>*args,<span class="w"> </span>**cmd_options<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">458</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>execute
<span class="w">    </span><span class="nv">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>self.handle<span class="o">(</span>*args,<span class="w"> </span>**options<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/zerver/management/commands/transfer_uploads_to_s3.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">27</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>handle
<span class="w">    </span>transfer_uploads_to_s3<span class="o">(</span>num_processes<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/zerver/lib/transfer.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">20</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>transfer_uploads_to_s3
<span class="w">    </span>transfer_avatars_to_s3<span class="o">(</span>processes<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/home/zulip/deployments/2023-06-21-06-31-02/zerver/lib/transfer.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">52</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>transfer_avatars_to_s3
<span class="w">    </span>future.result<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/usr/lib/python3.8/concurrent/futures/_base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">437</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>result
<span class="w">    </span><span class="k">return</span><span class="w"> </span>self.__get_result<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">"/usr/lib/python3.8/concurrent/futures/_base.py"</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">389</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>__get_result
<span class="w">    </span>raise<span class="w"> </span>self._exception
botocore.exceptions.ClientError:<span class="w"> </span>An<span class="w"> </span>error<span class="w"> </span>occurred<span class="w"> </span><span class="o">(</span>AccessDenied<span class="o">)</span><span class="w"> </span>when<span class="w"> </span>calling<span class="w"> </span>the<span class="w"> </span>PutObject<span class="w"> </span>operation:<span class="w"> </span>There<span class="w"> </span>were<span class="w"> </span>headers<span class="w"> </span>present<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>request<span class="w"> </span>which<span class="w"> </span>were<span class="w"> </span>not<span class="w"> </span>signed
</code></pre></div>



<a name="1616461"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616461" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616461">(Jul 26 2023 at 12:53)</a>:</h4>
<p>I moved the settings value eu-ovh to "eu-ovh" and got this...</p>



<a name="1616606"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616606" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616606">(Jul 26 2023 at 14:41)</a>:</h4>
<p>Answering your questions in order:</p>
<ul>
<li>You should comment out <code>LOCAL_UPLOADS_DIR</code>, yes, as <a href="https://zulip.readthedocs.io/en/stable/production/upload-backends.html#s3-backend-configuration">noted in step 4</a>.</li>
<li>We don't have experience using minio ourselves, nor have we heard specifically of folks doing so successfully -- though <a class="stream-topic" data-stream-id="31" href="/#narrow/stream/31-production-help/topic/File.20Upload">#production help &gt; File Upload</a> may be a success, since they didn't ask any follow-up questions.  If it works for you, that'd be good to know, and we can potentially extend the docs.</li>
<li>The string does need to be quoted in <code>settings.py</code>, yes:</li>
</ul>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">S3_REGION</span> <span class="o">=</span> <span class="s2">"eu-ovh"</span>
</code></pre></div>
<ul>
<li>If you're getting AccessDenied, that means there's something not-right with your auth or ACLs as configured in S3 (or minio, if you're trying that?)</li>
</ul>



<a name="1616611"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616611" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616611">(Jul 26 2023 at 14:47)</a>:</h4>
<p>This error is from when I try to migrate from local to s3.</p>



<a name="1616612"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616612" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616612">(Jul 26 2023 at 14:47)</a>:</h4>
<p>I have not tried without it to see if it works.</p>



<a name="1616613"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616613" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616613">(Jul 26 2023 at 14:48)</a>:</h4>
<p>I do not see the reason not to, I applied the policies from the docs, the buckets are in place</p>



<a name="1616614"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616614" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616614">(Jul 26 2023 at 14:48)</a>:</h4>
<p>the credentials are right, address is right...</p>



<a name="1616615"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616615" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616615">(Jul 26 2023 at 14:48)</a>:</h4>
<p>But also the log does not say much.</p>



<a name="1616616"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616616" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616616">(Jul 26 2023 at 14:48)</a>:</h4>
<p>i see is sort of auth issue, yet the credentials are right</p>



<a name="1616617"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616617" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616617">(Jul 26 2023 at 14:49)</a>:</h4>
<p>I tried both root credentials and made specific user for minio buckets</p>



<a name="1616619"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1616619" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1616619">(Jul 26 2023 at 14:52)</a>:</h4>
<p>The log says everything that minio tells us.  My guess is that the permissions for the user, on those buckets, are not set up right.</p>



<a name="1617125"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617125" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617125">(Jul 27 2023 at 16:35)</a>:</h4>
<p>Isn't there a way to get more info on that? Because I double checked, permissions are right, I even tried the ROOT keys, those should work with all buckets.</p>



<a name="1617126"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617126" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617126">(Jul 27 2023 at 16:36)</a>:</h4>
<p>Will do some more testing, check also minio logs</p>



<a name="1617141"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617141" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617141">(Jul 27 2023 at 17:47)</a>:</h4>
<p>So I really tried with all variants I have at hands</p>



<a name="1617142"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617142" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617142">(Jul 27 2023 at 17:47)</a>:</h4>
<p>I have my whole infra in minio. I managed all integration at first sight, no issues until zulip, Id say is must be more than just that error.</p>



<a name="1617143"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617143" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617143">(Jul 27 2023 at 17:47)</a>:</h4>
<p>Not sure how to move on with this.</p>



<a name="1617144"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617144" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617144">(Jul 27 2023 at 17:48)</a>:</h4>
<p>Policies are applied  as mentioned, 2 buckets are having same access user, with 2 sets of policies one for each bucket.</p>



<a name="1617145"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617145" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617145">(Jul 27 2023 at 17:48)</a>:</h4>
<p>either your docs needs something I missed, or I did all step by step</p>



<a name="1617146"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617146" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617146">(Jul 27 2023 at 17:54)</a>:</h4>
<p>Why I have a feeling the issue is in the migration plugin from local to s3</p>



<a name="1617148"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617148" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617148">(Jul 27 2023 at 17:59)</a>:</h4>
<p>According to this: <a href="https://gist.github.com/heitorlessa/5b709df96ea6ac5ddc600545c0683d3b">https://gist.github.com/heitorlessa/5b709df96ea6ac5ddc600545c0683d3b</a> boto3 supports Minio, not sure about previous releases or not sure. what version you ship with Zulip</p>



<a name="1617152"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617152" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617152">(Jul 27 2023 at 18:05)</a>:</h4>
<p>Zulip Server 7.2 uses boto3 1.26.142 (see <a href="https://github.com/zulip/zulip/blob/7.2/requirements/prod.txt">https://github.com/zulip/zulip/blob/7.2/requirements/prod.txt</a> for the versions of all our Python packages).</p>



<a name="1617156"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617156" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617156">(Jul 27 2023 at 18:14)</a>:</h4>
<p>We don't have any experience setting up Zulip with Minio, or with Minio at all, so our ability to help debug is unfortunately pretty limited.</p>



<a name="1617329"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617329" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617329">(Jul 28 2023 at 10:04)</a>:</h4>
<p>Minio like already explained is almost a one on one copy of s3 standards. So once in place correctly. S3 will work same as on aws same on minio.</p>



<a name="1617330"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1617330" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1617330">(Jul 28 2023 at 10:05)</a>:</h4>
<p>I could provide a minio user and access to debug this.  If intrested.</p>



<a name="1624333"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1624333" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1624333">(Aug 13 2023 at 10:24)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> can you take a look into this matter please? I find it really silly that ALL integrations made with S3 accross our infra works well. Only this one does not, and when I mentioned that I can provide S3 instance for testing, silence...</p>



<a name="1624334"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1624334" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1624334">(Aug 13 2023 at 10:24)</a>:</h4>
<p>Since Minio is a S3 clone, the setups with AWS will work where S3 compatible is present,</p>



<a name="1624856"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1624856" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1624856">(Aug 14 2023 at 21:12)</a>:</h4>
<p><span class="user-mention" data-user-id="20576">@Cosmic Sound</span> I'm still partially on parental leave and can't investigate this sort of thing. You'll welcome to sign up for a support contract if you need personalized help, or debug yourself -- we're just using the <code>boto</code> library, so it's likely a configuration issue of some sort.</p>



<a name="1624857"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1624857" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1624857">(Aug 14 2023 at 21:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/Storage.20settings/near/1624856">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="20576">Cosmic Sound</span> I'm still partially on parental leave and can't investigate this sort of thing. You'll welcome to sign up for a support contract if you need personalized help, or debug yourself -- we're just using the <code>boto</code> library, so it's likely a configuration issue of some sort.</p>
</blockquote>
<p>Right, was not sure about that, seen you had some replies hoped you're back, no worries, will wait, is not boiling just nice to have.</p>



<a name="1624858"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1624858" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1624858">(Aug 14 2023 at 21:14)</a>:</h4>
<p>I made sure is not config issue, i have like mentioned several apps that run on minio and using without issues.</p>



<a name="1624861"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1624861" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1624861">(Aug 14 2023 at 21:16)</a>:</h4>
<p>I'm guessing there's some parameter you're not setting in the Zulip S3 configuration that minio needs set.</p>



<a name="1625255"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625255" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625255">(Aug 15 2023 at 09:21)</a>:</h4>
<p>Well i went through it several times. Made custom users. Used root user. All same.</p>



<a name="1625594"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625594" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Neil Pilgrim (neiljp) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625594">(Aug 15 2023 at 17:41)</a>:</h4>
<p>Reading the error, this hints at an issue with the signature version used by minio, though search hits suggest it could be a proxy misconfiguration.</p>



<a name="1625604"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625604" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625604">(Aug 15 2023 at 17:46)</a>:</h4>
<p>If the minio server is in private IP space, it could be going through Smokescreen and getting rejected for that.</p>



<a name="1625615"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625615" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625615">(Aug 15 2023 at 17:54)</a>:</h4>
<p>my minio is deployed with caprover, runs on docker, behing nginx. The API is accessible at <a href="http://s3-api.uhl.cloud">s3-api.uhl.cloud</a> publicly. this is proxying to <a href="http://s3.uhl.cloud">s3.uhl.cloud</a> with nginx-reverse-proxy .</p>



<a name="1625616"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625616" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625616">(Aug 15 2023 at 17:54)</a>:</h4>
<p>Yet no other apps have had any issues in connecting until zulip</p>



<a name="1625618"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625618" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625618">(Aug 15 2023 at 17:56)</a>:</h4>
<p>If ay suggesyions on settingss to change on minio side or zulip or the nginx proxy manager, let me know.</p>



<a name="1625619"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625619" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625619">(Aug 15 2023 at 17:59)</a>:</h4>
<p><a href="/user_uploads/2/1a/0pgHH4qowf6Kcou9FyBJJcuf/image.png">image.png</a><br>
not using extra env variables for nginx proxy, is default deployment based on:<a href="https://github.com/caprover/one-click-apps/blob/fe591f182c864bc3a4e6eabec32c9228bbbc3976/public/v4/apps/minio.yml">https://github.com/caprover/one-click-apps/blob/fe591f182c864bc3a4e6eabec32c9228bbbc3976/public/v4/apps/minio.yml</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/1a/0pgHH4qowf6Kcou9FyBJJcuf/image.png" title="image.png"><img src="/user_uploads/2/1a/0pgHH4qowf6Kcou9FyBJJcuf/image.png"></a></div>



<a name="1625628"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625628" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Neil Pilgrim (neiljp) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625628">(Aug 15 2023 at 18:07)</a>:</h4>
<p>My proxy comment came from noting the specific error was <code>There were headers present in the request which were not signed</code> which suggested <a href="https://stackoverflow.com/questions/52450291/any-way-to-configure-what-signature-version-a-minio-server-accepts">https://stackoverflow.com/questions/52450291/any-way-to-configure-what-signature-version-a-minio-server-accepts</a> as well as various others connected to proxy or header-forwarding/preservation issues.</p>



<a name="1625666"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625666" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625666">(Aug 15 2023 at 18:23)</a>:</h4>
<p>Yes but thats something to be done on Zulip side, not on ourside...</p>



<a name="1625670"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625670" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625670">(Aug 15 2023 at 18:26)</a>:</h4>
<p>Well I did also research on it, and compared to nginx settings, is all good: </p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="w">            </span>proxy_pass<span class="w"> </span><span class="nv">$upstream</span><span class="p">;</span>
<span class="w">            </span>proxy_set_header<span class="w"> </span>Host<span class="w"> </span><span class="nv">$host</span><span class="p">;</span>
<span class="w">            </span>proxy_set_header<span class="w"> </span>X-Real-IP<span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<span class="w">            </span>proxy_set_header<span class="w"> </span>X-Forwarded-For<span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">            </span>proxy_set_header<span class="w"> </span>X-Forwarded-Proto<span class="w"> </span><span class="nv">$scheme</span><span class="p">;</span>
</code></pre></div>



<a name="1625697"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/Storage%20settings/near/1625697" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/Storage.20settings.html#1625697">(Aug 15 2023 at 18:50)</a>:</h4>
<p><a href="/user_uploads/2/7e/I5FykhZxv9U_HdTgrD-oNmvh/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/7e/I5FykhZxv9U_HdTgrD-oNmvh/image.png" title="image.png"><img src="/user_uploads/2/7e/I5FykhZxv9U_HdTgrD-oNmvh/image.png"></a></div>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>