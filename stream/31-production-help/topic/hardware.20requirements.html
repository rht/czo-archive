<html>
<head><meta charset="utf-8"><title>hardware requirements · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html">hardware requirements</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1027936"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1027936" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1027936">(Sep 30 2020 at 09:59)</a>:</h4>
<p>Hi :-)</p>
<p>I installed a zulip server for the CS department of my university, but I need some help in order to be able to calculate the hardware requirements.<br>
If everything works fine, the server might get up to a few thousand users and at least ~1.000 daily users (average).</p>
<p>I know the <a href="https://zulip.readthedocs.io/en/stable/production/requirements.html#scalability">document on scalability</a> and that it's possible to <a href="https://zulip.readthedocs.io/en/stable/production/deployment.html#running-zulip-s-service-dependencies-on-different-machines">outsource services</a>.</p>
<p>But how exactly will the requirements change if I outsource the services? Could you give me a clue? That would be great! :-)</p>
<p>PS: The maximum capacity of a single VM on our university: 4 cores, 16GB RAM, 80GB storage.</p>



<a name="1028047"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028047" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028047">(Sep 30 2020 at 16:51)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert</span> I'd recommend that 16GB of RAM version, given those constraints.  That's how much resources this server has with ~15K total users, and I expect that'll be sufficient for the usage you describe.</p>



<a name="1028048"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028048" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028048">(Sep 30 2020 at 16:51)</a>:</h4>
<p>Can you explain what you mean by "outsource the services"?</p>



<a name="1028079"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028079" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028079">(Sep 30 2020 at 17:33)</a>:</h4>
<p>Thank you very much for your answer! :-)</p>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1028048">said</a>:</p>
<blockquote>
<p>Can you explain what you mean by "outsource the services"?</p>
</blockquote>
<p>Well, <a href="https://zulip.readthedocs.io/en/stable/production/deployment.html#running-zulip-s-service-dependencies-on-different-machines">this</a>:</p>
<blockquote>
<p>Zulip has full support for each top-level service living on its own machine.</p>
</blockquote>
<p>Sorry, if it was the wrong wording...<br>
Do you think that a single 16GB VM is sufficient for zulip and its services like the database, etc.?<br>
Because <a href="https://zulip.readthedocs.io/en/stable/production/requirements.html#scalability">here</a> it seems that the absolute minimum requirements would be "16GB of RAM for the Zulip application server, plus 16GB for the database".</p>



<a name="1028154"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028154" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028154">(Sep 30 2020 at 20:11)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert</span> my guess is that it will be; if you find it isn't, it's not hard to migrate to have those be different servers.</p>



<a name="1028183"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028183" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028183">(Sep 30 2020 at 20:36)</a>:</h4>
<p>Ok, thank you! :-)</p>



<a name="1028195"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028195" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028195">(Sep 30 2020 at 20:41)</a>:</h4>
<p>One additional thing: Do you think that this is also sufficient for a peak of ~1.800 daily users? Or should the database in this case be on another server in any case?</p>



<a name="1028197"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028197" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028197">(Sep 30 2020 at 20:45)</a>:</h4>
<p>It really depends on how active those users will be.  Zulip load mainly scales with concurrent active users, which for 1800 daily users could be ~1000 or could be ~200 depending on how they end up using it.  Certainly you won't need to have a separate server at the 200 range, and you might not even at 1000.</p>



<a name="1028199"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028199" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028199">(Sep 30 2020 at 20:46)</a>:</h4>
<p>I'm be tempted to set it up on a single server first, since that's easiest, and if you experience load issues, do the migration.</p>



<a name="1028200"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028200" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028200">(Sep 30 2020 at 20:46)</a>:</h4>
<p>But if you're looking to minimize downtime, it's not hard to do postgres on a separate VM.</p>



<a name="1028279"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1028279" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1028279">(Sep 30 2020 at 22:16)</a>:</h4>
<p>Ok, got it :-) Thanks!</p>



<a name="1037715"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037715" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037715">(Oct 14 2020 at 21:54)</a>:</h4>
<p>Hi :-)<br>
I'm trying to install postgres on my second VM. So I fetched and unpacked a zulip tarball and executed <code>env PUPPET_CLASSES=zulip::base,zulip::apt_repository,zulip::postgres_appdb_tuned,zulip::localhost_camo ./scripts/setup/install --email=user@host --hostname=host</code> so postgres gets porperly installed and configured for zulip.<br>
However, I got the following failure during the installation:</p>
<div class="codehilite"><pre><span></span><code>+ /tmp/tmp.vW8CV5zscR/zulip-server-3.2/scripts/zulip-puppet-apply --force --noop --write-catalog-summary --classfile=/var/lib/puppet/classes.txt
Error: Could not find resource &#39;Package[nginx-full]&#39; in parameter &#39;require&#39; (file: /tmp/tmp.vW8CV5zscR/zulip-server-3.2/puppet/zulip/manifests/localhost_camo.pp, line: 7) on node host

Zulip installation failed (exit code 1)!
</code></pre></div>


<p>Did I do anything wrong? I thought it might be a good idea to include the <code>zulip::localhost_camo</code> target as well as the VM runs Ubuntu (= Debian-based, see <a href="https://github.com/zulip/zulip/blob/master/puppet/zulip/manifests/voyager.pp#L30">https://github.com/zulip/zulip/blob/master/puppet/zulip/manifests/voyager.pp#L30</a>)...<br>
Help is greatly appreciated! :-)</p>



<a name="1037743"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037743" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037743">(Oct 14 2020 at 22:28)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert</span> <code>localhost_camo</code> is for the app frontend servers. For a database-only server, you should install without it.</p>



<a name="1037747"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037747" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037747">(Oct 14 2020 at 22:48)</a>:</h4>
<p>Thank you! So just restart the installation without it? Or should I remove something before?</p>



<a name="1037750"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037750" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037750">(Oct 14 2020 at 22:51)</a>:</h4>
<p>Yeah you can just retry without it.</p>



<a name="1037751"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037751" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037751">(Oct 14 2020 at 22:57)</a>:</h4>
<p>Hmm?</p>
<div class="codehilite"><pre><span></span><code>++ dirname /tmp/tmp.vW8CV5zscR/zulip-server-3.2/scripts/setup/postgres-init-db
+ /tmp/tmp.vW8CV5zscR/zulip-server-3.2/scripts/setup/flush-memcached
Traceback (most recent call last):
  File &quot;/tmp/tmp.vW8CV5zscR/zulip-server-3.2/scripts/setup/flush-memcached&quot;, line 14, in &lt;module&gt;
    from zproject import settings
  File &quot;/tmp/tmp.vW8CV5zscR/zulip-server-3.2/scripts/setup/../../zproject/settings.py&quot;, line 19, in &lt;module&gt;
    from .configured_settings import *  # noqa: F401,F403 isort: skip
  File &quot;/tmp/tmp.vW8CV5zscR/zulip-server-3.2/scripts/setup/../../zproject/configured_settings.py&quot;, line 8, in &lt;module&gt;
    from .default_settings import *  # noqa: F401,F403 isort: skip
  File &quot;/tmp/tmp.vW8CV5zscR/zulip-server-3.2/scripts/setup/../../zproject/default_settings.py&quot;, line 13, in &lt;module&gt;
    from .prod_settings import EXTERNAL_HOST, ZULIP_ADMINISTRATOR
ModuleNotFoundError: No module named &#39;zproject.prod_settings&#39;

Zulip installation failed (exit code 1)!
</code></pre></div>



<a name="1037761"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037761" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037761">(Oct 14 2020 at 23:14)</a>:</h4>
<p>That seems like a bug. <span class="user-mention" data-user-id="12178">@Alex Vandiver</span> do you know how we’ve avoided running into this?</p>



<a name="1037762"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037762" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037762">(Oct 14 2020 at 23:17)</a>:</h4>
<p>Seems like we should have been seeing it since <a href="https://github.com/zulip/zulip/pull/13239">#13239</a>.</p>



<a name="1037764"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037764" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037764">(Oct 14 2020 at 23:24)</a>:</h4>
<p>Oh, we’d have used <code>--no-init-db</code>.</p>



<a name="1037765"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037765" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037765">(Oct 14 2020 at 23:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="17322">Robert</span> <del>I think you can just edit <code>scripts/setup/postgres-init-db</code> and comment out the <code>flush-memcached</code> line and retry.</del> Actually that doesn’t work, there are more bugs.</p>



<a name="1037769"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1037769" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1037769">(Oct 14 2020 at 23:55)</a>:</h4>
<p>I filed this as <a href="https://github.com/zulip/zulip/pull/16541">#16541</a>.</p>



<a name="1038182"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038182" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038182">(Oct 15 2020 at 09:13)</a>:</h4>
<p>Thank you. Is there a temporary fix / workaround I could use?</p>



<a name="1038601"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038601" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038601">(Oct 15 2020 at 21:37)</a>:</h4>
<p>My hope is we'll just fix it in the next day or so.</p>



<a name="1038620"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038620" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038620">(Oct 15 2020 at 21:40)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> are you working on this issue?</p>



<a name="1038627"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038627" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038627">(Oct 15 2020 at 21:46)</a>:</h4>
<p>Hm, I found this: <a href="https://github.com/zulip/zulip/blob/3.x/scripts/lib/install#L389">https://github.com/zulip/zulip/blob/3.x/scripts/lib/install#L389</a><br>
Maybe this is the missing piece of code?</p>



<a name="1038629"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038629" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038629">(Oct 15 2020 at 21:47)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> I don’t see how this code path was ever supposed to work. <code>scripts/setup/initialize-database --quiet</code> and <code>manage.py generate_realm_creation_link</code> cannot run without Django being set up. I’m assuming the intended way to set up a database-only server is using <code>--no-init-db</code> and then manually running those commands later from the app frontend server, but this is not documented anywhere.</p>



<a name="1038630"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038630" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038630">(Oct 15 2020 at 21:47)</a>:</h4>
<p>Yeah, the assumption is that a database-only server doesn't get the config, because we don't want a venv -- so it's not in charge of setting up the DB.</p>



<a name="1038632"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038632" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038632">(Oct 15 2020 at 21:48)</a>:</h4>
<p>In theory we should be able to initialize the database in the postgres server, connect the application server, and do Django migrations etc. from the application server side?</p>



<a name="1038633"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038633" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038633">(Oct 15 2020 at 21:48)</a>:</h4>
<p>I don't think we have instructions for that sort of flow.</p>



<a name="1038636"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038636" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038636">(Oct 15 2020 at 21:49)</a>:</h4>
<p>(We do actually get a venv, but we don’t get a Django configuration.)</p>



<a name="1038643"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038643" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anders Kaseorg <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038643">(Oct 15 2020 at 21:50)</a>:</h4>
<p>So basically there are like three of us for whom “it's not hard to do postgres on a separate VM” is actually true.</p>



<a name="1038647"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038647" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038647">(Oct 15 2020 at 21:52)</a>:</h4>
<p><span class="user-mention" data-user-id="17322">@Robert</span>: Can you run that the installer with <code>--no-init-db</code>?</p>
<p>To be clear, you already have one host that you installed on -- does that one currently have a local postgres?</p>



<a name="1038648"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038648" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038648">(Oct 15 2020 at 21:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="699">Anders Kaseorg</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1038643">said</a>:</p>
<blockquote>
<p>So basically there are like three of us for whom “it's not hard to do postgres on a separate VM” is actually true.</p>
</blockquote>
<p>I think the point you're attempting to make is that the documentation is lacking in how to do this, since it's seldom attempted.  Which yes, I agree with.</p>



<a name="1038657"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038657" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038657">(Oct 15 2020 at 21:54)</a>:</h4>
<p><a href="https://github.com/zulip/zulip/commit/5b7be7ba5dc80626c297ae439a08ab47e6ecef1f">5b7be7ba5dc80626c297ae439a08ab47e6ecef1f</a> is relevant here.</p>



<a name="1038668"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038668" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038668">(Oct 15 2020 at 21:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1038647">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="17322">Robert</span>: Can you run that the installer with <code>--no-init-db</code>?</p>
</blockquote>
<p>Sure, I can try it.</p>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1038647">said</a>:</p>
<blockquote>
<p>To be clear, you already have one host that you installed on -- does that one currently have a local postgres?</p>
</blockquote>
<p>Yes and yes. (But there is no need to copy the contents of the old database to the new one. There haven't been any important contents yet).</p>



<a name="1038673"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038673" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038673">(Oct 15 2020 at 21:58)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> <br>
Do you mean that I should run<br>
<code>env PUPPET_CLASSES=zulip::base,zulip::apt_repository,zulip::postgres_appdb_tuned ./scripts/setup/install --no-init-db --email=user@host --hostname=host</code><br>
or<br>
<code>./scripts/setup/install --no-init-db --email=user@host --hostname=host</code>?</p>



<a name="1038674"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038674" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038674">(Oct 15 2020 at 21:58)</a>:</h4>
<p>The former; sorry for not being specific.</p>



<a name="1038694"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038694" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038694">(Oct 15 2020 at 22:03)</a>:</h4>
<p>Ok, I ran the command<br>
<code>env PUPPET_CLASSES=zulip::base,zulip::apt_repository,zulip::postgres_appdb_tuned ./scripts/setup/install --no-init-db --email=user@host --hostname=host</code>.<br>
I'm not sure to what extend the results of the last attempts have been reused, but the command resulted in</p>
<div class="codehilite"><pre><span></span><code> Success!

 Stopping because --no-init-db was passed.
 To complete the installation, configure postgres and then run:

   su zulip -c &#39;/home/zulip/deployments/current/scripts/setup/initialize-database&#39;
   su zulip -c &#39;/home/zulip/deployments/current/manage.py generate_realm_creation_link&#39;
</code></pre></div>



<a name="1038696"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038696" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038696">(Oct 15 2020 at 22:03)</a>:</h4>
<p>OK -- that's great!</p>
<p>I think the right steps are to:</p>
<ol>
<li>Take a <a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html#backups">backup</a>.</li>
<li>Set <code>REMOTE_POSTGRES_HOST = 'your.postgres.hostname'</code> in <code>/etc/zulip/settings.py</code> on the main host.</li>
<li><a href="https://zulip.readthedocs.io/en/latest/production/export-and-import.html#restoring-backups">Restore</a> that same backup, which should set up the database tables in the remote postgres host.</li>
</ol>



<a name="1038698"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038698" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038698">(Oct 15 2020 at 22:05)</a>:</h4>
<p>Cleanup is then:</p>
<ol>
<li>Update <code>/etc/zulip/zulip.conf</code> on the application-frontend-only server to only have <code>puppet_classes = zulip::app_frontend, zulip::memcached, zulip::rabbit, zulip::redis</code>, so it doesn't think it needs to have a database.</li>
<li>Drop the database from the app frontend server.</li>
</ol>



<a name="1038701"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038701" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038701">(Oct 15 2020 at 22:11)</a>:</h4>
<p>Oh, I skipped a step before step 3, which is to set up postgres auth such that the app server can talk to the pg server.</p>



<a name="1038725"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038725" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038725">(Oct 15 2020 at 22:18)</a>:</h4>
<p>I think <a href="https://zulip.readthedocs.io/en/latest/production/deployment.html#using-zulip-with-amazon-rds-as-the-database">https://zulip.readthedocs.io/en/latest/production/deployment.html#using-zulip-with-amazon-rds-as-the-database</a> is likely reasonably parallel to what needs to happen; we're at step 2, effectively.  Instead of a dump-and-restore for step 3, it's going to generate a new one, which sounds like it's fine for your use case.</p>



<a name="1038736"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038736" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038736">(Oct 15 2020 at 22:19)</a>:</h4>
<p>That also elides the Postgres configuration necessary, which is mentioned only in passing in <a href="https://zulip.readthedocs.io/en/latest/production/postgres.html#remote-postgres-database">https://zulip.readthedocs.io/en/latest/production/postgres.html#remote-postgres-database</a> as well.</p>



<a name="1038760"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038760" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038760">(Oct 15 2020 at 22:25)</a>:</h4>
<p>Thank you!<br>
So I configured <code>REMOTE_POSTGRES_HOST</code> and set <code>REMOTE_POSTGRES_SSLMODE</code> to <code>verify-full</code> (on the application server side).<br>
Then I checked the postgres on the remote postgres server we just installed and it seems to already have a zulip user:</p>
<div class="codehilite"><pre><span></span><code>postgres=# \du
                                   List of roles
 Role name |                         Attributes                         | Member of
-----------+------------------------------------------------------------+-----------
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
 zulip     |                                                            | {}
</code></pre></div>


<p>So the next step would be to set the password for the zulip user in the db and save it in the application server's settings.py as well, right?</p>



<a name="1038778"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038778" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038778">(Oct 15 2020 at 22:29)</a>:</h4>
<p>(We should make sure we add better documentation for this process once we've helped Robert)</p>



<a name="1038792"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038792" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038792">(Oct 15 2020 at 22:31)</a>:</h4>
<p>Yup; either password or certificate auth.  If you use the former, <code>postgres_password = abcd1234</code> goes in <code>/etc/zulip/zulip-secrets.conf</code></p>
<p>And IIRC you'll need to set up postgres to listen not just on the loopback.</p>



<a name="1038794"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038794" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038794">(Oct 15 2020 at 22:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="7">Tim Abbott</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1038778">said</a>:</p>
<blockquote>
<p>(We should make sure we add better documentation for this process once we've helped Robert)</p>
</blockquote>
<p>Of course.</p>



<a name="1038849"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1038849" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1038849">(Oct 15 2020 at 22:58)</a>:</h4>
<p>I'll continue tomorrow and report on the results, thank you very much!<br>
(I'm in Europe and it's 00:58...)</p>



<a name="1039454"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039454" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039454">(Oct 16 2020 at 20:36)</a>:</h4>
<p>Hi, everything seems to be successfully setup now, thank you! The only thing I did not manage yet is the password authentication. If I want to run the first command of <a href="https://zulip.readthedocs.io/en/latest/production/deployment.html#step-3-configure-zulip-to-use-the-postgres-database">step 3</a> or just <code>supervisorctl restart all</code>, I get:</p>
<div class="codehilite"><pre><span></span><code>psycopg2.OperationalError: FATAL:  password authentication failed for user &quot;zulip&quot;
[...]
django.db.utils.OperationalError: FATAL:  password authentication failed for user &quot;zulip&quot;
</code></pre></div>


<p>But Zulip supports the scram-sha-256 <a href="https://www.postgresql.org/docs/12/auth-password.html">password authentication method</a>, doesn't it?</p>



<a name="1039456"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039456" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039456">(Oct 16 2020 at 20:44)</a>:</h4>
<p>You've verified you can connect to the database host from the frontend via <code>psql</code> ?</p>



<a name="1039459"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039459" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039459">(Oct 16 2020 at 20:53)</a>:</h4>
<p>Yes :-)</p>



<a name="1039460"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039460" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039460">(Oct 16 2020 at 20:54)</a>:</h4>
<p>Using <code>psql "host=localhost dbname=zulip user=zulip sslmode=require"</code></p>



<a name="1039464"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039464" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039464">(Oct 16 2020 at 21:03)</a>:</h4>
<p>Oh, I forgot to mention: The connection works also between the two hosts, not only on localhost.</p>



<a name="1039466"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039466" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039466">(Oct 16 2020 at 21:11)</a>:</h4>
<p>Ah, yeah, verifying not just the password but also the cross-host bit was what I was getting at.</p>



<a name="1039467"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039467" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039467">(Oct 16 2020 at 21:11)</a>:</h4>
<p>And the password is in <code>/etc/zulip/zulip-secrets.conf</code> as <code>postgres_password = xxxx</code> ?</p>



<a name="1039468"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039468" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039468">(Oct 16 2020 at 21:14)</a>:</h4>
<p>We're just using Django's default Pg backend, which is psycopg2, which uses libpq, so it should support scram-sha-256.</p>



<a name="1039469"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039469" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039469">(Oct 16 2020 at 21:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1039467">said</a>:</p>
<blockquote>
<p>And the password is in <code>/etc/zulip/zulip-secrets.conf</code> as <code>postgres_password = xxxx</code> ?</p>
</blockquote>
<p>Yes</p>
<p>Do you know anything I could do to further investigate this issue?</p>



<a name="1039470"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039470" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039470">(Oct 16 2020 at 21:17)</a>:</h4>
<p>Or are there restrictions regarding the password? (max length, invalid characters)?</p>



<a name="1039471"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039471" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039471">(Oct 16 2020 at 21:18)</a>:</h4>
<p>Let's try this:</p>
<div class="codehilite"><pre><span></span><code>sudo -i -u zulip
cd ~/deployments/current
source zulip-py3-venv/bin/activate
ipython3

import psycopg2
psycopg2.connect(&quot;host=your-db-hostname.here dbname=zulip user=zulip sslmode=require password=hunter2&quot;)
</code></pre></div>


<p>(Edited to use the same format as you have above, if you prefer that)</p>



<a name="1039472"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039472" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039472">(Oct 16 2020 at 21:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="17322">Robert</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1039470">said</a>:</p>
<blockquote>
<p>Or are there restrictions regarding the password? (max length, invalid characters)?</p>
</blockquote>
<p>Not that I know of.</p>



<a name="1039473"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039473" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039473">(Oct 16 2020 at 21:19)</a>:</h4>
<p>We use certificate authentication in production, but others are happily using password auth.</p>



<a name="1039474"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039474" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039474">(Oct 16 2020 at 21:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1039472">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="17322">Robert</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1039470">said</a>:</p>
<blockquote>
<p>Or are there restrictions regarding the password? (max length, invalid characters)?</p>
</blockquote>
<p>Not that I know of.</p>
</blockquote>
<p>There are (somewhere, maybe it got saved in a wrong way in the database?). I just tried a password using only 30 alphanumeric characters and now, it works...</p>



<a name="1039475"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039475" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039475">(Oct 16 2020 at 21:23)</a>:</h4>
<p>I tried to use the HTTPS certificates, but I think, I would need a special certificate for the client?</p>



<a name="1039476"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039476" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039476">(Oct 16 2020 at 21:23)</a>:</h4>
<p>Yeah, HTTPS certificates use a client certificate to identify who is connecting.</p>



<a name="1039477"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039477" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039477">(Oct 16 2020 at 21:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="17322">Robert</span> <a href="#narrow/stream/31-production-help/topic/hardware.20requirements/near/1039474">said</a>:</p>
<blockquote>
<p>There are (somewhere, maybe it got saved in a wrong way in the database?). I just tried a password using only 30 alphanumeric characters and now, it works...</p>
</blockquote>
<p>Oho!  Can you share what you were using for the non-working password, if it's random and you're not using it anymore?</p>



<a name="1039478"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039478" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039478">(Oct 16 2020 at 21:24)</a>:</h4>
<p>Or some hint at the non-alphanumeric characters and/or length.</p>



<a name="1039479"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039479" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039479">(Oct 16 2020 at 21:25)</a>:</h4>
<p>Sure: <code>|'c)l&gt;!Q"fSqefj"=m|Z*OoA_r@vIx=Dv:LnF?r7^\hy.J&gt;oR5#D#K3i8SCx9[y7mU;Bl2g=c_#6erx3U|B/MMm1Qu}vl_vcAH#q</code><br>
(I use a password manager, so it does not matter for me how complicate the password is... <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> )</p>



<a name="1039480"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039480" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039480">(Oct 16 2020 at 21:27)</a>:</h4>
<p>Great; I'll see if I can replicate.</p>



<a name="1039481"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039481" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039481">(Oct 16 2020 at 21:28)</a>:</h4>
<p>Regarding the certificates: I tried to reuse the HTTPS certificates of my two VMs as auth for postgres, but that did not work. I assumed that they may be the wrong certificates for this purpose, because the purpose stored in the certificate is "Server Authentication". Or am I wrong? Then I might retry it...</p>



<a name="1039482"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039482" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039482">(Oct 16 2020 at 21:28)</a>:</h4>
<p>Yeah, client certificates are different than HTTPS server certificates.</p>



<a name="1039483"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039483" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039483">(Oct 16 2020 at 21:30)</a>:</h4>
<p>Client certificates are signed by the server's certificates.  In this case, that means the frontend has a certificate signed by the postgres server's certificate; in general, these certs are only used for this specific authentication.</p>



<a name="1039503"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039503" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039503">(Oct 16 2020 at 22:02)</a>:</h4>
<p>Parts of postgres apparently truncate password entry at 99 characters: <a href="https://github.com/postgres/postgres/blob/REL_12_STABLE/src/bin/psql/command.c#L1828-L1829">https://github.com/postgres/postgres/blob/REL_12_STABLE/src/bin/psql/command.c#L1828-L1829</a></p>



<a name="1039505"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039505" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039505">(Oct 16 2020 at 22:05)</a>:</h4>
<p>This is fixed in master a month ago, but not any released versions of Postgres: <a href="https://github.com/postgres/postgres/commit/67a472d71c98c3d2fa322a1b4013080b20720b98">https://github.com/postgres/postgres/commit/67a472d71c98c3d2fa322a1b4013080b20720b98</a></p>



<a name="1039506"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039506" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039506">(Oct 16 2020 at 22:06)</a>:</h4>
<p>So yes, 101-character long passwords may be a problem in some contexts. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1039968"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039968" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039968">(Oct 17 2020 at 12:46)</a>:</h4>
<p>Ok, thank you :-)<br>
I had some trouble trying to use certificates, so I purged postgresql using apt and reinstalled it as we discussed here.<br>
However, if I like to create the organization after successfully setting up the db using <code>sudo -u zulip /home/zulip/deployments/current/scripts/setup/initialize-database</code>, I got:<br>
<code>[Django] host: insert or update on table "zerver_useractivity" violates foreign key constraint "zerver_useractivity_client_id_bb848fef_fk_zerver_client_id"\nDETAIL:  Key (client_id)=(5) is not present in table "zerver_client".\n</code><br>
the first time and<br>
<code>[Django] host: insert or update on table "zerver_message" violates foreign key constraint "zerver_message_sending_client_id_1c38413f_fk_zerver_client_id"\nDETAIL:  Key (sending_client_id)=(2) is not present in table "zerver_client".\n</code><br>
the second time I tried it (after another reinstall).<br>
Did I forgot anything?</p>



<a name="1039969"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1039969" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1039969">(Oct 17 2020 at 13:57)</a>:</h4>
<p>Or maybe you could tell me how to properly remove the database so I can reinstall it cleanly? I'm still a beginner and I think, I played around too much...</p>



<a name="1040086"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1040086" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1040086">(Oct 17 2020 at 21:12)</a>:</h4>
<p>I tried again and here the detailed process:</p>
<ul>
<li>purge all packages containing 'postgres' in their name using aptitude</li>
<li>manually remove /var/lib/postgresql/ and /usr/share/postgresql/</li>
<li>run <code>sudo env PUPPET_CLASSES=zulip::base,zulip::apt_repository,zulip::postgres_appdb_tuned ./scripts/setup/install --no-init-db</code> [success]</li>
<li>comment out the line <code>"$(dirname "$0")/flush-memcached"</code> in scripts/setup/postgres-init-db and run it using sudo [success]</li>
<li>make some changes in <code>postgresql.conf</code> and <code>pg_hba.conf</code> and restart the database [success]</li>
<li>set the correct password for the <code>zulip</code> user in the database</li>
<li>switch to application server (= postgres server client)</li>
<li>set the correct password in <code>settings.py</code></li>
<li>run <code>sudo -u zulip /home/zulip/deployments/current/scripts/setup/initialize-database</code> [success]</li>
<li>run <code>sudo -u zulip /home/zulip/deployments/current/manage.py generate_realm_creation_link</code> [success]</li>
<li>go to realm creation link and sign up</li>
<li>get redirected to <code>Internal server error</code> in the browser and receive email with subject:</li>
</ul>
<div class="codehilite"><pre><span></span><code>[Django] host: insert or update on table &quot;zerver_message&quot; violates foreign key constraint &quot;zerver_message_sending_client_id_1c38413f_fk_zerver_client_id&quot;\nDETAIL:  Key (sending_client_id)=(2) is not present in table &quot;zerver_client&quot;.\n
</code></pre></div>



<a name="1040606"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/hardware%20requirements/near/1040606" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Robert (ro-i) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/hardware.20requirements.html#1040606">(Oct 18 2020 at 19:11)</a>:</h4>
<p>follow-up question in <a class="stream-topic" data-stream-id="31" href="/#narrow/stream/31-production-help/topic/New.20remote.20postgres.20DB">#production help &gt; New remote postgres DB</a>, thank you :-)</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>