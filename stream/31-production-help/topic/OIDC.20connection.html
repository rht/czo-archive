<html>
<head><meta charset="utf-8"><title>OIDC connection · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html">OIDC connection</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1520521"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1520521" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pujan Poudyal <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1520521">(Mar 08 2023 at 06:45)</a>:</h4>
<p>Hello Zulip Community. I need help regarding oidc connection in my self-holted zulip server. Where can i post the help?</p>



<a name="1520522"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1520522" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1520522">(Mar 08 2023 at 06:48)</a>:</h4>
<p>A message was moved here from <a class="stream-topic" data-stream-id="2" href="/#narrow/stream/2-general/topic/Emoji.20Size">#general &gt; Emoji Size</a> by <span class="user-mention silent" data-user-id="12178">Alex Vandiver</span>.</p>



<a name="1520524"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1520524" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1520524">(Mar 08 2023 at 06:49)</a>:</h4>
<p><span class="user-mention" data-user-id="26342">@Pujan Poudyal</span>: Here's a good place to ask. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="1520525"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1520525" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1520525">(Mar 08 2023 at 06:49)</a>:</h4>
<p>I'm about to step away, so I can't help now, but if you post here then folks will help out as they come by.</p>



<a name="1521373"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1521373" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pujan Poudyal <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1521373">(Mar 09 2023 at 05:34)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> Thanks</p>



<a name="1521375"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1521375" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pujan Poudyal <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1521375">(Mar 09 2023 at 05:35)</a>:</h4>
<p>I am wso2 Identity Server as OIDC. After configuring i am getting following error:</p>
<div class="codehilite"><pre><span></span><code>social_core.exceptions.AuthFailed: Authentication failed: HTTPSConnectionPool(host=&#39;is.ithivesolutions.com&#39;, port=443): Max retries exceeded with url: /.well-known/openid-configuration (Caused by ProxyError(&#39;Cannot connect to proxy.&#39;, OSError(&#39;Tunnel connection failed: 407 Request rejected by proxy&#39;)))
</code></pre></div>



<a name="1521569"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1521569" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1521569">(Mar 09 2023 at 15:13)</a>:</h4>
<blockquote>
<p><div class="codehilite"><pre><span></span><code>Tunnel connection failed: 407 Request rejected by proxy
</code></pre></div><br>
</p>
</blockquote>
<p>That looks like the problem.  How have you configured your proxy?</p>



<a name="1522081"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1522081" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pujan Poudyal <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1522081">(Mar 10 2023 at 06:03)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> yes i did....</p>



<a name="1522102"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1522102" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pujan Poudyal <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1522102">(Mar 10 2023 at 06:52)</a>:</h4>
<div class="codehilite"><pre><span></span><code>[http_proxy]
host = 10.254.68.13
port = 9443
</code></pre></div>
<p>This is in zulip.conf.</p>
<p>We have identity server running in that host:port</p>



<a name="1522354"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1522354" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1522354">(Mar 10 2023 at 18:45)</a>:</h4>
<p>I'm not sure what you mean by "identity server"?</p>
<p>If your proxy requires authentication, I don't think we currently have a way to support that.</p>



<a name="1528152"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1528152" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Barry Green <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1528152">(Mar 20 2023 at 06:24)</a>:</h4>
<p>I've just encountered this same issue. I set up a nodejs server running oidc-provider as a test for Zulip to connect to. What I found is that when I had my Zulip server and nodejs server connected via Wireguard on a private IP (192.168.2.x), the Zulip logs would complain with this exact 407 error. Once I changed config to use public IP addresses, the issue disappeared.</p>
<p>Is there something in the code that requires the OIDC server to be on a public IP range? When I was on the Wireguard private network, the Zulip server wasn't even trying to hit the OIDC server. I checked this by enabling the Apache2 forensic module with logging, and nothing was logged from Zulip, compared to using curl directly (on the Zulip server) to get the OpenID configuration from the OIDC server, where I saw an entry in the log.</p>



<a name="1528313"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1528313" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1528313">(Mar 20 2023 at 14:08)</a>:</h4>
<p><span class="user-mention" data-user-id="18105">@Barry Green</span>: Hm!  That may point to the issue being Smokescreen, which is meant to prevent XSRF attacks against local-network hosts.</p>



<a name="1528314"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1528314" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1528314">(Mar 20 2023 at 14:09)</a>:</h4>
<p>Can you check <code>/var/log/zulip/smokescreen.log</code>?</p>



<a name="1528606"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1528606" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Barry Green <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1528606">(Mar 20 2023 at 19:31)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> Yep that's it!</p>
<div class="codehilite"><pre><span></span><code>&quot;The destination address (192.168.2.100) was denied by rule &#39;Deny: Private Range&#39;. destination address was denied by rule, see error&quot;
</code></pre></div>
<p>So can we customise the Smokescreen configuration?</p>



<a name="1528883"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1528883" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1528883">(Mar 21 2023 at 00:28)</a>:</h4>
<p><span class="user-mention" data-user-id="18105">@Barry Green</span> yes, see <a href="https://zulip.readthedocs.io/en/latest/production/deployment.html#customizing-the-outgoing-http-proxy">https://zulip.readthedocs.io/en/latest/production/deployment.html#customizing-the-outgoing-http-proxy</a>.</p>



<a name="1529219"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1529219" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1529219">(Mar 21 2023 at 13:42)</a>:</h4>
<p><span class="user-mention" data-user-id="18105">@Barry Green</span>: Note that while Smokescreen does support custom ACL lists (for instance to poke an exception through for the OIDC server) we don't have built-in support for that.  We've got the first parts of client identification into Smokescreen (in the form of sending an <code>X-Smokescreen-Role</code> proxy header) but that work isn't completed -- which means that you'd _also_ be opening up the OIDC server to requests from, say, custom webhooks.</p>



<a name="1529785"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1529785" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Barry Green <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1529785">(Mar 21 2023 at 22:09)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> OK. For now, and this is only in my dev environment, I've edited <code>/etc/supervisor/conf.d/zulip/smokescreen.conf</code> and added <code>--allow-range 192.168.2.0/24</code> to the command.</p>



<a name="1529796"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1529796" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1529796">(Mar 21 2023 at 22:17)</a>:</h4>
<p>Yup, that should work fine.</p>



<a name="1545134"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/OIDC%20connection/near/1545134" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> A. Casanova <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/OIDC.20connection.html#1545134">(Apr 11 2023 at 11:43)</a>:</h4>
<p>I am having a similar issue. See details here <a href="#narrow/stream/31-production-help/topic/OIDC.20error.20when.20login">https://chat.zulip.org/#narrow/stream/31-production-help/topic/OIDC.20error.20when.20login</a>.</p>
<p><span class="user-mention" data-user-id="18105">@Barry Green</span> <br>
How do you apply the changes after modifying the /etc/supervisor/conf.d/zulip/smokescreen.conf? You can see my commands in the other topic.</p>
<p>Thanks in advance</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>