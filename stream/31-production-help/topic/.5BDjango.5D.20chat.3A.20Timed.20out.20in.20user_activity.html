<html>
<head><meta charset="utf-8"><title>[Django] chat: Timed out in user_activity · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html">[Django] chat: Timed out in user_activity</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1414146"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414146" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414146">(Aug 02 2022 at 14:30)</a>:</h4>
<p>Anyone has any ideas what is causing this? It become gradually more and more often the occurance.</p>



<a name="1414147"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414147" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414147">(Aug 02 2022 at 14:30)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Logger root, from module zerver.worker.queue_processors line <span class="m">379</span>:
Error generated by Anonymous user <span class="o">(</span>not logged <span class="k">in</span><span class="o">)</span> on chat deployment

Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
 File <span class="s2">"/usr/lib/python3.8/os.py"</span>, line <span class="m">672</span>, <span class="k">in</span> __getitem__
   <span class="nv">value</span> <span class="o">=</span> self._data<span class="o">[</span>self.encodekey<span class="o">(</span>key<span class="o">)]</span>
KeyError: b<span class="s1">'DJANGO_ALLOW_ASYNC_UNSAFE'</span>
</code></pre></div>



<a name="1414149"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414149" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414149">(Aug 02 2022 at 14:31)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>During handling of the above exception, another exception occurred:

Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
 File <span class="s2">"/home/zulip/deployments/2022-08-01-19-55-31/zerver/worker/queue_processors.py"</span>, line <span class="m">314</span>, <span class="k">in</span> do_consume
   consume_func<span class="o">(</span>events<span class="o">)</span>
 File <span class="s2">"/home/zulip/deployments/2022-08-01-19-55-31/zerver/worker/queue_processors.py"</span>, line <span class="m">557</span>, <span class="k">in</span> consume_batch
   do_update_user_activity<span class="o">(</span>user_profile_id, client_id, query, count, log_time<span class="o">)</span>
 File <span class="s2">"/home/zulip/deployments/2022-08-01-19-55-31/zerver/decorator.py"</span>, line <span class="m">946</span>, <span class="k">in</span> wrapped_func
   <span class="nv">ret</span> <span class="o">=</span> func<span class="o">(</span>*args, **kwargs<span class="o">)</span>
 File <span class="s2">"/home/zulip/deployments/2022-08-01-19-55-31/zerver/actions/user_activity.py"</span>, line <span class="m">49</span>, <span class="k">in</span> do_update_user_activity
   activity.save<span class="o">(</span><span class="nv">update_fields</span><span class="o">=[</span><span class="s2">"last_visit"</span>, <span class="s2">"count"</span><span class="o">])</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/base.py"</span>, line <span class="m">806</span>, <span class="k">in</span> save
   self.save_base<span class="o">(</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/base.py"</span>, line <span class="m">857</span>, <span class="k">in</span> save_base
   <span class="nv">updated</span> <span class="o">=</span> self._save_table<span class="o">(</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/base.py"</span>, line <span class="m">970</span>, <span class="k">in</span> _save_table
   <span class="nv">updated</span> <span class="o">=</span> self._do_update<span class="o">(</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/base.py"</span>, line <span class="m">1034</span>, <span class="k">in</span> _do_update
   <span class="k">return</span> filtered._update<span class="o">(</span>values<span class="o">)</span> &gt; <span class="m">0</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/query.py"</span>, line <span class="m">885</span>, <span class="k">in</span> _update
   <span class="k">return</span> query.get_compiler<span class="o">(</span>self.db<span class="o">)</span>.execute_sql<span class="o">(</span>CURSOR<span class="o">)</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/sql/compiler.py"</span>, line <span class="m">1783</span>, <span class="k">in</span> execute_sql
   <span class="nv">cursor</span> <span class="o">=</span> super<span class="o">()</span>.execute_sql<span class="o">(</span>result_type<span class="o">)</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/sql/compiler.py"</span>, line <span class="m">1359</span>, <span class="k">in</span> execute_sql
   <span class="nv">cursor</span> <span class="o">=</span> self.connection.cursor<span class="o">()</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/utils/asyncio.py"</span>, line <span class="m">26</span>, <span class="k">in</span> inner
   <span class="k">return</span> func<span class="o">(</span>*args, **kwargs<span class="o">)</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/base/base.py"</span>, line <span class="m">284</span>, <span class="k">in</span> cursor
   <span class="k">return</span> self._cursor<span class="o">()</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/base/base.py"</span>, line <span class="m">262</span>, <span class="k">in</span> _cursor
   <span class="k">return</span> self._prepare_cursor<span class="o">(</span>self.create_cursor<span class="o">(</span>name<span class="o">))</span>
 File <span class="s2">"/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/django/utils/asyncio.py"</span>, line <span class="m">17</span>, <span class="k">in</span> inner
   <span class="k">if</span> not os.environ.get<span class="o">(</span><span class="s2">"DJANGO_ALLOW_ASYNC_UNSAFE"</span><span class="o">)</span>:
 File <span class="s2">"/usr/lib/python3.8/_collections_abc.py"</span>, line <span class="m">660</span>, <span class="k">in</span> get
   <span class="k">return</span> self<span class="o">[</span>key<span class="o">]</span>
 File <span class="s2">"/usr/lib/python3.8/os.py"</span>, line <span class="m">672</span>, <span class="k">in</span> __getitem__
   <span class="nv">value</span> <span class="o">=</span> self._data<span class="o">[</span>self.encodekey<span class="o">(</span>key<span class="o">)]</span>
 File <span class="s2">"/home/zulip/deployments/2022-08-01-19-55-31/zerver/worker/queue_processors.py"</span>, line <span class="m">360</span>, <span class="k">in</span> timer_expired
   raise WorkerTimeoutException<span class="o">(</span>self.queue_name, limit, len<span class="o">(</span>events<span class="o">))</span>
zerver.worker.queue_processors.WorkerTimeoutException: Timed out <span class="k">in</span> user_activity after <span class="m">30</span> seconds processing <span class="m">1</span> events


Deployed code:
- git: <span class="m">6</span>.0-dev-1177-gf2a3236b42
- ZULIP_VERSION: <span class="m">6</span>.0-dev-1177-gf2a3236b42
</code></pre></div>



<a name="1414150"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414150" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414150">(Aug 02 2022 at 14:32)</a>:</h4>
<p><a href="/user_uploads/2/aa/uBk3axLIzZhikLo4w8ft74pA/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/aa/uBk3axLIzZhikLo4w8ft74pA/image.png" title="image.png"><img src="/user_uploads/2/aa/uBk3axLIzZhikLo4w8ft74pA/image.png"></a></div>



<a name="1414151"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414151" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman (amanagr) <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414151">(Aug 02 2022 at 14:40)</a>:</h4>
<p>Looks similar to <a href="#narrow/stream/3-backend/topic/error.3A.20.22Timed.20out.20after.2030.20seconds.20processing.201.20events.22">https://chat.zulip.org/#narrow/stream/3-backend/topic/error.3A.20.22Timed.20out.20after.2030.20seconds.20processing.201.20events.22</a></p>



<a name="1414293"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414293" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414293">(Aug 02 2022 at 22:04)</a>:</h4>
<p>I think this is likely unrelated -- that one is about image previews when the third-party site is slow, and I believe is fixed.</p>



<a name="1414294"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414294" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414294">(Aug 02 2022 at 22:05)</a>:</h4>
<p><span class="user-mention" data-user-id="20576">@Cosmic Sound</span> so, the exception you see is a timeout doing an extremely inexpensive query (~1ms typically) to write some "last time this user did this API request" data.</p>



<a name="1414296"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414296" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414296">(Aug 02 2022 at 22:05)</a>:</h4>
<p>I don't have a good theory for what might cause that other than some sort of networking interruption between your Zulip server and your database, or the database having a deadlock or something.</p>



<a name="1414482"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414482" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414482">(Aug 03 2022 at 12:03)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> is there something we can do to debug this? In past week got like 7 such emails, yet they all differ a bit on the template used to report the errors.</p>



<a name="1414605"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1414605" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1414605">(Aug 03 2022 at 19:40)</a>:</h4>
<p><span class="user-mention" data-user-id="20576">@Cosmic Sound</span> well, to start, can you talk about what sort of network you're running Zulip under? I can imagine something you're doing on your infrastructure, like "It's a virtualization system that freezes the machine for 1 minute periodically to do backups", for example, triggering this notification if it happened in the middle of the request.</p>



<a name="1415055"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1415055" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1415055">(Aug 04 2022 at 14:07)</a>:</h4>
<p><span class="user-mention" data-user-id="7">@Tim Abbott</span> we run on proxmox with KVM machines. Will check if backups were running at thise times. Yet we do run backups at night only. We also use ceph storage with NVM so our storage is very fast. Network its 1 gb vlan and 1 gb external from OVH.</p>



<a name="1415081"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1415081" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1415081">(Aug 04 2022 at 14:44)</a>:</h4>
<p>Could it be RAM usage? I had the machine run with 4 GB, now I increased to 6 GB, and I see over 4 used.</p>



<a name="1415095"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1415095" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1415095">(Aug 04 2022 at 15:38)</a>:</h4>
<div class="codehilite" data-code-language="logger"><pre><span></span><code>Error generated by Anonymous user (not logged in) on chat deployment

Traceback (most recent call last):
 File "/home/zulip/deployments/2022-08-01-19-55-31/zerver/management/commands/process_queue.py", line 24, in log_and_exit_if_exception
   yield
 File "/home/zulip/deployments/2022-08-01-19-55-31/zerver/management/commands/process_queue.py", line 106, in handle
   worker.setup()
 File "/home/zulip/deployments/2022-08-01-19-55-31/zerver/worker/queue_processors.py", line 398, in setup
   self.q = SimpleQueueClient(prefetch=self.PREFETCH)
 File "/home/zulip/deployments/2022-08-01-19-55-31/zerver/lib/queue.py", line 44, in __init__
   self._connect()
 File "/home/zulip/deployments/2022-08-01-19-55-31/zerver/lib/queue.py", line 142, in _connect
   self.connection = pika.BlockingConnection(self._get_parameters())
 File "/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/blocking_connection.py", line 360, in __init__
   self._impl = self._create_connection(parameters, _impl_class)
 File "/srv/zulip-venv-cache/b9b6b1e1f9bff55507160d19f5d4e646428ecb02/zulip-py3-venv/lib/python3.8/site-packages/pika/adapters/blocking_connection.py", line 451, in _create_connection
   raise self._reap_last_connection_workflow_error(error)
pika.exceptions.AMQPConnectionError


Deployed code:
- git: 6.0-dev-1177-gf2a3236b42
- ZULIP_VERSION: 6.0-dev-1177-gf2a3236b42


Request info: none```
</code></pre></div>



<a name="1415098"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1415098" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1415098">(Aug 04 2022 at 15:40)</a>:</h4>
<p>looking at dates are old</p>



<a name="1415099"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1415099" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Sound <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1415099">(Aug 04 2022 at 15:40)</a>:</h4>
<p>i received this one above last</p>



<a name="1415241"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1415241" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1415241">(Aug 04 2022 at 19:16)</a>:</h4>
<p><span class="user-mention" data-user-id="20576">@Cosmic Sound</span> that last one is usually what happens when you restart RabbitMQ (and thus Zulip experiences it as down for a bit); it's not of interest if it's not continuing, as presumably your RabbitMQ server restarted properly.</p>



<a name="1415243"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%5BDjango%5D%20chat%3A%20Timed%20out%20in%20user_activity/near/1415243" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Timed.20out.20in.20user_activity.html#1415243">(Aug 04 2022 at 19:17)</a>:</h4>
<p>I don't see a clear reason that RAM usage would cause this sort of timeout in a write to the database that would typically take about a millisecond, but I can't rule it out in a virtualization environment.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>