<html>
<head><meta charset="utf-8"><title>✔ Upgrade to 5.0 fails in a container · production help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/czo-archive/stream/31-production-help/index.html">production help</a></h2>
<h3>Topic: <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html">✔ Upgrade to 5.0 fails in a container</a></h3>

<hr>

<base href="https://chat.zulip.org">

<head><link href="https://rht.github.io/czo-archive/style.css" rel="stylesheet"></head>

<a name="1356223"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1356223" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1356223">(Mar 30 2022 at 17:05)</a>:</h4>
<p>Hi,</p>
<p>today I wanted to upgrade (from 4.11) to v5.0. The upgrade fails with the following error message:</p>
<div class="codehilite"><pre><span></span><code>2022-03-30 16:53:03,566 upgrade-zulip: Archiving the tarball under /home/zulip/archives
2022-03-30 16:53:34,303 upgrade-zulip: Unpacking the tarball
2022-03-30 16:53:45,391 upgrade-zulip-stage-2: Upgrading system packages...
Hit:1 http://ftp.debian.org/debian bullseye InRelease
Hit:2 http://ftp.debian.org/debian bullseye-updates InRelease
Hit:3 https://deb.debian.org/debian-security bullseye-security InRelease
Hit:5 http://apt.postgresql.org/pub/repos/apt bullseye-pgdg InRelease
Hit:4 https://apt-archive.postgresql.org/pub/repos/apt bullseye-pgdg-archive InRelease
Hit:6 https://packages.groonga.org/debian bullseye InRelease
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
Calculating upgrade...
The following packages were automatically installed and are no longer required:
  libevent-core-2.1-7 libevent-pthreads-2.1-7 libopts25 sntp
Use &#39;apt autoremove&#39; to remove them.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
+ apt-get -y install build-essential libffi-dev libfreetype6-dev zlib1g-dev libjpeg-dev libldap2-dev python3-dev python3-pip virtualenv libxml2-dev libxslt1-dev libpq-dev libssl-dev libmagic1 libyaml-dev libxmlsec1-dev pkg-config jq libsasl2-dev
Reading package lists...
Building dependency tree...
Reading state information...
build-essential is already the newest version (12.9).
libsasl2-dev is already the newest version (2.1.27+dfsg-2.1+deb11u1).
libmagic1 is already the newest version (1:5.39-3).
libfreetype6-dev is already the newest version (2.10.4+dfsg-1).
jq is already the newest version (1.6-2.1).
libffi-dev is already the newest version (3.3-6).
libjpeg-dev is already the newest version (1:2.0.6-4).
libxml2-dev is already the newest version (2.9.10+dfsg-6.7+deb11u1).
libxslt1-dev is already the newest version (1.1.34-4).
libyaml-dev is already the newest version (0.2.2-1).
libldap2-dev is already the newest version (2.4.57+dfsg-3).
libssl-dev is already the newest version (1.1.1n-0+deb11u1).
pkg-config is already the newest version (0.29.2-1).
python3-pip is already the newest version (20.3.4-4+deb11u1).
virtualenv is already the newest version (20.4.0+ds-2+deb11u1).
python3-dev is already the newest version (3.9.2-3).
libxmlsec1-dev is already the newest version (1.2.31-1).
zlib1g-dev is already the newest version (1:1.2.11.dfsg-2).
libpq-dev is already the newest version (14.2-1.pgdg110+1).
The following packages were automatically installed and are no longer required:
  libevent-core-2.1-7 libevent-pthreads-2.1-7 libopts25 sntp
Use &#39;apt autoremove&#39; to remove them.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Using cached Python venv from /srv/zulip-venv-cache/e2ea2c72ccf4cb51730289f3971a079641e6b8d0/zulip-py3-venv
+ ln -nsf /srv/zulip-venv-cache/e2ea2c72ccf4cb51730289f3971a079641e6b8d0/zulip-py3-venv /home/zulip/deployments/2022-03-30-18-53-34/zulip-py3-venv
generate_secrets: No new secrets to generate.
2022-03-30 16:54:49,266 upgrade-zulip-stage-2: Installing static assets...
2022-03-30 16:55:56,900 upgrade-zulip-stage-2: Checking for needed migrations
2022-03-30 16:56:11,557 upgrade-zulip-stage-2: Stopping Zulip...
process-fts-updates: stopped
zulip-django: stopped
zulip-tornado: stopped
zulip-workers:zulip_events_error_reports: stopped
zulip-workers:zulip_events_missedmessage_emails: stopped
zulip-workers:zulip_events_invites: stopped
zulip-workers:zulip_events_email_senders: stopped
zulip-workers:zulip_events_deferred_work: stopped
zulip-workers:zulip_events_email_mirror: stopped
zulip-workers:zulip_events_embedded_bots: stopped
zulip-workers:zulip_events_user_activity: stopped
zulip-workers:zulip_events_embed_links: stopped
zulip-workers:zulip_events_missedmessage_mobile_notifications: stopped
zulip-workers:zulip_events_user_activity_interval: stopped
zulip-workers:zulip_events_outgoing_webhooks: stopped
zulip-workers:zulip_events_user_presence: stopped
zulip-workers:zulip_events_digest_emails: stopped
zulip_deliver_scheduled_emails: stopped
zulip_deliver_scheduled_messages: stopped

Zulip stopped successfully!
2022-03-30 16:56:16,048 upgrade-zulip-stage-2: Applying Puppet changes...
Notice: Compiled catalog for knecht.xxxxxxxxxxx.com in environment production in 2.58 seconds
Error: Systemd start for chrony failed!
journalctl log for chrony:
-- Journal begins at Thu 2021-07-15 03:12:17 CEST, ends at Wed 2022-03-30 18:56:28 CEST. --
Mar 30 18:52:25 knecht.xxxxxxxxxxx.com systemd[1]: Starting chrony, an NTP client/server...
Mar 30 18:52:25 knecht.xxxxxxxxxxx.com chronyd[275]: adjtimex(0x8001) failed : Operation not permitted
Mar 30 18:52:26 knecht.xxxxxxxxxxx.com systemd[1]: chrony.service: Control process exited, code=exited, status=1/FAILURE
Mar 30 18:52:26 knecht.xxxxxxxxxxx.com systemd[1]: chrony.service: Failed with result &#39;exit-code&#39;.
Mar 30 18:52:26 knecht.xxxxxxxxxxx.com systemd[1]: Failed to start chrony, an NTP client/server.
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com systemd[1]: Starting chrony, an NTP client/server...
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com chronyd[1615]: chronyd version 4.0 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +NTS +SECHASH +IPV6 -DEBUG)
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com chronyd[1615]: Fatal error : adjtimex(0x8001) failed : Operation not permitted
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com chronyd[1613]: adjtimex(0x8001) failed : Operation not permitted
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com systemd[1]: chrony.service: Control process exited, code=exited, status=1/FAILURE
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com systemd[1]: chrony.service: Failed with result &#39;exit-code&#39;.
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com systemd[1]: Failed to start chrony, an NTP client/server.

Error: /Stage[main]/Zulip::Profile::Base/Service[chrony]/ensure: change from &#39;stopped&#39; to &#39;running&#39; failed: Systemd start for chrony failed!
journalctl log for chrony:
-- Journal begins at Thu 2021-07-15 03:12:17 CEST, ends at Wed 2022-03-30 18:56:28 CEST. --
Mar 30 18:52:25 knecht.xxxxxxxxxxx.com systemd[1]: Starting chrony, an NTP client/server...
Mar 30 18:52:25 knecht.xxxxxxxxxxx.com chronyd[275]: adjtimex(0x8001) failed : Operation not permitted
Mar 30 18:52:26 knecht.xxxxxxxxxxx.com systemd[1]: chrony.service: Control process exited, code=exited, status=1/FAILURE
Mar 30 18:52:26 knecht.xxxxxxxxxxx.com systemd[1]: chrony.service: Failed with result &#39;exit-code&#39;.
Mar 30 18:52:26 knecht.xxxxxxxxxxx.com systemd[1]: Failed to start chrony, an NTP client/server.
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com systemd[1]: Starting chrony, an NTP client/server...
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com chronyd[1615]: chronyd version 4.0 starting (+CMDMON +NTP +REFCLOCK +RTC +PRIVDROP +SCFILTER +SIGND +ASYNCDNS +NTS +SECHASH +IPV6 -DEBUG)
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com chronyd[1615]: Fatal error : adjtimex(0x8001) failed : Operation not permitted
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com chronyd[1613]: adjtimex(0x8001) failed : Operation not permitted
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com systemd[1]: chrony.service: Control process exited, code=exited, status=1/FAILURE
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com systemd[1]: chrony.service: Failed with result &#39;exit-code&#39;.
Mar 30 18:56:28 knecht.xxxxxxxxxxx.com systemd[1]: Failed to start chrony, an NTP client/server.

Notice: /Stage[main]/Zulip::Profile::Redis/File[/run/redis]/mode: mode changed &#39;2755&#39; to &#39;0755&#39;
Notice: Applied catalog in 2.16 seconds
Traceback (most recent call last):
  File &quot;/home/zulip/deployments/2022-03-30-18-53-34/scripts/lib/upgrade-zulip-stage-2&quot;, line 361, in &lt;module&gt;
    subprocess.check_call([&quot;./scripts/zulip-puppet-apply&quot;, &quot;--force&quot;])
  File &quot;/usr/lib/python3.9/subprocess.py&quot;, line 373, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command &#39;[&#39;./scripts/zulip-puppet-apply&#39;, &#39;--force&#39;]&#39; returned non-zero exit status 1.
</code></pre></div>
<p>So <code>chrony</code> seems not to start. Any ideas why or what can I do next?</p>
<p>Best, Ronny</p>



<a name="1356236"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1356236" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1356236">(Mar 30 2022 at 17:25)</a>:</h4>
<p><span class="user-mention" data-user-id="14849">@Ronny</span>: Is this install in a container of some sort?</p>



<a name="1356320"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1356320" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1356320">(Mar 30 2022 at 18:38)</a>:</h4>
<p>I merged <a href="https://github.com/zulip/zulip/pull/21598">#21598</a>, so upgrading to the <code>5.x</code> branch should avoid that problem.</p>



<a name="1356328"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1356328" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1356328">(Mar 30 2022 at 18:44)</a>:</h4>
<p>You backported to <code>5.x</code>?</p>



<a name="1356331"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1356331" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1356331">(Mar 30 2022 at 18:44)</a>:</h4>
<p>Ah, yes.</p>



<a name="1356340"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1356340" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1356340">(Mar 30 2022 at 18:45)</a>:</h4>
<p>My guess is we'll end up doing a 5.1 release in the next day or so to get a fix for this into a release.</p>



<a name="1356342"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1356342" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1356342">(Mar 30 2022 at 18:45)</a>:</h4>
<p>But I'm still catching up on other threads, so don't know if there's anything else we'll want to include.</p>



<a name="1356910"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1356910" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1356910">(Mar 31 2022 at 05:56)</a>:</h4>
<p><span class="user-mention" data-user-id="12178">@Alex Vandiver</span> Hi, yes it's a rented vServer...</p>



<a name="1356923"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1356923" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1356923">(Mar 31 2022 at 06:15)</a>:</h4>
<p><code>virt-what</code> gives following output:</p>
<div class="codehilite"><pre><span></span><code>openvz
lxc
</code></pre></div>



<a name="1357317"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1357317" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Vandiver <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1357317">(Mar 31 2022 at 17:33)</a>:</h4>
<p><span class="user-mention" data-user-id="14849">@Ronny</span>: This is now fixed in <code>main</code>, and <code>5.x</code>.  We expect to do a 5.1 release which includes this fix, probably by tomorrow.</p>



<a name="1358721"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1358721" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Abbott <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1358721">(Apr 02 2022 at 07:01)</a>:</h4>
<p><span class="user-mention" data-user-id="14849">@Ronny</span> just letting you know that the 5.1 release is out with the fix for this issue.</p>



<a name="1358876"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1358876" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ronny <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1358876">(Apr 02 2022 at 16:44)</a>:</h4>
<p>Thanks! <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span> Upgrade runs smooth again! Great work! </p>
<div class="message_inline_image"><a href="https://media0.giphy.com/media/MAzunB1Ru6zAYlYgPD/giphy.gif?cid=c623cb355djqejhz79jatvf3zm7z944jpo9g7psr0lm58wu3&amp;rid=giphy.gif&amp;ct=g"><img src="/external_content/60b786a74b352603662a56fde5a69f5ae135d47a/68747470733a2f2f6d65646961302e67697068792e636f6d2f6d656469612f4d417a756e42315275367a41596c596750442f67697068792e6769663f6369643d633632336362333535646a71656a687a37396a61747666337a6d377a3934346a706f396737707372306c6d3538777533267269643d67697068792e6769662663743d67"></a></div>



<a name="1358887"></a>
<h4><a href="https://chat.zulip.org#narrow/stream/31-production%20help/topic/%E2%9C%94%20Upgrade%20to%205.0%20fails%20in%20a%20container/near/1358887" class="zl"><img src="https://rht.github.io/czo-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://rht.github.io/czo-archive/stream/31-production-help/topic/.E2.9C.94.20Upgrade.20to.205.2E0.20fails.20in.20a.20container.html#1358887">(Apr 02 2022 at 16:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="12178">Alex Vandiver</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Oct 02 2023 at 04:38 UTC</p>
</html>