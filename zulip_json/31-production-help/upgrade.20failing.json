[
    {
        "content": "<p>The upgrade is failing for me on my VM running 1.3.13.<br>\nI downloaded 1.4.0 and ran the command:  <code>/home/zulip/deployments/current/scripts/upgrade-zulip zulip-server-1.4.0.tar.gz</code></p>\n<p>It runs for a long time and then finally fails at the following stage.</p>\n<div class=\"codehilite\"><pre>Notice: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[pg_ctlcluster 9.3 main restart]/returns: pg_ctl: server does not shut down\nNotice: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[pg_ctlcluster 9.3 main restart]/returns: HINT: The &quot;-m fast&quot; option immediately disconnects sessions rather than\nNotice: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[pg_ctlcluster 9.3 main restart]/returns: waiting for session-initiated disconnection.\nError: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[pg_ctlcluster 9.3 main restart]: Failed to call refresh: pg_ctlcluster 9.3 main restart returned 1 instead of one of [0]\nError: /Stage[main]/Zulip::Postgres_appdb_tuned/Exec[pg_ctlcluster 9.3 main restart]: pg_ctlcluster 9.3 main restart returned 1 instead of one of [0]\nNotice: /Stage[main]/Zulip::Base/Package[crudini]/ensure: ensure changed &#39;purged&#39; to &#39;present&#39;\nNotice: Finished catalog run in 115.44 seconds\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2016-08-27-20-51-27/scripts/lib/upgrade-zulip-stage-2&quot;, line 59, in &lt;module&gt;\n    subprocess.check_call([&quot;./scripts/zulip-puppet-apply&quot;, &quot;--force&quot;])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;./scripts/zulip-puppet-apply&#39;, &#39;--force&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 53, in &lt;module&gt;\n    subprocess.check_call([os.path.abspath(&quot;./scripts/lib/upgrade-zulip-stage-2&quot;), deploy_path])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2016-08-27-20-51-27/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2016-08-27-20-51-27&#39;]&#39; returned non-zero exit status 1\n</pre></div>\n\n\n<p>Anyone have any suggestions on what to do? I have a snapshot of my server, so I have rolled back and tried to run the upgrade more than once with the same result.</p>",
        "id": 20146,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472345196
    },
    {
        "content": "<p>It looks like some kind of permission problem.</p>",
        "id": 20147,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472347200
    },
    {
        "content": "<p>I'm running the command as root...</p>",
        "id": 20148,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472347533
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\">@Steve Howell</span>  Where do you see the permissions issue? I am running the command as root. Do you have a suggestion as to how I can correct the issue?</p>",
        "id": 20149,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472347882
    },
    {
        "content": "<p>No, sorry, the issue is not immediately apparent to me.  Did postgres have problems shutting down, possibly from the earlier version running?</p>",
        "id": 20150,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472348714
    },
    {
        "content": "<p>It was off when I checked. May have been slow to stop.</p>",
        "id": 20151,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472348829
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"gervais@demontbrun.com\">@GervaisdeM</span>  postgres can be slow to stop, so that could be your problem.  If so, probably just rerunning the upgrade script will work</p>",
        "id": 20152,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1472362152
    },
    {
        "content": "<p>(Hello from a brief window of Internet)</p>",
        "id": 20153,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1472362168
    },
    {
        "content": "<p>No upgrade for me...</p>\n<p>I ran:<br>\n<code>/home/zulip/deployments/current/scripts/upgrade-zulip zulip-server-1.4.0.tar.gz</code><br>\nIt failed, so I reran<br>\n<code>/home/zulip/deployments/current/scripts/upgrade-zulip zulip-server-1.4.0.tar.gz</code></p>\n<p>This is what the errors says:</p>\n<div class=\"codehilite\"><pre>+ sudo ln -nsf /srv/zulip-venv-cache/3f3aca99403f3bbcc8ffd2c4b24d1296f904c04b/zulip-venv /home/zulip/deployments/2016-08-28-20-12-34/zulip-venv\nprocess-fts-updates: ERROR (not running)\n2016-08-28 20:12:48,416 upgrade-zulip-stage-2: Stopping Zulip...\nzulip-django: ERROR (not running)\nzulip-tornado: ERROR (not running)\n2016-08-28 20:12:48,509 upgrade-zulip-stage-2: Applying puppet changes...\nNotice: Compiled catalog for zulip.demontbrun.com in environment production in 0.82 seconds\nNotice: /Stage[main]/Zulip::Postgres_common/Exec[disable_logrotate]/returns: executed successfully\nNotice: Finished catalog run in 1.47 seconds\nReading package lists...\nBuilding dependency tree...\nReading state information...\n0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\n2016-08-28 20:12:53,945 upgrade-zulip-stage-2: Applying database migrations...\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2016-08-28-20-12-34/scripts/lib/log-management-command&quot;, line 15, in &lt;module&gt;\n    file_handler = logging.FileHandler(settings.MANAGEMENT_LOG_PATH)\n  File &quot;/home/zulip/deployments/2016-08-28-20-12-34/zulip-venv/local/lib/python2.7/site-packages/django/conf/__init__.py&quot;, line 48, in __getattr__\n    self._setup(name)\n  File &quot;/home/zulip/deployments/2016-08-28-20-12-34/zulip-venv/local/lib/python2.7/site-packages/django/conf/__init__.py&quot;, line 44, in _setup\n    self._wrapped = Settings(settings_module)\n  File &quot;/home/zulip/deployments/2016-08-28-20-12-34/zulip-venv/local/lib/python2.7/site-packages/django/conf/__init__.py&quot;, line 92, in __init__\n    mod = importlib.import_module(self.SETTINGS_MODULE)\n  File &quot;/usr/lib/python2.7/importlib/__init__.py&quot;, line 37, in import_module\n    __import__(name)\n  File &quot;/home/zulip/deployments/2016-08-28-20-12-34/zproject/settings.py&quot;, line 85, in &lt;module&gt;\n    from .prod_settings import *\nImportError: No module named prod_settings\nTraceback (most recent call last):\n  File &quot;./manage.py&quot;, line 22, in &lt;module&gt;\n    &quot; &quot;.join(sys.argv)])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2016-08-28-20-12-34/scripts/lib/log-management-command&#39;, &#39;./manage.py migrate --noinput&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2016-08-28-20-12-34/scripts/lib/upgrade-zulip-stage-2&quot;, line 64, in &lt;module&gt;\n    subprocess.check_call([&quot;./manage.py&quot;, &quot;migrate&quot;, &quot;--noinput&quot;], preexec_fn=su_to_zulip)\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;migrate&#39;, &#39;--noinput&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 53, in &lt;module&gt;\n    subprocess.check_call([os.path.abspath(&quot;./scripts/lib/upgrade-zulip-stage-2&quot;), deploy_path])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2016-08-28-20-12-34/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2016-08-28-20-12-34&#39;]&#39; returned non-zero exit status 1\nroot@zulip:/home/zulip#\n</pre></div>\n\n\n<p><img alt=\":cry:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/cry.png\" title=\":cry:\"> </p>",
        "id": 20222,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472426616
    },
    {
        "content": "<p>Can you track down your <code>prod_settings.py</code> file?</p>",
        "id": 20223,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472426865
    },
    {
        "content": "<p>where should prod_settings.py be?<br>\nis there a standard directory where I should find it?<br>\nDoing a find on the server now.</p>",
        "id": 20224,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472427429
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\">@Steve Howell</span> I'm not finding it...</p>",
        "id": 20225,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472427614
    },
    {
        "content": "<p>interesting... I found a few template files...</p>\n<div class=\"codehilite\"><pre>/home/zulip/deployments/2016-08-28-20-05-05/zproject/prod_settings_template.py\n/home/zulip/deployments/2016-08-28-20-12-02/zproject/prod_settings_template.py\n/home/zulip/deployments/2016-08-28-20-12-34/zproject/prod_settings_template.py\n</pre></div>\n\n\n<p>I'm looking at them now. Where should they be in \"real life?\"</p>",
        "id": 20226,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472427899
    },
    {
        "content": "<p><a href=\"https://github.com/zulip/zulip/blob/master/scripts/upgrade-zulip-from-git#L69\" target=\"_blank\" title=\"https://github.com/zulip/zulip/blob/master/scripts/upgrade-zulip-from-git#L69\">https://github.com/zulip/zulip/blob/master/scripts/upgrade-zulip-from-git#L69</a></p>",
        "id": 20227,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472428366
    },
    {
        "content": "<p>Hmmm, that link I just posted might not be that helpful.  Your settings should be in <code>/etc/zulip/settings.py</code>.</p>",
        "id": 20228,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472428651
    },
    {
        "content": "<p>more info here: <a href=\"http://zulip.readthedocs.io/en/latest/settings.html#server-settings\" target=\"_blank\" title=\"http://zulip.readthedocs.io/en/latest/settings.html#server-settings\">http://zulip.readthedocs.io/en/latest/settings.html#server-settings</a></p>",
        "id": 20229,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472428706
    },
    {
        "content": "<p>Yep... that's where they are.</p>",
        "id": 20230,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472428733
    },
    {
        "content": "<p>So now that I have the location of my settings file, should there be something I am looking for in there? Something that is blocking my upgrade? </p>",
        "id": 20231,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472428853
    },
    {
        "content": "<p>I am wondering if the soft link didn't get created for some reason:</p>\n<div class=\"codehilite\"><pre>$ git grep zproject | grep ln\nscripts/lib/install:    ln -nsf /etc/zulip/settings.py /root/zulip/zproject/prod_settings.py\nscripts/lib/install:    ln -nsf /etc/zulip/settings.py &quot;$deploy_path&quot;/zproject/prod_settings.py\nscripts/upgrade-zulip-from-git:        subprocess.check_call([&quot;ln&quot;, &quot;-nsf&quot;, os.path.join(deploy_path, &quot;zproject/local_settings.py&quot;),\n</pre></div>",
        "id": 20232,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472429140
    },
    {
        "content": "<p>Did you run the install as root?  Did you see any error messages?</p>",
        "id": 20233,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472429197
    },
    {
        "content": "<p>I did run as root... No errors until the ones I posted here.</p>",
        "id": 20234,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472429231
    },
    {
        "content": "<p>Do you have a <code>/root/zulip/zproject</code> directory?</p>",
        "id": 20235,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472429257
    },
    {
        "content": "<p>My vm is a mess right now... I'll check un a minute... Sorry.</p>",
        "id": 20236,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472429267
    },
    {
        "content": "<p>I'm going to rerun everything and then check.</p>",
        "id": 20237,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472429293
    },
    {
        "content": "<p>Finally back with you... </p>\n<div class=\"codehilite\"><pre>root@zulip:/home/zulip# ls -ld /root/zulip/zproject\ndrwxr-xr-x 3 zulip zulip 4096 Aug 28 22:36 /root/zulip/zproject\nroot@zulip:/home/zulip# ls -ld /root/zulip\nlrwxrwxrwx 1 root root 28 Oct  4  2015 /root/zulip -&gt; /home/zulip/deployments/next\n</pre></div>\n\n\n<p>I do have a <code>/root/zulip/zproject</code> dir and it is pointing to the <code>next</code> deployment<br>\n<code>current</code> is still pointing to the old version</p>",
        "id": 20242,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472436089
    },
    {
        "content": "<p>Hmmm, this suggests that maybe the upgrade failed before getting to the point where it cut over the soft link to point to the new current version?</p>",
        "id": 20248,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472437896
    },
    {
        "content": "<p>I don't know enough about the deployment/upgrade process to comment.  <img alt=\":cry:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/cry.png\" title=\":cry:\"> <br>\nIt's 11:35pm here and my brain is done for the day... I'm rolling back to a working version and going to bed. <br>\nIt's very easy for me to get back to this point, so I can try again tomorrow.</p>\n<p>Thanks for the help so far and good night.</p>",
        "id": 20249,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472438170
    },
    {
        "content": "<p>Yeah, let's try again tomorrow!</p>",
        "id": 20251,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472438327
    },
    {
        "content": "<p>(oops, wrong stream)</p>",
        "id": 20252,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472438747
    },
    {
        "content": "<p>I still can't figure out why my server won't upgrade... I can't even remember how I set it up originally. <img alt=\":frowning:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/frowning.png\" title=\":frowning:\"> <br>\nI hate not being able to upgrade. If no one has any hints as to where I should look for a reason, perhaps I will try a fresh install and restore my db backup (and files, etc).</p>",
        "id": 20379,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472521587
    },
    {
        "content": "<p>I was thinking that it had something to do with my settings files and the server not loading the productions environment, but I don't think that is the case after looking at <a href=\"http://zulip.readthedocs.io\" target=\"_blank\" title=\"http://zulip.readthedocs.io\">zulip.readthedocs.io</a></p>\n<hr>\n<p>Any suggestions would be appreciated</p>",
        "id": 20499,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472523376
    },
    {
        "content": "<p>Have you been able to track down any log files that might help you understand what's going on?  Unfortunately, I don't think many folks in the world have done a Zulip upgrade since it was open sourced.  The one expert, Tim, is on vacation this week.</p>",
        "id": 20500,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472523526
    },
    {
        "content": "<p>All the scripts to do the upgrade should be more or less readable, and you can insert print statements in them to see progress.  Also, do you understand the basic process where we install to a new directory then cut over the soft link at the end?</p>",
        "id": 20501,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472523615
    },
    {
        "content": "<p>I think I do now. I've been doing a lot of reading. There is the upgrade.log, but the error is essentially the python error that I pasted in yesterday.</p>",
        "id": 20502,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472523868
    },
    {
        "content": "<p>I'll keep poking at it (in my evenings as this is not for work). Perhaps, I'll find it and be able to send some info back, or Tim might be able to steer me in the right direction.</p>\n<p>Thanks for the help <span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\">@Steve Howell</span> </p>",
        "id": 20503,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472523944
    },
    {
        "content": "<p>is this a similar error? <a href=\"https://github.com/zulip/zulip/issues/1731\" target=\"_blank\" title=\"https://github.com/zulip/zulip/issues/1731\">https://github.com/zulip/zulip/issues/1731</a></p>",
        "id": 20504,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472527152
    },
    {
        "content": "<p>In the changelog it appears we renamed local_settings.py to prod_settings.py.</p>",
        "id": 20505,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472527372
    },
    {
        "content": "<p>Or, to be precise, the changelog says this: \"Renamed local_settings.py symlink to prod_settings.py for clarity.\"</p>",
        "id": 20506,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472527522
    },
    {
        "content": "<p>line 63 or so of <code>scripts/lib/upgrade-zulip-stage-2</code> is where the migrations start to be applied, and that's where <code>zprojects/settings.py</code> seems to fail to import <code>prod_settings</code> from the same directory.  If you make the upgrade script stop right before applying the migrations, it would be worthwhile to snoop around to see where, if anywhere, prod_settings.py lives.</p>",
        "id": 20507,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472527896
    },
    {
        "content": "<p>I'm pretty sure what's happening is that the symlink is created in the previous version of <code>scripts/lib/upgrade-zulip</code> (via <code>scripts/lib/unpack-zulip</code>, which creates local_settings. Then the rest of the upgrade is processes by <code>scripts/lib/upgrade-zulip-stage-2</code> which expects prod_settings.</p>",
        "id": 21291,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472688288
    },
    {
        "content": "<p>That would make sense.</p>",
        "id": 21292,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472688350
    },
    {
        "content": "<p>Not sure the best way to address other than to add code to upgrade-zulip-stage-2 that checks for prod_settings.py and creates the symlink if not there</p>",
        "id": 21301,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472688740
    },
    {
        "content": "<p>though there's probably a case to re-factor the whole upgrade process to be driven from the new release, not the old one</p>",
        "id": 21302,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472688774
    },
    {
        "content": "<p>I'm pretty sure this means any upgrade from 1.3.x will fail without manual intervention</p>",
        "id": 21303,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472688834
    },
    {
        "content": "<p>Does prod_settings.py point to something outside of the release that's manually edited?</p>",
        "id": 21304,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472689453
    },
    {
        "content": "<p>yes, /etc/zulip/settings.py</p>",
        "id": 21305,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472689669
    },
    {
        "content": "<p>I'm setting up an instance of 1.3.13 to confirm right now</p>",
        "id": 21306,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472689723
    },
    {
        "content": "<p>not sure why we don't just include /etc/zulip/settings.py directly, but perhaps that's a django thing</p>",
        "id": 21307,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472689783
    },
    {
        "content": "<p>yeah, I think it's just trying to avoid having to put /etc/zulip in the Python path or have Django do a direct import to get there</p>",
        "id": 21310,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472689863
    },
    {
        "content": "<p>One thing that I am noticing is that even the old 1.13.13 upgrade script basically just untars the tarball, then it moves into the new deploy path to run stage 2.</p>",
        "id": 21311,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472689912
    },
    {
        "content": "<p>yeah</p>",
        "id": 21312,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472689988
    },
    {
        "content": "<p>Oh, I see, the problem is that unpack-zulip does more than unpacking.</p>",
        "id": 21313,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472690031
    },
    {
        "content": "<p>Like you said above.  (catching up here slowly but surely)</p>",
        "id": 21314,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472690049
    },
    {
        "content": "<p>And in this commit the symlink got renamed, but the upgrades are still running the old version of unpack-zulip:</p>\n<div class=\"codehilite\"><pre>commit 19b860ceec7844156376c7c96710ddb06ccafae6\nAuthor: Tim Abbott &lt;tabbott@mit.edu&gt;\nDate:   Tue Jul 19 20:42:43 2016 -0700\n\n    Rename local_settings.py symlink to prod_settings.py.\n</pre></div>",
        "id": 21315,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472690181
    },
    {
        "content": "<p>I think people that use <code>scripts/upgrade-zulip-from-git</code> will be ok, because there the symlink logic seemed to survive all the refactorings and moving stuff around.</p>",
        "id": 21316,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472690430
    },
    {
        "content": "<p>sounds like you guys are making some progress that will make me happy (and maybe some other people) <img alt=\":smile:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/smile.png\" title=\":smile:\"> <br>\nI have a clone of my server... I can do some testing if you have suggestions, wait for a fix from y'all or whatever.</p>",
        "id": 21317,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472690598
    },
    {
        "content": "<p>One thing I recommend doing is going to your <strong>old</strong> install and comment out one of the very last lines of <code>scripts/lib/upgrade-zulip</code> so that it doesn't automatically call <code>./scripts/lib/upgrade-zulip-stage-2</code>.  Then re-run the upgrade, and you'll be a nice stopping point right after the tarball is unpacked but before stuff really happens.  Then we'll have you manually fix up the symlink then manually run stage-2.</p>",
        "id": 21319,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472690979
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"christie@authenticengine.com\">@Christie Koehler</span> Can you try what I suggested to Gervaise in the previous message?</p>",
        "id": 21320,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472691435
    },
    {
        "content": "<p>once I get 1.3.13 running, yeah</p>",
        "id": 21321,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472691501
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\">@Steve Howell</span> <br>\nI made a snapshot of my \"real\" server so I can try this... </p>",
        "id": 21322,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472691558
    },
    {
        "content": "<p>almost there</p>",
        "id": 21323,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472691562
    },
    {
        "content": "<p>ah, heh...yeah, the hardest part about troubleshooting upgrades is that you have to downgrade first <img alt=\":face_with_cold_sweat:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/face_with_cold_sweat.png\" title=\":face_with_cold_sweat:\"> </p>",
        "id": 21324,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472691565
    },
    {
        "content": "<p>should I just uncomment:<br>\n<code>subprocess.check_call([os.path.abspath(\"./scripts/lib/upgrade-zulip-stage-2\"), deploy_path])</code><br>\n?</p>",
        "id": 21325,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472691697
    },
    {
        "content": "<p>this is the downside of teh zulip prod install script doing everything</p>",
        "id": 21326,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472691698
    },
    {
        "content": "<p>yes <span class=\"user-mention\" data-user-email=\"gervais@demontbrun.com\">@GervaisdeM</span> comment out that line please</p>",
        "id": 21327,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472691727
    },
    {
        "content": "<p>note to self: zulip-secrets.conf is not totally portable between servers</p>",
        "id": 21328,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472691858
    },
    {
        "content": "<p>so now upgrade-zulip only does the untar?</p>\n<div class=\"codehilite\"><pre>root@zulip:/home/zulip# /home/zulip/deployments/current/scripts/upgrade-zulip zulip-server-1.4.0.tar.gz\n2016-08-31 22:05:33,577 upgrade-zulip: Archiving the tarball under /home/zulip/archives\n2016-08-31 22:05:33,794 upgrade-zulip: Unpacking the tarball\n2016-08-31 22:05:34,977 upgrade-zulip: Deployment complete\n</pre></div>",
        "id": 21329,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472691986
    },
    {
        "content": "<p>yeah, the way it works is that the first script only untars stuff and it's kind of a bootstrapping thing to get you into the stage-2 part of the deployment that happens with 1.4 code</p>",
        "id": 21330,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692034
    },
    {
        "content": "<p>but we need to manually fix the symlink before stage 2 starts</p>",
        "id": 21331,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692057
    },
    {
        "content": "<p>can you do <code>cwd</code>?</p>",
        "id": 21332,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692109
    },
    {
        "content": "<p>er, <code>pwd</code></p>",
        "id": 21333,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692124
    },
    {
        "content": "<p>I can be in any dir you want... :-)<br>\n<code>/home/zulip</code></p>",
        "id": 21334,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692146
    },
    {
        "content": "<p>you should be in the deployments directory...hold on</p>",
        "id": 21335,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692166
    },
    {
        "content": "<p><code>/home/zulip/deployments</code></p>",
        "id": 21336,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692185
    },
    {
        "content": "<p>:)</p>",
        "id": 21337,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692189
    },
    {
        "content": "<p>yup</p>",
        "id": 21338,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692191
    },
    {
        "content": "<p>did you see how fast I ran <code>cd</code>?<br>\n<img alt=\":smile:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/smile.png\" title=\":smile:\"> </p>",
        "id": 21339,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692226
    },
    {
        "content": "<p>then do: <code>ln -nsf /etc/zulip/settings.py /home/zulip/deployments/zproject/prod_settings.py</code></p>",
        "id": 21340,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692322
    },
    {
        "content": "<p>and then do <code>ls zproject/*settings*.py</code></p>",
        "id": 21341,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692363
    },
    {
        "content": "<p>pathing is off</p>",
        "id": 21342,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692399
    },
    {
        "content": "<p>there is no deployments/zproject dir</p>",
        "id": 21343,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692417
    },
    {
        "content": "<p>current?</p>",
        "id": 21344,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692426
    },
    {
        "content": "<p>like <code>/home/zulip/deployments/current</code></p>",
        "id": 21345,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692446
    },
    {
        "content": "<div class=\"codehilite\"><pre>root@zulip:/home/zulip/deployments# ln -nsf /etc/zulip/settings.py /home/zulip/deployments/zproject/prod_settings.py\nln: failed to create symbolic link ‘/home/zulip/deployments/zproject/prod_settings.py’: No such file or directory\n</pre></div>",
        "id": 21346,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692535
    },
    {
        "content": "<div class=\"codehilite\"><pre>root@zulip:/home/zulip/deployments# pwd\n/home/zulip/deployments\nroot@zulip:/home/zulip/deployments# ls -l\ntotal 8\ndrwxr-xr-x 14 zulip zulip 4096 Aug 17 20:00 2016-06-21-23-34-49\ndrwxr-xr-x 14 zulip zulip 4096 Aug 25 14:49 2016-08-31-22-05-33\nlrwxrwxrwx  1 zulip zulip   43 Jul 27 23:50 current -&gt; /home/zulip/deployments/2016-06-21-23-34-49\nsrwx------  1 zulip zulip    0 Aug 31 22:04 fastcgi-socket\nlrwxrwxrwx  1 zulip zulip   43 Aug 31 22:05 next -&gt; /home/zulip/deployments/2016-08-31-22-05-33\n</pre></div>",
        "id": 21347,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692612
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\">@Steve Howell</span>  <img alt=\":point_up:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/point_up.png\" title=\":point_up:\"> </p>",
        "id": 21348,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692676
    },
    {
        "content": "<p>oh yeah, current is what you want</p>",
        "id": 21349,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692793
    },
    {
        "content": "<div class=\"codehilite\"><pre>root@zulip:/home/zulip/deployments/current# ls -l zproject/*settings*.py\n-rw-r--r-- 1 zulip zulip   910 Jun 21 20:59 zproject/dev_settings.py\nlrwxrwxrwx 1 zulip zulip    22 Jun 21 23:34 zproject/local_settings.py -&gt; /etc/zulip/settings.py\n-rw-r--r-- 1 zulip zulip 15360 Jun 21 20:59 zproject/local_settings_template.py\nlrwxrwxrwx 1 root  root     22 Aug 31 22:20 zproject/prod_settings.py -&gt; /etc/zulip/settings.py\n-rw-r--r-- 1 zulip zulip 35020 Jun 21 20:59 zproject/settings.py\n</pre></div>",
        "id": 21350,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472692872
    },
    {
        "content": "<p>you can rm local_settings.py</p>",
        "id": 21351,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472692963
    },
    {
        "content": "<p>and then we should be ready to run stage-2 from the shell, from the \"current\" directory</p>",
        "id": 21352,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693002
    },
    {
        "content": "<p>basically that line of Python code you commented out earlier, you want to run that command from the command line now</p>",
        "id": 21353,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693040
    },
    {
        "content": "<div class=\"codehilite\"><pre>root@zulip:/home/zulip/deployments/current# rm zproject/local_settings.py\nroot@zulip:/home/zulip/deployments/current# ls zproject/*settings*.py\nzproject/dev_settings.py  zproject/local_settings_template.py  zproject/prod_settings.py  zproject/settings.py\n</pre></div>",
        "id": 21354,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693042
    },
    {
        "content": "<p>just to confirm before running it...<br>\n<code>scripts/lib/upgrade-zulip-stage-2</code></p>\n<p>right?</p>",
        "id": 21355,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693100
    },
    {
        "content": "<p>no, slightly more complicated</p>",
        "id": 21356,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693113
    },
    {
        "content": "<p>you need to pass in the deployment path similar to what the Python code is doing</p>",
        "id": 21357,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693141
    },
    {
        "content": "<p><code>/home/zulip/deployments/current/scripts/lib/upgrade-zulip-stage-2 /home/zulip/deployments/current</code> is what Python would  have run earlier had we not intervened</p>",
        "id": 21358,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693237
    },
    {
        "content": "<p>ok... shouldn't the second argument point to the new unpacked tarball? like:<br>\n<code>/home/zulip/deployments/current/scripts/lib/upgrade-zulip-stage-2 /home/zulip/deployments/2016-08-31-22-05-33</code></p>",
        "id": 21359,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693309
    },
    {
        "content": "<p>I think the symlink needs to be created in /next/ not /current/</p>",
        "id": 21360,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472693372
    },
    {
        "content": "<p>the script would have run:<br>\n<code>subprocess.check_call([os.path.abspath(\"./scripts/lib/upgrade-zulip-stage-2\"), deploy_path])</code><br>\nabove this line... <code>deploy_path</code> is defined as:</p>\n<div class=\"codehilite\"><pre>    deploy_path = subprocess.check_output([unpack_zulip, archived_tarball_path],\n                                          preexec_fn=su_to_zulip)\n</pre></div>\n\n\n<p>I think this is pointing to the path to the recently created dir from untar'ing the zulip-server-1.4.0.tgz tarball, no?</p>",
        "id": 21361,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693533
    },
    {
        "content": "<p>probably</p>",
        "id": 21362,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693544
    },
    {
        "content": "<p>I'm not a python guy... so I am just poking at it as best I can...</p>",
        "id": 21363,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693571
    },
    {
        "content": "<p>it's probably the most recent directory created under deployments if you do <code>ls -lt</code></p>",
        "id": 21364,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693575
    },
    {
        "content": "<p>yeah, I'm just trying to interpret the code, and I don't have the directory structure in front of me, and I'm trying to feed the dogs while checking in here haha</p>",
        "id": 21365,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693637
    },
    {
        "content": "<p>yup... that's the one I pointed to earlier (the one with today's date)<br>\n<code>/home/zulip/deployments/2016-08-31-22-05-33</code></p>\n<p>so I think the command I suggested earlier is correct<br>\n<code>/home/zulip/deployments/current/scripts/lib/upgrade-zulip-stage-2 /home/zulip/deployments/2016-08-31-22-05-33</code></p>",
        "id": 21366,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693659
    },
    {
        "content": "<p>feeding the dogs... :-)<br>\nI have a tiny dog sitting on my lap as I do this</p>",
        "id": 21367,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693677
    },
    {
        "content": "<p>ok... I'm going to run the above command and let you know if it works</p>",
        "id": 21368,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693704
    },
    {
        "content": "<p>On a high level this is all that really happens:<br>\n- untar to new dir with timestamp<br>\n- fix up some symlinks<br>\n- stage2 stuff: stop old server/run migrations/start new server<br>\n- fix up some symlinks</p>",
        "id": 21369,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693711
    },
    {
        "content": "<p>/me crosses his fingers</p>",
        "id": 21370,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693745
    },
    {
        "content": "<p>stage2 is running apt updates</p>",
        "id": 21371,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693757
    },
    {
        "content": "<p>yeah, that makes sense</p>",
        "id": 21372,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693775
    },
    {
        "content": "<p>I'm just building suspense...</p>",
        "id": 21373,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693786
    },
    {
        "content": "<p>failed</p>",
        "id": 21374,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693794
    },
    {
        "content": "<div class=\"codehilite\"><pre>zulip-senders:zulip-events-message_sender-0: stopped\nzulip-senders:zulip-events-message_sender-4: stopped\nzulip-senders:zulip-events-message_sender-1: stopped\nzulip-senders:zulip-events-message_sender-2: stopped\nzulip-senders:zulip-events-message_sender-3: stopped\n2016-08-31 22:36:29,864 upgrade-zulip-stage-2: Applying puppet changes...\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip-stage-2&quot;, line 43, in &lt;module&gt;\n    subprocess.check_call([&quot;./scripts/zulip-puppet-apply&quot;, &quot;--force&quot;])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 535, in check_call\n    retcode = call(*popenargs, **kwargs)\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 522, in call\n    return Popen(*popenargs, **kwargs).wait()\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 710, in __init__\n    errread, errwrite)\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 1327, in _execute_child\n    raise child_exception\nOSError: [Errno 2] No such file or directory\n</pre></div>",
        "id": 21375,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693811
    },
    {
        "content": "<p>cd'd into <code>current</code> dir and re-ran... looks like it got past that</p>",
        "id": 21376,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693918
    },
    {
        "content": "<p>Strange.  Can you do <code>ls scripts/*puppet*</code>?</p>",
        "id": 21377,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693918
    },
    {
        "content": "<p>Is <code>current</code> pointing at the \"new\" stuff yet?</p>",
        "id": 21378,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472693960
    },
    {
        "content": "<p>puppet stuff is still running...</p>",
        "id": 21379,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472693995
    },
    {
        "content": "<p>are you running old code or new?</p>",
        "id": 21380,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472694007
    },
    {
        "content": "<p>upgrade-stage-2 needs to run in the new directory</p>",
        "id": 21381,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472694016
    },
    {
        "content": "<p>so upgrade-stage-2 should be called from <code>next</code> or <code>2016-08-31-22-05-33</code> (in this instance)<br>\n?</p>",
        "id": 21382,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472694110
    },
    {
        "content": "<p>yeah that's what <span class=\"user-mention\" data-user-email=\"christie@authenticengine.com\">@Christie Koehler</span> was pointing out earlier</p>",
        "id": 21383,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472694167
    },
    {
        "content": "<p>that's also where the soft link should have happened</p>",
        "id": 21384,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472694200
    },
    {
        "content": "<p>I was confused...\"current\" is still \"old\" till the final install finishes</p>",
        "id": 21385,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472694215
    },
    {
        "content": "<p>so you want to do the symlink-fixing and stage-2 out of the most recent directory</p>",
        "id": 21386,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472694265
    },
    {
        "content": "<p>ok..</p>",
        "id": 21387,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472694289
    },
    {
        "content": "<p><img alt=\":hankey:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/hankey.png\" title=\":hankey:\"> is happening... <br>\nIt's setting up the zulip python environment... lots of stuff downloading</p>",
        "id": 21388,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472694469
    },
    {
        "content": "<p>I know this is normal... I have seen it 100 times</p>",
        "id": 21389,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472694484
    },
    {
        "content": "<p>just letting you know what is going on</p>",
        "id": 21390,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472694496
    },
    {
        "content": "<p>cool, afk for about 10 minutes</p>",
        "id": 21391,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472694560
    },
    {
        "content": "<p>Okay, I have a working 1.3.13 install so I can try the upgrade </p>",
        "id": 21392,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472694602
    },
    {
        "content": "<p>failed in the end:</p>\n<div class=\"codehilite\"><pre>Calculating upgrade... Done\n0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\n2016-08-31 22:56:47,291 upgrade-zulip-stage-2: Applying database migrations...\nTraceback (most recent call last):\n  File &quot;./manage.py&quot;, line 29, in &lt;module&gt;\n    execute_from_command_line(sys.argv)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 338, in execute_from_command_line\n    utility.execute()\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 330, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 390, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 441, in execute\n    output = self.handle(*args, **options)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/core/management/commands/migrate.py&quot;, line 93, in handle\n    executor = MigrationExecutor(connection, self.migration_progress_callback)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/migrations/executor.py&quot;, line 19, in __init__\n    self.loader = MigrationLoader(self.connection)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/migrations/loader.py&quot;, line 47, in __init__\n    self.build_graph()\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/migrations/loader.py&quot;, line 180, in build_graph\n    self.applied_migrations = recorder.applied_migrations()\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/migrations/recorder.py&quot;, line 59, in applied_migrations\n    self.ensure_schema()\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/migrations/recorder.py&quot;, line 49, in ensure_schema\n    if self.Migration._meta.db_table in self.connection.introspection.table_names(self.connection.cursor()):\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/backends/base/base.py&quot;, line 164, in cursor\n    cursor = self.make_cursor(self._cursor())\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/backends/base/base.py&quot;, line 135, in _cursor\n    self.ensure_connection()\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/backends/base/base.py&quot;, line 130, in ensure_connection\n    self.connect()\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/utils.py&quot;, line 97, in __exit__\n    six.reraise(dj_exc_type, dj_exc_value, traceback)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/backends/base/base.py&quot;, line 130, in ensure_connection\n    self.connect()\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/backends/base/base.py&quot;, line 119, in connect\n    self.connection = self.get_new_connection(conn_params)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/django/db/backends/postgresql_psycopg2/base.py&quot;, line 178, in get_new_connection\n    connection = Database.connect(**conn_params)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zulip-venv/lib/python2.7/site-packages/psycopg2/__init__.py&quot;, line 164, in connect\n    conn = _connect(dsn, connection_factory=connection_factory, async=async)\n  File &quot;/home/zulip/deployments/2016-08-31-22-05-33/zerver/lib/db.py&quot;, line 45, in __init__\n    super(TimeTrackingConnection, self).__init__(*args, **kwargs)\ndjango.db.utils.OperationalError: could not connect to server: No such file or directory\n        Is the server running locally and accepting\n        connections on Unix domain socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;?\n\nTraceback (most recent call last):\n  File &quot;./scripts/lib/upgrade-zulip-stage-2&quot;, line 64, in &lt;module&gt;\n    subprocess.check_call([&quot;./manage.py&quot;, &quot;migrate&quot;, &quot;--noinput&quot;], preexec_fn=su_to_zulip)\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;migrate&#39;, &#39;--noinput&#39;]&#39; returned non-zero exit status 1\n</pre></div>",
        "id": 21393,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695119
    },
    {
        "content": "<p>current still points to old install<br>\nnext points to 1.4.0 extracted tarball dir</p>",
        "id": 21394,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695170
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"gervais@demontbrun.com\">@GervaisdeM</span> what does your /next/ directory look like?</p>",
        "id": 21395,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472695282
    },
    {
        "content": "<p>e.g. is there is symlink there to /etc/zulip/settings.py?</p>",
        "id": 21396,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472695296
    },
    {
        "content": "<div class=\"codehilite\"><pre>root@zulip:/home/zulip/deployments/next# ls -l\ntotal 124\ndrwxr-xr-x 6 zulip zulip  4096 Aug 25 14:49 api\n-rw-r--r-- 1 zulip zulip    41 Aug 25 14:50 build_id\ndrwxr-xr-x 4 zulip zulip  4096 Aug 31 22:56 confirmation\ndrwxr-xr-x 3 zulip zulip  4096 Aug 25 14:49 contrib_bots\n-rw-r--r-- 1 zulip zulip   254 Aug 25 14:49 Dockerfile\ndrwxr-xr-x 4 zulip zulip  4096 Aug 25 14:49 docs\n-rw-r--r-- 1 zulip zulip 11358 Aug 25 14:49 LICENSE\n-rwxr-xr-x 1 zulip zulip  1012 Aug 25 14:49 manage.py\n-rw-r--r-- 1 zulip zulip   716 Aug 25 14:49 package.json\ndrwxr-xr-x 4 zulip zulip  4096 Aug 25 14:50 prod-static\ndrwxr-xr-x 5 zulip zulip  4096 Aug 25 14:49 puppet\n-rw-r--r-- 1 zulip zulip 10859 Aug 25 14:49 README.md\ndrwxr-xr-x 2 zulip zulip  4096 Aug 25 14:49 requirements\ndrwxr-xr-x 5 zulip zulip  4096 Aug 31 22:46 scripts\ndrwxr-xr-x 6 zulip zulip  4096 Aug 25 14:49 templates\n-rw-r--r-- 1 zulip zulip 23635 Aug 25 14:49 THIRDPARTY\n-rw-r--r-- 1 zulip zulip  2414 Aug 25 14:49 Vagrantfile\ndrwxr-xr-x 2 zulip zulip  4096 Aug 31 22:56 var\n-rw-r--r-- 1 zulip zulip     6 Aug 25 14:50 version\ndrwxr-xr-x 8 zulip zulip  4096 Aug 31 22:56 zerver\ndrwxr-xr-x 3 zulip zulip  4096 Aug 31 22:56 zproject\nlrwxrwxrwx 1 root  root     73 Aug 31 22:56 zulip-venv -&gt; /srv/zulip-venv-cache/3f3aca99403f3bbcc8ffd2c4b24d1296f904c04b/zulip-venv\nroot@zulip:/home/zulip/deployments/next# ls -l zproject/\ntotal 148\n-rw-r--r-- 1 zulip zulip 13214 Aug 25 14:49 backends.py\n-rw-r--r-- 1 zulip zulip  1036 Aug 25 14:49 dev_settings.py\n-rw-r--r-- 1 zulip zulip   820 Aug 25 14:49 dev_urls.py\n-rw-r--r-- 1 zulip zulip     0 Aug 25 14:49 __init__.py\n-rw-r--r-- 1 zulip zulip   151 Aug 31 22:56 __init__.pyc\ndrwxr-xr-x 2 zulip zulip  4096 Aug 25 14:49 jinja2\n-rw-r--r-- 1 zulip zulip  3138 Aug 25 14:49 legacy_urls.py\nlrwxrwxrwx 1 root  root     22 Aug 31 22:45 prod_settings.py -&gt; /etc/zulip/settings.py\n-rw-r--r-- 1 zulip zulip  1851 Aug 31 22:56 prod_settings.pyc\n-rw-r--r-- 1 zulip zulip 16710 Aug 25 14:49 prod_settings_template.py\n-rw-r--r-- 1 zulip zulip 38716 Aug 25 14:49 settings.py\n-rw-r--r-- 1 zulip zulip 24138 Aug 31 22:56 settings.pyc\n-rw-r--r-- 1 zulip zulip    59 Aug 25 14:49 terms.md.template\n-rw-r--r-- 1 zulip zulip 15140 Aug 25 14:49 urls.py\n-rw-r--r-- 1 zulip zulip  1340 Aug 25 14:49 wsgi.py\n</pre></div>",
        "id": 21397,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695356
    },
    {
        "content": "<p>I think that is right...</p>",
        "id": 21398,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695367
    },
    {
        "content": "<p>yeah, it looks correct</p>",
        "id": 21399,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472695436
    },
    {
        "content": "<p>I think you might have gotten a different error this time, though. It looks like a postgres error?</p>",
        "id": 21400,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472695453
    },
    {
        "content": "<p>postgres server is currently down...</p>",
        "id": 21401,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695492
    },
    {
        "content": "<p>I started it and re-running...</p>",
        "id": 21402,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695540
    },
    {
        "content": "<p>looks like it finished.<br>\ntrying to log in</p>",
        "id": 21403,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695617
    },
    {
        "content": "<p>I'm in and it looks like upgrade completed!<br>\n<img alt=\":smile:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/smile.png\" title=\":smile:\"> </p>\n<div class=\"codehilite\"><pre>root@zulip:/home/zulip/deployments# ls -l\ntotal 8\ndrwxr-xr-x 14 zulip zulip 4096 Aug 17 20:00 2016-06-21-23-34-49\ndrwxr-xr-x 15 zulip zulip 4096 Aug 31 23:05 2016-08-31-22-05-33\nlrwxrwxrwx  1 zulip zulip   43 Aug 31 23:06 current -&gt; /home/zulip/deployments/2016-08-31-22-05-33\nsrwx------  1 zulip zulip    0 Aug 31 23:06 fastcgi-socket\nlrwxrwxrwx  1 zulip zulip   43 Aug 31 23:06 last -&gt; /home/zulip/deployments/2016-06-21-23-34-49\nlrwxrwxrwx  1 zulip zulip   43 Aug 31 22:05 next -&gt; /home/zulip/deployments/2016-08-31-22-05-33\n</pre></div>",
        "id": 21404,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695699
    },
    {
        "content": "<p>yay!</p>",
        "id": 21405,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472695712
    },
    {
        "content": "<p>yay!</p>",
        "id": 21406,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695718
    },
    {
        "content": "<p>thanks!</p>",
        "id": 21407,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695722
    },
    {
        "content": "<p>is there a way to show version of server running when logged in?</p>",
        "id": 21408,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695748
    },
    {
        "content": "<p>Thanks for your patience slogging through this!</p>",
        "id": 21409,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472695755
    },
    {
        "content": "<p>fun!</p>",
        "id": 21410,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695786
    },
    {
        "content": "<p>I'm not aware of any way to check the version of the server from the browser.  I vaguely recall a ticket is open on this, but not sure.</p>",
        "id": 21411,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472695809
    },
    {
        "content": "<p>ok... after an upgrade, I'd like to be able to get it to report the version...</p>",
        "id": 21412,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695878
    },
    {
        "content": "<p>I'm going to shutdown vm, snapshot and bring it back up... </p>",
        "id": 21413,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695899
    },
    {
        "content": "<p>thanks for the help folks</p>",
        "id": 21414,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472695905
    },
    {
        "content": "<p>no prob...I'll go create a version ticket now</p>",
        "id": 21415,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472695941
    },
    {
        "content": "<p>all of a sudden I have huge latency from my digital ocean vms</p>",
        "id": 21416,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472695992
    },
    {
        "content": "<p>ugh</p>",
        "id": 21417,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472695993
    },
    {
        "content": "<p>my vm's run in virtualbox on my ancient Mac Pro tower.  <img alt=\":grimacing:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/grimacing.png\" title=\":grimacing:\"> </p>",
        "id": 21418,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472696089
    },
    {
        "content": "<p>rabbitmq-server didn't start automatically and I had to start it manually with the init script<br>\nzulip client tells me that it is \"not a vaild zulip server\" when I try to switch to it, but I can log in with a web brower.</p>",
        "id": 21419,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472696568
    },
    {
        "content": "<p><a href=\"/user_uploads/2/80/bg-H65MI_dGjJ5n88GwVqqEr/Screen-Shot-2016-08-31-at-11.21.28-PM.png\" target=\"_blank\" title=\"Screen-Shot-2016-08-31-at-11.21.28-PM.png\">typo.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/80/bg-H65MI_dGjJ5n88GwVqqEr/Screen-Shot-2016-08-31-at-11.21.28-PM.png\" target=\"_blank\" title=\"Screen-Shot-2016-08-31-at-11.21.28-PM.png\"><img src=\"/user_uploads/2/80/bg-H65MI_dGjJ5n88GwVqqEr/Screen-Shot-2016-08-31-at-11.21.28-PM.png\"></a></div>",
        "id": 21420,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472696593
    },
    {
        "content": "<p>wonder why it says that the server is not valid?</p>",
        "id": 21421,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472696687
    },
    {
        "content": "<p>It's 11:25PM, so that is a question for tomorrow.</p>",
        "id": 21422,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472696748
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\">@Steve Howell</span> <a href=\"https://github.com/zulip/zulip/pull/1746\" target=\"_blank\" title=\"https://github.com/zulip/zulip/pull/1746\">https://github.com/zulip/zulip/pull/1746</a> my attempt at a fix. works on my dev server</p>",
        "id": 21433,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472701669
    },
    {
        "content": "<p>cool, ping me tomorrow so we can figure out the other pieces to this (re-sending the release email or whatever, may have to wait for TIm)</p>",
        "id": 21435,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472706484
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"rishig@zulipchat.com\">@Rishi Gupta</span> Do you have the ability to upload a new tarball to <a href=\"https://www.zulip.com/dist/releases/\" target=\"_blank\" title=\"https://www.zulip.com/dist/releases/\">https://www.zulip.com/dist/releases/</a>?</p>",
        "id": 21436,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472706653
    },
    {
        "content": "<p>I think I do, though I haven't managed to figure out how to make the tarball correctly. I can play with it a bit more tomorrow.</p>",
        "id": 21444,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472711125
    },
    {
        "content": "<p>pinging <span class=\"user-mention\" data-user-email=\"rishig@zulipchat.com\">@Rishi Gupta</span> and <span class=\"user-mention\" data-user-email=\"christie@authenticengine.com\">@Christie Koehler</span> about getting her fix merged, possibly a new tarball uploaded, and possibly some new communication sent out regarding the upgrade issue</p>",
        "id": 21504,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472749248
    },
    {
        "content": "<p>I'm here for a bit, then will need to run an errand.</p>",
        "id": 21506,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472749268
    },
    {
        "content": "<p>One thing -- my branch for that PR was made off master, not the 1.4.0 tag</p>",
        "id": 21507,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472749287
    },
    {
        "content": "<p>Not sure if we want to cherry-pick just that fix or use other things that have been merged into master since the 1.4.0 release</p>",
        "id": 21508,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472749316
    },
    {
        "content": "<p>Ok, sounds good.  I'll be in and out, too.  I think your push looks good, but, yeah, I need to figure out where to merge it.</p>",
        "id": 21509,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472749323
    },
    {
        "content": "<p>I probably should have made a branch from 1.4.0</p>",
        "id": 21510,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472749342
    },
    {
        "content": "<p>I'm 90% sure that we should rebase off of 1.4.0 for now and create a special \"fix\" branch.</p>",
        "id": 21511,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472749357
    },
    {
        "content": "<p>I can handle the rebase, don't worry about that.  It's more deciding how we want to present this to the world that's a problem, and I think we need Rishi for that.</p>",
        "id": 21513,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472749393
    },
    {
        "content": "<p>Okay, thanks for taking care of the rebase.</p>",
        "id": 21514,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472749412
    },
    {
        "content": "<p>At least there's a work around, but yeah, I feel like getting a fix out quickly is good.</p>",
        "id": 21517,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472749449
    },
    {
        "content": "<p>If you do have some today, I think it's probably worthwhile for us to rm local_settings.py, like you mentioned in the PR, but I don't consider that a critical issue for putting out a fix.</p>",
        "id": 21518,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472749464
    },
    {
        "content": "<p>I should be able to do that after running my errand. </p>",
        "id": 21521,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472749502
    },
    {
        "content": "<p>Fixing the code is the easy part. The more time consuming part is testing it. </p>",
        "id": 21522,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472749512
    },
    {
        "content": "<p>Indeed.</p>",
        "id": 21531,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472750113
    },
    {
        "content": "<p>PR updated to remove local_settings.py symlink if it exists <a href=\"https://github.com/zulip/zulip/pull/1746\" target=\"_blank\" title=\"https://github.com/zulip/zulip/pull/1746\">https://github.com/zulip/zulip/pull/1746</a></p>",
        "id": 21540,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472767522
    },
    {
        "content": "<p>and tested on 1.3.13 &gt; 1.4.0 upgrade</p>",
        "id": 21541,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472767555
    },
    {
        "content": "<p>Awesome!  Do you agree with me that we should at least simple-merge this to master for now?  Here's my reasoning:<br>\n- Anybody that upgrades from master will have no problems.<br>\n- Nothing major has hit master since 1.4.0<br>\n- Rewriting history on the master branch isn't really gonna help anybody installing off the 1.4.0 branch.<br>\n- Once Tim gets back, we can decide on more permanent history-rewriting as needed.</p>",
        "id": 21543,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472767984
    },
    {
        "content": "<p>It is also easy to \"twist my arm\" and just do nothing proactive until Tim comes back, since now anybody that shows up on Zulip tomorrow will be greeted by us with the workaround, and we can always do a reactive branch with your fixes.</p>",
        "id": 21544,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472768087
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"rishig@zulipchat.com\">@Rishi Gupta</span> Any thoughts on communication to potential upgraders?</p>",
        "id": 21545,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472768780
    },
    {
        "content": "<p>Once you have a 1.4.1 (or whatever you want to number/name it), I should be able to test re-running the upgrade. I still have a clone and snapshot of my server that I can test on.</p>",
        "id": 21546,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472770171
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\">@Steve Howell</span> when you say \"simple merge\" do you merge as we would most other PR?</p>",
        "id": 21549,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472770777
    },
    {
        "content": "<p>yeah, just rebase on top of master, <span class=\"user-mention\" data-user-email=\"christie@authenticengine.com\">@Christie Koehler</span> </p>",
        "id": 21550,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472770790
    },
    {
        "content": "<p>oops, sorry for disappearing. I do have bits for upgrading <a href=\"http://zulipchat.com\" target=\"_blank\" title=\"http://zulipchat.com\">zulipchat.com</a>, but I think I don't actually have bits for putting out a new tarball release</p>",
        "id": 21551,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472770814
    },
    {
        "content": "<p>currently looking into it</p>",
        "id": 21552,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472770822
    },
    {
        "content": "<p>Given what <span class=\"user-mention\" data-user-email=\"gervais@demontbrun.com\">@GervaisdeM</span> said just now, I'm more inclined to push to master, and we can have him try upgrading from git</p>",
        "id": 21553,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472770822
    },
    {
        "content": "<p>Upgrade from git only works starting with 1.4</p>",
        "id": 21554,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472770842
    },
    {
        "content": "<p>afaik</p>",
        "id": 21555,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472770846
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"rishig@zulipchat.com\">@Rishi Gupta</span> At this point, maybe the best tactic is just to send out some communication...</p>\n<blockquote>\n<p>If you are about to install, please go to ztn for guidance.</p>\n</blockquote>",
        "id": 21556,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472770872
    },
    {
        "content": "<p>yeah</p>",
        "id": 21557,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472770899
    },
    {
        "content": "<p>I don't like that the upgrade is broken, but I also think it's low-exposure given the Labour Day holiday.</p>",
        "id": 21558,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472770912
    },
    {
        "content": "<p>And we have a pretty easy to apply work-around</p>",
        "id": 21559,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472770919
    },
    {
        "content": "<p>I noticed earlier that I can't edit sent messages on my server.I thought it was an issue with the alpha client, but it seems to be happening in a browser also. I wonder if this is an issue with the server.</p>",
        "id": 21560,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472770925
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"christie@authenticengine.com\">@Christie Koehler</span> ah, good point, so maybe we wait on pushing to master, and just deal with anybody who needs to upgrade before TIm gets back</p>",
        "id": 21561,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472770925
    },
    {
        "content": "<p>Yeah, I think that's best.</p>",
        "id": 21562,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472770952
    },
    {
        "content": "<p>We could send a note to zulip-dev</p>",
        "id": 21563,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472771003
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"gervais@demontbrun.com\">@GervaisdeM</span> Hmmmm.  We have mucked with the edit code recently.  One of the changes is intentional--we prevent people from editing messages too late after the fact.   But the settings on that might not have the perfect defaults for somebody upgrading and used to the old behavior.  (Or it could just be a bug.)</p>",
        "id": 21564,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771048
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"gervais@demontbrun.com\">@GervaisdeM</span> Do you not have the option (e..g the user interface for 'edit'), or does editing just not work?</p>",
        "id": 21565,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472771077
    },
    {
        "content": "<p>Yeah, and google groups, or is that one and the same,  Christie?</p>",
        "id": 21566,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771081
    },
    {
        "content": "<p>It looks locked, so might be that I just went back too late to edit the message</p>",
        "id": 21567,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771100
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\">@Steve Howell</span> afaik zulip-dev is the google group</p>",
        "id": 21568,
        "sender_full_name": "Christie Koehler",
        "timestamp": 1472771102
    },
    {
        "content": "<p>rock/paper/scissors for who sends out the GG update</p>",
        "id": 21569,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771131
    },
    {
        "content": "<p>If I had a vote, I would like to be able to edit any message no matter how old... I've gone back and edited messages that were months old that I post for users to read...</p>",
        "id": 21570,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771164
    },
    {
        "content": "<p>Let me test...</p>",
        "id": 21571,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771185
    },
    {
        "content": "<p>yeah, I think the new code is a little too stringent</p>",
        "id": 21572,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771187
    },
    {
        "content": "<p>yep... editing works if I edit right away, so must be new code.</p>",
        "id": 21573,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771235
    },
    {
        "content": "<p>There's an admin setting that controls how long messages can be edited</p>",
        "id": 21574,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472771257
    },
    {
        "content": "<p>I agree with the thought process that once a message has lived on the server for a few hours, everybody assumes that was the final message, but if you want to edit a message, you want to edit a message, and we should mostly leave it up to the discretion of the person who originally wrote it</p>",
        "id": 21575,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771260
    },
    {
        "content": "<p>cool... found the setting</p>",
        "id": 21576,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771308
    },
    {
        "content": "<p>thanks</p>",
        "id": 21577,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771311
    },
    {
        "content": "<p>and yeah, it is fairly new</p>",
        "id": 21578,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472771320
    },
    {
        "content": "<p>makes sense about people thinking messages will be unchanged</p>",
        "id": 21579,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771378
    },
    {
        "content": "<p>I think the new feature is probably fine once we address the confusion factor.</p>",
        "id": 21580,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771393
    },
    {
        "content": "<p>yep.</p>",
        "id": 21581,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771405
    },
    {
        "content": "<p>once I know that it is new behaviour and why it was set, it makes sense</p>",
        "id": 21582,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771423
    },
    {
        "content": "<p>We can probably make the hover a little smarter and say \"You can't edit this now.  Do this instead.\"</p>",
        "id": 21583,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771433
    },
    {
        "content": "<p>yeah, editing the hover seems like a good solution</p>",
        "id": 21584,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472771467
    },
    {
        "content": "<p>or the question mark next to the timer</p>",
        "id": 21585,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472771478
    },
    {
        "content": "<p>and maybe just tune the default a little bit...I don't know what the current default is, but I think it's fair game to edit a message within several hours, and let social pressures constrain abuse</p>",
        "id": 21586,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771492
    },
    {
        "content": "<p>I still have a couple other things to sort out.<br>\n1. rabbitmq doesn't start after reboot, but starts fine with init scwipt manually<br>\n2. twitter-bot items in my feed doesn't show images when using the zulip client... it does however when I log into my server with a browser.</p>\n<p>I haven't done any debugging, looking for an issue yet, so not really looking for help tracking it down. Unless someone knows that this is an issue and already knows the answer.  <img alt=\":smile:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/smile.png\" title=\":smile:\"> </p>",
        "id": 21587,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771635
    },
    {
        "content": "<p>so all of our client apps, besides the browser, are either highly deprecated or highly alpha</p>",
        "id": 21588,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771698
    },
    {
        "content": "<p>(1) is a known problem (though I unfortunately don't know the solution)</p>",
        "id": 21589,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472771741
    },
    {
        "content": "<p>yep... but the images only stopped workingin the clients  post-upgrade</p>",
        "id": 21590,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771773
    },
    {
        "content": "<p>known issue = great.  :) <br>\nI'll assume people smarter than me will sort it out</p>",
        "id": 21591,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771796
    },
    {
        "content": "<p>but given the choice between deprecated and alpha, I would definitely try to migrate toward the alpha</p>",
        "id": 21592,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771797
    },
    {
        "content": "<p>(full disclosure: I only use the browser, so anything I say about clients is mostly hearsay, although pretty good hearsay because of the people I talk to)</p>",
        "id": 21593,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771834
    },
    {
        "content": "<p>I'm running Electron version launched via a script that does a git pull prior to launching the client and the bundled alpha.</p>",
        "id": 21594,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472771859
    },
    {
        "content": "<p>oh, good...and I see you're subscribed to the \"electron\" stream</p>",
        "id": 21595,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472771954
    },
    {
        "content": "<p>I am sure the \"electron\" folks would like to know what's up with 1.4.  (Well, maybe their initial reaction will be ah, <img alt=\":poop:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/poop.png\" title=\":poop:\">, but they'll thank you eventually, and maybe even respect you, haha.)</p>",
        "id": 21596,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472772089
    },
    {
        "content": "<p>Sure... I'll open an issue... I only just noticed that the issue was only in the client this evening.<br>\nI'll also go update the issue (non-issue) I reported about edit being broken.</p>",
        "id": 21597,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472772198
    },
    {
        "content": "<p>sounds good</p>",
        "id": 21598,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472772224
    },
    {
        "content": "<p>If we're emailing out to zulip-dev, it may also make sense to include the file uploads problem: <a href=\"https://zulip.tabbott.net/#narrow/near/20217/stream/installation.20help/topic/file.20uploads.20not.20found\" target=\"_blank\" title=\"https://zulip.tabbott.net/#narrow/near/20217/stream/installation.20help/topic/file.20uploads.20not.20found\">https://zulip.tabbott.net/#narrow/near/20217/stream/installation.20help/topic/file.20uploads.20not.20found</a></p>",
        "id": 21601,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472772987
    },
    {
        "content": "<p>One other thing... the upgrade overwrote /etc/nginx/sites-available/zulip-enterprise back to the default. I had edited the copy on my server to point to different cert/key. The original seems to point to a self signed cert. I fixed it again.Slightly differently this time.</p>",
        "id": 21603,
        "sender_full_name": "GervaisdeM",
        "timestamp": 1472773744
    },
    {
        "content": "<p>I think it makes sense for us to collectively draft a message that we'll send to GG, either here on Zulip or maybe on Paper, and then one of us does the deed of sending it out.</p>",
        "id": 21604,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472774103
    },
    {
        "content": "<p>can people see/edit <a href=\"https://paper.dropbox.com/doc/test-SqU6foVPiDSq7OxIlv3q9\" target=\"_blank\" title=\"https://paper.dropbox.com/doc/test-SqU6foVPiDSq7OxIlv3q9\">https://paper.dropbox.com/doc/test-SqU6foVPiDSq7OxIlv3q9</a> ?</p>",
        "id": 21608,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472774442
    },
    {
        "content": "<p>I can see that.  I was simultaneously working on my own draft...</p>",
        "id": 21609,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472775100
    },
    {
        "content": "<p><a href=\"https://paper.dropbox.com/doc/Message-to-users-sXMlUnaatWkDY3seLKvfL\" target=\"_blank\" title=\"https://paper.dropbox.com/doc/Message-to-users-sXMlUnaatWkDY3seLKvfL\">https://paper.dropbox.com/doc/Message-to-users-sXMlUnaatWkDY3seLKvfL</a></p>",
        "id": 21610,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472775161
    },
    {
        "content": "<p>ah, haha</p>",
        "id": 21612,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472775441
    },
    {
        "content": "<p>I think it might make sense to send a shortish version of this to zulip-announce</p>",
        "id": 21613,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472775553
    },
    {
        "content": "<p>yeah, I think something something only a little more elaborate than \"upgrade bug -&gt; find help here\" will do the job</p>",
        "id": 21614,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472775801
    },
    {
        "content": "<p>/me working on a zulip-announce version</p>",
        "id": 21615,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472775908
    },
    {
        "content": "<p>sounds good</p>",
        "id": 21616,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472775919
    },
    {
        "content": "<p>how serious is the file uploads directory path bug?</p>",
        "id": 21617,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472775934
    },
    {
        "content": "<p>for the technical details that might help self-helpers we can alway reply</p>",
        "id": 21618,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472775940
    },
    {
        "content": "<p>it also seems like something most people will run in to?</p>",
        "id": 21619,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472775957
    },
    {
        "content": "<p>I think the file-uploads bug basically affects all messages with attachments, so I don't consider it catastrophic, but it's not trivial either</p>",
        "id": 21620,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472775982
    },
    {
        "content": "<p>got it</p>",
        "id": 21621,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472776010
    },
    {
        "content": "<p>okay, will send <a href=\"https://paper.dropbox.com/doc/Known-issues-with-upgrading-to-Zulip-server-1.4.0-SqU6foVPiDSq7OxIlv3q9\" target=\"_blank\" title=\"https://paper.dropbox.com/doc/Known-issues-with-upgrading-to-Zulip-server-1.4.0-SqU6foVPiDSq7OxIlv3q9\">https://paper.dropbox.com/doc/Known-issues-with-upgrading-to-Zulip-server-1.4.0-SqU6foVPiDSq7OxIlv3q9</a> to zulip-announce in 30 minutes or so, modulo comments</p>",
        "id": 21622,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472780597
    },
    {
        "content": "<p>I think we need to be a little more explicit that issue 1 is basically a show-stopper.</p>",
        "id": 21623,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472781068
    },
    {
        "content": "<p>got it</p>",
        "id": 21624,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472781141
    },
    {
        "content": "<p>it looks like Luke (from Dropbox) can in fact do server releases</p>",
        "id": 21625,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472784674
    },
    {
        "content": "<p>I think we should just do a 1.4.1 release with this and the file uploads path fixed</p>",
        "id": 21626,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472784768
    },
    {
        "content": "<p>I'll try to figure out how to create the tarballs, but <span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\">@Steve Howell</span> if you come on-line let me know :)</p>",
        "id": 21627,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472784848
    },
    {
        "content": "<p>It might be easiest to just point Luke to Christie's fix and let him take it from there, just so there are fewer moving parts, but I'll be online tomorrow.</p>",
        "id": 21628,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472784970
    },
    {
        "content": "<p>cool, thanks!</p>",
        "id": 21629,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472784987
    },
    {
        "content": "<p><a href=\"https://github.com/zulip/zulip/pull/1746\" target=\"_blank\" title=\"https://github.com/zulip/zulip/pull/1746\">#1746</a> rebased on 1.4.0 branch</p>",
        "id": 21630,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472785092
    },
    {
        "content": "<p>one quick question for now: is tools/build-release-tarball all that needs to be done?</p>",
        "id": 21631,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472785196
    },
    {
        "content": "<p><a href=\"https://github.com/zulip/zulip/blob/master/tools/build-release-tarball\" target=\"_blank\" title=\"https://github.com/zulip/zulip/blob/master/tools/build-release-tarball\">https://github.com/zulip/zulip/blob/master/tools/build-release-tarball</a></p>",
        "id": 21632,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472785198
    },
    {
        "content": "<p>cool, thanks!</p>",
        "id": 21633,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472785247
    },
    {
        "content": "<p><a href=\"http://zulip.readthedocs.io/en/latest/prod-maintain-secure-upgrade.html#upgrading\" target=\"_blank\" title=\"http://zulip.readthedocs.io/en/latest/prod-maintain-secure-upgrade.html#upgrading\">http://zulip.readthedocs.io/en/latest/prod-maintain-secure-upgrade.html#upgrading</a></p>",
        "id": 21634,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472785303
    },
    {
        "content": "<p>to answer your question, in a narrow context, yes, all we need to do is essentially publish a new tarball with Christie's change, and then when folks upgrade off the tarball, the stage-2 part of the upgrade will pick up her changes and do the right thing</p>",
        "id": 21635,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472785384
    },
    {
        "content": "<p>cool! Also reverting <a href=\"https://github.com/zulip/zulip/commit/4d2cb3754c80605af3ec0494f95391b0f0025124\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/4d2cb3754c80605af3ec0494f95391b0f0025124\">https://github.com/zulip/zulip/commit/4d2cb3754c80605af3ec0494f95391b0f0025124</a> (the file uploads change), unless that seems like a bad idea</p>",
        "id": 21636,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472786041
    },
    {
        "content": "<p>You might want to take a quick skim of the upgrade docs just to make sure the language in the upgrade docs doesn't conflict with a hot-fix kind of procedure.</p>",
        "id": 21637,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472786046
    },
    {
        "content": "<p>will do</p>",
        "id": 21638,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472786063
    },
    {
        "content": "<p>Don't revert the uploads fix, because we made some changes afterward that depended on it.</p>",
        "id": 21639,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472786153
    },
    {
        "content": "<p>ah, cool</p>",
        "id": 21640,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472786254
    },
    {
        "content": "<p>I think the uploads thing should be a one-line fix to our nginx config, but I wasn't as deeply engaged in that issue as I was with the prod_settings symlink.</p>",
        "id": 21641,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472786311
    },
    {
        "content": "<p><code>puppet/zulip/files/nginx/sites-available/zulip-enterprise</code></p>",
        "id": 21642,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472786425
    },
    {
        "content": "<p>Hmmmmm...I don't know what our process was supposed to be to move those files during the upgrade.</p>",
        "id": 21643,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472786573
    },
    {
        "content": "<p>I have one hint from Tim, who managed to pull a few minutes of phone service at the beginning of the week: <br>\n\"This seems like a regression worth doing a quick cherry pick release to fix, since it sounds like prod file uploads are broken, and I think it's kinda messy to fix after someone upgrades because their file uploads will be split between two directories.</p>\n<p>I think we intended the path to have changed only in development. \"</p>",
        "id": 21644,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472786671
    },
    {
        "content": "<p>yeah, that makes sense...if you revert the \"-&gt; var\" change and break dev, it's not the end of the world, but it's probably better to figure out how to just limit it to dev with a new commit</p>",
        "id": 21645,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472786858
    },
    {
        "content": "<p>makes sense</p>",
        "id": 21646,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472786967
    },
    {
        "content": "<p>People who are doing upgrades should technically already have this in /etc/zulip/settings.py if I'm reading the code right</p>",
        "id": 21647,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472786975
    },
    {
        "content": "<p>seems to be set to None in settings.py</p>",
        "id": 21648,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472787080
    },
    {
        "content": "<p>I don't see how reverting the change you mentioned earlier will actually help most people...I am starting to think the upload problems might have been a strange side effect of the bigger problem of people not having prod_settings.py</p>",
        "id": 21649,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472787083
    },
    {
        "content": "<p>ah</p>",
        "id": 21650,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472787112
    },
    {
        "content": "<p>if you look at the change that you proposed to revert, it only touches dev stuff and <code>local_settings_template.py</code></p>",
        "id": 21651,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472787136
    },
    {
        "content": "<p>take everything I say with a grain of salt, by the way...I don't know a ton about the upgrade procedure, and I'm kinda at the end of my day</p>",
        "id": 21652,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472787204
    },
    {
        "content": "<p>is prod_settings_template the right place to look? There we do have <code>LOCAL_UPLOADS_DIR = \"/home/zulip/var/uploads\"</code></p>",
        "id": 21653,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472787211
    },
    {
        "content": "<p>cool, and yeah</p>",
        "id": 21654,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472787231
    },
    {
        "content": "<p>I'll just put Christie's change in for now</p>",
        "id": 21655,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472787244
    },
    {
        "content": "<p>even that should be fine, I think, since for new installs, that's no problem</p>",
        "id": 21656,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472787268
    },
    {
        "content": "<p>I see</p>",
        "id": 21657,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472787283
    },
    {
        "content": "<p>I think re:uploads most people should be fine short-term, but we eventually want upgrade to coax people to put files into a \"standard\" upload directory...but as long as they're saving files somewhere in the FS that doesn't get overwritten and they don't muck with /etc/zulip/settings.py, I <strong>think</strong> they should be ok</p>",
        "id": 21658,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472787509
    },
    {
        "content": "<p>though as long as it is coordinated with nginx?</p>",
        "id": 21659,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472787734
    },
    {
        "content": "<p>(either way, I think it's fine to figure something out once Tim is back)</p>",
        "id": 21660,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472787799
    },
    {
        "content": "<p>ugh, still getting differences between my 1.4.0 build and what's on the server</p>",
        "id": 21661,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472788038
    },
    {
        "content": "<p>in the javascript</p>",
        "id": 21662,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472788041
    },
    {
        "content": "<p>oh...actually, it looks like the nginx config will break fresh installs</p>",
        "id": 21663,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472788762
    },
    {
        "content": "<p>but that's an easy retroactive fix</p>",
        "id": 21664,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472788783
    },
    {
        "content": "<p>the javascript changes seem like they might just be due to the minimizer</p>",
        "id": 21665,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472788788
    },
    {
        "content": "<p>though obviously not the easiest thing to tell :). Going to just go for it.</p>",
        "id": 21666,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472788953
    },
    {
        "content": "<p>We really need to stop minifying our JS files. </p>",
        "id": 21667,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472788968
    },
    {
        "content": "<p>the current nginx config?</p>",
        "id": 21668,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472788969
    },
    {
        "content": "<p>the current nginx config seems to conflict with the settings template</p>",
        "id": 21669,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472789020
    },
    {
        "content": "<p>although <code>prod_settings_template.py</code> has a super long comment about nginx, so a reasonably savvy Unix admin will figure it out</p>",
        "id": 21670,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472789128
    },
    {
        "content": "<p>it seems like we could just change the value in prod_settings_template?</p>",
        "id": 21671,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472789167
    },
    {
        "content": "<p>I think we should change the value on the nginx side, actually...switching to \"var\" is a good thing, we just need to manage the transition</p>",
        "id": 21672,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472789267
    },
    {
        "content": "<p>got it</p>",
        "id": 21673,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472789278
    },
    {
        "content": "<p>both of these files get managed \"outside\" of Zulip, so it's only during broken-upgrade situations that they get out of sync</p>",
        "id": 21674,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472789342
    },
    {
        "content": "<p>ah, I was wondering how to get to /etc/nginx/sites-available/zulip-enterprise :)</p>",
        "id": 21675,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472789367
    },
    {
        "content": "<p>puppet puts it out there originally...I'm not completely sure what happens during an upgrade...hopefully puppet is smart enough to leave it alone if it's already there, since a Zulip admin may have modified it during a previous release</p>",
        "id": 21676,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472789475
    },
    {
        "content": "<p>got it</p>",
        "id": 21677,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472789533
    },
    {
        "content": "<p>I am going to bed.  Hopefully I've given you the gist of what you need to look at, but I can track down things with more certainty tomorrow.</p>",
        "id": 21678,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472789546
    },
    {
        "content": "<p>cool, thanks!</p>",
        "id": 21679,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472789562
    },
    {
        "content": "<p>and sorry for pushing this way past the end of your day</p>",
        "id": 21680,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472789571
    },
    {
        "content": "<p>haha, no prob, later</p>",
        "id": 21681,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472789585
    },
    {
        "content": "<p>night!</p>",
        "id": 21682,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472789591
    },
    {
        "content": "<p>So I looked at var/uploads again, and I think now I understand what Tim was saying to <span class=\"user-mention\" data-user-email=\"rishig@zulipchat.com\">@Rishi Gupta</span> (based on Rishi's summary).  We should continue to have production hit <code>/home/zulip/uploads</code> with no \"var\".  The main purpose of the \"var\" convention is to make it easy to write stuff inside of our git repo when running a dev instance, and then \"var\" gets excluded from checkins.  For production, that's not as much of a concern.<br>\nFor upgrades we don't want to be changing the directory around and confusing matters, especially with the extra moving part of nginx configs (which have their own issues in terms of being overwritten by accident when admins go to S3).<br>\nSo, long story short...</p>",
        "id": 21708,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472842887
    },
    {
        "content": "<p>We should do this:</p>\n<div class=\"codehilite\"><pre>$ git diff\ndiff --git a/zproject/prod_settings_template.py b/zproject/prod_settings_template.py\nindex 4a5750b..d0eef7f 100644\n--- a/zproject/prod_settings_template.py\n+++ b/zproject/prod_settings_template.py\n@@ -155,7 +155,7 @@ INLINE_IMAGE_PREVIEW = True\n # https://github.com/zulip/zulip/issues/291 for discussion of a better\n # solution that won&#39;t be automatically reverted by the Zulip upgrade\n # script), and then restart nginx.\n-LOCAL_UPLOADS_DIR = &quot;/home/zulip/var/uploads&quot;\n+LOCAL_UPLOADS_DIR = &quot;/home/zulip/uploads&quot;\n #S3_AUTH_UPLOADS_BUCKET = &quot;&quot;\n #S3_AVATAR_BUCKET = &quot;&quot;\n ```\n</pre></div>",
        "id": 21709,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472842945
    },
    {
        "content": "<p>(That essentially reverts 1/3 of the commit that added \"var/uploads\", but keeps the good 2/3 of the commit that makes our dev setup less fragile.)</p>",
        "id": 21710,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472843033
    },
    {
        "content": "<p>cool, makes sense</p>",
        "id": 21711,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472844144
    },
    {
        "content": "<p>I think Luke has not done the deployment yet, so I'll sneak it in to the 1.4.1</p>",
        "id": 21712,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472844164
    },
    {
        "content": "<p>added :)</p>",
        "id": 21713,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472845096
    },
    {
        "content": "<p>nice detective work!</p>",
        "id": 21714,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472845137
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 21715,
        "sender_full_name": "Steve Howell",
        "timestamp": 1472845152
    },
    {
        "content": "<p>update: having trouble getting in touch with Luke, and looks like I don't have bits for zulip-announce (oops), so put it up at <a href=\"https://dl.dropboxusercontent.com/u/23782125/zulip-server-1.4.1.tar.gz\" target=\"_blank\" title=\"https://dl.dropboxusercontent.com/u/23782125/zulip-server-1.4.1.tar.gz\">https://dl.dropboxusercontent.com/u/23782125/zulip-server-1.4.1.tar.gz</a> and sent out the link to zulip-devel</p>",
        "id": 21741,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472890815
    },
    {
        "content": "<p>it's up!</p>",
        "id": 21744,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1472926325
    }
]