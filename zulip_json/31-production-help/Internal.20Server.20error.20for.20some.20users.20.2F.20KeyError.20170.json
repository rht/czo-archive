[
    {
        "content": "<p>Hello, we just updated our Zulip to the latest version, since that, some users (minimum 2) got an Internal Server Error when they login from web or desktop app. That's the error log :</p>\n<div class=\"codehilite\"><pre><span></span>2020-01-06 13:29:46.016 ERR  [django.request] Internal Server Error: /\nTraceback (most recent call last):\n  File &quot;/srv/zulip-venv-cache/546c5f60162d0b5be09d52adebaa995f9c609da3/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/exception.py&quot;, line 41, in inner\n    response = get_response(request)\n  File &quot;/srv/zulip-venv-cache/546c5f60162d0b5be09d52adebaa995f9c609da3/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/base.py&quot;, line 187, in _get_response\n    response = self.process_exception_by_middleware(e, request)\n  File &quot;/srv/zulip-venv-cache/546c5f60162d0b5be09d52adebaa995f9c609da3/zulip-py3-venv/lib/python3.5/site-packages/django/core/handlers/base.py&quot;, line 185, in _get_response\n    response = wrapped_callback(request, *callback_args, **callback_kwargs)\n  File &quot;./zerver/views/home.py&quot;, line 82, in home\n    return home_real(request)\n  File &quot;./zerver/decorator.py&quot;, line 414, in _wrapped_view\n    return view_func(request, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/546c5f60162d0b5be09d52adebaa995f9c609da3/zulip-py3-venv/lib/python3.5/site-packages/django/contrib/auth/decorators.py&quot;, line 23, in _wrapped_view\n    return view_func(request, *args, **kwargs)\n  File &quot;./zerver/decorator.py&quot;, line 467, in _wrapped_view_func\n    return rate_limit()(view_func)(request, *args, **kwargs)\n  File &quot;./zerver/decorator.py&quot;, line 829, in wrapped_func\n    return func(request, *args, **kwargs)\n  File &quot;./zerver/views/home.py&quot;, line 125, in home_real\n    narrow=narrow)\n  File &quot;./zerver/lib/events.py&quot;, line 876, in do_events_register\n    include_subscribers=include_subscribers)\n  File &quot;./zerver/lib/events.py&quot;, line 332, in fetch_initial_state_data\n    user_profile, include_subscribers=include_subscribers)\n  File &quot;./zerver/lib/actions.py&quot;, line 4754, in gather_subscriptions_helper\n    sub[&#39;stream_id&#39;] = stream_recipient.stream_id_for(sub[&#39;recipient_id&#39;])\n  File &quot;./zerver/lib/stream_recipient.py&quot;, line 89, in stream_id_for\n    return self.recip_to_stream[recip_id]\nKeyError: 170\n</pre></div>",
        "id": 806787,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578317525
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10026\">@Nathanaël M.</span> I haven't seen that exception before.  It seems like it should only happen as a result of some sort of database inconistency.  Was this server generated by the data import tool from HipChat or Slack?</p>",
        "id": 806827,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1578335388
    },
    {
        "content": "<p>I would investigate by running the following in a <code>manage.py shell</code>:</p>\n<div class=\"codehilite\"><pre><span></span>for stream in Stream.objects.all():\n     print(stream.recipient_id, stream.id, Recipient.objects.get(type=Recipient.STREAM, type_id=stream.id).id)\n</pre></div>\n\n\n<p>The output should look like this:</p>\n<div class=\"codehilite\"><pre><span></span>101 33 101\n103 35 103\n99 31 99\n100 32 100\n107 36 107\n108 37 108\n109 38 109\n110 39 110\n111 40 111\n112 41 112\n113 42 113\n114 43 114\n115 44 115\n120 45 120\n</pre></div>\n\n\n<p>and looking for whether there's any cases where the first number is None or otherwise doesn't match the 3rd number.</p>",
        "id": 806829,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1578335623
    },
    {
        "content": "<p>(If you have a lot of streams you can add an <code>if</code> statement)</p>",
        "id": 806830,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1578335633
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span>  Not at all, data was from Zulip since we installed more than year ago</p>",
        "id": 806853,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578336777
    },
    {
        "content": "<p>I will check tomorrow from failed server</p>",
        "id": 806854,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578336828
    },
    {
        "content": "<p>Great, thanks.  The most likely culprit is a bug in this migration: <code>zerver/migrations/0256_userprofile_stream_set_recipient_column_values.py</code></p>",
        "id": 806864,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1578338988
    },
    {
        "content": "<p>And that test should let us figure out whether this is the right direction to investigate.</p>",
        "id": 806865,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1578339013
    },
    {
        "content": "<p>Indeed, seems like it could be something relating to that migration. At the same time, in such a case, I'd expect it to be happening deterministically to all users, rather than just \"some\" <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span>  <span class=\"user-mention\" data-user-id=\"10026\">@Nathanaël M.</span> Are the affected users permanently unable to login, or it only happened to them once or a couple of times and then things worked again?</p>",
        "id": 806999,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578379447
    },
    {
        "content": "<p>As a sidenote, the whole <code>stream_recipient.py</code> file should be possible to simplify significantly now.</p>",
        "id": 807000,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578379584
    },
    {
        "content": "<p>No, it was permanently for 5 users</p>",
        "id": 807004,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578385330
    },
    {
        "content": "<p>I tested with my account, and other work colleagues accounts, it was fine from web or desktop</p>",
        "id": 807005,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578385354
    },
    {
        "content": "<p>Ah, I see. I wonder if they're perhaps all subscribed to a problematic stream, and the people without the issue aren't subscribed to it <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> Either way, running the code in <code>manage.py shell</code> that Tim posted should be very informative for the first step to debug this. Have you managed to do that?</p>",
        "id": 807008,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578386298
    },
    {
        "content": "<p>That's the output : </p>\n<div class=\"codehilite\"><pre><span></span>In [1]: for stream in Stream.objects.all():\n   ...:      print(stream.recipient_id, stream.id, Recipient.objects.get(type=Recipient.STREAM, type_id=stream.id).id)\n   ...:\n9 1 9\n11 3 11\n12 4 12\n21 8 21\n25 9 25\n10 2 10\n13 5 13\n20 7 20\n14 6 14\n26 10 26\n27 11 27\n28 12 28\n31 14 31\n32 15 32\n33 16 33\n34 17 34\n37 18 37\n38 19 38\n43 20 43\n45 21 45\n46 22 46\n53 23 53\n54 24 54\n55 25 55\n62 26 62\n63 27 63\n65 28 65\n66 29 66\n67 30 67\n84 31 84\n88 32 88\n97 33 97\n99 34 99\n114 35 114\n117 36 117\n118 37 118\n121 38 121\n124 39 124\n130 40 130\n135 41 135\n140 42 140\n144 43 144\n146 44 146\n159 46 159\n163 47 163\n165 48 165\n176 52 176\n178 54 178\n180 56 180\n181 57 181\n156 45 156\n29 13 29\n179 55 179\n168 50 168\n166 49 166\n177 53 177\n</pre></div>",
        "id": 807010,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578386636
    },
    {
        "content": "<p>Hmm, the numbers are consistent, but the recipient_id that's causing the KeyError (170) isn't here... Can you check the output of</p>\n<div class=\"codehilite\"><pre><span></span>Recipient.objects.get(id=170)\nSubscription.objects.filter(recipient_id=170).count()\n</pre></div>\n\n\n<p>in <code>manage.py shell</code> again?</p>",
        "id": 807011,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578387786
    },
    {
        "content": "<p>1</p>",
        "id": 807012,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578387818
    },
    {
        "content": "<p>I posted the 2nd line with the wrong id, please make sure to run with the corrected one? (170)</p>",
        "id": 807013,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578387864
    },
    {
        "content": "<p>No problem</p>",
        "id": 807014,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578387899
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>In [4]: Recipient.objects.get(id=170)\n   ...: Subscription.objects.filter(recipient_id=170).count()\nOut[4]: 6\n</pre></div>",
        "id": 807015,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578387900
    },
    {
        "content": "<p>Ah, the first line isn't showing output when run in this way, my bad. Can you run just <code>Recipient.objects.get(id=170)</code> ?</p>",
        "id": 807016,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578387997
    },
    {
        "content": "<p>Also, if you run <code>Subscription.objects.filter(recipient_id=170).select_related().values_list('user_profile__email') </code> you'll get a list of user emails, can you verify that they match the  5 users you said have the problem? There'll be one extra email in the list and if I'm correct that user would have this issue too.</p>",
        "id": 807017,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578388136
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">]:</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"mi\">170</span><span class=\"p\">)</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">]:</span> <span class=\"o\">---------------------------------------------------------------------------</span>\n<span class=\"n\">DoesNotExist</span>                              <span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">)</span>\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">IPython</span><span class=\"o\">/</span><span class=\"n\">core</span><span class=\"o\">/</span><span class=\"n\">formatters</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">)</span>\n    <span class=\"mi\">700</span>                 <span class=\"n\">type_pprinters</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">type_printers</span><span class=\"p\">,</span>\n    <span class=\"mi\">701</span>                 <span class=\"n\">deferred_pprinters</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_printers</span><span class=\"p\">)</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">702</span>             <span class=\"n\">printer</span><span class=\"o\">.</span><span class=\"n\">pretty</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n    <span class=\"mi\">703</span>             <span class=\"n\">printer</span><span class=\"o\">.</span><span class=\"n\">flush</span><span class=\"p\">()</span>\n    <span class=\"mi\">704</span>             <span class=\"k\">return</span> <span class=\"n\">stream</span><span class=\"o\">.</span><span class=\"n\">getvalue</span><span class=\"p\">()</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">IPython</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">pretty</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">pretty</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">)</span>\n    <span class=\"mi\">400</span>                         <span class=\"k\">if</span> <span class=\"bp\">cls</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"nb\">object</span> \\\n    <span class=\"mi\">401</span>                                 <span class=\"ow\">and</span> <span class=\"n\">callable</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;__repr__&#39;</span><span class=\"p\">)):</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">402</span>                             <span class=\"k\">return</span> <span class=\"n\">_repr_pprint</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">cycle</span><span class=\"p\">)</span>\n    <span class=\"mi\">403</span>\n    <span class=\"mi\">404</span>             <span class=\"k\">return</span> <span class=\"n\">_default_pprint</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">cycle</span><span class=\"p\">)</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">IPython</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">pretty</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">_repr_pprint</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">,</span> <span class=\"n\">cycle</span><span class=\"p\">)</span>\n    <span class=\"mi\">695</span>     <span class=\"s2\">&quot;&quot;&quot;A pprint that just redirects to the normal repr function.&quot;&quot;&quot;</span>\n    <span class=\"mi\">696</span>     <span class=\"c1\"># Find newlines and replace them with p.break_()</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">697</span>     <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"nb\">repr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n    <span class=\"mi\">698</span>     <span class=\"k\">for</span> <span class=\"n\">idx</span><span class=\"p\">,</span><span class=\"n\">output_line</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"n\">output</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">()):</span>\n    <span class=\"mi\">699</span>         <span class=\"k\">if</span> <span class=\"n\">idx</span><span class=\"p\">:</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"fm\">__repr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">588</span>     <span class=\"k\">def</span> <span class=\"fm\">__repr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n    <span class=\"mi\">589</span>         <span class=\"k\">try</span><span class=\"p\">:</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">590</span>             <span class=\"n\">u</span> <span class=\"o\">=</span> <span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">text_type</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">591</span>         <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">UnicodeEncodeError</span><span class=\"p\">,</span> <span class=\"ne\">UnicodeDecodeError</span><span class=\"p\">):</span>\n    <span class=\"mi\">592</span>             <span class=\"n\">u</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;[Bad Unicode data]&#39;</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"fm\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">765</span>\n    <span class=\"mi\">766</span>     <span class=\"k\">def</span> <span class=\"fm\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">767</span>         <span class=\"n\">display_recipient</span> <span class=\"o\">=</span> <span class=\"n\">get_display_recipient</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">768</span>         <span class=\"k\">return</span> <span class=\"s2\">&quot;&lt;Recipient: </span><span class=\"si\">%s</span><span class=\"s2\"> (</span><span class=\"si\">%d</span><span class=\"s2\">, </span><span class=\"si\">%s</span><span class=\"s2\">)&gt;&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">display_recipient</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">type_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">type</span><span class=\"p\">)</span>\n    <span class=\"mi\">769</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient</span><span class=\"p\">(</span><span class=\"n\">recipient</span><span class=\"p\">)</span>\n    <span class=\"mi\">100</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span>\n    <span class=\"mi\">101</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type</span><span class=\"p\">,</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">102</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type_id</span>\n    <span class=\"mi\">103</span>     <span class=\"p\">)</span>\n    <span class=\"mi\">104</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient_by_id</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">92</span>\n     <span class=\"mi\">93</span>     <span class=\"k\">if</span> <span class=\"n\">recipient_id</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">:</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">94</span>         <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">get_display_recipient_remote_cache</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">95</span>         <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">[</span><span class=\"n\">recipient_id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">result</span>\n     <span class=\"mi\">96</span>     <span class=\"k\">return</span> <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">[</span><span class=\"n\">recipient_id</span><span class=\"p\">]</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">cache</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">func_with_caching</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">166</span>                 <span class=\"k\">return</span> <span class=\"n\">val</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n    <span class=\"mi\">167</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">168</span>             <span class=\"n\">val</span> <span class=\"o\">=</span> <span class=\"n\">func</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">169</span>\n    <span class=\"mi\">170</span>             <span class=\"n\">cache_set</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">cache_name</span><span class=\"o\">=</span><span class=\"n\">cache_name</span><span class=\"p\">,</span> <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"n\">timeout</span><span class=\"p\">)</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">display_recipient</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient_remote_cache</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">25</span>     <span class=\"k\">if</span> <span class=\"n\">recipient_type</span> <span class=\"o\">==</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">STREAM</span><span class=\"p\">:</span>\n     <span class=\"mi\">26</span>         <span class=\"k\">assert</span> <span class=\"n\">recipient_type_id</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">27</span>         <span class=\"n\">stream</span> <span class=\"o\">=</span> <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">28</span>         <span class=\"k\">return</span> <span class=\"n\">stream</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span>\n     <span class=\"mi\">29</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">378</span>             <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">(</span>\n    <span class=\"mi\">379</span>                 <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> matching query does not exist.&quot;</span> <span class=\"o\">%</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">380</span>                 <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span>\n    <span class=\"mi\">381</span>             <span class=\"p\">)</span>\n    <span class=\"mi\">382</span>         <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">MultipleObjectsReturned</span><span class=\"p\">(</span>\n\n<span class=\"n\">DoesNotExist</span><span class=\"p\">:</span> <span class=\"n\">Stream</span> <span class=\"n\">matching</span> <span class=\"n\">query</span> <span class=\"n\">does</span> <span class=\"ow\">not</span> <span class=\"n\">exist</span><span class=\"o\">.</span>\n</pre></div>",
        "id": 807018,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578388553
    },
    {
        "content": "<p>Oh, when I run <code>Subscription.objects.filter(recipient_id=170).select_related().values_list('user_profile__email')</code> I got the list of users who got the problem</p>",
        "id": 807019,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578388590
    },
    {
        "content": "<p>Yeah, there are 6 emails, but the last is a colleague out from work this week, that's why I didn't saw he got the problem too</p>",
        "id": 807020,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578388677
    },
    {
        "content": "<p>Okay, I think I understand the problem now. The fix should be simple, though I think it's best to wait for Tim to say if my suggestion is safe.</p>\n<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> So it seems like a stream was deleted, deleting the <code>Recipient</code> object, but for some reason at least some of the <code>Subscription</code>s didn't get deleted. (I'm somewhat confused about how that would happen though, did we run into something like this before? Perhaps a Django bug, since these fields have  <code>on_delete=CASCADE</code>). An easy fix should be to just <code>.delete()</code> the Subsciptions (perhaps after saving the <code>.values()</code> dict to a file to be safe). Does that sound right? Or do we have a better approach</p>",
        "id": 807024,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578389050
    },
    {
        "content": "<p>True, I deleted some streams, btw we got a problem since weeks, we can't unsubscribe from streams, or delete streams</p>",
        "id": 807025,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578389108
    },
    {
        "content": "<p>Then, I didn't deleted streams, but removed every user from useless old streams</p>",
        "id": 807026,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578389146
    },
    {
        "content": "<p>I used the <code>manage.py remove_users_from_stream</code></p>",
        "id": 807027,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578389176
    },
    {
        "content": "<p>Huh, that is even stranger. What happens if you try to delete a stream?</p>",
        "id": 807028,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578389242
    },
    {
        "content": "<p>Same</p>",
        "id": 807029,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578389254
    },
    {
        "content": "<p>Nothing happens</p>",
        "id": 807030,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578389257
    },
    {
        "content": "<p>No errors, and nothing in server.log or errors.log</p>",
        "id": 807031,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578389335
    },
    {
        "content": "<p>Anything noteworthy that happened right before this started happening? Upgrade? Server crash? Did you successfully delete some of the mentioned streams, and then things stopped working?</p>",
        "id": 807036,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578389660
    },
    {
        "content": "<p>Maybe an upgrade but it was months ago, I don't really know when it started</p>",
        "id": 807038,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578392658
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10026\">@Nathanaël M.</span> just to be clear, did you delete any of those streams using a postgres shell?  That's the simplest explanation I can see for how you'd have avoided the <code>on_delete=CASCADE</code> logic.</p>",
        "id": 807101,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1578433631
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> Oh... I just remembered I deleted a stream with the shell, yeah, but after the upgrade</p>",
        "id": 807169,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578471895
    },
    {
        "content": "<p>Because of impossible unsubscribe/deletion from GUI, I've done that with shell commands...</p>",
        "id": 807172,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578472044
    },
    {
        "content": "<p>Now I know where the error from, can you help me to resolve that bug ?</p>",
        "id": 807173,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578472181
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10026\">@Nathanaël M.</span> Can you try running this in <code>manage.py shell</code> to see if there are more problemtic objects like this?</p>\n<div class=\"codehilite\"><pre><span></span>for sub in Subscription.objects.all():\n    recipient_id = sub.recipient_id\n    try:\n        Recipient.objects.get(id=recipient_id)\n    except Recipient.DoesNotExist:\n        print(&quot;Subscription {}: missing recipient with id {}&quot;.format(sub.id, recipient_id))\n\nfor recipient in Recipient.objects.filter(type=Recipient.STREAM):\n    stream_id = recipient.type_id\n    try:\n        Stream.objects.get(id=stream_id)\n    except Stream.DoesNotExist:\n        print(&quot;Recipient {}: missing stream with id {}&quot;.format(recipient, stream_id))\n</pre></div>",
        "id": 807177,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578473679
    },
    {
        "content": "<p>For the first command I got nothing</p>",
        "id": 807178,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578473816
    },
    {
        "content": "<p>For the other : </p>\n<div class=\"codehilite\"><pre><span></span>DoesNotExist                              Traceback (most recent call last)\n&lt;ipython-input-6-5cd7a46cd170&gt; in &lt;module&gt;\n      3     try:\n----&gt; 4         Stream.objects.get(id=stream_id)\n      5     except Stream.DoesNotExist:\n\n~/deployments/2020-01-06-12-05-54/zulip-py3-venv/lib/python3.5/site-packages/django/db/models/manager.py in manager_method(self, *args, **kwargs)\n     84             def manager_method(self, *args, **kwargs):\n---&gt; 85                 return getattr(self.get_queryset(), name)(*args, **kwargs)\n     86             manager_method.__name__ = method.__name__\n\n~/deployments/2020-01-06-12-05-54/zulip-py3-venv/lib/python3.5/site-packages/django/db/models/query.py in get(self, *args, **kwargs)\n    379                 &quot;%s matching query does not exist.&quot; %\n--&gt; 380                 self.model._meta.object_name\n    381             )\n\nDoesNotExist: Stream matching query does not exist.\n\nDuring handling of the above exception, another exception occurred:\n\nDoesNotExist                              Traceback (most recent call last)\n&lt;ipython-input-6-5cd7a46cd170&gt; in &lt;module&gt;\n      4         Stream.objects.get(id=stream_id)\n      5     except Stream.DoesNotExist:\n----&gt; 6         print(&quot;Recipient {}: missing stream with id {}&quot;.format(recipient, stream_id))\n      7\n\n~/deployments/2020-01-06-12-05-54/zerver/models.py in __str__(self)\n    765\n    766     def __str__(self) -&gt; str:\n--&gt; 767         display_recipient = get_display_recipient(self)\n    768         return &quot;&lt;Recipient: %s (%d, %s)&gt;&quot; % (display_recipient, self.type_id, self.type)\n    769\n\n~/deployments/2020-01-06-12-05-54/zerver/models.py in get_display_recipient(recipient)\n    100         recipient.id,\n    101         recipient.type,\n--&gt; 102         recipient.type_id\n    103     )\n    104\n\n~/deployments/2020-01-06-12-05-54/zerver/models.py in get_display_recipient_by_id(recipient_id, recipient_type, recipient_type_id)\n     92\n     93     if recipient_id not in per_request_display_recipient_cache:\n---&gt; 94         result = get_display_recipient_remote_cache(recipient_id, recipient_type, recipient_type_id)\n     95         per_request_display_recipient_cache[recipient_id] = result\n     96     return per_request_display_recipient_cache[recipient_id]\n\n~/deployments/2020-01-06-12-05-54/zerver/lib/cache.py in func_with_caching(*args, **kwargs)\n    166                 return val[0]\n    167\n--&gt; 168             val = func(*args, **kwargs)\n    169\n    170             cache_set(key, val, cache_name=cache_name, timeout=timeout)\n\n~/deployments/2020-01-06-12-05-54/zerver/lib/display_recipient.py in get_display_recipient_remote_cache(recipient_id, recipient_type, recipient_type_id)\n     25     if recipient_type == Recipient.STREAM:\n     26         assert recipient_type_id is not None\n---&gt; 27         stream = Stream.objects.values(&#39;name&#39;).get(id=recipient_type_id)\n     28         return stream[&#39;name&#39;]\n     29\n\n~/deployments/2020-01-06-12-05-54/zulip-py3-venv/lib/python3.5/site-packages/django/db/models/query.py in get(self, *args, **kwargs)\n    378             raise self.model.DoesNotExist(\n    379                 &quot;%s matching query does not exist.&quot; %\n--&gt; 380                 self.model._meta.object_name\n    381             )\n    382         raise self.model.MultipleObjectsReturned(\n\nDoesNotExist: Stream matching query does not exist.\n</pre></div>",
        "id": 807179,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578473828
    },
    {
        "content": "<p>Hmm, that doesn't look right, can you just copypaste the whole thing I posted as one?</p>",
        "id": 807180,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578474155
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]:</span> <span class=\"k\">for</span> <span class=\"n\">sub</span> <span class=\"ow\">in</span> <span class=\"n\">Subscription</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">():</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"n\">recipient_id</span> <span class=\"o\">=</span> <span class=\"n\">sub</span><span class=\"o\">.</span><span class=\"n\">recipient_id</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"k\">try</span><span class=\"p\">:</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>         <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">recipient_id</span><span class=\"p\">)</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"k\">except</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>         <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;Subscription </span><span class=\"si\">{}</span><span class=\"s2\">: missing recipient with id </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">sub</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span> <span class=\"n\">recipient_id</span><span class=\"p\">))</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span> <span class=\"k\">for</span> <span class=\"n\">recipient</span> <span class=\"ow\">in</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">STREAM</span><span class=\"p\">):</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"n\">stream_id</span> <span class=\"o\">=</span> <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type_id</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"k\">try</span><span class=\"p\">:</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>         <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">stream_id</span><span class=\"p\">)</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"k\">except</span> <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>         <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;Recipient </span><span class=\"si\">{}</span><span class=\"s2\">: missing stream with id </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">recipient</span><span class=\"p\">,</span> <span class=\"n\">stream_id</span><span class=\"p\">))</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>\n<span class=\"o\">---------------------------------------------------------------------------</span>\n<span class=\"n\">DoesNotExist</span>                              <span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;</span><span class=\"n\">ipython</span><span class=\"o\">-</span><span class=\"nb\">input</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mf\">1e6</span><span class=\"n\">af53b4d60</span><span class=\"o\">&gt;</span> <span class=\"ow\">in</span> <span class=\"o\">&lt;</span><span class=\"n\">module</span><span class=\"o\">&gt;</span>\n     <span class=\"mi\">10</span>     <span class=\"k\">try</span><span class=\"p\">:</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">11</span>         <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">stream_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">12</span>     <span class=\"k\">except</span> <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">manager_method</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n     <span class=\"mi\">84</span>             <span class=\"k\">def</span> <span class=\"nf\">manager_method</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">85</span>                 <span class=\"k\">return</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">(),</span> <span class=\"n\">name</span><span class=\"p\">)(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n     <span class=\"mi\">86</span>             <span class=\"n\">manager_method</span><span class=\"o\">.</span><span class=\"vm\">__name__</span> <span class=\"o\">=</span> <span class=\"n\">method</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">379</span>                 <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> matching query does not exist.&quot;</span> <span class=\"o\">%</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">380</span>                 <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span>\n    <span class=\"mi\">381</span>             <span class=\"p\">)</span>\n\n<span class=\"n\">DoesNotExist</span><span class=\"p\">:</span> <span class=\"n\">Stream</span> <span class=\"n\">matching</span> <span class=\"n\">query</span> <span class=\"n\">does</span> <span class=\"ow\">not</span> <span class=\"n\">exist</span><span class=\"o\">.</span>\n\n<span class=\"n\">During</span> <span class=\"n\">handling</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">above</span> <span class=\"n\">exception</span><span class=\"p\">,</span> <span class=\"n\">another</span> <span class=\"n\">exception</span> <span class=\"n\">occurred</span><span class=\"p\">:</span>\n\n<span class=\"n\">DoesNotExist</span>                              <span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;</span><span class=\"n\">ipython</span><span class=\"o\">-</span><span class=\"nb\">input</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mf\">1e6</span><span class=\"n\">af53b4d60</span><span class=\"o\">&gt;</span> <span class=\"ow\">in</span> <span class=\"o\">&lt;</span><span class=\"n\">module</span><span class=\"o\">&gt;</span>\n     <span class=\"mi\">11</span>         <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">stream_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">12</span>     <span class=\"k\">except</span> <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">13</span>         <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;Recipient </span><span class=\"si\">{}</span><span class=\"s2\">: missing stream with id </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">recipient</span><span class=\"p\">,</span> <span class=\"n\">stream_id</span><span class=\"p\">))</span>\n     <span class=\"mi\">14</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"fm\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">765</span>\n    <span class=\"mi\">766</span>     <span class=\"k\">def</span> <span class=\"fm\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">767</span>         <span class=\"n\">display_recipient</span> <span class=\"o\">=</span> <span class=\"n\">get_display_recipient</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">768</span>         <span class=\"k\">return</span> <span class=\"s2\">&quot;&lt;Recipient: </span><span class=\"si\">%s</span><span class=\"s2\"> (</span><span class=\"si\">%d</span><span class=\"s2\">, </span><span class=\"si\">%s</span><span class=\"s2\">)&gt;&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">display_recipient</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">type_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">type</span><span class=\"p\">)</span>\n    <span class=\"mi\">769</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient</span><span class=\"p\">(</span><span class=\"n\">recipient</span><span class=\"p\">)</span>\n    <span class=\"mi\">100</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span>\n    <span class=\"mi\">101</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type</span><span class=\"p\">,</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">102</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type_id</span>\n    <span class=\"mi\">103</span>     <span class=\"p\">)</span>\n    <span class=\"mi\">104</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient_by_id</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">92</span>\n     <span class=\"mi\">93</span>     <span class=\"k\">if</span> <span class=\"n\">recipient_id</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">:</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">94</span>         <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">get_display_recipient_remote_cache</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">95</span>         <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">[</span><span class=\"n\">recipient_id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">result</span>\n     <span class=\"mi\">96</span>     <span class=\"k\">return</span> <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">[</span><span class=\"n\">recipient_id</span><span class=\"p\">]</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">cache</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">func_with_caching</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">166</span>                 <span class=\"k\">return</span> <span class=\"n\">val</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n    <span class=\"mi\">167</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">168</span>             <span class=\"n\">val</span> <span class=\"o\">=</span> <span class=\"n\">func</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">169</span>\n    <span class=\"mi\">170</span>             <span class=\"n\">cache_set</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">cache_name</span><span class=\"o\">=</span><span class=\"n\">cache_name</span><span class=\"p\">,</span> <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"n\">timeout</span><span class=\"p\">)</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">display_recipient</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient_remote_cache</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">25</span>     <span class=\"k\">if</span> <span class=\"n\">recipient_type</span> <span class=\"o\">==</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">STREAM</span><span class=\"p\">:</span>\n     <span class=\"mi\">26</span>         <span class=\"k\">assert</span> <span class=\"n\">recipient_type_id</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">27</span>         <span class=\"n\">stream</span> <span class=\"o\">=</span> <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">28</span>         <span class=\"k\">return</span> <span class=\"n\">stream</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span>\n     <span class=\"mi\">29</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">378</span>             <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">(</span>\n    <span class=\"mi\">379</span>                 <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> matching query does not exist.&quot;</span> <span class=\"o\">%</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">380</span>                 <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span>\n    <span class=\"mi\">381</span>             <span class=\"p\">)</span>\n    <span class=\"mi\">382</span>         <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">MultipleObjectsReturned</span><span class=\"p\">(</span>\n\n<span class=\"n\">DoesNotExist</span><span class=\"p\">:</span> <span class=\"n\">Stream</span> <span class=\"n\">matching</span> <span class=\"n\">query</span> <span class=\"n\">does</span> <span class=\"ow\">not</span> <span class=\"n\">exist</span><span class=\"o\">.</span>\n</pre></div>",
        "id": 807188,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578479214
    },
    {
        "content": "<p>Uh, not sure what's going on there, can you try like this? (to avoid the annoying exceptions)</p>\n<div class=\"codehilite\"><pre><span></span>for sub in Subscription.objects.all():\n    recipient_id = sub.recipient_id\n    if not Recipient.objects.filter(id=recipient_id).exists():\n        print(&quot;Subscription {}: missing recipient with id {}&quot;.format(sub.id, recipient_id))\n\nfor recipient in Recipient.objects.filter(type=Recipient.STREAM):\n    stream_id = recipient.type_id\n    if not Stream.objects.filter(id=stream_id).exists():\n        print(&quot;Recipient {}: missing stream with id {}&quot;.format(recipient, stream_id))\n</pre></div>",
        "id": 807190,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578479948
    },
    {
        "content": "<p>Same</p>",
        "id": 807192,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578483083
    },
    {
        "content": "<p>Can you post the output?</p>",
        "id": 807194,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578483567
    },
    {
        "content": "<p>Sure : </p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]:</span> <span class=\"k\">for</span> <span class=\"n\">sub</span> <span class=\"ow\">in</span> <span class=\"n\">Subscription</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">():</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"n\">recipient_id</span> <span class=\"o\">=</span> <span class=\"n\">sub</span><span class=\"o\">.</span><span class=\"n\">recipient_id</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">recipient_id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">():</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>         <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;Subscription </span><span class=\"si\">{}</span><span class=\"s2\">: missing recipient with id </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">sub</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span> <span class=\"n\">recipient_id</span><span class=\"p\">))</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span> <span class=\"k\">for</span> <span class=\"n\">recipient</span> <span class=\"ow\">in</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">STREAM</span><span class=\"p\">):</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"n\">stream_id</span> <span class=\"o\">=</span> <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type_id</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">stream_id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">():</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>         <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;Recipient </span><span class=\"si\">{}</span><span class=\"s2\">: missing stream with id </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">recipient</span><span class=\"p\">,</span> <span class=\"n\">stream_id</span><span class=\"p\">))</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>\n<span class=\"o\">---------------------------------------------------------------------------</span>\n<span class=\"n\">DoesNotExist</span>                              <span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;</span><span class=\"n\">ipython</span><span class=\"o\">-</span><span class=\"nb\">input</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mi\">65838</span><span class=\"n\">c73fa58</span><span class=\"o\">&gt;</span> <span class=\"ow\">in</span> <span class=\"o\">&lt;</span><span class=\"n\">module</span><span class=\"o\">&gt;</span>\n      <span class=\"mi\">7</span>     <span class=\"n\">stream_id</span> <span class=\"o\">=</span> <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type_id</span>\n      <span class=\"mi\">8</span>     <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">stream_id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">():</span>\n<span class=\"o\">----&gt;</span> <span class=\"mi\">9</span>         <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;Recipient </span><span class=\"si\">{}</span><span class=\"s2\">: missing stream with id </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">recipient</span><span class=\"p\">,</span> <span class=\"n\">stream_id</span><span class=\"p\">))</span>\n     <span class=\"mi\">10</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"fm\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">765</span>\n    <span class=\"mi\">766</span>     <span class=\"k\">def</span> <span class=\"fm\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">767</span>         <span class=\"n\">display_recipient</span> <span class=\"o\">=</span> <span class=\"n\">get_display_recipient</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">768</span>         <span class=\"k\">return</span> <span class=\"s2\">&quot;&lt;Recipient: </span><span class=\"si\">%s</span><span class=\"s2\"> (</span><span class=\"si\">%d</span><span class=\"s2\">, </span><span class=\"si\">%s</span><span class=\"s2\">)&gt;&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">display_recipient</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">type_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">type</span><span class=\"p\">)</span>\n    <span class=\"mi\">769</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient</span><span class=\"p\">(</span><span class=\"n\">recipient</span><span class=\"p\">)</span>\n    <span class=\"mi\">100</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span>\n    <span class=\"mi\">101</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type</span><span class=\"p\">,</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">102</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type_id</span>\n    <span class=\"mi\">103</span>     <span class=\"p\">)</span>\n    <span class=\"mi\">104</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient_by_id</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">92</span>\n     <span class=\"mi\">93</span>     <span class=\"k\">if</span> <span class=\"n\">recipient_id</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">:</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">94</span>         <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">get_display_recipient_remote_cache</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">95</span>         <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">[</span><span class=\"n\">recipient_id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">result</span>\n     <span class=\"mi\">96</span>     <span class=\"k\">return</span> <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">[</span><span class=\"n\">recipient_id</span><span class=\"p\">]</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">cache</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">func_with_caching</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">166</span>                 <span class=\"k\">return</span> <span class=\"n\">val</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n    <span class=\"mi\">167</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">168</span>             <span class=\"n\">val</span> <span class=\"o\">=</span> <span class=\"n\">func</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">169</span>\n    <span class=\"mi\">170</span>             <span class=\"n\">cache_set</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">cache_name</span><span class=\"o\">=</span><span class=\"n\">cache_name</span><span class=\"p\">,</span> <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"n\">timeout</span><span class=\"p\">)</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">display_recipient</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient_remote_cache</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">25</span>     <span class=\"k\">if</span> <span class=\"n\">recipient_type</span> <span class=\"o\">==</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">STREAM</span><span class=\"p\">:</span>\n     <span class=\"mi\">26</span>         <span class=\"k\">assert</span> <span class=\"n\">recipient_type_id</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">27</span>         <span class=\"n\">stream</span> <span class=\"o\">=</span> <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">28</span>         <span class=\"k\">return</span> <span class=\"n\">stream</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span>\n     <span class=\"mi\">29</span>\n\n<span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2020</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span><span class=\"o\">-</span><span class=\"mi\">54</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">5</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"ow\">in</span> <span class=\"n\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">378</span>             <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">(</span>\n    <span class=\"mi\">379</span>                 <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> matching query does not exist.&quot;</span> <span class=\"o\">%</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">380</span>                 <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span>\n    <span class=\"mi\">381</span>             <span class=\"p\">)</span>\n    <span class=\"mi\">382</span>         <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">MultipleObjectsReturned</span><span class=\"p\">(</span>\n\n<span class=\"n\">DoesNotExist</span><span class=\"p\">:</span> <span class=\"n\">Stream</span> <span class=\"n\">matching</span> <span class=\"n\">query</span> <span class=\"n\">does</span> <span class=\"ow\">not</span> <span class=\"n\">exist</span><span class=\"o\">.</span>\n</pre></div>",
        "id": 807206,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578493175
    },
    {
        "content": "<p>Ahhh, I see the issue. Trying to print out the <code>Recipient</code> object causes an error, because it requires the existence of the related Stream (which is missing by assumption). We can just print out the ids in this case:</p>\n<div class=\"codehilite\"><pre><span></span>for sub in Subscription.objects.all():\n    recipient_id = sub.recipient_id\n    if not Recipient.objects.filter(id=recipient_id).exists():\n        print(&quot;Subscription {}: missing recipient with id {}&quot;.format(sub.id, recipient_id))\n\nfor recipient in Recipient.objects.filter(type=Recipient.STREAM):\n    stream_id = recipient.type_id\n    if not Stream.objects.filter(id=stream_id).exists():\n        print(&quot;Recipient {}: missing stream with id {}&quot;.format(recipient.id, stream_id))\n</pre></div>",
        "id": 807210,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578497630
    },
    {
        "content": "<p><code>Recipient 170: missing stream with id 51</code></p>",
        "id": 807215,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578500911
    },
    {
        "content": "<p>But as I said, that's bug is not problematic anymore, because we restored a backup last time</p>",
        "id": 807236,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578505508
    },
    {
        "content": "<p>Right now, the main problem is the impossible unsubscribe/deletion from GUI</p>",
        "id": 807237,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578505540
    },
    {
        "content": "<p>OK, great, glad to have confirmation that the deletion was done manually via a database shell.</p>",
        "id": 807322,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1578516000
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10026\">@Nathanaël M.</span> can you confirm whether you did it with a <code>postgres</code> shell or a Django shell?</p>",
        "id": 807325,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1578516033
    },
    {
        "content": "<p>I used the manage command, and I've done a get channel .delete()</p>",
        "id": 807372,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578517564
    },
    {
        "content": "<p>I don't remember the exact manage shell command</p>",
        "id": 807374,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578517596
    },
    {
        "content": "<p>OK, that's helpful.  In theory, the <code>on_delete=CASCADE</code> should have deleted those Subscription objects as well.  We can test that precise procedure, though, to see if it can reproduce this leaked Recipient object.</p>",
        "id": 807383,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1578517819
    },
    {
        "content": "<p>Yeah !</p>",
        "id": 807530,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578522407
    },
    {
        "content": "<p>It's useless to test right now, because our main problem is the one I told you before</p>",
        "id": 807533,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578522434
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10026\">@Nathanaël M.</span> you ran that code above after restoring the backup? Because the broken subscriptions are gone, but you still have a database incosistency with the <code>Recipient</code> object  pointing to the deleted <code>Stream</code>. Which can cause more problems in the future again.</p>\n<p>For the unsubscribing issue, what happens if you try this code to unsubscribe yourself from a test stream:</p>\n<div class=\"codehilite\"><pre><span></span>from zerver.lib.actions import bulk_remove_subscriptions\n\nrealm = get_realm(&quot;&quot;)\nuser = get_user_by_delivery_email(&quot;youremail@domain.com&quot;, realm)\nstream = get_stream(&quot;YourStreamName&quot;, realm)\n\nbulk_remove_subscriptions([user], [stream], get_client(&quot;ZulipServer&quot;))\n</pre></div>\n\n\n<p>(fill in your email and the stream name in there)</p>",
        "id": 807829,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578572795
    },
    {
        "content": "<p>Yeah, I ran every commands on cloned zulip failed server</p>",
        "id": 807853,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578577743
    },
    {
        "content": "<p>Our current restored zulip server runs fine</p>",
        "id": 807856,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578579988
    },
    {
        "content": "<p>Fine except unsubscribing/deleting streams? Have you tried running that code I posted above to try to debug the issue? (unless I misunderstood and that issue is resolved now too)</p>",
        "id": 808037,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1578643725
    },
    {
        "content": "<p>Yeah, just tried and no problems</p>",
        "id": 808054,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578650948
    },
    {
        "content": "<p>Unsubscribe with that command works without errors</p>",
        "id": 808055,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1578650980
    },
    {
        "content": "<p>Do I need to create another topic for my problem with GUI ?</p>",
        "id": 809245,
        "sender_full_name": "Nathanaël M.",
        "timestamp": 1579077311
    },
    {
        "content": "<p>I'm not sure what your problem with GUI is, but if it's unrelated to this one, you should create a new topic for it.</p>",
        "id": 809404,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1579120261
    }
]