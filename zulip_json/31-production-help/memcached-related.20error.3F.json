[
    {
        "content": "<p>Good day all --</p>\n<p>In the course of installing Zulip in my datacenter (backstory: 18.04 LTS; certs are already properly configured; postgres is up and receiving connections on the host) and netstat tells me Memcached is also listening on its designated port),</p>\n<p>As a result of issuing this command:</p>\n<hr>\n<p>export EMAIL=\"&lt;valid email&gt;\"<br>\nexport HOSTNAME=\"&lt;valid hostname&gt;\"<br>\nsudo -s ./zulip-server-*/scripts/setup/install --email=${EMAIL} --hostname=${HOSTNAME}</p>\n<hr>\n<p>I was getting this error:</p>\n<hr>\n<p>sudo tail /var/log/zulip/install.log<br>\nCREATE DATABASE<br>\nYou are now connected to database \"zulip\" as user \"postgres\".<br>\nCREATE SCHEMA zulip AUTHORIZATION zulip;<br>\nCREATE SCHEMA<br>\n++ dirname /home/ubuntu/downloads/zulip-server-2.1.4/scripts/setup/postgres-init-db</p>\n<ul>\n<li>/home/ubuntu/downloads/zulip-server-2.1.4/scripts/setup/flush-memcached<br>\nTraceback (most recent call last):<br>\n  File \"/home/ubuntu/downloads/zulip-server-2.1.4/scripts/setup/flush-memcached\", line 18, in &lt;module&gt;<br>\n    behaviors=settings.CACHES[\"default\"][\"OPTIONS\"]  # type: ignore # settings not typed properly<br>\npylibmc.SomeErrors: error 19 from flush_all: (0x28fd400) AUTHENTICATION FAILURE,  host: 127.0.0.1:11211 -&gt; libmemcached/sasl.cc:292</li>\n</ul>\n<hr>\n<p>The fix was to open the file &lt;ZULIP_HOME&gt;/scripts/setup/flush-memcache</p>\n<p>and comment out the lines:</p>\n<p>username=settings.MEMCACHED_USERNAME,<br>\npassword=settings.MEMCACHED_PASSWORD,</p>\n<p>This fixed the problem -- but it looks like email transport is now broken.</p>\n<p>Question #1: What is a proper fix for this problem?<br>\nQuestion #2: Did I in fact break email transport, or is something else going on?</p>\n<p>Thanks for reading (I know this is a long one).</p>",
        "id": 909753,
        "sender_full_name": "Dexter Taylor",
        "timestamp": 1592620049
    },
    {
        "content": "<p>I should add that when I spin up Zulip, I can interact with it via the web app, but I also get a stream of errors emitted to the admin address:</p>\n<hr>\n<p>Logger django.pylibmc, from module django_pylibmc.memcached line 146:<br>\nError generated by Anonymous user (not logged in) on ip-10-0-1-178 deployment</p>\n<p>Traceback (most recent call last):<br>\n  File \"/home/zulip/deployments/2020-06-15-17-40-15/zulip-py3-venv/lib/python3.6/site-packages/django_pylibmc/memcached.py\", line 130, in get<br>\n    return super(PyLibMCCache, self).get(key, default, version)<br>\n  File \"/home/zulip/deployments/2020-06-15-17-40-15/zulip-py3-venv/lib/python3.6/site-packages/django/core/cache/backends/memcached.py\", line 79, in get<br>\n    val = self._cache.get(key)<br>\npylibmc.Error: error 41 from memcached_get(:1:e37d7d97b1dc2de9cbc941941746d): (0x7ff5140310f0) AUTHENTICATION FAILURE,  host: 127.0.0.1:11211 -&gt; libmemcached/sasl.cc:292</p>\n<p>During handling of the above exception, another exception occurred:</p>\n<p>Traceback (most recent call last):<br>\n  File \"/home/zulip/deployments/2020-06-15-17-40-15/zulip-py3-venv/lib/python3.6/site-packages/django_pylibmc/memcached.py\", line 140, in set<br>\n    **COMPRESS_KWARGS)<br>\npylibmc.ServerDown: error 47 from memcached_set: (0x7ff5140310f0) SERVER HAS FAILED AND IS DISABLED UNTIL TIMED RETRY,  host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:720</p>\n<p>Deployed code:</p>\n<ul>\n<li>ZULIP_VERSION: 2.1.3-9-g2b95f54593</li>\n<li>version: 2.1.4</li>\n</ul>\n<hr>",
        "id": 909754,
        "sender_full_name": "Dexter Taylor",
        "timestamp": 1592620825
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"16315\">@Dexter Taylor</span> the problem here is that memcached authentication is not working, likely because your system's hostname changed sometime after you first installed.   I believe this is fixed here: <a href=\"https://github.com/zulip/zulip/pull/15462\">https://github.com/zulip/zulip/pull/15462</a> (which fixes the bug that made the system hostname part of the credentials used to authenticate with memcached).</p>\n<p>Because it's just a cache, Zulip will run, albeit slower, without it, while emailing you lots of errors about it being broken.</p>",
        "id": 909756,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592621414
    },
    {
        "content": "<p>Thank you Tim -- this is the direction I was headed in. So what I've just done is:</p>\n<p>-- shut down the Zulip stack using supervisorctl<br>\n-- created and installed valid SASL credentials for memcached<br>\n-- verified that I could connect to memcached using that username and password</p>\n<p>But of course my problem now is, I don't know what credentials Zulip is using to connect to memcached.  How do I access/configure that?</p>",
        "id": 909761,
        "sender_full_name": "Dexter Taylor",
        "timestamp": 1592623097
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"16315\">@Dexter Taylor</span> our puppet rules generate the credentials.  Most of the logic in that PR is just ensuring the generating happens twice.</p>",
        "id": 909763,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592623236
    },
    {
        "content": "<p>I can add it to our <code>2.1.x</code> branch, and then you can test <code>upgrade-zulip-from-git 2.1.x</code> fixes it for you (effectively QAing this change for our next release).  Would that work for you?</p>",
        "id": 909764,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592623278
    },
    {
        "content": "<p>Just added it to that branch.</p>",
        "id": 909766,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592623332
    },
    {
        "content": "<p>(Basically, the main reason it hasn't been merged/released is I wanted to get a full test that it fixes the problem for someone in exactly your situation)</p>",
        "id": 909767,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592623359
    },
    {
        "content": "<p>ok, I'll try that now</p>",
        "id": 909768,
        "sender_full_name": "Dexter Taylor",
        "timestamp": 1592623585
    },
    {
        "content": "<p>where does the command </p>\n<p>upgrade-zulip-from-git</p>\n<p>live?</p>",
        "id": 909769,
        "sender_full_name": "Dexter Taylor",
        "timestamp": 1592623723
    },
    {
        "content": "<p><a href=\"https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-a-git-repository\">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-a-git-repository</a></p>",
        "id": 909770,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592623743
    },
    {
        "content": "<p>Looks like that worked! Now zulip is sending invitation emails properly.</p>\n<p>Thanks for your help! That was a lifesaver.</p>",
        "id": 909778,
        "sender_full_name": "Dexter Taylor",
        "timestamp": 1592624705
    },
    {
        "content": "<p>Great!</p>",
        "id": 909779,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592624724
    },
    {
        "content": "<p>Thanks for verifying the fix <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 909780,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592624730
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"699\">@Anders Kaseorg</span> FYI.  Any objection to my releasing 2.1.7 with that your memcached PR tomorrow?</p>",
        "id": 909781,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592624766
    },
    {
        "content": "<p>Sure; just be aware that it wonâ€™t work with the docker-zulip 2.1.6 docker-compose.yml.</p>",
        "id": 909787,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1592627700
    },
    {
        "content": "<p>Hmm, is the docker-compose.yml change to support it complex?</p>",
        "id": 909788,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1592629097
    },
    {
        "content": "<p>I expect we just need to duplicate the <code>zulip@$$HOSTNAME:$$MEMCACHED_PASSWORD</code> line as <code>zulip@localhost:$$MEMCACHED_PASSWORD</code>.</p>",
        "id": 909797,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1592635051
    }
]