[
    {
        "content": "<p>Hi there,<br>\nIn my on-premises Zulip instance (Zulip 5.5, Ubuntu 20.04.6 LTS) I try to upgrade postgres from version 10 to 14 according to <a href=\"https://zulip.readthedocs.io/en/stable/production/upgrade-or-modify.html#upgrading-postgresql\">Zulip documentation</a>.<br>\nThe call of the <code>upgrade-postgresql</code> script results in an error of <code>pg_upgrade</code> due to a missing config dir as you can see in the log below:</p>\n<div class=\"codehilite\"><pre><span></span><code>root@zulip:~# /home/zulip/deployments/current/scripts/setup/upgrade-postgresql\n[...]\n+ &#39;[&#39; &#39;!&#39; -f scripts/setup/apt-repos/zulip/focal.list &#39;]&#39;\n++ sha256sum scripts/setup/apt-repos/zulip/custom.sh scripts/setup/apt-repos/zulip/focal.list scripts/setup/apt-repos/zulip/pgdg.asc scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc scripts/setup/apt-repos/zulip/pgroonga-ppa.asc scripts/lib/setup-apt-repo\n+ DEPENDENCIES_HASH=&#39;1880c6337400b54a7e344d9c4a42ca11482709ab2641e5fd3aae85f01fd5ea5d  scripts/setup/apt-repos/zulip/custom.sh\n93d04e5e9e4e22c5d38e1dca1cf1bfc0fee36a79d7205c1397ad255f464bc09d  scripts/setup/apt-repos/zulip/focal.list\n0144068502a1eddd2a0280ede10ef607d1ec592ce819940991203941564e8e76  scripts/setup/apt-repos/zulip/pgdg.asc\n06f00f144d99826f27b8912c26d02dd4e0247f662666be5378740828d39c6a41  scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc\na133aa690de5fc1d46ca23a54bf6dd1c6468e8426e1ec9661f390e4f41a365d1  scripts/setup/apt-repos/zulip/pgroonga-ppa.asc\n8f70beaa2b1b8621a156d140e6004367684f434f0978baa78e5f742ac3fb593a  scripts/lib/setup-apt-repo&#39;\n+ DEPENDENCIES_HASH_FILE=/var/lib/zulip/setup-repositories-state-zulip\n+ touch /var/lib/zulip/setup-repositories-state-zulip\n++ cat /var/lib/zulip/setup-repositories-state-zulip\n+ LAST_DEPENDENCIES_HASH=&#39;1880c6337400b54a7e344d9c4a42ca11482709ab2641e5fd3aae85f01fd5ea5d  scripts/setup/apt-repos/zulip/custom.sh\n93d04e5e9e4e22c5d38e1dca1cf1bfc0fee36a79d7205c1397ad255f464bc09d  scripts/setup/apt-repos/zulip/focal.list\n0144068502a1eddd2a0280ede10ef607d1ec592ce819940991203941564e8e76  scripts/setup/apt-repos/zulip/pgdg.asc\n06f00f144d99826f27b8912c26d02dd4e0247f662666be5378740828d39c6a41  scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc\na133aa690de5fc1d46ca23a54bf6dd1c6468e8426e1ec9661f390e4f41a365d1  scripts/setup/apt-repos/zulip/pgroonga-ppa.asc\n8f70beaa2b1b8621a156d140e6004367684f434f0978baa78e5f742ac3fb593a  scripts/lib/setup-apt-repo&#39;\n+ &#39;[&#39; &#39;1880c6337400b54a7e344d9c4a42ca11482709ab2641e5fd3aae85f01fd5ea5d  scripts/setup/apt-repos/zulip/custom.sh\n93d04e5e9e4e22c5d38e1dca1cf1bfc0fee36a79d7205c1397ad255f464bc09d  scripts/setup/apt-repos/zulip/focal.list\n0144068502a1eddd2a0280ede10ef607d1ec592ce819940991203941564e8e76  scripts/setup/apt-repos/zulip/pgdg.asc\n06f00f144d99826f27b8912c26d02dd4e0247f662666be5378740828d39c6a41  scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc\na133aa690de5fc1d46ca23a54bf6dd1c6468e8426e1ec9661f390e4f41a365d1  scripts/setup/apt-repos/zulip/pgroonga-ppa.asc\n8f70beaa2b1b8621a156d140e6004367684f434f0978baa78e5f742ac3fb593a  scripts/lib/setup-apt-repo&#39; = &#39;1880c6337400b54a7e344d9c4a42ca11482709ab2641e5fd3aae85f01fd5ea5d  scripts/setup/apt-repos/zulip/custom.sh\n93d04e5e9e4e22c5d38e1dca1cf1bfc0fee36a79d7205c1397ad255f464bc09d  scripts/setup/apt-repos/zulip/focal.list\n0144068502a1eddd2a0280ede10ef607d1ec592ce819940991203941564e8e76  scripts/setup/apt-repos/zulip/pgdg.asc\n06f00f144d99826f27b8912c26d02dd4e0247f662666be5378740828d39c6a41  scripts/setup/apt-repos/zulip/pgroonga-packages.groonga.org.asc\na133aa690de5fc1d46ca23a54bf6dd1c6468e8426e1ec9661f390e4f41a365d1  scripts/setup/apt-repos/zulip/pgroonga-ppa.asc\n8f70beaa2b1b8621a156d140e6004367684f434f0978baa78e5f742ac3fb593a  scripts/lib/setup-apt-repo&#39; &#39;]&#39;\n+ exit 0\n+ apt-get install -y postgresql-14\nReading package lists... Done\nBuilding dependency tree\nReading state information... Done\nThe following additional packages will be installed:\n  libllvm10\nThe following NEW packages will be installed:\n  libllvm10 postgresql-14\n0 upgraded, 2 newly installed, 0 to remove and 0 not upgraded.\nNeed to get 31.1 MB of archives.\nAfter this operation, 125 MB of additional disk space will be used.\nGet:1 http://de.archive.ubuntu.com/ubuntu focal/main amd64 libllvm10 amd64 1:10.0.0-4ubuntu1 [15.3 MB]\nGet:2 http://apt.postgresql.org/pub/repos/apt focal-pgdg/main amd64 postgresql-14 amd64 14.7-1.pgdg20.04+1 [15.8 MB]\nFetched 31.1 MB in 20s (1,583 kB/s)\nPreconfiguring packages ...\nSelecting previously unselected package libllvm10:amd64.\n(Reading database ... 136335 files and directories currently installed.)\nPreparing to unpack .../libllvm10_1%3a10.0.0-4ubuntu1_amd64.deb ...\nUnpacking libllvm10:amd64 (1:10.0.0-4ubuntu1) ...\nSelecting previously unselected package postgresql-14.\nPreparing to unpack .../postgresql-14_14.7-1.pgdg20.04+1_amd64.deb ...\nUnpacking postgresql-14 (14.7-1.pgdg20.04+1) ...\nSetting up libllvm10:amd64 (1:10.0.0-4ubuntu1) ...\nSetting up postgresql-14 (14.7-1.pgdg20.04+1) ...\nCreating new PostgreSQL cluster 14/main ...\n/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main --auth-local peer --auth-host scram-sha-256 --no-instructions\nThe files belonging to this database system will be owned by user &quot;postgres&quot;.\nThis user must also own the server process.\nThe database cluster will be initialized with locale &quot;en_US.UTF-8&quot;.\nThe default database encoding has accordingly been set to &quot;UTF8&quot;.\nThe default text search configuration will be set to &quot;english&quot;.\nData page checksums are disabled.\nfixing permissions on existing directory /var/lib/postgresql/14/main ... ok\ncreating subdirectories ... ok\nselecting dynamic shared memory implementation ... posix\nselecting default max_connections ... 100\nselecting default shared_buffers ... 128MB\nselecting default time zone ... Europe/Berlin\ncreating configuration files ... ok\nrunning bootstrap script ... ok\nperforming post-bootstrap initialization ... ok\nsyncing data to disk ... ok\nupdate-alternatives: using /usr/share/postgresql/14/man/man1/postmaster.1.gz to provide /usr/share/man/man1/postmaster.1.gz (postmaster.1.gz) in auto mode\nProcessing triggers for postgresql-common (248.pgdg20.04+1) ...\nBuilding PostgreSQL dictionaries from installed myspell/hunspell packages...\n  en_us\nRemoving obsolete dictionary files:\nProcessing triggers for libc-bin (2.31-0ubuntu9.9) ...\n+ grep -qE &#39;^14\\s+main\\b&#39;\n+ pg_lsclusters -h\n+ pg_dropcluster 14 main --stop\n++ mktemp -d\n+ TEMP_CONF_DIR=/tmp/tmp.tU0S3DqIZ9\n+ cp /etc/zulip/zulip.conf /tmp/tmp.tU0S3DqIZ9\n+ ZULIP_CONF=/tmp/tmp.tU0S3DqIZ9/zulip.conf\n+ crudini --set /tmp/tmp.tU0S3DqIZ9/zulip.conf postgresql version 14\n+ crudini --set /tmp/tmp.tU0S3DqIZ9/zulip.conf machine puppet_classes zulip::profile::base,zulip::postgresql_base\n+ touch /usr/share/postgresql/14/pgroonga_setup.sql.applied\n+ FACTER_LEAVE_SUPERVISOR=true\n+ /home/zulip/deployments/current/scripts/setup/../../scripts/zulip-puppet-apply -f --config /tmp/tmp.tU0S3DqIZ9/zulip.conf\nNotice: Compiled catalog for zulip.ixsys.de in environment production in 0.63 seconds\nNotice: /Stage[main]/Zulip::Postgresql_base/File[/usr/share/postgresql/14/tsearch_data/zulip_english.stop]/ensure: defined content as &#39;{md5}34e771a8f53b4ae2e8b43affd3f820b2&#39;\nNotice: Applied catalog in 0.79 seconds\n+ rm -rf /tmp/tmp.tU0S3DqIZ9\n++ mktemp /var/log/zulip/upgrade-postgresql-10-14.XXXXXXXXX.log\n+ UPGRADE_LOG=/var/log/zulip/upgrade-postgresql-10-14.UnjHTa7jk.log\n+ pg_upgradecluster -v 14 10 main --method=upgrade --link\n+ tee /var/log/zulip/upgrade-postgresql-10-14.UnjHTa7jk.log\nStopping old cluster...\nCreating new PostgreSQL cluster 14/main ...\n/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main --auth-local peer --auth-host scram-sha-256 --no-instructions --encoding UTF8 --lc-collate en_US.UTF-8 --lc-ctype en_US.UTF-8\nThe files belonging to this database system will be owned by user &quot;postgres&quot;.\nThis user must also own the server process.\n\nThe database cluster will be initialized with locale &quot;en_US.UTF-8&quot;.\nThe default text search configuration will be set to &quot;english&quot;.\n\nData page checksums are disabled.\n\nfixing permissions on existing directory /var/lib/postgresql/14/main ... ok\ncreating subdirectories ... ok\nselecting dynamic shared memory implementation ... posix\nselecting default max_connections ... 100\nselecting default shared_buffers ... 128MB\nselecting default time zone ... Europe/Berlin\ncreating configuration files ... ok\nrunning bootstrap script ... ok\nperforming post-bootstrap initialization ... ok\nsyncing data to disk ... ok\n\nCopying old configuration files...\nCopying old start.conf...\nCopying old pg_ctl.conf...\n/usr/lib/postgresql/14/bin/pg_upgrade -b /usr/lib/postgresql/10/bin -B /usr/lib/postgresql/14/bin -p 5432 -P 5433 -d /etc/postgresql/10/main -D /etc/postgresql/14/main --link\nFinding the real data directory for the source cluster      ok\nFinding the real data directory for the target cluster      2023-03-28 20:06:53.811 GMT [1785916] LOG:  could not open configuration directory &quot;/etc/postgresql/14/main/conf.d&quot;: No such file or directory\n2023-03-28 20:06:53.811 GMT [1785916] FATAL:  configuration file &quot;/etc/postgresql/14/main/postgresql.conf&quot; contains errors\n\ncould not get data directory using &quot;/usr/lib/postgresql/14/bin/postgres&quot; -D &quot;/etc/postgresql/14/main&quot; -C data_directory: No such file or directory\nFailure, exiting\nError: pg_upgrade run failed. Logfiles are in /var/log/postgresql/pg_upgradecluster-10-14-main.uLoD\nError during cluster dumping, removing new cluster\n</code></pre></div>\n<p>I have no clue which part of the process is expected to create that missing config directory (<code>puppet</code>, <code>pg_upgrade</code>?). I have searched the web for similar error cases but have found nothing useful. Do any of you have any ideas on how to fix this?</p>",
        "id": 1537176,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680166306
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>LOG:  could not open configuration directory &quot;/etc/postgresql/14/main/conf.d&quot;: No such file or directory\n</code></pre></div>\n<p>That directory should have been created when <code>postgresql-14</code> was installed.  You're not out of disk space, and this is a normal Ubuntu install?</p>\n<p><span class=\"user-mention\" data-user-id=\"16301\">@Harald Oest</span>: Can you show:</p>\n<div class=\"codehilite\"><pre><span></span><code>ls -al /etc/postgresql/14/main/\n</code></pre></div>",
        "id": 1537374,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680190228
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> , thx for your reply.<br>\nWell, that's the problem, the dir ist missing:</p>\n<div class=\"codehilite\"><pre><span></span><code>root@zulip:/home/maint# ls /etc/postgresql/\n10  9.3\n</code></pre></div>\n<p><code>postgres-14</code> ist installed:</p>\n<div class=\"codehilite\"><pre><span></span><code>root@zulip:/home/maint# dpkg -l|grep postgres\nii  check-postgres                        2.25.0-5.pgdg20.04+1              all          script for monitoring PostgreSQL databases\nii  postgresql-10                         10.23-1.pgdg20.04+1               amd64        The World&#39;s Most Advanced Open Source Relational Database\nii  postgresql-14                         14.7-1.pgdg20.04+1                amd64        The World&#39;s Most Advanced Open Source Relational Database\nii  postgresql-client                     15+248.pgdg20.04+1                all          front-end programs for PostgreSQL (supported version)\nii  postgresql-client-10                  10.23-1.pgdg20.04+1               amd64        front-end programs for PostgreSQL 10\nii  postgresql-client-14                  14.7-1.pgdg20.04+1                amd64        front-end programs for PostgreSQL 14\nii  postgresql-client-15                  15.2-1.pgdg20.04+1                amd64        front-end programs for PostgreSQL 15\nii  postgresql-client-common              248.pgdg20.04+1                   all          manager for multiple PostgreSQL client versions\nii  postgresql-common                     248.pgdg20.04+1                   all          PostgreSQL database-cluster manager\n</code></pre></div>\n<p>I assume, <code>/etc/postgres/14</code> should have been created by deb postinstall scripts? Since e.g. <code>dpkg -S /etc/postgresql/10/main/pg_hba.conf</code> yields no results.</p>",
        "id": 1537380,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680190653
    },
    {
        "content": "<p>Correct.  For instance:</p>\n<div class=\"codehilite\"><pre><span></span><code>root@alexmv-prod:~# ls /etc/postgresql\n12  14\nroot@alexmv-prod:~# apt-get install postgresql-15\nReading package lists... Done\nBuilding dependency tree\nReading state information... Done\nThe following packages were automatically installed and are no longer required:\n  libfwupdplugin1 libllvm9 libopts25 libstd-rust-1.57 libstd-rust-1.59 libstd-rust-1.61\n  libstd-rust-1.65 libstd-rust-dev libxmlb1 postgresql-client-12\nUse &#39;apt autoremove&#39; to remove them.\nThe following NEW packages will be installed:\n  postgresql-15\n0 upgraded, 1 newly installed, 0 to remove and 2 not upgraded.\nNeed to get 16.3 MB of archives.\nAfter this operation, 53.2 MB of additional disk space will be used.\nGet:1 http://apt.postgresql.org/pub/repos/apt focal-pgdg/main amd64 postgresql-15 amd64 15.2-1.pgdg20.04+1 [16.3 MB]\nFetched 16.3 MB in 2s (6708 kB/s)\nPreconfiguring packages ...\nSelecting previously unselected package postgresql-15.\n(Reading database ... 136424 files and directories currently installed.)\nPreparing to unpack .../postgresql-15_15.2-1.pgdg20.04+1_amd64.deb ...\nUnpacking postgresql-15 (15.2-1.pgdg20.04+1) ...\nSetting up postgresql-15 (15.2-1.pgdg20.04+1) ...\nCreating new PostgreSQL cluster 15/main ...\n/usr/lib/postgresql/15/bin/initdb -D /var/lib/postgresql/15/main --auth-local peer --auth-host scram-sha-256 --no-instructions\nThe files belonging to this database system will be owned by user &quot;postgres&quot;.\nThis user must also own the server process.\n\nThe database cluster will be initialized with locale &quot;C.UTF-8&quot;.\nThe default database encoding has accordingly been set to &quot;UTF8&quot;.\nThe default text search configuration will be set to &quot;english&quot;.\n\nData page checksums are disabled.\n\nfixing permissions on existing directory /var/lib/postgresql/15/main ... ok\ncreating subdirectories ... ok\nselecting dynamic shared memory implementation ... posix\nselecting default max_connections ... 100\nselecting default shared_buffers ... 128MB\nselecting default time zone ... Etc/UTC\ncreating configuration files ... ok\nrunning bootstrap script ... ok\nperforming post-bootstrap initialization ... ok\nsyncing data to disk ... ok\nupdate-alternatives: using /usr/share/postgresql/15/man/man1/postmaster.1.gz to provide /usr/share/man/man1/postmaster.1.gz (postmaster.1.gz) in auto mode\nProcessing triggers for postgresql-common (244.pgdg20.04+1) ...\nBuilding PostgreSQL dictionaries from installed myspell/hunspell packages...\n  en_us\nRemoving obsolete dictionary files:\nroot@alexmv-prod:~# ls /etc/postgresql\n12  14  15\n</code></pre></div>",
        "id": 1537386,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680190875
    },
    {
        "content": "<p>So if your system didn't make that, you can try uninstalling and re-installing <code>postgresql-14</code>.</p>",
        "id": 1537387,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680190912
    },
    {
        "content": "<p>But I see no reason from your output above that it wouldn't have been created.</p>",
        "id": 1537388,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680190956
    },
    {
        "content": "<p>I already tried <code>apt-get install --reinstall postgresql-14</code> but that does not help.</p>",
        "id": 1537389,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680190970
    },
    {
        "content": "<p>I assume this is a standard Ubuntu or Debian box, and you've checked your free disk space?</p>",
        "id": 1537390,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680191020
    },
    {
        "content": "<p>What does <code>pg_lsclusters</code> show?</p>",
        "id": 1537391,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680191072
    },
    {
        "content": "<p>Yes, Ubuntu 20.04, VM, upgraded from 18.04 longer time ago. Disk space is not a problem.</p>\n<div class=\"codehilite\"><pre><span></span><code>root@zulip:/home/maint# pg_lsclusters\nVer Cluster Port Status Owner    Data directory              Log file\n10  main    5432 online postgres /var/lib/postgresql/10/main /var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log\n</code></pre></div>",
        "id": 1537393,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680191179
    },
    {
        "content": "<p>You can try <code>pg_createcluster 14 main</code> and then re-running <code>upgrade-postgresql</code></p>",
        "id": 1537399,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680191449
    },
    {
        "content": "<p>But this is uncharted territory.  It might be more useful to spelunk the post-install scripts to see in what circumstances it makes an <code>/etc/postgresql/14</code></p>",
        "id": 1537401,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680191481
    },
    {
        "content": "<p>For me the relevant question is if the missing folder should have been created by postgres package or zulip deployment. Regarding your statements i assume it's a task of the deb package. Thus i try to extract the maintainer scripts from the package.</p>",
        "id": 1537403,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680191521
    },
    {
        "content": "<p>Yes, that directory is assumed to be created by the PostgreSQL package upon installation.</p>",
        "id": 1537404,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680191553
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> <a href=\"#narrow/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails/near/1537401\">said</a>:</p>\n<blockquote>\n<p>But this is uncharted territory.  It might be more useful to spelunk the post-install scripts to see in what circumstances it makes an <code>/etc/postgresql/14</code></p>\n</blockquote>\n<p>Yes, i give it a try...</p>",
        "id": 1537405,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680191565
    },
    {
        "content": "<p>Thank you so much for your help! I let you know the outcome.</p>",
        "id": 1537408,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680191603
    },
    {
        "content": "<p>Keep us posted!  If we shouldn't be assuming there's a <code>main</code> cluster after installation, then that's something that we can adjust the upgrader to handle.</p>",
        "id": 1537411,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680191694
    },
    {
        "content": "<p>Maybe it's a side effect of the OS dist-upgrade from 18.04 to 20.04. Although Debian/Ubuntu can usually be upgraded without major problems, I have experienced some strange effects with some packages over time.</p>",
        "id": 1537413,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680192073
    },
    {
        "content": "<p>FYI: the <code>postinst</code> script just calls <code>/usr/share/postgresql-common/maintscripts-functions</code>.</p>",
        "id": 1537415,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680192290
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> , i went brute force: <code>apt-get purge  postgresql-14</code> followed by <code>apt-get install  postgresql-14</code> (i forgot that <code>--reinstall</code> does not execute the maintainer scripts). Now <code>/etc/postgresql/14</code> exists. <br>\nNext i'll give <code>/home/zulip/deployments/current/scripts/setup/upgrade-postgresql</code> a try. But I can do that later because there are currently many active users on the zulip server instance.</p>",
        "id": 1537433,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680192696
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>configure_version<span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"nv\">VERSION</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$1</span><span class=\"s2\">\"</span>\n\n<span class=\"w\">    </span><span class=\"c1\"># Create a main cluster for given version ($1) if no cluster already exists</span>\n<span class=\"w\">    </span><span class=\"c1\"># for that version and we are installing from scratch.</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$VERSION</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"Error: configure_version: need version parameter\"</span><span class=\"w\"> </span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"nb\">exit</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>!<span class=\"w\"> </span>-d<span class=\"w\"> </span><span class=\"s2\">\"/etc/postgresql/</span><span class=\"nv\">$VERSION</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-z<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"k\">$(</span>ls<span class=\"w\"> </span>/etc/postgresql/<span class=\"nv\">$VERSION</span><span class=\"k\">)</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">       </span><span class=\"o\">[</span><span class=\"w\"> </span>-z<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"k\">$(</span>ls<span class=\"w\"> </span>/etc/postgresql/<span class=\"nv\">$VERSION</span>/*/postgresql.conf<span class=\"w\"> </span><span class=\"m\">2</span>&gt;/dev/null<span class=\"k\">)</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"c1\"># skip creating the main cluster when this is not the first install, or</span>\n<span class=\"w\">        </span><span class=\"c1\"># when explicitly disabled ($create is on/off/\"\")</span>\n<span class=\"w\">        </span><span class=\"nv\">create</span><span class=\"o\">=</span><span class=\"k\">$(</span>pg_conftool<span class=\"w\"> </span>/etc/postgresql-common/createcluster.conf<span class=\"w\"> </span>show<span class=\"w\"> </span>-bs<span class=\"w\"> </span>create_main_cluster<span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span>:<span class=\"k\">)</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>-z<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$2</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$create</span><span class=\"s2\">\"</span><span class=\"w\"> </span>!<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"off\"</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span>set_system_locale\n<span class=\"w\">            </span>pg_createcluster<span class=\"w\"> </span>-u<span class=\"w\"> </span>postgres<span class=\"w\"> </span>--no-status<span class=\"w\"> </span><span class=\"nv\">$VERSION</span><span class=\"w\"> </span>main<span class=\"w\"> </span><span class=\"o\">||</span>\n<span class=\"w\">                </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"Error: could not create default cluster. Please create it manually with</span>\n\n<span class=\"s2\">  pg_createcluster </span><span class=\"nv\">$VERSION</span><span class=\"s2\"> main --start</span>\n\n<span class=\"s2\">or a similar command (see 'man pg_createcluster').\"</span><span class=\"w\"> </span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">2</span>\n<span class=\"w\">        </span><span class=\"k\">fi</span>\n<span class=\"w\">    </span><span class=\"k\">fi</span>\n<span class=\"w\">    </span><span class=\"c1\"># ...</span>\n<span class=\"o\">}</span>\n</code></pre></div>",
        "id": 1537437,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680192785
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span>  well, now it becomes interesting:</p>\n<div class=\"codehilite\"><pre><span></span><code>root@zulip:/home/maint/tmp/DEBIAN# ls /etc/postgresql\n10  14  9.3\nroot@zulip:/home/maint# /home/zulip/deployments/current/scripts/setup/upgrade-postgresql\n\n[yadda yadda yadda]\n\nStopping old cluster...\nCreating new PostgreSQL cluster 14/main ...\n/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main --auth-local peer --auth-host scram-sha-256 --no-instructions --encoding UTF8 --lc-collate en_US.UTF-8 --lc-ctype en_US.UTF-8\nThe files belonging to this database system will be owned by user &quot;postgres&quot;.\nThis user must also own the server process.\n\nThe database cluster will be initialized with locale &quot;en_US.UTF-8&quot;.\nThe default text search configuration will be set to &quot;english&quot;.\n\nData page checksums are disabled.\n\nfixing permissions on existing directory /var/lib/postgresql/14/main ... ok\ncreating subdirectories ... ok\nselecting dynamic shared memory implementation ... posix\nselecting default max_connections ... 100\nselecting default shared_buffers ... 128MB\nselecting default time zone ... Europe/Berlin\ncreating configuration files ... ok\nrunning bootstrap script ... ok\nperforming post-bootstrap initialization ... ok\nsyncing data to disk ... ok\n\nCopying old configuration files...\nCopying old start.conf...\nCopying old pg_ctl.conf...\n/usr/lib/postgresql/14/bin/pg_upgrade -b /usr/lib/postgresql/10/bin -B /usr/lib/postgresql/14/bin -p 5432 -P 5433 -d /etc/postgresql/10/main -D /etc/postgresql/14/main --link\nFinding the real data directory for the source cluster      ok\nFinding the real data directory for the target cluster      2023-03-30 19:51:02.632 GMT [180143] LOG:  could not open configuration directory &quot;/etc/postgresql/14/main/conf.d&quot;: No such file or directory\n2023-03-30 19:51:02.632 GMT [180143] FATAL:  configuration file &quot;/etc/postgresql/14/main/postgresql.conf&quot; contains errors\nError: pg_upgrade run failed. Logfiles are in /var/log/postgresql/pg_upgradecluster-10-14-main.ODyw\n\ncould not get data directory using &quot;/usr/lib/postgresql/14/bin/postgres&quot; -D &quot;/etc/postgresql/14/main&quot; -C data_directory: No such file or directory\nFailure, exiting\nError during cluster dumping, removing new cluster\nCluster is not running.\nError: could not stop old cluster, please do that manually\n\nroot@zulip:/home/maint# ls /etc/postgresql\n10  9.3\n</code></pre></div>\n<p>Puzzled...</p>",
        "id": 1537750,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680206032
    },
    {
        "content": "<p>That looks like the same error as before.  Does the <code>conf.d</code> directory still not exist?</p>",
        "id": 1537752,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1680206122
    },
    {
        "content": "<p>See the beginning of the log snippet above. <code>/etc/postgresql/14/</code> definitely existed before running the update script.</p>",
        "id": 1537754,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680206204
    },
    {
        "content": "<p>Mhh, in the process i see this being executed:</p>\n<div class=\"codehilite\"><pre><span></span><code>[...]\n+ apt-get install -y postgresql-14\nReading package lists... Done\nBuilding dependency tree\nReading state information... Done\npostgresql-14 is already the newest version (14.7-1.pgdg20.04+1).\n0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\n+ pg_lsclusters -h\n+ grep -qE &#39;^14\\s+main\\b&#39;\n+ pg_dropcluster 14 main --stop.     &lt;--- !!!\n++ mktemp -d\n[...]\n</code></pre></div>\n<p>According to <code>man pg_dropcluster</code> it \"<em>removes all files that belong to a given PostgreSQL cluster; that includes the data, wal, and tablespace directories, the log file, and all configuration files ... If the configuration directory (/etc/postgresql/version/cluster) is empty after this, it is removed as well</em>\".</p>",
        "id": 1537769,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680206638
    },
    {
        "content": "<p>Seems like this part of <code>upgrade-postgresql</code> is doing this:</p>\n<div class=\"codehilite\"><pre><span></span><code>if pg_lsclusters -h | grep -qE &quot;^$UPGRADE_TO\\s+main\\b&quot;; then\n    pg_dropcluster &quot;$UPGRADE_TO&quot; main --stop\nfi\n</code></pre></div>",
        "id": 1537776,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680206853
    },
    {
        "content": "<p>But i don't understand why since the condition renders to <code>false</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code>root@zulip:/home/maint# pg_lsclusters -h\n10 main 5432 online postgres /var/lib/postgresql/10/main /var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log\nroot@zulip:/home/maint# pg_lsclusters -h | grep -qE &#39;^14\\s+main\\b&#39;\nroot@zulip:/home/maint# echo $?\n1\n</code></pre></div>",
        "id": 1537780,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680207042
    },
    {
        "content": "<p>Ok, funny, when the Debian package <code>postgresql-14</code> is installed it starts the <code>postgresql@14-main.service</code> immediately:</p>\n<div class=\"codehilite\"><pre><span></span><code>root@zulip:/home/maint# apt-get purge postgresql-14\n[...]\nroot@zulip:/home/maint# apt-get install postgresql-14\n[...]\nroot@zulip:/home/maint# systemctl --no-pager|grep postgres\n  postgresql.service                                                                  loaded    active exited    PostgreSQL RDBMS\n  postgresql@10-main.service                                                          loaded    active running   PostgreSQL Cluster 10-main\n  postgresql@14-main.service                                                          loaded    active running   PostgreSQL Cluster 14-main\nroot@zulip:/home/maint# pg_lsclusters -h\n10 main 5432 online postgres /var/lib/postgresql/10/main /var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log\n14 main 5433 online postgres /var/lib/postgresql/14/main /var/log/postgresql/postgresql-14-main.log\n</code></pre></div>\n<p>I'll try the same procedure again but will stop <code>postgresql-14</code> in advance.</p>",
        "id": 1537804,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680207629
    },
    {
        "content": "<p>The solution (at least on my system) is to create the config directory required by <code>pg_upgradecluster</code> manually: <code>mkdir -p /etc/postgresql/14/main/conf.d &amp;&amp; chown -R postgres:postgres /etc/postgresql/14</code>.</p>\n<p>To sum things up:</p>\n<ul>\n<li><code>/home/zulip/deployments/current/scripts/setup/upgrade-postgresql</code> installs <code>postgresql-14</code></li>\n<li>Package <code>postgresql-14</code> creates <code>/etc/postgresql/14</code> alongside all config files -and starts the service. This makes the version 14 cluster appear in the output of <code>pg_lsclusters -h</code></li>\n<li>In <code>upgrade-postgresql</code> the detection if a cluster of the target version already exists kicks in and <code>pg_dopcluster</code> removes the version 14 cluster, including the config directory <code>/etc/postgresql/14</code></li>\n<li><code>pg_upgradecluster</code> fails with the error which triggered this conversation</li>\n</ul>\n<p>Thus on my system the code in <code>upgrade-postgresql</code> needs to be like this to make <code>pg_upgradecluster</code> work:</p>\n<div class=\"codehilite\"><pre><span></span><code>if pg_lsclusters -h | grep -qE &quot;^$UPGRADE_TO\\s+main\\b&quot;; then\n    pg_dropcluster &quot;$UPGRADE_TO&quot; main --stop\n    mkdir -p /etc/postgresql/14/main/conf.d &amp;&amp; chown -R postgres:postgres /etc/postgresql/14\nfi\n</code></pre></div>",
        "id": 1537872,
        "sender_full_name": "Harald Oest",
        "timestamp": 1680212066
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"16301\">@Harald Oest</span>: I just got around to testing this myself on a clean install of 5.5 on Ubuntu 20.04 with PostgreSQL 10 -- and I can't replicate.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"16301\">Harald Oest</span> <a href=\"#narrow/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails/near/1537872\">said</a>:</p>\n<blockquote>\n<p>To sum things up:</p>\n<ul>\n<li><code>/home/zulip/deployments/current/scripts/setup/upgrade-postgresql</code> installs <code>postgresql-14</code></li>\n<li>Package <code>postgresql-14</code> creates <code>/etc/postgresql/14</code> alongside all config files -and starts the service. This makes the version 14 cluster appear in the output of <code>pg_lsclusters -h</code></li>\n<li>In <code>upgrade-postgresql</code> the detection if a cluster of the target version already exists kicks in and <code>pg_dopcluster</code> removes the version 14 cluster, including the config directory <code>/etc/postgresql/14</code></li>\n</ul>\n</blockquote>\n<p>I agree with all those points -- putting an <code>exit 0</code> right before the call to <code>pg_upfradecluster</code> shows:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">root@alexmv-testing-pg-upgrade:~# </span>dpkg<span class=\"w\"> </span>--get-selections<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>postgresql-1\n<span class=\"go\">check-postgres                  install</span>\n<span class=\"go\">postgresql-10                   install</span>\n<span class=\"go\">postgresql-14                   install</span>\n<span class=\"gp\">root@alexmv-testing-pg-upgrade:~# </span>pg_lsclusters\n<span class=\"go\">Ver Cluster Port Status Owner    Data directory              Log file</span>\n<span class=\"go\">10  main    5432 online postgres /var/lib/postgresql/10/main /var/log/postgresql/postgresql-%Y-%m-%d_%H%M%S.log</span>\n<span class=\"gp\">root@alexmv-testing-pg-upgrade:~# </span>ls<span class=\"w\"> </span>/etc/postgresql\n<span class=\"go\">10</span>\n</code></pre></div>\n<p>However, the first step of <code>pg_upgradecluster</code> is to create a <em>new</em> cluster -- from <a href=\"#narrow/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails/near/1537750\">your log</a>:</p>\n<div class=\"codehilite\"><pre><span></span><code>Stopping old cluster...\nCreating new PostgreSQL cluster 14/main ...\n</code></pre></div>\n<p>And creating that new cluster should create <code>/etc/postgresql/14/main/conf.d</code>.  Here's the command it runs for me (UID/GUID may vary), and the output and end state:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">root@alexmv-testing-pg-upgrade:~# </span>pg_createcluster<span class=\"w\"> </span>-u<span class=\"w\"> </span><span class=\"m\">119</span><span class=\"w\"> </span>-g<span class=\"w\"> </span><span class=\"m\">127</span><span class=\"w\"> </span>--socketdir<span class=\"w\"> </span>/var/run/postgresql<span class=\"w\"> </span>--port<span class=\"w\"> </span><span class=\"m\">5433</span><span class=\"w\"> </span>--no-status<span class=\"w\"> </span><span class=\"m\">14</span><span class=\"w\"> </span>main<span class=\"w\"> </span>--encoding<span class=\"w\"> </span>UTF8<span class=\"w\"> </span>--lc-collate<span class=\"w\"> </span>C.UTF-8<span class=\"w\"> </span>--lc-ctype<span class=\"w\"> </span>C.UTF-8\n<span class=\"go\">Creating new PostgreSQL cluster 14/main ...</span>\n<span class=\"go\">/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main --auth-local peer --auth-host scram-sha-256 --no-instructions --encoding UTF8 --lc-collate C.UTF-8 --lc-ctype C.UTF-8</span>\n<span class=\"go\">The files belonging to this database system will be owned by user \"postgres\".</span>\n<span class=\"go\">This user must also own the server process.</span>\n\n<span class=\"go\">The database cluster will be initialized with locale \"C.UTF-8\".</span>\n<span class=\"go\">The default text search configuration will be set to \"english\".</span>\n\n<span class=\"go\">Data page checksums are disabled.</span>\n\n<span class=\"go\">fixing permissions on existing directory /var/lib/postgresql/14/main ... ok</span>\n<span class=\"go\">creating subdirectories ... ok</span>\n<span class=\"go\">selecting dynamic shared memory implementation ... posix</span>\n<span class=\"go\">selecting default max_connections ... 100</span>\n<span class=\"go\">selecting default shared_buffers ... 128MB</span>\n<span class=\"go\">selecting default time zone ... Etc/UTC</span>\n<span class=\"go\">creating configuration files ... ok</span>\n<span class=\"go\">running bootstrap script ... ok</span>\n<span class=\"go\">performing post-bootstrap initialization ... ok</span>\n<span class=\"go\">syncing data to disk ... ok</span>\n<span class=\"gp\">root@alexmv-testing-pg-upgrade:~# </span>ls<span class=\"w\"> </span>/etc/postgresql\n<span class=\"go\">10  14</span>\n<span class=\"gp\">root@alexmv-testing-pg-upgrade:~# </span>ls<span class=\"w\"> </span>/etc/postgresql/14\n<span class=\"go\">main</span>\n<span class=\"gp\">root@alexmv-testing-pg-upgrade:~# </span>ls<span class=\"w\"> </span>/etc/postgresql/14/main/\n<span class=\"go\">conf.d  environment  pg_ctl.conf  pg_hba.conf  pg_ident.conf  postgresql.conf  start.conf</span>\n</code></pre></div>\n<p>In case it matters, this is with:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">root@alexmv-testing-pg-upgrade:~# </span>apt-cache<span class=\"w\"> </span>policy<span class=\"w\"> </span>postgresql-common\n<span class=\"go\">postgresql-common:</span>\n<span class=\"go\">  Installed: 248.pgdg20.04+1</span>\n<span class=\"go\">  Candidate: 248.pgdg20.04+1</span>\n<span class=\"go\">  Version table:</span>\n<span class=\"go\"> *** 248.pgdg20.04+1 500</span>\n<span class=\"go\">        500 http://apt.postgresql.org/pub/repos/apt focal-pgdg/main amd64 Packages</span>\n<span class=\"go\">        100 /var/lib/dpkg/status</span>\n<span class=\"go\">     214ubuntu0.1 500</span>\n<span class=\"go\">        500 http://mirrors.digitalocean.com/ubuntu focal-updates/main amd64 Packages</span>\n<span class=\"go\">        500 http://security.ubuntu.com/ubuntu focal-security/main amd64 Packages</span>\n<span class=\"go\">     214 500</span>\n<span class=\"go\">        500 http://mirrors.digitalocean.com/ubuntu focal/main amd64 Packages</span>\n</code></pre></div>",
        "id": 1549233,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681753760
    },
    {
        "content": "<p><code>pg_createcluster</code> has this code in it:</p>\n<div class=\"codehilite\" data-code-language=\"Perl\"><pre><span></span><code><span class=\"c1\"># read defaults from /etc/postgresql-common/createcluster.conf</span>\n<span class=\"nv\">%defaultconf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nn\">PgCommon::</span><span class=\"n\">read_conf_file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">$createclusterconf</span><span class=\"p\">);</span>\n\n<span class=\"c1\"># ...</span>\n\n<span class=\"c1\"># handle other createcluster.conf parameters, including --pgoption parameters</span>\n<span class=\"k\">foreach</span><span class=\"w\"> </span><span class=\"k\">my</span><span class=\"w\"> </span><span class=\"nv\">$guc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nb\">sort</span><span class=\"w\"> </span><span class=\"nb\">keys</span><span class=\"w\"> </span><span class=\"nv\">%defaultconf</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">next</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nv\">$guc</span><span class=\"w\"> </span><span class=\"o\">=~</span><span class=\"sr\"> /^(create_main_cluster|start_conf|data_directory|waldir|xlogdir|initdb_options|ssl)$/</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">next</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nv\">$guc</span><span class=\"w\"> </span><span class=\"ow\">eq</span><span class=\"w\"> </span><span class=\"s\">'logging_collector'</span><span class=\"w\"> </span><span class=\"ow\">and</span><span class=\"w\"> </span><span class=\"nv\">$version</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">8.3</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">next</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nv\">$guc</span><span class=\"w\"> </span><span class=\"ow\">eq</span><span class=\"w\"> </span><span class=\"s\">'cluster_name'</span><span class=\"w\"> </span><span class=\"ow\">and</span><span class=\"w\"> </span><span class=\"nv\">$version</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">9.5</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">my</span><span class=\"w\"> </span><span class=\"nv\">$val</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">replace_v_c</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">$defaultconf</span><span class=\"p\">{</span><span class=\"nv\">$guc</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"nv\">$version</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">$cluster</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"nv\">$guc</span><span class=\"w\"> </span><span class=\"o\">=~</span><span class=\"w\"> </span><span class=\"sr\">s/^add_include/include/</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\"># remove harness from include directives in createcluster.conf</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">$guc</span><span class=\"w\"> </span><span class=\"ow\">eq</span><span class=\"w\"> </span><span class=\"s\">'include_dir'</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">next</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">$version</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">9.3</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">$val</span><span class=\"w\"> </span><span class=\"o\">=~</span><span class=\"sr\"> /^[\\w.]+$/</span><span class=\"w\"> </span><span class=\"ow\">and</span><span class=\"w\"> </span><span class=\"ow\">not</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"s\">\"$confdir/$val\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"c1\"># create directory relative to new config directory</span>\n<span class=\"w\">            </span><span class=\"nb\">mkdir</span><span class=\"w\"> </span><span class=\"s\">\"$confdir/$val\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mo\">0755</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"n\">lchown</span><span class=\"w\"> </span><span class=\"nv\">$owneruid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">$ownergid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"$confdir/$val\"</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"nn\">PgCommon::</span><span class=\"n\">set_conf_value</span><span class=\"w\"> </span><span class=\"nv\">$version</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">$cluster</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'postgresql.conf'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">$guc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">$val</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>...which reads <code>/etc/postgresql-common/createcluster.conf</code> and based on that sets up <code>postgresql.conf</code> and <em>also</em> makes the empty <code>conf.d</code> directory.</p>\n<p>Can you show the contents of <code>/etc/postgresql-common/createcluster.conf</code> ?</p>",
        "id": 1549239,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681753944
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> , sure:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>root@zulip:/home/maint#<span class=\"w\"> </span>cat<span class=\"w\"> </span>/etc/postgresql-common/createcluster.conf\n<span class=\"c1\"># Default values for pg_createcluster(8)</span>\n\n<span class=\"c1\"># Create a \"main\" cluster when a new postgresql-x.y server package is installed</span>\n<span class=\"c1\">#create_main_cluster = true</span>\n\n<span class=\"c1\"># Default start.conf value, must be one of \"auto\", \"manual\", and \"disabled\".</span>\n<span class=\"c1\"># See pg_createcluster(8) for more documentation.</span>\n<span class=\"c1\">#start_conf = 'auto'</span>\n\n<span class=\"c1\"># In the following options, occurrences of '%v' are replaced by the major</span>\n<span class=\"c1\"># version number, and '%c' by the cluster name. Use '%%' for a literal '%'.</span>\n\n<span class=\"c1\"># Default data directory.</span>\n<span class=\"c1\">#data_directory = '/var/lib/postgresql/%v/%c'</span>\n\n<span class=\"c1\"># Default directory for transaction logs</span>\n<span class=\"c1\"># Unset by default, i.e. pg_xlog remains in the data directory.</span>\n<span class=\"c1\">#xlogdir = '/var/lib/postgresql/xlog/%v/%c/pg_xlog'</span>\n\n<span class=\"c1\"># Options to pass to initdb.</span>\n<span class=\"c1\">#initdb_options = ''</span>\n\n<span class=\"c1\"># All other options are copied into the new cluster's postgresql.conf</span>\n\n<span class=\"nv\">log_line_prefix</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'%%t '</span>\n</code></pre></div>",
        "id": 1549323,
        "sender_full_name": "Harald Oest",
        "timestamp": 1681756793
    },
    {
        "content": "<p>OK, that looks like the problem.  So that means that <code>pg_createcluster</code> doesn't make the <code>conf.d</code> and <code>pg_upgradecluster</code> copies over the old cluster's config which <em>does</em> have a <code>include 'conf.d'</code> line in it, which means the new cluster fails to start.</p>",
        "id": 1549325,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681756960
    },
    {
        "content": "<p>I don't know how you got that non-default <code>createcluster.conf</code>, but that's the proximal cause.</p>",
        "id": 1549326,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681757002
    },
    {
        "content": "<p>We can attempt to paper over this, but it's fundamentally a <code>pg_upgradecluster</code> problem -- running <code>pg_upgradecluster</code> with that config, without any Zulip involvement, would also fail.</p>",
        "id": 1549327,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681757049
    },
    {
        "content": "<p>What does <code>apt-cache policy postgresql-common</code> show?</p>",
        "id": 1549328,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681757077
    },
    {
        "content": "<p>TBH i don't understand yet. What's the (correct) content of <code>createcluster.conf</code> on your system?</p>",
        "id": 1549330,
        "sender_full_name": "Harald Oest",
        "timestamp": 1681757142
    },
    {
        "content": "<p>Oh!  Sorry for not including that:</p>\n<div class=\"codehilite\"><pre><span></span><code>root@alexmv-testing-pg-upgrade:~# cat /etc/postgresql-common/createcluster.conf\n# Default values for pg_createcluster(8)\n# Occurrences of &#39;%v&#39; are replaced by the major version number,\n# and &#39;%c&#39; by the cluster name. Use &#39;%%&#39; for a literal &#39;%&#39;.\n\n# Create a &quot;main&quot; cluster when a new postgresql-x.y server package is installed\n#create_main_cluster = true\n\n# Default start.conf value, must be one of &quot;auto&quot;, &quot;manual&quot;, and &quot;disabled&quot;.\n# See pg_createcluster(8) for more documentation.\n#start_conf = &#39;auto&#39;\n\n# Default data directory.\n#data_directory = &#39;/var/lib/postgresql/%v/%c&#39;\n\n# Default directory for transaction logs\n# Unset by default, i.e. transaction logs remain in the data directory.\n#waldir = &#39;/var/lib/postgresql/wal/%v/%c/pg_wal&#39;\n\n# Options to pass to initdb.\n#initdb_options = &#39;&#39;\n\n# The following options are copied into the new cluster&#39;s postgresql.conf:\n\n# Enable SSL by default (using the &quot;snakeoil&quot; certificates installed by the\n# ssl-cert package, unless configured otherwise here)\nssl = on\n\n# Show cluster name in process title\ncluster_name = &#39;%v/%c&#39;\n\n# Put stats_temp_directory on tmpfs (PG &lt;= 14)\nstats_temp_directory = &#39;/var/run/postgresql/%v-%c.pg_stat_tmp&#39;\n\n# Add prefix to log lines\nlog_line_prefix = &#39;%%m [%%p] %%q%%u@%%d &#39;\n\n# Add &quot;include_dir&quot; in postgresql.conf\nadd_include_dir = &#39;conf.d&#39;\n\n# Directory for additional createcluster config\ninclude_dir &#39;/etc/postgresql-common/createcluster.d&#39;\n</code></pre></div>",
        "id": 1549332,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681757184
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> <a href=\"#narrow/stream/31-production-help/topic/Upgrading.20postgresql.2010.20to.2014.20fails/near/1549328\">said</a>:</p>\n<blockquote>\n<p>What does <code>apt-cache policy postgresql-common</code> show?</p>\n</blockquote>\n<p>Here we go:</p>\n<div class=\"codehilite\"><pre><span></span><code>root@zulip:/home/maint# apt-cache policy postgresql-common\npostgresql-common:\n  Installed: 248.pgdg20.04+1\n  Candidate: 248.pgdg20.04+1\n  Version table:\n *** 248.pgdg20.04+1 500\n        500 http://apt.postgresql.org/pub/repos/apt focal-pgdg/main amd64 Packages\n        100 /var/lib/dpkg/status\n     214ubuntu0.1 500\n        500 http://de.archive.ubuntu.com/ubuntu focal-updates/main amd64 Packages\n        500 http://de.archive.ubuntu.com/ubuntu focal-updates/main i386 Packages\n        500 http://security.ubuntu.com/ubuntu focal-security/main amd64 Packages\n        500 http://security.ubuntu.com/ubuntu focal-security/main i386 Packages\n     214 500\n        500 http://de.archive.ubuntu.com/ubuntu focal/main amd64 Packages\n        500 http://de.archive.ubuntu.com/ubuntu focal/main i386 Packages\n</code></pre></div>",
        "id": 1549333,
        "sender_full_name": "Harald Oest",
        "timestamp": 1681757201
    },
    {
        "content": "<p>The important line is:</p>\n<div class=\"codehilite\"><pre><span></span><code>add_include_dir = &#39;conf.d&#39;\n</code></pre></div>",
        "id": 1549335,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681757236
    },
    {
        "content": "<p>Hm, OK.  So presumably your <code>createcluster.conf</code> is left over from a very old version of PostgreSQL?  I'm assuming you don't remember making any manual changes to it?</p>",
        "id": 1549339,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681757287
    },
    {
        "content": "<p>For that i'm sure, no manual changes. But as i mentioned at the beginning of this thread, it's an upgraded system. Strange things can happen with Ubuntu upgrades.</p>",
        "id": 1549347,
        "sender_full_name": "Harald Oest",
        "timestamp": 1681757428
    },
    {
        "content": "<p>Yeah.</p>\n<p>I wonder if we should just detect a lack of <code>add_include_dir</code> in <code>/etc/postgresql-common/createcluster.conf</code> and error out, because the upgrade won't work?  This seems like a very niche corner case, and I'm worried about side effects from doing things like making <code>/etc/postgresql/14/main</code> before <code>pg_createcluster 14 main</code> is called.</p>",
        "id": 1549408,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1681760846
    },
    {
        "content": "<p>I think adding such a check and erroring out would be a reasonable thing to do here, though I don't know whether it's worth the effort when we've only seen this once.</p>",
        "id": 1576152,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1684966669
    },
    {
        "content": "<p>I think it's probably reasonable to close <a href=\"https://github.com/zulip/zulip/pull/24908\">#24908</a> as resolved and move on, but I'd merge a PR to add such a check if <span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> thinks it's worth the time to write it.</p>",
        "id": 1576154,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1684966726
    },
    {
        "content": "<p>Yeah, I don't think this is worth generalizing.</p>",
        "id": 1577895,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1685134068
    }
]