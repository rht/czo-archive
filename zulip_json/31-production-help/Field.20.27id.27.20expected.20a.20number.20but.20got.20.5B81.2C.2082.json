[
    {
        "content": "<p>Hi, since upgrading to master 4.0-dev-2101-gccf520ff13 on febr 4, we have occasionally received these errors at 18:00 sharp: \"[Django] zulip: Field 'id' expected a number but got [81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 95, 96, 97, 98, 99, 100, 101, 102, 103].</p>\n<p>Searching here and github, yields no results. The fact that they come at 18:00...perhaps something cron related..?</p>\n<p>Below is the full email that is sent:</p>\n<div class=\"codehilite\"><pre><span></span><code>Logger root, from module zerver.worker.queue_processors line 321:\nError generated by Anonymous user (not logged in) on zulip deployment\n\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/fields/__init__.py&quot;, line 1774, in get_prep_value\n    return int(value)\nTypeError: int() argument must be a string, a bytes-like object or a number, not &#39;list&#39;\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zerver/worker/queue_processors.py&quot;, line 269, in do_consume\n    consume_func(events)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zerver/worker/queue_processors.py&quot;, line 306, in &lt;lambda&gt;\n    consume_func = lambda events: self.consume(events[0])\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zerver/worker/queue_processors.py&quot;, line 621, in consume\n    bulk_handle_digest_email(user_ids, event[&quot;cutoff&quot;])\n  File &quot;/usr/lib/python3.7/contextlib.py&quot;, line 74, in inner\n    return func(*args, **kwds)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zerver/lib/digest.py&quot;, line 327, in bulk_handle_digest_email\n    users = UserProfile.objects.filter(id__in=user_ids).order_by(&quot;id&quot;).select_related(&quot;realm&quot;)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/manager.py&quot;, line 85, in manager_method\n    return getattr(self.get_queryset(), name)(*args, **kwargs)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/query.py&quot;, line 942, in filter\n    return self._filter_or_exclude(False, *args, **kwargs)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/query.py&quot;, line 962, in _filter_or_exclude\n    clone._filter_or_exclude_inplace(negate, *args, **kwargs)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/query.py&quot;, line 969, in _filter_or_exclude_inplace\n    self._query.add_q(Q(*args, **kwargs))\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/sql/query.py&quot;, line 1358, in add_q\n    clause, _ = self._add_q(q_object, self.used_aliases)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/sql/query.py&quot;, line 1380, in _add_q\n    split_subq=split_subq, check_filterable=check_filterable,\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/sql/query.py&quot;, line 1319, in build_filter\n    condition = self.build_lookup(lookups, col, value)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/sql/query.py&quot;, line 1165, in build_lookup\n    lookup = lookup_class(lhs, rhs)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/lookups.py&quot;, line 24, in __init__\n    self.rhs = self.get_prep_lookup()\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/lookups.py&quot;, line 227, in get_prep_lookup\n    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n  File &quot;/home/zulip/deployments/2021-02-04-11-21-29/zulip-py3-venv/lib/python3.7/site-packages/django/db/models/fields/__init__.py&quot;, line 1778, in get_prep_value\n    ) from e\nTypeError: Field &#39;id&#39; expected a number but got [81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 95, 96, 97, 98, 99, 100, 101, 102, 103].\n\n\nDeployed code:\n- git: 4.0-dev-2101-gccf520ff13\n- ZULIP_VERSION: 4.0-dev-2101-gccf520ff13\n\n\nRequest info: none\n</code></pre></div>\n<p>Anyone with an idea what to do?  Should I simply try upgrading to todays most recent master?</p>",
        "id": 1119193,
        "sender_full_name": "mouk",
        "timestamp": 1613502846
    },
    {
        "content": "<p>This is fixed by <a href=\"https://github.com/zulip/zulip/commit/d0f0c2f2ed35d4265961eaa21d9d38e18d85d28f\">d0f0c2f2ed35d4265961eaa21d9d38e18d85d28f</a></p>",
        "id": 1119194,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1613503057
    },
    {
        "content": "<p>So please try upgrading to latest <code>master</code> and see if that fixes it.</p>",
        "id": 1119195,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1613503107
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> Thanks! Will do.</p>",
        "id": 1119217,
        "sender_full_name": "mouk",
        "timestamp": 1613505591
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span>  I read that without this fix, digests are not sent. Is there a way to re-try sending them, or are they simply lost..?</p>",
        "id": 1119219,
        "sender_full_name": "mouk",
        "timestamp": 1613505935
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"16223\">@mouk</span> that's correct; you can likely run <code>zerver/management/commands/enqueue_digest_emails.py</code> (aka <code>./manage.py enqueue_digest_emails</code>) by hand; if you're running it days after the original time, you may want to temporarily replace DIGEST_CUTOFF with a larger number of days.</p>",
        "id": 1119278,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1613514736
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> Thanks for the really fantastic support we receive here! I have looked, but not sure where to define DIGEST_CUTOFF. Should I simply add it to our settings.py?</p>",
        "id": 1119555,
        "sender_full_name": "mouk",
        "timestamp": 1613553299
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"16223\">@mouk</span> I think it's in <code>zerver/lib/digest.py</code>:34</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">DIGEST_CUTOFF</span> <span class=\"o\">=</span> <span class=\"mi\">5</span>\n</code></pre></div>",
        "id": 1119558,
        "sender_full_name": "Ganesh Pawar (ganpa3)",
        "timestamp": 1613554753
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"17967\">@Ganesh Pawar (ganpa3)</span>  Thank you, I just found it myself with grep as well. Thanks!</p>",
        "id": 1119569,
        "sender_full_name": "mouk",
        "timestamp": 1613556077
    }
]