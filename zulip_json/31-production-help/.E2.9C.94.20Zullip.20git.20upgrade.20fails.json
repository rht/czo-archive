[
    {
        "content": "<p>Here is the full log: <a href=\"https://pastebin.com/pbu1Umnj\">https://pastebin.com/pbu1Umnj</a> . Tried several times, same results.</p>",
        "id": 1449510,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665709852
    },
    {
        "content": "<p>To save folks a click, the relevant section is:</p>\n<div class=\"codehilite\"><pre><span></span><code>Running migrations:\n  Applying zerver.0420_alter_archivedmessage_realm_alter_message_realm...Traceback (most recent call last):\n  File &quot;/srv/zulip-venv-cache/4cb7e7f76b9747af6e3d88a027e730e8d0dedf5d/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/utils.py&quot;, line 89, in _execute\n    return self.cursor.execute(sql, params)\n  File &quot;/home/zulip/deployments/2022-10-14-00-56-27/zerver/lib/db.py&quot;, line 34, in execute\n    wrapper_execute(self, super().execute, query, vars)\n  File &quot;/home/zulip/deployments/2022-10-14-00-56-27/zerver/lib/db.py&quot;, line 19, in wrapper_execute\n    action(sql, params)\npsycopg2.errors.NotNullViolation: column &quot;realm_id&quot; of relation &quot;zerver_message&quot; contains null values\n</code></pre></div>",
        "id": 1449516,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1665711012
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> as a possible 6.0 blocker -- and I don't know if your recent experience with this migration is relevant.</p>\n<p>So it looks like something in the 0419 upgrade step failed to set a <code>realm_id</code> for one or more messages?</p>",
        "id": 1449799,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1665761099
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> <a href=\"#narrow/stream/31-production-help/topic/Zullip.20git.20upgrade.20fails/near/1449799\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"7\">Tim Abbott</span> as a possible 6.0 blocker -- and I don't know if your recent experience with this migration is relevant.</p>\n<p>So it looks like something in the 0419 upgrade step failed to set a <code>realm_id</code> for one or more messages?</p>\n</blockquote>\n<p>Yeah, I think so</p>",
        "id": 1449843,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665764704
    },
    {
        "content": "<p>Let's debug what the message is and go from there.</p>",
        "id": 1449844,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1665764760
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span> Can you run these in <code>manage.py shell</code>  to get an idea what kind of messages, and how many, are affected?</p>\n<div class=\"codehilite\"><pre><span></span><code>Message.objects.filter(realm=None).filter(recipient__type=Recipient.PERSONAL).count()\nMessage.objects.filter(realm=None).filter(recipient__type=Recipient.STREAM).count()\nMessage.objects.filter(realm=None).filter(recipient__type=Recipient.HUDDLE).count()\n</code></pre></div>",
        "id": 1449845,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665764762
    },
    {
        "content": "<p>The user should be able to start the server while we do so BTW.</p>",
        "id": 1449846,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1665764775
    },
    {
        "content": "<p>Though maybe a manual puppet apply is required? I am not sure whether that runs after migrations.</p>",
        "id": 1449847,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1665764796
    },
    {
        "content": "<p>Sure <span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span>  give me 5 mins to finish a task, will look into that</p>",
        "id": 1449850,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665764952
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span>  it is true I was able to start the server, was not fatal issue to cause downtime, only could not manage to pass the upgrade.</p>",
        "id": 1449853,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665765026
    },
    {
        "content": "<p>Here is the output: </p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]:</span> <span class=\"n\">Message</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">realm</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">recipient__type</span><span class=\"o\">=</span><span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">PERSONAL</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span> <span class=\"n\">Message</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">realm</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">recipient__type</span><span class=\"o\">=</span><span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">STREAM</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span> <span class=\"n\">Message</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">realm</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">recipient__type</span><span class=\"o\">=</span><span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">HUDDLE</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n   <span class=\"o\">...</span><span class=\"p\">:</span>\n<span class=\"o\">---------------------------------------------------------------------------</span>\n<span class=\"n\">FieldError</span>                                <span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">)</span>\n<span class=\"n\">Input</span> <span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"ow\">in</span> <span class=\"o\">&lt;</span><span class=\"n\">cell</span> <span class=\"n\">line</span><span class=\"p\">:</span> <span class=\"mi\">1</span><span class=\"o\">&gt;</span><span class=\"p\">()</span>\n<span class=\"o\">----&gt;</span> <span class=\"mi\">1</span> <span class=\"n\">Message</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">realm</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">recipient__type</span><span class=\"o\">=</span><span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">PERSONAL</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n      <span class=\"mi\">2</span> <span class=\"n\">Message</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">realm</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">recipient__type</span><span class=\"o\">=</span><span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">STREAM</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n      <span class=\"mi\">3</span> <span class=\"n\">Message</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">realm</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">recipient__type</span><span class=\"o\">=</span><span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">HUDDLE</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">85</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">BaseManager</span><span class=\"o\">.</span><span class=\"n\">_get_queryset_methods</span><span class=\"o\">.&lt;</span><span class=\"nb\">locals</span><span class=\"o\">&gt;.</span><span class=\"n\">create_method</span><span class=\"o\">.&lt;</span><span class=\"nb\">locals</span><span class=\"o\">&gt;.</span><span class=\"n\">manager_method</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n     <span class=\"mi\">84</span> <span class=\"k\">def</span> <span class=\"nf\">manager_method</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">85</span>     <span class=\"k\">return</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">(),</span> <span class=\"n\">name</span><span class=\"p\">)(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">1071</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">QuerySet</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n   <span class=\"mi\">1066</span> <span class=\"s2\">\"\"\"</span>\n<span class=\"s2\">   1067 Return a new QuerySet instance with the args ANDed to the existing</span>\n<span class=\"s2\">   1068 set.</span>\n<span class=\"s2\">   1069 \"\"\"</span>\n   <span class=\"mi\">1070</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">\"filter\"</span><span class=\"p\">)</span>\n<span class=\"o\">-&gt;</span> <span class=\"mi\">1071</span> <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_filter_or_exclude</span><span class=\"p\">(</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">1089</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">QuerySet</span><span class=\"o\">.</span><span class=\"n\">_filter_or_exclude</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n   <span class=\"mi\">1087</span>     <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_deferred_filter</span> <span class=\"o\">=</span> <span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span>\n   <span class=\"mi\">1088</span> <span class=\"k\">else</span><span class=\"p\">:</span>\n<span class=\"o\">-&gt;</span> <span class=\"mi\">1089</span>     <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_filter_or_exclude_inplace</span><span class=\"p\">(</span><span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n   <span class=\"mi\">1090</span> <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">1096</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">QuerySet</span><span class=\"o\">.</span><span class=\"n\">_filter_or_exclude_inplace</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n   <span class=\"mi\">1094</span>     <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_query</span><span class=\"o\">.</span><span class=\"n\">add_q</span><span class=\"p\">(</span><span class=\"o\">~</span><span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">))</span>\n   <span class=\"mi\">1095</span> <span class=\"k\">else</span><span class=\"p\">:</span>\n<span class=\"o\">-&gt;</span> <span class=\"mi\">1096</span>     <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_query</span><span class=\"o\">.</span><span class=\"n\">add_q</span><span class=\"p\">(</span><span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">))</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">sql</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">1502</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">Query</span><span class=\"o\">.</span><span class=\"n\">add_q</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">q_object</span><span class=\"p\">)</span>\n   <span class=\"mi\">1493</span> <span class=\"c1\"># For join promotion this case is doing an AND for the added q_object</span>\n   <span class=\"mi\">1494</span> <span class=\"c1\"># and existing conditions. So, any existing inner join forces the join</span>\n   <span class=\"mi\">1495</span> <span class=\"c1\"># type to remain inner. Existing outer joins can however be demoted.</span>\n   <span class=\"mi\">1496</span> <span class=\"c1\"># (Consider case where rel_a is LOUTER and rel_a__col=1 is added - if</span>\n   <span class=\"mi\">1497</span> <span class=\"c1\"># rel_a doesn't produce any rows, then the whole condition must fail.</span>\n   <span class=\"mi\">1498</span> <span class=\"c1\"># So, demotion is OK.</span>\n   <span class=\"mi\">1499</span> <span class=\"n\">existing_inner</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n   <span class=\"mi\">1500</span>     <span class=\"n\">a</span> <span class=\"k\">for</span> <span class=\"n\">a</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">alias_map</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">alias_map</span><span class=\"p\">[</span><span class=\"n\">a</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">join_type</span> <span class=\"o\">==</span> <span class=\"n\">INNER</span>\n   <span class=\"mi\">1501</span> <span class=\"p\">}</span>\n<span class=\"o\">-&gt;</span> <span class=\"mi\">1502</span> <span class=\"n\">clause</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_add_q</span><span class=\"p\">(</span><span class=\"n\">q_object</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">used_aliases</span><span class=\"p\">)</span>\n   <span class=\"mi\">1503</span> <span class=\"k\">if</span> <span class=\"n\">clause</span><span class=\"p\">:</span>\n   <span class=\"mi\">1504</span>     <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">clause</span><span class=\"p\">,</span> <span class=\"n\">AND</span><span class=\"p\">)</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">sql</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">1532</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">Query</span><span class=\"o\">.</span><span class=\"n\">_add_q</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">q_object</span><span class=\"p\">,</span> <span class=\"n\">used_aliases</span><span class=\"p\">,</span> <span class=\"n\">branch_negated</span><span class=\"p\">,</span> <span class=\"n\">current_negated</span><span class=\"p\">,</span> <span class=\"n\">allow_joins</span><span class=\"p\">,</span> <span class=\"n\">split_subq</span><span class=\"p\">,</span> <span class=\"n\">check_filterable</span><span class=\"p\">)</span>\n   <span class=\"mi\">1528</span> <span class=\"n\">joinpromoter</span> <span class=\"o\">=</span> <span class=\"n\">JoinPromoter</span><span class=\"p\">(</span>\n   <span class=\"mi\">1529</span>     <span class=\"n\">q_object</span><span class=\"o\">.</span><span class=\"n\">connector</span><span class=\"p\">,</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">q_object</span><span class=\"o\">.</span><span class=\"n\">children</span><span class=\"p\">),</span> <span class=\"n\">current_negated</span>\n   <span class=\"mi\">1530</span> <span class=\"p\">)</span>\n   <span class=\"mi\">1531</span> <span class=\"k\">for</span> <span class=\"n\">child</span> <span class=\"ow\">in</span> <span class=\"n\">q_object</span><span class=\"o\">.</span><span class=\"n\">children</span><span class=\"p\">:</span>\n<span class=\"o\">-&gt;</span> <span class=\"mi\">1532</span>     <span class=\"n\">child_clause</span><span class=\"p\">,</span> <span class=\"n\">needed_inner</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">build_filter</span><span class=\"p\">(</span>\n   <span class=\"mi\">1533</span>         <span class=\"n\">child</span><span class=\"p\">,</span>\n   <span class=\"mi\">1534</span>         <span class=\"n\">can_reuse</span><span class=\"o\">=</span><span class=\"n\">used_aliases</span><span class=\"p\">,</span>\n   <span class=\"mi\">1535</span>         <span class=\"n\">branch_negated</span><span class=\"o\">=</span><span class=\"n\">branch_negated</span><span class=\"p\">,</span>\n   <span class=\"mi\">1536</span>         <span class=\"n\">current_negated</span><span class=\"o\">=</span><span class=\"n\">current_negated</span><span class=\"p\">,</span>\n   <span class=\"mi\">1537</span>         <span class=\"n\">allow_joins</span><span class=\"o\">=</span><span class=\"n\">allow_joins</span><span class=\"p\">,</span>\n   <span class=\"mi\">1538</span>         <span class=\"n\">split_subq</span><span class=\"o\">=</span><span class=\"n\">split_subq</span><span class=\"p\">,</span>\n   <span class=\"mi\">1539</span>         <span class=\"n\">check_filterable</span><span class=\"o\">=</span><span class=\"n\">check_filterable</span><span class=\"p\">,</span>\n   <span class=\"mi\">1540</span>     <span class=\"p\">)</span>\n   <span class=\"mi\">1541</span>     <span class=\"n\">joinpromoter</span><span class=\"o\">.</span><span class=\"n\">add_votes</span><span class=\"p\">(</span><span class=\"n\">needed_inner</span><span class=\"p\">)</span>\n   <span class=\"mi\">1542</span>     <span class=\"k\">if</span> <span class=\"n\">child_clause</span><span class=\"p\">:</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">sql</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">1377</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">Query</span><span class=\"o\">.</span><span class=\"n\">build_filter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filter_expr</span><span class=\"p\">,</span> <span class=\"n\">branch_negated</span><span class=\"p\">,</span> <span class=\"n\">current_negated</span><span class=\"p\">,</span> <span class=\"n\">can_reuse</span><span class=\"p\">,</span> <span class=\"n\">allow_joins</span><span class=\"p\">,</span> <span class=\"n\">split_subq</span><span class=\"p\">,</span> <span class=\"n\">reuse_with_filtered_relation</span><span class=\"p\">,</span> <span class=\"n\">check_filterable</span><span class=\"p\">)</span>\n   <span class=\"mi\">1375</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">arg</span><span class=\"p\">:</span>\n   <span class=\"mi\">1376</span>     <span class=\"k\">raise</span> <span class=\"n\">FieldError</span><span class=\"p\">(</span><span class=\"s2\">\"Cannot parse keyword query </span><span class=\"si\">%r</span><span class=\"s2\">\"</span> <span class=\"o\">%</span> <span class=\"n\">arg</span><span class=\"p\">)</span>\n<span class=\"o\">-&gt;</span> <span class=\"mi\">1377</span> <span class=\"n\">lookups</span><span class=\"p\">,</span> <span class=\"n\">parts</span><span class=\"p\">,</span> <span class=\"n\">reffed_expression</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">solve_lookup_type</span><span class=\"p\">(</span><span class=\"n\">arg</span><span class=\"p\">)</span>\n   <span class=\"mi\">1379</span> <span class=\"k\">if</span> <span class=\"n\">check_filterable</span><span class=\"p\">:</span>\n   <span class=\"mi\">1380</span>     <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">check_filterable</span><span class=\"p\">(</span><span class=\"n\">reffed_expression</span><span class=\"p\">)</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">sql</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">1187</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">Query</span><span class=\"o\">.</span><span class=\"n\">solve_lookup_type</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">lookup</span><span class=\"p\">)</span>\n   <span class=\"mi\">1185</span>     <span class=\"k\">if</span> <span class=\"n\">expression</span><span class=\"p\">:</span>\n   <span class=\"mi\">1186</span>         <span class=\"k\">return</span> <span class=\"n\">expression_lookups</span><span class=\"p\">,</span> <span class=\"p\">(),</span> <span class=\"n\">expression</span>\n<span class=\"o\">-&gt;</span> <span class=\"mi\">1187</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">lookup_parts</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">names_to_path</span><span class=\"p\">(</span><span class=\"n\">lookup_splitted</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_meta</span><span class=\"p\">())</span>\n   <span class=\"mi\">1188</span> <span class=\"n\">field_parts</span> <span class=\"o\">=</span> <span class=\"n\">lookup_splitted</span><span class=\"p\">[</span><span class=\"mi\">0</span> <span class=\"p\">:</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">lookup_splitted</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">lookup_parts</span><span class=\"p\">)]</span>\n   <span class=\"mi\">1189</span> <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">lookup_parts</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">field_parts</span><span class=\"p\">:</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">sql</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">1677</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">Query</span><span class=\"o\">.</span><span class=\"n\">names_to_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">names</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"p\">,</span> <span class=\"n\">allow_many</span><span class=\"p\">,</span> <span class=\"n\">fail_on_missing</span><span class=\"p\">)</span>\n   <span class=\"mi\">1669</span>     <span class=\"k\">if</span> <span class=\"n\">pos</span> <span class=\"o\">==</span> <span class=\"o\">-</span><span class=\"mi\">1</span> <span class=\"ow\">or</span> <span class=\"n\">fail_on_missing</span><span class=\"p\">:</span>\n   <span class=\"mi\">1670</span>         <span class=\"n\">available</span> <span class=\"o\">=</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span>\n   <span class=\"mi\">1671</span>             <span class=\"p\">[</span>\n   <span class=\"mi\">1672</span>                 <span class=\"o\">*</span><span class=\"n\">get_field_names_from_opts</span><span class=\"p\">(</span><span class=\"n\">opts</span><span class=\"p\">),</span>\n   <span class=\"p\">(</span><span class=\"o\">...</span><span class=\"p\">)</span>\n   <span class=\"mi\">1675</span>             <span class=\"p\">]</span>\n   <span class=\"mi\">1676</span>         <span class=\"p\">)</span>\n<span class=\"o\">-&gt;</span> <span class=\"mi\">1677</span>         <span class=\"k\">raise</span> <span class=\"n\">FieldError</span><span class=\"p\">(</span>\n   <span class=\"mi\">1678</span>             <span class=\"s2\">\"Cannot resolve keyword '</span><span class=\"si\">%s</span><span class=\"s2\">' into field. \"</span>\n   <span class=\"mi\">1679</span>             <span class=\"s2\">\"Choices are: </span><span class=\"si\">%s</span><span class=\"s2\">\"</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"s2\">\", \"</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">available</span><span class=\"p\">))</span>\n   <span class=\"mi\">1680</span>         <span class=\"p\">)</span>\n   <span class=\"mi\">1681</span>     <span class=\"k\">break</span>\n   <span class=\"mi\">1682</span> <span class=\"c1\"># Check if we need any joins for concrete inheritance cases (the</span>\n   <span class=\"mi\">1683</span> <span class=\"c1\"># field lives in parent, but we are currently in one of its</span>\n   <span class=\"mi\">1684</span> <span class=\"c1\"># children)</span>\n\n<span class=\"n\">FieldError</span><span class=\"p\">:</span> <span class=\"n\">Cannot</span> <span class=\"n\">resolve</span> <span class=\"n\">keyword</span> <span class=\"s1\">'realm'</span> <span class=\"n\">into</span> <span class=\"n\">field</span><span class=\"o\">.</span> <span class=\"n\">Choices</span> <span class=\"n\">are</span><span class=\"p\">:</span> <span class=\"n\">attachment</span><span class=\"p\">,</span> <span class=\"n\">content</span><span class=\"p\">,</span> <span class=\"n\">date_sent</span><span class=\"p\">,</span> <span class=\"n\">edit_history</span><span class=\"p\">,</span> <span class=\"n\">has_attachment</span><span class=\"p\">,</span> <span class=\"n\">has_image</span><span class=\"p\">,</span> <span class=\"n\">has_link</span><span class=\"p\">,</span> <span class=\"nb\">id</span><span class=\"p\">,</span> <span class=\"n\">last_edit_time</span><span class=\"p\">,</span> <span class=\"n\">missedmessageemailaddress</span><span class=\"p\">,</span> <span class=\"n\">reaction</span><span class=\"p\">,</span> <span class=\"n\">recipient</span><span class=\"p\">,</span> <span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">rendered_content</span><span class=\"p\">,</span> <span class=\"n\">rendered_content_version</span><span class=\"p\">,</span> <span class=\"n\">scheduledmessagenotificationemail</span><span class=\"p\">,</span> <span class=\"n\">search_tsvector</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">sender_id</span><span class=\"p\">,</span> <span class=\"n\">sending_client</span><span class=\"p\">,</span> <span class=\"n\">sending_client_id</span><span class=\"p\">,</span> <span class=\"n\">subject</span><span class=\"p\">,</span> <span class=\"n\">submessage</span><span class=\"p\">,</span> <span class=\"n\">usermessage</span>\n</code></pre></div>",
        "id": 1449878,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665767522
    },
    {
        "content": "<p>Ah, true, you're running this in the working deployment's directory, so there <code>Message.realm</code> doesn't exist as far as Django is concerned. Let's go through direct SQL <span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span>  Can you try this?</p>\n<p>(it's basically the same code as above, just with SQL instead of Django ORM queries)</p>\n<div class=\"codehilite\"><pre><span></span><code>from django.db import connection\nwith connection.cursor() as c:\n    c.execute(&#39;SELECT COUNT(*) FROM &quot;zerver_message&quot; INNER JOIN &quot;zerver_recipient&quot; ON (&quot;zerver_message&quot;.&quot;recipient_id&quot; = &quot;zerver_recipient&quot;.&quot;id&quot;) WHERE (&quot;zerver_message&quot;.&quot;realm_id&quot; IS NULL AND &quot;zerver_recipient&quot;.&quot;type&quot; = 1)&#39;)\n    r = c.fetchall()\n    print(f&quot;PERSONAL: {r}&quot;)\n\n    c.execute(&#39;SELECT COUNT(*) FROM &quot;zerver_message&quot; INNER JOIN &quot;zerver_recipient&quot; ON (&quot;zerver_message&quot;.&quot;recipient_id&quot; = &quot;zerver_recipient&quot;.&quot;id&quot;) WHERE (&quot;zerver_message&quot;.&quot;realm_id&quot; IS NULL AND &quot;zerver_recipient&quot;.&quot;type&quot; = 2)&#39;)\n    r = c.fetchall()\n    print(f&quot;STREAM: {r}&quot;)\n\n    c.execute(&#39;SELECT COUNT(*) FROM &quot;zerver_message&quot; INNER JOIN &quot;zerver_recipient&quot; ON (&quot;zerver_message&quot;.&quot;recipient_id&quot; = &quot;zerver_recipient&quot;.&quot;id&quot;) WHERE (&quot;zerver_message&quot;.&quot;realm_id&quot; IS NULL AND &quot;zerver_recipient&quot;.&quot;type&quot; = 3)&#39;)\n    r = c.fetchall()\n    print(f&quot;HUDDLE: {r}&quot;)\n</code></pre></div>",
        "id": 1449905,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665769745
    },
    {
        "content": "<p>I just run the whole code at once?</p>",
        "id": 1449906,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665769933
    },
    {
        "content": "<p>also in the shell i suppose</p>",
        "id": 1449907,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665769948
    },
    {
        "content": "<p>Yup, paste that all into <code>./manage.py shell</code></p>",
        "id": 1449908,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1665769962
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>PERSONAL: [(4,)]\nSTREAM: [(4,)]\nHUDDLE: [(0,)]\n</code></pre></div>",
        "id": 1449909,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665769976
    },
    {
        "content": "<p>Thats all</p>",
        "id": 1449910,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665769985
    },
    {
        "content": "<p>Huh, that's surprising, I'd expect bugs in the Huddle case, not the others. But that's few messages, which is good, we can look at them closer. Can you try:</p>\n<div class=\"codehilite\"><pre><span></span><code>from django.db import connection\nwith connection.cursor() as c:\n    c.execute(&#39;SELECT zerver_message.id FROM &quot;zerver_message&quot; INNER JOIN &quot;zerver_recipient&quot; ON (&quot;zerver_message&quot;.&quot;recipient_id&quot; = &quot;zerver_recipient&quot;.&quot;id&quot;) WHERE (&quot;zerver_message&quot;.&quot;realm_id&quot; IS NULL AND &quot;zerver_recipient&quot;.&quot;type&quot; = 1)&#39;)\n    r = c.fetchall()\n    ids = [x[0] for x in r]\n    print(f&quot;PERSONAL: {ids}&quot;)\n\n    print(Message.objects.filter(id__in=ids).values(&quot;sender__delivery_email&quot;, &quot;recipient&quot;, &quot;date_sent&quot;)\n\n\n    c.execute(&#39;SELECT zerver_message.id FROM &quot;zerver_message&quot; INNER JOIN &quot;zerver_recipient&quot; ON (&quot;zerver_message&quot;.&quot;recipient_id&quot; = &quot;zerver_recipient&quot;.&quot;id&quot;) WHERE (&quot;zerver_message&quot;.&quot;realm_id&quot; IS NULL AND &quot;zerver_recipient&quot;.&quot;type&quot; = 2)&#39;)\n    r = c.fetchall()\n    ids = [x[0] for x in r]\n    print(f&quot;STREAM: {ids}&quot;)\n\n    print(Message.objects.filter(id__in=ids).values(&quot;sender__delivery_email&quot;, &quot;recipient&quot;, &quot;date_sent&quot;)\n</code></pre></div>\n<p>(feel free to censor the emails if they're user emails)</p>",
        "id": 1449917,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665770666
    },
    {
        "content": "<p>(this may be easier in <code>./manage dbshell</code>)</p>",
        "id": 1449927,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1665770974
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> <a href=\"#narrow/stream/31-production-help/topic/Zullip.20git.20upgrade.20fails/near/1449927\">said</a>:</p>\n<blockquote>\n<p>(this may be easier in <code>./manage dbshell</code>)</p>\n</blockquote>\n<p>yeah, good thought, would have been easier  <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> we'll have Message ids after this though, so ORM will be available for digging more</p>",
        "id": 1449930,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665771153
    },
    {
        "content": "<p>on it</p>",
        "id": 1449932,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665771365
    },
    {
        "content": "<p>In dbshell does not return anything</p>",
        "id": 1449933,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665771416
    },
    {
        "content": "<p>Both same</p>",
        "id": 1449935,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665771445
    },
    {
        "content": "<p>If I just have to paste it at onice</p>",
        "id": 1449936,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665771569
    },
    {
        "content": "<p>It does not return a thing</p>",
        "id": 1449937,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665771585
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span> Yeah that code above is for <code>manage.py shell</code></p>",
        "id": 1449938,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665771602
    },
    {
        "content": "<p>(Alex was just pointing out  that I could have made it much simpler if I went with just using <code>dbshell</code> and doing SQL queries there)</p>",
        "id": 1449939,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665771662
    },
    {
        "content": "<p>I think is something wrong maybe with the syntax</p>",
        "id": 1449942,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665771709
    },
    {
        "content": "<p>I tried both of them</p>",
        "id": 1449943,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665771759
    },
    {
        "content": "<p>Empty return</p>",
        "id": 1449944,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665771771
    },
    {
        "content": "<p>There are missing close-parentheses on two of the <code>print</code> statements. It’s waiting for more input.</p>",
        "id": 1449981,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1665775500
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">-    print(Message.objects.filter(id__in=ids).values(\"sender__delivery_email\", \"recipient\", \"date_sent\")</span><span class=\"w\"></span>\n<span class=\"gi\">+    print(Message.objects.filter(id__in=ids).values(\"sender__delivery_email\", \"recipient\", \"date_sent\"))</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 1449982,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1665775580
    },
    {
        "content": "<p>To be explicit -- <span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span>, try this into <code>./manage.py shell</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"kn\">from</span> <span class=\"nn\">django.db</span> <span class=\"kn\">import</span> <span class=\"n\">connection</span>\n<span class=\"k\">with</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">c</span><span class=\"p\">:</span>\n    <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">'SELECT zerver_message.id FROM \"zerver_message\" INNER JOIN \"zerver_recipient\" ON (\"zerver_message\".\"recipient_id\" = \"zerver_recipient\".\"id\") WHERE (\"zerver_message\".\"realm_id\" IS NULL AND \"zerver_recipient\".\"type\" = 1)'</span><span class=\"p\">)</span>\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">()</span>\n    <span class=\"n\">ids</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">x</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">x</span> <span class=\"ow\">in</span> <span class=\"n\">r</span><span class=\"p\">]</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">\"PERSONAL: </span><span class=\"si\">{</span><span class=\"n\">ids</span><span class=\"si\">}</span><span class=\"s2\">\"</span><span class=\"p\">)</span>\n\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">Message</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">id__in</span><span class=\"o\">=</span><span class=\"n\">ids</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s2\">\"sender__delivery_email\"</span><span class=\"p\">,</span> <span class=\"s2\">\"recipient\"</span><span class=\"p\">,</span> <span class=\"s2\">\"date_sent\"</span><span class=\"p\">))</span>\n\n\n    <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s1\">'SELECT zerver_message.id FROM \"zerver_message\" INNER JOIN \"zerver_recipient\" ON (\"zerver_message\".\"recipient_id\" = \"zerver_recipient\".\"id\") WHERE (\"zerver_message\".\"realm_id\" IS NULL AND \"zerver_recipient\".\"type\" = 2)'</span><span class=\"p\">)</span>\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">()</span>\n    <span class=\"n\">ids</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">x</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">x</span> <span class=\"ow\">in</span> <span class=\"n\">r</span><span class=\"p\">]</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">\"STREAM: </span><span class=\"si\">{</span><span class=\"n\">ids</span><span class=\"si\">}</span><span class=\"s2\">\"</span><span class=\"p\">)</span>\n\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">Message</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">id__in</span><span class=\"o\">=</span><span class=\"n\">ids</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s2\">\"sender__delivery_email\"</span><span class=\"p\">,</span> <span class=\"s2\">\"recipient\"</span><span class=\"p\">,</span> <span class=\"s2\">\"date_sent\"</span><span class=\"p\">))</span>\n</code></pre></div>",
        "id": 1449988,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1665775918
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">PERSONAL</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"mi\">10337</span><span class=\"p\">,</span> <span class=\"mi\">10338</span><span class=\"p\">,</span> <span class=\"mi\">10339</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">]</span>\n<span class=\"o\">&lt;</span><span class=\"n\">QuerySet</span> <span class=\"p\">[{</span><span class=\"s1\">'sender__delivery_email'</span><span class=\"p\">:</span> <span class=\"s1\">'welcome-bot@zulip.com'</span><span class=\"p\">,</span> <span class=\"s1\">'recipient'</span><span class=\"p\">:</span> <span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"s1\">'date_sent'</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">datetime</span><span class=\"p\">(</span><span class=\"mi\">2021</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">,</span> <span class=\"mi\">9</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">,</span> <span class=\"mi\">43</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">771567</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">utc</span><span class=\"p\">)},</span> <span class=\"p\">{</span><span class=\"s1\">'sender__delivery_email'</span><span class=\"p\">:</span> <span class=\"s1\">'ichi-bot@chat.uhlhosting.ch'</span><span class=\"p\">,</span> <span class=\"s1\">'recipient'</span><span class=\"p\">:</span> <span class=\"mi\">61</span><span class=\"p\">,</span> <span class=\"s1\">'date_sent'</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">datetime</span><span class=\"p\">(</span><span class=\"mi\">2022</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">14</span><span class=\"p\">,</span> <span class=\"mi\">13</span><span class=\"p\">,</span> <span class=\"mi\">54</span><span class=\"p\">,</span> <span class=\"mi\">28</span><span class=\"p\">,</span> <span class=\"mi\">357208</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">utc</span><span class=\"p\">)},</span> <span class=\"p\">{</span><span class=\"s1\">'sender__delivery_email'</span><span class=\"p\">:</span> <span class=\"s1\">'ichi-bot@chat.uhlhosting.ch'</span><span class=\"p\">,</span> <span class=\"s1\">'recipient'</span><span class=\"p\">:</span> <span class=\"mi\">61</span><span class=\"p\">,</span> <span class=\"s1\">'date_sent'</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">datetime</span><span class=\"p\">(</span><span class=\"mi\">2022</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">14</span><span class=\"p\">,</span> <span class=\"mi\">13</span><span class=\"p\">,</span> <span class=\"mi\">54</span><span class=\"p\">,</span> <span class=\"mi\">28</span><span class=\"p\">,</span> <span class=\"mi\">487381</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">utc</span><span class=\"p\">)},</span> <span class=\"p\">{</span><span class=\"s1\">'sender__delivery_email'</span><span class=\"p\">:</span> <span class=\"s1\">'postal-bot@chat.uhlhosting.ch'</span><span class=\"p\">,</span> <span class=\"s1\">'recipient'</span><span class=\"p\">:</span> <span class=\"mi\">61</span><span class=\"p\">,</span> <span class=\"s1\">'date_sent'</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">datetime</span><span class=\"p\">(</span><span class=\"mi\">2022</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">14</span><span class=\"p\">,</span> <span class=\"mi\">13</span><span class=\"p\">,</span> <span class=\"mi\">54</span><span class=\"p\">,</span> <span class=\"mi\">38</span><span class=\"p\">,</span> <span class=\"mi\">193574</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">utc</span><span class=\"p\">)}]</span><span class=\"o\">&gt;</span>\n<span class=\"n\">STREAM</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">]</span>\n<span class=\"o\">&lt;</span><span class=\"n\">QuerySet</span> <span class=\"p\">[{</span><span class=\"s1\">'sender__delivery_email'</span><span class=\"p\">:</span> <span class=\"s1\">'welcome-bot@zulip.com'</span><span class=\"p\">,</span> <span class=\"s1\">'recipient'</span><span class=\"p\">:</span> <span class=\"mi\">9</span><span class=\"p\">,</span> <span class=\"s1\">'date_sent'</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">datetime</span><span class=\"p\">(</span><span class=\"mi\">2021</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">,</span> <span class=\"mi\">9</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">,</span> <span class=\"mi\">43</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">806931</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">utc</span><span class=\"p\">)},</span> <span class=\"p\">{</span><span class=\"s1\">'sender__delivery_email'</span><span class=\"p\">:</span> <span class=\"s1\">'welcome-bot@zulip.com'</span><span class=\"p\">,</span> <span class=\"s1\">'recipient'</span><span class=\"p\">:</span> <span class=\"mi\">8</span><span class=\"p\">,</span> <span class=\"s1\">'date_sent'</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">datetime</span><span class=\"p\">(</span><span class=\"mi\">2021</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">,</span> <span class=\"mi\">9</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">,</span> <span class=\"mi\">43</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">815176</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">utc</span><span class=\"p\">)},</span> <span class=\"p\">{</span><span class=\"s1\">'sender__delivery_email'</span><span class=\"p\">:</span> <span class=\"s1\">'welcome-bot@zulip.com'</span><span class=\"p\">,</span> <span class=\"s1\">'recipient'</span><span class=\"p\">:</span> <span class=\"mi\">8</span><span class=\"p\">,</span> <span class=\"s1\">'date_sent'</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">datetime</span><span class=\"p\">(</span><span class=\"mi\">2021</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">,</span> <span class=\"mi\">9</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">,</span> <span class=\"mi\">43</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">822913</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">utc</span><span class=\"p\">)},</span> <span class=\"p\">{</span><span class=\"s1\">'sender__delivery_email'</span><span class=\"p\">:</span> <span class=\"s1\">'welcome-bot@zulip.com'</span><span class=\"p\">,</span> <span class=\"s1\">'recipient'</span><span class=\"p\">:</span> <span class=\"mi\">8</span><span class=\"p\">,</span> <span class=\"s1\">'date_sent'</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">datetime</span><span class=\"p\">(</span><span class=\"mi\">2021</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">,</span> <span class=\"mi\">9</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">,</span> <span class=\"mi\">43</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">829876</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">utc</span><span class=\"p\">)}]</span><span class=\"o\">&gt;</span>\n</code></pre></div>",
        "id": 1450011,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665777491
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span>  Huh, i don't see any obvious pattern that would let me identify a bug, other than all these were sent by bots <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span>  Some questions:</p>\n<ol>\n<li>Have you overriden <code>settings.CROSS_REALM_BOT_EMAILS</code> in your settings by any chance?</li>\n<li>Can you run this in <code>manage.py shell</code>, so that we can see what those recipients are and if there's a pattern?</li>\n</ol>\n<div class=\"codehilite\"><pre><span></span><code>Recipient.objects.filter(id__in=[8, 9, 10, 61])\n</code></pre></div>",
        "id": 1450318,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665828823
    },
    {
        "content": "<p>As well as</p>\n<div class=\"codehilite\"><pre><span></span><code>emails = [&#39;welcome-bot@zulip.com&#39;, &quot;postal-bot@chat.uhlhosting.ch&quot;, &quot;&#39;ichi-bot@chat.uhlhosting.ch&quot;]\nUserProfile.objects.filter(delivery_email__in=emails).values(&quot;delivery_email&quot;, &quot;realm&quot;)\n</code></pre></div>",
        "id": 1450327,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665829214
    },
    {
        "content": "<p>My main hypothesis right now is that there is some incorrect database state in terms of <code>Recipient</code> objects. since those things have happened on self-hosted deployments occasionally, and they might mess with the migration's assumptions</p>",
        "id": 1450328,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665829272
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python 2.x\"><pre><span></span><code><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]:</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">id__in</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"mi\">8</span><span class=\"p\">,</span> <span class=\"mi\">9</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">61</span><span class=\"p\">])</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]:</span> <span class=\"o\">---------------------------------------------------------------------------</span>\n<span class=\"n\">DoesNotExist</span>                              <span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">)</span>\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">IPython</span><span class=\"o\">/</span><span class=\"n\">core</span><span class=\"o\">/</span><span class=\"n\">formatters</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">707</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">PlainTextFormatter</span><span class=\"o\">.</span><span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">)</span>\n    <span class=\"mi\">700</span> <span class=\"n\">stream</span> <span class=\"o\">=</span> <span class=\"n\">StringIO</span><span class=\"p\">()</span>\n    <span class=\"mi\">701</span> <span class=\"n\">printer</span> <span class=\"o\">=</span> <span class=\"n\">pretty</span><span class=\"o\">.</span><span class=\"n\">RepresentationPrinter</span><span class=\"p\">(</span><span class=\"n\">stream</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">verbose</span><span class=\"p\">,</span>\n    <span class=\"mi\">702</span>     <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">max_width</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">newline</span><span class=\"p\">,</span>\n    <span class=\"mi\">703</span>     <span class=\"n\">max_seq_length</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">max_seq_length</span><span class=\"p\">,</span>\n    <span class=\"mi\">704</span>     <span class=\"n\">singleton_pprinters</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">singleton_printers</span><span class=\"p\">,</span>\n    <span class=\"mi\">705</span>     <span class=\"n\">type_pprinters</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">type_printers</span><span class=\"p\">,</span>\n    <span class=\"mi\">706</span>     <span class=\"n\">deferred_pprinters</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_printers</span><span class=\"p\">)</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">707</span> <span class=\"n\">printer</span><span class=\"o\">.</span><span class=\"n\">pretty</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n    <span class=\"mi\">708</span> <span class=\"n\">printer</span><span class=\"o\">.</span><span class=\"n\">flush</span><span class=\"p\">()</span>\n    <span class=\"mi\">709</span> <span class=\"k\">return</span> <span class=\"n\">stream</span><span class=\"o\">.</span><span class=\"n\">getvalue</span><span class=\"p\">()</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">IPython</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">pretty</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">410</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">RepresentationPrinter</span><span class=\"o\">.</span><span class=\"n\">pretty</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">)</span>\n    <span class=\"mi\">407</span>                         <span class=\"k\">return</span> <span class=\"n\">meth</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">cycle</span><span class=\"p\">)</span>\n    <span class=\"mi\">408</span>                 <span class=\"k\">if</span> <span class=\"bp\">cls</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"nb\">object</span> \\\n    <span class=\"mi\">409</span>                         <span class=\"ow\">and</span> <span class=\"nb\">callable</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">'__repr__'</span><span class=\"p\">)):</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">410</span>                     <span class=\"k\">return</span> <span class=\"n\">_repr_pprint</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">cycle</span><span class=\"p\">)</span>\n    <span class=\"mi\">412</span>     <span class=\"k\">return</span> <span class=\"n\">_default_pprint</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">cycle</span><span class=\"p\">)</span>\n    <span class=\"mi\">413</span> <span class=\"k\">finally</span><span class=\"p\">:</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">IPython</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">pretty</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">778</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_repr_pprint</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">p</span><span class=\"p\">,</span> <span class=\"n\">cycle</span><span class=\"p\">)</span>\n    <span class=\"mi\">776</span> <span class=\"s2\">\"\"\"A pprint that just redirects to the normal repr function.\"\"\"</span>\n    <span class=\"mi\">777</span> <span class=\"c1\"># Find newlines and replace them with p.break_()</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">778</span> <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"nb\">repr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n    <span class=\"mi\">779</span> <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"n\">output</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">()</span>\n    <span class=\"mi\">780</span> <span class=\"k\">with</span> <span class=\"n\">p</span><span class=\"o\">.</span><span class=\"n\">group</span><span class=\"p\">():</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">299</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">QuerySet</span><span class=\"o\">.</span><span class=\"fm\">__repr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">297</span> <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"n\">REPR_OUTPUT_SIZE</span><span class=\"p\">:</span>\n    <span class=\"mi\">298</span>     <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"...(remaining elements truncated)...\"</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">299</span> <span class=\"k\">return</span> <span class=\"s2\">\"&lt;</span><span class=\"si\">%s</span><span class=\"s2\"> </span><span class=\"si\">%r</span><span class=\"s2\">&gt;\"</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">)</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">580</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">Model</span><span class=\"o\">.</span><span class=\"fm\">__repr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n    <span class=\"mi\">579</span> <span class=\"k\">def</span> <span class=\"fm\">__repr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">580</span>     <span class=\"k\">return</span> <span class=\"s2\">\"&lt;</span><span class=\"si\">%s</span><span class=\"s2\">: </span><span class=\"si\">%s</span><span class=\"s2\">&gt;\"</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span>\n\n<span class=\"n\">File</span> <span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">28</span><span class=\"o\">-</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">23</span><span class=\"o\">-</span><span class=\"mi\">24</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">1483</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"fm\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n   <span class=\"mi\">1482</span> <span class=\"k\">def</span> <span class=\"fm\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span>\n<span class=\"o\">-&gt;</span> <span class=\"mi\">1483</span>     <span class=\"n\">display_recipient</span> <span class=\"o\">=</span> <span class=\"n\">get_display_recipient</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n   <span class=\"mi\">1484</span>     <span class=\"k\">return</span> <span class=\"n\">f</span><span class=\"s2\">\"&lt;Recipient: {display_recipient} ({self.type_id}, {self.type})&gt;\"</span>\n\n<span class=\"n\">File</span> <span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">28</span><span class=\"o\">-</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">23</span><span class=\"o\">-</span><span class=\"mi\">24</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">214</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient</span><span class=\"p\">(</span><span class=\"n\">recipient</span><span class=\"p\">)</span>\n    <span class=\"mi\">213</span> <span class=\"k\">def</span> <span class=\"nf\">get_display_recipient</span><span class=\"p\">(</span><span class=\"n\">recipient</span><span class=\"p\">:</span> <span class=\"s2\">\"Recipient\"</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">DisplayRecipientT</span><span class=\"p\">:</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">214</span>     <span class=\"k\">return</span> <span class=\"n\">get_display_recipient_by_id</span><span class=\"p\">(</span>\n    <span class=\"mi\">215</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span>\n    <span class=\"mi\">216</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type</span><span class=\"p\">,</span>\n    <span class=\"mi\">217</span>         <span class=\"n\">recipient</span><span class=\"o\">.</span><span class=\"n\">type_id</span><span class=\"p\">,</span>\n    <span class=\"mi\">218</span>     <span class=\"p\">)</span>\n\n<span class=\"n\">File</span> <span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">28</span><span class=\"o\">-</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">23</span><span class=\"o\">-</span><span class=\"mi\">24</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">208</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient_by_id</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n    <span class=\"mi\">205</span> <span class=\"kn\">from</span> <span class=\"nn\">zerver.lib.display_recipient</span> <span class=\"kn\">import</span> <span class=\"n\">get_display_recipient_remote_cache</span>\n    <span class=\"mi\">207</span> <span class=\"k\">if</span> <span class=\"n\">recipient_id</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">:</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">208</span>     <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">get_display_recipient_remote_cache</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n    <span class=\"mi\">209</span>     <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">[</span><span class=\"n\">recipient_id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">result</span>\n    <span class=\"mi\">210</span> <span class=\"k\">return</span> <span class=\"n\">per_request_display_recipient_cache</span><span class=\"p\">[</span><span class=\"n\">recipient_id</span><span class=\"p\">]</span>\n\n<span class=\"n\">File</span> <span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">28</span><span class=\"o\">-</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">23</span><span class=\"o\">-</span><span class=\"mi\">24</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">cache</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">175</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">cache_with_key</span><span class=\"o\">.&lt;</span><span class=\"nb\">locals</span><span class=\"o\">&gt;.</span><span class=\"n\">decorator</span><span class=\"o\">.&lt;</span><span class=\"nb\">locals</span><span class=\"o\">&gt;.</span><span class=\"n\">func_with_caching</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">172</span> <span class=\"k\">if</span> <span class=\"n\">val</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">None</span><span class=\"p\">:</span>\n    <span class=\"mi\">173</span>     <span class=\"k\">return</span> <span class=\"n\">val</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">175</span> <span class=\"n\">val</span> <span class=\"o\">=</span> <span class=\"n\">func</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">177</span> <span class=\"n\">cache_set</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">cache_name</span><span class=\"o\">=</span><span class=\"n\">cache_name</span><span class=\"p\">,</span> <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"n\">timeout</span><span class=\"p\">)</span>\n    <span class=\"mi\">179</span> <span class=\"k\">return</span> <span class=\"n\">val</span>\n\n<span class=\"n\">File</span> <span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">28</span><span class=\"o\">-</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">23</span><span class=\"o\">-</span><span class=\"mi\">24</span><span class=\"o\">/</span><span class=\"n\">zerver</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">display_recipient</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">46</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">get_display_recipient_remote_cache</span><span class=\"p\">(</span><span class=\"n\">recipient_id</span><span class=\"p\">,</span> <span class=\"n\">recipient_type</span><span class=\"p\">,</span> <span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">44</span> <span class=\"k\">if</span> <span class=\"n\">recipient_type</span> <span class=\"o\">==</span> <span class=\"n\">Recipient</span><span class=\"o\">.</span><span class=\"n\">STREAM</span><span class=\"p\">:</span>\n     <span class=\"mi\">45</span>     <span class=\"k\">assert</span> <span class=\"n\">recipient_type_id</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">None</span>\n<span class=\"o\">---&gt;</span> <span class=\"mi\">46</span>     <span class=\"n\">stream</span> <span class=\"o\">=</span> <span class=\"n\">Stream</span><span class=\"o\">.</span><span class=\"n\">objects</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s2\">\"name\"</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">recipient_type_id</span><span class=\"p\">)</span>\n     <span class=\"mi\">47</span>     <span class=\"k\">return</span> <span class=\"n\">stream</span><span class=\"p\">[</span><span class=\"s2\">\"name\"</span><span class=\"p\">]</span>\n     <span class=\"mi\">49</span> <span class=\"c1\"># The main priority for ordering here is being deterministic.</span>\n     <span class=\"mi\">50</span> <span class=\"c1\"># Right now, we order by ID, which matches the ordering of user</span>\n     <span class=\"mi\">51</span> <span class=\"c1\"># names in the left sidebar.</span>\n\n<span class=\"n\">File</span> <span class=\"o\">/</span><span class=\"n\">srv</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">-</span><span class=\"n\">cache</span><span class=\"o\">/</span><span class=\"n\">b4ba5048959a2b70574d95fb2938f7a861d1ad07</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">py3</span><span class=\"o\">-</span><span class=\"n\">venv</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"o\">.</span><span class=\"mi\">8</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span><span class=\"o\">/</span><span class=\"n\">django</span><span class=\"o\">/</span><span class=\"n\">db</span><span class=\"o\">/</span><span class=\"n\">models</span><span class=\"o\">/</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">py</span><span class=\"p\">:</span><span class=\"mi\">496</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">QuerySet</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"mi\">494</span>     <span class=\"k\">return</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n    <span class=\"mi\">495</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">num</span><span class=\"p\">:</span>\n<span class=\"o\">--&gt;</span> <span class=\"mi\">496</span>     <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">(</span>\n    <span class=\"mi\">497</span>         <span class=\"s2\">\"</span><span class=\"si\">%s</span><span class=\"s2\"> matching query does not exist.\"</span> <span class=\"o\">%</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span>\n    <span class=\"mi\">498</span>     <span class=\"p\">)</span>\n    <span class=\"mi\">499</span> <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">MultipleObjectsReturned</span><span class=\"p\">(</span>\n    <span class=\"mi\">500</span>     <span class=\"s2\">\"get() returned more than one </span><span class=\"si\">%s</span><span class=\"s2\"> -- it returned </span><span class=\"si\">%s</span><span class=\"s2\">!\"</span>\n    <span class=\"mi\">501</span>     <span class=\"o\">%</span> <span class=\"p\">(</span>\n   <span class=\"p\">(</span><span class=\"o\">...</span><span class=\"p\">)</span>\n    <span class=\"mi\">504</span>     <span class=\"p\">)</span>\n    <span class=\"mi\">505</span> <span class=\"p\">)</span>\n\n<span class=\"n\">DoesNotExist</span><span class=\"p\">:</span> <span class=\"n\">Stream</span> <span class=\"n\">matching</span> <span class=\"n\">query</span> <span class=\"n\">does</span> <span class=\"ow\">not</span> <span class=\"n\">exist</span><span class=\"o\">.</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]:</span>\n</code></pre></div>",
        "id": 1450336,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665831627
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> 1. I do not recall making such a change.</p>",
        "id": 1450360,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665833423
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span> Okay, I think this basically confirms the corrupt Recipients theory. Basically, I think these are Recipients  with no matching Stream/UserProfile objects - resulting from improper deletion of Streams and UserProfiles in the past, that left these Recipients undeleted. Let's make 100% sure that's what we have here and then we'll be able to fix it so that you can upgrade your server.</p>\n<p>Can you run this?</p>\n<div class=\"codehilite\"><pre><span></span><code>for recipient in Recipient.objects.filter(id__in=[8, 9]):\n    assert recipient.type == Recipient.STREAM\n    try:\n        Stream.objects.get(id=recipient.type_id)\n        print(f&quot;Stream exists for {recipient.id}&quot;)\n    except Stream.DoesNotExist:\n        print(f&quot;Recipient {recipient.id} has no Stream&quot;)\n\nfor recipient in Recipient.objects.filter(id__in=[10, 61]):\n    assert recipient.type == Recipient.PERSONAL\n    try:\n        UserProfile.objects.get(id=recipient.type_id)\n        print(f&quot;UserProfile exists for {recipient.id}&quot;)\n    except UserProfile.DoesNotExist:\n        print(f&quot;Recipient {recipient.id} has no UserProfile&quot;)\n</code></pre></div>",
        "id": 1450554,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665905744
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>Recipient 8 has no Stream\nRecipient 9 has no Stream\nRecipient 10 has no UserProfile\nUserProfile exists for 61\n</code></pre></div>",
        "id": 1450564,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665923846
    },
    {
        "content": "<p>Okay, mystery solved then!  <code>UserProfile exists for 61</code> is fine, because the message to this <code>Recipient</code> is from October 14th, I assume it was sent after the failed migration, when you had already restarted the server using the pre-upgrade deployment. So it wasn't touched by the migration or the new code that sets <code>.realm</code>. </p>\n<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> So I don't think this is an obstacle for 6.0, since it was corrupt Recipient state, not a bug in the migration. Though there will be some number of deployments in this situation, due to having manually <code>user_profile.delete()</code>-ed in the past - so we should think whether we should come up with some plan for this (<code>Upgrade notes</code> instructions perhaps?), or just assume they will come here to ask and we'll help them fix it...</p>",
        "id": 1450750,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665939435
    },
    {
        "content": "<p>Now, onto fixing this here. <span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span> Are you okay with us just deleting these  corrupt Recipient objects? As we saw, there's a few Messages to them - this will permanently delete those Messages too. But those belong to deleted users and streams, so they already aren't accessible in your Zulip (though if you thought they're important, they're still recoverable in <code>manage.py shell</code>)</p>",
        "id": 1450751,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665939440
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> yes let's clean them up, so we can check if upgrade proceeds.</p>",
        "id": 1450780,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665942469
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span>   Cool, in that case:</p>\n<div class=\"codehilite\"><pre><span></span><code>for recipient in Recipient.objects.filter(id__in=[8, 9]):\n    assert recipient.type == Recipient.STREAM\n    try:\n        Stream.objects.get(id=recipient.type_id)\n        print(f&quot;Stream exists for {recipient.id}&quot;)\n    except Stream.DoesNotExist:\n        print(f&quot;Recipient {recipient.id} has no Stream, deleting&quot;)\n        recipient.delete()\n\nfor recipient in Recipient.objects.filter(id__in=[10]):\n    assert recipient.type == Recipient.PERSONAL\n    try:\n        UserProfile.objects.get(id=recipient.type_id)\n        print(f&quot;UserProfile exists for {recipient.id}&quot;)\n    except UserProfile.DoesNotExist:\n        print(f&quot;Recipient {recipient.id} has no UserProfile, deleting&quot;)\n        recipient.delete()\n</code></pre></div>\n<p>and we should be good to proceed. Though let's make sure Django applies migrations correctly to avoid your server going down again, since I'm not sure how exactly this works after a failed upgrade like this... So after the above code,  can you show <code>manage.py showmigrations\n</code>?</p>",
        "id": 1450841,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665949391
    },
    {
        "content": "<p><a href=\"https://pastebin.com/zhAhB5iu\">https://pastebin.com/zhAhB5iu</a></p>",
        "id": 1450872,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665956622
    },
    {
        "content": "<p>should I run again the upgrade?</p>",
        "id": 1450873,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665956637
    },
    {
        "content": "<p>Guess this you are aware of this deps issues: </p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">warning</span> <span class=\"s2\">\" &gt; postcss-media-minmax@5.0.0\"</span> <span class=\"n\">has</span> <span class=\"n\">incorrect</span> <span class=\"n\">peer</span> <span class=\"n\">dependency</span> <span class=\"s2\">\"postcss@8.4.5\"</span><span class=\"o\">.</span>\n<span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"p\">]</span> <span class=\"n\">Building</span> <span class=\"n\">fresh</span> <span class=\"n\">packages</span><span class=\"o\">...</span>\n<span class=\"n\">warning</span> <span class=\"n\">Ignored</span> <span class=\"n\">scripts</span> <span class=\"n\">due</span> <span class=\"n\">to</span> <span class=\"n\">flag</span><span class=\"o\">.</span>\n</code></pre></div>",
        "id": 1450874,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1665956862
    },
    {
        "content": "<p>Yes, you can ignore the spew about postcss-media-minmax.</p>",
        "id": 1450884,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1665958955
    },
    {
        "content": "<p>Yeah, now we should be ready to upgrade if you ran the deletion code above. If my understanding is correct, I expect that at the end Django will try to apply migration <code>0420</code>, which will fail again (because new messages have been posted with no <code>.realm</code> set).  Once that happens, you should do (in the new, upgraded deployment directory):</p>\n<div class=\"codehilite\"><pre><span></span><code>manage.py migrate --fake zerver 0418\nmanage.py migrate\n</code></pre></div>\n<p>Basically, this will fake-revert the <code>.realm</code> backfill migration <code>0419</code>, allowing it to run again (it will set <code>.realm</code> for all Messages this time, because we got rid of the bugged ones) and Django will successfully apply <code>0420</code> as well, completing the upgrade - so you'll be able to restart the server and things should work.</p>\n<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> Could you double-check if my thinking on this upgrade procedure sounds right?</p>",
        "id": 1451018,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1665996535
    },
    {
        "content": "<p>I got this at first: Cannot find a migration matching '0418' from app 'zerver'. .</p>",
        "id": 1451034,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666004241
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span>  What commands did you run before that?</p>",
        "id": 1451127,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1666020080
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/Zullip.20git.20upgrade.20fails/near/1450841\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"20576\">Cosmic Sound</span>   Cool, in that case:</p>\n<div class=\"codehilite\"><pre><span></span><code>for recipient in Recipient.objects.filter(id__in=[8, 9]):\n    assert recipient.type == Recipient.STREAM\n    try:\n        Stream.objects.get(id=recipient.type_id)\n        print(f&quot;Stream exists for {recipient.id}&quot;)\n    except Stream.DoesNotExist:\n        print(f&quot;Recipient {recipient.id} has no Stream, deleting&quot;)\n        recipient.delete()\n\nfor recipient in Recipient.objects.filter(id__in=[10]):\n    assert recipient.type == Recipient.PERSONAL\n    try:\n        UserProfile.objects.get(id=recipient.type_id)\n        print(f&quot;UserProfile exists for {recipient.id}&quot;)\n    except UserProfile.DoesNotExist:\n        print(f&quot;Recipient {recipient.id} has no UserProfile, deleting&quot;)\n        recipient.delete()\n</code></pre></div>\n<p>and we should be good to proceed. Though let's make sure Django applies migrations correctly to avoid your server going down again, since I'm not sure how exactly this works after a failed upgrade like this... So after the above code,  can you show <code>manage.py showmigrations\n</code>?</p>\n</blockquote>\n<p>I first run this. And then the migration commands, all commands where issued in the order received.</p>",
        "id": 1451252,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666032747
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/Zullip.20git.20upgrade.20fails/near/1451018\">said</a>:</p>\n<blockquote>\n<p>Yeah, now we should be ready to upgrade if you ran the deletion code above. If my understanding is correct, I expect that at the end Django will try to apply migration <code>0420</code>, which will fail again (because new messages have been posted with no <code>.realm</code> set).  Once that happens, you should do (in the new, upgraded deployment directory):</p>\n<div class=\"codehilite\"><pre><span></span><code>manage.py migrate --fake zerver 0418\nmanage.py migrate\n</code></pre></div>\n<p>Basically, this will fake-revert the <code>.realm</code> backfill migration <code>0419</code>, allowing it to run again (it will set <code>.realm</code> for all Messages this time, because we got rid of the bugged ones) and Django will successfully apply <code>0420</code> as well, completing the upgrade - so you'll be able to restart the server and things should work.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> Could you double-check if my thinking on this upgrade procedure sounds right?</p>\n</blockquote>\n<p>when i runned this nothing was returned alto.</p>",
        "id": 1451253,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666032856
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span> Ah, okay - I meant that you can proceed with the upgrade. So running your Zulip upgrade command (<code>upgrade-zulip</code> or such - I don't know if you upgrade from a tarball or a git repo) followed by the <code>manage.py migrate</code> fiddling I posted above, if the upgrade process fails at migration <code>0420</code> as I described</p>",
        "id": 1451273,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1666034519
    },
    {
        "content": "<p>I upgrade from git.</p>",
        "id": 1451274,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666034563
    },
    {
        "content": "<p>I did all the above, yet fails with the error I sent</p>",
        "id": 1451277,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666034687
    },
    {
        "content": "<p>Can you show the full console output of the whole procedure? Though maybe the problem is just that you're in the old deployment directory when running the <code>manage.py migrate ........</code> commands? You could try running them after <code>cd /home/zulip/deployments/next</code></p>",
        "id": 1451309,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1666036886
    },
    {
        "content": "<p>Today I started from the migrations mentioned: </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>root@chat:/home/ubuntu# su zulip -c <span class=\"s1\">'/home/zulip/deployments/current/manage.py migrate --fake zerver 0418'</span>\nCannot find a migration matching <span class=\"s1\">'0418'</span> from app <span class=\"s1\">'zerver'</span>.\nroot@chat:/home/ubuntu# su zulip -c <span class=\"s1\">'/home/zulip/deployments/current/manage.py migrate --fake zerver 0419'</span>\nCannot find a migration matching <span class=\"s1\">'0419'</span> from app <span class=\"s1\">'zerver'</span>.\nroot@chat:/home/ubuntu# su zulip -c <span class=\"s1\">'/home/zulip/deployments/current/manage.py migrate --fake zerver 0420'</span>\nCannot find a migration matching <span class=\"s1\">'0420'</span> from app <span class=\"s1\">'zerver'</span>.\nroot@chat:/home/ubuntu# su zulip -c <span class=\"s1\">'/home/zulip/deployments/current/manage.py migrate'</span>\nOperations to perform:\n  Apply all migrations: analytics, auth, confirmation, contenttypes, otp_static, otp_totp, sessions, social_django, two_factor, zerver\nRunning migrations:\n  No migrations to apply.\n</code></pre></div>",
        "id": 1451390,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666046023
    },
    {
        "content": "<p>The rest you know it explained above.</p>",
        "id": 1451392,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666046071
    },
    {
        "content": "<p>I run all commands in the order they were received.</p>",
        "id": 1451393,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666046089
    },
    {
        "content": "<p>You were not supposed to run that command with <code>0419</code> or <code>0420</code>.</p>",
        "id": 1451394,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1666046114
    },
    {
        "content": "<p>It did nothing anyway</p>",
        "id": 1451395,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666046130
    },
    {
        "content": "<p>See the output</p>",
        "id": 1451396,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666046135
    },
    {
        "content": "<p>So nothing was altered by running that</p>",
        "id": 1451397,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666046153
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span> I assume your <code>/home/zulip/deployments/current</code> is still the old, pre-upgrade directory. Can you show the latest <code>/var/log/zulip/upgrade.log</code> from this last upgrade?</p>\n<p>Also, <code>ls /home/zulip/deployments/next/zerver/migrations/ | sort</code> to check the <code>next</code> directory - im pretty sure the migrations should be there, we may need to be running the migrate commands there as I mentioned</p>",
        "id": 1451811,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1666114275
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/Zullip.20git.20upgrade.20fails/near/1451811\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"20576\">Cosmic Sound</span> I assume your <code>/home/zulip/deployments/current</code> is still the old, pre-upgrade directory. Can you show the latest <code>/var/log/zulip/upgrade.log</code> from this last upgrade?</p>\n<p>Also, <code>ls /home/zulip/deployments/next/zerver/migrations/ | sort</code> to check the <code>next</code> directory - im pretty sure the migrations should be there, we may need to be running the migrate commands there as I mentioned</p>\n</blockquote>\n<p>here is last log: <a href=\"https://pastebin.com/J7BDGtFD\">https://pastebin.com/J7BDGtFD</a></p>",
        "id": 1451830,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666115486
    },
    {
        "content": "<p>Here is the sort log</p>",
        "id": 1451831,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666115534
    },
    {
        "content": "<p>How do I run the migration in next?</p>",
        "id": 1451835,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666115593
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">zulip</span><span class=\"nd\">@chat</span><span class=\"p\">:</span><span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"nb\">next</span><span class=\"err\">$</span> <span class=\"o\">./</span><span class=\"n\">manage</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"n\">migrate</span> <span class=\"o\">--</span><span class=\"n\">fake</span> <span class=\"n\">zerver</span> <span class=\"mi\">0418</span>\n<span class=\"n\">Operations</span> <span class=\"n\">to</span> <span class=\"n\">perform</span><span class=\"p\">:</span>\n  <span class=\"n\">Target</span> <span class=\"n\">specific</span> <span class=\"n\">migration</span><span class=\"p\">:</span> <span class=\"mi\">0418</span><span class=\"n\">_archivedmessage_realm_message_realm</span><span class=\"p\">,</span> <span class=\"kn\">from</span> <span class=\"nn\">zerver</span>\n<span class=\"n\">Running</span> <span class=\"n\">migrations</span><span class=\"p\">:</span>\n  <span class=\"n\">Rendering</span> <span class=\"n\">model</span> <span class=\"n\">states</span><span class=\"o\">...</span> <span class=\"n\">DONE</span>\n  <span class=\"n\">Unapplying</span> <span class=\"n\">zerver</span><span class=\"mf\">.0419</span><span class=\"n\">_backfill_message_realm</span><span class=\"o\">...</span> <span class=\"n\">FAKED</span>\n<span class=\"n\">zulip</span><span class=\"nd\">@chat</span><span class=\"p\">:</span><span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"nb\">next</span><span class=\"err\">$</span> <span class=\"o\">./</span><span class=\"n\">manage</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"n\">migrate</span>\n<span class=\"n\">Operations</span> <span class=\"n\">to</span> <span class=\"n\">perform</span><span class=\"p\">:</span>\n  <span class=\"n\">Apply</span> <span class=\"nb\">all</span> <span class=\"n\">migrations</span><span class=\"p\">:</span> <span class=\"n\">analytics</span><span class=\"p\">,</span> <span class=\"n\">auth</span><span class=\"p\">,</span> <span class=\"n\">confirmation</span><span class=\"p\">,</span> <span class=\"n\">contenttypes</span><span class=\"p\">,</span> <span class=\"n\">otp_static</span><span class=\"p\">,</span> <span class=\"n\">otp_totp</span><span class=\"p\">,</span> <span class=\"n\">sessions</span><span class=\"p\">,</span> <span class=\"n\">social_django</span><span class=\"p\">,</span> <span class=\"n\">two_factor</span><span class=\"p\">,</span> <span class=\"n\">zerver</span>\n<span class=\"n\">Running</span> <span class=\"n\">migrations</span><span class=\"p\">:</span>\n  <span class=\"n\">Applying</span> <span class=\"n\">zerver</span><span class=\"mf\">.0419</span><span class=\"n\">_backfill_message_realm</span><span class=\"o\">...</span>\n<span class=\"n\">Processing</span> <span class=\"n\">batch</span> <span class=\"mi\">1</span> <span class=\"n\">to</span> <span class=\"mi\">10000</span> <span class=\"k\">for</span> <span class=\"n\">Message</span>\n<span class=\"n\">Processing</span> <span class=\"n\">batch</span> <span class=\"mi\">10001</span> <span class=\"n\">to</span> <span class=\"mi\">20000</span> <span class=\"k\">for</span> <span class=\"n\">Message</span>\n <span class=\"n\">OK</span>\n  <span class=\"n\">Applying</span> <span class=\"n\">zerver</span><span class=\"mf\">.0420</span><span class=\"n\">_alter_archivedmessage_realm_alter_message_realm</span><span class=\"o\">...</span> <span class=\"n\">OK</span>\n<span class=\"n\">zulip</span><span class=\"nd\">@chat</span><span class=\"p\">:</span><span class=\"o\">~/</span><span class=\"n\">deployments</span><span class=\"o\">/</span><span class=\"nb\">next</span><span class=\"err\">$</span>\n</code></pre></div>\n<p>I have redone these from next folder.</p>",
        "id": 1451840,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666115774
    },
    {
        "content": "<p>what next?</p>",
        "id": 1451843,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666115781
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> tried to rerun migrations, it failed again, and not it returns: </p>\n<div class=\"codehilite\"><pre><span></span><code>root@chat:/home/zulip/deployments/next/scripts# ./upgrade-zulip-from-git main\nAnother deployment in progress; waiting for lock... (If no deployment is running, rmdir /home/zulip/deployments/lock)\nAnother deployment in progress; waiting for lock... (If no deployment is running, rmdir /home/zulip/deployments/lock)\n^C\n</code></pre></div>",
        "id": 1451850,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666116199
    },
    {
        "content": "<p>yet there is no such dir</p>",
        "id": 1451851,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666116227
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>root@chat:/home/zulip/deployments# ls -latr\ntotal <span class=\"m\">64</span>\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Aug  <span class=\"m\">1</span> <span class=\"m\">20</span>:00 <span class=\"m\">2022</span>-08-01-19-55-31\ndrwxr-xr-x <span class=\"m\">24</span> zulip zulip <span class=\"m\">4096</span> Sep <span class=\"m\">28</span> <span class=\"m\">18</span>:21 <span class=\"m\">2022</span>-09-28-18-18-36\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Sep <span class=\"m\">28</span> <span class=\"m\">18</span>:24 <span class=\"m\">2022</span>-09-28-18-23-24\nlrwxrwxrwx  <span class=\"m\">1</span> zulip zulip   <span class=\"m\">43</span> Sep <span class=\"m\">28</span> <span class=\"m\">18</span>:25 last -&gt; /home/zulip/deployments/2022-08-01-19-55-31\nlrwxrwxrwx  <span class=\"m\">1</span> zulip zulip   <span class=\"m\">43</span> Sep <span class=\"m\">28</span> <span class=\"m\">18</span>:25 current -&gt; /home/zulip/deployments/2022-09-28-18-23-24\ndrwxr-xr-x <span class=\"m\">24</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">13</span> <span class=\"m\">18</span>:16 <span class=\"m\">2022</span>-10-13-18-14-31\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">14</span> <span class=\"m\">00</span>:23 <span class=\"m\">2022</span>-10-14-00-21-36\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">14</span> <span class=\"m\">00</span>:57 <span class=\"m\">2022</span>-10-14-00-56-27\ndrwxr-xr-x <span class=\"m\">16</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">14</span> <span class=\"m\">18</span>:17 ..\nsrwx------  <span class=\"m\">1</span> zulip zulip    <span class=\"m\">0</span> Oct <span class=\"m\">16</span> <span class=\"m\">06</span>:00 uwsgi-socket\nsrwx------  <span class=\"m\">1</span> zulip zulip    <span class=\"m\">0</span> Oct <span class=\"m\">16</span> <span class=\"m\">06</span>:00 uwsgi-stats\nprw-------  <span class=\"m\">1</span> zulip zulip    <span class=\"m\">0</span> Oct <span class=\"m\">16</span> <span class=\"m\">06</span>:00 uwsgi-control\ndrwxr-xr-x <span class=\"m\">24</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">16</span> <span class=\"m\">21</span>:45 <span class=\"m\">2022</span>-10-16-21-44-16\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">16</span> <span class=\"m\">21</span>:51 <span class=\"m\">2022</span>-10-16-21-49-52\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">17</span> <span class=\"m\">10</span>:59 <span class=\"m\">2022</span>-10-17-10-57-53\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">17</span> <span class=\"m\">11</span>:16 <span class=\"m\">2022</span>-10-17-11-14-48\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">17</span> <span class=\"m\">18</span>:53 <span class=\"m\">2022</span>-10-17-18-52-32\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">17</span> <span class=\"m\">22</span>:38 <span class=\"m\">2022</span>-10-17-22-36-41\ndrwxr-xr-x <span class=\"m\">25</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">17</span> <span class=\"m\">22</span>:40 <span class=\"m\">2022</span>-10-17-22-39-14\nlrwxrwxrwx  <span class=\"m\">1</span> root  root    <span class=\"m\">43</span> Oct <span class=\"m\">18</span> <span class=\"m\">17</span>:59 next -&gt; /home/zulip/deployments/2022-10-18-17-59-25\ndrwxr-xr-x <span class=\"m\">24</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">18</span> <span class=\"m\">17</span>:59 <span class=\"m\">2022</span>-10-18-17-59-25\ndrwxr-xr-x <span class=\"m\">16</span> zulip zulip <span class=\"m\">4096</span> Oct <span class=\"m\">18</span> <span class=\"m\">17</span>:59 .\nroot@chat:/home/zulip/deployments#\n</code></pre></div>",
        "id": 1451852,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666116274
    },
    {
        "content": "<p><code>12.3 GiB [##########] /zulip-npm-cache</code></p>",
        "id": 1451874,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666116780
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>--- /home/zulip/.cache ------------------------------------------------------------------------------------------------------------------------------------------------\n                         /..\n    <span class=\"m\">4</span>.1 GiB <span class=\"o\">[</span><span class=\"c1\">##########] /yarn</span>\n</code></pre></div>",
        "id": 1451883,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666116882
    },
    {
        "content": "<p>Would be useful maybe to add some cleanup process to migration, seems to have taken a lot of space 30 GB Machine it was fulll.</p>",
        "id": 1451886,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666116931
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"20576\">Cosmic Sound</span> has marked this topic as resolved.</p>",
        "id": 1451901,
        "sender_full_name": "Notification Bot",
        "timestamp": 1666117420
    },
    {
        "content": "<p>Managed to upgrade, yet the yarn cache is just huge</p>",
        "id": 1451902,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666117452
    },
    {
        "content": "<p>Also it seems the machine went from 4 GB ram to now almost 6. Wondering what takes so much.</p>",
        "id": 1451904,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666117487
    },
    {
        "content": "<p>I don't know about the other issues, but you should make sure that <code>/home/zulip/deployments/current</code> is linking to the latest deployment (<code>/home/zulip/deployments/2022-10-18-17-59-25</code> I assume) to be sure you're running always the latest code</p>",
        "id": 1451906,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1666117575
    },
    {
        "content": "<p>(the migrations seems to have indeed applied successfully based on your output in <a href=\"#narrow/stream/31-production-help/topic/.E2.9C.94.20Zullip.20git.20upgrade.20fails/near/1451840\">https://chat.zulip.org/#narrow/stream/31-production-help/topic/.E2.9C.94.20Zullip.20git.20upgrade.20fails/near/1451840</a>)</p>",
        "id": 1451910,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1666117651
    },
    {
        "content": "<p>I thought we had code to delete the yarn cache on upgrade if it was larger than some size; is that logic only running in the development environment or is my memory off?</p>",
        "id": 1452050,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1666134479
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/.E2.9C.94.20Zullip.20git.20upgrade.20fails/near/1451906\">said</a>:</p>\n<blockquote>\n<p>I don't know about the other issues, but you should make sure that <code>/home/zulip/deployments/current</code> is linking to the latest deployment (<code>/home/zulip/deployments/2022-10-18-17-59-25</code> I assume) to be sure you're running always the latest code</p>\n</blockquote>\n<p>Yes, already check that, all works well. Thanks <span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span>  for the support and patience!</p>",
        "id": 1452147,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666143527
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"7\">Tim Abbott</span> <a href=\"#narrow/stream/31-production-help/topic/.E2.9C.94.20Zullip.20git.20upgrade.20fails/near/1452050\">said</a>:</p>\n<blockquote>\n<p>I thought we had code to delete the yarn cache on upgrade if it was larger than some size; is that logic only running in the development environment or is my memory off?</p>\n</blockquote>\n<p>In my findings almost 5 GB of yarn's cache, is huge imho.</p>",
        "id": 1452148,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1666143560
    }
]