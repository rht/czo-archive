[
    {
        "content": "<p>Hi,</p>\n<p>Lately I got this error: [Django] chat: Timed out in user_presence after 30 seconds processing 1 events</p>",
        "id": 1557917,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682706170
    },
    {
        "content": "<p>Deployed code:</p>\n<ul>\n<li>git: 6.0-1907-ga03dca93ca</li>\n<li>ZULIP_VERSION: 6.0-1907-ga03dca93ca</li>\n</ul>",
        "id": 1557918,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682706191
    },
    {
        "content": "<p>That's not on <code>main</code>.  Can you show <code>/home/zulip/deployments/current/zulip-git-version</code> ?</p>",
        "id": 1557925,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682706622
    },
    {
        "content": "<p>Oh, it's the current tip, I needed to fetch, nevermind.</p>",
        "id": 1557927,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682706645
    },
    {
        "content": "<p>Do you see a stacktrace in <code>/var/log/zulip/errors.log</code> for that?</p>",
        "id": 1557928,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682706690
    },
    {
        "content": "<p>I got even more errors since:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Logger<span class=\"w\"> </span>root,<span class=\"w\"> </span>from<span class=\"w\"> </span>module<span class=\"w\"> </span>zerver.lib.markdown<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">2618</span>:\nError<span class=\"w\"> </span>generated<span class=\"w\"> </span>by<span class=\"w\"> </span>Anonymous<span class=\"w\"> </span>user<span class=\"w\"> </span><span class=\"o\">(</span>not<span class=\"w\"> </span>logged<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"o\">)</span><span class=\"w\"> </span>on<span class=\"w\"> </span>chat<span class=\"w\"> </span>deployment\n\nTraceback<span class=\"w\"> </span><span class=\"o\">(</span>most<span class=\"w\"> </span>recent<span class=\"w\"> </span>call<span class=\"w\"> </span>last<span class=\"o\">)</span>:\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/./zerver/lib/markdown/__init__.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">2602</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>do_convert\n<span class=\"w\">   </span>rendering_result.rendered_content<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>timeout<span class=\"o\">(</span><span class=\"m\">5</span>,<span class=\"w\"> </span>lambda:<span class=\"w\"> </span>_md_engine.convert<span class=\"o\">(</span>content<span class=\"o\">))</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/./zerver/lib/timeout.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">82</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>timeout\n<span class=\"w\">   </span>raise<span class=\"w\"> </span>thread.exc_info<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>.with_traceback<span class=\"o\">(</span>thread.exc_info<span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">])</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/./zerver/lib/timeout.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">54</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>run\n<span class=\"w\">   </span>self.result<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>func<span class=\"o\">()</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/./zerver/lib/markdown/__init__.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">2602</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>&lt;lambda&gt;\n<span class=\"w\">   </span>rendering_result.rendered_content<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>timeout<span class=\"o\">(</span><span class=\"m\">5</span>,<span class=\"w\"> </span>lambda:<span class=\"w\"> </span>_md_engine.convert<span class=\"o\">(</span>content<span class=\"o\">))</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/markdown/core.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">258</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>convert\n<span class=\"w\">   </span><span class=\"nv\">newRoot</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>treeprocessor.run<span class=\"o\">(</span>root<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/markdown/treeprocessors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">367</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>run\n<span class=\"w\">   </span>self.__handleInline<span class=\"o\">(</span>text<span class=\"o\">)</span>,<span class=\"w\"> </span>child\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/markdown/treeprocessors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">127</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>__handleInline\n<span class=\"w\">   </span>data,<span class=\"w\"> </span>matched,<span class=\"w\"> </span><span class=\"nv\">startIndex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>self.__applyPattern<span class=\"o\">(</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/markdown/treeprocessors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">267</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>__applyPattern\n<span class=\"w\">   </span><span class=\"k\">for</span><span class=\"w\"> </span>match<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>pattern.getCompiledRegExp<span class=\"o\">()</span>.finditer<span class=\"o\">(</span>data,<span class=\"w\"> </span>startIndex<span class=\"o\">)</span>:\nzerver.lib.timeout.TimeoutExpiredError:<span class=\"w\"> </span>Function<span class=\"w\"> </span>call<span class=\"w\"> </span>timed<span class=\"w\"> </span>out.\n\n\nDeployed<span class=\"w\"> </span>code:\n-<span class=\"w\"> </span>git:<span class=\"w\"> </span><span class=\"m\">6</span>.0-1907-ga03dca93ca\n-<span class=\"w\"> </span>ZULIP_VERSION:<span class=\"w\"> </span><span class=\"m\">6</span>.0-1907-ga03dca93ca\n\n\nRequest<span class=\"w\"> </span>info:<span class=\"w\"> </span>none\n</code></pre></div>",
        "id": 1557981,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682709476
    },
    {
        "content": "<p>and </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Logger<span class=\"w\"> </span>root,<span class=\"w\"> </span>from<span class=\"w\"> </span>module<span class=\"w\"> </span>zerver.worker.queue_processors<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">380</span>:\nError<span class=\"w\"> </span>generated<span class=\"w\"> </span>by<span class=\"w\"> </span>Anonymous<span class=\"w\"> </span>user<span class=\"w\"> </span><span class=\"o\">(</span>not<span class=\"w\"> </span>logged<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"o\">)</span><span class=\"w\"> </span>on<span class=\"w\"> </span>chat<span class=\"w\"> </span>deployment\n\nTraceback<span class=\"w\"> </span><span class=\"o\">(</span>most<span class=\"w\"> </span>recent<span class=\"w\"> </span>call<span class=\"w\"> </span>last<span class=\"o\">)</span>:\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/asgiref/local.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">70</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>_get_context_id\n<span class=\"w\">   </span><span class=\"nv\">context_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>SyncToAsync.launch_map<span class=\"o\">[</span>context_id<span class=\"o\">]</span>\nKeyError:<span class=\"w\"> </span>&lt;_MainThread<span class=\"o\">(</span>MainThread,<span class=\"w\"> </span>started<span class=\"w\"> </span><span class=\"m\">139716367423296</span><span class=\"o\">)</span>&gt;\n\nDuring<span class=\"w\"> </span>handling<span class=\"w\"> </span>of<span class=\"w\"> </span>the<span class=\"w\"> </span>above<span class=\"w\"> </span>exception,<span class=\"w\"> </span>another<span class=\"w\"> </span>exception<span class=\"w\"> </span>occurred:\n\nTraceback<span class=\"w\"> </span><span class=\"o\">(</span>most<span class=\"w\"> </span>recent<span class=\"w\"> </span>call<span class=\"w\"> </span>last<span class=\"o\">)</span>:\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/worker/queue_processors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">315</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>do_consume\n<span class=\"w\">   </span>consume_func<span class=\"o\">(</span>events<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/worker/queue_processors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">355</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>&lt;lambda&gt;\n<span class=\"w\">   </span><span class=\"nv\">consume_func</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>lambda<span class=\"w\"> </span>events:<span class=\"w\"> </span>self.consume<span class=\"o\">(</span>events<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">])</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/worker/queue_processors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">564</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>consume\n<span class=\"w\">   </span>do_update_user_presence<span class=\"o\">(</span>user_profile,<span class=\"w\"> </span>client,<span class=\"w\"> </span>log_time,<span class=\"w\"> </span>status<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/actions/presence.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">172</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>do_update_user_presence\n<span class=\"w\">   </span>transaction.on_commit<span class=\"o\">(</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/django/db/transaction.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">134</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>on_commit\n<span class=\"w\">   </span>get_connection<span class=\"o\">(</span>using<span class=\"o\">)</span>.on_commit<span class=\"o\">(</span>func,<span class=\"w\"> </span>robust<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/django/db/backends/base/base.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">760</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>on_commit\n<span class=\"w\">   </span>func<span class=\"o\">()</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/actions/presence.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">173</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>&lt;lambda&gt;\n<span class=\"w\">   </span>lambda:<span class=\"w\"> </span>send_presence_changed<span class=\"o\">(</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/actions/presence.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">30</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>send_presence_changed\n<span class=\"w\">   </span><span class=\"nv\">user_ids</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>active_user_ids<span class=\"o\">(</span>user_profile.realm_id<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/lib/cache.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">146</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>func_with_caching\n<span class=\"w\">   </span><span class=\"nv\">val</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>cache_get<span class=\"o\">(</span>key,<span class=\"w\"> </span><span class=\"nv\">cache_name</span><span class=\"o\">=</span>cache_name<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/lib/cache.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">220</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>cache_get\n<span class=\"w\">   </span><span class=\"nv\">cache_backend</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>get_cache_backend<span class=\"o\">(</span>cache_name<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/lib/cache.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">125</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>get_cache_backend\n<span class=\"w\">   </span><span class=\"k\">return</span><span class=\"w\"> </span>caches<span class=\"o\">[</span>cache_name<span class=\"o\">]</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/django/utils/connection.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">58</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>__getitem__\n<span class=\"w\">   </span><span class=\"k\">return</span><span class=\"w\"> </span>getattr<span class=\"o\">(</span>self._connections,<span class=\"w\"> </span><span class=\"nb\">alias</span><span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/asgiref/local.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">101</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>__getattr__\n<span class=\"w\">   </span><span class=\"nv\">storage</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>self._get_storage<span class=\"o\">()</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/asgiref/local.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">81</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>_get_storage\n<span class=\"w\">   </span><span class=\"nv\">context_obj</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>self._get_context_id<span class=\"o\">()</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/asgiref/local.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">70</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>_get_context_id\n<span class=\"w\">   </span><span class=\"nv\">context_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>SyncToAsync.launch_map<span class=\"o\">[</span>context_id<span class=\"o\">]</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/worker/queue_processors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">361</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>timer_expired\n<span class=\"w\">   </span>raise<span class=\"w\"> </span>WorkerTimeoutError<span class=\"o\">(</span>self.queue_name,<span class=\"w\"> </span>limit,<span class=\"w\"> </span>len<span class=\"o\">(</span>events<span class=\"o\">))</span>\nzerver.worker.queue_processors.WorkerTimeoutError:<span class=\"w\"> </span>Timed<span class=\"w\"> </span>out<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>user_presence<span class=\"w\"> </span>after<span class=\"w\"> </span><span class=\"m\">30</span><span class=\"w\"> </span>seconds<span class=\"w\"> </span>processing<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>events\n\n\nDeployed<span class=\"w\"> </span>code:\n-<span class=\"w\"> </span>git:<span class=\"w\"> </span><span class=\"m\">6</span>.0-1907-ga03dca93ca\n-<span class=\"w\"> </span>ZULIP_VERSION:<span class=\"w\"> </span><span class=\"m\">6</span>.0-1907-ga03dca93ca\n\n\nRequest<span class=\"w\"> </span>info:<span class=\"w\"> </span>none\n</code></pre></div>",
        "id": 1557982,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682709499
    },
    {
        "content": "<p>Respectively: <code>[Django] chat: Timed out in user_presence after 30 seconds processing 1 events</code><br>\nand <code>[Django] chat: Function call timed out. </code></p>",
        "id": 1557984,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682709604
    },
    {
        "content": "<p>and this is the details from first error:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Logger<span class=\"w\"> </span>root,<span class=\"w\"> </span>from<span class=\"w\"> </span>module<span class=\"w\"> </span>zerver.worker.queue_processors<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">380</span>:\nError<span class=\"w\"> </span>generated<span class=\"w\"> </span>by<span class=\"w\"> </span>Anonymous<span class=\"w\"> </span>user<span class=\"w\"> </span><span class=\"o\">(</span>not<span class=\"w\"> </span>logged<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"o\">)</span><span class=\"w\"> </span>on<span class=\"w\"> </span>chat<span class=\"w\"> </span>deployment\n\nTraceback<span class=\"w\"> </span><span class=\"o\">(</span>most<span class=\"w\"> </span>recent<span class=\"w\"> </span>call<span class=\"w\"> </span>last<span class=\"o\">)</span>:\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/worker/queue_processors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">315</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>do_consume\n<span class=\"w\">   </span>consume_func<span class=\"o\">(</span>events<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/worker/queue_processors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">355</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>&lt;lambda&gt;\n<span class=\"w\">   </span><span class=\"nv\">consume_func</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>lambda<span class=\"w\"> </span>events:<span class=\"w\"> </span>self.consume<span class=\"o\">(</span>events<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">])</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/worker/queue_processors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">564</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>consume\n<span class=\"w\">   </span>do_update_user_presence<span class=\"o\">(</span>user_profile,<span class=\"w\"> </span>client,<span class=\"w\"> </span>log_time,<span class=\"w\"> </span>status<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/actions/presence.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">132</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>do_update_user_presence\n<span class=\"w\">   </span><span class=\"nv\">seconds</span><span class=\"o\">=</span>settings.OFFLINE_THRESHOLD_SECS\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/django/utils/functional.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">292</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>__getattribute__\n<span class=\"w\">   </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nv\">name</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s2\">\"_wrapped\"</span>:\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/zerver/worker/queue_processors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">361</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>timer_expired\n<span class=\"w\">   </span>raise<span class=\"w\"> </span>WorkerTimeoutError<span class=\"o\">(</span>self.queue_name,<span class=\"w\"> </span>limit,<span class=\"w\"> </span>len<span class=\"o\">(</span>events<span class=\"o\">))</span>\nzerver.worker.queue_processors.WorkerTimeoutError:<span class=\"w\"> </span>Timed<span class=\"w\"> </span>out<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>user_presence<span class=\"w\"> </span>after<span class=\"w\"> </span><span class=\"m\">30</span><span class=\"w\"> </span>seconds<span class=\"w\"> </span>processing<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>events\n\n\nDeployed<span class=\"w\"> </span>code:\n-<span class=\"w\"> </span>git:<span class=\"w\"> </span><span class=\"m\">6</span>.0-1907-ga03dca93ca\n-<span class=\"w\"> </span>ZULIP_VERSION:<span class=\"w\"> </span><span class=\"m\">6</span>.0-1907-ga03dca93ca\n\n\nRequest<span class=\"w\"> </span>info:<span class=\"w\"> </span>none\n</code></pre></div>",
        "id": 1557986,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682709650
    },
    {
        "content": "<p>How big is this deployment?</p>",
        "id": 1557987,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682709714
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span>: Just highlighting this, since it seems like a potential release blocker with the new presence code.</p>",
        "id": 1557988,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682709746
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> not big at all, we have maybe 30 users while active 2, and like 10 bots.</p>",
        "id": 1557989,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682709865
    },
    {
        "content": "<p>It was an import from mattermost some years ago</p>",
        "id": 1557990,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682709878
    },
    {
        "content": "<p>was working fine until recently these errors started to pop out</p>",
        "id": 1557991,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682709893
    },
    {
        "content": "<p>Yup, we merged a change to how presence data is calculated recently, which is what I suspect is being the problem.</p>",
        "id": 1557992,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682709930
    },
    {
        "content": "<p>could be, as I see some notifications delayed</p>",
        "id": 1557993,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682709946
    },
    {
        "content": "<p>Well, that's where the timouts are coming from. <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 1557994,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682709960
    },
    {
        "content": "<p>If anything else I can provide to help debug this, let me know.</p>",
        "id": 1557995,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682709987
    },
    {
        "content": "<p>Do you have graphs of CPU load over time?  Any recent regressions in those?</p>",
        "id": 1557997,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682710080
    },
    {
        "content": "<p>Yes I do, let me check</p>",
        "id": 1557999,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710179
    },
    {
        "content": "<p><a href=\"/user_uploads/2/82/Y7dEOH41b0H7XKM7b0kVfxuI/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/82/Y7dEOH41b0H7XKM7b0kVfxuI/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/82/Y7dEOH41b0H7XKM7b0kVfxuI/image.png\"></a></div>",
        "id": 1558000,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710220
    },
    {
        "content": "<p><a href=\"/user_uploads/2/8f/w4fsJaH3Q889ukV1_ZlaEBmM/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/8f/w4fsJaH3Q889ukV1_ZlaEBmM/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/8f/w4fsJaH3Q889ukV1_ZlaEBmM/image.png\"></a></div>",
        "id": 1558001,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710243
    },
    {
        "content": "<p>Corresponds also to network and disk IO</p>",
        "id": 1558002,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710257
    },
    {
        "content": "<p>Sure -- how often do you upgrade to latest <code>main</code>?</p>",
        "id": 1558003,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682710310
    },
    {
        "content": "<p>Alternately, can you show:</p>\n<div class=\"codehilite\"><pre><span></span><code>grep -C5 &#39;Applying zerver.0443&#39; /var/log/zulip/upgrade.log\n</code></pre></div>",
        "id": 1558005,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682710452
    },
    {
        "content": "<p>1 a month or so</p>",
        "id": 1558007,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710555
    },
    {
        "content": "<p>Hm, OK.  Can you show that grep output?</p>",
        "id": 1558010,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682710583
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>root@chat:/home/ubuntu#<span class=\"w\"> </span>grep<span class=\"w\"> </span>-C5<span class=\"w\"> </span><span class=\"s1\">'Applying zerver.0443'</span><span class=\"w\"> </span>/var/log/zulip/upgrade.log\n<span class=\"w\">  </span>Applying<span class=\"w\"> </span>zerver.0438_add_web_mark_read_on_scroll_policy_setting...<span class=\"w\"> </span>OK\n<span class=\"w\">  </span>Applying<span class=\"w\"> </span>zerver.0439_fix_deleteduser_email...<span class=\"w\"> </span>OK\n<span class=\"w\">  </span>Applying<span class=\"w\"> </span>zerver.0440_realmfilter_url_template...<span class=\"w\"> </span>OK\n<span class=\"w\">  </span>Applying<span class=\"w\"> </span>zerver.0441_backfill_realmfilter_url_template...<span class=\"w\"> </span>OK\n<span class=\"w\">  </span>Applying<span class=\"w\"> </span>zerver.0442_remove_realmfilter_url_format_string...<span class=\"w\"> </span>OK\n<span class=\"w\">  </span>Applying<span class=\"w\"> </span>zerver.0443_userpresence_new_table_schema...<span class=\"w\"> </span>OK\n<span class=\"w\">  </span>Applying<span class=\"w\"> </span>zerver.0444_userpresence_fill_data...<span class=\"w\"> </span>OK\n<span class=\"w\">  </span>Applying<span class=\"w\"> </span>zerver.0445_drop_userpresenceold...<span class=\"w\"> </span>OK\n<span class=\"m\">2023</span>-04-28<span class=\"w\"> </span><span class=\"m\">16</span>:24:27,519<span class=\"w\"> </span>upgrade-zulip-stage-2:<span class=\"w\"> </span>Restarting<span class=\"w\"> </span>Zulip...\n<span class=\"m\">2023</span>-04-28<span class=\"w\"> </span><span class=\"m\">16</span>:24:27,572<span class=\"w\"> </span>start-server:<span class=\"w\"> </span>Filling<span class=\"w\"> </span>memcached<span class=\"w\"> </span>caches\n<span class=\"m\">2023</span>-04-28<span class=\"w\"> </span><span class=\"m\">16</span>:24:28.256<span class=\"w\"> </span>INFO<span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span>Successfully<span class=\"w\"> </span>populated<span class=\"w\"> </span>user<span class=\"w\"> </span>cache!<span class=\"w\">  </span>Consumed<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>remote<span class=\"w\"> </span>cache<span class=\"w\"> </span>queries<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">0</span>.03<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"o\">)</span>\nroot@chat:/home/ubuntu#\n</code></pre></div>",
        "id": 1558011,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710634
    },
    {
        "content": "<p>OK, so you <em>just</em> upgraded (3 hours ago) into the version with the new presence code.</p>",
        "id": 1558020,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682710753
    },
    {
        "content": "<p>So showing the last ~6 hours of CPU graph might be helpful, to compare the before and after -- though from what you showed already, I don't think that's smoking gun</p>",
        "id": 1558024,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682710805
    },
    {
        "content": "<p>Yes</p>",
        "id": 1558025,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710809
    },
    {
        "content": "<p>I do not have longer CPU graph than the one shared</p>",
        "id": 1558026,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710837
    },
    {
        "content": "<p>Ah, OK</p>",
        "id": 1558027,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682710851
    },
    {
        "content": "<p>In future I will, working on a new monitoring deployment</p>",
        "id": 1558029,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710956
    },
    {
        "content": "<p>Yet thats the basic from proxmox</p>",
        "id": 1558031,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710970
    },
    {
        "content": "<p>I just got another timeout</p>",
        "id": 1558032,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682710978
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Logger<span class=\"w\"> </span>root,<span class=\"w\"> </span>from<span class=\"w\"> </span>module<span class=\"w\"> </span>zerver.lib.markdown<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">2618</span>:\nError<span class=\"w\"> </span>generated<span class=\"w\"> </span>by<span class=\"w\"> </span>Anonymous<span class=\"w\"> </span>user<span class=\"w\"> </span><span class=\"o\">(</span>not<span class=\"w\"> </span>logged<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"o\">)</span><span class=\"w\"> </span>on<span class=\"w\"> </span>chat<span class=\"w\"> </span>deployment\n\nTraceback<span class=\"w\"> </span><span class=\"o\">(</span>most<span class=\"w\"> </span>recent<span class=\"w\"> </span>call<span class=\"w\"> </span>last<span class=\"o\">)</span>:\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/./zerver/lib/markdown/__init__.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">2602</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>do_convert\n<span class=\"w\">   </span>rendering_result.rendered_content<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>timeout<span class=\"o\">(</span><span class=\"m\">5</span>,<span class=\"w\"> </span>lambda:<span class=\"w\"> </span>_md_engine.convert<span class=\"o\">(</span>content<span class=\"o\">))</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/./zerver/lib/timeout.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">82</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>timeout\n<span class=\"w\">   </span>raise<span class=\"w\"> </span>thread.exc_info<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>.with_traceback<span class=\"o\">(</span>thread.exc_info<span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">])</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/./zerver/lib/timeout.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">54</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>run\n<span class=\"w\">   </span>self.result<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>func<span class=\"o\">()</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/home/zulip/deployments/2023-04-28-16-21-09/./zerver/lib/markdown/__init__.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">2602</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>&lt;lambda&gt;\n<span class=\"w\">   </span>rendering_result.rendered_content<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>timeout<span class=\"o\">(</span><span class=\"m\">5</span>,<span class=\"w\"> </span>lambda:<span class=\"w\"> </span>_md_engine.convert<span class=\"o\">(</span>content<span class=\"o\">))</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/markdown/core.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">258</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>convert\n<span class=\"w\">   </span><span class=\"nv\">newRoot</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>treeprocessor.run<span class=\"o\">(</span>root<span class=\"o\">)</span>\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/markdown/treeprocessors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">367</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>run\n<span class=\"w\">   </span>self.__handleInline<span class=\"o\">(</span>text<span class=\"o\">)</span>,<span class=\"w\"> </span>child\n<span class=\"w\"> </span>File<span class=\"w\"> </span><span class=\"s2\">\"/srv/zulip-venv-cache/9f78492dcdea0cfa09952b3a23e82955fafa3ea7/zulip-py3-venv/lib/python3.8/site-packages/markdown/treeprocessors.py\"</span>,<span class=\"w\"> </span>line<span class=\"w\"> </span><span class=\"m\">131</span>,<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>__handleInline\n<span class=\"w\">   </span><span class=\"nv\">patternIndex</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"m\">1</span>\nzerver.lib.timeout.TimeoutExpiredError:<span class=\"w\"> </span>Function<span class=\"w\"> </span>call<span class=\"w\"> </span>timed<span class=\"w\"> </span>out.\n\n\nDeployed<span class=\"w\"> </span>code:\n-<span class=\"w\"> </span>git:<span class=\"w\"> </span><span class=\"m\">6</span>.0-1907-ga03dca93ca\n-<span class=\"w\"> </span>ZULIP_VERSION:<span class=\"w\"> </span><span class=\"m\">6</span>.0-1907-ga03dca93ca\n\n\nRequest<span class=\"w\"> </span>info:<span class=\"w\"> </span>none\n</code></pre></div>",
        "id": 1558034,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711003
    },
    {
        "content": "<p>Not sure why is sayingg always user Anonymous...</p>",
        "id": 1558036,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711021
    },
    {
        "content": "<p>Backend processes which time out don't have a user.</p>",
        "id": 1558041,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682711086
    },
    {
        "content": "<p>Right</p>",
        "id": 1558045,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711112
    },
    {
        "content": "<p>Having things time out left and right is weird if you're not looking CPU-bound.  How's memory consumption?</p>",
        "id": 1558047,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682711134
    },
    {
        "content": "<p>Memory is almost full</p>",
        "id": 1558048,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711179
    },
    {
        "content": "<p><a href=\"/user_uploads/2/42/qGW8qOY_Upq8UkTBg1PhOKpE/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/42/qGW8qOY_Upq8UkTBg1PhOKpE/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/42/qGW8qOY_Upq8UkTBg1PhOKpE/image.png\"></a></div>",
        "id": 1558049,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711183
    },
    {
        "content": "<p>These are all from today</p>",
        "id": 1558050,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711194
    },
    {
        "content": "<p>Do you have swap enabled on the host?  Is any in use?</p>",
        "id": 1558053,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682711213
    },
    {
        "content": "<p><a href=\"/user_uploads/2/28/B0sEv3hmoBRwUQh5uG7Bfnag/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/28/B0sEv3hmoBRwUQh5uG7Bfnag/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/28/B0sEv3hmoBRwUQh5uG7Bfnag/image.png\"></a></div>",
        "id": 1558054,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711215
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>root@chat:/home/ubuntu#<span class=\"w\"> </span>free<span class=\"w\"> </span>-m\n<span class=\"w\">              </span>total<span class=\"w\">        </span>used<span class=\"w\">        </span>free<span class=\"w\">      </span>shared<span class=\"w\">  </span>buff/cache<span class=\"w\">   </span>available\nMem:<span class=\"w\">           </span><span class=\"m\">3982</span><span class=\"w\">        </span><span class=\"m\">3619</span><span class=\"w\">         </span><span class=\"m\">125</span><span class=\"w\">         </span><span class=\"m\">135</span><span class=\"w\">         </span><span class=\"m\">238</span><span class=\"w\">          </span><span class=\"m\">46</span>\nSwap:<span class=\"w\">             </span><span class=\"m\">0</span><span class=\"w\">           </span><span class=\"m\">0</span><span class=\"w\">           </span><span class=\"m\">0</span>\nroot@chat:/home/ubuntu#\n</code></pre></div>",
        "id": 1558055,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711237
    },
    {
        "content": "<p>I guess is disabled</p>",
        "id": 1558056,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711242
    },
    {
        "content": "<p>The server was always fine with 4GB ram, since we do not have much traffic.</p>",
        "id": 1558057,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711275
    },
    {
        "content": "<p>Since you're seeing timouts from things that aren't the presence codepath, I don't think that's actually to blame.  And slow timeouts when it doesn't look CPU or IO bound smells a little like something happening in hypervisor land -- I'm assuming this is some sort of cloud host?  Maybe try a quick reboot to see if that shakes anything out?</p>",
        "id": 1558085,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682711737
    },
    {
        "content": "<p>This is KVM machine running in my private cloud based on proxmox</p>",
        "id": 1558087,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711767
    },
    {
        "content": "<p>Il try  a reboot</p>",
        "id": 1558088,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711772
    },
    {
        "content": "<p>I can't quite tell from timestamps on the emails you showed, but was the first timeout from <em>before</em> you upgraded?</p>",
        "id": 1558089,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682711774
    },
    {
        "content": "<p>I am not sure to say exactly</p>",
        "id": 1558091,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711852
    },
    {
        "content": "<p>I think they might be all after reboot</p>",
        "id": 1558093,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711860
    },
    {
        "content": "<p>upgrade sorry</p>",
        "id": 1558094,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682711864
    },
    {
        "content": "<p>Upgrade was at <code>2023-04-28 16:24:27</code> (presumably UTC)</p>",
        "id": 1558096,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682711875
    },
    {
        "content": "<p>So its all after upgrade then</p>",
        "id": 1558104,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682712307
    },
    {
        "content": "<p>Hm, OK, that points back to the upgrade.  But I'm a little stumped on the mechanism of action.</p>",
        "id": 1558111,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682712444
    },
    {
        "content": "<p>Only thing I notice is that the app is also sluggish from time to time, and. increases CPU usage a lot, speaking on my macbook</p>",
        "id": 1558116,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682712539
    },
    {
        "content": "<p><a href=\"/user_uploads/2/be/CcljyvoUeqieqFDWoijetM-p/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/be/CcljyvoUeqieqFDWoijetM-p/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/be/CcljyvoUeqieqFDWoijetM-p/image.png\"></a></div>",
        "id": 1558117,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682712541
    },
    {
        "content": "<p><a href=\"/user_uploads/2/3c/EVoKL5QE6JXbxBsYsqfD_pIv/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/3c/EVoKL5QE6JXbxBsYsqfD_pIv/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/3c/EVoKL5QE6JXbxBsYsqfD_pIv/image.png\"></a></div>",
        "id": 1558120,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682712630
    },
    {
        "content": "<p>Wonder if the app has something to do with it</p>",
        "id": 1558124,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682712828
    },
    {
        "content": "<p>Cause its increasing CPU only by switching users DMs, or changing the server. I have 2 servers only, this and mine.</p>",
        "id": 1558125,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682712859
    },
    {
        "content": "<p><a href=\"/user_uploads/2/2a/nB3jZp50wPTnlBPOQUmpMYfq/image.png\">image.png</a><br>\nthis is a bit weird.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/2a/nB3jZp50wPTnlBPOQUmpMYfq/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/2a/nB3jZp50wPTnlBPOQUmpMYfq/image.png\"></a></div>",
        "id": 1558129,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682712961
    },
    {
        "content": "<p>Seems the app might have some Memory leaks and some CPU hogs</p>",
        "id": 1558130,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682712983
    },
    {
        "content": "<p>Virtual memory size doesn't mean anything (my laptop has 10 Chrome tabs over 1TB of virtual memory right now); the real/shared memory sizes are reasonable.</p>",
        "id": 1558135,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1682713308
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span> can you send <code>top</code> output from the server?</p>",
        "id": 1558137,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1682713349
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>top<span class=\"w\"> </span>-<span class=\"w\"> </span><span class=\"m\">20</span>:23:53<span class=\"w\"> </span>up<span class=\"w\"> </span><span class=\"m\">26</span><span class=\"w\"> </span>min,<span class=\"w\">  </span><span class=\"m\">1</span><span class=\"w\"> </span>user,<span class=\"w\">  </span>load<span class=\"w\"> </span>average:<span class=\"w\"> </span><span class=\"m\">0</span>.01,<span class=\"w\"> </span><span class=\"m\">0</span>.04,<span class=\"w\"> </span><span class=\"m\">0</span>.16\nTasks:<span class=\"w\"> </span><span class=\"m\">225</span><span class=\"w\"> </span>total,<span class=\"w\">   </span><span class=\"m\">1</span><span class=\"w\"> </span>running,<span class=\"w\"> </span><span class=\"m\">224</span><span class=\"w\"> </span>sleeping,<span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\"> </span>stopped,<span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\"> </span>zombie\n%Cpu<span class=\"o\">(</span>s<span class=\"o\">)</span>:<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>us,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>sy,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>ni,100.0<span class=\"w\"> </span>id,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>wa,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>hi,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>si,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>st\nMiB<span class=\"w\"> </span>Mem<span class=\"w\"> </span>:<span class=\"w\">   </span><span class=\"m\">3982</span>.8<span class=\"w\"> </span>total,<span class=\"w\">    </span><span class=\"m\">189</span>.6<span class=\"w\"> </span>free,<span class=\"w\">   </span><span class=\"m\">3531</span>.1<span class=\"w\"> </span>used,<span class=\"w\">    </span><span class=\"m\">262</span>.2<span class=\"w\"> </span>buff/cache\nMiB<span class=\"w\"> </span>Swap:<span class=\"w\">      </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>total,<span class=\"w\">      </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>free,<span class=\"w\">      </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>used.<span class=\"w\">    </span><span class=\"m\">154</span>.5<span class=\"w\"> </span>avail<span class=\"w\"> </span>Mem\n\n<span class=\"w\">    </span>PID<span class=\"w\"> </span>USER<span class=\"w\">      </span>PR<span class=\"w\">  </span>NI<span class=\"w\">    </span>VIRT<span class=\"w\">    </span>RES<span class=\"w\">    </span>SHR<span class=\"w\"> </span>S<span class=\"w\">  </span>%CPU<span class=\"w\">  </span>%MEM<span class=\"w\">     </span>TIME+<span class=\"w\"> </span>COMMAND\n<span class=\"w\">   </span><span class=\"m\">1350</span><span class=\"w\"> </span>zulip<span class=\"w\">     </span><span class=\"m\">20</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"m\">1606856</span><span class=\"w\">   </span><span class=\"m\">9436</span><span class=\"w\">   </span><span class=\"m\">5184</span><span class=\"w\"> </span>S<span class=\"w\">   </span><span class=\"m\">0</span>.3<span class=\"w\">   </span><span class=\"m\">0</span>.2<span class=\"w\">   </span><span class=\"m\">0</span>:03.83<span class=\"w\"> </span>smokescreen-83e\n<span class=\"w\">      </span><span class=\"m\">1</span><span class=\"w\"> </span>root<span class=\"w\">      </span><span class=\"m\">20</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">168244</span><span class=\"w\">   </span><span class=\"m\">8224</span><span class=\"w\">   </span><span class=\"m\">5008</span><span class=\"w\"> </span>S<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>.2<span class=\"w\">   </span><span class=\"m\">0</span>:01.88<span class=\"w\"> </span>systemd\n<span class=\"w\">      </span><span class=\"m\">2</span><span class=\"w\"> </span>root<span class=\"w\">      </span><span class=\"m\">20</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\"> </span>S<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>:00.00<span class=\"w\"> </span>kthreadd\n<span class=\"w\">      </span><span class=\"m\">3</span><span class=\"w\"> </span>root<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\"> </span>-20<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\"> </span>I<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>:00.00<span class=\"w\"> </span>rcu_gp\n<span class=\"w\">      </span><span class=\"m\">4</span><span class=\"w\"> </span>root<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\"> </span>-20<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\"> </span>I<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>:00.00<span class=\"w\"> </span>rcu_par_gp\n<span class=\"w\">      </span><span class=\"m\">6</span><span class=\"w\"> </span>root<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\"> </span>-20<span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\"> </span>I<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>:00.00<span class=\"w\"> </span>kworker/0:0H-kblockd\n<span class=\"w\">      </span><span class=\"m\">7</span><span class=\"w\"> </span>root<span class=\"w\">      </span><span class=\"m\">20</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">       </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\"> </span>I<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>.0<span class=\"w\">   </span><span class=\"m\">0</span>:00.08<span class=\"w\"> </span>kworker/u16:0-ev\n</code></pre></div>",
        "id": 1558140,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682713443
    },
    {
        "content": "<p>This definitely feels like memory pressure or perhaps load on the system. The actual database queries that are timing out are trivial.</p>",
        "id": 1558141,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1682713444
    },
    {
        "content": "<p>The server runs only Zulip</p>",
        "id": 1558142,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682713484
    },
    {
        "content": "<p><a href=\"http://\">Uploading image.png…</a></p>",
        "id": 1558145,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682713624
    },
    {
        "content": "<p>Is this normal?<br>\n<a href=\"http://\">Uploading image.png…</a></p>",
        "id": 1558151,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682713953
    },
    {
        "content": "<p>Yeah I get too the same issues, when uploading images, they seem like stuck</p>",
        "id": 1558152,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682713988
    },
    {
        "content": "<p>keep on saying uploading...</p>",
        "id": 1558153,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682714001
    },
    {
        "content": "<p><a href=\"/user_uploads/2/44/XGesneS_CME9BHhU-HTwa7gH/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/44/XGesneS_CME9BHhU-HTwa7gH/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/44/XGesneS_CME9BHhU-HTwa7gH/image.png\"></a></div>",
        "id": 1558177,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682715060
    },
    {
        "content": "<p>Is this normal?</p>",
        "id": 1558178,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682715065
    },
    {
        "content": "<p>They are even more, cant fit them all in one view</p>",
        "id": 1558179,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682715085
    },
    {
        "content": "<p>Erlang runs a lot of threads internally, so depending what you're using to show that, it may be normal.</p>",
        "id": 1558180,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1682715098
    },
    {
        "content": "<p>I remove snapd, and some remains from it, memory usage is better now.</p>",
        "id": 1558181,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682715099
    },
    {
        "content": "<p>Ok</p>",
        "id": 1558182,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682715108
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>top<span class=\"w\"> </span>-<span class=\"w\"> </span><span class=\"m\">20</span>:52:06<span class=\"w\"> </span>up<span class=\"w\"> </span><span class=\"m\">6</span><span class=\"w\"> </span>min,<span class=\"w\">  </span><span class=\"m\">1</span><span class=\"w\"> </span>user,<span class=\"w\">  </span>load<span class=\"w\"> </span>average:<span class=\"w\"> </span><span class=\"m\">0</span>.09,<span class=\"w\"> </span><span class=\"m\">0</span>.49,<span class=\"w\"> </span><span class=\"m\">0</span>.27\nTasks:<span class=\"w\"> </span><span class=\"m\">223</span><span class=\"w\"> </span>total,<span class=\"w\">   </span><span class=\"m\">1</span><span class=\"w\"> </span>running,<span class=\"w\"> </span><span class=\"m\">222</span><span class=\"w\"> </span>sleeping,<span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\"> </span>stopped,<span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\"> </span>zombie\n%Cpu<span class=\"o\">(</span>s<span class=\"o\">)</span>:<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>us,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>sy,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>ni,<span class=\"w\"> </span><span class=\"m\">99</span>.8<span class=\"w\"> </span>id,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>wa,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>hi,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>si,<span class=\"w\">  </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>st\nMiB<span class=\"w\"> </span>Mem<span class=\"w\"> </span>:<span class=\"w\">   </span><span class=\"m\">3982</span>.8<span class=\"w\"> </span>total,<span class=\"w\">    </span><span class=\"m\">153</span>.6<span class=\"w\"> </span>free,<span class=\"w\">   </span><span class=\"m\">3424</span>.0<span class=\"w\"> </span>used,<span class=\"w\">    </span><span class=\"m\">405</span>.2<span class=\"w\"> </span>buff/cache\nMiB<span class=\"w\"> </span>Swap:<span class=\"w\">      </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>total,<span class=\"w\">      </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>free,<span class=\"w\">      </span><span class=\"m\">0</span>.0<span class=\"w\"> </span>used.<span class=\"w\">    </span><span class=\"m\">261</span>.6<span class=\"w\"> </span>avail<span class=\"w\"> </span>Mem\n</code></pre></div>",
        "id": 1558184,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1682715148
    },
    {
        "content": "<p>The RES column in top is considerably more useful for what to sort by than the virtual memory one.</p>",
        "id": 1558190,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1682715529
    }
]