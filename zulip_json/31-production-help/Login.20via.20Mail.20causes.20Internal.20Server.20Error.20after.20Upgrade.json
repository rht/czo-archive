[
    {
        "content": "<p>Hi,<br>\nI am currently facing an Issue since my last Update to Zulip Server 5.7.<br>\nWhenever a User Authenticates himself with a Mailadress instead of a User, it creates the following Error.</p>\n<div class=\"codehilite\"><pre><span></span><code>2021-10-19 10:04:15.028 ERR  [django.request] Internal Server Error: /accounts/login/\nTraceback (most recent call last):\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/core/handlers/exception.py&quot;, line 47, in inner\n    response = get_response(request)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/core/handlers/base.py&quot;, line 181, in _get_response\n    response = wrapped_callback(request, *callback_args, **callback_kwargs)\n  File &quot;./zerver/lib/request.py&quot;, line 390, in _wrapped_view_func\n    return view_func(request, *args, **kwargs)\n  File &quot;./zerver/views/auth.py&quot;, line 752, in login_page\n    )(request)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/generic/base.py&quot;, line 70, in view\n    return self.dispatch(request, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py&quot;, line 43, in _wrapper\n    return bound_method(*args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/decorators/debug.py&quot;, line 89, in sensitive_post_parameters_wrapper\n    return view(request, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py&quot;, line 43, in _wrapper\n    return bound_method(*args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py&quot;, line 130, in _wrapped_view\n    response = view_func(request, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py&quot;, line 43, in _wrapper\n    return bound_method(*args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/decorators/cache.py&quot;, line 44, in _wrapped_view_func\n    response = view_func(request, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/auth/views.py&quot;, line 63, in dispatch\n    return super().dispatch(request, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/generic/base.py&quot;, line 98, in dispatch\n    return handler(request, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/generic/edit.py&quot;, line 141, in post\n    if form.is_valid():\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py&quot;, line 175, in is_valid\n    return self.is_bound and not self.errors\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py&quot;, line 170, in errors\n    self.full_clean()\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py&quot;, line 373, in full_clean\n    self._clean_form()\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py&quot;, line 400, in _clean_form\n    cleaned_data = self.clean()\n  File &quot;./zerver/forms.py&quot;, line 397, in clean\n    return_data=return_data,\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/views/decorators/debug.py&quot;, line 42, in sensitive_variables_wrapper\n    return func(*func_args, **func_kwargs)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/auth/__init__.py&quot;, line 76, in authenticate\n    user = backend.authenticate(request, **credentials)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/decorator.py&quot;, line 232, in fun\n    return caller(func, *(extras + args), **kw)\n  File &quot;./zproject/backends.py&quot;, line 285, in rate_limit_auth\n    result = auth_func(*args, **kwargs)\n  File &quot;./zproject/backends.py&quot;, line 788, in authenticate\n    username = self.django_to_ldap_username(username)\n  File &quot;./zproject/backends.py&quot;, line 543, in django_to_ldap_username\n    email_search_result = find_ldap_users_by_email(username)\n  File &quot;./zproject/backends.py&quot;, line 440, in find_ldap_users_by_email\n    return email_search.search_for_users(should_populate=False)\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py&quot;, line 342, in search_for_users\n    results = search.execute(self.connection, {&quot;email&quot;: self._email})\n  File &quot;/srv/zulip-venv-cache/681ca2d0acd1abbab0cc35f1d947ada79599a9ff/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/config.py&quot;, line 150, in execute\n    filterstr = self.filterstr % filterargs\nKeyError: &#39;user&#39;\n</code></pre></div>\n<p>The Users usually should authenticate with ldap usernames, so i am searching a way to disable the Login via mail in order to prevent this error.<br>\nI already tried this by commeting out the line \"'zproject.backends.EmailAuthBackend',  # Email and password; just requires SMTP setup\" like you can see below and resarting the Zulip Server</p>\n<div class=\"codehilite\"><pre><span></span><code>AUTHENTICATION_BACKENDS = (\n    # &#39;zproject.backends.EmailAuthBackend&#39;,  # Email and password; just requires SMTP setup\n    # &#39;zproject.backends.GoogleMobileOauth2Backend&#39;,  # Google Apps, setup below\n    # &#39;zproject.backends.GitHubAuthBackend&#39;,  # GitHub auth, setup below\n    # &#39;zproject.backends.AzureADAuthBackend&#39;,  # Microsoft Azure Active Directory auth, setup below\n    &#39;zproject.backends.ZulipLDAPAuthBackend&#39;,  # LDAP, setup below\n    # &#39;zproject.backends.ZulipRemoteUserBackend&#39;,  # Local SSO, setup docs on readthedocs\n</code></pre></div>\n<p>But the Error still comes up, if someone tries to authenticate via mail.</p>\n<p>Any help would be wonderful<br>\nThanks in advance!</p>",
        "id": 1268380,
        "sender_full_name": "Sven Lenhof",
        "timestamp": 1634642343
    },
    {
        "content": "<p>Did you setup the reverse Search option correctly?<br>\nDisabling E-Mail Login in the organisation settings could help you, too</p>",
        "id": 1268382,
        "sender_full_name": "Felix (strifel)",
        "timestamp": 1634643023
    },
    {
        "content": "<p>Thanks for the fast answer.</p>\n<p>actually there is only LDAP in the Organisation configured.<br>\nbut in the settings.py is the following line:<br>\n´´´<br>\nAUTH_LDAP_REVERSE_EMAIL_SEARCH = AUTH_LDAP_USER_SEARCH<br>\n´´´<br>\nShould this be commented out? I just need to be sure, im doing nothing wrong, cuz its a livesystem</p>",
        "id": 1268387,
        "sender_full_name": "Sven Lenhof",
        "timestamp": 1634644656
    },
    {
        "content": "<p>The <code>AUTH_LDAP_REVERSE_EMAIL_SEARCH</code> needs to be able to find a user by email address.<br>\n(While the <code>AUTH_LDAP_USER_SEARCH</code> should find them by username)</p>\n<p>The example from the documentation is</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">AUTH_LDAP_REVERSE_EMAIL_SEARCH</span> <span class=\"o\">=</span> <span class=\"n\">LDAPSearch</span><span class=\"p\">(</span><span class=\"s2\">\"ou=users,dc=example,dc=com\"</span><span class=\"p\">,</span>\n                                            <span class=\"n\">ldap</span><span class=\"o\">.</span><span class=\"n\">SCOPE_SUBTREE</span><span class=\"p\">,</span> <span class=\"s2\">\"(mail=</span><span class=\"si\">%(email)s</span><span class=\"s2\">)\"</span><span class=\"p\">)</span>\n</code></pre></div>",
        "id": 1268413,
        "sender_full_name": "Felix (strifel)",
        "timestamp": 1634650994
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"21906\">@Sven Lenhof</span> Making <code>AUTH_LDAP_REVERSE_EMAIL_SEARCH = AUTH_LDAP_USER_SEARCH</code> is wrong because <code>AUTH_LDAP_USER_SEARCH</code> uses <code>%(user)</code> in its experssion, while <code>AUTH_LDAP_REVERSE_EMAIL_SEARCH</code> needs <code>%(email)</code>, even if the search are otherwise synonymous. So e.g. you can have</p>\n<div class=\"codehilite\"><pre><span></span><code>AUTH_LDAP_USER_SEARCH = LDAPSearch(\n    &quot;ou=users,dc=example,dc=com&quot;, ldap.SCOPE_SUBTREE, &quot;(uid=%(user)s)&quot;\n)\nAUTH_LDAP_REVERSE_EMAIL_SEARCH = LDAPSearch(\n    &quot;ou=users,dc=example,dc=com&quot;, ldap.SCOPE_SUBTREE, &quot;(uid=%(email)s)&quot;\n)\n</code></pre></div>\n<p>if the username = the email address and is stored in the <code>uid</code> ldap attribute</p>",
        "id": 1268414,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1634651186
    }
]