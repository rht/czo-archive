[
    {
        "content": "<p>Hello, I'm trying to convince my company to switch to Zulip. Huge advantages for us to run the server locally, if I can manage to get it to work.<br>\nWe use Cloudflare. I created a subdomain and added a new DNS A-record pointing to 192.168.18.102 (a private address). I confirm it's resolving properly and the host is reachable.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>dig<span class=\"w\"> </span>confidant.domain.com\n\n<span class=\"p\">;</span><span class=\"w\"> </span>&lt;&lt;&gt;&gt;<span class=\"w\"> </span>DiG<span class=\"w\"> </span><span class=\"m\">9</span>.18.12-0ubuntu0.22.04.1-Ubuntu<span class=\"w\"> </span>&lt;&lt;&gt;&gt;<span class=\"w\"> </span>confidant.domain.com\n<span class=\"p\">;;</span><span class=\"w\"> </span>global<span class=\"w\"> </span>options:<span class=\"w\"> </span>+cmd\n<span class=\"p\">;;</span><span class=\"w\"> </span>Got<span class=\"w\"> </span>answer:\n<span class=\"p\">;;</span><span class=\"w\"> </span>-&gt;&gt;HEADER<span class=\"s\">&lt;&lt;- opco</span>de:<span class=\"w\"> </span>QUERY,<span class=\"w\"> </span>status:<span class=\"w\"> </span>NOERROR,<span class=\"w\"> </span>id:<span class=\"w\"> </span><span class=\"m\">7591</span>\n<span class=\"p\">;;</span><span class=\"w\"> </span>flags:<span class=\"w\"> </span>qr<span class=\"w\"> </span>rd<span class=\"w\"> </span>ra<span class=\"p\">;</span><span class=\"w\"> </span>QUERY:<span class=\"w\"> </span><span class=\"m\">1</span>,<span class=\"w\"> </span>ANSWER:<span class=\"w\"> </span><span class=\"m\">1</span>,<span class=\"w\"> </span>AUTHORITY:<span class=\"w\"> </span><span class=\"m\">0</span>,<span class=\"w\"> </span>ADDITIONAL:<span class=\"w\"> </span><span class=\"m\">1</span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span>OPT<span class=\"w\"> </span>PSEUDOSECTION:\n<span class=\"p\">;</span><span class=\"w\"> </span>EDNS:<span class=\"w\"> </span>version:<span class=\"w\"> </span><span class=\"m\">0</span>,<span class=\"w\"> </span>flags:<span class=\"p\">;</span><span class=\"w\"> </span>udp:<span class=\"w\"> </span><span class=\"m\">65494</span>\n<span class=\"p\">;;</span><span class=\"w\"> </span>QUESTION<span class=\"w\"> </span>SECTION:\n<span class=\"p\">;</span>confidant.domain.com.<span class=\"w\">  </span>IN<span class=\"w\">  </span>A\n\n<span class=\"p\">;;</span><span class=\"w\"> </span>ANSWER<span class=\"w\"> </span>SECTION:\nconfidant.domain.com.<span class=\"w\"> </span><span class=\"m\">300</span><span class=\"w\">   </span>IN<span class=\"w\">  </span>A<span class=\"w\">   </span><span class=\"m\">192</span>.168.18.102\n\n<span class=\"p\">;;</span><span class=\"w\"> </span>Query<span class=\"w\"> </span>time:<span class=\"w\"> </span><span class=\"m\">48</span><span class=\"w\"> </span>msec\n<span class=\"p\">;;</span><span class=\"w\"> </span>SERVER:<span class=\"w\"> </span><span class=\"m\">127</span>.0.0.53#53<span class=\"o\">(</span><span class=\"m\">127</span>.0.0.53<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>UDP<span class=\"o\">)</span>\n<span class=\"p\">;;</span><span class=\"w\"> </span>WHEN:<span class=\"w\"> </span>Wed<span class=\"w\"> </span>Jun<span class=\"w\"> </span><span class=\"m\">07</span><span class=\"w\"> </span><span class=\"m\">13</span>:51:33<span class=\"w\"> </span>EEST<span class=\"w\"> </span><span class=\"m\">2023</span>\n<span class=\"p\">;;</span><span class=\"w\"> </span>MSG<span class=\"w\"> </span>SIZE<span class=\"w\">  </span>rcvd:<span class=\"w\"> </span><span class=\"m\">68</span>\n</code></pre></div>\n<p>But when I try to install zulip it fails at </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>certbot<span class=\"w\"> </span>certonly<span class=\"w\"> </span>--webroot<span class=\"w\"> </span>--webroot-path<span class=\"o\">=</span>/var/lib/zulip/certbot-webroot/<span class=\"w\"> </span>-d<span class=\"w\"> </span>confidant.domain.com<span class=\"w\"> </span>-m<span class=\"w\"> </span>email@disroot.org<span class=\"w\"> </span>--force-interactive<span class=\"w\"> </span>--no-eff-email\nSaving<span class=\"w\"> </span>debug<span class=\"w\"> </span>log<span class=\"w\"> </span>to<span class=\"w\"> </span>/var/log/letsencrypt/letsencrypt.log\nPlugins<span class=\"w\"> </span>selected:<span class=\"w\"> </span>Authenticator<span class=\"w\"> </span>webroot,<span class=\"w\"> </span>Installer<span class=\"w\"> </span>None\nRequesting<span class=\"w\"> </span>a<span class=\"w\"> </span>certificate<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>confidant.domain.com\nPerforming<span class=\"w\"> </span>the<span class=\"w\"> </span>following<span class=\"w\"> </span>challenges:\nhttp-01<span class=\"w\"> </span>challenge<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>confidant.domain.com\nUsing<span class=\"w\"> </span>the<span class=\"w\"> </span>webroot<span class=\"w\"> </span>path<span class=\"w\"> </span>/var/lib/zulip/certbot-webroot<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>all<span class=\"w\"> </span>unmatched<span class=\"w\"> </span>domains.\nWaiting<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>verification...\nChallenge<span class=\"w\"> </span>failed<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>domain<span class=\"w\"> </span>confidant.domain.com\nhttp-01<span class=\"w\"> </span>challenge<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>confidant.domain.com\nCleaning<span class=\"w\"> </span>up<span class=\"w\"> </span>challenges\nSome<span class=\"w\"> </span>challenges<span class=\"w\"> </span>have<span class=\"w\"> </span>failed.\nIMPORTANT<span class=\"w\"> </span>NOTES:\n<span class=\"w\"> </span>-<span class=\"w\"> </span>The<span class=\"w\"> </span>following<span class=\"w\"> </span>errors<span class=\"w\"> </span>were<span class=\"w\"> </span>reported<span class=\"w\"> </span>by<span class=\"w\"> </span>the<span class=\"w\"> </span>server:\n\n<span class=\"w\">   </span>Domain:<span class=\"w\"> </span>confidant.domain.com\n<span class=\"w\">   </span>Type:<span class=\"w\">   </span>dns\n<span class=\"w\">   </span>Detail:<span class=\"w\"> </span>no<span class=\"w\"> </span>valid<span class=\"w\"> </span>A<span class=\"w\"> </span>records<span class=\"w\"> </span>found<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>confidant.domain.com<span class=\"p\">;</span><span class=\"w\"> </span>no\n<span class=\"w\">   </span>valid<span class=\"w\"> </span>AAAA<span class=\"w\"> </span>records<span class=\"w\"> </span>found<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>confidant.domain.com\n</code></pre></div>\n<p><span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> what did I miss? Any help appreciated, thanks.</p>",
        "id": 1588406,
        "sender_full_name": "Naim Abou Darwish",
        "timestamp": 1686217422
    },
    {
        "content": "<p>Certbot requires a public facing host and domain, if you are using the install script leave out the <code>--certbot</code> option</p>",
        "id": 1588627,
        "sender_full_name": "Justin René Back",
        "timestamp": 1686237947
    },
    {
        "content": "<p><a href=\"https://zulip.readthedocs.io/en/latest/production/ssl-certificates.html#self-signed-certificate\">https://zulip.readthedocs.io/en/latest/production/ssl-certificates.html#self-signed-certificate</a> might be your best option if the server is not public facing</p>",
        "id": 1588628,
        "sender_full_name": "Justin René Back",
        "timestamp": 1686238001
    },
    {
        "content": "<p>If you're putting it behind Cloudflare, and it's not public, then certbot won't be able to validate it using the http challenge.  You can use a DNS challenge with certbot, or use a self-signed certificate and turn off SSL validation from cloudflare.</p>",
        "id": 1588631,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1686238156
    },
    {
        "content": "<p>The problem was that certbot won't sign domains like <strong>.home</strong> or <strong>.local</strong>. I already tried <strong>--self-signed-cert</strong>, it was relatively straight forward to install but I could only get zulip on the browser.  To use the desktop client I'd have to manually install the certificates on everyone's laptops, too much work to test with the whole office.<br>\nIf I go the <strong>DNS challenge with certbot</strong> route I'd still need something like <strong>dyndns</strong> right?  <br>\nI think this is a common use case; to have Zulip on an internal local server. It would be nice to have some documentation for folks who've never dealt with SSL before.</p>",
        "id": 1589277,
        "sender_full_name": "Naim Abou Darwish",
        "timestamp": 1686302278
    },
    {
        "content": "<p>As some general networking matters (not specific to Zulip):</p>\n<ul>\n<li>\n<p>It is a design principle of the SSL certificate authority system that you can’t get a legitimate certificate for an unregistered domain. Otherwise, an attacker could get a certificate for the same unregistered domain, and intercept your connections.</p>\n</li>\n<li>\n<p>Do not use .local in any case—it is <a href=\"https://www.iana.org/assignments/special-use-domain-names/special-use-domain-names.xhtml\">reserved</a> for <a href=\"https://www.rfc-editor.org/rfc/rfc6762.html\">multicast DNS</a>, and any other usage of .local will break things with macOS systems. See <a href=\"https://www.rfc-editor.org/rfc/rfc6762#appendix-G\">RFC 6762 appendix G</a> for a list of specific unregistered domains designated as unlikely to conflict with reserved uses.</p>\n</li>\n</ul>",
        "id": 1589657,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1686336247
    }
]