[
    {
        "content": "<p><a href=\"https://github.com/zulip/zulip/issues/26349\">https://github.com/zulip/zulip/issues/26349</a></p>\n<blockquote>\n<p>I've already upgraded and built the <code>docker-zulip</code> to <code>refs/remotes/origin/zulip-cloud-current</code> following <a href=\"https://github.com/zulip/docker-zulip/blob/main/UPGRADING.md#upgrading-from-a-git-repository\">https://github.com/zulip/docker-zulip/blob/main/UPGRADING.md#upgrading-from-a-git-repository</a></p>\n<p><div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">07</span><span class=\"o\">-</span><span class=\"mi\">25</span> <span class=\"mi\">09</span><span class=\"p\">:</span><span class=\"mi\">42</span><span class=\"p\">:</span><span class=\"mf\">20.909</span> <span class=\"n\">INFO</span> <span class=\"p\">[]</span> <span class=\"n\">Importing</span> <span class=\"n\">attachment</span> <span class=\"n\">data</span> <span class=\"kn\">from</span> <span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">/</span><span class=\"n\">zulip</span><span class=\"o\">-</span><span class=\"n\">export</span><span class=\"o\">-</span><span class=\"n\">s5nsij46</span><span class=\"o\">/</span><span class=\"n\">attachment</span><span class=\"o\">.</span><span class=\"n\">json</span>\n<span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"./manage.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">150</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"o\">&lt;</span><span class=\"n\">module</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">execute_from_command_line</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">argv</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"./manage.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">115</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute_from_command_line</span>\n    <span class=\"n\">utility</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">436</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetch_command</span><span class=\"p\">(</span><span class=\"n\">subcommand</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">run_from_argv</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">argv</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">412</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">run_from_argv</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">cmd_options</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/ac628ea947ad0e5668a12a89aaa06f69c19fee56/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">458</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute</span>\n    <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">options</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2023-07-25-08-34-03/zerver/management/commands/import.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">101</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">handle</span>\n    <span class=\"n\">do_import_realm</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">subdomain</span><span class=\"p\">,</span> <span class=\"n\">num_processes</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2023-07-25-08-34-03/zerver/lib/import_realm.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1381</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">do_import_realm</span>\n    <span class=\"n\">import_attachments</span><span class=\"p\">(</span><span class=\"n\">attachment_data</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2023-07-25-08-34-03/zerver/lib/import_realm.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1594</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">import_attachments</span>\n    <span class=\"n\">attachment</span><span class=\"p\">[</span><span class=\"s2\">\"path_id\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">path_maps</span><span class=\"p\">[</span><span class=\"s2\">\"attachment_path\"</span><span class=\"p\">][</span><span class=\"n\">attachment</span><span class=\"p\">[</span><span class=\"s2\">\"path_id\"</span><span class=\"p\">]]</span>\n<span class=\"ne\">KeyError</span><span class=\"p\">:</span> <span class=\"s1\">'45099/DCepzIc7ZRGbRjXXGG6xDNHC/image.png'</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 1615532,
        "sender_full_name": "n0099",
        "timestamp": 1690285978
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"27436\">@n0099</span>: Is there a <code>45099/DCepzIc7ZRGbRjXXGG6xDNHC/image.png</code> in your export tarball?</p>\n<p>Are you willing to share (via DMs, if you prefer) the organization name in Zulip Cloud so I can check what the export generates?</p>",
        "id": 1615615,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1690295652
    },
    {
        "content": "<p><a href=\"https://n0099.zulipchat.com\">https://n0099.zulipchat.com</a></p>",
        "id": 1615638,
        "sender_full_name": "n0099",
        "timestamp": 1690296920
    },
    {
        "content": "<p>It's not exists in the exported tarball.</p>",
        "id": 1615640,
        "sender_full_name": "n0099",
        "timestamp": 1690297042
    },
    {
        "content": "<p>I can replicate that it's missing in a fresh export; since the message matching it <em>is</em> in the export, that's clearly a bug.</p>",
        "id": 1615833,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1690311939
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"27436\">@n0099</span>: We've determined that the file in question is missing from our S3 backing store, and we're investigating how that happened.  We'll let you know when we know more.</p>",
        "id": 1616226,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1690346339
    },
    {
        "content": "<p>Thanks</p>",
        "id": 1616291,
        "sender_full_name": "n0099",
        "timestamp": 1690350499
    },
    {
        "content": "<p>and there's even more files that are missing from the exported tarball and s3 storage on <a href=\"https://n0099.zulipchat.com/user_uploads\">https://n0099.zulipchat.com/user_uploads</a></p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>jq<span class=\"w\"> </span><span class=\"s1\">'.zerver_attachment[].path_id'</span><span class=\"w\"> </span>-r<span class=\"w\"> </span>attachment.json<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>xargs<span class=\"w\"> </span>-I<span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span>stat<span class=\"w\"> </span>uploads/<span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>not\nstat:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>stat<span class=\"w\"> </span><span class=\"s1\">'uploads/45099/DCepzIc7ZRGbRjXXGG6xDNHC/image.png'</span>:<span class=\"w\"> </span>No<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"w\"> </span>or<span class=\"w\"> </span>directory\nstat:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>stat<span class=\"w\"> </span><span class=\"s1\">'uploads/45099/yOxd_PN4TxwIqAkTUBrTdREQ/25b850c5-eba2-4bd3-acf8-258a993d6e18.jpg'</span>:<span class=\"w\"> </span>No<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"w\"> </span>or<span class=\"w\"> </span>directory\nstat:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>stat<span class=\"w\"> </span><span class=\"s1\">'uploads/45099/QvhHXTIRhLyQ6yGbbp5N3v3G/Screenshot_20221012-084748.png'</span>:<span class=\"w\"> </span>No<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"w\"> </span>or<span class=\"w\"> </span>directory\nstat:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>stat<span class=\"w\"> </span><span class=\"s1\">'uploads/45099/OxaIFaTh1NMF6XvgTfYKoViQ/image.png'</span>:<span class=\"w\"> </span>No<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"w\"> </span>or<span class=\"w\"> </span>directory\nstat:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>stat<span class=\"w\"> </span><span class=\"s1\">'uploads/45099/pxUaYM8CQAcKsuMIM4vy2mIg/image.png'</span>:<span class=\"w\"> </span>No<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"w\"> </span>or<span class=\"w\"> </span>directory\nstat:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>stat<span class=\"w\"> </span><span class=\"s1\">'uploads/45099/gt-wxVqLRjI88qbZLUyk6NkS/image.png'</span>:<span class=\"w\"> </span>No<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"w\"> </span>or<span class=\"w\"> </span>directory\nstat:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>stat<span class=\"w\"> </span><span class=\"s1\">'uploads/45099/D30bw_Z6HlWwhGEyReYbicdJ/image.png'</span>:<span class=\"w\"> </span>No<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"w\"> </span>or<span class=\"w\"> </span>directory\nstat:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>stat<span class=\"w\"> </span><span class=\"s1\">'uploads/45099/aHGx810flcBoiAUiGbs29iEL/image.png'</span>:<span class=\"w\"> </span>No<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"w\"> </span>or<span class=\"w\"> </span>directory\n</code></pre></div>",
        "id": 1616984,
        "sender_full_name": "n0099",
        "timestamp": 1690442246
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>comm<span class=\"w\"> </span>-3<span class=\"w\"> </span>&lt;<span class=\"o\">(</span>jq<span class=\"w\"> </span><span class=\"s1\">'.zerver_attachment[].path_id'</span><span class=\"w\"> </span>-r<span class=\"w\"> </span>attachment.json<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>sort<span class=\"o\">)</span><span class=\"w\"> </span>&lt;<span class=\"o\">(</span>find<span class=\"w\"> </span>uploads<span class=\"w\"> </span>-type<span class=\"w\"> </span>f<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>cut<span class=\"w\"> </span>-d/<span class=\"w\"> </span>-f2-<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>sort<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>-v<span class=\"w\"> </span>records.json<span class=\"o\">)</span>\n<span class=\"m\">45099</span>/D30bw_Z6HlWwhGEyReYbicdJ/image.png\n<span class=\"m\">45099</span>/DCepzIc7ZRGbRjXXGG6xDNHC/image.png\n<span class=\"m\">45099</span>/OxaIFaTh1NMF6XvgTfYKoViQ/image.png\n<span class=\"m\">45099</span>/QvhHXTIRhLyQ6yGbbp5N3v3G/Screenshot_20221012-084748.png\n<span class=\"m\">45099</span>/aHGx810flcBoiAUiGbs29iEL/image.png\n<span class=\"m\">45099</span>/gt-wxVqLRjI88qbZLUyk6NkS/image.png\n<span class=\"m\">45099</span>/pxUaYM8CQAcKsuMIM4vy2mIg/image.png\n<span class=\"m\">45099</span>/yOxd_PN4TxwIqAkTUBrTdREQ/25b850c5-eba2-4bd3-acf8-258a993d6e18.jpg\n</code></pre></div>",
        "id": 1616985,
        "sender_full_name": "n0099",
        "timestamp": 1690443614
    },
    {
        "content": "<p>To remove missing files from <code>attachment.json</code> to allow the importing:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>jq<span class=\"w\"> </span><span class=\"s1\">'del(.zerver_attachment[] | select(.path_id == $missing[]))'</span><span class=\"w\"> </span>--argjson<span class=\"w\"> </span>missing<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"k\">$(</span>comm<span class=\"w\"> </span>-3<span class=\"w\"> </span>&lt;<span class=\"o\">(</span>cat<span class=\"w\"> </span>attachment.json<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>jq<span class=\"w\"> </span><span class=\"s1\">'.zerver_attachment[].path_id'</span><span class=\"w\"> </span>-r<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>sort<span class=\"k\">)</span><span class=\"s2\"> &lt;(find uploads -type f | cut -d/ -f2- | sort | grep -v records.json) | jq --raw-input . | jq --slurp .)\"</span><span class=\"w\"> </span>-r<span class=\"w\"> </span>attachment.json<span class=\"w\"> </span>&gt;<span class=\"w\"> </span>attachment.json.2\n</code></pre></div>",
        "id": 1616988,
        "sender_full_name": "n0099",
        "timestamp": 1690445241
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"27436\">@n0099</span>: We've confirmed that we unfortunately improperly deleted a small number of files from S3 which should not have been deleted (<a href=\"https://github.com/zulip/zulip/pull/26377\">#26377</a> has the gory details).  We do not have a way to reconstruct those files, sadly.</p>\n<p>We'll be posting a blog post and sending out email to the affected users, yourself included, this week.</p>",
        "id": 1618501,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1690902738
    },
    {
        "content": "<p>Sorry to hear that it's not only affecting my organization.</p>",
        "id": 1618502,
        "sender_full_name": "n0099",
        "timestamp": 1690903427
    },
    {
        "content": "<p>We're extremely sorry to have lost the data. <span aria-label=\"frown\" class=\"emoji emoji-1f641\" role=\"img\" title=\"frown\">:frown:</span></p>\n<p>Thank you for bringing it to our attention -- your report was what allowed us to find the issue.</p>",
        "id": 1618504,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1690903952
    }
]