[
    {
        "content": "<div class=\"codehilite\"><pre><span></span>root@zulip-bots-playground:~# /home/zulip/deployments/current/scripts/upgrade-zulip-from-git master\n2018-06-08 17:52:33,768 upgrade-zulip-from-git: Fetching the latest commits\n2018-06-08 17:52:41,979 upgrade-zulip-stage-2: Upgrading system packages...\nHit:1 http://security.ubuntu.com/ubuntu xenial-security InRelease\nHit:2 http://nyc2.mirrors.digitalocean.com/ubuntu xenial InRelease\nHit:3 http://ppa.launchpad.net/tabbott/zulip/ubuntu xenial InRelease\nHit:4 http://nyc2.mirrors.digitalocean.com/ubuntu xenial-updates InRelease\nHit:5 http://nyc2.mirrors.digitalocean.com/ubuntu xenial-backports InRelease\nReading package lists... Done\nReading package lists... Done\nBuilding dependency tree\nReading state information... Done\nCalculating upgrade... Done\nThe following packages were automatically installed and are no longer required:\n  grub-pc-bin linux-headers-4.4.0-104 linux-headers-4.4.0-104-generic linux-headers-4.4.0-108\n  linux-headers-4.4.0-108-generic linux-headers-4.4.0-109 linux-headers-4.4.0-109-generic linux-headers-4.4.0-112\n  linux-headers-4.4.0-112-generic linux-headers-4.4.0-119 linux-headers-4.4.0-119-generic linux-headers-4.4.0-121\n  linux-headers-4.4.0-121-generic linux-image-4.4.0-104-generic linux-image-4.4.0-108-generic\n  linux-image-4.4.0-109-generic linux-image-4.4.0-112-generic linux-image-4.4.0-119-generic\n  linux-image-4.4.0-121-generic\nUse &#39;apt autoremove&#39; to remove them.\nThe following packages have been kept back:\n  open-vm-tools\n0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.\n+ apt-get -y install build-essential libffi-dev libfreetype6-dev zlib1g-dev libjpeg-dev libldap2-dev libmemcached-dev python3-dev python-dev python3-pip python-pip python-virtualenv python3-six python-six libxml2-dev libxslt1-dev libpq-dev virtualenv\nReading package lists... Done\nBuilding dependency tree\nReading state information... Done\nbuild-essential is already the newest version (12.1ubuntu2).\nlibffi-dev is already the newest version (3.2.1-4).\nlibjpeg-dev is already the newest version (8c-2ubuntu8).\nlibmemcached-dev is already the newest version (1.0.18-4.1).\npython-six is already the newest version (1.10.0-3).\npython3-dev is already the newest version (3.5.1-3).\npython3-six is already the newest version (1.10.0-3).\nlibfreetype6-dev is already the newest version (2.6.1-0.1ubuntu2.3).\nlibldap2-dev is already the newest version (2.4.42+dfsg-2ubuntu3.3).\nlibpq-dev is already the newest version (9.5.13-0ubuntu0.16.04).\nlibxml2-dev is already the newest version (2.9.3+dfsg1-1ubuntu0.5).\nlibxslt1-dev is already the newest version (1.1.28-2.1ubuntu0.1).\npython-dev is already the newest version (2.7.12-1~16.04).\nzlib1g-dev is already the newest version (1:1.2.8.dfsg-2ubuntu4.1).\npython-pip is already the newest version (8.1.1-2ubuntu0.4).\npython-virtualenv is already the newest version (15.0.1+ds-3ubuntu1).\npython3-pip is already the newest version (8.1.1-2ubuntu0.4).\nvirtualenv is already the newest version (15.0.1+ds-3ubuntu1).\nThe following packages were automatically installed and are no longer required:\n  grub-pc-bin linux-headers-4.4.0-104 linux-headers-4.4.0-104-generic linux-headers-4.4.0-108\n  linux-headers-4.4.0-108-generic linux-headers-4.4.0-109 linux-headers-4.4.0-109-generic linux-headers-4.4.0-112\n  linux-headers-4.4.0-112-generic linux-headers-4.4.0-119 linux-headers-4.4.0-119-generic linux-headers-4.4.0-121\n  linux-headers-4.4.0-121-generic linux-image-4.4.0-104-generic linux-image-4.4.0-108-generic\n  linux-image-4.4.0-109-generic linux-image-4.4.0-112-generic linux-image-4.4.0-119-generic\n  linux-image-4.4.0-121-generic\nUse &#39;apt autoremove&#39; to remove them.\n0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.\nUsing cached Python venv from /srv/zulip-venv-cache/c33157e33f152726906b020807f7608b05fc019e/zulip-py3-venv\n+ sudo ln -nsf /srv/zulip-venv-cache/c33157e33f152726906b020807f7608b05fc019e/zulip-py3-venv /home/zulip/deployments/2018-06-08-17-52-33/zulip-py3-venv\n+ ln -nsf zulip-py3-venv /home/zulip/deployments/2018-06-08-17-52-33/zulip-current-venv\nv8.11.1 is already installed.\nNow using node v8.11.1 (npm v5.6.0)\ndefault -&gt; 8.11.1 (-&gt; v8.11.1)\nInstalling Yarn!\nYarn is already at the 1.7.0 version.\nGenerated Camo config file /etc/default/camo\ngenerate_secrets: No new secrets to generate.\n2018-06-08 17:53:11,998 upgrade-zulip-stage-2: Building static assets...\n+ mkdir -p var/log\nCached version not found! Installing node modules.\n+ mkdir -p /srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081\n+ cp package.json yarn.lock /srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081\n+ /home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/cd_exec /srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081 /srv/zulip-yarn/bin/yarn install --non-interactive --prod\n\nError running a subcommand of ./tools/update-prod-static: /home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/cd_exec /srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081 /srv/zulip-yarn/bin/yarn install --non-interactive --prod\nActual error output for the subcommand is just above this.\n\nTraceback (most recent call last):\n  File &quot;./tools/update-prod-static&quot;, line 37, in &lt;module&gt;\n    setup_node_modules(production=True, stdout=fp, stderr=fp)\n  File &quot;./tools/../scripts/lib/node_cache.py&quot;, line 65, in setup_node_modules\n    copy_modules=copy_modules)\n  File &quot;./tools/../scripts/lib/node_cache.py&quot;, line 98, in do_yarn_install\n    run(cmd, stdout=stdout, stderr=stderr)\n  File &quot;./tools/../scripts/lib/zulip_tools.py&quot;, line 163, in run\n    subprocess.check_call(args, **kwargs)\n  File &quot;/usr/lib/python3.5/subprocess.py&quot;, line 581, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/cd_exec&#39;, &#39;/srv/zulip-npm-cache/26f0fcbab2c8f53a6cfc79c0fa01484a3fbf1081&#39;, &#39;/srv/zulip-yarn/bin/yarn&#39;, &#39;install&#39;, &#39;--non-interactive&#39;, &#39;--prod&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/upgrade-zulip-stage-2&quot;, line 81, in &lt;module&gt;\n    preexec_fn=su_to_zulip)\n  File &quot;/usr/lib/python3.5/subprocess.py&quot;, line 581, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;./tools/update-prod-static&#39;, &#39;--authors-not-required&#39;, &#39;--prev-deploy&#39;, &#39;/home/zulip/deployments/current&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/current/scripts/upgrade-zulip-from-git&quot;, line 71, in &lt;module&gt;\n    deploy_path, &quot;--from-git&quot;] + deploy_options)\n  File &quot;/usr/lib/python3.5/subprocess.py&quot;, line 581, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2018-06-08-17-52-33/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2018-06-08-17-52-33&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1\n</pre></div>\n\n\n<p>(This is for <a href=\"http://playground.zulipdev.org\" target=\"_blank\" title=\"http://playground.zulipdev.org\">playground.zulipdev.org</a>.)</p>\n<p>For some reason a <code>/var/log/zulip/upgrade.log</code> doesn't exist.</p>",
        "id": 596873,
        "sender_full_name": "Robert HÃ¶nig",
        "timestamp": 1528481058
    },
    {
        "content": "<p>check <code>var/log/update-prod-static.log</code> inside <code>/home/zulip/deployments/next</code>.</p>",
        "id": 596876,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1528481260
    },
    {
        "content": "<p>I tried running the upgrade script again and got a different error this time:</p>\n<div class=\"codehilite\"><pre><span></span>root@zulip-bots-playground:~# /home/zulip/deployments/current/scripts/upgrade-zulip-from-git master\n\n...(excluded output because the message would have been too long)\n\n2018-06-11 18:17:32,101 upgrade-zulip-stage-2: Applying database migrations...\nOperations to perform:\n  Apply all migrations: analytics, auth, confirmation, contenttypes, otp_static, otp_totp, sessions, sites, social_django, two_factor, zerver\nRunning migrations:\n  Applying zerver.0170_submessage...Traceback (most recent call last):\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/db/backends/utils.py&quot;, line 62, in execute\n    return self.cursor.execute(sql)\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zerver/lib/db.py&quot;, line 33, in execute\n    return wrapper_execute(self, super().execute, query, vars)\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zerver/lib/db.py&quot;, line 20, in wrapper_execute\n    return action(sql, params)\npsycopg2.ProgrammingError: relation &quot;zerver_submessage&quot; already exists\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File &quot;./manage.py&quot;, line 25, in &lt;module&gt;\n    execute_from_command_line(sys.argv)\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/__init__.py&quot;, line 364, in execute_from_command_line\n    utility.execute()\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/__init__.py&quot;, line 356, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/base.py&quot;, line 283, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/base.py&quot;, line 330, in execute\n    output = self.handle(*args, **options)\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/core/management/commands/migrate.py&quot;, line 204, in handle\n    fake_initial=fake_initial,\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/db/migrations/executor.py&quot;, line 115, in migrate\n    state = self._migrate_all_forwards(state, plan, full_plan, fake=fake, fake_initial=fake_initial)\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/zulip-py3-venv/lib/python3.5/site-packages/django/db/migrations/executor.py&quot;, line 145, in _migrate_all_forwards\n    state = self.apply_migration(state, migration, fake=fake, fake_initial=fake_initial)\n  File &quot;/home/zulip/deployments/2018-06-11-18-11-02/\n</pre></div>",
        "id": 597546,
        "sender_full_name": "Robert HÃ¶nig",
        "timestamp": 1528742129
    },
    {
        "content": "<p>To give some background on this: Initially, I ran the upgrade script , but accidentally still had my <code>zulip.conf</code> set to a personal branch of mine, instead of zulip master. This error occurred after I re-ran it  a couple times on <code>zulip/master</code>.</p>",
        "id": 598075,
        "sender_full_name": "Robert HÃ¶nig",
        "timestamp": 1528806834
    },
    {
        "content": "<p>Ah, that background helps.</p>\n<p>It looks like the migration system is trying to run a migration <code>0170_submessage</code>, but you already have effectively run some version of that migration. Maybe your previous branch had that migration under another name?</p>",
        "id": 598354,
        "sender_full_name": "Greg Price",
        "timestamp": 1528826757
    },
    {
        "content": "<p>Probably you want to sort out the migration situation directly, then rerun the upgrade script.</p>",
        "id": 598356,
        "sender_full_name": "Greg Price",
        "timestamp": 1528826826
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"801\">@Robert HÃ¶nig</span> <code>manage.py showmigrations</code>  is helpful</p>",
        "id": 599667,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1529014356
    },
    {
        "content": "<p>I think it's possibly you'll end up wanting to do some version of using <code>manage.py migrate --fake</code>, but it's hard to know without seeing where you're starting.</p>",
        "id": 599668,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1529014385
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"73\">@Tim April</span> thanks, <code>./manage.py migrate --fake</code> pointed in the right direction. What I think happeneed is that on my first trial, only one migration was applied to the database. I faked that  onemigration with <code>./manage.py migrate --fake zerver 0170</code>. Afterwards, running the normal upgrade script for a git repo worked fine.</p>",
        "id": 599945,
        "sender_full_name": "Robert HÃ¶nig",
        "timestamp": 1529087440
    },
    {
        "content": "<p>I meant <span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> .</p>",
        "id": 599946,
        "sender_full_name": "Robert HÃ¶nig",
        "timestamp": 1529087465
    },
    {
        "content": "<p>Great <span class=\"emoji emoji-1f603\" title=\"smiley\">:smiley:</span></p>",
        "id": 600074,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1529151318
    }
]