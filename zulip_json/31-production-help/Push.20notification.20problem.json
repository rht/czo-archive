[
    {
        "content": "<p>Hi,</p>\n<p>My enviroment: zulip run in docker, connection to internet via proxy</p>\n<p>After last update to zulip version 4.2 I lost mobile push notification.<br>\nConnection to internet is working properly. I try re register my server and tha operation was success. But when system try to send mobile push notification timeout is occurred. What can be wrong ?</p>\n<p>'Logger root, from module zerver.worker.queue_processors line 354:<br>\nError generated by Anonymous user (not logged in) on e1631c66da56 deployment</p>\n<p>Traceback (most recent call last):<br>\n  File \"/home/zulip/deployments/2021-06-03-21-00-31/zerver/worker/queue_processors.py\", line 299, in do_consume<br>\n    consume_func(events)<br>\n  File \"/home/zulip/deployments/2021-06-03-21-00-31/zerver/worker/queue_processors.py\", line 339, in &lt;lambda&gt;<br>\n    consume_func = lambda events: self.consume(events[0])<br>\n  File \"/home/zulip/deployments/2021-06-03-21-00-31/zerver/worker/queue_processors.py\", line 666, in consume<br>\n    handle_push_notification(event[\"user_profile_id\"], event)<br>\n  File \"/home/zulip/deployments/2021-06-03-21-00-31/zerver/decorator.py\", line 830, in wrapped_func<br>\n    ret = func(*args, **kwargs)<br>\n  File \"/home/zulip/deployments/2021-06-03-21-00-31/zerver/lib/push_notifications.py\", line 907, in handle_push_notification<br>\n    send_notifications_to_bouncer(user_profile_id, apns_payload, gcm_payload, gcm_options)<br>\n  File \"/home/zulip/deployments/2021-06-03-21-00-31/zerver/lib/push_notifications.py\", line 407, in send_notifications_to_bouncer<br>\n    send_json_to_push_bouncer(\"POST\", \"push/notify\", post_data)<br>\n  File \"/home/zulip/deployments/2021-06-03-21-00-31/zerver/lib/remote_server.py\", line 104, in send_json_to_push_bouncer<br>\n    send_to_push_bouncer(<br>\n  File \"/home/zulip/deployments/2021-06-03-21-00-31/zerver/lib/remote_server.py\", line 57, in send_to_push_bouncer<br>\n    res = requests.request(<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/requests/api.py\", line 61, in request<br>\n    return session.request(method=method, url=url, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/requests/sessions.py\", line 542, in request<br>\n    resp = self.send(prep, **send_kwargs)<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/requests/sessions.py\", line 655, in send<br>\n    r = adapter.send(request, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/requests/adapters.py\", line 439, in send<br>\n    resp = conn.urlopen(<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 699, in urlopen<br>\n    httplib_response = self._make_request(<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 382, in _make_request<br>\n    self._validate_conn(conn)<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connectionpool.py\", line 1010, in _validate_conn<br>\n    conn.connect()<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connection.py\", line 353, in connect<br>\n    conn = self._new_conn()<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/connection.py\", line 169, in _new_conn<br>\n    conn = connection.create_connection(<br>\n  File \"/srv/zulip-venv-cache/32fcc960bfb7387aa422d8595f3e85936ecbc5eb/zulip-py3-venv/lib/python3.8/site-packages/urllib3/util/connection.py\", line 86, in create_connection<br>\n    sock.connect(sa)<br>\n  File \"/home/zulip/deployments/2021-06-03-21-00-31/zerver/worker/queue_processors.py\", line 201, in timer_expired<br>\n    raise WorkerTimeoutException(limit, event_count)<br>\nzerver.worker.queue_processors.WorkerTimeoutException: Timed out after 30 seconds processing 1 events</p>\n<p>Deployed code:</p>\n<ul>\n<li>git: None</li>\n<li>ZULIP_VERSION: 4.3</li>\n</ul>\n<p>Request info: none<br>\n'</p>",
        "id": 1203622,
        "sender_full_name": "Edek Kredka",
        "timestamp": 1623152749
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"15773\">@Edek Kredka</span>, can you show the output, run from your server, of:</p>\n<div class=\"codehilite\"><pre><span></span><code>curl -v https://push.zulipchat.com/api/v1/remotes/push/notify\n</code></pre></div>",
        "id": 1203960,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1623174427
    },
    {
        "content": "<p>Also, what's the public IP of your server?  Feel free to PM me it if you'd prefer.</p>",
        "id": 1203962,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1623174467
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"15773\">@Edek Kredka</span>: From PMs, it looks like Zulip isn't using your outgoing proxy.  Have you configured it according to <a href=\"https://zulip.readthedocs.io/en/latest/production/deployment.html#using-an-outgoing-http-proxy\">https://zulip.readthedocs.io/en/latest/production/deployment.html#using-an-outgoing-http-proxy</a> ?</p>",
        "id": 1207432,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1623446117
    },
    {
        "content": "<p>If you were upgrading from &lt; 4.0, then it may have been accidentally working previously by picking up your existing environment variables, depending on how you started it.</p>\n<p>We may want a bigger note in the upgrading docs about needing to explicitly set your outgoing proxy.</p>",
        "id": 1207434,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1623446203
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span>  thats true, wa are using proxy  ENV settings. <br>\nI setup proxy setting by adding [http_proxy] section to zulip.conf file and apply changes,  but it did not help. Is there a possibility to check if zulip is using proxy settings ?</p>",
        "id": 1208380,
        "sender_full_name": "Edek Kredka",
        "timestamp": 1623656180
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"15773\">@Edek Kredka</span> what step did you take to apply changes?</p>",
        "id": 1208656,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1623687793
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span>  based on <a href=\"https://zulip.readthedocs.io/en/latest/production/deployment.html#using-an-outgoing-http-proxy\">https://zulip.readthedocs.io/en/latest/production/deployment.html#using-an-outgoing-http-proxy</a></p>\n<ol>\n<li>add section [http_proxy] to /etc/zulip/zulip.conf</li>\n</ol>\n<p>[http_proxy]<br>\nhost = 192.168.215.9<br>\nport = 1974</p>\n<ol start=\"2\">\n<li>apply changes  by running /home/zulip/deployments/current/scripts/zulip-puppet-apply</li>\n</ol>",
        "id": 1209498,
        "sender_full_name": "Edek Kredka",
        "timestamp": 1623744575
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"15773\">@Edek Kredka</span> ok; that should be all you need to do.  You can check whehter the configuration is being used by seeing whether <code>/etc/supervisor/conf.d/zulip/zulip.conf</code> has <code>HTTPS_proxy</code> lines.</p>",
        "id": 1209825,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1623783084
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span>  Sorry my mistake the push notification are already working :) <br>\n My suggestion was that pictures that were entered as http links were not displayed</p>",
        "id": 1209959,
        "sender_full_name": "Edek Kredka",
        "timestamp": 1623792021
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> do you have an example of what the output of  <code>curl -v https://push.zulipchat.com/api/v1/remotes/push/notify</code> should look like? I recently got around to upgrading some <code>4.3</code> servers to <code>4.8</code> and push has stopped working for me, I put up an issue with some more documentation <a href=\"https://github.com/zulip/zulip/issues/20772\">here</a>.<br>\nI'm wondering if the addition of Smokescreen is doing something strange, I did look through my <code>/etc/supervisor/conf.d/zulip/zulip.conf</code> and see in all the entries<br>\n<code>environment=HTTP_proxy=\"http://localhost:4750\",HTTPS_proxy=\"http://localhost:4750\"</code><br>\nserver should be running in DMZ with no strange proxy stuff<br>\nsorry to bother, thanks if you've got any clues for where I might look to chase down the problem</p>",
        "id": 1310922,
        "sender_full_name": "Jack Hellerstedt",
        "timestamp": 1642389664
    },
    {
        "content": "<p>Finally checked <code>supervisorctl status</code> and neither <code>go-camo</code> nor <code>smokescreen</code> were running (despite a server restart), but manually starting them again fixed this problem.</p>",
        "id": 1310927,
        "sender_full_name": "Jack Hellerstedt",
        "timestamp": 1642393656
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"22803\">@Jack Hellerstedt</span>: Hm.  Is there anything in the supervisor or Zulip error logs that point to why camo and smokescreen weren't running?  Adding smokescreen to the supervisor config should have reloaded the config, and started the smokescreen process.</p>\n<p>Can you post any of the stacktraces that you were getting?  Ideally we'd like this to go a good job of pointing a finger at the proxy.</p>\n<p>But it's expected that the manual <code>curl</code> request with a GET with no credentials would give you a <code>Method not allowed</code> response.</p>",
        "id": 1311071,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642448110
    },
    {
        "content": "<p>I guess, from the Github issue, the exception said \"Bad Gateway\" but seeing the full stacktrace may help if there are other details we can add.</p>",
        "id": 1311072,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642448304
    },
    {
        "content": "<p>I run a daily backup:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>supervisorctl stop all\n<span class=\"c1\">## command to backup the zulip server</span>\nsu zulip -c <span class=\"s1\">'/home/zulip/deployments/current/manage.py backup --output backup_filename</span>\n<span class=\"s1\">## restart server</span>\n<span class=\"s1\">su zulip -c '</span>/home/zulip/deployments/current/scripts/restart-server<span class=\"err\">'</span>\n</code></pre></div>\n<p>it seems the <code>supervisor stop all</code> stops everything, but <code>restart-server</code> doesn't restart <code>smokescreen</code> and <code>go-camo</code> (logs said they were stopping gracefully, I had to stare at the timestamps to remember that I'm running a backup regularly)</p>\n<p>I guess I can change those to <code>stop-server</code> and <code>start-server</code> on either side of the backup call, and <code>smokescreen</code> and <code>go-camo</code> should just run through that.  I guess it's worth noting that <code>restart-server</code> or <code>start-server</code> don't bring those two services back up if they've been stopped.</p>",
        "id": 1311141,
        "sender_full_name": "Jack Hellerstedt",
        "timestamp": 1642480930
    },
    {
        "content": "<p>Hm.  I think it's a reasonable expectation that <code>restart-server</code>/<code>start-server</code> would make sure that all of the needed services are running, even if we don't take them down with <code>stop-server</code>.  I think I agree that it should start smokscreen and camo if they're installed on the host, yeah.</p>",
        "id": 1311416,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642541028
    },
    {
        "content": "<p>We don't bring those down on stop because they're stateless, and not affected by code deploys.</p>",
        "id": 1311421,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642541083
    },
    {
        "content": "<p>Yeah, I think I agree that it's a bug to not start those services if they are expected to be running via supervisord.</p>",
        "id": 1311424,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1642541141
    },
    {
        "content": "<p>That said <span class=\"user-mention\" data-user-id=\"22803\">@Jack Hellerstedt</span>, you should probably update your script to do <code>stop-server</code> rather than <code>supervisorctl stop all</code>; the latter used to be our only documented mechanism for stopping a server, but <code>stop-server</code> is now preferred.</p>",
        "id": 1311426,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1642541192
    },
    {
        "content": "<p><a href=\"https://github.com/zulip/zulip/pull/20832\">#20832</a>.</p>",
        "id": 1311505,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642546068
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"22803\">@Jack Hellerstedt</span>: Did you have the stacktraces handy that were getting spit out?</p>",
        "id": 1311507,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642546094
    },
    {
        "content": "<p>are you looking for the output of <code>pstack pid</code> ? Sorry I haven't pulled a stacktrace before.  Happy to stop <code>go-camo</code> &amp; <code>smokescreen</code> again and see what I get</p>",
        "id": 1311509,
        "sender_full_name": "Jack Hellerstedt",
        "timestamp": 1642546287
    },
    {
        "content": "<p>Oh, hm.  I assume <a href=\"https://github.com/zulip/zulip/pull/20772\">#20772</a> was the full content of the email you were getting?  That doesn't have a stacktrace, which seems like its own big.</p>\n<p>What did the errors in <code>/var/log/zulip/error.log</code> look like?</p>",
        "id": 1311514,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642546425
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"m\">2022</span>-01-17 <span class=\"m\">02</span>:04:16.404 ERR  <span class=\"o\">[</span>django.request<span class=\"o\">]</span> Bad Gateway: /api/v1/users/me/apns_device_token\n<span class=\"m\">2022</span>-01-17 <span class=\"m\">02</span>:43:42.521 ERR  <span class=\"o\">[</span>django.request<span class=\"o\">]</span> Bad Gateway: /api/v1/users/me/android_gcm_reg_id\n<span class=\"m\">2022</span>-01-17 <span class=\"m\">02</span>:45:21.222 WARN <span class=\"o\">[</span>zerver.worker.queue_processors<span class=\"o\">]</span> Maximum retries exceeded <span class=\"k\">for</span> trigger:42 event:push_notification\n</code></pre></div>\n<p>where the log was awash with that warning, replace <code>42</code> with presumably every other number'd user also getting a failed push</p>",
        "id": 1311518,
        "sender_full_name": "Jack Hellerstedt",
        "timestamp": 1642546785
    },
    {
        "content": "<p>Hm, OK.  \"Bad Gateway\" is really the specific problem.  We can maybe make things clearer by overriding something in <code>zerver.lib.outgoing_http</code> to make that hint more explicitly at Smokescreen or other proxy.  But we'd want to make sure that doesn't muddle things by pointing at smokescreen in cases where it <em>did</em> talk to a remote server, and <em>that</em> server returned the 502.</p>",
        "id": 1311526,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642547150
    },
    {
        "content": "<p>in retrospect link previews were also not loading, but those failures to load weren't showing up anywhere in the logs when I was poking around trying to fix push</p>",
        "id": 1311527,
        "sender_full_name": "Jack Hellerstedt",
        "timestamp": 1642547457
    },
    {
        "content": "<p>Mmm, because that's a failure almost strictly on the browser end.  Zulip generates a link to camo, but doesn't need to talk to camo to do that.  The browser tries to follow the URL that is so generated, and nginx was probably spewing errors there talking to a down'd camo.</p>",
        "id": 1311529,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642547530
    },
    {
        "content": "<p>But looking at the nginx logs generally isn't useful, so it makes sense that that wouldn't have been a thing to look at immedaitely.</p>",
        "id": 1311530,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1642547564
    }
]