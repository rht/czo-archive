[
    {
        "content": "<p>I have upgraded zulip and whoever was logged into the client works fine but if you try to login again or from a webpage or the desktop app, or phone app, it says internal server error. Everyone currently logged into the app is still able to use Zulip normally and message everyone.</p>",
        "id": 799346,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574787489
    },
    {
        "content": "<p>Any Ideas?</p>",
        "id": 799347,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574787494
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12396\">@Branden Keating</span> have you upgraded to master from git? or to 2.0.7? or to 2.1 release candidate?</p>",
        "id": 799349,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574788694
    },
    {
        "content": "<p>and can you post <code>/var/log/zulip/errors.log</code>?</p>",
        "id": 799350,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574788863
    },
    {
        "content": "<p>Sorry, just saw this as I was in a meeting.<br>\nLogs:</p>",
        "id": 799351,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574791416
    },
    {
        "content": "<p>2019-11-26 15:05:08.465 WARN [] Invalid data.<br>\n2019-11-26 15:23:16.272 WARN [zerver.lib.email_mirror] EMAIL_GATEWAY_PATTERN is an empty string, using NOREPLY_EMAIL_ADDRESS in the 'from' field.<br>\n2019-11-26 16:05:07.488 WARN [] Invalid data.<br>\n2019-11-26 16:47:17.067 ERR  [django.request] Internal Server Error: /accounts/login/<br>\nTraceback (most recent call last):<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/core/handlers/exception.py\", line 41, in inner<br>\n    response = get_response(request)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/core/handlers/base.py\", line 187, in _get_response<br>\n    response = self.process_exception_by_middleware(e, request)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/core/handlers/base.py\", line 185, in _get_response<br>\n    response = wrapped_callback(request, *callback_args, **callback_kwargs)<br>\n  File \"./zerver/views/auth.py\", line 646, in login_page<br>\n    extra_context=extra_context, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/auth/views.py\", line 54, in inner<br>\n    return func(*args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/auth/views.py\", line 150, in login<br>\n    )(request)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/views/generic/base.py\", line 68, in view<br>\n    return self.dispatch(request, *args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py\", line 67, in _wrapper<br>\n    return bound_func(*args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/views/decorators/debug.py\", line 76, in sensitive_post_parameters_wrapper<br>\n    return view(request, *args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py\", line 63, in bound_func<br>\n    return func.__get__(self, type(self))(*args2, **kwargs2)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py\", line 67, in _wrapper<br>\n    return bound_func(*args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py\", line 149, in _wrapped_view<br>\n    response = view_func(request, *args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py\", line 63, in bound_func<br>\n    return func.__get__(self, type(self))(*args2, **kwargs2)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py\", line 67, in _wrapper<br>\n    return bound_func(*args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/views/decorators/cache.py\", line 57, in _wrapped_view_func<br>\n    response = view_func(request, *args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/utils/decorators.py\", line 63, in bound_func<br>\n    return func.__get__(self, type(self))(*args2, **kwargs2)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/auth/views.py\", line 90, in dispatch<br>\n    return super(LoginView, self).dispatch(request, *args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/views/generic/base.py\", line 88, in dispatch<br>\n    return handler(request, *args, **kwargs)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/views/generic/edit.py\", line 182, in post<br>\n    if form.is_valid():<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py\", line 183, in is_valid<br>\n    return self.is_bound and not self.errors<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py\", line 175, in errors<br>\n    self.full_clean()<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py\", line 385, in full_clean<br>\n    self._clean_form()<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/forms/forms.py\", line 412, in _clean_form<br>\n    cleaned_data = self.clean()<br>\n  File \"./zerver/forms.py\", line 309, in clean<br>\n    realm=realm, return_data=return_data)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/auth/__init__.py\", line 70, in authenticate<br>\n    user = _authenticate_with_backend(backend, backend_path, request, credentials)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/auth/__init__.py\", line 116, in _authenticate_with_backend<br>\n    return backend.authenticate(*args, **credentials)<br>\n  File \"./zproject/backends.py\", line 562, in authenticate<br>\n return backend.authenticate(*args, **credentials)<br>\n  File \"./zproject/backends.py\", line 562, in authenticate<br>\n    username = self.django_to_ldap_username(username)<br>\n  File \"./zproject/backends.py\", line 387, in django_to_ldap_username<br>\n    if _LDAPUser(self, result).attrs is None:<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py\", line 557, in attrs<br>\n    self._load_user_attrs()<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py\", line 589, in _load_user_attrs<br>\n    if self.dn is not None:<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py\", line 550, in dn<br>\n    self._load_user_dn()<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py\", line 618, in _load_user_dn<br>\n    self._user_dn = self._search_for_user_dn()<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py\", line 639, in _search_for_user_dn<br>\n    results = search.execute(self.connection, {\"user\": self._username})<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py\", line 268, in connection<br>\n    self._bind()<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py\", line 277, in _bind<br>\n    self._bind_as(self.settings.BIND_DN, self.settings.BIND_PASSWORD, sticky=True)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/django_auth_ldap/backend.py\", line 288, in _bind_as<br>\n    self._get_connection().simple_bind_s(bind_dn, bind_password)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/ldap/ldapobject.py\", line 446, in simple_bind_s<br>\n    resp_type, resp_data, resp_msgid, resp_ctrls = self.result3(msgid,all=1,timeout=self.timeout)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/ldap/ldapobject.py\", line 751, in result3<br>\n    resp_ctrl_classes=resp_ctrl_classes<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/ldap/ldapobject.py\", line 758, in result4<br>\n    ldap_result = self._ldap_call(self._l.result4,msgid,all,timeout,add_ctrls,add_intermediates,add_extop)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/ldap/ldapobject.py\", line 331, in _ldap_call<br>\n    reraise(exc_type, exc_value, exc_traceback)<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/ldap/compat.py\", line 44, in reraise<br>\n    raise exc_value<br>\n  File \"/srv/zulip-venv-cache/08c7c1e4fad499cee6dd00398c62f9908faed46f/zulip-py3-venv/lib/python3.6/site-packages/ldap/ldapobject.py\", line 315, in _ldap_call<br>\n    result = func(<em>args,</em>*kwargs)<br>\nldap.INVALID_CREDENTIALS: {'desc': 'Invalid credentials', 'info': '80090308: LdapErr: DSID-0C09042A, comment: AcceptSecurityContext error, data 52e, v3839'}<br>\n2019-11-26 17:05:07.330 WARN [] Invalid data.<br>\n2019-11-26 17:54:14.993 WARN [django.request] Not Found: /browserconfig.xml</p>",
        "id": 799352,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574791417
    },
    {
        "content": "<p>THis is the upgrade command I ran:<br>\n/home/zulip/deployments/current/scripts/upgrade-zulip-from-git master<br>\n<span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span></p>",
        "id": 799353,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574791451
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12396\">@Branden Keating</span> you're using LDAP, right? it seems like the bind_dn or bind_password for connecting to the directory are incorrect</p>",
        "id": 799354,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574791741
    },
    {
        "content": "<p>Besides the connection credentials issue, because we added some more obligatory settings, you may need to configure <code>AUTH_LDAP_REVERSE_EMAIL_SEARCH</code> and <code>AUTH_LDAP_USERNAME_ATTR</code> - see  <a href=\"https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#ldap-including-active-directory\" target=\"_blank\" title=\"https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#ldap-including-active-directory\">https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#ldap-including-active-directory</a></p>",
        "id": 799355,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574792022
    },
    {
        "content": "<p>But the immediate issue seems to be with the connection.</p>",
        "id": 799356,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574792047
    },
    {
        "content": "<p>would that cause the internal server error with the database?<br>\nI was originally having an issue logging in with LDAP period</p>",
        "id": 799359,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574792305
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> <br>\nAlso, my users that were still logged in are working fine, just people that are logged out cannot login as they get this internal server error message</p>",
        "id": 799360,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574792436
    },
    {
        "content": "<p>yes, if the ldap backend is enabled, the server may make some queries to ldap whenever an attempt to log in is made - and that will cause this internal server error if ldap isn't configured to work</p>",
        "id": 799363,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574792481
    },
    {
        "content": "<p>You have two options:</p>\n<ol>\n<li>Just disable the ldap backend in <code>AUTHENTICATION_METHODS</code> in <code>/etc/zulip/settings.py</code></li>\n<li>Finish configuring ldap to make it work - so the connection credential and the two settings that I'm guessing you don't have configured if you're updating from an older version.</li>\n</ol>",
        "id": 799364,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574792567
    },
    {
        "content": "<p>So the odd thing is, this worked fine before the upgrade, could it have fallen back to default after the upgrade?<br>\nMy LDAO settings have stayed the same.<br>\n<a href=\"/user_uploads/2/61/OEGCdO_zxnNMApNfqiuYDtva/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/61/OEGCdO_zxnNMApNfqiuYDtva/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/61/OEGCdO_zxnNMApNfqiuYDtva/pasted_image.png\"></a></div>",
        "id": 799365,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574792739
    },
    {
        "content": "<p>I just verified the zulip AD password in the secrets file</p>",
        "id": 799366,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574792833
    },
    {
        "content": "<p>before the upgrade, was everything with ldap working fine? or as you mentioned, logging in with LDAP  wasn't working before the upgrade?</p>",
        "id": 799368,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574792899
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> Looks like I am now just having issues logging in as it says \"Invalid username or password\" while trying to authenticate via LDAP. The internal server error is gon. would a new set of logs help you to determine what is happening?</p>",
        "id": 799369,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574792967
    },
    {
        "content": "<p>sure, could be useful</p>",
        "id": 799370,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574792999
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> <br>\nLooks like the only difference is the bottom line</p>\n<p>ldap.INVALID_CREDENTIALS: {'desc': 'Invalid credentials', 'info': '80090308: LdapErr: DSID-0C09042A, comment: AcceptSecurityContext error, data 52e, v3839'}<br>\n2019-11-26 17:05:07.330 WARN [] Invalid data.<br>\n2019-11-26 17:54:14.993 WARN [django.request] Not Found: /browserconfig.xml<br>\n2019-11-26 18:05:09.305 WARN [] Invalid data.</p>",
        "id": 799371,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574793062
    },
    {
        "content": "<p>so no new error? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> oh and back to the previous question - before the upgrade, was logging in via ldap working fine?</p>",
        "id": 799372,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574793189
    },
    {
        "content": "<p>yes</p>",
        "id": 799374,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574793199
    },
    {
        "content": "<p>Can you try using <code>query_ldap</code> to search yourself in ldap and see what that outputs?<br>\n<code>/home/zulip/deployments/current/manage.py query_ldap your@email.com</code></p>",
        "id": 799375,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574793369
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span>  I have looked at this line and it is fine, but maybe you will see something I missed.</p>",
        "id": 799377,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574793450
    },
    {
        "content": "<p><a href=\"/user_uploads/2/38/RwqdChkxj0V8qa_yyxip-7-f/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/38/RwqdChkxj0V8qa_yyxip-7-f/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/38/RwqdChkxj0V8qa_yyxip-7-f/pasted_image.png\"></a></div>",
        "id": 799378,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574793451
    },
    {
        "content": "<p>Manage.py</p>\n<p>#!/usr/bin/env python3<br>\nfrom __future__ import (print_function)<br>\nimport os<br>\nimport sys<br>\nimport configparser<br>\nif sys.version_info &lt;= (3, 0):<br>\n    print(\"Error: Zulip is a Python 3 project, and cannot be run with Python 2.\")<br>\n    print(\"Use e.g. <code>/path/to/manage.py</code> not <code>python /path/to/manage.py</code>.\")<br>\n    sys.exit(1)</p>\n<p>BASE_DIR = os.path.dirname(os.path.abspath(__file__))<br>\nsys.path.append(BASE_DIR)<br>\nimport scripts.lib.setup_path_on_import<br>\nfrom scripts.lib.zulip_tools import assert_not_running_as_root</p>\n<p>if __name__ == \"__main__\":<br>\n    assert_not_running_as_root()</p>\n<div class=\"codehilite\"><pre><span></span>config_file = configparser.RawConfigParser()\nconfig_file.read(&quot;/etc/zulip/zulip.conf&quot;)\nPRODUCTION = config_file.has_option(&#39;machine&#39;, &#39;deploy_type&#39;)\nHAS_SECRETS = os.access(&#39;/etc/zulip/zulip-secrets.conf&#39;, os.R_OK)\n\nif PRODUCTION and not HAS_SECRETS:\n    # The best way to detect running manage.py as another user in\n    # production before importing anything that would require that\n    # access is to check for access to /etc/zulip/zulip.conf (in\n    # which case it&#39;s a production server, not a dev environment)\n    # and lack of access for /etc/zulip/zulip-secrets.conf (which\n    # should be only readable by root and zulip)\n    print(&quot;Error accessing Zulip secrets; manage.py in production must be run as the zulip user.&quot;)\n    sys.exit(1)\n\nos.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;zproject.settings&quot;)\nfrom django.conf import settings\nfrom django.core.management import execute_from_command_line\nfrom django.core.management.base import CommandError\nfrom scripts.lib.zulip_tools import log_management_command\n\nlog_management_command(&quot; &quot;.join(sys.argv), settings.MANAGEMENT_LOG_PATH)\n\nos.environ.setdefault(&quot;PYTHONSTARTUP&quot;, os.path.join(BASE_DIR, &quot;scripts/lib/pythonrc.py&quot;))\nif &quot;--no-traceback&quot; not in sys.argv and len(sys.argv) &gt; 1:\n    sys.argv.append(&quot;--traceback&quot;)\ntry:\n    execute_from_command_line(sys.argv)\nexcept CommandError as e:\n    print(e, file=sys.stderr)\n    sys.exit(1)\n</pre></div>",
        "id": 799379,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574793485
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12396\">@Branden Keating</span> oh, that's a confusing error, but if you switch to the zulip user with su first, and then run the command, it should work</p>",
        "id": 799381,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574793851
    },
    {
        "content": "<p>I did, I included the command in the screenshot, unless you mean \"su zulip\" at the OS level, then run the command but I don't know if that will change anything</p>",
        "id": 799382,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574793912
    },
    {
        "content": "<p>I will try it now</p>",
        "id": 799383,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574793916
    },
    {
        "content": "<p><code>su zulip  -s  /home/zulip/deployments/current/manage.py query_ldap</code> this style should work too</p>",
        "id": 799384,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574793947
    },
    {
        "content": "<p><a href=\"/user_uploads/2/56/ZjaQGZJPCoqREzmIb2XMWwin/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/56/ZjaQGZJPCoqREzmIb2XMWwin/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/56/ZjaQGZJPCoqREzmIb2XMWwin/pasted_image.png\"></a></div>",
        "id": 799385,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574793966
    },
    {
        "content": "<p>so it basically is not connecting to LDAP</p>",
        "id": 799386,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574793977
    },
    {
        "content": "<p>hmmm, and how is your <code>AUTH_LDAP_USER_SEARCH</code> configured?</p>",
        "id": 799387,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574794350
    },
    {
        "content": "<p>in the settings.py correct?</p>",
        "id": 799388,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574794433
    },
    {
        "content": "<p>yes</p>",
        "id": 799389,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574794450
    },
    {
        "content": "<p><a href=\"/user_uploads/2/1a/yHX4-7Z2SmpIBxmcgUmwtynd/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/1a/yHX4-7Z2SmpIBxmcgUmwtynd/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/1a/yHX4-7Z2SmpIBxmcgUmwtynd/pasted_image.png\"></a></div>",
        "id": 799390,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574794458
    },
    {
        "content": "<p>has not changed, and it looks to still be formatted correctly</p>",
        "id": 799391,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574794481
    },
    {
        "content": "<p>yeah, that looks okay. Hmm, what if you go into the django shell <code>manage.py shell</code> and there:<br>\n<code>from zproject.backends import ZulipLDAPAuthBackend</code> and <code>ZulipLDAPAuthBackend().django_to_ldap_username('youremail')</code></p>",
        "id": 799392,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574794806
    },
    {
        "content": "<p>Sorry, this is an end user question but how do I get to the python shell to run that?</p>",
        "id": 799394,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574794999
    },
    {
        "content": "<p>Similar as before - <code>/home/zulip/deployments/current/manage.py shell</code> as the zulip user</p>",
        "id": 799395,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574795049
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> <a href=\"/user_uploads/2/ea/8FcKegqVtg0aN1M8q04VRXt1/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/ea/8FcKegqVtg0aN1M8q04VRXt1/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/ea/8FcKegqVtg0aN1M8q04VRXt1/pasted_image.png\"></a></div>",
        "id": 799396,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574795152
    },
    {
        "content": "<p>oh, you just misspelled your domain here, can you try again with it fixed? you did <code>bkeating@sbmcoPR.com</code></p>",
        "id": 799397,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574795238
    },
    {
        "content": "<p>Sorry about that, <a href=\"/user_uploads/2/96/MBD6Mc7yRAKp4eMdXBQ2gcE-/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/96/MBD6Mc7yRAKp4eMdXBQ2gcE-/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/96/MBD6Mc7yRAKp4eMdXBQ2gcE-/pasted_image.png\"></a></div>",
        "id": 799398,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574795294
    },
    {
        "content": "<p>hmm, I see - how about <code>from django_auth_ldap.backend import _LDAPUser</code> and then  <code>_LDAPUser(ZulipLDAPAuthBackend(), 'bkeating').attrs is None</code>?</p>",
        "id": 799399,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574795493
    },
    {
        "content": "<p><a href=\"/user_uploads/2/f4/_sPUb8Rb1SgBsCcQO0Va0iGw/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/f4/_sPUb8Rb1SgBsCcQO0Va0iGw/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/f4/_sPUb8Rb1SgBsCcQO0Va0iGw/pasted_image.png\"></a></div>",
        "id": 799400,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574795549
    },
    {
        "content": "<p>ah, if you exit the shell alreayd, you have to import <code>ZulipLdapAuthBackend</code> again (<code>from zproject.backends import ZulipLDAPAuthBackend</code>)</p>",
        "id": 799401,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574795597
    },
    {
        "content": "<p>I presume that your <code>sAMAccountName</code> in AD should be <code>bkeating</code>, right?</p>",
        "id": 799402,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574795619
    },
    {
        "content": "<p>yes</p>",
        "id": 799403,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574795647
    },
    {
        "content": "<p><a href=\"/user_uploads/2/7e/054SA5Hm1TMrgM4WZarvjjXj/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/7e/054SA5Hm1TMrgM4WZarvjjXj/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/7e/054SA5Hm1TMrgM4WZarvjjXj/pasted_image.png\"></a></div>",
        "id": 799404,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574795704
    },
    {
        "content": "<p>hmm, I'm kind of at a loss here, since nothing is throwing any useful errors (it's weird that the INVALID_CREDENTIALS error has disappeared). Oh, unless some caching is causing the ldapsearch not to get executed...<br>\nCan you try in the shell<br>\n<code>from django.core.cache import cache</code> -&gt; <code>cache.clear()</code> and then the <code>_LDAPUser(ZulipLDAPAuthBackend(), 'bkeating').attrs is None</code> thing again? (with the objects imported too) <span class=\"user-mention\" data-user-id=\"12396\">@Branden Keating</span></p>",
        "id": 799406,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574796677
    },
    {
        "content": "<p><a href=\"/user_uploads/2/6c/AqSbtxk3Aiyty_8PXoylRXRM/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/6c/AqSbtxk3Aiyty_8PXoylRXRM/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/6c/AqSbtxk3Aiyty_8PXoylRXRM/pasted_image.png\"></a></div>",
        "id": 799407,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574796991
    },
    {
        "content": "<p>New logs: <a href=\"/user_uploads/2/1/JNvog6LvKfbyhs9azMJe3ILs/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/1/JNvog6LvKfbyhs9azMJe3ILs/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/1/JNvog6LvKfbyhs9azMJe3ILs/pasted_image.png\"></a></div>",
        "id": 799408,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574797102
    },
    {
        "content": "<p>This is in the events log, if it means anything helpful <a href=\"/user_uploads/2/5c/8aKHsN0CGFlW_CBDzW0w_p6H/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/5c/8aKHsN0CGFlW_CBDzW0w_p6H/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/5c/8aKHsN0CGFlW_CBDzW0w_p6H/pasted_image.png\"></a></div>",
        "id": 799409,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574797451
    },
    {
        "content": "<p>These events log errors are from way earlier, right? Judging from the timestamps. Are they still occurring?</p>",
        "id": 799410,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574797591
    },
    {
        "content": "<p>those error.log screens are new. For some reason, our timing of the logs has always been wrong</p>",
        "id": 799411,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574797688
    },
    {
        "content": "<p>I meant the events log from the last screenshot (because the hour is way off compared to those errors.log entries that are current)</p>",
        "id": 799412,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574797848
    },
    {
        "content": "<p>those are from earlier today before you asked for the python shell commands</p>",
        "id": 799413,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574797889
    },
    {
        "content": "<p>from before or after the upgrade?</p>",
        "id": 799414,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574797922
    },
    {
        "content": "<p>after</p>",
        "id": 799415,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574797930
    },
    {
        "content": "<p>Can you try to restart the zulip server and see if the invalid_credentials errors comes back? <code>su zulip -c '/home/zulip/deployments/current/scripts/restart-server'</code></p>",
        "id": 799416,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574798315
    },
    {
        "content": "<p>as in the GUI error message?</p>",
        "id": 799417,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574798352
    },
    {
        "content": "<p>one sec</p>",
        "id": 799418,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574798357
    },
    {
        "content": "<p>same thing <a href=\"/user_uploads/2/ad/eHyYTCfRvnx_XFRnGmy_d9PO/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/ad/eHyYTCfRvnx_XFRnGmy_d9PO/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/ad/eHyYTCfRvnx_XFRnGmy_d9PO/pasted_image.png\"></a></div>",
        "id": 799419,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574798457
    },
    {
        "content": "<p>I'm guessing nothing in <code>errors.log</code> either? Curious that the <code>invalid_credentials</code> error (that was causing the internal server error) disappeared.</p>",
        "id": 799420,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574798510
    },
    {
        "content": "<p>nothing new in there</p>",
        "id": 799421,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574798546
    },
    {
        "content": "<p><a href=\"/user_uploads/2/46/_1BPKRBmyVEPSh-ccEoDBbbn/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/46/_1BPKRBmyVEPSh-ccEoDBbbn/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/46/_1BPKRBmyVEPSh-ccEoDBbbn/pasted_image.png\"></a></div>",
        "id": 799422,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574798559
    },
    {
        "content": "<p><code>_LDAPUser(ZulipLDAPAuthBackend(), 'bkeating')._search_for_user_dn()</code> in the python shell again? (with the needed imports)</p>",
        "id": 799423,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574798823
    },
    {
        "content": "<p>it literally just dropped down to nothing lol</p>",
        "id": 799424,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574798880
    },
    {
        "content": "<p><a href=\"/user_uploads/2/61/L3ifoOvGzD_dW-mf4hYYyekD/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a> v</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/61/L3ifoOvGzD_dW-mf4hYYyekD/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/61/L3ifoOvGzD_dW-mf4hYYyekD/pasted_image.png\"></a></div>",
        "id": 799425,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574798899
    },
    {
        "content": "<p>Because it's not finding the dn. This seems like there has to be an issue with the configuration - though that's strange too, considering it was working fine before the upgrade.</p>\n<p>What will <code>_LDAPUser(ZulipLDAPAuthBackend(), 'bkeating').connection</code> show?</p>",
        "id": 799426,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574799128
    },
    {
        "content": "<p><a href=\"/user_uploads/2/81/OpMtmWNUZ01rG0_b4-o5I5-o/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/81/OpMtmWNUZ01rG0_b4-o5I5-o/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/81/OpMtmWNUZ01rG0_b4-o5I5-o/pasted_image.png\"></a></div>",
        "id": 799427,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574799202
    },
    {
        "content": "<p>So it does seem to be connecting fine, and having an issue with the search...</p>",
        "id": 799428,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574799233
    },
    {
        "content": "<p>that seems to make sense</p>",
        "id": 799429,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574799300
    },
    {
        "content": "<p>is there a way to re-establish the connection or initiate the search again?</p>",
        "id": 799430,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574799321
    },
    {
        "content": "<p>it was the redoing connection and search every time we called these code snippets just now  I think</p>",
        "id": 799431,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574799431
    },
    {
        "content": "<p>hmmm, ok.</p>",
        "id": 799432,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574799507
    },
    {
        "content": "<p>can it be check in AD logs if connection are indeed being made and what search queries are being run?</p>",
        "id": 799433,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574799511
    },
    {
        "content": "<p>let me look</p>",
        "id": 799434,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574799535
    },
    {
        "content": "<p>worst case you could wireshark it or something, lol <a href=\"https://iamtechtips.com/capture-ldap-queries-wireshark/\" target=\"_blank\" title=\"https://iamtechtips.com/capture-ldap-queries-wireshark/\">https://iamtechtips.com/capture-ldap-queries-wireshark/</a> <span aria-label=\"confounded\" class=\"emoji emoji-1f616\" role=\"img\" title=\"confounded\">:confounded:</span></p>",
        "id": 799435,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574800066
    },
    {
        "content": "<p>I have 0 logs for that service account showing up in AD</p>",
        "id": 799436,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574800067
    },
    {
        "content": "<p>Does that mean no bind is being done using the accoun configured in <code>AUTH_LDAP_BIND_DN</code>?</p>",
        "id": 799439,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574800171
    },
    {
        "content": "<p>it should be but I would think not if I am not seeing any logs, successful or otherwise</p>",
        "id": 799441,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574800199
    },
    {
        "content": "<p>and <code>AUTH_LDAP_SERVER_URI</code> is correct?</p>",
        "id": 799443,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574800288
    },
    {
        "content": "<p>I am double checking now</p>",
        "id": 799444,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574800301
    },
    {
        "content": "<p>yes those settings are correct</p>",
        "id": 799449,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574800423
    },
    {
        "content": "<p>I am looking at the original file to see if a symbol is mistyped or there is a trailing space somewhere lol</p>",
        "id": 799450,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574800445
    },
    {
        "content": "<p>Is there a service by chance that may not be running?</p>",
        "id": 799456,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574800876
    },
    {
        "content": "<p>I don't think so. The connections and search queries should be happening when we call that code in the python shell regardless anyway. Can you use some network monitoring tool on the server to check what happens we do that <code>_LDAPUser(ZulipLDAPAuthBackend(), 'bkeating')._search_for_user_dn()</code>? It's really strange for no connection to the AD to even be attempted.</p>",
        "id": 799457,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574801038
    },
    {
        "content": "<p>I will test that in a second, but I found this message in events and error logs<br>\n<a href=\"/user_uploads/2/e2/NWuG-GYyylBvC8pQuA6ZRDLY/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/e2/NWuG-GYyylBvC8pQuA6ZRDLY/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/e2/NWuG-GYyylBvC8pQuA6ZRDLY/pasted_image.png\"></a></div>",
        "id": 799458,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574801073
    },
    {
        "content": "<p>That's unrelated, it's a harmless warning from a completely different feature - <a href=\"https://zulip.readthedocs.io/en/latest/production/email-gateway.html\" target=\"_blank\" title=\"https://zulip.readthedocs.io/en/latest/production/email-gateway.html\">https://zulip.readthedocs.io/en/latest/production/email-gateway.html</a></p>",
        "id": 799459,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574801178
    },
    {
        "content": "<p>ok, sorry to bring it up then</p>",
        "id": 799460,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574801194
    },
    {
        "content": "<p>Btw, depending on how urgent getting the login working is, you could enable the EmailAuthBackend, disable LDAP authentication for the realm (in organization settings) and have users Reset their password and they'll be able to login with the password they'll set for themselves that way - if that's acceptable for your company as a temporary measure until this AD stuff gets figured out.</p>",
        "id": 799462,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574802039
    },
    {
        "content": "<p>ok, that is something to think about</p>",
        "id": 799466,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574802282
    },
    {
        "content": "<p>I am not getting any traffic from wireshark so I am trying some things</p>",
        "id": 799467,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574802300
    },
    {
        "content": "<p>We found the issue, it had to do with users not being in the correct OU so they were getting the login error</p>",
        "id": 799485,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574802804
    },
    {
        "content": "<p>Ahhh, it's working now then?</p>",
        "id": 799487,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574802858
    },
    {
        "content": "<p>yes</p>",
        "id": 799488,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574802917
    },
    {
        "content": "<p>Thank you so much for all of your help</p>",
        "id": 799489,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574802923
    },
    {
        "content": "<p>I really do appreciate it</p>",
        "id": 799490,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574802930
    },
    {
        "content": "<p>Great news! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 799491,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1574802999
    },
    {
        "content": "<p>Thanks again</p>",
        "id": 799498,
        "sender_full_name": "Branden Keating",
        "timestamp": 1574803364
    }
]