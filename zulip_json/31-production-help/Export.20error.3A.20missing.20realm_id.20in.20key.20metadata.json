[
    {
        "content": "<p>Hi everyone! I was trying to do a data export of our zulip server, and import it to a fresh new zulip server. However, I am getting a error \"AssertionError: Missing realm_id in key metadata: {}\" during the export. Please see the complete traceback below:</p>\n<div class=\"codehilite\"><pre><span></span><code>Exporting realm:\n2022-07-08 14:56:48.635 INFO [] Exporting data from get_realm_config()...\n2022-07-08 14:56:48.635 INFO [] Exporting via export_from_config:  zerver_realm\n2022-07-08 14:56:48.636 INFO [] Exporting via export_from_config:  zerver_defaultstream\n2022-07-08 14:56:48.644 INFO [] Exporting via export_from_config:  zerver_customprofilefield\n2022-07-08 14:56:48.649 INFO [] Exporting via export_from_config:  zerver_realmauditlog\n2022-07-08 14:56:48.682 INFO [] Exporting via export_from_config:  zerver_realmemoji\n2022-07-08 14:56:48.691 INFO [] Exporting via export_from_config:  zerver_realmdomain\n2022-07-08 14:56:48.698 INFO [] Exporting via export_from_config:  zerver_realmfilter\n2022-07-08 14:56:48.701 INFO [] Exporting via export_from_config:  zerver_realmplayground\n2022-07-08 14:56:48.713 INFO [] Exporting via export_from_config:  zerver_client\n2022-07-08 14:56:48.720 INFO [] Exporting via export_from_config:  zerver_realmuserdefault\n2022-07-08 14:56:48.730 INFO [] Exporting via export_from_config:  zerver_userprofile\n2022-07-08 14:56:48.734 INFO [] Exporting via export_from_config:  zerver_userprofile_mirrordummy\n2022-07-08 14:56:48.979 INFO [] Exporting via export_from_config:  zerver_userprofile_crossrealm\n2022-07-08 14:56:49.008 INFO [] Exporting via export_from_config:  zerver_service\n2022-07-08 14:56:49.013 INFO [] Exporting via export_from_config:  zerver_botstoragedata\n2022-07-08 14:56:49.017 INFO [] Exporting via export_from_config:  zerver_botconfigdata\n2022-07-08 14:56:49.021 INFO [] Exporting via export_from_config:  _user_subscription\n2022-07-08 14:56:49.030 INFO [] Exporting via export_from_config:  _user_recipient\n2022-07-08 14:56:49.037 INFO [] Exporting via export_from_config:  _huddle_recipient\n2022-07-08 14:56:49.037 INFO [] Exporting via export_from_config:  _huddle_subscription\n2022-07-08 14:56:49.037 INFO [] Exporting via export_from_config:  zerver_huddle\n2022-07-08 14:56:49.078 INFO [] Exporting via export_from_config:  zerver_alertword\n2022-07-08 14:56:49.083 INFO [] Exporting via export_from_config:  zerver_customprofilefieldvalue\n2022-07-08 14:56:49.090 INFO [] Exporting via export_from_config:  zerver_muteduser\n2022-07-08 14:56:49.099 INFO [] Exporting via export_from_config:  zerver_useractivity\n2022-07-08 14:56:49.161 INFO [] Exporting via export_from_config:  zerver_useractivityinterval\n2022-07-08 14:56:52.091 INFO [] Exporting via export_from_config:  zerver_userhotspot\n2022-07-08 14:56:52.103 INFO [] Exporting via export_from_config:  zerver_userpresence\n2022-07-08 14:56:52.111 INFO [] Exporting via export_from_config:  zerver_userstatus\n2022-07-08 14:56:52.117 INFO [] Exporting via export_from_config:  zerver_usertopic\n2022-07-08 14:56:52.124 INFO [] Exporting via export_from_config:  zerver_usergroup\n2022-07-08 14:56:52.262 INFO [] Exporting via export_from_config:  zerver_usergroupmembership\n2022-07-08 14:56:52.268 INFO [] Exporting via export_from_config:  zerver_groupgroupmembership\n2022-07-08 14:56:52.272 INFO [] Exporting via export_from_config:  zerver_stream\n2022-07-08 14:56:52.279 INFO [] Exporting via export_from_config:  _stream_recipient\n2022-07-08 14:56:52.283 INFO [] Exporting via export_from_config:  _stream_subscription\n2022-07-08 14:56:52.301 INFO [] Exporting via export_from_config:  zerver_recipient\n2022-07-08 14:56:52.301 INFO [] Deleted temporary _user_recipient\n2022-07-08 14:56:52.301 INFO [] Deleted temporary _stream_recipient\n2022-07-08 14:56:52.301 INFO [] Deleted temporary _huddle_recipient\n2022-07-08 14:56:52.302 INFO [] Exporting via export_from_config:  zerver_subscription\n2022-07-08 14:56:52.302 INFO [] Deleted temporary _user_subscription\n2022-07-08 14:56:52.302 INFO [] Deleted temporary _stream_subscription\n2022-07-08 14:56:52.302 INFO [] Deleted temporary _huddle_subscription\n2022-07-08 14:56:52.302 INFO [] ...DONE with get_realm_config() data\n2022-07-08 14:56:52.303 INFO [] Exporting uploaded files and avatars\n2022-07-08 14:56:53.110 INFO [] Downloading upload files from tesi-zulip-uploads\nTraceback (most recent call last):\n  File &quot;./manage.py&quot;, line 157, in &lt;module&gt;\n    execute_from_command_line(sys.argv)\n  File &quot;./manage.py&quot;, line 122, in execute_from_command_line\n    utility.execute()\n  File &quot;/srv/zulip-venv-cache/a30311a4e5879c676d7aa8276dd6be5dcb00b3d1/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py&quot;, line 413, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File &quot;/srv/zulip-venv-cache/a30311a4e5879c676d7aa8276dd6be5dcb00b3d1/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File &quot;/srv/zulip-venv-cache/a30311a4e5879c676d7aa8276dd6be5dcb00b3d1/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 398, in execute\n    output = self.handle(*args, **options)\n  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/management/commands/export.py&quot;, line 207, in handle\n    export_realm_wrapper(\n  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/lib/export.py&quot;, line 2248, in export_realm_wrapper\n    tarball_path = do_export_realm(\n  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/lib/export.py&quot;, line 1842, in do_export_realm\n    export_uploads_and_avatars(realm, user=None, output_dir=output_dir)\n  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/lib/export.py&quot;, line 1425, in export_uploads_and_avatars\n    export_files_from_s3(\n  File &quot;/home/zulip/deployments/2022-07-07-10-48-49/zerver/lib/export.py&quot;, line 1588, in export_files_from_s3\n    raise AssertionError(f&quot;Missing realm_id in key metadata: {key.metadata}&quot;)\nAssertionError: Missing realm_id in key metadata: {}\n</code></pre></div>\n<p>I am using Wasabi (S3-compatible object storage) as my file upload backend. Any ideas?</p>\n<p>Thanks!</p>",
        "id": 1401643,
        "sender_full_name": "Marko",
        "timestamp": 1657294476
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"11031\">@Marko</span> I haven't seen this error before, but I can speculate a bit about the problem.</p>",
        "id": 1401644,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657294563
    },
    {
        "content": "<p>Zulip stores metadata in S3 when it uploads files -- basic details like what realm/organization the file is associated with.</p>",
        "id": 1401647,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657294590
    },
    {
        "content": "<p>That assertion error suggests that the metadata cannot be read back out from your Wasabi S3 backend.</p>",
        "id": 1401648,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657294616
    },
    {
        "content": "<p>So one possibility is that Wasabi does not correctly implement the S3 protocol and is just silently failing to store key metadata when Zulip requests that.</p>",
        "id": 1401649,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657294652
    },
    {
        "content": "<p>I don't see obvious evidence of that being a known issue with Wasabi after a bit if research. I think the next thing I'd recommend trying is a bit of print-debugging to see whether the issue is isolated to one file or applies to all files.</p>",
        "id": 1401651,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657294809
    }
]