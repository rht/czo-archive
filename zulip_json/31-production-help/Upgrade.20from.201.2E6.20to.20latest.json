[
    {
        "content": "<p>Wondering if there is a staggered approach here, or do we just attempt going straight to latest from 1.6? Running on Ubuntu 14.04 currently so maybe a migration is a better idea.</p>",
        "id": 687645,
        "sender_full_name": "hb-it",
        "timestamp": 1548355709
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3275\">@hb-it</span> I am not aware of issues with going from 1.6 to 1.9.1 directly.  We generally have been fixing issues that might have required a staged migration when we find them, and I think the last ones I remember are all from starting with 1.3.x or 1.4.x.</p>",
        "id": 687705,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1548357130
    },
    {
        "content": "<p>Great thanks. Will clone to a another VM and try it out.</p>",
        "id": 687717,
        "sender_full_name": "hb-it",
        "timestamp": 1548357218
    },
    {
        "content": "<p>Testing upgrading from 1.6 to 1.9.2 on a cloned VM (Ubuntu 14), server comes up after upgrade although I had to do the remove-re-install and reconfigure Rabbit to get it running. Now it's not accepting any known user passwords. We are using AD domain logins. Where can I start digging to see what is missing?  TIA.</p>",
        "id": 694025,
        "sender_full_name": "hb-it",
        "timestamp": 1549311445
    },
    {
        "content": "<p>Should clarify on the clone I changed hostname, IP address and edited settings.py and our internal DNS to reflect the test hostname/IP.</p>",
        "id": 694028,
        "sender_full_name": "hb-it",
        "timestamp": 1549311749
    },
    {
        "content": "<p>Logger django_auth_ldap, from module django_auth_ldap.config line 157:<br>\nError generated by Anonymous user (not logged in) on zulip-test deployment</p>\n<p>No stack trace available</p>\n<p>Deployed code:<br>\n- ZULIP_VERSION: 1.9.2<br>\n- version: 1.9.2</p>",
        "id": 694034,
        "sender_full_name": "hb-it",
        "timestamp": 1549312337
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3275\">@hb-it</span> well, rabbitmq breaks when changing hostname, so that part isn't surprising.</p>",
        "id": 694074,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549316022
    },
    {
        "content": "<p>What happens when you do <code>manage.py query_ldap</code>?  That's the tool to use for debugging LDAP issues.</p>",
        "id": 694075,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549316036
    },
    {
        "content": "<p>My guess is you either had some sort of manual customization in your 1.6 version and that is what is failing here, or e.g. your LDAP firewall is blocking the new host.</p>",
        "id": 694076,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549316069
    },
    {
        "content": "<p>It's possible there is customization, I inherited this from the original person who is no longer here and of course left no docs for it. manage.py query_ldap returns command not found.</p>",
        "id": 694541,
        "sender_full_name": "hb-it",
        "timestamp": 1549369517
    },
    {
        "content": "<p>If we elect instead to start a new clean OS instead, is there a proven process to migrate 1.6 data to a new 1.9.2 server?</p>",
        "id": 694550,
        "sender_full_name": "hb-it",
        "timestamp": 1549371653
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3275\">@hb-it</span> see <a href=\"https://zulip.readthedocs.io/en/latest/production/maintain-secure-upgrade.html#management-commands\" target=\"_blank\" title=\"https://zulip.readthedocs.io/en/latest/production/maintain-secure-upgrade.html#management-commands\">https://zulip.readthedocs.io/en/latest/production/maintain-secure-upgrade.html#management-commands</a> for how to run management commands; I had been assuming you were familiar with the basics.</p>",
        "id": 694672,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549389593
    },
    {
        "content": "<p>The supported way to migrate data between systems involves both systems being on the same version.</p>",
        "id": 694674,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549389641
    },
    {
        "content": "<p>So you'll want to upgrade in any case.</p>",
        "id": 694676,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549389688
    },
    {
        "content": "<p>Ok got the hang of ./manage.py, thanks for that.          - so query_ldap any_user@ourdomain returns:</p>",
        "id": 694680,
        "sender_full_name": "hb-it",
        "timestamp": 1549390198
    },
    {
        "content": "<p>Traceback (most recent call last):<br>\n  File \"./manage.py\", line 29, in &lt;module&gt;<br>\n    execute_from_command_line(sys.argv)<br>\n  File \"/home/zulip/deployments/2017-09-17-17-01-30/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py\", line 367, in execute_from_command_line<br>\n    utility.execute()<br>\n  File \"/home/zulip/deployments/2017-09-17-17-01-30/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py\", line 359, in execute<br>\n    self.fetch_command(subcommand).run_from_argv(self.argv)<br>\n  File \"/home/zulip/deployments/2017-09-17-17-01-30/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py\", line 294, in run_from_argv<br>\n    self.execute(*args, **cmd_options)<br>\n  File \"/home/zulip/deployments/2017-09-17-17-01-30/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py\", line 345, in execute<br>\n    output = self.handle(*args, **options)<br>\n  File \"/home/zulip/deployments/2017-09-17-17-01-30/zerver/management/commands/query_ldap.py\", line 37, in handle<br>\n    query_ldap(**options)<br>\n  File \"/home/zulip/deployments/2017-09-17-17-01-30/zerver/management/commands/query_ldap.py\", line 27, in query_ldap<br>\n    print(\"%s: %s\" % (django_field, ldap_attrs[ldap_field]))<br>\n  File \"/home/zulip/deployments/2017-09-17-17-01-30/zulip-venv/lib/python2.7/site-packages/ldap/cidict.py\", line 27, in __getitem__<br>\n    return self.data[lower(key)]<br>\nKeyError: 'uidnumber'</p>",
        "id": 694682,
        "sender_full_name": "hb-it",
        "timestamp": 1549390207
    },
    {
        "content": "<p>OK; that definitely sounds like a configuration problem.  You should read the docs in <code>/etc/zulip/settings.py</code> (search for LDAP) and make sure <code>AUTH_LDAP_USER_ATTR_MAP</code> matches your LDAP database's configuration.</p>",
        "id": 694684,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549390280
    },
    {
        "content": "<p>(It sounds like your config is expecting your LDAP user objects to have a <code>uidnumber</code> field, and they don't?)</p>",
        "id": 694686,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549390298
    },
    {
        "content": "<p>Trying to install 1.6 (in order to migrate existing server) onto a clean Ubuntu 18 LTS VM,  getting \"Unsupported release bionic\" - is there a way to override this? Thanks In advance.</p>",
        "id": 697920,
        "sender_full_name": "hb-it",
        "timestamp": 1549896231
    },
    {
        "content": "<p>Also the above LDAP error happens on a working Zulip server so I don't know if the uidnumber field is actually the issue.</p>",
        "id": 697955,
        "sender_full_name": "hb-it",
        "timestamp": 1549904371
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3275\">@hb-it</span> no, 1.6 has no support for Bionic; you won't be able to install it.</p>",
        "id": 698075,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549913706
    },
    {
        "content": "<p>Ok - so we can't go that route then (matching versions in order to migrate). I've setup a new test VM, trying to connect to our LDAP (same AD as the production 1.6 server) - can't even get the new one to log in. Same settings as the old one as far as I can tell. Login screen comes up but won't accept any user/pass. Same errors as above re query_ldap. Strange thing is the old production server throws the same error yet logins are working on that one.</p>",
        "id": 698079,
        "sender_full_name": "hb-it",
        "timestamp": 1549913899
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3275\">@hb-it</span> and the new VM is running which version?</p>",
        "id": 698085,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549914124
    },
    {
        "content": "<p>Ubuntu 18.04 LTS and Zulip 1.9.2</p>",
        "id": 698086,
        "sender_full_name": "hb-it",
        "timestamp": 1549914141
    },
    {
        "content": "<p>OK.  <span class=\"user-mention\" data-user-id=\"3275\">@hb-it</span> I think your problem is most likely caused by that <code>query_ldap</code> traceback and you'll need to fix that.  If you want someone to debug this for you, this is probably the place you should get a formal support contract, since the problems seem very specific to your configuration and thus are beyond what we can offer as free best-effort support.</p>",
        "id": 698114,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549914917
    },
    {
        "content": "<p>Understood. Will keep looking at that.</p>",
        "id": 698116,
        "sender_full_name": "hb-it",
        "timestamp": 1549915038
    },
    {
        "content": "<p>(It's possible 1.9 got stricter about semi-broken LDAP configuration preventing login)</p>",
        "id": 698118,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549915065
    },
    {
        "content": "<p>I removed the UID completely from the settings.py - user lookups are now working successfully via manage.py - still no logins though.</p>",
        "id": 698124,
        "sender_full_name": "hb-it",
        "timestamp": 1549915363
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3275\">@hb-it</span> did you restart the server after making those settings changes?</p>",
        "id": 698163,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549917546
    },
    {
        "content": "<p>DId now - new server is working. On to trying to import the old data.</p>",
        "id": 698164,
        "sender_full_name": "hb-it",
        "timestamp": 1549917578
    },
    {
        "content": "<p>Great <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 698166,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549917619
    },
    {
        "content": "<p>My recommendation for doing this migration would be to import data between the same version.</p>",
        "id": 698167,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549917647
    },
    {
        "content": "<p>So if you want to move from trusty to bionic as part of the process, install a new trusty server on 1.6, migrate your data there using <code>pg_dump</code> (etc.), as we recommend in our backups section -- that's bulletproof.  And then upgrade that server to 1.9.1.  And then you can move data from that trusty server to a bionic server.</p>",
        "id": 698168,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549917698
    },
    {
        "content": "<p>(That is, if you're unwilling to upgrade your existing trusty server to 1.9, which is defintiely the simplest past)</p>",
        "id": 698169,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1549917712
    },
    {
        "content": "<p>Wasn't a question of unwilling, more that I could not get the production server upgraded in place, would not start after the 1.9 upgrade. Will try your suggested path next in another VM, thanks for the tip.</p>",
        "id": 698484,
        "sender_full_name": "hb-it",
        "timestamp": 1549977435
    },
    {
        "content": "<p>Hello, is there a correct way to restore a 1.9.2 server from a PSQL dump file?   Running the scripts in current/scripts/setups is producing various errors.    ./postgres-init-db: line 51: ./postgres-create-db: No such file or directory. To update, we managed to get a cloned VM from 1.6 to 1.9.2 on Ubuntu 14, now trying to import from pg_dump into a new clean 1.9.2 running on Ubuntu 18. That process I believe involves dropping the zulip db and letting the scripts create and initialize a new db before importing the dump file?</p>",
        "id": 704551,
        "sender_full_name": "hb-it",
        "timestamp": 1550679997
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3275\">@hb-it</span> Zulip 2.0 (which there's a release candidate for posted here: <a href=\"#narrow/stream/2-general/topic/Zulip.202.2E0.2E0-rc1/near/698367\" title=\"#narrow/stream/2-general/topic/Zulip.202.2E0.2E0-rc1/near/698367\">https://chat.zulip.org/#narrow/stream/2-general/topic/Zulip.202.2E0.2E0-rc1/near/698367</a>) has a <code>manage.py backup</code> and corresponding restore tool that I'd recommend for doing that sort of <code>pg_dump</code> process.</p>",
        "id": 704631,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1550682006
    },
    {
        "content": "<p>I'd expect the 1.9.2 to 2.0 upgrade to just work.</p>",
        "id": 704635,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1550682060
    },
    {
        "content": "<p>Ok will try that. Should I be able to import a 1.9.2 dump into 2.0?</p>",
        "id": 704638,
        "sender_full_name": "hb-it",
        "timestamp": 1550682118
    },
    {
        "content": "<p>No, you should upgrade the 1.9.2 to 2.0, and then do the dump + restore with that.</p>",
        "id": 704655,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1550682654
    },
    {
        "content": "<p>Oh, and that backup/restore tool expects the same postgres version on the two systems... so you might need to grab the default postgres version for bionic from a PPA and do the standard postgres database upgrade process on the 14.04 server before trying to import into bionic.</p>",
        "id": 704658,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1550682704
    },
    {
        "content": "<p>We have managed to get upgraded to 1.9.2 on Ubuntu 18,  by importing a 1.6 dump from the Ubuntu 14 vm and then running upgrade-zulip-stage-2  and copying over the uploads folder. Will look at 2.0 soon, but thanks for the direction to this point. All good! :-)</p>",
        "id": 705549,
        "sender_full_name": "hb-it",
        "timestamp": 1550781550
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3275\">@hb-it</span> glad to hear it <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 706040,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1550870995
    }
]