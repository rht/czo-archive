[
    {
        "content": "<p>Hi,<br>\nCurrently I'm trying to move Zulip to new server but import command crash right at the beginning of the process.</p>\n<div class=\"codehilite\"><pre><span></span>Processing dump: /home/zulip/zulip ...\n2019-12-04 18:59:22.691 INFO [] Importing realm dump /home/zulip/zulip\n2019-12-04 18:59:22.691 INFO [] Importing realm data from /home/zulip/zulip/realm.json\n2019-12-04 18:59:23.885 INFO [] Successfully imported &lt;class &#39;zerver.models.Stream&#39;&gt; from zerver_stream.\nTraceback (most recent call last):\n  File &quot;./manage.py&quot;, line 46, in &lt;module&gt;\n    execute_from_command_line(sys.argv)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 364, in execute_from_command_line\n    utility.execute()\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 356, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 283, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 330, in execute\n    output = self.handle(*args, **options)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/management/commands/import.py&quot;, line 79, in handle\n    realm = do_import_realm(path, subdomain, num_processes)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/import_realm.py&quot;, line 764, in do_import_realm\n    logging.info(&quot;Adding to ID map: %s %s&quot; % (item[&#39;id&#39;], get_system_bot(item[&#39;email&#39;]).id))\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/cache.py&quot;, line 167, in func_with_caching\n    val = func(*args, **kwargs)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/models.py&quot;, line 1882, in get_system_bot\n    return UserProfile.objects.select_related().get(email__iexact=email.strip())\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py&quot;, line 380, in get\n    self.model._meta.object_name\nzerver.models.DoesNotExist: UserProfile matching query does not exist.\n</pre></div>\n\n\n<p>Any tips?</p>",
        "id": 800487,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575486227
    },
    {
        "content": "<p>Both instances are running 2.0.7 but old one is... very old.</p>",
        "id": 800489,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575486291
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"2617\">@Paweł Jastrzębski</span> that looks like a system bot is missing.</p>",
        "id": 800497,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575487010
    },
    {
        "content": "<p>Which would suggest the database isn't properly initialized prior to running the import.</p>",
        "id": 800498,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575487039
    },
    {
        "content": "<p>Can you explain exactly how you setup the system you're importing into?</p>",
        "id": 800499,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575487047
    },
    {
        "content": "<p>Steps 1-2 <a href=\"https://zulip.readthedocs.io/en/latest/production/install.html\" target=\"_blank\" title=\"https://zulip.readthedocs.io/en/latest/production/install.html\">https://zulip.readthedocs.io/en/latest/production/install.html</a></p>",
        "id": 800500,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575487101
    },
    {
        "content": "<p>Plus I replaced contents of <code>/etc/zulip</code> with configs from old server.</p>",
        "id": 800501,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575487125
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> could this be a system bot that used to exist on the old server, but no longer gets created on newer versions?</p>",
        "id": 800502,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575487188
    },
    {
        "content": "<p>Did you try running the import process, delete the database, and rerun again at any point?</p>",
        "id": 800503,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575487194
    },
    {
        "content": "<p>That's certainly possible.</p>",
        "id": 800504,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575487198
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"2617\">@Paweł Jastrzębski</span> can you add  aprint statement to see what the email of the system bot in question is?</p>",
        "id": 800505,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575487209
    },
    {
        "content": "<p>I deleted unfinished import with <code>realm.delete()</code> but every time it produce the same error.</p>",
        "id": 800506,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575487273
    },
    {
        "content": "<p>Where to add it?</p>",
        "id": 800507,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575487279
    },
    {
        "content": "<p>The line above this one: <code>logging.info(\"Adding to ID map: %s %s\" % (item['id'], get_system_bot(item['email']).id))</code>; you can see the file and line number above.</p>",
        "id": 800508,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575487402
    },
    {
        "content": "<p>OK. One moment.</p>",
        "id": 800509,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575487413
    },
    {
        "content": "<p><code>notification-bot@zulip.com</code></p>",
        "id": 800510,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575487553
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>INTERNAL_BOTS = [{&#39;var_name&#39;: &#39;NOTIFICATION_BOT&#39;,\n                  &#39;email_template&#39;: &#39;notification-bot@%s&#39;,\n                  &#39;name&#39;: &#39;Notification Bot&#39;},\n</pre></div>\n\n\n<p>should exist  on news installs too</p>",
        "id": 800513,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575488446
    },
    {
        "content": "<p>This is only place in dump where I see that e-mail:</p>\n<div class=\"codehilite\"><pre><span></span>    &quot;zerver_userprofile_crossrealm&quot;:[\n        {\n            &quot;recipient_id&quot;:5,\n            &quot;id&quot;:5,\n            &quot;email&quot;:&quot;notification-bot@zulip.com&quot;\n        },\n        {\n            &quot;recipient_id&quot;:24,\n            &quot;id&quot;:13,\n            &quot;email&quot;:&quot;email-bot@my.domain&quot;\n        },\n        {\n            &quot;recipient_id&quot;:4,\n            &quot;id&quot;:4,\n            &quot;email&quot;:&quot;welcome-bot@zulip.com&quot;\n        }\n    ],\n</pre></div>",
        "id": 800517,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575488604
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"2617\">@Paweł Jastrzębski</span> can you try in the django shell (<code>manage.py shell</code> as the zulip user in the directory with the current deployment) the line</p>\n<div class=\"codehilite\"><pre><span></span>get_system_bot(&quot;notification-bot@zulip.com&quot;)\n</pre></div>",
        "id": 800518,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575488636
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>In [1]: get_system_bot(&quot;notification-bot@zulip.com&quot;)\n---------------------------------------------------------------------------\nDoesNotExist                              Traceback (most recent call last)\n&lt;ipython-input-1-48cbf9311d2a&gt; in &lt;module&gt;()\n----&gt; 1 get_system_bot(&quot;notification-bot@zulip.com&quot;)\n\n~/deployments/2019-11-22-09-58-06/zerver/lib/cache.py in func_with_caching(*args, **kwargs)\n    165                 return val[0]\n    166\n--&gt; 167             val = func(*args, **kwargs)\n    168\n    169             cache_set(key, val, cache_name=cache_name, timeout=timeout)\n\n~/deployments/2019-11-22-09-58-06/zerver/models.py in get_system_bot(email)\n   1880 @cache_with_key(bot_profile_cache_key, timeout=3600*24*7)\n   1881 def get_system_bot(email: str) -&gt; UserProfile:\n-&gt; 1882     return UserProfile.objects.select_related().get(email__iexact=email.strip())\n   1883\n   1884 def get_user_by_id_in_realm_including_cross_realm(\n\n~/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py in get(self, *args, **kwargs)\n    378             raise self.model.DoesNotExist(\n    379                 &quot;%s matching query does not exist.&quot; %\n--&gt; 380                 self.model._meta.object_name\n    381             )\n    382         raise self.model.MultipleObjectsReturned(\n\nDoesNotExist: UserProfile matching query does not exist.\n</pre></div>",
        "id": 800519,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575488669
    },
    {
        "content": "<p>So some basic DB initialization failed during setup?</p>",
        "id": 800520,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575488770
    },
    {
        "content": "<p>I don't remember seeing any errors.</p>",
        "id": 800521,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575488787
    },
    {
        "content": "<p>can you show</p>\n<div class=\"codehilite\"><pre><span></span>for bot in UserProfile.objects.filter(realm__string_id=&#39;zulipinternal&#39;):\n     print(bot.email)\n</pre></div>",
        "id": 800522,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575488945
    },
    {
        "content": "<p>nothing</p>",
        "id": 800523,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575488963
    },
    {
        "content": "<p>yeah, that's not right, bots should have been created on install <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 800524,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489001
    },
    {
        "content": "<p>OK. Any civilized way to re-init this instance? :-)</p>",
        "id": 800525,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489042
    },
    {
        "content": "<p>Just to be sure, does the realm exist:</p>\n<div class=\"codehilite\"><pre><span></span>get_realm(&quot;zulipinternal&quot;)\n</pre></div>",
        "id": 800526,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489115
    },
    {
        "content": "<p>no output</p>",
        "id": 800527,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489169
    },
    {
        "content": "<p>but no error?</p>\n<div class=\"codehilite\"><pre><span></span>In [3]: get_realm(&quot;zulipinternal&quot;)\nOut[3]: &lt;Realm: &lt;Realm: zulipinternal 1&gt;&gt;\n\nIn [4]: get_realm(&quot;zulipinternalkkk&quot;)\n---------------------------------------------------------------------------\nDoesNotExist                              Traceback (most recent call last)\n&lt;ipython-input-4-34d13167adbd&gt; in &lt;module&gt;\n----&gt; 1 get_realm(&quot;zulipinternalkkk&quot;)\n\n~/deployments/2019-11-16-10-04-50/zerver/models.py in get_realm(string_id)\n    520\n    521 def get_realm(string_id: str) -&gt; Realm:\n--&gt; 522     return Realm.objects.get(string_id=string_id)\n    523\n    524 def name_changes_disabled(realm: Optional[Realm]) -&gt; bool:\n\n~/deployments/2019-11-16-10-04-50/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/manager.py in manager_method(self, *args, **kwargs)\n     83         def create_method(name, method):\n     84             def manager_method(self, *args, **kwargs):\n---&gt; 85                 return getattr(self.get_queryset(), name)(*args, **kwargs)\n     86             manager_method.__name__ = method.__name__\n     87             manager_method.__doc__ = method.__doc__\n\n~/deployments/2019-11-16-10-04-50/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py in get(self, *args, **kwargs)\n    378             raise self.model.DoesNotExist(\n    379                 &quot;%s matching query does not exist.&quot; %\n--&gt; 380                 self.model._meta.object_name\n    381             )\n    382         raise self.model.MultipleObjectsReturned(\n\nDoesNotExist: Realm matching query does not exist.\n</pre></div>\n\n\n<p>Should be something, or an error <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 800528,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489234
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>Successfully imported Zulip settings, models, and actions functions.\n\nIn [1]: get_realm(&quot;zulipinternal&quot;)\n\nIn [2]: get_realm(&quot;zulipinternalkkk&quot;)\n\nIn [3]:\n</pre></div>",
        "id": 800529,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489319
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>        if Realm.objects.count() &gt; 0:\n            print(&quot;Database already initialized; doing nothing.&quot;)\n            return\n        realm = Realm.objects.create(string_id=settings.SYSTEM_BOT_REALM)\n</pre></div>\n\n\n<p>how about this? This is an instance we don't have to worry about messing up, right?</p>",
        "id": 800530,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489588
    },
    {
        "content": "<p><code>zerver_realm</code> table is empty</p>",
        "id": 800531,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489590
    },
    {
        "content": "<p>yeah it is fresh instance without data</p>",
        "id": 800532,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489608
    },
    {
        "content": "<p>ok, we can try being adventurous then</p>",
        "id": 800533,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489625
    },
    {
        "content": "<p>hmm or instead of running that <span class=\"user-mention\" data-user-id=\"2617\">@Paweł Jastrzębski</span></p>",
        "id": 800534,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489670
    },
    {
        "content": "<p>Just try <code>manage.py initialize_voyager_db</code>?</p>",
        "id": 800535,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489683
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>In [3]: realm = Realm.objects.create(string_id=settings.SYSTEM_BOT_REALM)\n\nIn [4]: realm\nOut[4]: &lt;Realm: &lt;Realm: zulip 4&gt;&gt;\n</pre></div>",
        "id": 800536,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489695
    },
    {
        "content": "<p>too late ;p</p>",
        "id": 800537,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489698
    },
    {
        "content": "<p><code>realm.delete()</code> still in this shell</p>\n<p>and then run that management command</p>",
        "id": 800538,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489743
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>zulip@balin:~/deployments/current$ ./manage.py initialize_voyager_db\nSuccessfully populated database with initial data.\nPlease run ./manage.py generate_realm_creation_link to generate link for creating organization\n</pre></div>",
        "id": 800539,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489779
    },
    {
        "content": "<p>Try importing now <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 800540,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489800
    },
    {
        "content": "<p><code>get_realm(\"zulipinternal\")</code> still return nothing</p>",
        "id": 800541,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489816
    },
    {
        "content": "<p>and the tables are empty?</p>",
        "id": 800542,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489848
    },
    {
        "content": "<p>one record</p>",
        "id": 800543,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489883
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>zulip=&gt; select * from zerver_realm;\n-[ RECORD 1 ]----------------------------------+------------------------------\nid                                             | 5\nname                                           |\nemails_restricted_to_domains                   | f\ninvite_required                                | t\ninvite_by_admins_only                          | f\nmandatory_topics                               | f\ndigest_emails_enabled                          | t\nname_changes_disabled                          | f\ndate_created                                   | 2019-12-04 20:02:48.850264+00\ndeactivated                                    | f\nnotifications_stream_id                        |\ncreate_stream_by_admins_only                   | f\nallow_message_editing                          | t\nmessage_content_edit_limit_seconds             | 600\ndefault_language                               | en\nstring_id                                      | zulip\norg_type                                       | 1\nmessage_retention_days                         |\nauthentication_methods                         | 2147483647\nwaiting_period_threshold                       | 0\nadd_emoji_by_admins_only                       | f\nicon_source                                    | G\nicon_version                                   | 1\nemail_changes_disabled                         | f\ndescription                                    |\ninline_image_preview                           | t\ninline_url_embed_preview                       | t\nallow_edit_history                             | t\nallow_message_deleting                         | f\nsignup_notifications_stream_id                 |\nmax_invites                                    |\nmessage_visibility_limit                       |\nupload_quota_gb                                |\nsend_welcome_emails                            | t\nbot_creation_policy                            | 1\ndisallow_disposable_email_addresses            | t\nallow_community_topic_editing                  | t\ndefault_twenty_four_hour_time                  | f\nvideo_chat_provider                            | Jitsi\ngoogle_hangouts_domain                         |\nmessage_content_delete_limit_seconds           | 600\nplan_type                                      | 1\nemail_address_visibility                       | 1\nfirst_visible_message_id                       | 0\nlogo_source                                    | D\nlogo_version                                   | 1\nzoom_api_key                                   |\nzoom_api_secret                                |\nzoom_user_id                                   |\nmessage_content_allowed_in_email_notifications | t\nnight_logo_source                              | D\nnight_logo_version                             | 1\n</pre></div>",
        "id": 800544,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575489885
    },
    {
        "content": "<p><code>print(settings.SYSTEM_BOT_REALM)</code> in the shell?</p>",
        "id": 800545,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575489967
    },
    {
        "content": "<p><code>zulip</code></p>",
        "id": 800546,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490021
    },
    {
        "content": "<p>Ah, this is 2.0.7, so I think this is right. Can you just try importing now?</p>",
        "id": 800547,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575490061
    },
    {
        "content": "<p>OK.</p>",
        "id": 800548,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490094
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>zulip@balin:~/deployments/current$ ./manage.py import &#39;&#39; ~/zulip\nProcessing dump: /home/zulip/zulip ...\n2019-12-04 20:08:28.081 INFO [] Importing realm dump /home/zulip/zulip\n2019-12-04 20:08:28.081 INFO [] Importing realm data from /home/zulip/zulip/realm.json\n2019-12-04 20:08:29.289 INFO [] Successfully imported &lt;class &#39;zerver.models.Stream&#39;&gt; from zerver_stream.\nnotification-bot@zulip.com\nnotification-bot@zulip.com\n2019-12-04 20:08:29.296 INFO [] Adding to ID map: 5 7\nemail-bot@my.domain\nemail-bot@my.domain\nTraceback (most recent call last):\n  File &quot;./manage.py&quot;, line 46, in &lt;module&gt;\n    execute_from_command_line(sys.argv)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 364, in execute_from_command_line\n    utility.execute()\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/__init__.py&quot;, line 356, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 283, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/core/management/base.py&quot;, line 330, in execute\n    output = self.handle(*args, **options)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/management/commands/import.py&quot;, line 79, in handle\n    realm = do_import_realm(path, subdomain, num_processes)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/import_realm.py&quot;, line 766, in do_import_realm\n    logging.info(&quot;Adding to ID map: %s %s&quot; % (item[&#39;id&#39;], get_system_bot(item[&#39;email&#39;]).id))\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/cache.py&quot;, line 167, in func_with_caching\n    val = func(*args, **kwargs)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/models.py&quot;, line 1882, in get_system_bot\n    return UserProfile.objects.select_related().get(email__iexact=email.strip())\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py&quot;, line 380, in get\n    self.model._meta.object_name\nzerver.models.DoesNotExist: UserProfile matching query does not exist.\n</pre></div>",
        "id": 800549,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490120
    },
    {
        "content": "<p>this time it exploded on some old internal bot</p>",
        "id": 800550,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490172
    },
    {
        "content": "<p>custom one</p>",
        "id": 800551,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490175
    },
    {
        "content": "<p>I'm trying to remember why it exist.</p>",
        "id": 800552,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490195
    },
    {
        "content": "<p>I'm guessing it was used for EMAIL_GATEWAY.</p>",
        "id": 800553,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490275
    },
    {
        "content": "<p>Yeah. It was used as EMAIL_GATEWAY_BOT.</p>",
        "id": 800554,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490342
    },
    {
        "content": "<p>So how fix that? :-)</p>",
        "id": 800555,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490361
    },
    {
        "content": "<p>Drop it from <code>zerver_userprofile_crossrealm</code> and pray?</p>",
        "id": 800557,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490436
    },
    {
        "content": "<p>we could try adding it to the database manually</p>",
        "id": 800558,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575490512
    },
    {
        "content": "<p>hmmm or in the import code in this snippet:</p>\n<div class=\"codehilite\"><pre><span></span>    for item in data[&#39;zerver_userprofile_crossrealm&#39;]:\n        if item[&#39;email&#39;].startswith(&quot;emailgateway@&quot;):\n</pre></div>",
        "id": 800559,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575490615
    },
    {
        "content": "<p>Change that second conditional to <code>if item['email'].startswith(\"email-bot@\"):</code>?</p>",
        "id": 800560,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575490654
    },
    {
        "content": "<p>and retry importing</p>",
        "id": 800561,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575490697
    },
    {
        "content": "<p>I looks like it is importing it.</p>",
        "id": 800562,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490761
    },
    {
        "content": "<p>But I'm quite sure it will explode somewhere else :-)</p>",
        "id": 800563,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490770
    },
    {
        "content": "<p>This is ~4y old instance. I not expected that import will go smoothly.</p>",
        "id": 800564,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490811
    },
    {
        "content": "<p>is instance need to be up for import?</p>",
        "id": 800565,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490832
    },
    {
        "content": "<p>because im getting tons of <code>MemcachedError</code> error 15 and 21 during avatar import</p>",
        "id": 800566,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490852
    },
    {
        "content": "<p>but it not crashed</p>",
        "id": 800567,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490886
    },
    {
        "content": "<p>now only parse 1799 json files with messages</p>",
        "id": 800568,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575490943
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 800571,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491195
    },
    {
        "content": "<p>If it fails from the MemcacheErrors, I think I'd just try wiping the server and installing again - because something clearly went wrong in the installation, and if the failure was more than just the <code>initialize_voyager_db</code> script not running, it's too hard to figure it out and whether it may cause the current errors. With a succesfull install, I'd repeat the import code change that we just did and try importing then <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 800572,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575491246
    },
    {
        "content": "<p>I rather not wipe this server as some time was already invested to prepare it.</p>",
        "id": 800573,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491319
    },
    {
        "content": "<p>So lets keep that as last resort.</p>",
        "id": 800574,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491332
    },
    {
        "content": "<p>But it also mean that install script failed and not crashed.</p>",
        "id": 800575,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491388
    },
    {
        "content": "<p>Nothing weird in <code>/var/log/zulip/install.log</code>?</p>",
        "id": 800576,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575491516
    },
    {
        "content": "<p>Sadly I wiped that logs some time ago.</p>",
        "id": 800577,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491540
    },
    {
        "content": "<p>But I don't remember seeing any errors during install.</p>",
        "id": 800578,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491555
    },
    {
        "content": "<p>If this test import will succeed I think I will nuke this VM anyway.</p>",
        "id": 800579,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491605
    },
    {
        "content": "<p>Better safe than sorry.</p>",
        "id": 800580,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491611
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>2019-12-04 20:35:50.269 INFO [] Successfully imported &lt;class &#39;analytics.models.RealmCount&#39;&gt; from analytics_realmcount.\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py&quot;, line 64, in execute\n    return self.cursor.execute(sql, params)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/db.py&quot;, line 32, in execute\n    return wrapper_execute(self, super().execute, query, vars)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/db.py&quot;, line 19, in wrapper_execute\n    return action(sql, params)\npsycopg2.OperationalError: out of memory\nDETAIL:  Failed on request of size 262144.\n</pre></div>",
        "id": 800581,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491868
    },
    {
        "content": "<p>:-|</p>",
        "id": 800582,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575491872
    },
    {
        "content": "<p>Seems like it happened in <code>import_analytics_data</code>?</p>",
        "id": 800586,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575492387
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>def bulk_import_model(data: TableData, model: Any, dump_file_id: Optional[str]=None) -&gt; None:\n    table = get_db_table(model)\n    # TODO, deprecate dump_file_id\n    model.objects.bulk_create(model(**item) for item in data[table])\n    if dump_file_id is None:\n        logging.info(&quot;Successfully imported %s from %s.&quot; % (model, table))\n    else:\n        logging.info(&quot;Successfully imported %s from %s[%s].&quot; % (model, table, dump_file_id))\n</pre></div>\n\n\n<p>Shouldn't we add batching in this function, to avoid these kinds of crashes for huge tables? <span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span></p>",
        "id": 800587,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575492433
    },
    {
        "content": "<p>my analytics.json have 400mb</p>",
        "id": 800589,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575492444
    },
    {
        "content": "<p>also memcached is working correctly</p>",
        "id": 800591,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575492906
    },
    {
        "content": "<p>Awful code, but I'm in a hurry, can you try replacing the function with this and importing again?</p>\n<div class=\"codehilite\"><pre><span></span>def bulk_import_model(data: TableData, model: Any, dump_file_id: Optional[str]=None) -&gt; None:\n    table = get_db_table(model)\n    # TODO, deprecate dump_file_id\n    BATCH_SIZE = 100\n    current_batch = []\n    for item in data[table]:\n        current_batch.append(item)\n        if len(current_batch) &gt;= BATCH_SIZE:\n            model.objects.bulk_create(model(**item) for item in current_batch)\n            current_batch = []\n\n    if len(current_batch) &gt;= 0:\n        model.objects.bulk_create(model(**item) for item in current_batch)\n\n    if dump_file_id is None:\n        logging.info(&quot;Successfully imported %s from %s.&quot; % (model, table))\n    else:\n        logging.info(&quot;Successfully imported %s from %s[%s].&quot; % (model, table, dump_file_id))\n</pre></div>",
        "id": 800592,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575493043
    },
    {
        "content": "<p>in how big batches avatars are imported?</p>",
        "id": 800593,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575493063
    },
    {
        "content": "<p>I replaced that function. We will know in few minutes.</p>",
        "id": 800595,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575493204
    },
    {
        "content": "<p>We don't store the avatar data in the database I think (only file paths), so I doubt this was about it</p>",
        "id": 800596,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575493223
    },
    {
        "content": "<p>Its looks like pylibmc is hitting some memcached limit and/or threading issue during avatar parsing.</p>",
        "id": 800597,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575493610
    },
    {
        "content": "<p>How much memory does your system have?</p>",
        "id": 800603,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575493990
    },
    {
        "content": "<p>16gb</p>",
        "id": 800604,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575494015
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> import completed.</p>",
        "id": 800605,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575494548
    },
    {
        "content": "<p>And things look reasonable in the imported realm?</p>",
        "id": 800606,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575494583
    },
    {
        "content": "<p>I would say no considering that Tornado can't connect to RabbitMQ</p>",
        "id": 800607,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575494671
    },
    {
        "content": "<p>I presume that overwriting <code>zulip-secrets.conf</code> broken something.</p>",
        "id": 800608,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575494701
    },
    {
        "content": "<p><code>rabbitmq_password</code> ?</p>",
        "id": 800609,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575494711
    },
    {
        "content": "<p>Yeah, overwriting that would be problematic.</p>",
        "id": 800610,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575494807
    },
    {
        "content": "<p>\"If your new Zulip server is meant to fully replace a previous Zulip server, you may want to copy the contents of /etc/zulip to your new server to reuse the server-level configuration and secret keys from your old server.\"</p>",
        "id": 800611,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575494834
    },
    {
        "content": "<p>This is quote from documentation.</p>",
        "id": 800612,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575494843
    },
    {
        "content": "<p>OK. <code>./scripts/setup/configure-rabbitmq</code> fixed that</p>",
        "id": 800615,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575495156
    },
    {
        "content": "<p>Hmm, yeah, that instruction should be adjusted I think</p>",
        "id": 800616,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575495410
    },
    {
        "content": "<p>any other secret trap I should know?</p>",
        "id": 800617,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575495449
    },
    {
        "content": "<p>Not any I'm aware of</p>",
        "id": 800618,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575495717
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> <span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> OK. I think it is working correctly.</p>",
        "id": 800624,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575496943
    },
    {
        "content": "<p>What a journey.</p>",
        "id": 800625,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575496948
    },
    {
        "content": "<p>Avatars and logos declared in <code>Organization profile</code> not survived the import.</p>",
        "id": 800626,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575496976
    },
    {
        "content": "<p>Yes, that's known... there's an issue open for that.</p>",
        "id": 800628,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575497126
    },
    {
        "content": "<p>Also all links to custom emoji in older messages</p>",
        "id": 800629,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575497214
    },
    {
        "content": "<p>have old realm id in url</p>",
        "id": 800630,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575497223
    },
    {
        "content": "<p>I will make sure that real import will re-use old realm id.</p>",
        "id": 800631,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575497284
    },
    {
        "content": "<p>Eh I forgot about most important part: Thank you for your help :-)</p>",
        "id": 800633,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575498484
    },
    {
        "content": "<p>Well made my migration. Everything not counting analytics survived.</p>",
        "id": 800883,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575705427
    },
    {
        "content": "<p><code>manage.py update_analytics_counts</code> return:</p>",
        "id": 800884,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575705447
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>Traceback (most recent call last):\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py&quot;, line 64, in execute\n    return self.cursor.execute(sql, params)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/db.py&quot;, line 32, in execute\n    return wrapper_execute(self, super().execute, query, vars)\n  File &quot;/home/zulip/deployments/2019-11-22-09-58-06/zerver/lib/db.py&quot;, line 19, in wrapper_execute\n    return action(sql, params)\npsycopg2.IntegrityError: duplicate key value violates unique constraint &quot;analytics_usercount_user_id_property_subgrou_0597562a_uniq&quot;\nDETAIL:  Key (user_id, property, subgroup, end_time)=(9, messages_sent:is_bot:hour, false, 2015-11-25 11:00:00+00) already exists.\n</pre></div>",
        "id": 800885,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575705471
    },
    {
        "content": "<p>stats page don't display anything</p>",
        "id": 800886,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575705491
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>2019-12-07 07:56:34.571 WARN [] User from realm  attempted to access /stats, but the computed start time: 2015-11-25 09:25:41.249450+00:00 (creation of realm or installation) is later than the computed end time: 0001-01-01 00:00:00+00:00 (last successful analytics update). Is the analytics cron job running?\n</pre></div>",
        "id": 800887,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575705500
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"2617\">@Paweł Jastrzębski</span> just to be clear, what changes did you make to re-use the realm ID?  Just creating realms until the right ID came up?</p>",
        "id": 800929,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575746642
    },
    {
        "content": "<p>I think I know what the bug analytics bug is; the FillState table (which keeps track of whether analytics data is up to date) wasn't transferred properly.</p>",
        "id": 800930,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575746728
    },
    {
        "content": "<p>It should be possible to fix your analytics situation by just creating the right <code>FillState</code> records.</p>",
        "id": 800932,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575746775
    },
    {
        "content": "<p>It's a bit tricky to define what \"transferred properly\" would mean importing into a server hosting other realms, but in the case where one's going from a server hosting a single realm to another one just wants to transfer the whole table.</p>",
        "id": 800933,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575746797
    },
    {
        "content": "<p>Thanks for the report.  Are you up for potentially redoing the import?  If so I can put together a quick patch that should handle transferring <code>FillState</code></p>",
        "id": 800934,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575746841
    },
    {
        "content": "<p>I opened <a href=\"https://github.com/zulip/zulip/issues/13486\" target=\"_blank\" title=\"https://github.com/zulip/zulip/issues/13486\">https://github.com/zulip/zulip/issues/13486</a> to track fixing that issue properly.</p>",
        "id": 800935,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575747926
    },
    {
        "content": "<p>(The organization avatar import issue is <a href=\"https://github.com/zulip/zulip/issues/11216\" target=\"_blank\" title=\"https://github.com/zulip/zulip/issues/11216\">https://github.com/zulip/zulip/issues/11216</a>)</p>",
        "id": 800936,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575747967
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"52\">@Vishnu Ks</span> if you have time, these could be good projects for you.</p>",
        "id": 800937,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575747982
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> I dropped entire database and recreated it from scratch. So internal realm now have id 1 and imported 2 as in the old insance.</p>",
        "id": 800938,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575748186
    },
    {
        "content": "<p>No. Another import is a no-go.</p>",
        "id": 800939,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575748228
    },
    {
        "content": "<p>New instance is already in use.</p>",
        "id": 800940,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575748236
    },
    {
        "content": "<p>So I can't fix it without another re-import?</p>",
        "id": 800941,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575748792
    },
    {
        "content": "<p>I still can start old server and transplant raw SQL if needed/if possible.</p>",
        "id": 800942,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575748881
    },
    {
        "content": "<p>huh also</p>",
        "id": 800943,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575749237
    },
    {
        "content": "<p>old messages that highlighted me look like this:</p>",
        "id": 800944,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575749248
    },
    {
        "content": "<p><a href=\"/user_uploads/2/7a/Fj6BJNWOi-iYAJf6AyieZb8h/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/7a/Fj6BJNWOi-iYAJf6AyieZb8h/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/7a/Fj6BJNWOi-iYAJf6AyieZb8h/pasted_image.png\"></a></div>",
        "id": 800945,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575749275
    },
    {
        "content": "<p>New ones are OK.</p>",
        "id": 800946,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575749285
    },
    {
        "content": "<p>What a humiliation... My own IT infrastructure consider me a bot :-D</p>",
        "id": 800947,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575749329
    },
    {
        "content": "<p>Generally I feel there was no many people who did this process for so old instance.</p>",
        "id": 800948,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575749386
    },
    {
        "content": "<p>It affects 2-3 first users in \"normal\" realm. Educated guess - it pulled data from crossrealm bots.</p>",
        "id": 800949,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575749938
    },
    {
        "content": "<p>Yeah. It affects two first users from \"normal\" realm.</p>",
        "id": 800950,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575750362
    },
    {
        "content": "<p>Unrelated question: Is <code>reminder-bot@zulip.com</code> is still used?</p>",
        "id": 800951,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575750559
    },
    {
        "content": "<p>Because I see it on normal bot list for my realm.</p>",
        "id": 800952,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575750594
    },
    {
        "content": "<p>Made quick dive in <code>zerver_message</code></p>",
        "id": 800954,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575751634
    },
    {
        "content": "<p><code>content</code> and <code>rendered_content</code> contain proper tag</p>",
        "id": 800955,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575751663
    },
    {
        "content": "<p><code>data-user-id=</code> in <code>rendered_content</code> is wrong</p>",
        "id": 800956,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575751730
    },
    {
        "content": "<p>it is shifted by 2 for two users</p>",
        "id": 800957,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575751752
    },
    {
        "content": "<p>Nope. I'm wrong. I think everybody is shifted.</p>",
        "id": 800958,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575751977
    },
    {
        "content": "<p>That is bad.</p>",
        "id": 800959,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575751982
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> Every <code>data-user-id</code> in all <code>rendered_content</code> fields in <code>zerver_message</code> table is shifted.</p>",
        "id": 800960,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575752304
    },
    {
        "content": "<p>That's part 1 in the issue <a href=\"https://github.com/zulip/zulip/issues/11293\" target=\"_blank\" title=\"https://github.com/zulip/zulip/issues/11293\">https://github.com/zulip/zulip/issues/11293</a> and should be fixed, but I believe the fix is not included in 2.0.7. Will be in 2.1. Let me check to make sure</p>",
        "id": 800961,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575752325
    },
    {
        "content": "<p>Profile name in tag is correct. But data-user-id is wrong.</p>",
        "id": 800962,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575752357
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> OK. And it will be fixed backwards?</p>",
        "id": 800963,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575752544
    },
    {
        "content": "<p>I checked, yeah, it's not in 2.0.x, it's scheduled for 2.1. I believe it'll be fixed for new imports, it won't correct what's already imported.</p>",
        "id": 800964,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1575752719
    },
    {
        "content": "<p>Well then I'm fucked.</p>",
        "id": 800965,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575752757
    },
    {
        "content": "<p>Import/Export documentation definitely require KNOWN ISSUES section.</p>",
        "id": 800967,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575752844
    },
    {
        "content": "<p>If I would know in how bad state this mechanism is I would never tried to migrate this instance.</p>",
        "id": 800968,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575752922
    },
    {
        "content": "<p>I also see that <code>span</code> no longer have <code>data-user-email</code> so I can't use it to fix it.</p>",
        "id": 800970,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575753195
    },
    {
        "content": "<p>Can I even edit <code>rendered_content</code> in bulk? Or it will break something else.</p>",
        "id": 800971,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575753253
    },
    {
        "content": "<p>Additionally I have multiple reports that import marked all messages as unread.</p>",
        "id": 801072,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575872216
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> <span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span>  So, to sum up:</p>\n<ul>\n<li>Analytic import step don't parse JSON in batches and that can cause OOM errors.</li>\n<li>Even then analytic import is broken due to missing information in export dump.</li>\n<li>If new realmid is other that old then custom emoji links in old messages are broken.</li>\n<li>Documentation missing information that reusing secrets from old instance require reinitialization of rabbitmq.</li>\n<li>Realm logos (and realm name) are not part of export dump.</li>\n<li>Import breaks all highlights in old messages.</li>\n<li>For some users process reset status of read messages.</li>\n<li>Memcached errors during import IMHO require some investigation.</li>\n<li>Export don't work at all if old ream used custom <code>EMAIL_GATEWAY_BOT</code> but that was our fault and I don't think that is an error.</li>\n</ul>",
        "id": 801073,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575875313
    },
    {
        "content": "<p>Generally in my opinion documentation should be updated to clearly mark that Import/Export mechanism is not production ready.</p>",
        "id": 801074,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575875380
    },
    {
        "content": "<p>Because this process corrupted my 4 year old realm and I probably can't make a rollback.</p>",
        "id": 801075,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575875470
    },
    {
        "content": "<p>So i have two follow up questions:</p>\n<ol>\n<li>How I can fix my analytic module and if I can't how to nuke it so it start to collect data from scratch?</li>\n<li>How to fix old highlights?</li>\n</ol>",
        "id": 801076,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575875657
    },
    {
        "content": "<p>Generally I blame mostly myself I not tested instance more during week when I prepared everything for this migration. But at the same time some of these problems were known (<a href=\"https://github.com/zulip/zulip/pull/11293\" target=\"_blank\" title=\"https://github.com/zulip/zulip/pull/11293\">#11293</a> have almost year...) and yet there was no mention about them in documentation.</p>",
        "id": 801077,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575875738
    },
    {
        "content": "<p>Also it would be nice to have manage.py command to set all messages read realm-wide.</p>",
        "id": 801078,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575875861
    },
    {
        "content": "<p>Sigh. People receive notifications from not their conversations.</p>",
        "id": 801091,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575890556
    },
    {
        "content": "<p>I going to make emergency rollback.</p>",
        "id": 801092,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575890586
    },
    {
        "content": "<p>I have users who receive mobile notifications not from their accounts...</p>",
        "id": 801095,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575891543
    },
    {
        "content": "<p>How the hell is even possible?</p>",
        "id": 801096,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575891560
    },
    {
        "content": "<p>This is complete disaster.</p>",
        "id": 801100,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575892042
    },
    {
        "content": "<p>There is something wrong with avatars too.</p>",
        "id": 801102,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575892541
    },
    {
        "content": "<p>Some people see somebody else avatar as their own.</p>",
        "id": 801103,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575892560
    },
    {
        "content": "<p>But only them - rest see it correctly.</p>",
        "id": 801104,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575892568
    },
    {
        "content": "<p>And it is not client side cache issue.</p>",
        "id": 801106,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575892575
    },
    {
        "content": "<p><code>bankrupt_users</code> is a command i was looking for</p>",
        "id": 801114,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575897194
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"2617\">@Paweł Jastrzębski</span> sorry for the trouble, and thanks for all the reports.  I don't believe other folks have experienced similar issues doing this process, so I'm wondering what the difference is.  Can you talk about what versions the two servers were running and any details about differences in the set of realms hosted on the two servers?</p>",
        "id": 801255,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575939977
    },
    {
        "content": "<p>Just making sure we have all of these tracked:</p>\n<blockquote>\n<p>Analytic import step don't parse JSON in batches and that can cause OOM errors.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> can you submit a PR for this since it looks like you already investigated and written a patch earlier in this thread?  <a href=\"#narrow/stream/31-production-help/topic/Realm.20import/near/800592\" title=\"#narrow/stream/31-production-help/topic/Realm.20import/near/800592\">https://chat.zulip.org/#narrow/stream/31-production-help/topic/Realm.20import/near/800592</a>.</p>\n<blockquote>\n<p>Memcached errors during import IMHO require some investigation.</p>\n</blockquote>\n<p>Likely caused by the system being under RAM pressure.  I've updated our recommend to suggest shutting down the Zulip server while one does an import if the system has limited free RAM: <a href=\"https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34\">79604c781742ed9ddafd995d213bf80040900c34</a>.</p>\n<blockquote>\n<p>Even then analytic import is broken due to missing information in export dump.  </p>\n</blockquote>\n<p>This is <a href=\"https://github.com/zulip/zulip/issues/13486\" target=\"_blank\" title=\"https://github.com/zulip/zulip/issues/13486\">https://github.com/zulip/zulip/issues/13486</a>.  Probably you'll get a decent result if you just skip importing the analytics data (it can be rebuilt from other tables).  Deleting via  <code>RealmCount.objects.all.delete()</code> and similarly for <code>UserCount</code> and <code>StreamCount</code> is likely to be an effective immediate workaround, as then it'll just regenerate the data from scratch.  But once <a href=\"https://github.com/zulip/zulip/pull/13486\" target=\"_blank\" title=\"https://github.com/zulip/zulip/pull/13486\">#13486</a> is done we will have a cleaner fix that I would recommend if you're not in a hurry.</p>\n<blockquote>\n<p>If new realmid is other that old then custom emoji links in old messages are broken.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"52\">@Vishnu Ks</span> I think this is an issue very similar to <a href=\"https://github.com/zulip/zulip/commit/ce1d6044db446673fc86795028918c415c4d160f\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/ce1d6044db446673fc86795028918c415c4d160f\">ce1d6044db446673fc86795028918c415c4d160f</a>; would you be up for taking this up?  I don't have time to open an issue for this right now but it should be straightforward given what we've already implemented.</p>\n<blockquote>\n<p>Documentation missing information that reusing secrets from old instance require reinitialization of rabbitmq.</p>\n</blockquote>\n<p>Fixed in <a href=\"https://github.com/zulip/zulip/commit/6ca56f81f225c53c0eb6108007b0bcdd08fdf461\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/6ca56f81f225c53c0eb6108007b0bcdd08fdf461\">6ca56f81f225c53c0eb6108007b0bcdd08fdf461</a>.</p>\n<blockquote>\n<p>Realm logos (and realm name) are not part of export dump.</p>\n</blockquote>\n<p>This is <a href=\"https://github.com/zulip/zulip/issues/11216\" target=\"_blank\" title=\"https://github.com/zulip/zulip/issues/11216\">https://github.com/zulip/zulip/issues/11216</a>.  I don't consider it to be a high priority because it's easy to fix manually, but it'd be nice to do it right for visual polish reasons.  I think it's on <span class=\"user-mention\" data-user-id=\"52\">@Vishnu Ks</span>'s TODO list.</p>\n<blockquote>\n<p>Import breaks all highlights in old messages.</p>\n</blockquote>\n<p>This was fixed in master months ago, and the fix is present in Zulip 2.1-rc1.  I suppose we should have suggested upgrading to the release candidate first if we'd thought of this.  </p>\n<blockquote>\n<p>For some users process reset status of read messages.</p>\n</blockquote>\n<p>Can you provide details on this?  I don't understand a mechanism for how that would happen, given that we just preserve the flags from before the import in the migration...</p>\n<blockquote>\n<p>Export don't work at all if old ream used custom <code>EMAIL_GATEWAY_BOT</code> but that was our fault and I don't think that is an error.</p>\n</blockquote>\n<p>Yeah, that's not a recommended configuration or one that we still document, but I still consider it a bug.  Opened <a href=\"https://github.com/zulip/zulip/pull/13496\" target=\"_blank\" title=\"https://github.com/zulip/zulip/pull/13496\">#13496</a> since I think the fix is likely simple.</p>\n<blockquote>\n<p>There is something wrong with avatars too.</p>\n</blockquote>\n<p>We fixed an issue with avatars and the S3 file upload backend in the import process in master a few months ago, so this is likely already fixed for Zulip 2.1-rc1.  Are you using that backend?  It's also possible you're seeing a browser caching issue if you're using the same hostname for your new server (since you'd have different avatars at the same filename?).</p>\n<blockquote>\n<p>I have users who receive mobile notifications not from their accounts...</p>\n</blockquote>\n<p>Yuck, thanks for reporting this!  I think I know exactly why this happened; it is an unintended consequence of copying over <code>zulip-secrets.conf</code> with users' IDs being renumbered; the protocol with the push notification bouncer server identifies whose devices to push to via <code>(zulip_org_id, user_id)</code> pairs, and by copying that file, you'll end up with the <code>zulip_org_id</code> (and its corresponding secret) being preserved with the <code>user_id</code> values being scrambled.  This is fixable in the short term by clearing push notifications bouncer state; simplest is to just delete the <code>zulip_org_*</code> settings in <code>zulip-secrets.conf</code> and re-register for push notifications.  And I'll update the documentation to warn about this issue.</p>",
        "id": 801261,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575941813
    },
    {
        "content": "<p>I merged <a href=\"https://github.com/zulip/zulip/commit/c6fe6cf0a47cd61c0005aa099b9f7fa16d96f603\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/c6fe6cf0a47cd61c0005aa099b9f7fa16d96f603\">c6fe6cf0a47cd61c0005aa099b9f7fa16d96f603</a> to address the bundle of issues caused by copying <code>zulip-secrets.conf</code>.   I think that recommend was more or less wrong, having been incorrectly copied from the backups situation (where it was correct).</p>",
        "id": 801269,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575943110
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"2617\">@Paweł Jastrzębski</span> out of curiousity, why didn't you use the backups system for this migration?  We recommend it pretty strongly for most use cases (including most any where copying secrets might be relevant).  </p>\n<p>In any case, thanks again for all of these reports.  While some of them are already fixed for our next release, others are not.</p>",
        "id": 801270,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575943185
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> Both instances were using 2.0.7. But old one was really old. ~2m messages, 400 users, Ubuntu 14.04 and that was Zulip updated release after release starting from 2015-11-25.</p>",
        "id": 801296,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575958935
    },
    {
        "content": "<p>I used full import/export procedure as new server had newer psql. Now I know that I should make copy of old VM update system there to align psql versions and use normal backup mechanism.</p>",
        "id": 801297,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575959009
    },
    {
        "content": "<p>That lesson cost me 3 days of production data :-P</p>",
        "id": 801298,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575959104
    },
    {
        "content": "<blockquote>\n<p>Likely caused by the system being under RAM pressure. I've updated our recommend to suggest shutting down the Zulip server while one does an import if the system has limited free RAM: <a href=\"https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34\">79604c781742ed9ddafd995d213bf80040900c34</a>.</p>\n</blockquote>\n<p>During import process new machine had ~15gb of free ram. I didn't keep full stack but all of them were MemcachedError error 15 and 21</p>",
        "id": 801299,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575959262
    },
    {
        "content": "<blockquote>\n<p>Can you provide details on this? I don't understand a mechanism for how that would happen, given that we just preserve the flags from before the import in the migration...</p>\n</blockquote>\n<p>Sadly I can't. As I not replicated this issue. Few users after login in to new instance had all messages from X years marked as unread.</p>",
        "id": 801300,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575959392
    },
    {
        "content": "<p>I was wrong about avatar issue. It was browser cache issue. Still only ~10% of users were affected.</p>",
        "id": 801301,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575959505
    },
    {
        "content": "<p>So to confirm. If I use normal backup and restore it on different machine I don't need to reset mobile notification secrets?</p>",
        "id": 801302,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575959848
    },
    {
        "content": "<blockquote>\n<p>So to confirm. If I use normal backup and restore it on different machine I don't need to reset mobile notification secrets?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"2617\">@Paweł Jastrzębski</span> well, that would have been correct if we'd done that in the first place; I think at this point it's likely that you will need to reset the mobile notification secrets after getting the rest of the state how you want it, because some devices could have registered for push notifications with the \"new\" user IDs over the last 3 days.</p>",
        "id": 801306,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575961136
    },
    {
        "content": "<blockquote>\n<blockquote>\n<p>Likely caused by the system being under RAM pressure. I've updated our recommend to suggest shutting down the Zulip server while one does an import if the system has limited free RAM: <a href=\"https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/79604c781742ed9ddafd995d213bf80040900c34\">79604c781742ed9ddafd995d213bf80040900c34</a>.</p>\n</blockquote>\n<p>During import process new machine had ~15gb of free ram. I didn't keep full stack but all of them were MemcachedError error 15 and 21</p>\n</blockquote>\n<p>OK, that should have been plenty of RAM; which suggests the issue is likely some sort of actual bug.  If you do see the stack traces again, I'd appreciate your posting them here.  We've migrated organizations with 2M+ messages before with this process, but not a long of them.</p>",
        "id": 801307,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575961217
    },
    {
        "content": "<p>I don't have any plans to touch this import/export mechanism again. Ever :-P</p>",
        "id": 801308,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575961258
    },
    {
        "content": "<blockquote>\n<blockquote>\n<p>Can you provide details on this? I don't understand a mechanism for how that would happen, given that we just preserve the flags from before the import in the migration...</p>\n</blockquote>\n<p>Sadly I can't. As I not replicated this issue. Few users after login in to new instance had all messages from X years marked as unread.</p>\n</blockquote>\n<p>So, I'm guessing the cause here is actually that those messages had never been marked as read.  We had some bugs in older Zulip releases that could result in unread messages being leaked (basically lost in the scrollback if the user never read that stream, for example) where it'd be hard to find them and mark them as read.  And a detail in how the import process sets the place one lands when loading the app after the import process is that it'll take them to the oldest (unmuted) unread message, causing those ancient unread messages to become \"relevant\" again.  Zulip 2.1 reworks the system in a way that should help users do a 1-time clear of those old unread messages, ending up in a reasonable state.</p>",
        "id": 801309,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575961380
    },
    {
        "content": "<p>So I should now remove mobile keys from old instance that is now running. Run registration again and to be sure nuke all sessions?</p>",
        "id": 801310,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575961445
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 801311,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575961568
    },
    {
        "content": "<p>For mobile keys, yes I'd remove the mobile keys and re-register on the restored server to avoid further push notifications delivery issues.</p>",
        "id": 801312,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575961603
    },
    {
        "content": "<p>OK. I will do this immediately.</p>",
        "id": 801314,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575961623
    },
    {
        "content": "<p>Well done that and now I can't login to mobile client at all.</p>",
        "id": 801315,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575962341
    },
    {
        "content": "<p>It is stuck on google account selection.</p>",
        "id": 801316,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575962388
    },
    {
        "content": "<p>web client is working correctly</p>",
        "id": 801317,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575962402
    },
    {
        "content": "<p>OK. I'm in. Login process was just loooong.</p>",
        "id": 801318,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575962444
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>./manage.py register_server --rotate-key\n./scripts/restart-server\n./manage.py logout_all_users\n</pre></div>\n\n\n<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> I presume that should be enough?</p>",
        "id": 801320,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575962788
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> Well this process broken something.</p>",
        "id": 801348,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575974832
    },
    {
        "content": "<p>Login on Android over Google OAuth now timeout.</p>",
        "id": 801349,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575974855
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>2019-12-10 10:48:37.540 WARN [] User error converting Google oauth2 login to token: {\n  &quot;error&quot;: &quot;invalid_grant&quot;,\n  &quot;error_description&quot;: &quot;Bad Request&quot;\n}\n</pre></div>",
        "id": 801350,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575974934
    },
    {
        "content": "<p>web login is not affected</p>",
        "id": 801351,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575974988
    },
    {
        "content": "<p>After few attempts login is successful.</p>",
        "id": 801353,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575975074
    },
    {
        "content": "<p>Whatever it was - it stopped.</p>",
        "id": 801364,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575989474
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"2617\">@Paweł Jastrzębski</span> I think <code>register_server --rotate-key</code> isn't sufficient -- that just rotates the secret/password, not removes the identity.</p>",
        "id": 801376,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575997581
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span>  So how do that properly?</p>",
        "id": 801378,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575997865
    },
    {
        "content": "<p>Just delete the <code>zulip_org_*</code> entries from <code>zulip-secrets.conf</code> and do <code>manage.py register_server</code>.</p>",
        "id": 801383,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1575998226
    },
    {
        "content": "<p>That was my first guess but: <a href=\"https://github.com/zulip/zulip/blob/master/zerver/management/commands/register_server.py#L37\" target=\"_blank\" title=\"https://github.com/zulip/zulip/blob/master/zerver/management/commands/register_server.py#L37\">https://github.com/zulip/zulip/blob/master/zerver/management/commands/register_server.py#L37</a></p>",
        "id": 801385,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575998267
    },
    {
        "content": "<p><code>register_server</code> expect them to be already set</p>",
        "id": 801387,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575998287
    },
    {
        "content": "<p>i will just regenerate them manually using snippets from <code>generate_secrets.py</code></p>",
        "id": 801390,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575998377
    },
    {
        "content": "<p>yep that worked</p>",
        "id": 801395,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575998611
    },
    {
        "content": "<p>And mobile login issue is back.</p>",
        "id": 801398,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575998817
    },
    {
        "content": "<p>I need 3 minutes to log the mobile client.</p>",
        "id": 801399,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575998830
    },
    {
        "content": "<p>But hopefully push notifications are now intact.</p>",
        "id": 801401,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575998910
    },
    {
        "content": "<p>Well thank you very much for help <span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span>. Hopefully everything is working now and I can attempt to find will to retry migration process using \"normal\" backups.</p>",
        "id": 801403,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575999208
    },
    {
        "content": "<p>But I doubt I will have any maintenance window this month.</p>",
        "id": 801404,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575999235
    },
    {
        "content": "<p>That android login look like auth endpoint on zulip side is timeouting and return nothing. After that timeout client refresh and everything start to work.</p>",
        "id": 801405,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575999461
    },
    {
        "content": "<p>hm</p>",
        "id": 801407,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575999558
    },
    {
        "content": "<p><a href=\"https://github.com/zulip/zulip-mobile/issues/3708\" target=\"_blank\" title=\"https://github.com/zulip/zulip-mobile/issues/3708\">https://github.com/zulip/zulip-mobile/issues/3708</a></p>",
        "id": 801408,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1575999558
    },
    {
        "content": "<p>So just small update. After few months we finished that move to new server.</p>",
        "id": 851258,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1586544032
    },
    {
        "content": "<p>We synced Zulip version on old and new server and used normal backup mechanic.</p>",
        "id": 851259,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1586544058
    },
    {
        "content": "<p>Only problem we found is a fact that old database used <code>tsearch-extras</code></p>",
        "id": 851260,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1586544081
    },
    {
        "content": "<p>And new server was missing that extension - as expected.</p>",
        "id": 851261,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1586544120
    },
    {
        "content": "<p>So until I manually installed <code>postgresql-10-tsearch-extras_0.4bionic2_amd64.deb</code> import was failing.</p>",
        "id": 851264,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1586544298
    },
    {
        "content": "<p>Yeah, this is a known bug.  It's somewhat difficult to script removing the <code>tsearch_extras</code> extension from the database because it requires root acces to do so.</p>",
        "id": 851265,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1586544331
    },
    {
        "content": "<p>I suppose we should at least document the fix for this, since the manual fix is easy.</p>",
        "id": 851266,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1586544338
    },
    {
        "content": "<p><a href=\"https://github.com/zulip/zulip/issues/13612\" title=\"https://github.com/zulip/zulip/issues/13612\">https://github.com/zulip/zulip/issues/13612</a></p>",
        "id": 851267,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1586544371
    },
    {
        "content": "<p><span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 851274,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1586545128
    },
    {
        "content": "<p>So I can safely drop extension on new server?</p>",
        "id": 851277,
        "sender_full_name": "Paweł Jastrzębski",
        "timestamp": 1586545219
    },
    {
        "content": "<p>Yep!</p>",
        "id": 851294,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1586546105
    }
]