[
    {
        "content": "<p>how to restore my current zulip ???</p>",
        "id": 1102380,
        "sender_full_name": "Jenish",
        "timestamp": 1611118262
    },
    {
        "content": "<p><a href=\"/user_uploads/2/2f/9z2P_1mRcrN5cpDgsLAHYIhP/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/2f/9z2P_1mRcrN5cpDgsLAHYIhP/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/2f/9z2P_1mRcrN5cpDgsLAHYIhP/image.png\"></a></div>",
        "id": 1102381,
        "sender_full_name": "Jenish",
        "timestamp": 1611118264
    },
    {
        "content": "<p>I upgrade my ubuntu 18.04  into 20.04 then it give me this error so how I can restore my zulip server ???</p>",
        "id": 1102382,
        "sender_full_name": "Jenish",
        "timestamp": 1611118392
    },
    {
        "content": "<p>The error shows that the virtual environment is not setup for the current python version</p>",
        "id": 1102542,
        "sender_full_name": "Gaurav Pandey (ligmitz)",
        "timestamp": 1611130645
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"17897\">@Jenish</span> did you follow this guide? <a href=\"https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal\">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal</a></p>",
        "id": 1102549,
        "sender_full_name": "Rein Zustand",
        "timestamp": 1611130773
    },
    {
        "content": "<p>If you want to play it safe, you can restore your system (if you made a snapshot backup) to the previous state before the upgrade, and then just follow <a href=\"https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal\">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-ubuntu-18-04-bionic-to-20-04-focal</a>.</p>",
        "id": 1102550,
        "sender_full_name": "Rein Zustand",
        "timestamp": 1611130810
    },
    {
        "content": "<p>but i forgot to take backup.</p>",
        "id": 1102617,
        "sender_full_name": "Jenish",
        "timestamp": 1611133112
    },
    {
        "content": "<p>so now it possible to restore zulip</p>",
        "id": 1102619,
        "sender_full_name": "Jenish",
        "timestamp": 1611133130
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"17897\">@Jenish</span> you should have taken backup. I suppose this is an expensive lesson for you. Since there is no way to turn back, you can just continue with step 4 and 5 in the guide I linked.</p>",
        "id": 1102626,
        "sender_full_name": "Rein Zustand",
        "timestamp": 1611136757
    },
    {
        "content": "<p>Okay</p>",
        "id": 1102637,
        "sender_full_name": "Jenish",
        "timestamp": 1611138615
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"2328\">@Rein Zustand</span> Thanks this was helpfully for me but I solved that issue</p>",
        "id": 1102685,
        "sender_full_name": "Jenish",
        "timestamp": 1611145602
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"17897\">@Jenish</span>  what issue did you solve?</p>",
        "id": 1102686,
        "sender_full_name": "Rein Zustand",
        "timestamp": 1611145645
    },
    {
        "content": "<p>I reset my virtual environment</p>",
        "id": 1102687,
        "sender_full_name": "Jenish",
        "timestamp": 1611145691
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"17897\">@Jenish</span> step 5 in the guide I linked already automatically does a virtualenv refresh.</p>",
        "id": 1102693,
        "sender_full_name": "Rein Zustand",
        "timestamp": 1611147649
    },
    {
        "content": "<p>Yes</p>",
        "id": 1103506,
        "sender_full_name": "Jenish",
        "timestamp": 1611204279
    },
    {
        "content": "<p>Hello, this is sort of urgent if someone out there can provide some assistance. On our production server all of a sudden our users started to get an error message when they try to upload an attachment <code>An Unexpected error has occurred</code>. I couldn't find any answers on the forum as to what may have caused this error message. I decided to restore my server to previous backup, but unfortunately my restore process wouldn't get past the error below:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>+ dropdb --if-exists -- zulip\n+ createdb -O zulip -T template0 -- zulip\ngenerate_secrets: No new secrets to generate.\n+ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq\n+ <span class=\"nv\">RABBITMQ_FLAGS</span><span class=\"o\">=()</span>\n+ <span class=\"s1\">'['</span> -n <span class=\"s1\">''</span> <span class=\"s1\">']'</span>\n+++ dirname /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq\n++ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/../get-django-setting RABBITMQ_USERNAME\n+ <span class=\"nv\">RABBITMQ_USERNAME</span><span class=\"o\">=</span>zulip\n+++ dirname /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq\n++ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/../get-django-setting RABBITMQ_PASSWORD\n+ <span class=\"nv\">RABBITMQ_PASSWORD</span><span class=\"o\">=</span>f1c9276738089a62af4326bed103969636c5d92dbd6d18c3bd052307a9c2bab0\n+ <span class=\"s1\">'['</span> <span class=\"m\">0</span> -eq <span class=\"m\">0</span> <span class=\"s1\">']'</span>\n+ <span class=\"nv\">RABBITMQCTL_COMMAND</span><span class=\"o\">=</span>rabbitmqctl\n+ rabbitmqctl delete_user zulip\nDeleting user <span class=\"s2\">\"zulip\"</span>\n+ rabbitmqctl delete_user zulip\nDeleting user <span class=\"s2\">\"zulip\"</span>\nError: no_such_user: zulip\n+ <span class=\"nb\">true</span>\n+ rabbitmqctl delete_user guest\nDeleting user <span class=\"s2\">\"guest\"</span>\nError: no_such_user: guest\n+ <span class=\"nb\">true</span>\n+ rabbitmqctl add_user zulip f1c9276738089a62af4326bed103969636c5d92dbd6d18c3bd052307a9c2bab0\nCreating user <span class=\"s2\">\"zulip\"</span>\n+ rabbitmqctl set_user_tags zulip administrator\nSetting tags <span class=\"k\">for</span> user <span class=\"s2\">\"zulip\"</span> to <span class=\"o\">[</span>administrator<span class=\"o\">]</span>\n+ rabbitmqctl set_permissions -p / zulip <span class=\"s1\">'.*'</span> <span class=\"s1\">'.*'</span> <span class=\"s1\">'.*'</span>\nSetting permissions <span class=\"k\">for</span> user <span class=\"s2\">\"zulip\"</span> <span class=\"k\">in</span> vhost <span class=\"s2\">\"/\"</span>\n+ /home/zulip/deployments/2020-08-07-22-43-47/scripts/zulip-puppet-apply -f\nNotice: Compiled catalog <span class=\"k\">for</span> zulip-prod <span class=\"k\">in</span> environment production <span class=\"k\">in</span> <span class=\"m\">1</span>.40 seconds\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Apt_repository/Exec<span class=\"o\">[</span>setup_apt_repo<span class=\"o\">]</span>/returns: executed successfully\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Tornado_sharding/File<span class=\"o\">[</span>/etc/zulip/nginx_sharding.conf<span class=\"o\">]</span>/owner: owner changed <span class=\"s1\">'zulip'</span> to <span class=\"s1\">'root'</span>\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Tornado_sharding/File<span class=\"o\">[</span>/etc/zulip/nginx_sharding.conf<span class=\"o\">]</span>/group: group changed <span class=\"s1\">'zulip'</span> to <span class=\"s1\">'root'</span>\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::App_frontend_base/File<span class=\"o\">[</span>/etc/zulip/uwsgi.ini<span class=\"o\">]</span>/owner: owner changed <span class=\"s1\">'zulip'</span> to <span class=\"s1\">'root'</span>\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::App_frontend_base/File<span class=\"o\">[</span>/etc/zulip/uwsgi.ini<span class=\"o\">]</span>/group: group changed <span class=\"s1\">'zulip'</span> to <span class=\"s1\">'root'</span>\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Supervisor/Service<span class=\"o\">[</span>supervisor<span class=\"o\">]</span>: Triggered <span class=\"s1\">'refresh'</span> from <span class=\"m\">2</span> events\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Nginx/Service<span class=\"o\">[</span>nginx<span class=\"o\">]</span>: Triggered <span class=\"s1\">'refresh'</span> from <span class=\"m\">2</span> events\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::App_frontend_base/Zulip::Safepackage<span class=\"o\">[</span>postgresql-client<span class=\"o\">]</span>/Package<span class=\"o\">[</span>postgresql-client<span class=\"o\">]</span>/ensure: created\nNotice: Applied catalog <span class=\"k\">in</span> <span class=\"m\">17</span>.04 seconds\n+ pg_restore -d zulip -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database\npg_restore: <span class=\"o\">[</span>archiver<span class=\"o\">]</span> unsupported version <span class=\"o\">(</span><span class=\"m\">1</span>.14<span class=\"o\">)</span> <span class=\"k\">in</span> file header\n\nError running a subcommand of /home/zulip/deployments/current/scripts/setup/restore-backup: pg_restore -d zulip -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database\nActual error output <span class=\"k\">for</span> the subcommand is just above this.\n\nTraceback <span class=\"o\">(</span>most recent call last<span class=\"o\">)</span>:\n  File <span class=\"s2\">\"/home/zulip/deployments/current/scripts/setup/restore-backup\"</span>, line <span class=\"m\">163</span>, <span class=\"k\">in</span> &lt;module&gt;\n    restore_backup<span class=\"o\">(</span>tarball_file<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/home/zulip/deployments/current/scripts/setup/restore-backup\"</span>, line <span class=\"m\">148</span>, <span class=\"k\">in</span> restore_backup\n    run<span class=\"o\">([</span><span class=\"s2\">\"pg_restore\"</span>, <span class=\"s2\">\"-d\"</span>, db<span class=\"o\">[</span><span class=\"s2\">\"NAME\"</span><span class=\"o\">]</span>, <span class=\"s2\">\"--\"</span>, db_dir<span class=\"o\">]</span>, <span class=\"nv\">cwd</span><span class=\"o\">=</span><span class=\"s2\">\"/\"</span>, <span class=\"nv\">env</span><span class=\"o\">=</span>postgres_env<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/home/zulip/deployments/current/scripts/lib/zulip_tools.py\"</span>, line <span class=\"m\">198</span>, <span class=\"k\">in</span> run\n    subprocess.check_call<span class=\"o\">(</span>args, **kwargs<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/usr/lib/python3.6/subprocess.py\"</span>, line <span class=\"m\">311</span>, <span class=\"k\">in</span> check_call\n    raise CalledProcessError<span class=\"o\">(</span>retcode, cmd<span class=\"o\">)</span>\nsubprocess.CalledProcessError: Command <span class=\"s1\">'['</span>pg_restore<span class=\"s1\">', '</span>-d<span class=\"s1\">', '</span>zulip<span class=\"s1\">', '</span>--<span class=\"s1\">', '</span>/tmp/zulip-restore-backup-_ouu520s/zulip-backup/database<span class=\"s1\">']'</span> returned non-zero <span class=\"nb\">exit</span> status <span class=\"m\">1</span>.\n</code></pre></div>\n<p>Any help would be greatly appreciated.</p>",
        "id": 1122585,
        "sender_full_name": "Tej Gill",
        "timestamp": 1614049091
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"13286\">Tej Gill</span> <a href=\"#narrow/stream/31-production-help/topic/restore.20zulip/near/1122585\">said</a>:</p>\n<blockquote>\n<p>Hello, this is sort of urgent if someone out there can provide some assistance. On our production server all of a sudden our users started to get an error message when they try to upload an attachment <code>An Unexpected error has occurred</code>. I couldn't find any answers on the forum as to what may have caused this error message. I decided to restore my server to previous backup, but unfortunately my restore process wouldn't get past the error below:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>+ dropdb --if-exists -- zulip\n+ createdb -O zulip -T template0 -- zulip\ngenerate_secrets: No new secrets to generate.\n+ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq\n+ <span class=\"nv\">RABBITMQ_FLAGS</span><span class=\"o\">=()</span>\n+ <span class=\"s1\">'['</span> -n <span class=\"s1\">''</span> <span class=\"s1\">']'</span>\n+++ dirname /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq\n++ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/../get-django-setting RABBITMQ_USERNAME\n+ <span class=\"nv\">RABBITMQ_USERNAME</span><span class=\"o\">=</span>zulip\n+++ dirname /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/configure-rabbitmq\n++ /home/zulip/deployments/2020-08-07-22-43-47/scripts/setup/../get-django-setting RABBITMQ_PASSWORD\n+ <span class=\"nv\">RABBITMQ_PASSWORD</span><span class=\"o\">=</span>f1c9276738089a62af4326bed103969636c5d92dbd6d18c3bd052307a9c2bab0\n+ <span class=\"s1\">'['</span> <span class=\"m\">0</span> -eq <span class=\"m\">0</span> <span class=\"s1\">']'</span>\n+ <span class=\"nv\">RABBITMQCTL_COMMAND</span><span class=\"o\">=</span>rabbitmqctl\n+ rabbitmqctl delete_user zulip\nDeleting user <span class=\"s2\">\"zulip\"</span>\n+ rabbitmqctl delete_user zulip\nDeleting user <span class=\"s2\">\"zulip\"</span>\nError: no_such_user: zulip\n+ <span class=\"nb\">true</span>\n+ rabbitmqctl delete_user guest\nDeleting user <span class=\"s2\">\"guest\"</span>\nError: no_such_user: guest\n+ <span class=\"nb\">true</span>\n+ rabbitmqctl add_user zulip f1c9276738089a62af4326bed103969636c5d92dbd6d18c3bd052307a9c2bab0\nCreating user <span class=\"s2\">\"zulip\"</span>\n+ rabbitmqctl set_user_tags zulip administrator\nSetting tags <span class=\"k\">for</span> user <span class=\"s2\">\"zulip\"</span> to <span class=\"o\">[</span>administrator<span class=\"o\">]</span>\n+ rabbitmqctl set_permissions -p / zulip <span class=\"s1\">'.*'</span> <span class=\"s1\">'.*'</span> <span class=\"s1\">'.*'</span>\nSetting permissions <span class=\"k\">for</span> user <span class=\"s2\">\"zulip\"</span> <span class=\"k\">in</span> vhost <span class=\"s2\">\"/\"</span>\n+ /home/zulip/deployments/2020-08-07-22-43-47/scripts/zulip-puppet-apply -f\nNotice: Compiled catalog <span class=\"k\">for</span> zulip-prod <span class=\"k\">in</span> environment production <span class=\"k\">in</span> <span class=\"m\">1</span>.40 seconds\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Apt_repository/Exec<span class=\"o\">[</span>setup_apt_repo<span class=\"o\">]</span>/returns: executed successfully\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Tornado_sharding/File<span class=\"o\">[</span>/etc/zulip/nginx_sharding.conf<span class=\"o\">]</span>/owner: owner changed <span class=\"s1\">'zulip'</span> to <span class=\"s1\">'root'</span>\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Tornado_sharding/File<span class=\"o\">[</span>/etc/zulip/nginx_sharding.conf<span class=\"o\">]</span>/group: group changed <span class=\"s1\">'zulip'</span> to <span class=\"s1\">'root'</span>\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::App_frontend_base/File<span class=\"o\">[</span>/etc/zulip/uwsgi.ini<span class=\"o\">]</span>/owner: owner changed <span class=\"s1\">'zulip'</span> to <span class=\"s1\">'root'</span>\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::App_frontend_base/File<span class=\"o\">[</span>/etc/zulip/uwsgi.ini<span class=\"o\">]</span>/group: group changed <span class=\"s1\">'zulip'</span> to <span class=\"s1\">'root'</span>\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Supervisor/Service<span class=\"o\">[</span>supervisor<span class=\"o\">]</span>: Triggered <span class=\"s1\">'refresh'</span> from <span class=\"m\">2</span> events\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::Nginx/Service<span class=\"o\">[</span>nginx<span class=\"o\">]</span>: Triggered <span class=\"s1\">'refresh'</span> from <span class=\"m\">2</span> events\nNotice: /Stage<span class=\"o\">[</span>main<span class=\"o\">]</span>/Zulip::App_frontend_base/Zulip::Safepackage<span class=\"o\">[</span>postgresql-client<span class=\"o\">]</span>/Package<span class=\"o\">[</span>postgresql-client<span class=\"o\">]</span>/ensure: created\nNotice: Applied catalog <span class=\"k\">in</span> <span class=\"m\">17</span>.04 seconds\n+ pg_restore -d zulip -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database\n<span class=\"sb\">`</span>pg_restore: <span class=\"o\">[</span>archiver<span class=\"o\">]</span> unsupported version <span class=\"o\">(</span><span class=\"m\">1</span>.14<span class=\"o\">)</span> <span class=\"k\">in</span> file header<span class=\"sb\">`</span>\n\nError running a subcommand of /home/zulip/deployments/current/scripts/setup/restore-backup: pg_restore -d zulip -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database\nActual error output <span class=\"k\">for</span> the subcommand is just above this.\n\nTraceback <span class=\"o\">(</span>most recent call last<span class=\"o\">)</span>:\n  File <span class=\"s2\">\"/home/zulip/deployments/current/scripts/setup/restore-backup\"</span>, line <span class=\"m\">163</span>, <span class=\"k\">in</span> &lt;module&gt;\n    restore_backup<span class=\"o\">(</span>tarball_file<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/home/zulip/deployments/current/scripts/setup/restore-backup\"</span>, line <span class=\"m\">148</span>, <span class=\"k\">in</span> restore_backup\n    run<span class=\"o\">([</span><span class=\"s2\">\"pg_restore\"</span>, <span class=\"s2\">\"-d\"</span>, db<span class=\"o\">[</span><span class=\"s2\">\"NAME\"</span><span class=\"o\">]</span>, <span class=\"s2\">\"--\"</span>, db_dir<span class=\"o\">]</span>, <span class=\"nv\">cwd</span><span class=\"o\">=</span><span class=\"s2\">\"/\"</span>, <span class=\"nv\">env</span><span class=\"o\">=</span>postgres_env<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/home/zulip/deployments/current/scripts/lib/zulip_tools.py\"</span>, line <span class=\"m\">198</span>, <span class=\"k\">in</span> run\n    subprocess.check_call<span class=\"o\">(</span>args, **kwargs<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/usr/lib/python3.6/subprocess.py\"</span>, line <span class=\"m\">311</span>, <span class=\"k\">in</span> check_call\n    raise CalledProcessError<span class=\"o\">(</span>retcode, cmd<span class=\"o\">)</span>\nsubprocess.CalledProcessError: Command <span class=\"s1\">'['</span>pg_restore<span class=\"s1\">', '</span>-d<span class=\"s1\">', '</span>zulip<span class=\"s1\">', '</span>--<span class=\"s1\">', '</span>/tmp/zulip-restore-backup-_ouu520s/zulip-backup/database<span class=\"s1\">']'</span> returned non-zero <span class=\"nb\">exit</span> status <span class=\"m\">1</span>.\n</code></pre></div>\n<p>Any help would be greatly appreciated.</p>\n<p><div class=\"codehilite\"><pre><span></span><code>Output of `dpkg -l | grep postgres` is as follows\n```bash\nii  check-postgres                             2.25.0-1.pgdg18.04+1                             all          script for monitoring PostgreSQL databases\nii  pgdg-keyring                               2018.2                                           all          keyring for apt.postgresql.org\nii  postgresql-10                              10.15-1.pgdg18.04+1                              amd64        object-relational SQL database, version 10 server\nii  postgresql-client                          13+225.pgdg18.04+1                               all          front-end programs for PostgreSQL (supported version)\nii  postgresql-client-10                       10.15-1.pgdg18.04+1                              amd64        front-end programs for PostgreSQL 10\nii  postgresql-client-12                       12.5-1.pgdg18.04+1                               amd64        front-end programs for PostgreSQL 12\nii  postgresql-client-13                       13.2-1.pgdg18.04+1                               amd64        front-end programs for PostgreSQL 13\nii  postgresql-client-common                   223.pgdg18.04+1                                  all          manager for multiple PostgreSQL client versions\nii  postgresql-common                          223.pgdg18.04+1                                  all          PostgreSQL database-cluster manager\n```\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 1122588,
        "sender_full_name": "Tej Gill",
        "timestamp": 1614049412
    },
    {
        "content": "<p>I'm guessing it's picking up the postgres 10 client.</p>",
        "id": 1122589,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614049580
    },
    {
        "content": "<p>You can try using <code>update_alternatives</code> to switch which one <code>pg_restore</code> runs</p>",
        "id": 1122590,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614049746
    },
    {
        "content": "<p>Hm, looks like it's not in <code>update-alternatives</code></p>",
        "id": 1122591,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614049865
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"13286\">@Tej Gill</span>: Try</p>\n<div class=\"codehilite\"><pre><span></span><code>pg_restore -f zulip --cluster 13/main -- /tmp/zulip-restore-backup-_ouu520s/zulip-backup/database\n</code></pre></div>\n<p>(assuming you're running pg 13, as the one with your data)</p>",
        "id": 1122592,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614050035
    },
    {
        "content": "<p>Oh, hang on.  No, that's not right, your only server pg is 10</p>",
        "id": 1122593,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614050066
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> thank you for the quick reply. Would you happen to know what may have caused the <code>An unexpected error occurred</code> when trying to upload an attachment? Our users started reporting it in the later afternoon.</p>",
        "id": 1122594,
        "sender_full_name": "Tej Gill",
        "timestamp": 1614050236
    },
    {
        "content": "<p>Oh -- I think your data may have been <em>dumped</em> with pg 13 command-line tools, but it's picking up version 10 as the version of pg_restore to use, becauase that matches the running cluster<br>\nAnd the version 10 <code>pg_restore</code> doesn't understand the version 13 data.</p>",
        "id": 1122595,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614050241
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"13286\">Tej Gill</span> <a href=\"#narrow/stream/31-production-help/topic/restore.20zulip/near/1122594\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> thank you for the quick reply. Would you happen to know what may have caused the <code>An unexpected error occurred</code> when trying to upload an attachment? Our users started reporting it in the later afternoon.</p>\n</blockquote>\n<p>What does <code>/var/log/zulip/error.log</code> say?</p>",
        "id": 1122596,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614050262
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> <a href=\"#narrow/stream/31-production-help/topic/restore.20zulip/near/1122595\">said</a>:</p>\n<blockquote>\n<p>Oh -- I think your data may have been <em>dumped</em> with pg 13 command-line tools, but it's picking up version 10 as the version of pg_restore to use, becauase that matches the running cluster<br>\nAnd the version 10 <code>pg_restore</code> doesn't understand the version 13 data.</p>\n</blockquote>\n<p>If so, this is a bug in our backup scripts, which need to make sure to use the same pg_backup binary when taking backups, due to a pg bug: <a href=\"https://stackoverflow.com/questions/59455783/pg-restore-archiver-unsupported-version-1-14-in-file-header\">https://stackoverflow.com/questions/59455783/pg-restore-archiver-unsupported-version-1-14-in-file-header</a></p>",
        "id": 1122597,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614050339
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> <a href=\"#narrow/stream/31-production-help/topic/restore.20zulip/near/1122596\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"13286\">Tej Gill</span> <a href=\"#narrow/stream/31-production-help/topic/restore.20zulip/near/1122594\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> thank you for the quick reply. Would you happen to know what may have caused the <code>An unexpected error occurred</code> when trying to upload an attachment? Our users started reporting it in the later afternoon.</p>\n</blockquote>\n<p>What does <code>/var/log/zulip/error.log</code> say?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> I am seeing one error over and over again. not sure if that has something to do with anything</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>  File <span class=\"s2\">\"./zerver/lib/db.py\"</span>, line <span class=\"m\">33</span>, <span class=\"k\">in</span> execute\n    <span class=\"k\">return</span> wrapper_execute<span class=\"o\">(</span>self, super<span class=\"o\">()</span>.execute, query, vars<span class=\"o\">)</span>\n  File <span class=\"s2\">\"./zerver/lib/db.py\"</span>, line <span class=\"m\">20</span>, <span class=\"k\">in</span> wrapper_execute\n    <span class=\"k\">return</span> action<span class=\"o\">(</span>sql, params<span class=\"o\">)</span>\npsycopg2.errors.UndefinedTable: relation <span class=\"s2\">\"django_session\"</span> does not exist\nLINE <span class=\"m\">1</span>: ...ession_data<span class=\"s2\">\", \"</span>django_session<span class=\"s2\">\".\"</span>expire_date<span class=\"s2\">\" FROM \"</span>django_se...\n                                                             ^\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback <span class=\"o\">(</span>most recent call last<span class=\"o\">)</span>:\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/core/handlers/exception.py\"</span>, line <span class=\"m\">34</span>, <span class=\"k\">in</span> inner\n    <span class=\"nv\">response</span> <span class=\"o\">=</span> get_response<span class=\"o\">(</span>request<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/utils/deprecation.py\"</span>, line <span class=\"m\">93</span>, <span class=\"k\">in</span> __call__\n    <span class=\"nv\">response</span> <span class=\"o\">=</span> self.process_request<span class=\"o\">(</span>request<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/middleware/locale.py\"</span>, line <span class=\"m\">21</span>, <span class=\"k\">in</span> process_request\n    <span class=\"nv\">language</span> <span class=\"o\">=</span> translation.get_language_from_request<span class=\"o\">(</span>request, <span class=\"nv\">check_path</span><span class=\"o\">=</span>i18n_patterns_used<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/utils/translation/__init__.py\"</span>, line <span class=\"m\">236</span>, <span class=\"k\">in</span> get_language_f\nrom_request\n    <span class=\"k\">return</span> _trans.get_language_from_request<span class=\"o\">(</span>request, check_path<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/utils/translation/trans_real.py\"</span>, line <span class=\"m\">532</span>, <span class=\"k\">in</span> get_language\n_from_request\n    <span class=\"nv\">lang_code</span> <span class=\"o\">=</span> request.session.get<span class=\"o\">(</span>LANGUAGE_SESSION_KEY<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/sessions/backends/base.py\"</span>, line <span class=\"m\">65</span>, <span class=\"k\">in</span> get\n    <span class=\"k\">return</span> self._session.get<span class=\"o\">(</span>key, default<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/sessions/backends/base.py\"</span>, line <span class=\"m\">194</span>, <span class=\"k\">in</span> _get_sessi\non\n    self._session_cache <span class=\"o\">=</span> self.load<span class=\"o\">()</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/sessions/backends/cached_db.py\"</span>, line <span class=\"m\">35</span>, <span class=\"k\">in</span> load\n    <span class=\"nv\">s</span> <span class=\"o\">=</span> self._get_session_from_db<span class=\"o\">()</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/contrib/sessions/backends/db.py\"</span>, line <span class=\"m\">34</span>, <span class=\"k\">in</span> _get_session_\nfrom_db\n    <span class=\"nv\">expire_date__gt</span><span class=\"o\">=</span>timezone.now<span class=\"o\">()</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/manager.py\"</span>, line <span class=\"m\">82</span>, <span class=\"k\">in</span> manager_method\n    <span class=\"k\">return</span> getattr<span class=\"o\">(</span>self.get_queryset<span class=\"o\">()</span>, name<span class=\"o\">)(</span>*args, **kwargs<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py\"</span>, line <span class=\"m\">402</span>, <span class=\"k\">in</span> get\n    <span class=\"nv\">num</span> <span class=\"o\">=</span> len<span class=\"o\">(</span>clone<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py\"</span>, line <span class=\"m\">256</span>, <span class=\"k\">in</span> __len__\n    self._fetch_all<span class=\"o\">()</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py\"</span>, line <span class=\"m\">1242</span>, <span class=\"k\">in</span> _fetch_all\n    self._result_cache <span class=\"o\">=</span> list<span class=\"o\">(</span>self._iterable_class<span class=\"o\">(</span>self<span class=\"o\">))</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/query.py\"</span>, line <span class=\"m\">55</span>, <span class=\"k\">in</span> __iter__\n    <span class=\"nv\">results</span> <span class=\"o\">=</span> compiler.execute_sql<span class=\"o\">(</span><span class=\"nv\">chunked_fetch</span><span class=\"o\">=</span>self.chunked_fetch, <span class=\"nv\">chunk_size</span><span class=\"o\">=</span>self.chunk_size<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/models/sql/compiler.py\"</span>, line <span class=\"m\">1140</span>, <span class=\"k\">in</span> execute_sql\n    cursor.execute<span class=\"o\">(</span>sql, params<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py\"</span>, line <span class=\"m\">67</span>, <span class=\"k\">in</span> execute\n    <span class=\"k\">return</span> self._execute_with_wrappers<span class=\"o\">(</span>sql, params, <span class=\"nv\">many</span><span class=\"o\">=</span>False, <span class=\"nv\">executor</span><span class=\"o\">=</span>self._execute<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py\"</span>, line <span class=\"m\">76</span>, <span class=\"k\">in</span> _execute_with_wrappers\n    <span class=\"k\">return</span> executor<span class=\"o\">(</span>sql, params, many, context<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py\"</span>, line <span class=\"m\">84</span>, <span class=\"k\">in</span> _execute\n    <span class=\"k\">return</span> self.cursor.execute<span class=\"o\">(</span>sql, params<span class=\"o\">)</span>\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/utils.py\"</span>, line <span class=\"m\">89</span>, <span class=\"k\">in</span> __exit__\n    raise dj_exc_value.with_traceback<span class=\"o\">(</span>traceback<span class=\"o\">)</span> from exc_value\n  File <span class=\"s2\">\"/srv/zulip-venv-cache/bb5dddb1c00dadfdc6e3e18e589c298dcee61702/zulip-py3-venv/lib/python3.6/site-packages/django/db/backends/utils.py\"</span>, line <span class=\"m\">84</span>, <span class=\"k\">in</span> _execute\n    <span class=\"k\">return</span> self.cursor.execute<span class=\"o\">(</span>sql, params<span class=\"o\">)</span>\n  File <span class=\"s2\">\"./zerver/lib/db.py\"</span>, line <span class=\"m\">33</span>, <span class=\"k\">in</span> execute\n    <span class=\"k\">return</span> wrapper_execute<span class=\"o\">(</span>self, super<span class=\"o\">()</span>.execute, query, vars<span class=\"o\">)</span>\n</code></pre></div>",
        "id": 1122598,
        "sender_full_name": "Tej Gill",
        "timestamp": 1614051039
    },
    {
        "content": "<p>That error looks like the <code>django_session</code> table doesn't exist.  Which is likely because recovering from backups, as a first step, dropped your current database.</p>",
        "id": 1122599,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614051663
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"13286\">@Tej Gill</span>: I believe your path forward is to try explicitly using the postgres-13 pg_restore on your backup.</p>\n<div class=\"codehilite\"><pre><span></span><code>export PATH=/usr/lib/postgresql/13/bin:$PATH\n</code></pre></div>\n<p>...then re-run the <code>scripts/setup/restore-backup</code> command you ran to produce what you pasted.</p>",
        "id": 1122603,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1614052136
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> <a href=\"#narrow/stream/31-production-help/topic/restore.20zulip/near/1122603\">said</a>:</p>\n<blockquote>\n<p>Thanks <span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> I will try that and let you know how it goes</p>\n</blockquote>",
        "id": 1122613,
        "sender_full_name": "Tej Gill",
        "timestamp": 1614055382
    }
]