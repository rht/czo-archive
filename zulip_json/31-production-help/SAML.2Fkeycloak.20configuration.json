[
    {
        "content": "<p>Hi guys,<br>\nWondering if it's possible to configure SAML SSO login using environmental variables or if I need to handcraft a config and tell the container to not configure the config?</p>",
        "id": 814298,
        "sender_full_name": "ChemSmith",
        "timestamp": 1580776089
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"14082\">@ChemSmith</span> I would guess it'll be really painful to try to configure SAML via environment variables.</p>",
        "id": 814305,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1580777056
    },
    {
        "content": "<p>You can try using the MANUAL_CONFIGURATION setting (Which we have plans to work on soon)</p>",
        "id": 814306,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1580777069
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> Thanks, I'd figured as much but thought I'd get confirmation first.</p>",
        "id": 814324,
        "sender_full_name": "ChemSmith",
        "timestamp": 1580777695
    },
    {
        "content": "<p>On a related note has anyone successfully setup Keycloak as a SAML IdP for Zulip?</p>",
        "id": 814351,
        "sender_full_name": "ChemSmith",
        "timestamp": 1580779727
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> getting the container to spin up with an external settings.py is way more work than it should be (I still haven't actually managed to do it). I'm wondering if a better way to do it would be to just volume mount settings.py from the host into the container directly into /etc/zulip/settings.py but otherwise let the entrypoint script setup up everything else (rather than linking all of /etc/zulip from /data). I will look into modifying the entrypoint script tonight to allow this.</p>",
        "id": 814361,
        "sender_full_name": "ChemSmith",
        "timestamp": 1580787693
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"14082\">@ChemSmith</span> yeah, making that work nicely is one of the things I'm hoping <span class=\"user-mention\" data-user-id=\"52\">@Vishnu Ks</span> will make happen over the next few weeks.  For the moment, I'd definitely recommend using our standard installation approach for SAML.</p>",
        "id": 814485,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1580851780
    },
    {
        "content": "<p>As I can see in README: An alternative approach is to set MANUAL_CONFIGURATION: \"True\" and LINK_SETTINGS_TO_DATA in docker-compose.yml. <br>\nIs LINK_SETTINGS_TO_DATA particular ENV? Or just example? Anyway, Do I have to set path to setting.py? and If I bind /etc/zulip (volumes:) contained setting.py, do I need to specify LINK_SETTINGS_TO_DATA ?</p>",
        "id": 817560,
        "sender_full_name": "Максим Декин",
        "timestamp": 1581954494
    },
    {
        "content": "<p>additionl qusetion :) How to pass setting from docker-compose env to setting.py if that setting in setting.py must be present as dict?  Most settings in Zulip are just strings, but some are lists (etc.) if it is list it is clear, need to use comma-separated. if is it dict?</p>",
        "id": 817565,
        "sender_full_name": "Максим Декин",
        "timestamp": 1581954990
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"14868\">@Максим Декин</span> I'd recommend using <code>MANUAL_CONFIGURATION</code> for that use case.  The Docker model of passing data via environment variables isn't super compatible with more complex configuration like dictionaries.</p>",
        "id": 817935,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1582054535
    },
    {
        "content": "<p>ok, it works. I was able to configure LDAP by changing paramerts in setting.py.  But Now I am trying to configure SAML auth (it is my main purpose) and I can not succeed in this task. I read manual and try more and more, but it doesn’t work. I have a lot of other applications I had configured SAML but not Zulip. I couldn`t find any examples in internet (my saml provider is WSO2IS). The main problem is no redirect to SAML provider when I click button  on the form. I watch requests and respons in Chrome Developer Tools</p>",
        "id": 818480,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582129344
    },
    {
        "content": "<p><a href=\"/user_uploads/2/f3/5AhBTZMaufRSY8RdFOWJuLZa/image.png\" target=\"_blank\" title=\"image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/f3/5AhBTZMaufRSY8RdFOWJuLZa/image.png\" target=\"_blank\" title=\"image.png\"><img src=\"/user_uploads/2/f3/5AhBTZMaufRSY8RdFOWJuLZa/image.png\"></a></div>",
        "id": 818481,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582129348
    },
    {
        "content": "<p>nothing happens after sending :)<br>\n<a href=\"/user_uploads/2/87/Urrb2OqCliFrIYiPt6fUzg9N/image.png\" target=\"_blank\" title=\"image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/87/Urrb2OqCliFrIYiPt6fUzg9N/image.png\" target=\"_blank\" title=\"image.png\"><img src=\"/user_uploads/2/87/Urrb2OqCliFrIYiPt6fUzg9N/image.png\"></a></div>",
        "id": 818482,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582129439
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"14868\">@Максим Декин</span> can you show /var/log/zulip/errors.log and and what gets generated in /var/log/zulip/server.log when you do this?</p>",
        "id": 818483,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582130467
    },
    {
        "content": "<p>in django.log<br>\n2020-02-20 06:10:57.713 INFO [zr] 172.17.230.153  GET     302  32ms (db: 1ms/1q) /login/saml/ (unauth via ?)<br>\n[pid: 171|app: 0|req: 600/1171] 172.23.0.1 () {68 vars in 1485 bytes} [Thu Feb 20 06:10:57 2020] GET /login/saml/subdomain=&amp;is_signup=0&amp;multiuse_object_key=&amp;idp=idp_name =&gt; generated 0 bytes in 34 msecs (HTTP/1.1 302) 8 headers in 434 bytes (2 switches on core 0)<br>\n2020-02-20 06:10:57.744 INFO [zr] 172.17.230.153  GET     200  13ms (db: 2ms/1q) /login/ (unauth via ?)</p>\n<p>the same in server.log<br>\n2020-02-20 06:10:57.667 INFO [zr] 172.17.230.153  GET     302   1ms /accounts/login/social/saml/idp_name (unauth via ?)<br>\n2020-02-20 06:10:57.682 INFO [] /login/saml/ : Bad idp param.<br>\n2020-02-20 06:10:57.713 INFO [zr] 172.17.230.153  GET     302  32ms (db: 1ms/1q) /login/saml/ (unauth via ?)<br>\n2020-02-20 06:10:57.744 INFO [zr] 172.17.230.153  GET     200  13ms (db: 2ms/1q) /login/ (unauth via ?)</p>\n<p>no entries in file in error.log</p>",
        "id": 818816,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582179791
    },
    {
        "content": "<p><a href=\"/user_uploads/2/97/Wd7fEXmoJTUmJSX2RsjpjLtJ/image.png\" target=\"_blank\" title=\"image.png\">image.png</a> <br>\nSetting on the idp side</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/97/Wd7fEXmoJTUmJSX2RsjpjLtJ/image.png\" target=\"_blank\" title=\"image.png\"><img src=\"/user_uploads/2/97/Wd7fEXmoJTUmJSX2RsjpjLtJ/image.png\"></a></div>",
        "id": 818817,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582179912
    },
    {
        "content": "<p>Can you try with this patch:</p>\n<div class=\"codehilite\"><pre><span></span>diff --git a/zproject/backends.py b/zproject/backends.py\nindex 771a21f980..75696657db 100644\n--- a/zproject/backends.py\n+++ b/zproject/backends.py\n@@ -1392,10 +1392,10 @@ class SAMLAuthBackend(SocialAuthMixin, SAMLAuth):\n         try:\n             idp_name = self.strategy.request_data()[&#39;idp&#39;]\n             auth = self._create_saml_auth(idp=self.get_idp(idp_name))\n-        except KeyError:\n+        except KeyError as e:\n             # If the above raise KeyError, it means invalid or no idp was specified,\n             # we should log that and redirect to the login page.\n-            logging.info(&quot;/login/saml/ : Bad idp param.&quot;)\n+            logging.info(&quot;/login/saml/ : Bad idp param: {}.&quot;.format(e))\n             return reverse(&#39;zerver.views.auth.login_page&#39;,\n                            kwargs = {&#39;template_name&#39;: &#39;zerver/login.html&#39;})\n</pre></div>\n\n\n<p>and see the logs generated with that? The point of this is to make the error log a bit more informative.</p>",
        "id": 818834,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582195721
    },
    {
        "content": "<p>patch applied. thx it helps to find out the reason!<br>\nerror : Bad idp param: 'IDP must contain x509cert or x509certMulti'</p>",
        "id": 818898,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582209546
    },
    {
        "content": "<p>Are things working after fixing that cert issue?</p>",
        "id": 818908,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582210889
    },
    {
        "content": "<p>No ) I fix permission for cert<br>\nI run Zulip in Docker so I can not change owner for /etc/zulip/saml/ beacause zulip user is not exist in host OS (outside the container). To fix it I had to change permission on cert on 777<br>\nnothing changed, I can not login via SAML. BUT errors dissapeared from logs :( and I can not see what is going on  :(</p>",
        "id": 818913,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582211733
    },
    {
        "content": "<p>So nothing is getting logged now, but you're getting redirected back to the login page?</p>\n<p>Are the attribute statements configured correctly?</p>",
        "id": 818914,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582212294
    },
    {
        "content": "<p>Though something should probably be getting logged if it was about attribute statements <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 818915,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582212390
    },
    {
        "content": "<p>good question :)<br>\nI tried to correlate the settings from the example with my settings. That's what came out of it.<br>\nin setting.py I didnt change any parametrs:<br>\n<a href=\"/user_uploads/2/14/FntJUGsdhjJCx_1kL0Duo21z/image.png\" target=\"_blank\" title=\"image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/14/FntJUGsdhjJCx_1kL0Duo21z/image.png\" target=\"_blank\" title=\"image.png\"><img src=\"/user_uploads/2/14/FntJUGsdhjJCx_1kL0Duo21z/image.png\"></a></div>",
        "id": 818916,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582212634
    },
    {
        "content": "<p>on the Idp side:<br>\n<a href=\"/user_uploads/2/7a/gsMt6VJQ7O-VyRhuvJMU9CZa/image.png\" target=\"_blank\" title=\"image.png\">image.png</a><br>\nor instead email, last_name, first_name do I have to put something esle?</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/7a/gsMt6VJQ7O-VyRhuvJMU9CZa/image.png\" target=\"_blank\" title=\"image.png\"><img src=\"/user_uploads/2/7a/gsMt6VJQ7O-VyRhuvJMU9CZa/image.png\"></a></div>",
        "id": 818918,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582212857
    },
    {
        "content": "<p>I will try to reboot container  at this nigth :) now users are working...</p>",
        "id": 818919,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582212990
    },
    {
        "content": "<p>That should probably be correct.<br>\nThere really is absolutely no message getting logged now on login attempts? <span aria-label=\"hear no evil\" class=\"emoji emoji-1f649\" role=\"img\" title=\"hear no evil\">:hear_no_evil:</span> Once we figure out what this issue is, I'll make sure this case is covered by some logging <span aria-label=\"confounded\" class=\"emoji emoji-1f616\" role=\"img\" title=\"confounded\">:confounded:</span></p>",
        "id": 818920,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582213018
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/818914\" title=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/818914\">said</a>:</p>\n<blockquote>\n<p>So nothing is getting logged now, but you're getting redirected back to the login page?</p>\n<p>Are the attribute statements configured correctly?</p>\n</blockquote>\n<p>yes. I was redirected back to login page...</p>",
        "id": 818921,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582213115
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/818920\" title=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/818920\">said</a>:</p>\n<blockquote>\n<p>That should probably be correct.<br>\nThere really is absolutely no message getting logged now on login attempts? <span aria-label=\"hear no evil\" class=\"emoji emoji-1f649\" role=\"img\" title=\"hear no evil\">:hear_no_evil:</span> Once we figure out what this issue is, I'll make sure this case is covered by some logging <span aria-label=\"confounded\" class=\"emoji emoji-1f616\" role=\"img\" title=\"confounded\">:confounded:</span></p>\n</blockquote>\n<p>After the reboot, I will still investigate</p>",
        "id": 818922,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582213274
    },
    {
        "content": "<p>After reboot I can see errors again.<br>\nthe same error: /login/saml/ : Bad idp param: 'IDP must contain x509cert or x509certMulti'. <br>\nThere is only one cert in /etc/zulip/saml/idps/ <br>\nIt is the public cert of Idp - zchat.crt<br>\nI`ve got it by export from wso2carbon.jks (Java key store in WSO2IS )<br>\nexport command: keytool -export -alias wso2carbon.cert -keystore wso2carbon.jks -file zchat.crt<br>\nwso2carbon.cert is chosen in SP settings on the Idp side.<br>\n<a href=\"/user_uploads/2/c7/_uYYBP-FvPuiUxH9KhVY_87-/image.png\" target=\"_blank\" title=\"image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/c7/_uYYBP-FvPuiUxH9KhVY_87-/image.png\" target=\"_blank\" title=\"image.png\"><img src=\"/user_uploads/2/c7/_uYYBP-FvPuiUxH9KhVY_87-/image.png\"></a></div>",
        "id": 819420,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582278944
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"14868\">Максим Декин</span> Did perhaps the file permissions get reset on restart?</p>",
        "id": 819597,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582307473
    },
    {
        "content": "<p>No, It didnt. I check every time.</p>",
        "id": 821320,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582612686
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/819597\" title=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/819597\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"14868\">Максим Декин</span> Did perhaps the file permissions get reset on restart?</p>\n</blockquote>\n<p>Hi, I do not lose hope to configure SAML :)<br>\nPlease answer the questions, it make me clear about saml configuration in zulip. </p>\n<p>SOCIAL_AUTH_SAML_ENABLED_IDPS as dict can contains more the one saml configuration, isnt it?<br>\nif so, \"idp_name\" - I can set any name, isnt it? (even if I have only one saml configuration)</p>\n<p>Do I need to chage \"idp_name\"? Because in documentation I see: \"The \"x509cert\" attribute is automatically read from /etc/zulip/saml/idps/{idp_name}.crt\"</p>\n<p>for example: I need give the name \"myidp\" instead of \"idp_name\" then I heed to rename my cert file to \"myidp.crt\", Is it right?<br>\nIf no, then what name do I give to my crtificate file.</p>\n<p>And question about \"entity_id\" - What is that if it is not a idp name on the saml provider side? What do I need to set?</p>\n<p>SOCIAL_AUTH_SAML_ENABLED_IDPS = {<br>\n    \"idp_name\": {<br>\n        # Configure entity_id and url according to information provided to you by your IdP:<br>\n        \"entity_id\": \"zchat\",<br>\n        \"url\": \"<a href=\"https://is.vols-vl.ru/samlsso\" target=\"_blank\" title=\"https://is.vols-vl.ru/samlsso\">https://is.vols-vl.ru/samlsso</a>\",<br>\n        # The part below corresponds to what's likely referred to as something like<br>\n        # \"Attribute Statements\" (with Okta as your IdP) or \"Attribute Mapping\" (with G Suite).<br>\n        # The names on the right side need to correspond to the names under which<br>\n        # the IdP will send the user attributes. With these defaults, it's expected<br>\n        # that the user's email will be sent with the \"email\" attribute name,<br>\n        # the first name and the last name with the \"first_name\", \"last_name\" attribute names.<br>\n        \"attr_user_permanent_id\": \"email\",<br>\n        \"attr_first_name\": \"first_name\",<br>\n        \"attr_last_name\": \"last_name\",<br>\n        \"attr_username\": \"email\",<br>\n        \"attr_email\": \"email\",<br>\n        # The \"x509cert\" attribute is automatically read from<br>\n        # /etc/zulip/saml/idps/{idp_name}.crt; don't specify it here.<br>\n        \"display_name\": \"Auth SAML in VOLS\",<br>\n    }<br>\n}</p>",
        "id": 822164,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582712560
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"14868\">@Максим Декин</span> Yes, the .crt file name needs to match the name. <code>\"entity_id\"</code> is the standard SAML <code>EntityId</code> attribute (of the IdP)  - <a href=\"https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata\" target=\"_blank\" title=\"https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata\">https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata</a> - you should be able to get it from the IdP.</p>",
        "id": 822231,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582730337
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822231\" title=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822231\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"14868\">Максим Декин</span> Yes, the .crt file name needs to match the name. <code>\"entity_id\"</code> is the standard SAML <code>EntityId</code> attribute (of the IdP)  - <a href=\"https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata\" target=\"_blank\" title=\"https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata\">https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata</a> - you should be able to get it from the IdP.</p>\n</blockquote>\n<p>You sad - Yes, the .crt file name needs to match the name. \"entity_id\" -  But it`s wrong :) In Documentation <a href=\"https://zulip.readthedocs.io/en/latest/production/authentication-methods.html\" target=\"_blank\" title=\"https://zulip.readthedocs.io/en/latest/production/authentication-methods.html\">https://zulip.readthedocs.io/en/latest/production/authentication-methods.html</a> We can see that .crt file name needs to match the \"idp_name\" not \"entity_id\" . Please look at docs.<br>\nso, let me repeat question: Do I need change \"idp_name\" in the section SOCIAL_AUTH_SAML_ENABLED_IDPS = {} of the setting.py? What is \"idp_name \" ? What the name do I have to set as \"idp_name\"?</p>\n<p>There are no questions about \"entity_id\" :)</p>",
        "id": 822612,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582787498
    },
    {
        "content": "<p>I guess \"idp_name\" does not mean anything important, so I changed it to \"zulip\" and renamed .crt file to zulip.crt<br>\nand Now SAML auth is working, but only for existed users. I mean, if user is registered, I can login to app, otherwise application invites to register new user.<br>\n<a href=\"/user_uploads/2/5d/KLX-6hQrp4P9_YD7z_M_kVko/image.png\" target=\"_blank\" title=\"image.png\">image.png</a><br>\nI click continiue and I'am getting redirected back to login page.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/5d/KLX-6hQrp4P9_YD7z_M_kVko/image.png\" target=\"_blank\" title=\"image.png\"><img src=\"/user_uploads/2/5d/KLX-6hQrp4P9_YD7z_M_kVko/image.png\"></a></div><p>what's logs can help to get clear? What does not allow to register a new user after SAML auth ?</p>",
        "id": 822656,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582795628
    },
    {
        "content": "<blockquote>\n<p>Yes, the .crt file name needs to match the name. \"entity_id\" is the standard SAML EntityId attribute (of the IdP) - <a href=\"https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata\" target=\"_blank\" title=\"https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata\">https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata</a> - you should be able to get it from the IdP.</p>\n</blockquote>\n<p>Those were answers to your two questions - you asked about .crt file name, and about what \"entity_id\" is <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span>  </p>\n<p>Hmm, I'm not aware of any registration-specific issues. Could this be an issue with your organization settings not allowing registration? If not, can you check the logs again?</p>",
        "id": 822657,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582796639
    },
    {
        "content": "<p>Could this be an issue with your organization settings not allowing registration? - I haven't seen any setting in \"Organisation Setting\" to manage user registration (allow/disallow and so on). I could`n find in documentation too. Where is this setting?</p>\n<p>-----LOG-----<br>\n2020-02-27 10:17:00.277 INFO [zr] 172.17.230.153  GET     200  30ms (db: 3ms/6q) /accounts/do_confirm/beg4t6vogl4f83tv4t9xrzxf (unauth via ?)<br>\n[pid: 6199|app: 0|req: 16/42] 172.23.0.1 () {70 vars in 1736 bytes} [Thu Feb 27 10:17:00 2020] GET /accounts/do_confirm/beg4t6vogl4f83tv4t9xrzxf?full_name=officeadmin+officeadmin =&gt; generated 2450 bytes in 32 msecs (HTTP/1.1 200) 5 headers in 319 bytes (1 switches on core 0)</p>\n<p>2020-02-27 10:17:00.381 DEBG [django_auth_ldap] search_s('ou=Users,ou=Uvv,dc=ot,dc=ru', 2, '(mail=%(email)s)') returned 1 objects: cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru<br>\n2020-02-27 10:17:00.395 DEBG [django_auth_ldap] search_s('ou=Users,ou=Uvv,dc=ot,dc=ru', 2, '(mail=%(user)s)') returned 1 objects: cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru<br>\n2020-02-27 10:17:00.402 DEBG [django_auth_ldap] search_s('cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru', 0, '(objectClass=*)') returned 1 objects: cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru<br>\n2020-02-27 10:17:00.457 DEBG [django_auth_ldap] search_s('ou=Users,ou=Uvv,dc=ot,dc=ru', 2, '(mail=%(email)s)') returned 1 objects: cn=officeadmin,ou=users,ou=uvv,dc=ot,dc=ru</p>\n<p>2020-02-27 10:17:00.458 DEBG [django_auth_ldap] Rejecting empty password for <a href=\"mailto:officeadmin@rosseti.digital\" title=\"mailto:officeadmin@rosseti.digital\">officeadmin@rosseti.digital</a></p>\n<p>2020-02-27 10:17:00.471 INFO [zr] 172.17.230.153  POST    302 116ms (db: 9ms/7q) /accounts/register/ (unauth via ?)<br>\n[pid: 6196|app: 0|req: 4/43] 172.23.0.1 () {76 vars in 1571 bytes} [Thu Feb 27 10:17:00 2020] POST /accounts/register/ =&gt; generated 0 bytes in 118 msecs (HTTP/1.1 302) 6 headers in 376 bytes (1 switches on core 0)</p>\n<p>2020-02-27 10:17:00.540 INFO [zr] 172.17.230.153  GET     200  57ms (db: 1ms/1q) /accounts/login/ (unauth via ?)<br>\n[pid: 6199|app: 0|req: 17/44] 172.23.0.1 () {70 vars in 1480 bytes} [Thu Feb 27 10:17:00 2020] GET /accounts/login/?email=officeadmin%40rosseti.digital =&gt; generated 10102 bytes in 60 msecs (HTTP/1.1 200) 7 headers in 423 bytes (1 switches on core 0)</p>\n<p>---END LOG----<br>\nWhay after SAML auth does zulip try LDAP? Of couse password is empty, password exists in saml flow only.</p>\n<p>P.S. If I login via LDAP from begin, then new user registeration is successfully.  LDAP works always because I have to fill password feald in the login form  :)</p>",
        "id": 822663,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582799707
    },
    {
        "content": "<ol>\n<li>Do you have your ldap config with the LDAP_APPEND_DOMAIN?</li>\n<li>Does this user exist in ldap?</li>\n</ol>\n<p>For the registration settings, can you go to Manage organization -&gt; Organization permissions? These settings could be relevant:<br>\n<a href=\"/user_uploads/2/28/VL12ZmGSJ1o_I9PCRu7dHzMa/image.png\" target=\"_blank\" title=\"image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/28/VL12ZmGSJ1o_I9PCRu7dHzMa/image.png\" target=\"_blank\" title=\"image.png\"><img src=\"/user_uploads/2/28/VL12ZmGSJ1o_I9PCRu7dHzMa/image.png\"></a></div>",
        "id": 822665,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582801292
    },
    {
        "content": "<p>upd. I got working registration user after SAML auth<br>\nTo get SAML auth work correctly including user registration, It is necessary to enable only SAML auth backend.<br>\n In documentation <a href=\"https://zulip.readthedocs.io/en/latest/production/authentication-methods.html\" target=\"_blank\" title=\"https://zulip.readthedocs.io/en/latest/production/authentication-methods.html\">https://zulip.readthedocs.io/en/latest/production/authentication-methods.html</a></p>\n<ol start=\"6\">\n<li>Enable the zproject.backends.SAMLAuthBackend auth backend, in AUTHENTICATION_BACKENDS in /etc/zulip/settings.py.</li>\n</ol>\n<p>Shoud be changed to:<br>\nEnable the zproject.backends.SAMLAuthBackend auth backend, in AUTHENTICATION_BACKENDS in /etc/zulip/settings.py.  AND DISABLE ANY OTHERS.</p>\n<p>for example:<br>\nAUTHENTICATION_BACKENDS = (<br>\n    #'zproject.backends.EmailAuthBackend',  # Email and password; just requires SMTP setup<br>\n    # 'zproject.backends.GoogleAuthBackend',  # Google auth, setup below<br>\n    # 'zproject.backends.GitHubAuthBackend',  # GitHub auth, setup below<br>\n    # 'zproject.backends.AzureADAuthBackend',  # Microsoft Azure Active Directory auth, setup below<br>\n    'zproject.backends.SAMLAuthBackend', # SAML, setup below<br>\n    #'zproject.backends.ZulipLDAPAuthBackend',  # LDAP, setup below<br>\n    # 'zproject.backends.ZulipRemoteUserBackend',  # Local SSO, setup docs on readthedocs<br>\n)  # type: Tuple[str, ...]</p>",
        "id": 822666,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582801442
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822231\" title=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822231\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"14868\">Максим Декин</span> Yes, the .crt file name needs to match the name. <code>\"entity_id\"</code> is the standard SAML <code>EntityId</code> attribute (of the IdP)  - <a href=\"https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata\" target=\"_blank\" title=\"https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata\">https://en.wikipedia.org/wiki/SAML_metadata#Entity_metadata</a> - you should be able to get it from the IdP.</p>\n</blockquote>\n<p>It is not obvious that I have to change the \"idp_name\" of SOCIAL_AUTH_SAML_ENABLED_IDPS  in setting.py to something, and  rename the certificate according to that. \"idp_name\" seems a parameter that cannot be changed.</p>",
        "id": 822667,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582802247
    },
    {
        "content": "<blockquote>\n<p>It is not obvious that I have to change the \"idp_name\" of SOCIAL_AUTH_SAML_ENABLED_IDPS in setting.py to something, and rename the certificate according to that. \"idp_name\" seems a parameter that cannot be changed.</p>\n</blockquote>\n<p>I'll try to improve those instructions, thanks!</p>\n<blockquote>\n<p>To get SAML auth work correctly including user registration, It is necessary to enable only SAML auth backend.</p>\n</blockquote>\n<p>It's not quite that way. SAML has no problem with other backends. What I believe was the issue here was that this SAML user is in your ldap directory (unless I'm wrong in this assumption?). Users that are in ldap can only be managed by the ldap backend, so trying to access them via other backends may not work. That's why disabling the ldap backend fixed the issue for you.</p>",
        "id": 822669,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582802701
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822669\" title=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/822669\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>It is not obvious that I have to change the \"idp_name\" of SOCIAL_AUTH_SAML_ENABLED_IDPS in setting.py to something, and rename the certificate according to that. \"idp_name\" seems a parameter that cannot be changed.</p>\n</blockquote>\n<p>I'll try to improve those instructions, thanks!</p>\n<blockquote>\n<p>To get SAML auth work correctly including user registration, It is necessary to enable only SAML auth backend.</p>\n</blockquote>\n<p>It's not quite that way. SAML has no problem with other backends. What I believe was the issue here was that this SAML user is in your ldap directory (unless I'm wrong in this assumption?). Users that are in ldap can only be managed by the ldap backend, so trying to access them via other backends may not work. That's why disabling the ldap backend fixed the issue for you.</p>\n</blockquote>\n<p>You are right. It is the same domain/ldap and the same user.  But it's not obvious  that I can not use both backend. As usual organisation have one LDAP/AD. At the beginig the admin configures LDAP as the easiest way. Next, if organisation want to use saml, admin start configuring SAML auth and face the challenge :) he doesn't know that he must disable LDAP auth backend. <br>\nI think it must to be in documentation too.</p>\n<p>Anyway, I'm appreciated you support. I don’t think I would solve SAML problems without your help. Thank you very much!</p>",
        "id": 822674,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582805200
    },
    {
        "content": "<p>We have a TODO in the code to show a proper error message in this case (user trying to register via non-ldap backend, with an email that belongs to ldap). Time to fix that I guess <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> I'll add it to the top of my queue, since it should be very fast.</p>",
        "id": 822699,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582813720
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"14868\">@Максим Декин</span> I looked through our doc and see that in <a href=\"https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#saml\" target=\"_blank\" title=\"https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#saml\">https://zulip.readthedocs.io/en/latest/production/authentication-methods.html#saml</a> point 3, we do mention:</p>\n<blockquote>\n<p>Set the outer idp_name key to be an identifier for your IdP, e.g. testshib or okta. This field appears in URLs for parts of your Zulip server’s SAML authentication flow</p>\n</blockquote>\n<p>Does that sound okay and you simply missed it by accident, or could we make this stuff clearer somehow?</p>",
        "id": 823473,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1582906833
    },
    {
        "content": "<p>first of all english is not my native and I can misunderstandin something. I'll try explain about wso2is provider :)</p>\n<p>\"Set the outer idp_name key to be an identifier for your IdP\" - Yes, I saw it, but the fact is that it was not clear wich setting in WSO2IS is identifier for IdP.<br>\nI guess that it can be any name and should not correspond to any settings in WSO2IS, so I used the same name (zchat) on both sides as a precaution :) </p>\n<p>\"The IdP should provide the url and entity_id values.\" - This also caused some difficulty in understanding. This parameter we can see only in IdP's metadata.xml by URL. At the begin I tryed to set it as \"zchat\" I thought it is Service Provider Name (see the screen)<br>\n<a href=\"/user_uploads/2/10/gZGl-Wikf48jSUd8StVQRylz/image.png\" target=\"_blank\" title=\"image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/10/gZGl-Wikf48jSUd8StVQRylz/image.png\" target=\"_blank\" title=\"image.png\"><img src=\"/user_uploads/2/10/gZGl-Wikf48jSUd8StVQRylz/image.png\"></a></div>",
        "id": 823496,
        "sender_full_name": "Максим Декин",
        "timestamp": 1582911000
    },
    {
        "content": "<p>hi, hope its ok to \"hijack\" this topic? but it fits exactly.. if not, let me know and i create a new one..</p>\n<p>i got the two (zulip, keycloak) linked and it redirects me to my keycloak to sign in.. i sign in, get redirected back and land on the login page.. the auth log tells me:</p>\n<p><code>WARN [zulip.auth.saml] SAML got invalid email argument.</code></p>\n<p>and i googled the hell outta it.. some say they changed the names to saml identity names, some say, i need to configure my idp to actually send the attributes.. but there is nothing on how to do that and how to figure out the saml identity names..</p>\n<p>i am using the latest keycloak (14.0.0) and the latest zulip (4.3)</p>\n<p>does anyone a hint maybe on what i screwed up?</p>",
        "id": 1224790,
        "sender_full_name": "Andreas",
        "timestamp": 1625384503
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20964\">@Andreas</span> Sorry for the delay, I noticed your question on github but couldn't answer at that moment. I guess your problem is with the keycloak mapper for your email property. I am still using Keycloak 13 but I don't think that they changed something essential in the meanwhile. </p>\n<p>First take a look at my configuration of zulip SAML: <a href=\"/user_uploads/2/c1/SaflvFLCX9dEbe-V4lNB58mW/Bildschirmfoto-2021-07-04-um-14.58.06.png\">Bildschirmfoto-2021-07-04-um-14.58.06.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/c1/SaflvFLCX9dEbe-V4lNB58mW/Bildschirmfoto-2021-07-04-um-14.58.06.png\" title=\"Bildschirmfoto-2021-07-04-um-14.58.06.png\"><img src=\"/user_uploads/2/c1/SaflvFLCX9dEbe-V4lNB58mW/Bildschirmfoto-2021-07-04-um-14.58.06.png\"></a></div><p>Notice that <code>attribute_user_permanent_id</code> does not work yet, as Zulip always takes the email attribute as permanent ID. I think, <span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> said they wanted to support this feature soon, so SAML users are able to change their email addresses.</p>\n<p>Second, have a look at my configuration of the mail mapper: <a href=\"/user_uploads/2/a4/BgUgsF_WGRB9_khAnCI7kgAP/Bildschirmfoto-2021-07-04-um-15.03.01.png\">Bildschirmfoto-2021-07-04-um-15.03.01.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/a4/BgUgsF_WGRB9_khAnCI7kgAP/Bildschirmfoto-2021-07-04-um-15.03.01.png\" title=\"Bildschirmfoto-2021-07-04-um-15.03.01.png\"><img src=\"/user_uploads/2/a4/BgUgsF_WGRB9_khAnCI7kgAP/Bildschirmfoto-2021-07-04-um-15.03.01.png\"></a></div>",
        "id": 1224807,
        "sender_full_name": "Lumrenion",
        "timestamp": 1625403928
    },
    {
        "content": "<p>hey <span class=\"user-mention\" data-user-id=\"20570\">@Lumrenion</span> ! thx again.. nah, no need to sorry.. i just didnt wanna annoy and thought maybe someone else in here has an idea..</p>\n<p>i set up the mapper and double checked the config.. now it doesnt complain about the email anymore but throws me to: <a href=\"/user_uploads/2/79/47CI226Cmv17iBcYWL9L581w/image.png\">image.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/79/47CI226Cmv17iBcYWL9L581w/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/79/47CI226Cmv17iBcYWL9L581w/image.png\"></a></div><p>error log tells me:</p>\n<div class=\"codehilite\"><pre><span></span><code>2021-07-04 13:17:57.622 ERR  [django.request] Internal Server Error: /complete/saml/\nTraceback (most recent call last):\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/exception.py&quot;, line 47, in inner\n    response = get_response(request)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py&quot;, line 181, in _get_response\n    response = wrapped_callback(request, *callback_args, **callback_kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/cache.py&quot;, line 44, in _wrapped_view_func\n    response = view_func(request, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/csrf.py&quot;, line 54, in wrapped_view\n    return view_func(*args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_django/utils.py&quot;, line 49, in wrapper\n    return func(request, backend, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_django/views.py&quot;, line 31, in complete\n    return do_complete(request.backend, _do_login, user=request.user,\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/actions.py&quot;, line 45, in do_complete\n    user = backend.complete(user=user, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py&quot;, line 40, in complete\n    return self.auth_complete(*args, **kwargs)\n  File &quot;/home/zulip/deployments/2021-07-01-17-34-40/./zproject/backends.py&quot;, line 2204, in auth_complete\n    result = super().auth_complete(*args, **kwargs)\n  File &quot;/home/zulip/deployments/2021-07-01-17-34-40/./zproject/backends.py&quot;, line 1610, in auth_complete\n    return super().auth_complete(*args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/saml.py&quot;, line 333, in auth_complete\n    return self.strategy.authenticate(*args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_django/strategy.py&quot;, line 107, in authenticate\n    return authenticate(*args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/debug.py&quot;, line 42, in sensitive_variables_wrapper\n    return func(*func_args, **func_kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/auth/__init__.py&quot;, line 76, in authenticate\n    user = backend.authenticate(request, **credentials)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py&quot;, line 80, in authenticate\n    return self.pipeline(pipeline, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py&quot;, line 83, in pipeline\n    out = self.run_pipeline(pipeline, pipeline_index, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/backends/base.py&quot;, line 113, in run_pipeline\n    result = func(*args, **out) or {}\n  File &quot;/srv/zulip-venv-cache/cc77818846b328558cc9444c67cbbe0121ca80f4/zulip-py3-venv/lib/python3.8/site-packages/social_core/pipeline/partial.py&quot;, line 30, in wrapper\n    out = func(strategy=strategy,\n  File &quot;/home/zulip/deployments/2021-07-01-17-34-40/./zproject/backends.py&quot;, line 1443, in social_auth_associate_user\n    user_profile = social_associate_user_helper(backend, return_data, *args, **kwargs)\n  File &quot;/home/zulip/deployments/2021-07-01-17-34-40/./zproject/backends.py&quot;, line 1417, in social_associate_user_helper\n    raise AssertionError(&quot;Social auth backend doesn&#39;t provide name&quot;)\nAssertionError: Social auth backend doesn&#39;t provide name\n</code></pre></div>\n<p>meine dankbarkeit würde dich ewig verfolgen, wenn du darauf auch ne antwort hättest :D</p>",
        "id": 1224809,
        "sender_full_name": "Andreas",
        "timestamp": 1625404735
    },
    {
        "content": "<p>is there a way to dump out the response from the auth server? to see like what it actually sends out?<br>\ni kinda feel like flying blind..</p>",
        "id": 1224810,
        "sender_full_name": "Andreas",
        "timestamp": 1625405012
    },
    {
        "content": "<p>I had this error with my keycloak test account. Turned out, that account did not have a first name and last name. Once set, I was able to log in with that account. So make sure your keyclak user you are trying to login with has those two attributes filled and double check your attribute mappers for those too:<br>\n<a href=\"/user_uploads/2/e8/kaRcuW5xLwPTIcCVgiuEOlqt/Bildschirmfoto-2021-07-04-um-15.23.01.png\">Bildschirmfoto-2021-07-04-um-15.23.01.png</a> <a href=\"/user_uploads/2/f1/hMd7qEml14rdtj0cHM69_U7W/Bildschirmfoto-2021-07-04-um-15.23.09.png\">Bildschirmfoto-2021-07-04-um-15.23.09.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/e8/kaRcuW5xLwPTIcCVgiuEOlqt/Bildschirmfoto-2021-07-04-um-15.23.01.png\" title=\"Bildschirmfoto-2021-07-04-um-15.23.01.png\"><img src=\"/user_uploads/2/e8/kaRcuW5xLwPTIcCVgiuEOlqt/Bildschirmfoto-2021-07-04-um-15.23.01.png\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/2/f1/hMd7qEml14rdtj0cHM69_U7W/Bildschirmfoto-2021-07-04-um-15.23.09.png\" title=\"Bildschirmfoto-2021-07-04-um-15.23.09.png\"><img src=\"/user_uploads/2/f1/hMd7qEml14rdtj0cHM69_U7W/Bildschirmfoto-2021-07-04-um-15.23.09.png\"></a></div>",
        "id": 1224811,
        "sender_full_name": "Lumrenion",
        "timestamp": 1625405048
    },
    {
        "content": "<p>awesome, thx man! very much appreciate your help here!</p>",
        "id": 1224812,
        "sender_full_name": "Andreas",
        "timestamp": 1625405076
    },
    {
        "content": "<p>do you also have a mapper for username? is it just <code>username</code> or is it <code>userName</code>?</p>",
        "id": 1224814,
        "sender_full_name": "Andreas",
        "timestamp": 1625405155
    },
    {
        "content": "<p><a href=\"/user_uploads/2/a7/rZPBRgbBBKRUEkaNApX6kqub/Bildschirmfoto-2021-07-04-um-15.26.15.png\">Bildschirmfoto-2021-07-04-um-15.26.15.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/a7/rZPBRgbBBKRUEkaNApX6kqub/Bildschirmfoto-2021-07-04-um-15.26.15.png\" title=\"Bildschirmfoto-2021-07-04-um-15.26.15.png\"><img src=\"/user_uploads/2/a7/rZPBRgbBBKRUEkaNApX6kqub/Bildschirmfoto-2021-07-04-um-15.26.15.png\"></a></div>",
        "id": 1224815,
        "sender_full_name": "Lumrenion",
        "timestamp": 1625405194
    },
    {
        "content": "<p>k, had it set that way.. thx!</p>",
        "id": 1224817,
        "sender_full_name": "Andreas",
        "timestamp": 1625405250
    },
    {
        "content": "<p>ah and... it works!!</p>",
        "id": 1224818,
        "sender_full_name": "Andreas",
        "timestamp": 1625405257
    },
    {
        "content": "<p>all those sweat and tears..</p>",
        "id": 1224819,
        "sender_full_name": "Andreas",
        "timestamp": 1625405276
    },
    {
        "content": "<p>I am glad I can contribute to this project with my experience and support at least <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 1224822,
        "sender_full_name": "Lumrenion",
        "timestamp": 1625405759
    },
    {
        "content": "<p>Ahh interesting - perhaps zulip should handle the edge case of the IdP sending an empty name instead of throwing this error.</p>",
        "id": 1224852,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1625409876
    },
    {
        "content": "<p>It is common practice in several software to use the username as fallback display name if other names are empty. But if I remember correctly, we noticed that the username, which has a mapping configuration in Zulips SAML configuration, does not currently get saved in the Zulip database</p>",
        "id": 1224865,
        "sender_full_name": "Lumrenion",
        "timestamp": 1625410694
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"20570\">Lumrenion</span> <a href=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/1224865\">said</a>:</p>\n<blockquote>\n<p>It is common practice in several software to use the username as fallback display name if other names are empty. But if I remember correctly, we noticed that the username, which has a mapping configuration in Zulips SAML configuration, does not currently get saved in the Zulip database</p>\n</blockquote>\n<p>yeah, that's correct.</p>",
        "id": 1225215,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1625512281
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20570\">@Lumrenion</span> it'd be awesome if you'd be up for writing a short writeup for KeyCloak similar to what we have in <code>templates/zerver/help/saml-authentication.md</code> aka <a href=\"https://zulip.com/help/saml-authentication\">https://zulip.com/help/saml-authentication</a> so that we can make this easy for others.</p>",
        "id": 1225217,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1625512347
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> and I are happy to do an editing pass, it'd just be nice for someone who's done this setup to do an initial writeup (even just in a message here).</p>",
        "id": 1225219,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1625512389
    },
    {
        "content": "<p>Yes, I will do this. Already did a writeup here <a href=\"https://github.com/zulip/zulip/issues/18659#issuecomment-855799758\">https://github.com/zulip/zulip/issues/18659#issuecomment-855799758</a> and can reformat it to match the docs page. <span class=\"user-mention\" data-user-id=\"20964\">@Andreas</span> can you explain what information exactly was missing for you to get authentication setup on both sides, Zulip and Keycloak, working immediately?</p>",
        "id": 1225711,
        "sender_full_name": "Lumrenion",
        "timestamp": 1625551476
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20570\">@Lumrenion</span> the main thing was probably that the keycloak keys aint gonna cut it on the zulip side as well as you have to have your own mappers for the user attributes..</p>\n<p>AND, thats something i was able to figure out myself ( <span aria-label=\"party ball\" class=\"emoji emoji-1f38a\" role=\"img\" title=\"party ball\">:party_ball:</span> ) you have to remove the default client scope <code>role_list</code>:</p>\n<p><a href=\"user_uploads/2/ba/dlGps56BW2LXd2VTOeG5As8G/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"user_uploads/2/ba/dlGps56BW2LXd2VTOeG5As8G/image.png\" title=\"image.png\"><img src=\"user_uploads/2/ba/dlGps56BW2LXd2VTOeG5As8G/image.png\"></a></div><p>and have your own role mapper set up:</p>\n<p><a href=\"/user_uploads/2/b8/-qBfpbBQp1iCSmmV4nsiC0Cs/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/b8/-qBfpbBQp1iCSmmV4nsiC0Cs/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/b8/-qBfpbBQp1iCSmmV4nsiC0Cs/image.png\"></a></div>",
        "id": 1225712,
        "sender_full_name": "Andreas",
        "timestamp": 1625551786
    },
    {
        "content": "<p>I think you don‘t even need the roles mapper as Zulip currently does not support group mapping from SAML nor LDAP</p>",
        "id": 1225713,
        "sender_full_name": "Lumrenion",
        "timestamp": 1625552422
    },
    {
        "content": "<p>ah, ok.. then just removing the scope might do the trick then..</p>",
        "id": 1225715,
        "sender_full_name": "Andreas",
        "timestamp": 1625552551
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"10349\">Mateusz Mandera</span> <a href=\"#narrow/stream/31-production-help/topic/SAML.2Fkeycloak.20configuration/near/1224852\">said</a>:</p>\n<blockquote>\n<p>Ahh interesting - perhaps zulip should handle the edge case of the IdP sending an empty name instead of throwing this error.</p>\n</blockquote>\n<p><a href=\"https://github.com/zulip/zulip/pull/19152\">#19152</a> for fixing this one</p>",
        "id": 1226726,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1625668799
    },
    {
        "content": "<p>Hi all! Im trying to set up Keycloak SAML with Zulip and running into an issue where it says that authentication needs to be signed, however when i add a zulip pem file generated on the server to the SAML Keys (while also having the keycloak.cert file in the saml folder) I then get <code>Signature validation failed. SAML Response rejected.</code> Ive been debugging for a few hours now and am out of ideas. I'd be happy to provide any necessary info :)</p>",
        "id": 1247759,
        "sender_full_name": "Sean Cassar",
        "timestamp": 1629250347
    },
    {
        "content": "<p>Hi, did you already check the PR I created to extend the documentation with instructions how to setup keycloak? <a href=\"https://github.com/zulip/zulip/pull/19245\">https://github.com/zulip/zulip/pull/19245</a></p>\n<p>The PR also explains, how to setup signed communication between keycloak and zulip</p>",
        "id": 1247808,
        "sender_full_name": "Lumrenion",
        "timestamp": 1629270314
    },
    {
        "content": "<p>Speaking of which, what's the status of that PR? I see it has some resolved comments, but is failing CI due to <a href=\"https://github.com/zulip/zulip/pull/19245/checks?check_run_id=3135454641\">some linter errors</a>.  <span class=\"user-mention\" data-user-id=\"20570\">@Lumrenion</span> <span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> can one of you clean those up?  I can then do a final polish review and get it integrated.</p>",
        "id": 1248395,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1629468137
    },
    {
        "content": "<p>If the content is fine and there are only formal errors, I can fix the linter errors. But tbh I don‘t understand, what those mean. It says </p>\n<blockquote>\n<p>Realms are referred to as Organizations in user-facing docs.</p>\n</blockquote>\n<p>Does it say I should not use the word „realm“? Well, but those ARE called so in Keycloak 🤷</p>",
        "id": 1248399,
        "sender_full_name": "Lumrenion",
        "timestamp": 1629468523
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20570\">@Lumrenion</span> ahh, if it's a keycloak concept, we should just add an exclude rule for it.  One can do that in <code>tools/linter_lib/custom_check.py</code> by searching for the error message, but we're happy to take care of that since it's a Zulip expertise thing if you're happy with the language.</p>",
        "id": 1248404,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1629469147
    },
    {
        "content": "<p>Alright! I am happy with the language, but you are the native speaker after all :)</p>",
        "id": 1248408,
        "sender_full_name": "Lumrenion",
        "timestamp": 1629469244
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20570\">@Lumrenion</span> I pushed an update to the PR that addresses a bunch of formatting and language; can you check it for correctness issues I might have introduced?</p>",
        "id": 1248417,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1629473467
    },
    {
        "content": "<p>Posted some comments as well</p>",
        "id": 1248421,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1629476156
    }
]