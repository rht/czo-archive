[
    {
        "content": "<p>Hi all, I tried upgrading my docker-compose deployment from 2.1.6 to 3.0 and nginx won't start with an error about <code>nginx_sharding.conf</code> which is missing. I'm assuming I need to run a puppet job somewhere?</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"gp\">$</span> docker-compose <span class=\"nb\">exec</span> zulip cat /var/log/nginx/error.log\n<span class=\"go\">2020/07/30 18:57:08 [emerg] 34#34: open() &quot;/etc/zulip/nginx_sharding.conf&quot; failed (2: No such file or directory) in /etc/nginx/sites-enabled/zulip-enterprise:33</span>\n<span class=\"go\">2020/07/30 18:57:11 [emerg] 110#110: open() &quot;/etc/zulip/nginx_sharding.conf&quot; failed (2: No such file or directory) in /etc/nginx/sites-enabled/zulip-enterprise:33</span>\n<span class=\"go\">2020/07/30 18:57:14 [emerg] 130#130: open() &quot;/etc/zulip/nginx_sharding.conf&quot; failed (2: No such file or directory) in /etc/nginx/sites-enabled/zulip-enterprise:33</span>\n<span class=\"go\">2020/07/30 18:57:17 [emerg] 171#171: open() &quot;/etc/zulip/nginx_sharding.conf&quot; failed (2: No such file or directory) in /etc/nginx/sites-enabled/zulip-enterprise:33</span>\n</code></pre></div>",
        "id": 965119,
        "sender_full_name": "pemontto",
        "timestamp": 1596136177
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"15691\">@pemontto</span> hmm, can you try running <code>/home/zulip/deployments/current/scripts/zulip-puppet-apply</code> in the container?</p>",
        "id": 965250,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596139041
    },
    {
        "content": "<p>I would not expect that to be necessary.</p>",
        "id": 965252,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596139058
    },
    {
        "content": "<p>Since that file should have been generated by the image ...</p>",
        "id": 965255,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596139137
    },
    {
        "content": "<p>Oh, do you have MANUAL_CONFIGURATION set?</p>",
        "id": 965256,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596139147
    },
    {
        "content": "<p>I bet that having that system manage <code>/etc/zulip</code> is the problem here.</p>",
        "id": 965257,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596139164
    },
    {
        "content": "<p>I think logically we probably shouldn't be keeping that file in /etc/zulip; <span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> <span class=\"user-mention\" data-user-id=\"699\">@Anders Kaseorg</span> what do you think?  It seems like it would be better placed under <code>/etc/nginx/</code> somewhere with our other <code>nginx</code> configuration.</p>",
        "id": 965259,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596139213
    },
    {
        "content": "<p>Yep, MANUAL_CONFIGURATION=True</p>",
        "id": 965262,
        "sender_full_name": "pemontto",
        "timestamp": 1596139297
    },
    {
        "content": "<p>hmm weird, I just tried the latest image, as of 3 days ago, and it starts up ok</p>",
        "id": 965266,
        "sender_full_name": "pemontto",
        "timestamp": 1596139328
    },
    {
        "content": "<p>ahh, that's only because it's in my bind mount now</p>",
        "id": 965271,
        "sender_full_name": "pemontto",
        "timestamp": 1596139382
    },
    {
        "content": "<p>So <code>/etc/zulip/nginx_sharding.conf</code> is a generated file by puppet; if you're doing your own management of the <code>/etc/zulip</code> directory, your tooling might delete that file.</p>",
        "id": 965272,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596139384
    },
    {
        "content": "<p>You know what I can't repro it now, it's getting dropped into that directory</p>",
        "id": 965278,
        "sender_full_name": "pemontto",
        "timestamp": 1596139535
    },
    {
        "content": "<p>I think I understand the change we want to make for the long term, which is to not have generated files under <code>/etc/zulip</code>.</p>",
        "id": 965316,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596140368
    },
    {
        "content": "<p>So if your system is working, we can just focus on making that change.</p>",
        "id": 965318,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596140390
    },
    {
        "content": "<p>Hmm yeah <code>/etc/nginx/</code> probably makes more sense. Though I think changing this will mean we'll need to add more compatibility puppet code, to remove that file on existing installations <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 967140,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1596207198
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> yeah, but it's only a line or two to delete a file, so shouldn't be a big deal.  Just need to make sure it happens after the <code>nginx</code> restart.</p>",
        "id": 967375,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596220121
    },
    {
        "content": "<p>Do we want to move <code>/etc/zulip/sharding.json</code> elsewhere too? Not sure what the right place would be though</p>",
        "id": 968172,
        "sender_full_name": "Mateusz Mandera",
        "timestamp": 1596275845
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"10349\">@Mateusz Mandera</span> yes, I think under <code>/home/zulip/tornado/</code> would be appropriate.</p>",
        "id": 970863,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1596485952
    }
]