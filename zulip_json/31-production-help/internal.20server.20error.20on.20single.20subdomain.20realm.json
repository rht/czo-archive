[
    {
        "content": "<p>Hello,</p>\n<p>Can anyone help with this issue with a subdomain realm that's not working. We have several other subdomain realms that work fine. We are wondering if there's a database corruption error that needs to be repaired. We are receiving the following error when attempting to login to one of our subdomain installations:</p>\n<p>Logger django.request, from module django.utils.log line 230:<br>\nError generated by Collaboration HUB Admin &lt;<a href=\"mailto:user10@untcemi.collaborationhub.chat\">user10@untcemi.collaborationhub.chat</a>&gt; (Organization owner) on <a href=\"http://untcemi.collaborationhub.chat\">untcemi.collaborationhub.chat</a> deployment</p>\n<p>Traceback (most recent call last):<br>\n File \"/srv/zulip-venv-cache/cf3d745490514640ac79ed6b24b6a4f3814fa701/zulip-py3-venv/lib/python3.7/site-packages/django/core/handlers/exception.py\", line 47, in inner<br>\n   response = get_response(request)<br>\n File \"/srv/zulip-venv-cache/cf3d745490514640ac79ed6b24b6a4f3814fa701/zulip-py3-venv/lib/python3.7/site-packages/django/core/handlers/base.py\", line 181, in _get_response<br>\n   response = wrapped_callback(request, *callback_args, **callback_kwargs)<br>\n File \"./zerver/views/home.py\", line 129, in home<br>\n   return zulip_login_required(home_real)(request)<br>\n File \"./zerver/decorator.py\", line 432, in _wrapped_view<br>\n   return view_func(request, *args, **kwargs)<br>\n File \"/srv/zulip-venv-cache/cf3d745490514640ac79ed6b24b6a4f3814fa701/zulip-py3-venv/lib/python3.7/site-packages/django/contrib/auth/decorators.py\", line 21, in _wrapped_view<br>\n   return view_func(request, *args, **kwargs)<br>\n File \"./zerver/decorator.py\", line 481, in _wrapped_view_func<br>\n   return rate_limit()(view_func)(request, *args, **kwargs)<br>\n File \"./zerver/decorator.py\", line 984, in wrapped_func<br>\n   return func(request, *args, **kwargs)<br>\n File \"./zerver/views/home.py\", line 230, in home_real<br>\n   needs_tutorial=needs_tutorial,<br>\n File \"./zerver/lib/home.py\", line 153, in build_page_params_for_home_page_load<br>\n   include_streams=False,<br>\n File \"./zerver/lib/events.py\", line 1347, in do_events_register<br>\n   reactivate_user_if_soft_deactivated(user_profile)<br>\n File \"./zerver/lib/soft_deactivation.py\", line 307, in reactivate_user_if_soft_deactivated<br>\n   add_missing_messages(user_profile)<br>\n File \"./zerver/lib/soft_deactivation.py\", line 186, in add_missing_messages<br>\n   if stream_subscription_logs[-1].event_type == RealmAuditLog.SUBSCRIPTION_DEACTIVATED:<br>\nIndexError: list index out of range</p>\n<p>Deployed code:</p>\n<ul>\n<li>git: None</li>\n<li>ZULIP_VERSION: 5.4</li>\n</ul>\n<p>Request info:</p>\n<ul>\n<li>path: /</li>\n<li>GET: {}</li>\n<li>REMOTE_ADDR: \"129.120.67.52\"</li>\n<li>QUERY_STRING: \"\"</li>\n<li>SERVER_NAME: \"\"</li>\n</ul>\n<p>Thank you in advance for your help,<br>\nAgustin.</p>",
        "id": 1403308,
        "sender_full_name": "UNT Collaboration HUB",
        "timestamp": 1657644014
    },
    {
        "content": "<p>Hi! Is the busted realm a new one, or one that worked previously?</p>",
        "id": 1403342,
        "sender_full_name": "Matt",
        "timestamp": 1657646538
    },
    {
        "content": "<p>Also <span class=\"user-mention\" data-user-id=\"24421\">@UNT Collaboration HUB</span> can you explain the process through which this organization was created?</p>",
        "id": 1403577,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657654153
    },
    {
        "content": "<p>Hello <span class=\"user-mention\" data-user-id=\"24078\">@Matt Keller</span> !<br>\nThis realm worked previously.</p>",
        "id": 1403895,
        "sender_full_name": "UNT Collaboration HUB",
        "timestamp": 1657730907
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span>  We did a primary installation on an AWS Debian 10 server and set up subsequent sub-domain realms off that primary installation. The realm that is broken is one of the sub-domain realms. There are five others that are working fine.</p>",
        "id": 1403915,
        "sender_full_name": "UNT Collaboration HUB",
        "timestamp": 1657734979
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"24421\">@UNT Collaboration HUB</span> ok. Well, that exception suggests you have a user who is <code>long_term_idle</code> and is subscribed to a stream but doesn't have any <code>RealmAuditLog</code> entries (which are creating when subscribing to a stream).</p>",
        "id": 1404037,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657744531
    },
    {
        "content": "<p>Is it possible that your team has done manual adjustments to the database via SQL? That could potentially explain this anomaly.</p>",
        "id": 1404038,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657744554
    },
    {
        "content": "<p>Another possibility is that you upgraded the OS for the Postgres host system without using the right process, and have corrupted database indexes as a result. If that's the case, we can provide a link for how to fix it.</p>",
        "id": 1404039,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657744602
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> We were doing some testing for this realm with mail forwarding options and other interactions with streams via email, but I believe this only involved adjustments to the PHP config file. Iâ€™m not certain, but I believe this process included adding users on a testing basis that may not have interacted with any steams on a subscription basis. If we have a RealmAuditLog issue due to a long_term_idle, how would we verify and repair?</p>",
        "id": 1404343,
        "sender_full_name": "UNT Collaboration HUB",
        "timestamp": 1657755265
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"24421\">@UNT Collaboration HUB</span> well, the code that is failing is expects that a user who is subscribed to a stream has an audit log entry for having been subscribed, which is an invariant that should always be true if the Zulip database has not been tampered with.</p>",
        "id": 1404454,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657758821
    },
    {
        "content": "<p>(The <code>long_term_idle</code> code path assumes this invariant has not been violated)</p>",
        "id": 1404455,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657758845
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> Thanks for this information. This is a beta version release for us and so we do not have a large database of information we are looking to preserve. With this in mind, should we try resetting the database or reinstalling the sub-domain realm altogether? If so, would we do this by simply following the subdomain realm installation procedure again?</p>",
        "id": 1404490,
        "sender_full_name": "UNT Collaboration HUB",
        "timestamp": 1657759710
    },
    {
        "content": "<p>Would that procedure be sufficient or do we need to somehow wipe the sub realm installation first?</p>",
        "id": 1404494,
        "sender_full_name": "UNT Collaboration HUB",
        "timestamp": 1657759848
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"24421\">@UNT Collaboration HUB</span> it's definitely possible to fix the database, but you'll need to get a support contract -- it'll require somewhat involved debugging by a Zulip developer to figure out the right way to correct this situation.</p>",
        "id": 1405003,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1657837530
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> We are starting with a fresh install on a new server. Thank you very much for your help!</p>",
        "id": 1407041,
        "sender_full_name": "UNT Collaboration HUB",
        "timestamp": 1658261304
    }
]