[
    {
        "content": "<p>I'm suddenly getting this error during <code>upgrade-zulip-from-git </code>:</p>\n<div class=\"codehilite\"><pre><span></span><code>Traceback (most recent call last):\n  File &quot;./manage.py&quot;, line 157, in &lt;module&gt;\n    execute_from_command_line(sys.argv)\n  File &quot;./manage.py&quot;, line 122, in execute_from_command_line\n    utility.execute()\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py&quot;, line 413, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 398, in execute\n    output = self.handle(*args, **options)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 187, in handle\n    collected = self.collect()\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 128, in collect\n    for original_path, processed_path, processed in processor:\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/storage.py&quot;, line 399, in post_process\n    yield from super().post_process(*args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/storage.py&quot;, line 231, in post_process\n    for name, hashed_name, processed, _ in self._post_process(paths, adjustable_paths, hashed_files):\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/storage.py&quot;, line 315, in _post_process\n    saved_name = self._save(hashed_name, original_file)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/core/files/storage.py&quot;, line 279, in _save\n    fd = os.open(full_path, self.OS_OPEN_FLAGS, 0o666)\nOSError: [Errno 36] File name too long: &#39;/home/zulip/prod-static/generated/emoji/images-twitter-64/NOTICE.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f.3b83ef96387f&#39;\n</code></pre></div>\n<p>no mention of this issue in the <a href=\"https://zulip.readthedocs.io/en/latest/subsystems/emoji.html\">docs</a> aka <a href=\"https://github.com/zulip/zulip/blob/main/docs/subsystems/emoji.md\">emoji.md</a> aka <a href=\"https://zulip.readthedocs.io/en/latest/subsystems/emoji.html\">server docs</a></p>\n<p>tracking it down, it appears to be originating from repeated filenames in </p>\n<div class=\"codehilite\"><pre><span></span><code>zulip@zulip-prod:~/deployments$ ls -l current/static/generated/emoji-styles/twitter-sprite.191324f5563c.*\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar 12 17:20 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.191324f5563c.css\n-rw-r--r-- 1 zulip zulip 111046 Mar  2 14:52 current/static/generated/emoji-styles/twitter-sprite.191324f5563c.css\n</code></pre></div>\n<p>Looking through the last dozen deploys, it looks like these filenames are \"building up\" over time?  I tried deleting <code>/srv/zulip-emoji-cache</code> but got a different error: </p>\n<div class=\"codehilite\"><pre><span></span><code>zulip@zulip-prod:~/deployments/current$ ./manage.py collectstatic --no-default-ignore --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates | grep -v Skip\nTraceback (most recent call last):\n  File &quot;./manage.py&quot;, line 157, in &lt;module&gt;\n    execute_from_command_line(sys.argv)\n  File &quot;./manage.py&quot;, line 122, in execute_from_command_line\n    utility.execute()\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py&quot;, line 413, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 354, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py&quot;, line 398, in execute\n    output = self.handle(*args, **options)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 187, in handle\n    collected = self.collect()\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 114, in collect\n    handler(path, prefixed_path, storage)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/management/commands/collectstatic.py&quot;, line 347, in copy_file\n    with source_storage.open(path) as source_file:\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/core/files/storage.py&quot;, line 38, in open\n    return self._open(name, mode)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/core/files/storage.py&quot;, line 243, in _open\n    return File(open(self.path(name), mode))\nFileNotFoundError: [Errno 2] No such file or directory: &#39;/home/zulip/deployments/2022-03-13-15-23-24/static/generated/emoji/images/emoji/black_large_square.png&#39;\n</code></pre></div>\n<p>(fyi I've had repeated trouble with the emoji pipeline... others having trouble?)</p>",
        "id": 1346111,
        "sender_full_name": "Adam Sah",
        "timestamp": 1647436432
    },
    {
        "content": "<p>fyi, production is running but this is blocking upgrade/deploy.</p>\n<p>if there's a command to completely re-initialize the emojis, I'd be grateful !!  I of course tried <code>tools/setup/emoji/build_emoji</code></p>\n<p>thx!</p>",
        "id": 1346112,
        "sender_full_name": "Adam Sah",
        "timestamp": 1647436565
    },
    {
        "content": "<p>also, I tried <code>--ignore-static-assets</code> but that failed with this error:</p>\n<div class=\"codehilite\"><pre><span></span><code>  File &quot;/usr/lib/python3.8/importlib/__init__.py&quot;, line 127, in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\n  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 1014, in _gcd_import\n  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 991, in _find_and_load\n  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 975, in _find_and_load_unlocked\n  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 671, in _load_unlocked\n  File &quot;&lt;frozen importlib._bootstrap_external&gt;&quot;, line 848, in exec_module\n  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 219, in _call_with_frames_removed\n  File &quot;/home/zulip/deployments/2022-03-16-13-26-44/zproject/urls.py&quot;, line 19, in &lt;module&gt;\n    from zerver.lib.integrations import WEBHOOK_INTEGRATIONS\n  File &quot;/home/zulip/deployments/2022-03-16-13-26-44/zerver/lib/integrations.py&quot;, line 316, in &lt;module&gt;\n    EmbeddedBotIntegration(&quot;helloworld&quot;, []),\n  File &quot;/home/zulip/deployments/2022-03-16-13-26-44/zerver/lib/integrations.py&quot;, line 310, in __init__\n    super().__init__(name, client_name, *args, **kwargs)\n  File &quot;/home/zulip/deployments/2022-03-16-13-26-44/zerver/lib/integrations.py&quot;, line 94, in __init__\n    self.logo_url = self.get_logo_url()\n  File &quot;/home/zulip/deployments/2022-03-16-13-26-44/zerver/lib/integrations.py&quot;, line 126, in get_logo_url\n    return staticfiles_storage.url(self.logo_path)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/storage.py&quot;, line 147, in url\n    return self._url(self.stored_name, name, force)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/storage.py&quot;, line 126, in _url\n    hashed_name = hashed_name_func(*args)\n  File &quot;/srv/zulip-venv-cache/f61d736b39d4363b842936dd27a15cc9ee6bb145/zulip-py3-venv/lib/python3.8/site-packages/django/contrib/staticfiles/storage.py&quot;, line 417, in stored_name\n    raise ValueError(&quot;Missing staticfiles manifest entry for &#39;%s&#39;&quot; % clean_name)\nValueError: Missing staticfiles manifest entry for &#39;images/integrations/logos/helloworld.svg&#39;\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2022-03-16-13-26-44/scripts/lib/upgrade-zulip-stage-2&quot;, line 304, in &lt;module&gt;\n    migrations_output = subprocess.check_output(\n  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 415, in check_output\n    return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,\n  File &quot;/usr/lib/python3.8/subprocess.py&quot;, line 516, in run\n    raise CalledProcessError(retcode, process.args,\nsubprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;showmigrations&#39;]&#39; returned non-zero exit status 1.\n</code></pre></div>",
        "id": 1346116,
        "sender_full_name": "Adam Sah",
        "timestamp": 1647437290
    },
    {
        "content": "<p>It's back up - I deleted everything in /srv and /home/zulip then manually created /srv/zulip-npm-cache and chown/chgrp it to zulip and re-ran <code>upgrade-zulip-from-git</code>.</p>\n<p>Since this isn't the first time I I've struggled with emoji and static assets, I'll try to document this process.</p>\n<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> this happened before and after I merged from main (bcbba0b) but since I've had these issues before, I'm guessing it's not related to the recent release.</p>",
        "id": 1346149,
        "sender_full_name": "Adam Sah",
        "timestamp": 1647445092
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"21154\">@Adam S</span> I think the root cause of your issue is very likely that you've been in the habit of running subscripts rather than just the upgrade tool. (And probably some version of that having happened in the past caused this issue).</p>",
        "id": 1346165,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1647447852
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> sorry for the confusion, I promise!! I've been running just upgrade-from-git and only tried sub-scripts when that failed. </p>\n<p>Anyway, humpty -dumpty is back together again and I'll take note if this happens again.</p>\n<p>Thx! For the quick reply.</p>",
        "id": 1346178,
        "sender_full_name": "Adam Sah",
        "timestamp": 1647449673
    },
    {
        "content": "<p>This is probably due to the <code>prod-static</code> → <code>static</code> symlink you made before. Don’t make a <code>prod-static</code> → <code>static</code> symlink.</p>",
        "id": 1346334,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1647457726
    },
    {
        "content": "<p>thx for that feedback <span class=\"user-mention\" data-user-id=\"699\">@Anders Kaseorg</span> - that symlink was a previous act of desperation, and I'm pretty sure it was removed before running into this issue (it's not longer there right now).</p>\n<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> I'm keeping an eye on these upgrade troubles, and as I learn more &amp; get my arms around them, I'll switch from \"whining\" to identifying opportunities and proposing solutions and PRs. :-)</p>\n<p>All - <strong><em>thank you</em></strong> for all the help, really appreciate it !!!</p>",
        "id": 1347731,
        "sender_full_name": "Adam Sah",
        "timestamp": 1647614234
    }
]