[
    {
        "content": "<p>I was having problems with pylibmc (<a href=\"https://github.com/zulip/zulip/issues/14805\">bug 14805</a>) and it was suggested that I test the PR switching to bmemcached (<a href=\"https://github.com/zulip/zulip/pull/14925\">PR 14925</a>).  So I ran <code>upgrade-zulip-from-git</code> with that PR and it got most of the way through before bombing out with ... more memcached-related problems (full error spew below).  Can anyone suggest further troubleshooting steps?</p>\n<div class=\"codehilite\"><pre><span></span><code>2020-06-13 12:51:28,591 upgrade-zulip-stage-2: Restarting Zulip...\n2020-06-13 12:51:31,108 restart-server: Filling memcached caches\n2020-06-13 12:51:33.391 INFO [] Successfully populated user cache!  Consumed 1 remote cache queries (0.02 time)\nTraceback (most recent call last):\n  File &quot;./manage.py&quot;, line 50, in &lt;module&gt;\n    execute_from_command_line(sys.argv)\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/__init__.py&quot;, line 381, in execute_from_command_line\n    utility.execute()\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/__init__.py&quot;, line 375, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/base.py&quot;, line 323, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/django/core/management/base.py&quot;, line 364, in execute\n    output = self.handle(*args, **options)\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zerver/management/commands/fill_memcached_caches.py&quot;, line 20, in handle\n    fill_remote_cache(cache)\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zerver/lib/cache_helpers.py&quot;, line 145, in fill_remote_cache\n    cache_set_many(items_for_remote_cache, timeout=3600*24*7)\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zerver/lib/cache.py&quot;, line 283, in cache_set_many\n    get_cache_backend(cache_name).set_many(items, timeout=timeout)\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/django/core/cache/backends/memcached.py&quot;, line 149, in set_many\n    failed_keys = self._cache.set_multi(safe_data, self.get_backend_timeout(timeout))\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/bmemcached/client/replicating.py&quot;, line 159, in set_multi\n    returns |= set(server.set_multi(mappings, time, compress_level=compress_level))\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/bmemcached/protocol.py&quot;, line 725, in set_multi\n    self._send(msg)\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/bmemcached/protocol.py&quot;, line 244, in _send\n    self._open_connection()\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/bmemcached/protocol.py&quot;, line 158, in _open_connection\n    self._send_authentication()\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/zulip-py3-venv/lib/python3.7/site-packages/bmemcached/protocol.py&quot;, line 319, in _send_authentication\n    raise MemcachedException(&#39;Code: %d Message: %s&#39; % (status, extra_content), status)\nbmemcached.exceptions.MemcachedException: (&quot;Code: 32 Message: b&#39;Auth failure.&#39;&quot;, 32)\nTraceback (most recent call last):\n  File &quot;./scripts/restart-server&quot;, line 36, in &lt;module&gt;\n    subprocess.check_call([&quot;./manage.py&quot;, &quot;fill_memcached_caches&quot;])\n  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;fill_memcached_caches&#39;]&#39; returned non-zero exit status 1.\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2020-06-13-12-43-42/scripts/lib/upgrade-zulip-stage-2&quot;, line 222, in &lt;module&gt;\n    subprocess.check_output([&quot;./scripts/restart-server&quot;, &quot;--fill-cache&quot;], preexec_fn=su_to_zulip)\n  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 395, in check_output\n    **kwargs).stdout\n  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 487, in run\n    output=stdout, stderr=stderr)\nsubprocess.CalledProcessError: Command &#39;[&#39;./scripts/restart-server&#39;, &#39;--fill-cache&#39;]&#39; returned non-zero exit status 1.\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip-from-git&quot;, line 69, in &lt;module&gt;\n    deploy_path, &quot;--from-git&quot;] + deploy_options)\n  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2020-06-13-12-43-42/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2020-06-13-12-43-42&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1.\n</code></pre></div>",
        "id": 903642,
        "sender_full_name": "Zack Weinberg",
        "timestamp": 1592053203
    },
    {
        "content": "<p>I figured out how to test the authentication configuration of memcached itself, and it seems to be fine:</p>\n<div class=\"codehilite\"><pre><span></span><code># sasldblistusers2 -f /etc/sasl2/memcached-sasldb2\nzulip@localhost: userPassword\n# memcstat --servers=127.0.0.1; echo $?\n1\n# memcstat --servers=127.0.0.1 --username=zulip@localhost --password=$(cat /etc/sasl2/memcached-zulip-password)\nServer: 127.0.0.1 (11211)\n     pid: 16533\n     uptime: 1938\n     time: 1592054605\n     version: 1.5.6\n     libevent: 2.1.8-stable\n         [etc]\n</code></pre></div>\n\n\n<p>So this must be something on the zulip side.</p>",
        "id": 903645,
        "sender_full_name": "Zack Weinberg",
        "timestamp": 1592054792
    },
    {
        "content": "<p>... and the new memcached client library works, too:</p>\n<div class=\"codehilite\"><pre><span></span><code># . /srv/zulip-venv-cache/de7ab305a0da8e7e5dd9ce66e935ed5e960351c1/zulip-py3-venv/bin/activate\n(zulip-py3-venv) # python3\nPython 3.7.3 (default, Dec 20 2019, 18:57:59)\n[GCC 8.3.0] on linux\nType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.\n&gt;&gt;&gt; with open(&quot;/etc/sasl2/memcached-zulip-password&quot;, &quot;rt&quot;) as fp:\n...    memcache_pass = fp.read()\n...\n&gt;&gt;&gt; memcache_user = &#39;zulip@localhost&#39;\n&gt;&gt;&gt; import bmemcached\n&gt;&gt;&gt; client = bmemcached.Client((&#39;127.0.0.1&#39;, ), memcache_user, memcache_pass)\n&gt;&gt;&gt; client.set(&#39;test_bmemcached&#39;, &#39;test&#39;)\nTrue\n&gt;&gt;&gt; client.get(&#39;test_bmemcached&#39;)\n&#39;test&#39;\n&gt;&gt;&gt; client.delete(&#39;test_bmemcached&#39;)\nTrue\n</code></pre></div>",
        "id": 903647,
        "sender_full_name": "Zack Weinberg",
        "timestamp": 1592055363
    },
    {
        "content": "<p>Aha! <code>manage.py</code> was trying to authenticate as user <code>zulip</code>, not user <code>zulip@localhost</code>.  I have no idea why, but I added an entry to the SASL password database for user <code>zulip</code> and now the upgrade has completed successfully.</p>",
        "id": 903651,
        "sender_full_name": "Zack Weinberg",
        "timestamp": 1592058097
    },
    {
        "content": "<p>The Python code is not responsible for adding the <code>@localhost</code>; thatâ€™s (expected to be) added within the memcached server and its SASL library.</p>",
        "id": 903860,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1592085299
    }
]