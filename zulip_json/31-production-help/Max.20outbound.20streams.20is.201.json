[
    {
        "content": "<p>Looking to see if this is a known traceback. It appears to because of a bot using the zulip API to register events. I'm wondering if there is some common issue with connecting bots to to follow streams like only doing one stream per bot or something. </p>\n<p>I have requested the source code from the user to see what's up with it.</p>\n<div class=\"codehilite\"><pre><span></span>Error generated by Anonymous user (not logged in) on zulip deployment\n\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/worker/queue_processors.py&quot;, line 141, in consume_wrapper\n    self.consume(data)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/worker/queue_processors.py&quot;, line 287, in consume\n    handle_push_notification(data[&#39;user_profile_id&#39;], data)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/decorator.py&quot;, line 643, in wrapped_func\n    ret = func(*args, **kwargs)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/lib/push_notifications.py&quot;, line 544, in handle_push_notification\n    apns_payload)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/decorator.py&quot;, line 643, in wrapped_func\n    ret = func(*args, **kwargs)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/lib/push_notifications.py&quot;, line 121, in send_apple_push_notification\n    result = attempt_send()\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zerver/lib/push_notifications.py&quot;, line 113, in attempt_send\n    expiration=expiration)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/apns2/client.py&quot;, line 78, in send_notification_async\n    stream_id = self._connection.request(&#39;POST&#39;, url, json_payload, headers)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/hyper/http20/connection.py&quot;, line 281, in request\n    self.endheaders(message_body=body, final=True, stream_id=stream_id)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/hyper/http20/connection.py&quot;, line 555, in endheaders\n    stream.send_headers(headers_only)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/hyper/http20/stream.py&quot;, line 98, in send_headers\n    conn.send_headers(self.stream_id, headers, end_stream)\n  File &quot;/home/zulip/deployments/2018-02-08-14-17-05/zulip-py3-venv/lib/python3.5/site-packages/h2/connection.py&quot;, line 836, in send_headers\n    (max_open_streams, self.open_outbound_streams)\nh2.exceptions.TooManyStreamsError: Max outbound streams is 1, 1 open\n\n\nRequest info:\n- path: None\n- None: None\n- REMOTE_ADDR: &quot;None&quot;\n- QUERY_STRING: &quot;None&quot;\n- SERVER_NAME: &quot;None&quot;\n</pre></div>",
        "id": 498119,
        "sender_full_name": "Scott Russell",
        "timestamp": 1518575229
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"scott@frak.ms\" data-user-id=\"5233\">@Scott Russell</span> I think this is the same APNS issue that you (I think) reported earlier.</p>",
        "id": 498445,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1518587723
    },
    {
        "content": "<p>Apple Push Notifications? I haven’t tried to config them. I’ll make sure they are disable in my config.</p>",
        "id": 499090,
        "sender_full_name": "Scott Russell",
        "timestamp": 1518612711
    },
    {
        "content": "<p>I'm experiencing the same issue on my new installation (it was setup yesterday), but I don't have any bots set up in my installation so far</p>",
        "id": 499200,
        "sender_full_name": "Patrik",
        "timestamp": 1518617509
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"scott@frak.ms\" data-user-id=\"5233\">@Scott Russell</span> Yeah, the issue is that when a notification was generated, if the server wasn't configured to send it via the <a href=\"https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html\" target=\"_blank\" title=\"https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html\">bouncer service</a>, it would attempt to send it through APNs directly. Which would fail if no credentials for that were configured.</p>\n<p>The correct logic is of course to attempt to send through APNs only if <em>that's</em> configured. And if the server has credentials configured for neither APNs nor the bouncer, then drop the notification on the floor (separate codepaths will independently handle email notifications, and browser/desktop notifications) and maybe log a warning. That fix only happened last week in master, as 7f6a1714a.</p>",
        "id": 499789,
        "sender_full_name": "Greg Price",
        "timestamp": 1518626532
    },
    {
        "content": "<p>For most users, the preferred workaround is to just <a href=\"https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html\" target=\"_blank\" title=\"https://zulip.readthedocs.io/en/latest/production/mobile-push-notifications.html\">set up the bouncer service</a> <span class=\"emoji emoji-1f601\" title=\"grin\">:grin:</span> -- then you get mobile push notifications, and you don't get this error. If you won't be doing that, this error is harmless; if you want to get it out of your log, you can upgrade to a recent master, or maybe cherry-pick that fix.</p>",
        "id": 499795,
        "sender_full_name": "Greg Price",
        "timestamp": 1518626692
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"patrikm87@gmail.com\" data-user-id=\"5344\">@Patrik</span> ^</p>",
        "id": 499796,
        "sender_full_name": "Greg Price",
        "timestamp": 1518626701
    },
    {
        "content": "<p>(Looks like the previous report was <a href=\"#narrow/stream/issues/subject/h2.20exception.20in.20APN.20send/near/491013\" title=\"#narrow/stream/issues/subject/h2.20exception.20in.20APN.20send/near/491013\">here</a>, not by Scott but by Maarten Rijke.)</p>",
        "id": 499798,
        "sender_full_name": "Greg Price",
        "timestamp": 1518626795
    },
    {
        "content": "<p>Thanks all. So I understand the issue now. I think part of the bug might be that with the services disabled in config users can still pick to use Moible notifications in the UI? Is part of the fix 7f6a1714a to disable mobile notifications in the UI if the APNS/bouncer are not configured?</p>",
        "id": 500000,
        "sender_full_name": "Scott Russell",
        "timestamp": 1518631268
    },
    {
        "content": "<p>I think that fix is just for the traceback and doesn't include such a concept, but you make a good point that we probably should do something there to hide the option from users or display a warning?  (We're not aware of many sites that don't use the push bouncer.).</p>",
        "id": 500019,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1518631459
    },
    {
        "content": "<p>I'm curious what Greg thinks.</p>",
        "id": 500021,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1518631464
    },
    {
        "content": "<p>Yeah, it'd be reasonable to have some UI to warn users in the case where the server admin has chosen not to set up notifications.</p>\n<p>I think actually the most important surface for that is probably in the mobile app itself -- we have <a href=\"https://github.com/zulip/zulip-mobile/pull/1507\" target=\"_blank\" title=\"https://github.com/zulip/zulip-mobile/pull/1507\">#M1507</a> for that, which I think will happen soon. If you don't have the mobile app, you won't expect mobile notifications anyway, and if you do install a mobile app for a chat service, then you probably are expecting push notifications unless you've seen a specific reason not to.</p>",
        "id": 500052,
        "sender_full_name": "Greg Price",
        "timestamp": 1518631957
    },
    {
        "content": "<p>But it'd also make sense to hide that UI in the settings screen, or maybe gray it out with a little info tooltip.</p>\n<p>Since <a href=\"https://github.com/zulip/zulip/commit/ecbc72b857aa9ead4ca2458a9ea2c9ab000dc57a\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/ecbc72b857aa9ead4ca2458a9ea2c9ab000dc57a\">ecbc72b85</a> there's a single function in the code which returns the boolean you'd want to control that UI, so this should be a simple change for someone to do.</p>",
        "id": 500057,
        "sender_full_name": "Greg Price",
        "timestamp": 1518632089
    },
    {
        "content": "<p>FYI. Requested bouncer setup. I'm curious if it will work for us since our instance is not accessible from the Internet without VPN.</p>",
        "id": 500120,
        "sender_full_name": "Scott Russell",
        "timestamp": 1518633360
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"greg@zulipchat.com\" data-user-id=\"2187\">@Greg Price</span> thanks for the info, I'll probably just live with the messages in the log until the fix is pushed out in a future release :-)</p>",
        "id": 500243,
        "sender_full_name": "Patrik",
        "timestamp": 1518638524
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"scott@frak.ms\" data-user-id=\"5233\">@Scott Russell</span> just FYI, the push bouncer will work fine as long as your server can do outgoing HTTPS to <a href=\"http://push.zulipchat.com\" target=\"_blank\" title=\"http://push.zulipchat.com\">push.zulipchat.com</a>.</p>",
        "id": 500336,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1518640277
    },
    {
        "content": "<p>For the settings: I think greying out the setting with a tooltip explaining is probably the right stategy.</p>",
        "id": 500418,
        "sender_full_name": "Rishi Gupta",
        "timestamp": 1518642029
    }
]