[
    {
        "content": "<p>This afternoon/evening, we're planning an upgrade of our fairly large (~2k users) Zulip installation from 1.3.12 to the latest (1.4.1)</p>",
        "id": 24853,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474048449
    },
    {
        "content": "<p>Ooh, fun :).  What time?</p>",
        "id": 24855,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474048489
    },
    {
        "content": "<p>That's flexible, if there are times that you would prefer. ;)</p>",
        "id": 24856,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474048526
    },
    {
        "content": "<p>But, roughly, \"after work EST\".</p>",
        "id": 24857,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474048538
    },
    {
        "content": "<p>OK.  I probably get busy around 6PM Pacific, so I guess I'd recommend going for \"shortly after work\"</p>",
        "id": 24858,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474048601
    },
    {
        "content": "<p>Sure thing.</p>",
        "id": 24859,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474048626
    },
    {
        "content": "<p>I'll make the announcement for 2PM PT?</p>",
        "id": 24860,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474048680
    },
    {
        "content": "<p>sure, that works for me</p>",
        "id": 24861,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474048834
    },
    {
        "content": "<p>Starting the upgrade now.</p>",
        "id": 25089,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059539
    },
    {
        "content": "<p>Cool!  </p>",
        "id": 25090,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474059589
    },
    {
        "content": "<p>Interesting.</p>",
        "id": 25091,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059672
    },
    {
        "content": "<p>The unpack-zulip command is erroring.</p>",
        "id": 25092,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059679
    },
    {
        "content": "<p>traceback?</p>",
        "id": 25093,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474059685
    },
    {
        "content": "<div class=\"codehilite\"><pre>2016-09-16 21:01:02,053 upgrade-zulip: Unpacking the tarball\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2016-05-13-04-17-09/scripts/lib/unpack-zulip&quot;, line 25, in &lt;module&gt;\n    subprocess.check_call([&quot;mv&quot;, glob.glob(os.path.join(extract_path, &quot;zulip-server-*&quot;))[0], deploy_path])\nIndexError: list index out of range\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 46, in &lt;module&gt;\n    preexec_fn=su_to_zulip)\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 573, in check_output\n    raise CalledProcessError(retcode, cmd, output=output)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2016-05-13-04-17-09/scripts/lib/unpack-zulip&#39;, &#39;/home/zulip/archives/zulip-1.4.1.tar.gz&#39;]&#39; returned non-zero exit status 1\n</pre></div>",
        "id": 25094,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059693
    },
    {
        "content": "<p>you're going directly to 1.4.1 right?</p>",
        "id": 25095,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474059695
    },
    {
        "content": "<p>Trying to, yes.</p>",
        "id": 25096,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059702
    },
    {
        "content": "<p>Hmm that's a new exception to me :)</p>",
        "id": 25098,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474059730
    },
    {
        "content": "<p>And to me.  Bizarre.</p>",
        "id": 25102,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059744
    },
    {
        "content": "<p>should be pretty debuggable whatever it is...</p>",
        "id": 25105,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474059773
    },
    {
        "content": "<p>I've confirmed the tarball extracts normally.</p>",
        "id": 25106,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059782
    },
    {
        "content": "<p>Aha.</p>",
        "id": 25116,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059965
    },
    {
        "content": "<p>The file needs to be named zulip-server-1.4.1.</p>",
        "id": 25117,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059979
    },
    {
        "content": "<p>The ones from github are just zulip-1.4.1</p>",
        "id": 25118,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474059985
    },
    {
        "content": "<p>oh, don't use the things GitHub generates</p>",
        "id": 25119,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474059996
    },
    {
        "content": "<p>You should always grab them from the <a href=\"http://zulip.org\" target=\"_blank\" title=\"http://zulip.org\">zulip.org</a> links</p>",
        "id": 25120,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474060009
    },
    {
        "content": "<p>Yup.</p>",
        "id": 25121,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474060011
    },
    {
        "content": "<p>Grabbing now.</p>",
        "id": 25122,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474060013
    },
    {
        "content": "<p>We need to figure out how to disable the github ones</p>",
        "id": 25123,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474060014
    },
    {
        "content": "<p>I'll investigate that</p>",
        "id": 25124,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474060022
    },
    {
        "content": "<p>Well it looks like we could upload our release tarballs to GitHub's release pages, but it requires using their API, not the webapp</p>",
        "id": 25125,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474060225
    },
    {
        "content": "<p>It's amazing how half-baked GitHub is for being the thing everyone uses :)</p>",
        "id": 25126,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474060242
    },
    {
        "content": "<p>Anyway, how's the upgrade going?</p>",
        "id": 25142,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474060667
    },
    {
        "content": "<p>So far, so good.  I always forget that this host doesn't have internet access, and then have to remember how I setup the necessary SSH incantations to jump backwards.</p>",
        "id": 25144,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474060847
    },
    {
        "content": "<p>But I've got that sorted now.</p>",
        "id": 25145,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474060857
    },
    {
        "content": "<p>In the package upgrade step.</p>",
        "id": 25146,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474060862
    },
    {
        "content": "<p>OK cool</p>",
        "id": 25147,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474060885
    },
    {
        "content": "<p>pip installing now.</p>",
        "id": 25148,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474060985
    },
    {
        "content": "<p>Well, I did get a set of errors.  Memcached.</p>",
        "id": 25155,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061245
    },
    {
        "content": "<p>traceback?</p>",
        "id": 25156,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061258
    },
    {
        "content": "<div class=\"codehilite\"><pre>Traceback (most recent call last):\n  File &quot;./manage.py&quot;, line 29, in &lt;module&gt;\n    execute_from_command_line(sys.argv)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 338, in execute_from_command_line\n    utility.execute()\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/management/__init__.py&quot;, line 330, in execute\n    self.fetch_command(subcommand).run_from_argv(self.argv)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 390, in run_from_argv\n    self.execute(*args, **cmd_options)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/management/base.py&quot;, line 441, in execute\n    output = self.handle(*args, **options)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zerver/management/commands/fill_memcached_caches.py&quot;, line 21, in handle\n    fill_remote_cache(cache)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zerver/lib/cache_helpers.py&quot;, line 95, in fill_remote_cache\n    cache_set_many(items_for_remote_cache, timeout=3600*24*7)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zerver/lib/cache.py&quot;, line 183, in cache_set_many\n    get_cache_backend(cache_name).set_many(items, timeout=timeout)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/cache/backends/memcached.py&quot;, line 154, in set_many\n    self._cache.set_multi(safe_data, self.get_backend_timeout(timeout))\n_pylibmc.ConnectionError: error 3 from memcached_set_multi: (24892464) CONNECTION FAILURE, host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:544\nTraceback (most recent call last):\n  File &quot;./scripts/restart-server&quot;, line 27, in &lt;module&gt;\n    subprocess.check_call([&quot;python&quot;, &quot;./manage.py&quot;, &quot;fill_memcached_caches&quot;])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;python&#39;, &#39;./manage.py&#39;, &#39;fill_memcached_caches&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/scripts/lib/upgrade-zulip-stage-2&quot;, line 84, in &lt;module&gt;\n    subprocess.check_output([&quot;./scripts/restart-server&quot;], preexec_fn=su_to_zulip)\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 573, in check_output\n    raise CalledProcessError(retcode, cmd, output=output)\nsubprocess.CalledProcessError: Command &#39;[&#39;./scripts/restart-server&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 53, in &lt;module&gt;\n    subprocess.check_call([os.path.abspath(&quot;./scripts/lib/upgrade-zulip-stage-2&quot;), deploy_path])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2016-09-16-21-19-55/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2016-09-16-21-19-55&#39;]&#39; returned non-zero exit status 1\n</pre></div>",
        "id": 25157,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061267
    },
    {
        "content": "<p>It looks like memcached didn't get started after the puppet refresh.</p>",
        "id": 25158,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061276
    },
    {
        "content": "<p>yep, that is what it looks like</p>",
        "id": 25162,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061353
    },
    {
        "content": "<p>Or didn't start quickly enough, if it did start</p>",
        "id": 25163,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061367
    },
    {
        "content": "<p>How should I resume where I was?</p>",
        "id": 25166,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061398
    },
    {
        "content": "<p>/home/zulip/deployments/next/scripts/restart-server</p>",
        "id": 25167,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061413
    },
    {
        "content": "<p>(that was on the last step that actually does the restart, basically)</p>",
        "id": 25168,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061421
    },
    {
        "content": "<p>Tons of \"warning Session data corrupted\" is spewing out.</p>",
        "id": 25169,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061442
    },
    {
        "content": "<p>But eventually it restarted.</p>",
        "id": 25170,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061474
    },
    {
        "content": "<p>what version were you on before?</p>",
        "id": 25171,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061501
    },
    {
        "content": "<p>1.3.12</p>",
        "id": 25172,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061515
    },
    {
        "content": "<div class=\"codehilite\"><pre>ServerDown: error 47 from memcached_set: (34454752) SERVER HAS FAILED AND IS DISABLED UNTIL TIMED RETRY, host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:612\n2016-09-16 17:32:20,070 ERROR    Internal Server Error: /json/users/me/pointer\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/handlers/base.py&quot;, line 108, in get_response\n    response = middleware_method(request)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/middleware/locale.py&quot;, line 32, in process_request\n    request, check_path=check_path)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/utils/translation/__init__.py&quot;, line 189, in get_language_from_request\n    return _trans.get_language_from_request(request, check_path)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/utils/translation/trans_real.py&quot;, line 496, in get_language_from_request\n    lang_code = request.session.get(LANGUAGE_SESSION_KEY)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/base.py&quot;, line 59, in get\n    return self._session.get(key, default)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/base.py&quot;, line 181, in _get_session\n    self._session_cache = self.load()\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/cached_db.py&quot;, line 48, in load\n    self.get_expiry_age(expiry=s.expire_date))\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/cache/backends/memcached.py&quot;, line 91, in set\n    if not self._cache.set(key, value, self.get_backend_timeout(timeout)):\nServerDown: error 47 from memcached_set: (34454752) SERVER HAS FAILED AND IS DISABLED UNTIL TIMED RETRY, host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:612\n2016-09-16 17:32:20,118 ERROR    Internal Server Error: /json/users/me/pointer\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/handlers/base.py&quot;, line 108, in get_response\n    response = middleware_method(request)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/middleware/locale.py&quot;, line 32, in process_request\n    request, check_path=check_path)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/utils/translation/__init__.py&quot;, line 189, in get_language_from_request\n    return _trans.get_language_from_request(request, check_path)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/utils/translation/trans_real.py&quot;, line 496, in get_language_from_request\n    lang_code = request.session.get(LANGUAGE_SESSION_KEY)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/base.py&quot;, line 59, in get\n    return self._session.get(key, default)\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/base.py&quot;, line 181, in _get_session\n    self._session_cache = self.load()\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/contrib/sessions/backends/cached_db.py&quot;, line 48, in load\n    self.get_expiry_age(expiry=s.expire_date))\n  File &quot;/home/zulip/deployments/2016-09-16-21-19-55/zulip-venv/lib/python2.7/site-packages/django/core/cache/backends/memcached.py&quot;, line 91, in set\n    if not self._cache.set(key, value, self.get_backend_timeout(timeout)):\nServerDown: error 47 from memcached_set: (34454752) SERVER HAS FAILED AND IS DISABLED UNTIL TIMED RETRY, host: 127.0.0.1:11211 -&gt; libmemcached/connect.cc:612\n</pre></div>",
        "id": 25173,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061545
    },
    {
        "content": "<p>I suspect this is solved by \"restart zulip\"</p>",
        "id": 25174,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061554
    },
    {
        "content": "<p>yes, though I think it's interesting that your memcached seems to be having availability problems</p>",
        "id": 25175,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061570
    },
    {
        "content": "<p>Again, spewing Warning session data corrupted.</p>",
        "id": 25176,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061586
    },
    {
        "content": "<p>Still getting the same memcached error.</p>",
        "id": 25177,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061647
    },
    {
        "content": "<p>I don't have a good explanation for your session data corrupted problem.  The easiest explanation would be if somehow you ended up changing your /etc/zulip/zulip-secrets.py to use a different secret key</p>",
        "id": 25178,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061650
    },
    {
        "content": "<p>Check the logs for memcached</p>",
        "id": 25179,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061659
    },
    {
        "content": "<p>Empty.  Checking config...</p>",
        "id": 25180,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061678
    },
    {
        "content": "<p>I've basically not seen this happen before, but it seems pretty clear that your memcached is messed up in some way</p>",
        "id": 25181,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061687
    },
    {
        "content": "<p>Bizarre.</p>",
        "id": 25185,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061949
    },
    {
        "content": "<p>Any luck?</p>",
        "id": 25187,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474061972
    },
    {
        "content": "<p>Not yet.</p>",
        "id": 25188,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474061984
    },
    {
        "content": "<p>We did change some bits of how we configure memcached recently, that may be worth adjusting</p>",
        "id": 25189,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062005
    },
    {
        "content": "<p>in <code>zproject/settings.py</code>, search for <code>django.core.cache.backends.memcached.PyLibMCCache</code></p>",
        "id": 25190,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062023
    },
    {
        "content": "<p>(in /home/zulip/deployments/current)</p>",
        "id": 25191,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062030
    },
    {
        "content": "<p>And try commenting out the <code>OPTIONS</code> section</p>",
        "id": 25192,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062039
    },
    {
        "content": "<p>Memcached is working for me.</p>",
        "id": 25193,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062045
    },
    {
        "content": "<div class=\"codehilite\"><pre>root@prod-infosec-zulip02:/var/mail# telnet localhost 11211\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is &#39;^]&#39;.\nadd mykey 0 60 11\nhello world\nSTORED\nget mykey\nVALUE mykey 0 11\nhello world\nEND```\n</pre></div>",
        "id": 25194,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062051
    },
    {
        "content": "<p>I can imagine that those settings are somehow problematic on your system</p>",
        "id": 25195,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062053
    },
    {
        "content": "<p>Same error.</p>",
        "id": 25196,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062127
    },
    {
        "content": "<p>(I assume you restarted the server in between?)</p>",
        "id": 25197,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062140
    },
    {
        "content": "<p>Yup.</p>",
        "id": 25198,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062145
    },
    {
        "content": "<p>Oh, can you disable your proxy configuration and then restart the server?</p>",
        "id": 25199,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062177
    },
    {
        "content": "<p>Did that already.</p>",
        "id": 25200,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062183
    },
    {
        "content": "<p>Oh, do you mean hard restart the whole box?</p>",
        "id": 25201,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062198
    },
    {
        "content": "<p>Oh, actually, disable your proxy configuration, and then restart supervisord</p>",
        "id": 25202,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062207
    },
    {
        "content": "<p>The problem is I bet that supervisord is caught running inside your http_proxy environment variables</p>",
        "id": 25203,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062218
    },
    {
        "content": "<p>Because you ran puppet with those options enabled</p>",
        "id": 25204,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062229
    },
    {
        "content": "<p>And so now everything it starts is inheriting that environment</p>",
        "id": 25205,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062239
    },
    {
        "content": "<p>Bingo.</p>",
        "id": 25206,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062262
    },
    {
        "content": "<p>sweet</p>",
        "id": 25207,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062278
    },
    {
        "content": "<p>I restarted everything under supervisord, but not supervisord itself.</p>",
        "id": 25208,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062279
    },
    {
        "content": "<p>I wonder what the best way to make that not happen is</p>",
        "id": 25209,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062343
    },
    {
        "content": "<p>maybe setting <code>http_proxy</code> and friends to blank inside our supervisord config would work</p>",
        "id": 25210,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062415
    },
    {
        "content": "<p>I'm also getting a cron error.</p>",
        "id": 25211,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062433
    },
    {
        "content": "<p>/bin/bash: /home/zulip/deployments/current/bin/write-rabbitmq-consumers-state-file: No such file or directory</p>",
        "id": 25212,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062438
    },
    {
        "content": "<p>What is the cron job that does that?  It might be something you added :)</p>",
        "id": 25213,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062476
    },
    {
        "content": "<p>rabbitmq-numconsumers?</p>",
        "id": 25214,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062485
    },
    {
        "content": "<div class=\"codehilite\"><pre>p$ cat puppet/zulip/files/cron.d/rabbitmq-numconsumers \nSHELL=/bin/bash\nPATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin\nUSER=root\n\n* * * * * root /home/zulip/deployments/current/scripts/nagios/check-rabbitmq-consumers\n</pre></div>",
        "id": 25215,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062504
    },
    {
        "content": "<p>... weird.  Let me try rerunning the puppet apply.</p>",
        "id": 25216,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062553
    },
    {
        "content": "<p>Nope.</p>",
        "id": 25217,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062555
    },
    {
        "content": "<p>So clearly that didn't update.  What do you have as <code>puppet_classes</code> in /etc/zulip/zulip.conf</p>",
        "id": 25218,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062556
    },
    {
        "content": "<p>puppet_classes = zulip::base, zulip::apt_repository, zulip::app_frontend, zulip::memcached, zulip::redis, zulip::localhost_camo, zulip::postfix_localmail, zulip::apache_sso</p>",
        "id": 25219,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062568
    },
    {
        "content": "<p>Yeah, add <code>zulip::rabbit</code></p>",
        "id": 25220,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062588
    },
    {
        "content": "<p>Since you exploded our list manually, I guess you got broken when we split that out from <code>zulip::app_frontend</code></p>",
        "id": 25221,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062606
    },
    {
        "content": "<p>Yeah... do you remember why we did that?</p>",
        "id": 25222,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062618
    },
    {
        "content": "<p>There was something we wanted to remove.</p>",
        "id": 25223,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062622
    },
    {
        "content": "<p>Oh.</p>",
        "id": 25224,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062642
    },
    {
        "content": "<p>Right.</p>",
        "id": 25225,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062643
    },
    {
        "content": "<p>It was the rabbit bit, actually.</p>",
        "id": 25226,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062648
    },
    {
        "content": "<p>which piece?</p>",
        "id": 25227,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062684
    },
    {
        "content": "<p>Specifically, what you put in /etc/default/rabbitmq-server.</p>",
        "id": 25228,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062694
    },
    {
        "content": "<p>OK well what I'd do</p>",
        "id": 25229,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062708
    },
    {
        "content": "<p>is run zulip-puppet-apply in dry-run mode, to see what you're missing</p>",
        "id": 25230,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062718
    },
    {
        "content": "<p>I did the run and then did it by hand.</p>",
        "id": 25231,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062719
    },
    {
        "content": "<p>Yep that's what I was going to suggest :)</p>",
        "id": 25232,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062728
    },
    {
        "content": "<p>Great minds, &amp;c.</p>",
        "id": 25233,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062764
    },
    {
        "content": "<p>We're back up.</p>",
        "id": 25234,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062769
    },
    {
        "content": "<p>yay!</p>",
        "id": 25235,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062774
    },
    {
        "content": "<p>And to give you a bit of context for how important Zulip is, after the downtime, this exchange happened:</p>",
        "id": 25236,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062802
    },
    {
        "content": "<blockquote>\n<p>Harlan Lieberman-Berg: Hello <span class=\"user-mention\" data-user-email=\"*\">@all</span>. We are planning on doing a Zulip upgrade today at 5PM Eastern, 9PM UTC. You may experience a short (&lt;5min) inaccessibility around that time.<br>\nPerson #1: Thank you, 5.<br>\nHarlan Lieberman-Berg: Starting the upgrade now.<br>\nHarlan Lieberman-Berg: That was a longer outage than we predicted; sorry everyone.<br>\nHarlan Lieberman-Berg: We should be back up now.<br>\nPerson #2: /me grips the edge of her desk in frantic nervousness... and slowly relaxes<br>\nPerson #2: Thanks!</p>\n</blockquote>",
        "id": 25237,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474062846
    },
    {
        "content": "<p><img alt=\":zulip:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/zulip.png\" title=\":zulip:\"> <br>\n<img alt=\":octopus:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/octopus.png\" title=\":octopus:\"> </p>",
        "id": 25238,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062885
    },
    {
        "content": "<p>So, now that you're on 1.4.x, it should be safe to do <code>apt</code> upgrades in general without risk of causing Zulip problems (well, unless you upgrade postgres, in which case you will need to restart the Zulip server after the upgrade for some services to reconnect)</p>",
        "id": 25239,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062972
    },
    {
        "content": "<p>Since we're no longer using any of the system Python packages</p>",
        "id": 25240,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474062979
    },
    {
        "content": "<p>Opened <a href=\"https://github.com/zulip/zulip/issues/1807\" target=\"_blank\" title=\"https://github.com/zulip/zulip/issues/1807\">https://github.com/zulip/zulip/issues/1807</a> for the http_proxy issue</p>",
        "id": 25241,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474063052
    },
    {
        "content": "<p><a href=\"/user_uploads/2/7f/DvVI3eGUabbZwyNLsiG5rt_D/IMG_20151123_161808223.jpg\" target=\"_blank\" title=\"IMG_20151123_161808223.jpg\">IMG_20151123_161808223.jpg</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/7f/DvVI3eGUabbZwyNLsiG5rt_D/IMG_20151123_161808223.jpg\" target=\"_blank\" title=\"IMG_20151123_161808223.jpg\"><img src=\"/user_uploads/2/7f/DvVI3eGUabbZwyNLsiG5rt_D/IMG_20151123_161808223.jpg\"></a></div>",
        "id": 25242,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474063078
    },
    {
        "content": "<p><img alt=\":heart:\" class=\"emoji\" src=\"/static/third/gemoji/images/emoji/heart.png\" title=\":heart:\"> </p>",
        "id": 25243,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474063092
    },
    {
        "content": "<p>Can you note <a href=\"https://github.com/zulip/zulip/pull/1807\" target=\"_blank\" title=\"https://github.com/zulip/zulip/pull/1807\">#1807</a> in your upgrade checklist as a reminder for next time?  </p>",
        "id": 25244,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474063122
    },
    {
        "content": "<p>Definitely.</p>",
        "id": 25245,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474063132
    },
    {
        "content": "<p>Thanks for your help, Tim.</p>",
        "id": 25246,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474063226
    },
    {
        "content": "<p>I think it's time for me to head home. :)</p>",
        "id": 25247,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474063230
    },
    {
        "content": "<p>Have a great weekend! :)</p>",
        "id": 25248,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1474063267
    },
    {
        "content": "<p>You as well!</p>",
        "id": 25249,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1474063290
    },
    {
        "content": "<p>Just a quick one guys, I tried upgrading with the tar.gz file from github and I got a bunch of errors similar to <a href=\"https://github.com/zulip/zulip/issues/208\" target=\"_blank\" title=\"https://github.com/zulip/zulip/issues/208\">issue 208</a>. However, once I got the upgrade file from <a href=\"https://www.zulip.org/dist/releases/\" target=\"_blank\" title=\"https://www.zulip.org/dist/releases/\">dist/releases</a> all seems well...</p>",
        "id": 142616,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1485939441
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133\">@Bruce Lewin</span> oh, the GitHub auto-generated tarballs are not correct.  I guess it's time to look into whether we can make GitHub not post them</p>",
        "id": 142891,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1485970409
    },
    {
        "content": "<p>(There are static assets that need to be built as part of generating a release tarball)</p>",
        "id": 142892,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1485970423
    },
    {
        "content": "<p>OK I've added our actual release tarballs to GitHub to block it's broken autogenerated release tarballs from impacting anyone else.  Thanks for the report <span class=\"user-mention\" data-user-id=\"133\">@Bruce Lewin</span>!</p>",
        "id": 142950,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1485971322
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> Thanks Tim... I was wondering why I was having trouble but it's not a surprise that github mangled the .tar.gz files!</p>",
        "id": 143336,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486004140
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"tabbott@zulipchat.com\" data-user-id=\"7\">@Tim Abbott</span> Thanks Tim, I just ran the upgrade from <a href=\"https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz\" target=\"_blank\" title=\"https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz\">https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz</a> without any hitches, well, apart from the usual </p>\n<blockquote>\n<p>sudo service supervisor stop<br>\nsudo dpkg -P rabbitmq-server<br>\nsudo apt-get install rabbitmq-server<br>\nsudo /root/zulip/scripts/setup/configure-rabbitmq<br>\nservice supervisor start</p>\n</blockquote>\n<p>Is there any where in the browser to tell what version you're running btw, or do I have to check it on the command line/in the docs etc?</p>",
        "id": 144069,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486107076
    },
    {
        "content": "<p>Hmmm, I've upgraded to 1.4.3 via github <a href=\"https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz\" target=\"_blank\" title=\"https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz\">https://github.com/zulip/zulip/releases/download/1.4.3/zulip-server-1.4.3.tar.gz</a><br>\nBut I don't see the emoji and preview icons in the compose box...<br>\nEverything else seems fine though...<br>\nDoes anyone have any thoughts?</p>",
        "id": 144080,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486117618
    },
    {
        "content": "<p>Emojis and preview icons will be part of the imminent 1.5 release.</p>",
        "id": 144158,
        "sender_full_name": "Steve Howell",
        "timestamp": 1486137308
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\" data-user-id=\"58\">@Steve Howell</span> do you think we should toss in a <code>/version</code> endpoint that just returns the value in version.py?</p>",
        "id": 144332,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486144357
    },
    {
        "content": "<p>Probably an API endpoint would be better.</p>",
        "id": 144360,
        "sender_full_name": "Sampriti Panda",
        "timestamp": 1486144829
    },
    {
        "content": "<p>Yeah, I think a version endpoint is a good idea.  I thought at one point we talked about putting the version in page_params as well or in in some kind of \"about\" link.  We could probably put the version in tiny print in the help pages.</p>",
        "id": 144372,
        "sender_full_name": "Steve Howell",
        "timestamp": 1486145670
    },
    {
        "content": "<p>Note that version values will include release versions and also versions like <code>1.5.0+git</code> for if they're forked off of a release</p>",
        "id": 144375,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486145972
    },
    {
        "content": "<p>Yeah, we'd want to be a bit careful about anything user-facing.</p>",
        "id": 144381,
        "sender_full_name": "Steve Howell",
        "timestamp": 1486146248
    },
    {
        "content": "<p>ok, so you guys think I'm on the right release for 1.4.3 and not seeing preview and emoji icons in the compose box is expected behaviour?</p>",
        "id": 144965,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486276200
    },
    {
        "content": "<p>Yeah those features are new in 1.5</p>",
        "id": 145099,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486317386
    },
    {
        "content": "<p>Ok, so I tried to upgrade to 1.5 and ran into an error as below...<br>\nI've attached the <a href=\"/user_uploads/2/d2/1kUs7ZJgGZ3ZcyLZ9TJeF3wx/upgrade.log\" target=\"_blank\" title=\"upgrade.log\">upgrade.log</a> <br>\nLines 1264 - 1273 seem to be the relevant ones I've pasted below...</p>\n<div class=\"codehilite\"><pre><span></span>2017-02-07 08:15:57,451 upgrade-zulip-stage-2: Installing static assets...\nCached version not found! Copying node modules.\n+ rm -rf /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315\n+ mkdir -p /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315\n+ cp package.json /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315\n+ cp -rT prod-static/serve/node_modules /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315/node_modules\ncp: cannot stat &#39;prod-static/serve/node_modules&#39;: No such file or directory\n\n\u001b[0;37;41mError running a subcommand of /home/zulip/deployments/2017-02-07-08-12-45/scripts/lib/upgrade-zulip-stage-2: cp -rT prod-static/serve/node_modules /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315/node_modules\u001b[0m\n\u001b[0;37;41mActual error output for the subcommand is just above this.\u001b[0m\n</pre></div>",
        "id": 146047,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486453308
    },
    {
        "content": "<p>I have a similar problem. Tried upgrading both from <code>zulip</code> and <code>root</code> users, still no luck. Here's my output:</p>\n<div class=\"codehilite\"><pre><span></span>2017-02-07 12:15:38,188 upgrade-zulip-stage-2: Building static assets...\nCached version not found! Installing node modules.\n+ rm -rf /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315\n\nError running a subcommand of ./tools/update-prod-static: rm -rf /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315\nActual error output for the subcommand is just above this.\n\nTraceback (most recent call last):\n  File &quot;./tools/update-prod-static&quot;, line 34, in &lt;module&gt;\n    setup_node_modules(npm_args=[&#39;--production&#39;], stdout=fp, stderr=fp)\n  File &quot;./tools/../scripts/lib/node_cache.py&quot;, line 38, in setup_node_modules\n    copy_modules=copy_modules)\n  File &quot;./tools/../scripts/lib/node_cache.py&quot;, line 66, in do_npm_install\n    run(cmd, stdout=stdout, stderr=stderr)\n  File &quot;./tools/../scripts/lib/zulip_tools.py&quot;, line 98, in run\n    subprocess.check_call(args, **kwargs)\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;rm&#39;, &#39;-rf&#39;, &#39;/srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2017-02-07-12-15-26/scripts/lib/upgrade-zulip-stage-2&quot;, line 75, in &lt;module&gt;\n    preexec_fn=su_to_zulip)\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;./tools/update-prod-static&#39;, &#39;--authors-not-required&#39;, &#39;--prev-deploy&#39;, &#39;/home/zulip/deployments/current&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;./scripts/upgrade-zulip-from-git&quot;, line 81, in &lt;module&gt;\n    deploy_path, &quot;--from-git&quot;] + deploy_options)\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;sudo&#39;, &#39;/home/zulip/deployments/2017-02-07-12-15-26/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2017-02-07-12-15-26&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1\n</pre></div>",
        "id": 146056,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486459207
    },
    {
        "content": "<p>Could it be related to the fact I'm trying to upgrade a packaged-based installation via a <code>upgrade-zulip-from-git</code>? So I have a <code>tar.gz</code> package installed and now I would like to switch to git-based upgrades. Maybe a new version can't fetch the previous deployment's static files and is failing as a result? Anyway, the error message is completely cryptic.</p>",
        "id": 146059,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486460905
    },
    {
        "content": "<p>hmmm... for what it's worth, I'm on package based and I think our errors are pretty similar...</p>",
        "id": 146060,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486460963
    },
    {
        "content": "<p>Looking at the <code>update-prod-static.log</code>, I see a user really doesn't have the permissions (how come?), so I'll try granting <code>zulip</code> all the access that exists on the Earth.</p>",
        "id": 146061,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486461044
    },
    {
        "content": "<p>ok, let me know if that helps... I sudo'ed from 1.4.1 to 1.4.2 and 1.4.3 without any problems...</p>",
        "id": 146062,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486461085
    },
    {
        "content": "<p>sure, will do</p>",
        "id": 146063,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486461098
    },
    {
        "content": "<p>did you run the upgrade from <code>root</code> btw?</p>",
        "id": 146064,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486461149
    },
    {
        "content": "<p>no, the zulip user using sudo</p>",
        "id": 146065,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486461167
    },
    {
        "content": "<p>okay, thanks</p>",
        "id": 146066,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486461178
    },
    {
        "content": "<p>looks like the <code>zulip</code> user hasn't had permissions on the base <code>/srv</code> directory. Chowned the dir to him, the process advanced a bit further. Building modules now...</p>",
        "id": 146067,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486461546
    },
    {
        "content": "<p>alright, it went all the way down to restarting Postgres and died, bringing down the Zulip itself. Still not giving up hope ... )</p>",
        "id": 146068,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486461798
    },
    {
        "content": "<p>running the upgrade script one more time did the trick, we're now running 1.5!</p>",
        "id": 146069,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486462060
    },
    {
        "content": "<p>nice....<br>\nis this the chown command you ran?</p>\n<div class=\"codehilite\"><pre><span></span>sudo chown zulip:zulip /srv/\n</pre></div>\n\n\n<p>looking at the error message I got, do you think chowning /srv/ would work on my installation?</p>\n<div class=\"codehilite\"><pre><span></span>+ cp -rT prod-static/serve/node_modules /srv/zulip-npm-cache/df2a70fb3159f4b09d262be71ccf650c9cd42315/node_modules\ncp: cannot stat &#39;prod-static/serve/node_modules&#39;: No such file or directory\n</pre></div>",
        "id": 146070,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486462239
    },
    {
        "content": "<p>yes, with the exception I didn't change the group, just <code>chown zulip /srv</code></p>",
        "id": 146071,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486462313
    },
    {
        "content": "<p>ok, let me try that...</p>",
        "id": 146072,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486462379
    },
    {
        "content": "<p>Can't say for sure, but I remember getting strange <code>stat</code> errors on a nested file because on of the parent folders didn't have <code>x</code> permissions for the user.</p>",
        "id": 146073,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486462388
    },
    {
        "content": "<p>Though it might be a completely different case</p>",
        "id": 146074,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486462421
    },
    {
        "content": "<p>bugger, same error!</p>",
        "id": 146076,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486462998
    },
    {
        "content": "<p>does your <code>/home/zulip/deployments/&lt;your&gt;/var/log</code> folder contain any cues?</p>",
        "id": 146077,
        "sender_full_name": "Alex Morozov",
        "timestamp": 1486463063
    },
    {
        "content": "<p>I'm not sure, I've destroyed the instance :-( I'm going to restore from backup and will probably wait to see if anyone else has any suggestions...</p>",
        "id": 146081,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486464113
    },
    {
        "content": "<p>looking at this now</p>",
        "id": 146153,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486488936
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-email=\"tabbott@zulipchat.com\" data-user-id=\"7\">@Tim Abbott</span> </p>",
        "id": 146154,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486488955
    },
    {
        "content": "<p>I think I know what's up; will post a release candidate tarball shortly.</p>",
        "id": 146156,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486489155
    },
    {
        "content": "<p>Great, I'll probably give that a go tomorrow morning....</p>",
        "id": 146157,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486489224
    },
    {
        "content": "<p>We stopped shipping <code>node_modules</code> in the tarballs because they made them 2x as big and weren't actually used (since the static assets had already been built from <code>node_modules</code>).  But we failed to remove the upgrade path to copy the no-longer-existent node_modules directory into place.</p>",
        "id": 146158,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486489286
    },
    {
        "content": "<p>ahhhh, ok...</p>",
        "id": 146160,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486489339
    },
    {
        "content": "<p>BTW there should be no downtime attached to a failed upgrade here; it'll just not have changed anything</p>",
        "id": 146163,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486489463
    },
    {
        "content": "<p>I have a release candidate ready for testing</p>",
        "id": 146164,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486489487
    },
    {
        "content": "<p>ok... I wasn't sure... either way I had a volume snapshot to go back to...</p>",
        "id": 146165,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486489494
    },
    {
        "content": "<p>great, I'll test it out tomorrow....</p>",
        "id": 146166,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486489509
    },
    {
        "content": "<p>I'm going to make a fresh instance so I can test and post it now </p>",
        "id": 146167,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486489516
    },
    {
        "content": "<p>OK test complete, I'll be posting Zulip 1.5.1 with this fixed soon.  Thanks for the reports <span class=\"user-mention\" data-user-email=\"bruce.lewin@brandreflections.com\" data-user-id=\"133\">@Bruce Lewin</span> and <span class=\"user-mention\" data-user-email=\"am@kupo.la\" data-user-id=\"299\">@Alex Morozov</span>!</p>",
        "id": 146207,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486492555
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"tabbott@zulipchat.com\" data-user-id=\"7\">@Tim Abbott</span> No worries!</p>",
        "id": 146208,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486492588
    },
    {
        "content": "<p>OK, 1.5.1 is released fixing that issue.  Thanks again for the report!</p>",
        "id": 146258,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486496404
    },
    {
        "content": "<p>I had the same issue with 1.5.0. Works fine with 1.5.1.</p>",
        "id": 146260,
        "sender_full_name": "Thomas Butter",
        "timestamp": 1486496556
    },
    {
        "content": "<p>Thanks for confirming the problem is fixed for you :)</p>",
        "id": 146261,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486496812
    },
    {
        "content": "<p>I'm updating to 1.5.1 from 1.4.3 but the following error is occurred:</p>\n<div class=\"codehilite\"><pre><span></span>/var/log/zulip/django.log \n----\nUnknown command: &#39;runfcgi&#39;\nType &#39;manage.py help&#39; for usage.\n</pre></div>",
        "id": 146640,
        "sender_full_name": "kou",
        "timestamp": 1486518685
    },
    {
        "content": "<p>Restart supervisord?  That sounds like it's trying to use the 1.4.3 supervisord config</p>",
        "id": 146641,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486518708
    },
    {
        "content": "<p>How to restart supervisord? <code>sudo -H supervisorctl reload</code> is OK?</p>",
        "id": 146642,
        "sender_full_name": "kou",
        "timestamp": 1486518799
    },
    {
        "content": "<p>supervisord configuration may not be upgraded successfully?</p>\n<div class=\"codehilite\"><pre><span></span>% head -20 /etc/supervisor/conf.d/zulip.conf\n; Supervisor config file.\n; on Debian squeeze, place me in /etc/supervisor/conf.d/zulip.conf\n;\n; For more information on the config file, please see:\n; http://supervisord.org/configuration.html\n;\n; Note: shell expansion (&quot;~&quot; or &quot;$HOME&quot;) is not supported.  Environment\n; variables can be expanded using this syntax: &quot;%(ENV_HOME)s&quot;.\n\n[fcgi-program:zulip-django]\ncommand=python /home/zulip/deployments/current/manage.py runfcgi daemonize=False maxchildren=20 ; the program (relative uses PATH, can take args)\n;process_name=%(program_name)s ; process_name expr (default %(program_name)s)\n;numprocs=1                    ; number of processes copies to start (def 1)\n;directory=/tmp                ; directory to cwd to before exec (def no cwd)\n;umask=022                     ; umask for process (default None)\npriority=100                   ; the relative start priority (default 999)\nautostart=true                 ; start at supervisord start (default: true)\nautorestart=true               ; whether/when to restart (default: unexpected)\n;startsecs=1                   ; number of secs prog must stay running (def. 1)\n;startretries=3                ; max # of serial start failures (default 3)\n</pre></div>",
        "id": 146643,
        "sender_full_name": "kou",
        "timestamp": 1486518856
    },
    {
        "content": "<p>did the upgrade actually finish?  </p>",
        "id": 146647,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486519020
    },
    {
        "content": "<p>Oh, you mentioned that /root/zulip didn't exist or something</p>",
        "id": 146648,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486519028
    },
    {
        "content": "<p>Run <code>/root/zulip/scripts/zulip-puppet-apply</code> after making sure <code>/root/zulip</code> is a symlink to /home/zulip/deployments/next</p>",
        "id": 146649,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486519055
    },
    {
        "content": "<p>The upgrade script finished successfully.</p>",
        "id": 146650,
        "sender_full_name": "kou",
        "timestamp": 1486519078
    },
    {
        "content": "<p>I'll try it.</p>",
        "id": 146651,
        "sender_full_name": "kou",
        "timestamp": 1486519150
    },
    {
        "content": "<p>I think if /root/zulip was not configured correctly, upgrading wouldn't have installed the configuration for the new release</p>",
        "id": 146652,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486519153
    },
    {
        "content": "<p><code>/etc/supervisor/conf.d/zulip.conf</code> is upgraded to use WSGI. And our Zulip runs again. Thanks!</p>",
        "id": 146653,
        "sender_full_name": "kou",
        "timestamp": 1486519299
    },
    {
        "content": "<p>yay!</p>",
        "id": 146655,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486519343
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"tabbott@zulipchat.com\" data-user-id=\"7\">@Tim Abbott</span> Morning Tim, 1.5.1 did the trick, thank you!</p>",
        "id": 146800,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1486545156
    },
    {
        "content": "<p>Great, thanks for reporting back! :)</p>",
        "id": 146869,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486573264
    },
    {
        "content": "<p>Is the 1.4.1 =&gt; 1.4.3 upgrade code-only, or are there database changes?</p>",
        "id": 147905,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1486676174
    },
    {
        "content": "<p>I'm always shit-scared of doing upgrades in our env.</p>",
        "id": 147906,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1486676188
    },
    {
        "content": "<p>I am 80% sure it's code only.</p>",
        "id": 147915,
        "sender_full_name": "Steve Howell",
        "timestamp": 1486676855
    },
    {
        "content": "<p>1.4.1 -&gt; 1.4.3 is very safe:</p>\n<div class=\"codehilite\"><pre><span></span>$ git diff 1.4.1..1.4.3 --stat\n docs/changelog.md                     | 16 ++++++++++++++++\n puppet/zulip/files/logrotate/zulip    |  2 +-\n requirements/common.txt               |  2 +-\n tools/travis/success-http-headers.txt |  1 -\n zerver/tests/test_subs.py             | 23 +++++++++++++++++++++++\n zerver/views/streams.py               |  2 +-\n 6 files changed, 42 insertions(+), 4 deletions(-)\n</pre></div>",
        "id": 147920,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486677163
    },
    {
        "content": "<p>OK.  I'll give it a shot tonight or tomorrow.</p>",
        "id": 147922,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1486677185
    },
    {
        "content": "<p>In general we've been very conservative about what we put in security update releases to make it easy to upgrade</p>",
        "id": 147924,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1486677188
    },
    {
        "content": "<p>We've managed to screw the pooch on minimal changes before.  Never doubt my competence at that. ;)</p>",
        "id": 147926,
        "sender_full_name": "Harlan Lieberman-Berg",
        "timestamp": 1486677229
    },
    {
        "content": "<p>o hai</p>",
        "id": 148520,
        "sender_full_name": "Alex Dehnert",
        "timestamp": 1486704826
    },
    {
        "content": "<p>Just successfully upgraded from 1.5 to 1.6 :-)<br>\nApart from the classic <code>sudo dpkg -P rabbitmq-server</code>, everything ran smoothly! Thanks guys :-)</p>",
        "id": 221004,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1496896316
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"bruce.lewin@brandreflections.com\" data-user-id=\"133\">@Bruce Lewin</span> it's interesting that you still are having rabbitmq-server issues.  Do you have a:</p>\n<div class=\"codehilite\"><pre><span></span>[rabbitmq]\nnodename = zulip@localhost\n</pre></div>\n\n\n<p>entry in your <code>/etc/zulip/zulip.conf</code>?  That change (which requires a force-reinstall of rabbitmq to switch to) was something that we did and seems to have eliminated rabbitmq trouble for new installations.</p>",
        "id": 221007,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496896435
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"tabbott@zulipchat.com\" data-user-id=\"7\">@Tim Abbott</span> Hi Tim, no, I only have these 3 lines...</p>\n<div class=\"codehilite\"><pre><span></span>[machine]\npuppet_classes = zulip::voyager\ndeploy_type = voyager\n</pre></div>\n\n\n<p>Is it worth adding them in?</p>",
        "id": 221023,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1496897495
    },
    {
        "content": "<p>So if you add them in, and do a <code>/home/zulip/deployments/current/scripts/zulip-puppet-apply</code> (and probably reinstall rabbitmq-server), rabbitmq should be more stable afterwards (its main problem is it really doesn't like hostnames changing).</p>",
        "id": 221025,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496897604
    },
    {
        "content": "<p>Ok, I updated zulip.conf and ran <code>zulip-puppet-apply</code> and everything seems fine... no need to re-install rabbitmq-server yet... do you recommend I do that in any case?</p>",
        "id": 221032,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1496898167
    },
    {
        "content": "<p>I bet it'll crash if you restart it</p>",
        "id": 221037,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496898815
    },
    {
        "content": "<p>So, I guess if/when that happen, do that</p>",
        "id": 221038,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496898822
    },
    {
        "content": "<p>Basically, the puppet command should have installed a config file telling rabbitmq to use a particular nodename, but it has no effect until rabbitmq is restarted</p>",
        "id": 221039,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496898878
    },
    {
        "content": "<p>Ok, I ran a <code>/home/zulip/deployments/current/scripts/restart-server</code> and all was well....<br>\nAnd then I did</p>\n<div class=\"codehilite\"><pre><span></span>sudo service supervisor stop\nservice supervisor start\n</pre></div>\n\n\n<p>Which also worked fine, as did another server restart....</p>",
        "id": 221040,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1496899067
    },
    {
        "content": "<p>did you <code>service restart rabbitmq-server</code> as part of this process?</p>",
        "id": 221041,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496899104
    },
    {
        "content": "<p>If so, you should be good</p>",
        "id": 221042,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496899107
    },
    {
        "content": "<p>Running <code>service restart rabbitmq-server</code> returns <code>restart: unrecognized service</code>?</p>",
        "id": 221044,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1496899156
    },
    {
        "content": "<p>Hrm, is there an <code>/etc/init.d/rabbitmq-server</code>?</p>",
        "id": 221047,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496899294
    },
    {
        "content": "<p>Yeah, that file is there...</p>",
        "id": 221049,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1496899331
    },
    {
        "content": "<p>well, you can just run it instead of using the fancy <code>service</code> command; it's just a thin wrapper.  <code>/etc/init.d/rabbitmq-server restart</code> e.g.</p>",
        "id": 221050,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496899370
    },
    {
        "content": "<p>ok, <code>/etc/init.d/rabbitmq-server restart</code> worked fine...</p>",
        "id": 221051,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1496899419
    },
    {
        "content": "<p>ok you should be all set then</p>",
        "id": 221052,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1496899452
    },
    {
        "content": "<p>Great, thanks!</p>",
        "id": 221054,
        "sender_full_name": "Bruce Lewin",
        "timestamp": 1496899470
    },
    {
        "content": "<p>Did you just upgrade the server to <a href=\"https://github.com/zulip/zulip/commit/8530ed0b5e8ee8f62bceb5202ecf3e69c7bcf210\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/8530ed0b5e8ee8f62bceb5202ecf3e69c7bcf210\">the latest master commit</a> <span class=\"user-mention\" data-user-email=\"tabbott@zulipchat.com\" data-user-id=\"7\">@Tim Abbott</span> ? I was looking to upgrade our server to something recent but wondering what recent commit would be a good one.</p>",
        "id": 450741,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1516139645
    },
    {
        "content": "<p>I just did master.  I would probably wait a day for people to test with this version before doing an upgrade to a more production system, since this upgrade included a lot of changes.</p>",
        "id": 450754,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1516139899
    },
    {
        "content": "<p>Cool, thanks!</p>",
        "id": 450828,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1516141320
    },
    {
        "content": "<p>Is the zulip user password documented? It asked me for it when I was testing <code>upgrade-from-git</code> on a duplicate instance of our server</p>",
        "id": 452470,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1516212853
    },
    {
        "content": "<p>I ran it from another sudo user instead, but I've never encountered that before and usually I just run the scripts sudo su'd as zulip</p>",
        "id": 452475,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1516212930
    },
    {
        "content": "<p>(I could have also just changed the zulip user's pw, but...)</p>",
        "id": 452479,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1516212958
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"shidarin@gmail.com\" data-user-id=\"3733\">@Sean Wallitsch</span> we don't set a password for it.</p>",
        "id": 452519,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1516213651
    },
    {
        "content": "<p>So, you can set one, but we generally just add SSH keys for the user (you can also su from root if you prefer that model, or give it a password)</p>",
        "id": 452520,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1516213675
    },
    {
        "content": "<p>The <code>upgrade-from-git</code> script is intended to be run as root.</p>",
        "id": 452521,
        "sender_full_name": "Greg Price",
        "timestamp": 1516213698
    },
    {
        "content": "<p>Our current permissions design is that we don't require the <code>zulip</code> use to be a sudoer.</p>",
        "id": 452522,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1516213700
    },
    {
        "content": "<p>Cool, thanks guys</p>",
        "id": 452529,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1516213796
    },
    {
        "content": "<p>What version are you currently on (pre-upgrade)?</p>",
        "id": 452530,
        "sender_full_name": "Greg Price",
        "timestamp": 1516213809
    },
    {
        "content": "<p>I was on 1.7. Once I ran the upgrade script as root, everything went smooth</p>",
        "id": 452532,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1516213829
    },
    {
        "content": "<p>Huh, interesting. 1.7 should already have the check in <code>upgrade-zulip-from-git</code> that should have given you a good error message up front if you ran it as non-root.</p>",
        "id": 452534,
        "sender_full_name": "Greg Price",
        "timestamp": 1516213873
    },
    {
        "content": "<p>If that was added in one of the last commits before the 1.7 release, we might have missed it. We were still on one of the 1.7 RCs. But if not, I didn't see one- just a request for the sudo pw</p>",
        "id": 452541,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1516214010
    },
    {
        "content": "<p>Ah, that's probably it -- looks like it was added just a few days before the release.</p>",
        "id": 452543,
        "sender_full_name": "Greg Price",
        "timestamp": 1516214072
    },
    {
        "content": "<p>Sorry for the trouble then :) We moved off Zulip for a few months and are getting back into the swing of it.</p>",
        "id": 452545,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1516214123
    },
    {
        "content": "<p>Cool, mystery solved, and I won't worry about future installs running into the same thing. :)</p>",
        "id": 452546,
        "sender_full_name": "Greg Price",
        "timestamp": 1516214128
    },
    {
        "content": "<p>No problem! Thanks for the report.</p>",
        "id": 452547,
        "sender_full_name": "Greg Price",
        "timestamp": 1516214139
    },
    {
        "content": "<p>going from 2.0.6 to 2.1.4 i noticed a bug? or just unexpected behavior when operating on a machine that was in psql recovery mode (part of a primary/secondary psql setup)</p>\n<div class=\"codehilite\"><pre><span></span><code>2020-05-29 19:09:31,588 upgrade-zulip: Archiving the tarball under /home/zulip/archives\n2020-05-29 19:09:31,868 upgrade-zulip: Unpacking the tarball\nERROR:  cannot execute DROP EXTENSION in a read-only transaction\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2020-05-29-19-09-31/scripts/lib/upgrade-zulip-stage-2&quot;, line 68, in &lt;module&gt;\n    &#39;psql -v ON_ERROR_STOP=1 zulip -c &quot;DROP EXTENSION IF EXISTS tsearch_extras;&quot;&#39;])\n  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 311, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;su&#39;, &#39;postgres&#39;, &#39;-c&#39;, &#39;psql -v ON_ERROR_STOP=1 zulip -c &quot;DROP EXTENSION IF EXISTS tsearch_extras;&quot;&#39;]&#39; returned non-zero exit status 1.\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip&quot;, line 58, in &lt;module&gt;\n    + deploy_options)\n  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 311, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2020-05-29-19-09-31/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2020-05-29-19-09-31&#39;, &#39;--skip-migrations&#39;]&#39; returned non-zero exit status 1.\n</code></pre></div>",
        "id": 890629,
        "sender_full_name": "Tim April",
        "timestamp": 1590779473
    },
    {
        "content": "<p>it looks like its trying to check for the full text search extension, but the psql server is in recovery so it is unable to run that command</p>",
        "id": 890630,
        "sender_full_name": "Tim April",
        "timestamp": 1590779502
    },
    {
        "content": "<p>my work around will be to upgrade the primary fully and then to promote the secondary, do the upgrade and then recover it, but i figured i'd mention it here</p>",
        "id": 890631,
        "sender_full_name": "Tim April",
        "timestamp": 1590779527
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"73\">@Tim April</span> I think it would have also worked to just skip that step of the upgrade tool on the secondary.</p>",
        "id": 890746,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1590786534
    },
    {
        "content": "<p>Thanks for the report; I'm not sure there's a code change we'll make in relation to this but it's good to know about.</p>",
        "id": 890747,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1590786559
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> Hi man, I have a zulip server running on-prem, pretty old one (v1.8 IIRC).<br>\nIt's running with <code>docker-compose</code>.</p>\n<p>I would very much like to migrate to a newer version, but am unsure of what's the correct procedures for migrations when running with <code>docker-compose</code>.</p>\n<p>I'm not a python developer and don't have much experience with Django, so I'm unsure of how it will handle the migrations.</p>\n<p>What's the best migration plan? Do I have to migrate one version at a time, or just move on to the latest version?</p>\n<p>And, considering I'm on <code>docker-compose</code>, is there a migration guide for that?</p>",
        "id": 912935,
        "sender_full_name": "Giora Guttsait",
        "timestamp": 1593022346
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"8449\">@Giora Guttsait</span> see <a href=\"https://github.com/zulip/docker-zulip#upgrading-the-zulip-container\">https://github.com/zulip/docker-zulip#upgrading-the-zulip-container</a></p>",
        "id": 912970,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1593023099
    },
    {
        "content": "<p>So it runs <code>migrate</code> on its own? Wow, that's some kick ass UX man, couldn't be easier than that. I'll definitely try a migration <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span>🏻 Thanks a bunch for the quick reply!</p>",
        "id": 912983,
        "sender_full_name": "Giora Guttsait",
        "timestamp": 1593023432
    },
    {
        "content": "<p>Do you suppose only the updated <code>zulip</code> image is needed, or should I bring along all the other images as well? Like the postgresql and stuff...</p>",
        "id": 912989,
        "sender_full_name": "Giora Guttsait",
        "timestamp": 1593023570
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> looking at <a href=\"https://github.com/zulip/docker-zulip#upgrading-from-the-old-galexrtdocker-zulip\">this</a> it looks like I would at least have to do a database migration, right?</p>",
        "id": 913013,
        "sender_full_name": "Giora Guttsait",
        "timestamp": 1593024092
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"8449\">@Giora Guttsait</span> it depends what version you're upgrading from.</p>",
        "id": 913016,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1593024178
    },
    {
        "content": "<p>But if it's 1.8, yeah, I'd expect you to need to follow those extra instructions.</p>",
        "id": 913017,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1593024196
    },
    {
        "content": "<p>hi. trying to upgrade <br>\n/home/zulip/deployments/current/scripts/upgrade-zulip-from-git 2.1.x<br>\nto go from debian Stretch to Debian Buster<br>\nbut getting an error: look@ <a href=\"https://github.com/zulip/zulip/issues/15919\">https://github.com/zulip/zulip/issues/15919</a></p>\n<p>can anyone help me with this? thx</p>",
        "id": 953724,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1595623371
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"8768\">@Fabian Tribrunner</span> I haven't seen that error before.</p>",
        "id": 953839,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1595629123
    },
    {
        "content": "<p>Can you post <code>/var/log/zulip/upgrade.log</code>?  I suspect the actual problem is earlier than what you've posted there.</p>",
        "id": 953840,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1595629146
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"7\">Tim Abbott</span> <a href=\"#narrow/stream/31-production-help/topic/upgrade/near/953840\">said</a>:</p>\n<blockquote>\n<p>Can you post <code>/var/log/zulip/upgrade.log</code>?  I suspect the actual problem is earlier than what you've posted there.</p>\n</blockquote>\n<p><a href=\"/user_uploads/2/83/_CDzR1z-Um3lCbTmTdHFKSW6/upgrade.log\">upgrade.log</a></p>",
        "id": 953846,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1595629411
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"8768\">@Fabian Tribrunner</span> OK my guess is that you were previously running a commit from master; is that possible?</p>",
        "id": 953848,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1595629538
    },
    {
        "content": "<p>(And that commit has many migrations newer than what is present in the latest <code>2.1.x</code>)</p>",
        "id": 953849,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1595629555
    },
    {
        "content": "<p>If so, you can likely just skip step 1 in <a href=\"https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-debian-stretch-to-debian-buster\">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-from-debian-stretch-to-debian-buster</a> and proceed.</p>",
        "id": 953850,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1595629594
    },
    {
        "content": "<p>yes. i have been on master all the time</p>",
        "id": 953851,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1595629597
    },
    {
        "content": "<p>2020-07-24 20:28:07,693 upgrade-zulip-from-git: Fetching the latest commits<br>\n2020-07-24 20:28:35,081 upgrade-zulip-stage-2: Unsupported platform: debian 9<br>\n2020-07-24 20:28:35,081 upgrade-zulip-stage-2: Sorry! The support for your OS has been discontinued.<br>\nPlease upgrade your OS to a supported release first.<br>\nSee <a href=\"https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-the-operating-system\">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-the-operating-system</a><br>\nTraceback (most recent call last):</p>",
        "id": 953853,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1595629600
    },
    {
        "content": "<p>And then upgrade to 3.0 once you've done the database upgrade documented there.</p>",
        "id": 953854,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1595629614
    },
    {
        "content": "<p>ok. i will try.</p>",
        "id": 953855,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1595629636
    },
    {
        "content": "<p>thx</p>",
        "id": 953856,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1595629652
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span>  i was trying to upgrade from 2.1.x to the git master...this error comes up</p>\n<p><a href=\"/user_uploads/2/9e/DK4hgftBkXwH-hw5oX_itFDN/image.png\">image.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/9e/DK4hgftBkXwH-hw5oX_itFDN/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/9e/DK4hgftBkXwH-hw5oX_itFDN/image.png\"></a></div><p>any suggestions? thx</p>",
        "id": 988399,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1597416744
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"7\">Tim Abbott</span> <a href=\"#narrow/stream/31-production-help/topic/upgrade/near/953854\">said</a>:</p>\n<blockquote>\n<p>And then upgrade to 3.0 once you've done the database upgrade documented there.</p>\n</blockquote>\n<p>do I have to upgrade to 3.0 or could I also to git master?</p>",
        "id": 988402,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1597416824
    },
    {
        "content": "<p>also this one <a href=\"https://github.com/zulip/zulip/issues/16140\">https://github.com/zulip/zulip/issues/16140</a></p>",
        "id": 988454,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1597420764
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"8768\">@Fabian Tribrunner</span> you should be able to go directly to master.</p>",
        "id": 988603,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1597428742
    },
    {
        "content": "<p>I think this is a bug in how that migration was updated for <code>orjson</code>, the new JSON parser we're using.</p>",
        "id": 988604,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1597428815
    },
    {
        "content": "<p>If you upgrade to 3.1 and then master, you won't see this; but we'll also fix that migration in master.</p>",
        "id": 988605,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1597428833
    },
    {
        "content": "<p>I think the fix should just be this:</p>\n<div class=\"codehilite\"><pre><span></span><code>diff --git a/zerver/migrations/0284_convert_realm_admins_to_realm_owners.py b/zerver/migrations/0284_convert_realm_admins_to_realm_owners.py\nindex 17bdcaaa90..753374b908 100644\n--- a/zerver/migrations/0284_convert_realm_admins_to_realm_owners.py\n+++ b/zerver/migrations/0284_convert_realm_admins_to_realm_owners.py\n@@ -32,7 +32,7 @@ def set_realm_admins_as_realm_owners(apps: StateApps, schema_editor: DatabaseSch\n                         UserProfile.ROLE_GUEST: 0}\n         for value_dict in list(UserProfile.objects.filter(\n                 realm=realm, is_bot=False, is_active=True).values(&#39;role&#39;).annotate(Count(&#39;role&#39;))):\n-            human_counts[value_dict[&#39;role&#39;]] = value_dict[&#39;role__count&#39;]\n+            human_counts[str(value_dict[&#39;role&#39;])] = value_dict[&#39;role__count&#39;]\n         bot_count = UserProfile.objects.filter(realm=realm, is_bot=True, is_active=True).count()\n         return {\n             RealmAuditLog.ROLE_COUNT_HUMANS: human_counts,\n</code></pre></div>",
        "id": 988608,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1597428937
    },
    {
        "content": "<p>OK, fixed merged as <a href=\"https://github.com/zulip/zulip/commit/f2c9ee80007a0e19393ab229a0cca52600edc01a\">f2c9ee80007a0e19393ab229a0cca52600edc01a</a>.  Thanks for the report <span class=\"user-mention\" data-user-id=\"8768\">@Fabian Tribrunner</span>; you should be able to just upgrade to master now that the fix to a regression in that migration since 3.1 has been merged.</p>",
        "id": 988623,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1597429420
    },
    {
        "content": "<p>I'll try it right now</p>",
        "id": 988626,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1597429494
    },
    {
        "content": "<p>everything was going great <span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> <br>\nthank you very much for the very fast solution :-) <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 988644,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1597429903
    },
    {
        "content": "<p>Thanks for the report!  Reports like this help us avoid the upgrade from 2.x to 4.0 being broken in the future <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span>.</p>",
        "id": 988671,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1597430681
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> <br>\nwas trying to upgrad from git master</p>\n<div class=\"codehilite\"><pre><span></span><code>root@chat: ~ # /home/zulip/deployments/current/scripts/upgrade-zulip-from-git master\ni ｢wdm｣: Webpack compilation successful.\n+ ./manage.py collectstatic --no-default-ignore -v0 --noinput --ignore=assets --ignore=emoji-styles --ignore=html --ignore=js --ignore=styles --ignore=templates\n+ ./manage.py compilemessages -v0\n2021-03-19 18:32:02,692 upgrade-zulip-stage-2: Caching Zulip Git version...\n2021-03-19 18:32:02,917 upgrade-zulip-stage-2: Checking for needed migrations\n2021-03-19 18:32:08,868 upgrade-zulip-stage-2: Stopping Zulip...\nzulip-workers:zulip_deliver_enqueued_emails: stopped\nzulip-workers:zulip_deliver_scheduled_messages: stopped\nzulip-workers:zulip_events_email_mirror: stopped\nzulip-workers:zulip_events_email_senders: stopped\nzulip-workers:zulip_events_missedmessage_mobile_notifications: stopped\nzulip-workers:zulip_events_outgoing_webhooks: stopped\nzulip-workers:zulip_events_invites: stopped\nzulip-workers:zulip_events_user_activity_interval: stopped\nzulip-workers:zulip_events_missedmessage_emails: stopped\nzulip-workers:zulip_events_digest_emails: stopped\nzulip-workers:zulip_events_user_activity: stopped\nzulip-workers:zulip_events_user_presence: stopped\nzulip-workers:zulip_events_embedded_bots: stopped\nzulip-workers:zulip_events_deferred_work: stopped\nzulip-workers:zulip_events_embed_links: stopped\nzulip-workers:zulip_events_error_reports: stopped\nzulip-django: stopped\nzulip-tornado: stopped\n2021-03-19 18:32:17,993 upgrade-zulip-stage-2: Applying Puppet changes...\nTraceback (most recent call last):\n  File &quot;./scripts/zulip-puppet-apply&quot;, line 10, in &lt;module&gt;\n    import yaml\nModuleNotFoundError: No module named &#39;yaml&#39;\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2021-03-19-19-26-21/scripts/lib/upgrade-zulip-stage-2&quot;, line 310, in &lt;module&gt;\n    subprocess.check_call([&quot;./scripts/zulip-puppet-apply&quot;, &quot;--force&quot;])\n  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;./scripts/zulip-puppet-apply&#39;, &#39;--force&#39;]&#39; returned non-zero exit status 1.\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/current/scripts/lib/upgrade-zulip-from-git&quot;, line 93, in &lt;module&gt;\n    *deploy_options,\n  File &quot;/usr/lib/python3.7/subprocess.py&quot;, line 347, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2021-03-19-19-26-21/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2021-03-19-19-26-21&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1.\n</code></pre></div>",
        "id": 1136909,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1616180673
    },
    {
        "content": "<p>Well, the fix is <code>apt install python3-pyyaml</code> and then doing it again.</p>",
        "id": 1136911,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1616180736
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> the bug is that we need <code>pyyaml</code> in order to run <code>zulip-puppet-apply</code> -- I think the right fix might in part be to just move the <code>import yaml</code> inwards to only run in the <code>noop</code> state?  Not sure.</p>",
        "id": 1136913,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1616180812
    },
    {
        "content": "<p>you mean pip install pyyaml?<br>\nbecause apt does not work</p>",
        "id": 1136914,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1616180874
    },
    {
        "content": "<p><code>apt install python3-yaml</code>, not <code>python3-pyyaml</code>.</p>",
        "id": 1136916,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1616180883
    },
    {
        "content": "<p>works fine. thx</p>",
        "id": 1136920,
        "sender_full_name": "Fabian Tribrunner",
        "timestamp": 1616181094
    },
    {
        "content": "<p>Moving it to right before it's used won't work -- we've only run the <code>--noop</code> version, so puppet hasn't installed <code>python3-yaml</code> yet.</p>\n<p>I think we'd need to bootstrap this with an <code>apt-get install python3-yaml</code> in <code>upgrade-zulip-stage-2</code> before puppet.  For the same reason that the installer needs to install yaml before running zulip-puppet-apply, the upgrader needs to do the same.</p>",
        "id": 1136931,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1616182944
    },
    {
        "content": "<p>Or we just parse it out without importing <code>yaml</code> <span aria-label=\"scared\" class=\"emoji emoji-1f628\" role=\"img\" title=\"scared\">:scared:</span></p>",
        "id": 1136933,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1616182994
    },
    {
        "content": "<p>Well, with default options, we'll never run the <code>--noop</code> version.  But yeah, best would be the bootstrapping approach (with some sort of fast <code>[ -e </code> check to avoid making things slow)</p>",
        "id": 1137379,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1616206009
    },
    {
        "content": "<p>I've foud one issue when running this (<code>/home/zulip/deployments/current/scripts/upgrade-zulip-from-git master</code>), is that node is 12.18 and the upgrade seems to require &gt;=12.19 (this was on ubuntu 18.04). I had to manually install the latest stable version of 12.x and change the system to use <code>upgrade-zulip-from-git master</code>.<br>\n(this is <strong>not</strong> a 'recommended' fix by any means...)</p>\n<p><em>(not that it fixed my Android notification issue(s), but at this point I'm trying every/anything to help the server have the right versions (of whatever) to send those pushes to GCM <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> )</em></p>",
        "id": 1138786,
        "sender_full_name": "Eric",
        "timestamp": 1616423671
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"19361\">@Eric</span> Our upgrade script installs its preferred version of <code>node</code> (currently 14.16.0) itself and symlinks it into <code>/usr/local/bin/node</code>. Do you have a different version of <code>node</code> earlier in your <code>PATH</code>? If so, you should remove it.</p>",
        "id": 1139141,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1616437063
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"699\">Anders Kaseorg</span> <a href=\"#narrow/stream/31-production-help/topic/upgrade/near/1139141\">said</a>:</p>\n<blockquote>\n<p>Do you have a different version of <code>node</code> earlier in your <code>PATH</code>? If so, you should remove it.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"699\">@Anders Kaseorg</span>  That's interesting, when I did an upgrade (<a href=\"https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-to-a-release\">https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-to-a-release</a>), on an Ubuntu 18 VPS with 3.3 installed, the installer failed because it was trying to find node above 12.19, but could only find 12.18.</p>\n<p>Unfortunatley I've deleted the entire server otherwise I'd go back and get the logs.</p>\n<p>Is there a possibility the wrong version of <code>node</code> could cause issues with registering devices or managing them in Postgres?</p>",
        "id": 1139439,
        "sender_full_name": "Eric",
        "timestamp": 1616444875
    },
    {
        "content": "<p>Unlikely; a production install only uses Node to compile the JavaScript bundles with Webpack and to render LaTeX messages with KaTeX.</p>",
        "id": 1139458,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1616446018
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> did we fix <code>upgrade-zulip-stage-2</code> for this issue yet?  If not we should make an issue and tag it as a blocker, since I think we'll get N reports of this if we post a release candidate and encourage folks to upgrade right now.</p>",
        "id": 1162893,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1618445921
    },
    {
        "content": "<p><a href=\"https://github.com/zulip/zulip/pull/18179\">#18179</a>.</p>",
        "id": 1164152,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1618538168
    }
]