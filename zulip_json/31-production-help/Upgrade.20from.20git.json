[
    {
        "content": "<p>I ran an <code>upgrade-zulip-from-git</code> (starting from custom built tarball from yesterday) but I got this error:</p>\n<div class=\"codehilite\"><pre><span></span>subprocess.CalledProcessError: Command &#39;[&#39;./tools/minify-js&#39;, &#39;--prev-deploy&#39;, &#39;/home/zulip/deployments/current&#39;]&#39; returned non-zero exit status 1\n</pre></div>",
        "id": 125399,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484237439
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-email=\"rwbarton@gmail.com\">@Reid Barton</span> , can you try to run the command manually, so that we can see what exact error it is throwing?</p>",
        "id": 125478,
        "sender_full_name": "Robert Hönig",
        "timestamp": 1484238660
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>root@zulip:/home/zulip/deployments/next# ./tools/minify-js &#39;--prev-deploy&#39; &#39;/home/zulip/deployments/current&#39;\nmodule.js:457\n    throw err;\n    ^\n\nError: Cannot find module &#39;../lib&#39;\n    at Function.Module._resolveFilename (module.js:455:15)\n    at Function.Module._load (module.js:403:25)\n    at Module.require (module.js:483:17)\n    at require (internal/module.js:20:19)\n    at Object.&lt;anonymous&gt; (/srv/zulip-npm-cache/736d292307af94230dc4e3c8ab63208d1bf2bb46/node_modules/.bin/handlebars:105:18)\n    at Module._compile (module.js:556:32)\n    at Object.Module._extensions..js (module.js:565:10)\n    at Module.load (module.js:473:32)\n    at tryModuleLoad (module.js:432:12)\n    at Function.Module._load (module.js:424:3)\nTraceback (most recent call last):\n  File &quot;tools/compile-handlebars-templates&quot;, line 61, in &lt;module&gt;\n    run()\n  File &quot;tools/compile-handlebars-templates&quot;, line 30, in run\n    &#39;--known&#39;, &#39;if,unless,each,with&#39;])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 541, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;node&#39;, &#39;node_modules/.bin/handlebars&#39;, &#39;static/templates/admin_user_list.handlebars&#39;, &#39;static/templates/compose-invite-users.handlebars&#39;, &#39;static/templates/settings_tab.handlebars&#39;, &#39;static/templates/admin_default_streams_list.handlebars&#39;, &#39;static/templates/tutorial_reply.handlebars&#39;, &#39;static/templates/subscription_type.handlebars&#39;, &#39;static/templates/stream_sidebar_row.handlebars&#39;, &#39;static/templates/admin_streams_list.handlebars&#39;, &#39;static/templates/announce_stream_docs.handlebars&#39;, &#39;static/templates/notification.handlebars&#39;, &#39;static/templates/bankruptcy_modal.handlebars&#39;, &#39;static/templates/message_edit_form.handlebars&#39;, &#39;static/templates/message_reactions.handlebars&#39;, &#39;static/templates/subscription_table_body.handlebars&#39;, &#39;static/templates/tutorial_message.handlebars&#39;, &#39;static/templates/tutorial_home.handlebars&#39;, &#39;static/templates/user_presence_rows.handlebars&#39;, &#39;static/templates/tutorial_title.handlebars&#39;, &#39;static/templates/subscription_setting_icon.handlebars&#39;, &#39;static/templates/user_sidebar_actions.handlebars&#39;, &#39;static/templates/propagate_notification_change.handlebars&#39;, &#39;static/templates/admin_tab.handlebars&#39;, &#39;static/templates/message_info_popover_title.handlebars&#39;, &#39;static/templates/tab_bar.handlebars&#39;, &#39;static/templates/stream_sidebar_actions.handlebars&#39;, &#39;static/templates/invite_subscription.handlebars&#39;, &#39;static/templates/admin_filter_list.handlebars&#39;, &#39;static/templates/bot_avatar_row.handlebars&#39;, &#39;static/templates/alert_word_settings_item.handlebars&#39;, &#39;static/templates/auth-methods-settings-admin.handlebars&#39;, &#39;static/templates/recipient_row.handlebars&#39;, &#39;static/templates/compose_notification.handlebars&#39;, &#39;static/templates/emoji_popover_content.handlebars&#39;, &#39;static/templates/topic_sidebar_actions.handlebars&#39;, &#39;static/templates/stream_privacy.handlebars&#39;, &#39;static/templates/bookend.handlebars&#39;, &#39;static/templates/actions_popover_content.handlebars&#39;, &#39;static/templates/topic_list_item.handlebars&#39;, &#39;static/templates/tutorial_subject.handlebars&#39;, &#39;static/templates/change_stream_privacy.handlebars&#39;, &#39;static/templates/stream_member_list_entry.handlebars&#39;, &#39;static/templates/message_info_popover_content.handlebars&#39;, &#39;static/templates/subscription.handlebars&#39;, &#39;static/templates/admin_emoji_list.handlebars&#39;, &#39;static/templates/user_presence_row.handlebars&#39;, &#39;static/templates/tutorial_stream.handlebars&#39;, &#39;static/templates/subscription_settings.handlebars&#39;, &#39;static/templates/topic_edit_form.handlebars&#39;, &#39;static/templates/new_stream_users.handlebars&#39;, &#39;static/templates/email_address_hint.handlebars&#39;, &#39;static/templates/message_reaction.handlebars&#39;, &#39;static/templates/loader.handlebars&#39;, &#39;static/templates/group_pms.handlebars&#39;, &#39;static/templates/compose_all_everyone.handlebars&#39;, &#39;static/templates/subscription_creation_form.handlebars&#39;, &#39;static/templates/reaction_popover_content.handlebars&#39;, &#39;static/templates/sidebar_private_message_list.handlebars&#39;, &#39;static/templates/message_group.handlebars&#39;, &#39;static/templates/single_message.handlebars&#39;, &#39;static/templates/settings/streams-list-admin.handlebars&#39;, &#39;static/templates/settings/bot-list-admin.handlebars&#39;, &#39;static/templates/settings/deactivated-users-admin.handlebars&#39;, &#39;static/templates/settings/bot-settings.handlebars&#39;, &#39;static/templates/settings/admin_auth_methods_list.handlebars&#39;, &#39;static/templates/settings/alert-word-settings.handlebars&#39;, &#39;static/templates/settings/emoji-settings-admin.handlebars&#39;, &#39;static/templates/settings/account-settings.handlebars&#39;, &#39;static/templates/settings/default-streams-list-admin.handlebars&#39;, &#39;static/templates/settings/ui-settings.handlebars&#39;, &#39;static/templates/settings/notification-settings.handlebars&#39;, &#39;static/templates/settings/display-settings.handlebars&#39;, &#39;static/templates/settings/organization-settings-admin.handlebars&#39;, &#39;static/templates/settings/realm-filter-settings-admin.handlebars&#39;, &#39;static/templates/settings/admin_alias_list.handlebars&#39;, &#39;static/templates/settings/user-list-admin.handlebars&#39;, &#39;--output&#39;, &#39;static/templates/compiled.js&#39;, &#39;--known&#39;, &#39;if,unless,each,with&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;./tools/minify-js&quot;, line 34, in &lt;module&gt;\n    subprocess.check_call([&#39;tools/compile-handlebars-templates&#39;])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 541, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;tools/compile-handlebars-templates&#39;]&#39; returned non-zero exit status 1\n</pre></div>",
        "id": 125480,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484238681
    },
    {
        "content": "<p>I'm not sure if I'm supposed to be in a specific directory for this steps</p>",
        "id": 125482,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484238738
    },
    {
        "content": "<p>I'm guessing <code>cd zulip</code> might get you further.</p>",
        "id": 125483,
        "sender_full_name": "Steve Howell",
        "timestamp": 1484238964
    },
    {
        "content": "<p>I'm in <code>/home/zulip/deployments/next</code></p>",
        "id": 125485,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239000
    },
    {
        "content": "<p>what is <code>settings.DEPLOY_ROOT</code>?</p>",
        "id": 125487,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239083
    },
    {
        "content": "<p>probably <code>zulip</code>, hence the <code>cd zulip</code> suggestion :)</p>",
        "id": 125490,
        "sender_full_name": "Steve Howell",
        "timestamp": 1484239182
    },
    {
        "content": "<p>Can you do <code>ls</code> from your current working directory?</p>",
        "id": 125491,
        "sender_full_name": "Steve Howell",
        "timestamp": 1484239219
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>root@zulip:/home/zulip/deployments/next# ls\nanalytics     contrib_bots  frontend_tests  package.json  requirements  tools        zerver              zulip-venv\napi           corporate     LICENSE         pgroonga      scripts       Vagrantfile  zilencer\nbots          Dockerfile    manage.py       puppet        static        var          zproject\nconfirmation  docs          node_modules    README.md     templates     version.py   zulip-current-venv\n</pre></div>",
        "id": 125495,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239382
    },
    {
        "content": "<p>there is no <code>zulip</code>, nor is there in my <code>deployments/current</code></p>",
        "id": 125496,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239404
    },
    {
        "content": "<p>You are inside a  subdirectory of zulip. Simply do <code>cd ..</code> twice now, and you'll be at the root of zulip.</p>",
        "id": 125498,
        "sender_full_name": "Robert Hönig",
        "timestamp": 1484239448
    },
    {
        "content": "<p>okay, but the command was invoked by the installation process as <code>./tools/minify-js</code></p>",
        "id": 125501,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239491
    },
    {
        "content": "<p>From where did you execute <code>upgrade-zulip-from-git</code>?</p>",
        "id": 125502,
        "sender_full_name": "Robert Hönig",
        "timestamp": 1484239532
    },
    {
        "content": "<p>from <code>/root</code> I guess, I can try from <code>/root/zulip</code></p>",
        "id": 125504,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239611
    },
    {
        "content": "<p>same problem (unsurprisingly)</p>",
        "id": 125506,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239673
    },
    {
        "content": "<p>I see, <code>/root/zulip = /home/zulip/deployments/next</code></p>",
        "id": 125509,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239808
    },
    {
        "content": "<p>oh there is an issue about this already, <a href=\"https://github.com/zulip/zulip/issues/2377\" target=\"_blank\" title=\"https://github.com/zulip/zulip/issues/2377\">https://github.com/zulip/zulip/issues/2377</a></p>",
        "id": 125513,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239901
    },
    {
        "content": "<p>so I guess it is just broken</p>",
        "id": 125517,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484239976
    },
    {
        "content": "<p>/me does it the old-fashioned way</p>",
        "id": 125519,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484240013
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"rwbarton@gmail.com\">@Reid Barton</span> I'm a bit confused by this failure mode; I use upgrade-zulip-from-git all the time to upgrade our servers, and have never seen this</p>",
        "id": 125580,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1484242004
    },
    {
        "content": "<p>(At least, never been able to reproduce this; I had seen <span class=\"user-mention\" data-user-email=\"andersk@mit.edu\">@Anders Kaseorg</span>'s traceback)</p>",
        "id": 125582,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1484242022
    },
    {
        "content": "<p>hm</p>",
        "id": 125583,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484242025
    },
    {
        "content": "<p>oops I missed part of the instructions haha!</p>",
        "id": 125587,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484242053
    },
    {
        "content": "<p>ahh, which part?</p>",
        "id": 125590,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1484242059
    },
    {
        "content": "<p>To configure this, you will need to add<br>\n<code>zulip::static_asset_compiler</code> to your <code>/etc/zulip/zulip.conf</code> file's<br>\n<code>puppet_classes</code> entry, like this:</p>",
        "id": 125591,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484242067
    },
    {
        "content": "<p>:)</p>",
        "id": 125592,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484242071
    },
    {
        "content": "<p>that's what I get for grepping for upgrade-zulip-from-git and reading backwards</p>",
        "id": 125594,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484242086
    },
    {
        "content": "<p>ahh, yeah</p>",
        "id": 125597,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1484242113
    },
    {
        "content": "<p>We should quite possibly just move it into the default configuration</p>",
        "id": 125598,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1484242123
    },
    {
        "content": "<p>should maybe fail faster in this scenario</p>",
        "id": 125600,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484242126
    },
    {
        "content": "<p>I recently rearranged things so that <code>upgrade-zulip-from-git</code> builds static assets before turning anything off</p>",
        "id": 125603,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1484242151
    },
    {
        "content": "<p>So that if it fails, it should be harmless</p>",
        "id": 125604,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1484242163
    },
    {
        "content": "<p>hm</p>",
        "id": 125605,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484242164
    },
    {
        "content": "<p>it did fail very early but I'm almost certain the zulip server was not running (had the \"We're trouble reaching etc.\" message in my zulip browser tab)</p>",
        "id": 125610,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484242212
    },
    {
        "content": "<p>hmm.  You can read <code>scripts/lib/upgrade-zulip-stage-2</code>; as of last Friday it now does <code>update-prod-static</code> early</p>",
        "id": 125614,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1484242314
    },
    {
        "content": "<p>hm, I agree that it looks that way</p>",
        "id": 125625,
        "sender_full_name": "Reid Barton",
        "timestamp": 1484242503
    },
    {
        "content": "<p>was just trying the upgrade from git but got an error and nothing was in the log folder (here the terminal output only)<br>\nWhat was the cause?<br>\n<a href=\"/user_uploads/2/e3/CEmk7yugnVehtnhCQE1HWtf_/failed-upgrading-from-git.txt\" target=\"_blank\" title=\"failed-upgrading-from-git.txt\">failed-upgrading-from-git.txt</a></p>",
        "id": 165404,
        "sender_full_name": "Matthias",
        "timestamp": 1489151045
    },
    {
        "content": "<p>retried with <code>sudo</code> but same result</p>",
        "id": 165405,
        "sender_full_name": "Matthias",
        "timestamp": 1489151224
    },
    {
        "content": "<p>how can I create a tarball straight from git. I've seen the script in a tools folder, but it's not there in my current zulip installation (1.5.1)</p>",
        "id": 165410,
        "sender_full_name": "Matthias",
        "timestamp": 1489151861
    },
    {
        "content": "<p>oh, it is there in the new folder from the failed git upgrade<br>\nbut <code>sudo build-release-tarball</code> isn't a known command</p>",
        "id": 165411,
        "sender_full_name": "Matthias",
        "timestamp": 1489151998
    },
    {
        "content": "<p>It should be in the <code>tools</code> directory.</p>",
        "id": 165450,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489162542
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\" data-user-id=\"58\">@Steve Howell</span> there should be additional log details for what that failed at some path like <code>/home/zulip/deployments/next/var/log/update-prod-static/log</code></p>",
        "id": 165488,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489167955
    },
    {
        "content": "<p>Oops meant to mention <span class=\"user-mention\" data-user-email=\"m.mueller@intercultural-elements.eu\" data-user-id=\"1646\">@Matthias Müller</span></p>",
        "id": 165489,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489167971
    },
    {
        "content": "<p>I already have succeeded in upgrading our production machine to 1.5.1 but that's almost 1000 commits away from current git master. Now it looks and feels much more consistent so unless you think the current git master is not mature enough for production use I would attempt the git upgrade tomorrow around 5pm CET/9am your time.</p>",
        "id": 166583,
        "sender_full_name": "Matthias",
        "timestamp": 1489350085
    },
    {
        "content": "<p>I am not aware of any major regressions on master, but of course it's a little less well tested than a full release.  I can be around 9am tomorrow.  Once you go through the process of deploying off of master, it should be easy to re-update off of master if you discover any issues, and we usually make pretty quick fixes, so I think you should proceed with the plan.</p>",
        "id": 166587,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489352008
    },
    {
        "content": "<p>Fab, thanks a lot. Until then...</p>",
        "id": 166588,
        "sender_full_name": "Matthias",
        "timestamp": 1489355236
    },
    {
        "content": "<p>Testserver git upgrade: I just looked for the log <span class=\"user-mention\" data-user-email=\"tabbott@zulipchat.com\" data-user-id=\"7\">@Tim Abbott</span> pointed out on March 10th. But the symlink <code>/next</code> didn't work. <br>\nI had to manually click to <code>/home/zulip/deployments/2017-03-13-12-29-05/var/log</code></p>",
        "id": 166734,
        "sender_full_name": "Matthias",
        "timestamp": 1489405158
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>Using cached emojis from /srv/zulip-emoji-cache/f516920874fb980676d9c5a3c1e858ffd6284a0c/emoji\n+ rm -rf /home/zulip/deployments/2017-03-10-14-04-37/tools/setup/emoji/../../../static/generated/emoji\nHash: 5ccb5f20f5ef7f649109\nVersion: webpack 1.12.2\nTime: 797ms\n    Asset    Size  Chunks             Chunk Names\nbundle.js  106 kB       0  [emitted]  main\n   [0] ./static/js/src/main.js 1.38 kB {0} [built]\n    + 30 hidden modules\nfatal: Not a git repository: &#39;/home/zulip/deployments/current/.git&#39;\nWarning: git returned an error when comparing to the previous\ndeploy in /home/zulip/deployments/current. Will re-minify JavaScript instead of reusing\nclosure-compiler not installed; the Vagrant tools/provision installs it via apt or you can manually unpack http://dl.google.com/closure-compiler/compiler-latest.zip to tools/closure-compiler\n</pre></div>",
        "id": 166735,
        "sender_full_name": "Matthias",
        "timestamp": 1489405163
    },
    {
        "content": "<p>I tried three times and every time the same log</p>",
        "id": 166736,
        "sender_full_name": "Matthias",
        "timestamp": 1489405182
    },
    {
        "content": "<p>I think I found the problem: <br>\nafter editing <code>/etc/zulip/zulip.conf</code> I can't successfully run <code>scripts/zulip-puppet-apply</code></p>",
        "id": 166740,
        "sender_full_name": "Matthias",
        "timestamp": 1489408846
    },
    {
        "content": "<p>instead I get this error </p>\n<div class=\"codehilite\"><pre><span></span>zulip@zulip:~/deployments/current$ scripts/zulip-puppet-apply\nError: Could not find class apt for zulip.domain.local on node zulip.domain.local\nError: Could not find class apt for zulip.domain.local on node zulip.domain.local\nTraceback (most recent call last):\n  File &quot;scripts/zulip-puppet-apply&quot;, line 36, in &lt;module&gt;\n    subprocess.check_call(puppet_cmd + [&#39;--noop&#39;, &#39;--show_diff&#39;])\n  File &quot;/usr/lib/python2.7/subprocess.py&quot;, line 541, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;puppet&#39;, &#39;apply&#39;, &#39;--modulepath=/root/zulip/puppet&#39;, &#39;-e&#39;, &#39;\\nExec { path =&gt; &quot;/usr/sbin:/usr/bin:/sbin:/bin&quot; }\\ninclude apt\\ninclude zulip::voyager\\ninclude zulip::static_asset_compiler\\n&#39;, &#39;--noop&#39;, &#39;--show_diff&#39;]&#39; returned non-zero exit status 1\n</pre></div>",
        "id": 166741,
        "sender_full_name": "Matthias",
        "timestamp": 1489408920
    },
    {
        "content": "<p>Is there an easy way to get back to your starting state this morning?  It would be good to know which steps you're following before you encounter the first error.</p>",
        "id": 166837,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489421759
    },
    {
        "content": "<p>(er, afternoon for you)</p>",
        "id": 166838,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489421767
    },
    {
        "content": "<p>hm, the first error that I posted today (starting with <code>Using cached emojis...</code> was on  the test server). let's ignore that one. <br>\non the production machine I haven't tried a git upgrade yet<br>\nbut did encounter the puppet error on both<br>\nmaybe because both hang in a Windows domain network (?)</p>",
        "id": 166840,
        "sender_full_name": "Matthias",
        "timestamp": 1489421900
    },
    {
        "content": "<p>It's possible that the Windows networking stuff is relevant here.</p>",
        "id": 166841,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489422144
    },
    {
        "content": "<p>For your test server, it might be helpful to try to run the puppet command individually.  If you look at the last line of the output, you can infer what command it's trying to run.  Back in 5 minutes.</p>",
        "id": 166842,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489422192
    },
    {
        "content": "<p>this really looks like it<code>Could not find class apt for zulip.domain.local on node zulip.domain.local</code><br>\nok, I'll wait<br>\ndo you have the list of puppet commands I have to run through?</p>",
        "id": 166843,
        "sender_full_name": "Matthias",
        "timestamp": 1489422222
    },
    {
        "content": "<p>I'm saying you can construct the puppet command based on the output you posted (see the last line).</p>",
        "id": 166844,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489422489
    },
    {
        "content": "<p>But it might make sense to start over on a test server, and we  can try to do this very methodically, and you can tell us exactly which commands you are running.</p>",
        "id": 166845,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489422526
    },
    {
        "content": "<p>uff, I don't even know what puppet really is. <br>\non the testserver I basically followed the instructions in the <a href=\"http://zulip.readthedocs.io/en/latest/prod-maintain-secure-upgrade.html\" target=\"_blank\" title=\"http://zulip.readthedocs.io/en/latest/prod-maintain-secure-upgrade.html\">documentation</a></p>",
        "id": 166846,
        "sender_full_name": "Matthias",
        "timestamp": 1489422594
    },
    {
        "content": "<p>I would have to create a new VM for that.</p>",
        "id": 166848,
        "sender_full_name": "Matthias",
        "timestamp": 1489422689
    },
    {
        "content": "<p><code>puppet</code> is basically a tool that knows how to populate all of your directories with various files.  It would not surprise me if it's assuming Unix conventions.</p>",
        "id": 166853,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489422916
    },
    {
        "content": "<p><a href=\"https://en.wikipedia.org/wiki/Puppet_(software)\" target=\"_blank\" title=\"https://en.wikipedia.org/wiki/Puppet_(software)\">https://en.wikipedia.org/wiki/Puppet_(software)</a></p>\n<p>The wiki page seems to indicate some level of Windows support, but I could still see hybrid environments being challenging.  Most Zulip production environments are pure Unix.</p>",
        "id": 166854,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489423010
    },
    {
        "content": "<p>weird, but upgrading using the tarball worked fine</p>",
        "id": 166855,
        "sender_full_name": "Matthias",
        "timestamp": 1489423053
    },
    {
        "content": "<p>Can you post a brief history of what you've done on the two servers (test and production) so far, going back to the original install?  (An example would be something like \"test server: original install 1.3 worked, normal upgrade to 1.5.1 worked w/some workarounds, upgrade using git tarball fails w/puppet error\".</p>",
        "id": 166857,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489423205
    },
    {
        "content": "<p>ok, Testserver: installed 1.5.1 worked<br>\nattempting multiple git upgrades didn't work<br>\n/deployment/next still pointed to an older git upgrade attempt <br>\ntried again zulip-puppet-apply but it failed with above error</p>\n<p>prod.server: installed 1.4.2 months ago<br>\nupgrade to 1.5.1 from tarball worked fine (there were problems with ubuntu because I restored the VM from a backup so those things kind of never happened)</p>",
        "id": 166858,
        "sender_full_name": "Matthias",
        "timestamp": 1489423447
    },
    {
        "content": "<p>ok, give me a moment, I'm looking for some docs</p>",
        "id": 166862,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489423637
    },
    {
        "content": "<p>forgot to mention: production server had the same <code>zulip-puppet-apply</code> error as test server</p>",
        "id": 166864,
        "sender_full_name": "Matthias",
        "timestamp": 1489423728
    },
    {
        "content": "<p>Ok, this does seem to be relevant:</p>\n<div class=\"codehilite\"><pre><span></span>Error: Could not find class apt for zulip.domain.local on node zulip.domain.local\n</pre></div>",
        "id": 166874,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489423937
    },
    {
        "content": "<p>I  unfortunately don't have much experience with puppet, but can you run this for a data point?</p>\n<div class=\"codehilite\"><pre><span></span> puppet module list\n</pre></div>",
        "id": 166876,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489424016
    },
    {
        "content": "<p>As an aside, it's 9:53 local time here, but it feels like 8:53, because our clocks moved forward this weekend.  So it may be a while till Tim comes online.  He'll know more here.</p>",
        "id": 166877,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489424052
    },
    {
        "content": "<p>I googled your error and found this, but we should hold off on following their advice right away:</p>\n<p><a href=\"http://stackoverflow.com/questions/26046550/puppet-error-could-not-find-class-apt\" target=\"_blank\" title=\"http://stackoverflow.com/questions/26046550/puppet-error-could-not-find-class-apt\">http://stackoverflow.com/questions/26046550/puppet-error-could-not-find-class-apt</a></p>",
        "id": 166879,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489424091
    },
    {
        "content": "<p>ok, I have a read in a moment... I restored a ubuntu VM export without Zulip but need to rename the user first<br>\nthen I can install Zulip 1.5.1 again for testing</p>",
        "id": 166881,
        "sender_full_name": "Matthias",
        "timestamp": 1489424178
    },
    {
        "content": "<p>sounds good</p>",
        "id": 166885,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489424248
    },
    {
        "content": "<p>when I googled the problem I also found a lot of vagrant related issues. But I don't use vagrant. <br>\nupdate: running <code>apt-get upgrade</code> on the test-server</p>",
        "id": 166902,
        "sender_full_name": "Matthias",
        "timestamp": 1489424629
    },
    {
        "content": "<p>test server: did sudo apt-get dist-upgrade<br>\ncreated self-signed certificates <br>\ninstalling zulip 1.5.1 from releases tarball now</p>",
        "id": 166926,
        "sender_full_name": "Matthias",
        "timestamp": 1489425414
    },
    {
        "content": "<p>could it be connected to this? <br>\n<a href=\"/user_uploads/2/66/pqgWVtpr2nIArhTIIUmHpXtL/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/66/pqgWVtpr2nIArhTIIUmHpXtL/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/66/pqgWVtpr2nIArhTIIUmHpXtL/pasted_image.png\"></a></div>",
        "id": 166936,
        "sender_full_name": "Matthias",
        "timestamp": 1489425958
    },
    {
        "content": "<p>Possibly.  What is the symptom now?</p>",
        "id": 166937,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489426014
    },
    {
        "content": "<p>it's still installing zulip</p>",
        "id": 166938,
        "sender_full_name": "Matthias",
        "timestamp": 1489426045
    },
    {
        "content": "<p>ok</p>",
        "id": 166940,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489426342
    },
    {
        "content": "<p>configured setting.py and zulip-secrets.conf<br>\ninitializing database now</p>",
        "id": 166941,
        "sender_full_name": "Matthias",
        "timestamp": 1489426493
    },
    {
        "content": "<p>ok, zulip up and running again<br>\nfresh installation of 1.5.1 on test server</p>",
        "id": 166955,
        "sender_full_name": "Matthias",
        "timestamp": 1489427067
    },
    {
        "content": "<p>I will now edit the zulip.conf file to allow for git upgrades</p>",
        "id": 166960,
        "sender_full_name": "Matthias",
        "timestamp": 1489427104
    },
    {
        "content": "<p>interesting, the test server has this </p>\n<div class=\"codehilite\"><pre><span></span>[rabbitmq]\nnodename = zulip@localhost\n</pre></div>\n\n\n<p>which is not in the production server's zulip.conf file</p>",
        "id": 166965,
        "sender_full_name": "Matthias",
        "timestamp": 1489427209
    },
    {
        "content": "<p>test server /etc/zulip/zulip.conf looks now like this </p>\n<div class=\"codehilite\"><pre><span></span>[machine]\npuppet_classes = zulip::voyager, zulip::static_asset_compiler\ndeploy_type = voyager\n\n[rabbitmq]\nnodename = zulip@localhost\n\n[deployment]\ngit_repo_url = https://github.com/zulip/zulip.git\n</pre></div>",
        "id": 166971,
        "sender_full_name": "Matthias",
        "timestamp": 1489427266
    },
    {
        "content": "<p>Interesting!  <span class=\"user-mention\" data-user-email=\"tabbott@zulipchat.com\" data-user-id=\"7\">@Tim Abbott</span> do you know why there'd be a <code>rabbitmq</code> section in <code>zulip.conf</code> for a fresh install, but not for an upgrade?</p>",
        "id": 166974,
        "sender_full_name": "Steve Howell",
        "timestamp": 1489427320
    },
    {
        "content": "<p>yep</p>",
        "id": 166978,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489427345
    },
    {
        "content": "<p>shall I try to run the <code>zulip-puppet-apply</code> on test server?</p>",
        "id": 166979,
        "sender_full_name": "Matthias",
        "timestamp": 1489427346
    },
    {
        "content": "<p>Basically it's not super safe to migrate a machine to the new model without them doing manual work</p>",
        "id": 166981,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489427369
    },
    {
        "content": "<p>But the <code>zulip@localhost</code> thing basically makes rabbitmq robust to hostname changes (but also force-changes your rabbitmq hostname)</p>",
        "id": 166982,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489427392
    },
    {
        "content": "<p>So older systems can just stay with the default</p>",
        "id": 166983,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489427419
    },
    {
        "content": "<p>We have a process for switching existing production systems if one's interested</p>",
        "id": 166985,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489427433
    },
    {
        "content": "<p>with the 'new model' do you mean corporate / community ?</p>",
        "id": 166986,
        "sender_full_name": "Matthias",
        "timestamp": 1489427468
    },
    {
        "content": "<p>No, I just mean hardcoding the rabbitmq nodename of <code>zulip@localhost</code> rather than the default of <code>zulip@hostname</code> which breaks if your hostname changes</p>",
        "id": 166988,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489427542
    },
    {
        "content": "<p>I see</p>",
        "id": 166990,
        "sender_full_name": "Matthias",
        "timestamp": 1489427561
    },
    {
        "content": "<p>I will try now the puppet apply</p>",
        "id": 166992,
        "sender_full_name": "Matthias",
        "timestamp": 1489427590
    },
    {
        "content": "<p>same problem with the error on the domain</p>",
        "id": 166994,
        "sender_full_name": "Matthias",
        "timestamp": 1489427628
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>Error: Could not find class apt for zuliptest.domain.local on node zuliptest.domain.local\nError: Could not find class apt for zuliptest.domain.local on node zuliptest.domain.local\n</pre></div>",
        "id": 166996,
        "sender_full_name": "Matthias",
        "timestamp": 1489427678
    },
    {
        "content": "<p>OK so that error is caused by running the command in an unexpected way</p>",
        "id": 166997,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489427691
    },
    {
        "content": "<p>There's a bug in 1.5.1 that means you need to run <code>./scripts/zulip-puppet-apply</code>, not e.g. <code>scripts/zulip-puppet-apply</code>; the way it finds the rest of the project depends on having the leading <code>./</code></p>",
        "id": 166998,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489427712
    },
    {
        "content": "<p>just now i did actually ./script...</p>",
        "id": 167000,
        "sender_full_name": "Matthias",
        "timestamp": 1489427751
    },
    {
        "content": "<p>ah, but didn't sudo it</p>",
        "id": 167005,
        "sender_full_name": "Matthias",
        "timestamp": 1489427782
    },
    {
        "content": "<p>it's doing something</p>",
        "id": 167008,
        "sender_full_name": "Matthias",
        "timestamp": 1489427800
    },
    {
        "content": "<p><img alt=\":smile:\" class=\"emoji\" src=\"/static/generated/emoji/images/emoji/unicode/1f604.png\" title=\":smile:\"></p>",
        "id": 167011,
        "sender_full_name": "Matthias",
        "timestamp": 1489427815
    },
    {
        "content": "<p>yes! <code>Notice: Finished catalog run in 238.54 seconds</code></p>",
        "id": 167024,
        "sender_full_name": "Matthias",
        "timestamp": 1489428046
    },
    {
        "content": "<p>a simple ./ made all the difference</p>",
        "id": 167027,
        "sender_full_name": "Matthias",
        "timestamp": 1489428063
    },
    {
        "content": "<p>so now i can try again the git upgrade</p>",
        "id": 167028,
        "sender_full_name": "Matthias",
        "timestamp": 1489428077
    },
    {
        "content": "<p>this puppet apply command/script is really CPU intensive</p>",
        "id": 167040,
        "sender_full_name": "Matthias",
        "timestamp": 1489428259
    },
    {
        "content": "<p>ah, while running <code>zulip-puppet-apply</code> on the production machine I got this</p>\n<div class=\"codehilite\"><pre><span></span>Error: Could not start Service[rabbitmq-server]: Execution of &#39;/bin/systemctl start rabbitmq-server&#39; returned 1: Job for rabbitmq-server.service failed because a timeout was exceeded. See &quot;systemctl status rabbitmq-server.service&quot; and &quot;journalctl -xe&quot; for details.\nError: /Stage[main]/Zulip::Rabbit/Service[rabbitmq-server]/ensure: change from stopped to running failed: Could not start Service[rabbitmq-server]: Execution of &#39;/bin/systemctl start rabbitmq-server&#39; returned 1: Job for rabbitmq-server.service failed because a timeout was exceeded. See &quot;systemctl status rabbitmq-server.service&quot; and &quot;journalctl -xe&quot; for details.\nNotice: /Stage[main]/Zulip::Static_asset_compiler/Zulip::Static_asset_compiler::Safepackage[gettext]/Package[gettext]/ensure: ensure changed &#39;purged&#39; to &#39;present&#39;\nNotice: Finished catalog run in 413.41 seconds\n</pre></div>",
        "id": 167046,
        "sender_full_name": "Matthias",
        "timestamp": 1489428483
    },
    {
        "content": "<p>now the production machine is down :-(</p>",
        "id": 167052,
        "sender_full_name": "Matthias",
        "timestamp": 1489428562
    },
    {
        "content": "<p>and although it's finished whatever it did there is still a high CPU load caused by python</p>",
        "id": 167055,
        "sender_full_name": "Matthias",
        "timestamp": 1489428630
    },
    {
        "content": "<p>test server is done with upgrade - all went well<br>\nproduction server is not quite down but still totally overloaded by python</p>",
        "id": 167061,
        "sender_full_name": "Matthias",
        "timestamp": 1489428786
    },
    {
        "content": "<p>Can you <code>supervisorctl status</code>?</p>",
        "id": 167064,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489428855
    },
    {
        "content": "<p>the python processes will continuously restart themselves if rabbitmq is down</p>",
        "id": 167065,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489428875
    },
    {
        "content": "<p>So that should show them all with uptimes &lt;10s</p>",
        "id": 167066,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489428884
    },
    {
        "content": "<p>yes, exactly<br>\n<a href=\"/user_uploads/2/62/3K5AD2WD5H7qKkTxjGoyYrKq/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/62/3K5AD2WD5H7qKkTxjGoyYrKq/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/62/3K5AD2WD5H7qKkTxjGoyYrKq/pasted_image.png\"></a></div>",
        "id": 167069,
        "sender_full_name": "Matthias",
        "timestamp": 1489428923
    },
    {
        "content": "<p>how can i stop it? or start rabbitmq?</p>",
        "id": 167072,
        "sender_full_name": "Matthias",
        "timestamp": 1489428945
    },
    {
        "content": "<p>It might be reasonable to <code>supervisorctl stop all</code> and then start <code>rabbitmq-server</code> and then start supervisord processes again</p>",
        "id": 167074,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489428959
    },
    {
        "content": "<p>(Just because the machine will be more responsive without the restart party)</p>",
        "id": 167075,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489428970
    },
    {
        "content": "<p>Wait, did you change the <code>/etc/zulip/zulip.conf</code> to have the <code>rabbitmq</code> lines?</p>",
        "id": 167077,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489428992
    },
    {
        "content": "<p>On your existing machine?</p>",
        "id": 167079,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489428996
    },
    {
        "content": "<p>no, on the production machine that was upgrade from 1.4.2 to 1.5.1 using tarball I never added those lines in zulip.conf</p>",
        "id": 167081,
        "sender_full_name": "Matthias",
        "timestamp": 1489429054
    },
    {
        "content": "<p>k</p>",
        "id": 167082,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489429079
    },
    {
        "content": "<p>This is the process for doing that migration:<br>\n<a href=\"https://chat.zulip.org/#narrow/near/152942/stream/production.20help/topic/Livezuliping.201.2E4-.3E1.2E5\" target=\"_blank\" title=\"https://chat.zulip.org/#narrow/near/152942/stream/production.20help/topic/Livezuliping.201.2E4-.3E1.2E5\">https://chat.zulip.org/#narrow/near/152942/stream/production.20help/topic/Livezuliping.201.2E4-.3E1.2E5</a><br>\nwhich is about as fast as debugging why rabbitmq isn't starting if it doesn't just start for you</p>",
        "id": 167084,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489429114
    },
    {
        "content": "<p>I run <code>sudo rabbitmq-server</code> but it seems be stuck</p>",
        "id": 167086,
        "sender_full_name": "Matthias",
        "timestamp": 1489429123
    },
    {
        "content": "<p>ok added </p>\n<div class=\"codehilite\"><pre><span></span>[rabbitmq]\nnodename = zulip@localhost\n</pre></div>",
        "id": 167103,
        "sender_full_name": "Matthias",
        "timestamp": 1489429365
    },
    {
        "content": "<p>will follow those instructions now or do I follow the instructions first and after that add those two lines?</p>",
        "id": 167107,
        "sender_full_name": "Matthias",
        "timestamp": 1489429424
    },
    {
        "content": "<p>heck, all red on the screen</p>",
        "id": 167119,
        "sender_full_name": "Matthias",
        "timestamp": 1489429640
    },
    {
        "content": "<p>I think <code>apt-get purge rabbitmq-server</code> removed rabbitmq completely<br>\nLivezuliping 1.4-&gt;1.5</p>",
        "id": 167124,
        "sender_full_name": "Matthias",
        "timestamp": 1489429707
    },
    {
        "content": "<p>after you add the lines</p>",
        "id": 167125,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489429708
    },
    {
        "content": "<p>Yep, that's the intent -- rabbitmq is bad at switching its nodename</p>",
        "id": 167127,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489429722
    },
    {
        "content": "<p>So to make the migration reliable it's best to uninstall it</p>",
        "id": 167128,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489429754
    },
    {
        "content": "<p>(It's really Erlang's fault, not rabbitmq's, but the conclusion is the same)</p>",
        "id": 167129,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489429775
    },
    {
        "content": "<p>what's the next command I should run?</p>",
        "id": 167131,
        "sender_full_name": "Matthias",
        "timestamp": 1489429801
    },
    {
        "content": "<p>This stuff:</p>\n<div class=\"codehilite\"><pre><span></span>scripts/setup/zulip-puppet-apply -f\n/etc/init.d/rabbitmq-server start # may not be needed\nscripts/setup/configure-rabbitmq\nsupervisorctl start all\n</pre></div>",
        "id": 167138,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489429948
    },
    {
        "content": "<p>here the print from putty<a href=\"/user_uploads/2/7d/hSAcv_iqZbdgEYNh0BjBYPEi/rabbitmq-error-logs.txt\" target=\"_blank\" title=\"rabbitmq-error-logs.txt\">rabbitmq-error-logs.txt</a></p>",
        "id": 167139,
        "sender_full_name": "Matthias",
        "timestamp": 1489429960
    },
    {
        "content": "<p><code>scripts/setup/zulip-puppet-apply -f</code> failed because rabbitmq seems to be purged from ubuntu</p>",
        "id": 167140,
        "sender_full_name": "Matthias",
        "timestamp": 1489429991
    },
    {
        "content": "<p>hmm, that <code>puppet</code> command should install it</p>",
        "id": 167142,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489430007
    },
    {
        "content": "<p>Looking at the logs, it appears to have been reinstalled</p>",
        "id": 167143,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489430027
    },
    {
        "content": "<p>Try starting it manually and rerunning the puppet thing?</p>",
        "id": 167145,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489430052
    },
    {
        "content": "<p>ok</p>",
        "id": 167148,
        "sender_full_name": "Matthias",
        "timestamp": 1489430069
    },
    {
        "content": "<p>sorry, what should I start manually?</p>",
        "id": 167155,
        "sender_full_name": "Matthias",
        "timestamp": 1489430177
    },
    {
        "content": "<p>Try <code>/etc/init.d/rabbitmq-server start</code></p>",
        "id": 167157,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489430195
    },
    {
        "content": "<p>excuse my ignorance. rabbits, puppets I feel I'm in a Djangol etc. <img alt=\":confused:\" class=\"emoji\" src=\"/static/generated/emoji/images/emoji/unicode/1f615.png\" title=\":confused:\"></p>",
        "id": 167160,
        "sender_full_name": "Matthias",
        "timestamp": 1489430214
    },
    {
        "content": "<p>ok</p>",
        "id": 167162,
        "sender_full_name": "Matthias",
        "timestamp": 1489430216
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>zulip@zulip:~/deployments/current$ sudo /etc/init.d/rabbitmq-server start\n[....] Starting rabbitmq-server (via systemctl): rabbitmq-server.serviceJob for rabbitmq-server.service failed because the control process exited with error code. See &quot;systemctl status rabbitmq-server.service&quot; and &quot;journalctl -xe&quot; for details.\n failed!\n</pre></div>",
        "id": 167163,
        "sender_full_name": "Matthias",
        "timestamp": 1489430258
    },
    {
        "content": "<p>ugh, rabbitmq is the worst.  Can you post what's in <code>/etc/rabbitmq/</code>?  In particular <code>rabbitmq-env.conf</code>?</p>",
        "id": 167172,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489430557
    },
    {
        "content": "<p>ok</p>",
        "id": 167174,
        "sender_full_name": "Matthias",
        "timestamp": 1489430575
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>[...]\nNODENAME=zulip@localhost\n\n# ....\n#NODE_IP_ADDRESS=127.0.0.1\n\n# Defaults to 5672.\n#NODE_PORT=5672\n</pre></div>",
        "id": 167183,
        "sender_full_name": "Matthias",
        "timestamp": 1489430696
    },
    {
        "content": "<p>there was only that one file</p>",
        "id": 167185,
        "sender_full_name": "Matthias",
        "timestamp": 1489430705
    },
    {
        "content": "<p>in the window world a reboot of the VM does miracles... would it here?</p>",
        "id": 167188,
        "sender_full_name": "Matthias",
        "timestamp": 1489430739
    },
    {
        "content": "<p>You can try it, certainly.  But first: <code>ps -ef | grep rabbitmq</code>?</p>",
        "id": 167190,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489430776
    },
    {
        "content": "<p><a href=\"/user_uploads/2/73/JooZjTTa_rMsHrnmFjBH-4TK/ps-ef-grep-rabbitmq.txt\" target=\"_blank\" title=\"ps-ef-grep-rabbitmq.txt\">ps-ef-grep-rabbitmq.txt</a></p>",
        "id": 167200,
        "sender_full_name": "Matthias",
        "timestamp": 1489430887
    },
    {
        "content": "<p>You can try <code>pkill -u rabbitmq</code> and then trying to start it again.</p>",
        "id": 167206,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489431021
    },
    {
        "content": "<p>Those processes look like they were leaked by the uninstall process (must be an Ubuntu init script bug)</p>",
        "id": 167207,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489431035
    },
    {
        "content": "<p>score! </p>\n<div class=\"codehilite\"><pre><span></span>root@zulip:~# /etc/init.d/rabbitmq-server start\n[ ok ] Starting rabbitmq-server (via systemctl): rabbitmq-server.service.\n</pre></div>",
        "id": 167213,
        "sender_full_name": "Matthias",
        "timestamp": 1489431135
    },
    {
        "content": "<p>yay</p>",
        "id": 167214,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489431163
    },
    {
        "content": "<p>OK now you need to continue with the <code>configure-rabbitmq</code> script (which basically creates the <code>zulip</code> user there and sets its password)</p>",
        "id": 167216,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489431180
    },
    {
        "content": "<p>And then you should <code>zulip-puppet-apply</code> again and start the server</p>",
        "id": 167217,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489431201
    },
    {
        "content": "<p>ah, I overlooked the <code>configure-rabbitmq</code> and already started the server with <code>supervisorctl start all</code></p>",
        "id": 167224,
        "sender_full_name": "Matthias",
        "timestamp": 1489431337
    },
    {
        "content": "<p>can i stop it again to go back to <code>configure-rabbitmq</code>?</p>",
        "id": 167226,
        "sender_full_name": "Matthias",
        "timestamp": 1489431353
    },
    {
        "content": "<p>yep</p>",
        "id": 167241,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489431557
    },
    {
        "content": "<p>ah, great. back again</p>",
        "id": 167246,
        "sender_full_name": "Matthias",
        "timestamp": 1489431599
    },
    {
        "content": "<p>works again.<br>\nis it now configured to run git upgrade?</p>",
        "id": 167249,
        "sender_full_name": "Matthias",
        "timestamp": 1489431616
    },
    {
        "content": "<p>yay</p>",
        "id": 167255,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489431663
    },
    {
        "content": "<p>If you added the <code>static_asset_compiler</code> stuff and did a puppet apply, then yes</p>",
        "id": 167258,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489431680
    },
    {
        "content": "<p>ok, do puppet apply now</p>",
        "id": 167264,
        "sender_full_name": "Matthias",
        "timestamp": 1489431711
    },
    {
        "content": "<p>OK I'm going to be AFK for 15; sorry that this was a somewhat rough upgrade <span class=\"user-mention\" data-user-email=\"m.mueller@intercultural-elements.eu\" data-user-id=\"1646\">@Matthias Müller</span>!</p>",
        "id": 167273,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489431844
    },
    {
        "content": "<p>this way would be clearer after having gone through</p>\n<ul>\n<li>Edit <code>/etc/zulip/zulip.conf</code> and add the below block to it.</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span>[rabbitmq]\nnodename = zulip@localhost\n</pre></div>\n\n\n<ul>\n<li><code>supervisorctl stop all</code></li>\n<li><code>/etc/init.d/rabbitmq-server stop</code></li>\n<li><code>apt-get purge rabbitmq-server</code> # may not be needed</li>\n<li><code>cd /home/zulip/deployment/current</code></li>\n<li><code>./scripts/zulip-puppet-apply -f</code></li>\n<li><code>pkill -u rabbitmq</code></li>\n<li><code>/etc/init.d/rabbitmq-server start</code> # may not be needed</li>\n<li><code>./scripts/setup/configure-rabbitmq</code></li>\n<li><code>supervisorctl start all</code></li>\n</ul>",
        "id": 167286,
        "sender_full_name": "Matthias",
        "timestamp": 1489432039
    },
    {
        "content": "<p>I wonder if the compose box in the legacy desktop app is even small after the git upgrade</p>",
        "id": 167292,
        "sender_full_name": "Matthias",
        "timestamp": 1489432135
    },
    {
        "content": "<p>sweet. It's done and working. Thanks <span class=\"user-mention\" data-user-email=\"tabbott@zulipchat.com\" data-user-id=\"7\">@Tim Abbott</span> and <span class=\"user-mention\" data-user-email=\"showell30@yahoo.com\" data-user-id=\"58\">@Steve Howell</span> !!! (compose box still small, but not smaller ;-)</p>",
        "id": 167312,
        "sender_full_name": "Matthias",
        "timestamp": 1489432637
    },
    {
        "content": "<p>one second... after a restart of zulip it seems to have reverted back to 1.5.1 without git</p>",
        "id": 167334,
        "sender_full_name": "Matthias",
        "timestamp": 1489433018
    },
    {
        "content": "<p>did symlink current not get updated?</p>",
        "id": 167335,
        "sender_full_name": "Matthias",
        "timestamp": 1489433040
    },
    {
        "content": "<p>ok, restart-server from /current restarts the old 1.5.1 and restart-server from the todays upgrade starts desired version ... mh</p>",
        "id": 167340,
        "sender_full_name": "Matthias",
        "timestamp": 1489433242
    },
    {
        "content": "<p>Yeah, we use <code>/next</code> to point to the thing you were trying to upgrade to</p>",
        "id": 167368,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1489435322
    },
    {
        "content": "<p>cool, just upgraded the production VM from git again and it worked without problems even though almost 1000 commits have gone by since<br>\nbut it takes some 20 minutes to complete (most of that time after it has checked whether npm 6.6.0 exists</p>\n<div class=\"codehilite\"><pre><span></span>v6.6.0 is already installed.\nNow using node v6.6.0 (npm v3.10.3)\ndefault -&gt; 6.6.0 (-&gt; v6.6.0)\n...\n</pre></div>\n\n\n<p><code>Cached version not found! Installing node modules.</code></p>\n<p>deploys here seem to be much  quicker...</p>",
        "id": 191213,
        "sender_full_name": "Matthias",
        "timestamp": 1492805879
    },
    {
        "content": "<p>how long deploying takes depends in part on how long it's been, since we have some pretty fancy caching</p>",
        "id": 191214,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1492805934
    },
    {
        "content": "<p>But still, for us, an <code>npm install</code> takes it from 1m to 2m</p>",
        "id": 191215,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1492805950
    },
    {
        "content": "<p>Do you have a good Internet connection?</p>",
        "id": 191216,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1492805955
    },
    {
        "content": "<p>I see, I suspected something like that</p>",
        "id": 191218,
        "sender_full_name": "Matthias",
        "timestamp": 1492805961
    },
    {
        "content": "<p>First time is also a bit slower, since it needs to do a git clone</p>",
        "id": 191219,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1492805988
    },
    {
        "content": "<p>Doing a <code>pip install</code> is also required if Python deps have changed significantly; that could add another few minutes</p>",
        "id": 191220,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1492806004
    },
    {
        "content": "<p>200 mbps downstream but only 100 mbps are used (network wiring needs fixing)</p>",
        "id": 191221,
        "sender_full_name": "Matthias",
        "timestamp": 1492806011
    },
    {
        "content": "<p>I guess you can test re-deploying the same version to see how that is :)</p>",
        "id": 191222,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1492806012
    },
    {
        "content": "<p>nah, not on production. another day on the test server that is only little behind the current state</p>",
        "id": 191224,
        "sender_full_name": "Matthias",
        "timestamp": 1492806055
    },
    {
        "content": "<p><code>Yarn</code> seems to be a lot faster than <code>npm</code> and it should be a simple drop in replacement</p>",
        "id": 191239,
        "sender_full_name": "Tommy Ip",
        "timestamp": 1492806752
    },
    {
        "content": "<p>200mbps should be more than plenty.  Hrm.</p>",
        "id": 191244,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1492806881
    },
    {
        "content": "<p>Does <code>/var/log/zulip/upgrade.log</code> have timestamps in it?</p>",
        "id": 191245,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1492806892
    }
]