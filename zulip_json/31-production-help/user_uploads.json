[
    {
        "content": "<p>Hi, after updating 1.9.0 -&gt; 1.9.2 all user_uploads/* return 404. Files are there. Upload mechanism works too.</p>",
        "id": 710081,
        "sender_full_name": "AcidWeb",
        "timestamp": 1551433934
    },
    {
        "content": "<p>In error.log of Zulip I see this type of errors <code>WARN [django.request] Not Found: /serve_uploads/2/6b/CvUgQ1rRpJrjwnH3Y_M5ufok/box.JPG</code></p>",
        "id": 710082,
        "sender_full_name": "AcidWeb",
        "timestamp": 1551434070
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"11510\">@AcidWeb</span> hmm, that sounds like an issue with your <code>nginx</code> configuration.</p>",
        "id": 710249,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551460316
    },
    {
        "content": "<p>Can you talk a bit about how precisely you did the upgrade?</p>",
        "id": 710250,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551460321
    },
    {
        "content": "<p>And what upload backend you're using?</p>",
        "id": 710252,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551460328
    },
    {
        "content": "<p>And maybe also what's in <code>/etc/zulip/zulip.conf</code>?</p>",
        "id": 710253,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551460345
    },
    {
        "content": "<p>Just ran into the same issue going from 1.9.1 -&gt; 2.0.0 on Trusty</p>",
        "id": 711637,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551549435
    },
    {
        "content": "<p>Upgraded via git, to the 2.0.0 tag</p>",
        "id": 711638,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551549513
    },
    {
        "content": "<p>Impacts both new uploads and old uploads (like you said probably a server config issue)</p>",
        "id": 711671,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551549993
    },
    {
        "content": "<p>Uploads don't trigger any errors, so they'll likely working</p>",
        "id": 711672,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551550008
    },
    {
        "content": "<p><code>restart-server</code> script does not resolve, neither does rebooting the server itself..</p>",
        "id": 711676,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551550034
    },
    {
        "content": "<p>conf.py:</p>\n<div class=\"codehilite\"><pre><span></span>[machine]\npuppet_classes = zulip::voyager, zulip::static_asset_compiler\ndeploy_type = voyager\n</pre></div>",
        "id": 711678,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551550138
    },
    {
        "content": "<p>nginx.conf identical to <a href=\"https://github.com/zulip/zulip/blob/master/puppet/zulip/files/nginx/nginx.conf\" target=\"_blank\" title=\"https://github.com/zulip/zulip/blob/master/puppet/zulip/files/nginx/nginx.conf\">Zulip's nginx.conf in repo</a></p>",
        "id": 711681,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551550295
    },
    {
        "content": "<p>We're using a self signed cert</p>",
        "id": 711682,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551550306
    },
    {
        "content": "<p>When I try to go to the URL of the image directly, it makes me authenticate- which I thought wasn't going to be supported on Trusty</p>",
        "id": 711684,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551550439
    },
    {
        "content": "<p>(instead images would be served without regard to authentication)</p>",
        "id": 711685,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551550461
    },
    {
        "content": "<p>Other parts of our nginx configuration files do not match the files I'm seeing at <a href=\"https://github.com/zulip/zulip/commits/master/puppet/zulip/files/nginx\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commits/master/puppet/zulip/files/nginx\">https://github.com/zulip/zulip/commits/master/puppet/zulip/files/nginx</a> </p>\n<p>Edit: Ahh, this is because of the puppet install. Looking at nginx.pp trusty gets zulip-include-maybe/direct redirected to zulip-include/uploads.route</p>",
        "id": 711691,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551551213
    },
    {
        "content": "<p>(nevermind)</p>",
        "id": 711692,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551551223
    },
    {
        "content": "<p>I remember <a href=\"https://github.com/zulip/zulip/commit/efe85453039e9ef9e1a7a503e33d8b21e91e5fa9#diff-7f650084f892af5ba032222273d372e7\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/efe85453039e9ef9e1a7a503e33d8b21e91e5fa9#diff-7f650084f892af5ba032222273d372e7\">this commit</a> is were Zulip first started authenticating local uploads, but it has support for the older versions of nginx</p>",
        "id": 711693,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551551321
    },
    {
        "content": "<p>Confirmed file uploads work, and the file is actually in the expected place. It's just not being served correctly</p>",
        "id": 711696,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551551632
    },
    {
        "content": "<p>Content-Security-Policy was added in <a href=\"https://github.com/zulip/zulip/commit/d608a9d315a3dae90033d36cdf591eb3227ce30e#diff-9b57523c22e695172bd9a625be44ddfc\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/d608a9d315a3dae90033d36cdf591eb3227ce30e#diff-9b57523c22e695172bd9a625be44ddfc\">this commit</a> to uploads-route.direct, then further modified in <a href=\"https://github.com/zulip/zulip/commit/4898fe7ebc4e249e487a84b81cf2730cb24ced33#diff-9b57523c22e695172bd9a625be44ddfc\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/4898fe7ebc4e249e487a84b81cf2730cb24ced33#diff-9b57523c22e695172bd9a625be44ddfc\">this commit</a> but removing that line doesn't result in being able to view uploads (even after full reboot)</p>",
        "id": 711697,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551551915
    },
    {
        "content": "<p>Self signed cert shouldn't be an issue, since images also fail on a machine with the self signed cert's organization certifier present (acts like a trusted cert for those machines)</p>",
        "id": 711699,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551552118
    },
    {
        "content": "<p>And we've exhausted my ability to troubleshoot. Happy to help anyone attempting to debug the issue root around.</p>",
        "id": 711703,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551552601
    },
    {
        "content": "<p>Created <a href=\"https://github.com/zulip/zulip/pull/11758\" target=\"_blank\" title=\"https://github.com/zulip/zulip/pull/11758\">#11758</a></p>",
        "id": 711710,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551553138
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3733\">@Sean Wallitsch</span> thanks for the rpeort</p>",
        "id": 711713,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551553479
    },
    {
        "content": "<p>anytime</p>",
        "id": 711714,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551553494
    },
    {
        "content": "<p>Did you say you're on Trusty?</p>",
        "id": 711715,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551553509
    },
    {
        "content": "<p>Yup</p>",
        "id": 711716,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551553524
    },
    {
        "content": "<p>What do you have in <code>/etc/nginx/zulip-include/uploads.route</code>?</p>",
        "id": 711717,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551553535
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>location /user_uploads {\n    add_header X-Content-Type-Options nosniff;\n    add_header Content-Security-Policy &quot;default-src &#39;none&#39;; style-src &#39;self&#39; &#39;unsafe-inline&#39;; img-src &#39;self&#39;; object-src &#39;self&#39;; plugin-types application/pdf;&quot;;\n    include /etc/nginx/zulip-include/uploads.types;\n    alias /home/zulip/uploads/files;\n}\n</pre></div>",
        "id": 711718,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551553572
    },
    {
        "content": "<p>do you have a block of this form in <code>zulip-enterprise.conf</code>?</p>\n<div class=\"codehilite\"><pre><span></span>    location /user_avatars {\n        add_header X-Content-Type-Options nosniff;\n        add_header Content-Security-Policy &quot;default-src &#39;none&#39; img-src &#39;self&#39;&quot;;\n        include /etc/nginx/zulip-include/uploads.types;\n        alias /home/zulip/uploads/avatars;\n    }\n</pre></div>",
        "id": 711719,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551553638
    },
    {
        "content": "<p>In the <code>nginx</code> config?</p>",
        "id": 711720,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551553652
    },
    {
        "content": "<p>yes</p>\n<div class=\"codehilite\"><pre><span></span>    location /user_avatars {\n        add_header X-Content-Type-Options nosniff;\n        add_header Content-Security-Policy &quot;default-src &#39;none&#39; img-src &#39;self&#39;&quot;;\n        include /etc/nginx/zulip-include/uploads.types;\n        alias /home/zulip/uploads/avatars;\n    }\n</pre></div>",
        "id": 711722,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551553684
    },
    {
        "content": "<p>and at the bottom.. <code>include /etc/nginx/zulip-include/uploads.route;</code></p>",
        "id": 711723,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551553696
    },
    {
        "content": "<p>Oh, I think I know what the bug is.</p>",
        "id": 711724,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551553741
    },
    {
        "content": "<p>So, can you try commenting out this block of <code>/etc/nginx/zulip-include/app</code>:</p>\n<div class=\"codehilite\"><pre><span></span># Certain Django routes not under /api are shared between mobile and\n# web and thus need API headers added.  We don&#39;t collapse this with the\n# above block for /events, because regular expressions take priority over\n# paths in nginx&#39;s order-of-operations, and we don&#39;t want to override the\n# tornado stuff.\nlocation ~ ^/(user_uploads|avatar|thumbnail)/ {\n    add_header Access-Control-Allow-Origin *;\n    add_header Access-Control-Allow-Headers Authorization;\n    add_header Access-Control-Allow-Methods &#39;GET, POST, DELETE, PUT, PATCH, HEAD&#39;;\n\n    include uwsgi_params;\n    uwsgi_pass django;\n}\n</pre></div>\n\n\n<p>and reloading <code>nginx</code>?</p>",
        "id": 711725,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551553842
    },
    {
        "content": "<p>I'll have a cleaner fix in 10 minutes</p>",
        "id": 711726,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551553850
    },
    {
        "content": "<p>But worth verifying that works</p>",
        "id": 711727,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551553855
    },
    {
        "content": "<p>on it</p>",
        "id": 711728,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551553908
    },
    {
        "content": "<p>Works</p>",
        "id": 711736,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551554157
    },
    {
        "content": "<p>cool, I'll work on a cleaner solution and plan to include that in a 2.0.1 this weekend</p>",
        "id": 711739,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551554221
    },
    {
        "content": "<p>thanks a ton man</p>",
        "id": 711741,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551554390
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3733\">@Sean Wallitsch</span> merged the cleaner solution, which it'd be great if you can verify.</p>",
        "id": 711977,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551578846
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> I'll upgrade the server later tonight and report back</p>",
        "id": 711988,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551580641
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> upgrade repeatedly failed. </p>\n<div class=\"codehilite\"><pre><span></span>ubuntu@zulip:/etc/nginx/zulip-include$ cd /home/zulip/deployments/current/scripts/\nubuntu@zulip:/home/zulip/deployments/current/scripts$ sudo ./upgrade-zulip-from-git master\n[snip]\n+ cp -R node_modules/katex/dist/fonts /home/zulip/prod-static/node_modules/katex/dist/fonts\n+ ./manage.py collectstatic --no-default-ignore --noinput -i assets -inode_modules -i styles -i templates\n\nError running a subcommand of ./tools/update-prod-static: ./manage.py collectstatic --no-default-ignore --noinput -i assets -inode_modules -i styles -i templates\nActual error output for the subcommand is just above this.\n\nTraceback (most recent call last):\n  File &quot;./tools/update-prod-static&quot;, line 85, in &lt;module&gt;\n    stdout=fp, stderr=fp)\n  File &quot;./tools/../scripts/lib/zulip_tools.py&quot;, line 196, in run\n    subprocess.check_call(args, **kwargs)\n  File &quot;/usr/lib/python3.4/subprocess.py&quot;, line 561, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;./manage.py&#39;, &#39;collectstatic&#39;, &#39;--no-default-ignore&#39;, &#39;--noinput&#39;, &#39;-i&#39;, &#39;assets&#39;, &#39;-inode_modules&#39;, &#39;-i&#39;, &#39;styles&#39;, &#39;-i&#39;, &#39;templates&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;/home/zulip/deployments/2019-03-02-20-55-46/scripts/lib/upgrade-zulip-stage-2&quot;, line 111, in &lt;module&gt;\n    preexec_fn=su_to_zulip)\n  File &quot;/usr/lib/python3.4/subprocess.py&quot;, line 561, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;./tools/update-prod-static&#39;, &#39;--authors-not-required&#39;, &#39;--prev-deploy&#39;, &#39;/home/zulip/deployments/current&#39;]&#39; returned non-zero exit status 1\nTraceback (most recent call last):\n  File &quot;./lib/upgrade-zulip-from-git&quot;, line 68, in &lt;module&gt;\n    deploy_path, &quot;--from-git&quot;] + deploy_options)\n  File &quot;/usr/lib/python3.4/subprocess.py&quot;, line 561, in check_call\n    raise CalledProcessError(retcode, cmd)\nsubprocess.CalledProcessError: Command &#39;[&#39;/home/zulip/deployments/2019-03-02-20-55-46/scripts/lib/upgrade-zulip-stage-2&#39;, &#39;/home/zulip/deployments/2019-03-02-20-55-46&#39;, &#39;--from-git&#39;]&#39; returned non-zero exit status 1\n</pre></div>",
        "id": 711994,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551590201
    },
    {
        "content": "<p>trying to upgrade to 22381f9ce</p>",
        "id": 711996,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551591141
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3733\">@Sean Wallitsch</span> interesting; can you post what you have in <code>var/log/update-prod-static.log</code> (from inside <code>/home/zulip/deployments/next</code>?</p>",
        "id": 712280,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551636308
    },
    {
        "content": "<p>That should give what the actual error was in collecting static assets.</p>",
        "id": 712281,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551636317
    },
    {
        "content": "<p>sorry, should have done that right off the bat.</p>",
        "id": 712467,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551659010
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>    [1] ./static/third/zocial/zocial.eot 62 bytes {0} [built]\n    [3] ./static/third/zocial/zocial.ttf 62 bytes {0} [built]\n    [4] ./static/third/zocial/zocial.woff 63 bytes {0} [built]\n    [6] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!./static/third/zocial/zocial.css 95.3 KiB {0} [built]\n    [7] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/portico-styles.scss 121 KiB {0} [built]\n        + 2 hidden modules\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/pygments.scss:\n    Entrypoint mini-css-extract-plugin = *\n    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/pygments.scss 16 KiB {0} [built]\n        + 1 hidden module\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/reactions.scss:\n    Entrypoint mini-css-extract-plugin = *\n    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/reactions.scss 12.2 KiB {0} [built]\n        + 1 hidden module\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/right-sidebar.scss:\n    Entrypoint mini-css-extract-plugin = *\n    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/right-sidebar.scss 8.1 KiB {0} [built]\n        + 1 hidden module\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/settings.scss:\n                 Asset       Size  Chunks             Chunk Names\n    files/dropdown.png  370 bytes          [emitted]\n    Entrypoint mini-css-extract-plugin = *\n    [0] ./static/images/dropdown.png 64 bytes {0} [built]\n    [3] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/settings.scss 74.9 KiB {0} [built]\n        + 2 hidden modules\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/stats.scss:\n    Entrypoint mini-css-extract-plugin = *\n    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/stats.scss 8.53 KiB {0} [built]\n        + 1 hidden module\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/subscriptions.scss:\n                        Asset       Size  Chunks             Chunk Names\n    files/preview-loading.png  808 bytes          [emitted]\n    Entrypoint mini-css-extract-plugin = *\n    [0] ./static/images/preview-loading.png 71 bytes {0} [built]\n    [3] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/subscriptions.scss 43.6 KiB {0} [built]\n        + 2 hidden modules\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/typing_notifications.scss:\n    Entrypoint mini-css-extract-plugin = *\n    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/typing_notifications.scss 854 bytes {0} [built]\n        + 1 hidden module\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/user_circles.scss:\n    Entrypoint mini-css-extract-plugin = *\n    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/user_circles.scss 3.6 KiB {0} [built]\n        + 1 hidden module\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/user_status.scss:\n    Entrypoint mini-css-extract-plugin = *\n    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/user_status.scss 1.37 KiB {0} [built]\n        + 1 hidden module\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/widgets.scss:\n    Entrypoint mini-css-extract-plugin = *\n    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/widgets.scss 5 KiB {0} [built]\n        + 1 hidden module\nChild mini-css-extract-plugin ../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader/index.js??ref--7-1!../../../../srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!static/styles/zulip.scss:\n    Entrypoint mini-css-extract-plugin = *\n    [1] /srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/css-loader??ref--7-1!/srv/zulip-npm-cache/f834f51a79a0a71e87978bb81f248c120e56f67b/node_modules/sass-loader/lib/loader.js??ref--7-2!./static/styles/zulip.scss 111 KiB {0} [built]\n        + 1 hidden module\nmanage.py should not be run as root. Use `su root` to switch to the &#39;zulip&#39;\nuser before rerunning this, or use\n  su root -c &#39;/home/zulip/deployments/2019-03-02-20-55-46/manage.py ...&#39;\nto switch users and run this as a single command.\n</pre></div>",
        "id": 712469,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551659184
    },
    {
        "content": "<p>yet, I'm supposed to be running <code>./upgrade-zulip-from-git</code> with sudo, correct?</p>",
        "id": 712470,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551659223
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3733\">@Sean Wallitsch</span> so my guess is the problem is that we made a change that makes running <code>upgrade-zulip-from-git</code> under <code>sudo</code> not work properly in some circumstances.  If I had to guess, it's <span class=\"user-mention\" data-user-id=\"699\">@Anders Kaseorg</span>'s work to make this function in <code>zulip_tools.py</code> taht's supposed to drop privileges from root to the <code>zulip</code> user:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">def</span> <span class=\"nf\">su_to_zulip</span><span class=\"p\">(</span><span class=\"n\">save_suid</span><span class=\"o\">=</span><span class=\"bp\">False</span><span class=\"p\">):</span>\n    <span class=\"c1\"># type: (bool) -&gt; None</span>\n    <span class=\"sd\">&quot;&quot;&quot;Warning: su_to_zulip assumes that the zulip checkout is owned by</span>\n<span class=\"sd\">    the zulip user (or whatever normal user is running the Zulip</span>\n<span class=\"sd\">    installation).  It should never be run from the installer or other</span>\n<span class=\"sd\">    production contexts before /home/zulip/deployments/current is</span>\n<span class=\"sd\">    created.&quot;&quot;&quot;</span>\n    <span class=\"n\">pwent</span> <span class=\"o\">=</span> <span class=\"n\">pwd</span><span class=\"o\">.</span><span class=\"n\">getpwuid</span><span class=\"p\">(</span><span class=\"n\">get_zulip_uid</span><span class=\"p\">())</span>\n    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">setgid</span><span class=\"p\">(</span><span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_gid</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">save_suid</span><span class=\"p\">:</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">setresuid</span><span class=\"p\">(</span><span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_uid</span><span class=\"p\">,</span> <span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_uid</span><span class=\"p\">,</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getuid</span><span class=\"p\">())</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">setuid</span><span class=\"p\">(</span><span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_uid</span><span class=\"p\">)</span>\n    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">environ</span><span class=\"p\">[</span><span class=\"s1\">&#39;HOME&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_dir</span>\n</pre></div>\n\n\n<p>in <a href=\"https://github.com/zulip/zulip/commit/ebad0b7cbf391f326f4a63448ca71ddcdb1cc303\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/ebad0b7cbf391f326f4a63448ca71ddcdb1cc303\">ebad0b7cbf391f326f4a63448ca71ddcdb1cc303</a></p>",
        "id": 712480,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551670336
    },
    {
        "content": "<p>Can you try doing a bit of print-debugging to see what <code>pw_uid</code>  is being userd here (in theory, this should be the UID of the <code>zulip</code> user)</p>",
        "id": 712481,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551670379
    },
    {
        "content": "<p>I want just confirm that commenting that nginx config block also fixed issue for me on 1.9.2.</p>",
        "id": 712510,
        "sender_full_name": "AcidWeb",
        "timestamp": 1551680202
    },
    {
        "content": "<p>I noticed one minor thing in the logs attached above in <a href=\"#narrow/stream/31-production-help/topic/user_uploads/near/711994\" title=\"#narrow/stream/31-production-help/topic/user_uploads/near/711994\">this message</a> about the <code>collecstatic</code> manage.py command:</p>\n<div class=\"codehilite\"><pre><span></span>+ ./manage.py collectstatic --no-default-ignore --noinput -i assets -inode_modules ...\n</pre></div>\n\n\n<p>There is no space after <code>-i</code> at <code>-inode_modules</code> which seems like a bug in how we pass argument for that part. I don't know if that make a lot of difference but just something I noticed.</p>",
        "id": 712703,
        "sender_full_name": "Priyank Patel",
        "timestamp": 1551715985
    },
    {
        "content": "<p>Looking at <code>tools/update-prod-static</code> we are missing a comma after on <a href=\"https://github.com/zulip/zulip/blob/7d12e2019de5bc2311ea8b1060ff917f8aa5c7c2/tools/update-prod-static#L84\" target=\"_blank\" title=\"https://github.com/zulip/zulip/blob/7d12e2019de5bc2311ea8b1060ff917f8aa5c7c2/tools/update-prod-static#L84\">line 84</a> which causes <code>-inode_modules</code> and was introduced in <a href=\"https://github.com/zulip/zulip/commit/d71f2e7b9bd2e1e622237eee381b62813b8ecaaa\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/d71f2e7b9bd2e1e622237eee381b62813b8ecaaa\">d71f2e7b9bd2e1e622237eee381b62813b8ecaaa</a>.</p>",
        "id": 712707,
        "sender_full_name": "Priyank Patel",
        "timestamp": 1551716396
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"4241\">@Priyank</span> hmm, interesting.  It's possible that the argument parsing for <code>manage.py collectstatic</code> is such that this happens to work, but certainly we should change it.  I'm going to test fixing that to be how the code is clearly intended to read...</p>",
        "id": 712710,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551716976
    },
    {
        "content": "<p>I can try some troubleshooting tonight</p>",
        "id": 712826,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551720907
    },
    {
        "content": "<p>I've added print debugging and am attempting an upgrade</p>",
        "id": 712927,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551730731
    },
    {
        "content": "<p>As expected, this doesn't seem to be changing to the user correctly.</p>\n<div class=\"codehilite\"><pre><span></span>su_to_zulip: pwent.pw_gid is 0\nsu_to_zulip: os.getgid is 0\nsu_to_zulip: os.setuid result: 0\nsu_to_zulip: $HOME set result: /root\n</pre></div>\n\n\n<p>the zulip id is 1002</p>\n<p>my print statements:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">def</span> <span class=\"nf\">su_to_zulip</span><span class=\"p\">(</span><span class=\"n\">save_suid</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n    <span class=\"c1\"># type: (bool) -&gt; None</span>\n    <span class=\"sd\">&quot;&quot;&quot;Warning: su_to_zulip assumes that the zulip checkout is owned by</span>\n<span class=\"sd\">    the zulip user (or whatever normal user is running the Zulip</span>\n<span class=\"sd\">    installation).  It should never be run from the installer or other</span>\n<span class=\"sd\">    production contexts before /home/zulip/deployments/current is</span>\n<span class=\"sd\">    created.&quot;&quot;&quot;</span>\n    <span class=\"n\">pwent</span> <span class=\"o\">=</span> <span class=\"n\">pwd</span><span class=\"o\">.</span><span class=\"n\">getpwuid</span><span class=\"p\">(</span><span class=\"n\">get_zulip_uid</span><span class=\"p\">())</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;su_to_zulip: pwent.pw_gid is </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_gid</span><span class=\"p\">))</span>\n    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">setgid</span><span class=\"p\">(</span><span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_gid</span><span class=\"p\">)</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;su_to_zulip: os.getgid is </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getgid</span><span class=\"p\">()))</span>\n    <span class=\"k\">if</span> <span class=\"n\">save_suid</span><span class=\"p\">:</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;Attempting os.setresuid with: </span><span class=\"si\">{}</span><span class=\"s2\"> </span><span class=\"si\">{}</span><span class=\"s2\"> </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_uid</span><span class=\"p\">,</span> <span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_uid</span><span class=\"p\">,</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getuid</span><span class=\"p\">()))</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">setresuid</span><span class=\"p\">(</span><span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_uid</span><span class=\"p\">,</span> <span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_uid</span><span class=\"p\">,</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getuid</span><span class=\"p\">())</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;su_to_zulip: os.setresuid results: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getresuid</span><span class=\"p\">()</span>\n        <span class=\"p\">))</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">setuid</span><span class=\"p\">(</span><span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_uid</span><span class=\"p\">)</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;su_to_zulip: os.setuid result: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getuid</span><span class=\"p\">()))</span>\n    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">environ</span><span class=\"p\">[</span><span class=\"s1\">&#39;HOME&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">pwent</span><span class=\"o\">.</span><span class=\"n\">pw_dir</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;su_to_zulip: $HOME set result: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">environ</span><span class=\"p\">[</span><span class=\"s1\">&#39;HOME&#39;</span><span class=\"p\">]))</span>\n</pre></div>",
        "id": 712929,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551731005
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"3733\">@Sean Wallitsch</span> I guess it's <code>get_zulip_uid</code> you should be print-debugging.</p>",
        "id": 712995,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551733982
    },
    {
        "content": "<p>yup.</p>",
        "id": 713000,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551734744
    },
    {
        "content": "<p>after looking at how that's working, it's likely because all of these upgrade directories are being owned by root</p>",
        "id": 713001,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551734759
    },
    {
        "content": "<p>the last directory to be owned by zulip was the 2.0 upgrade</p>",
        "id": 713002,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551734777
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>drwxr-xr-x 26 zulip zulip 4096 Mar  2 09:27 2019-03-02-09-22-50/\ndrwxr-xr-x 24 root  root  4096 Mar  2 20:50 2019-03-02-20-48-46/\ndrwxr-xr-x 24 root  root  4096 Mar  2 20:53 2019-03-02-20-52-50/\ndrwxr-xr-x 24 root  root  4096 Mar  2 20:56 2019-03-02-20-55-46/\ndrwxr-xr-x 24 root  root  4096 Mar  4 12:21 2019-03-04-12-20-19/\n</pre></div>",
        "id": 713003,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551734791
    },
    {
        "content": "<p>I'm proceeding with the print debugging though</p>",
        "id": 713005,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551734800
    },
    {
        "content": "<p>yup, eveerything during the upgrade is set as root....</p>\n<div class=\"codehilite\"><pre><span></span>filepath: /home/zulip/deployments/2019-03-04-13-31-05/scripts/lib/zulip_tools.py\nfile owner: 0\ndir path: /home/zulip/deployments/2019-03-04-13-31-05/scripts/lib\ndir owner 0\ndir2 path: /home/zulip/deployments/2019-03-04-13-31-05/scripts\ndir2 owner: 0\ndir3 path: /home/zulip/deployments/2019-03-04-13-31-05\ndir3 owner: 0\ndeploy root: /home/zulip/deployments/2019-03-04-13-31-05\nfilepath: /home/zulip/deployments/2019-03-04-13-31-05/scripts/lib/zulip_tools.py\nfile owner: 0\ndir path: /home/zulip/deployments/2019-03-04-13-31-05/scripts/lib\ndir owner 0\ndir2 path: /home/zulip/deployments/2019-03-04-13-31-05/scripts\ndir2 owner: 0\ndir3 path: /home/zulip/deployments/2019-03-04-13-31-05\ndir3 owner: 0\nsu_to_zulip: pwent.pw_gid is 0\nsu_to_zulip: os.getgid is 0\nsu_to_zulip: os.setuid result: 0\nsu_to_zulip: $HOME set result: /root\n</pre></div>",
        "id": 713010,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551735136
    },
    {
        "content": "<p>debugging code:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">def</span> <span class=\"nf\">get_deploy_root</span><span class=\"p\">()</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span>\n    <span class=\"c1\"># This calls realpath twice to handle both symlinks and users</span>\n    <span class=\"c1\"># running our scripts with relative paths from a current working</span>\n    <span class=\"c1\"># directory of `scripts/`.</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;filepath: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">))))</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;file owner: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">stat</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)))</span><span class=\"o\">.</span><span class=\"n\">st_uid</span><span class=\"p\">))</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;dir path: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)))))</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;dir owner </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">stat</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">))))</span><span class=\"o\">.</span><span class=\"n\">st_uid</span><span class=\"p\">))</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;dir2 path: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">))))))</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;dir2 owner: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">stat</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)))))</span><span class=\"o\">.</span><span class=\"n\">st_uid</span><span class=\"p\">))</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;dir3 path: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)))))))</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;dir3 owner: </span><span class=\"si\">{}</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">stat</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">))))))</span><span class=\"o\">.</span><span class=\"n\">st_uid</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">realpath</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)))))</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">get_zulip_uid</span><span class=\"p\">()</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">int</span><span class=\"p\">:</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;deploy root: </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">get_deploy_root</span><span class=\"p\">()))</span>\n    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">stat</span><span class=\"p\">(</span><span class=\"n\">get_deploy_root</span><span class=\"p\">())</span><span class=\"o\">.</span><span class=\"n\">st_uid</span>\n</pre></div>",
        "id": 713013,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551735198
    },
    {
        "content": "<p>OK, weird -- how are you doing the upgrade?</p>",
        "id": 713025,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551736094
    },
    {
        "content": "<p><code>ubuntu@zulip:/home/zulip/deployments/current/scripts$ sudo ./upgrade-zulip-from-git master</code></p>",
        "id": 713026,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736124
    },
    {
        "content": "<p>current is currently owned by the zulip user still</p>",
        "id": 713027,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736136
    },
    {
        "content": "<p>and this was how I upgraded to 2.0</p>",
        "id": 713028,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736144
    },
    {
        "content": "<p>I have a theory</p>",
        "id": 713030,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551736156
    },
    {
        "content": "<p>So, on <a href=\"http://chat.zulip.org\" target=\"_blank\" title=\"http://chat.zulip.org\">chat.zulip.org</a>, they are all owned by <code>zulip</code>.</p>",
        "id": 713032,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551736174
    },
    {
        "content": "<p>But the logic for computing the zulip uid copies the user ID from the last deployment...</p>",
        "id": 713033,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551736214
    },
    {
        "content": "<p>So if you got one owned by root somehow, you could get into this state where new ones preserve that.</p>",
        "id": 713035,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551736243
    },
    {
        "content": "<p>hmm, let me rm all the other deployment dirs. do I need to redirect <code>next</code>?</p>",
        "id": 713036,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736338
    },
    {
        "content": "<p>Just chown them</p>",
        "id": 713037,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551736355
    },
    {
        "content": "<p>It only uses the realpath of <code>current</code> (aka what the symlink points to) for this determination</p>",
        "id": 713038,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551736362
    },
    {
        "content": "<p>current is owned by zulip already :/</p>",
        "id": 713039,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736482
    },
    {
        "content": "<p>The symlink is, but its destination is not</p>",
        "id": 713040,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551736493
    },
    {
        "content": "<p>And we follow symlinks before reading the owner.</p>",
        "id": 713041,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551736511
    },
    {
        "content": "<p>no, I meant, the deployment dir that current was pointing to</p>",
        "id": 713042,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736529
    },
    {
        "content": "<p>was already owned by zulip</p>",
        "id": 713043,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736533
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>drwxr-xr-x  9 zulip zulip 4096 Mar  4 13:32 ./\ndrwxr-xr-x 13 zulip zulip 4096 Apr 12  2018 ../\ndrwxr-xr-x 26 zulip zulip 4096 Nov  8 21:59 2018-11-09-13-53-50/\ndrwxr-xr-x 26 zulip zulip 4096 Mar  2 09:27 2019-03-02-09-22-50/\ndrwxr-xr-x 24 zulip zulip 4096 Mar  2 20:50 2019-03-02-20-48-46/\ndrwxr-xr-x 24 root  root  4096 Mar  2 20:53 2019-03-02-20-52-50/\ndrwxr-xr-x 24 root  root  4096 Mar  2 20:56 2019-03-02-20-55-46/\ndrwxr-xr-x 24 root  root  4096 Mar  4 12:21 2019-03-04-12-20-19/\ndrwxr-xr-x 24 root  root  4096 Mar  4 13:31 2019-03-04-13-31-05/\nlrwxrwxrwx  1 zulip zulip   43 Mar  2 09:29 current -&gt; /home/zulip/deployments/2019-03-02-09-22-50/\nlrwxrwxrwx  1 zulip zulip   43 Mar  2 09:29 last -&gt; /home/zulip/deployments/2018-11-09-13-53-50/\nlrwxrwxrwx  1 root  root    43 Mar  4 13:31 next -&gt; /home/zulip/deployments/2019-03-04-13-31-05/\nsrwx------  1 zulip zulip    0 Mar  3 06:00 uwsgi-socket=\n</pre></div>\n\n\n<p>(I've only chown'd <code>2019-03-02-20-48-46</code> at this point)</p>",
        "id": 713045,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736582
    },
    {
        "content": "<p>all chown's complete. attempting upgrade</p>",
        "id": 713046,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736667
    },
    {
        "content": "<p>new deployment is still owned by root, so this one is about to fail</p>",
        "id": 713047,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736730
    },
    {
        "content": "<p>I'm assuming there's some installs that don't use the <code>zulip</code> user, otherwise we'd just be using <code>pwd.getpwnam('zulip').pw_uid</code></p>",
        "id": 713049,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551736869
    },
    {
        "content": "<p>OK, well, <span class=\"user-mention\" data-user-id=\"3733\">@Sean Wallitsch</span> I'm about to merge a fix for this.</p>",
        "id": 713053,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551737931
    },
    {
        "content": "<p>I can test immediately</p>",
        "id": 713054,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551737946
    },
    {
        "content": "<p>or even your PR if you'd like</p>",
        "id": 713055,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551737962
    },
    {
        "content": "<p>About to merge to master; is there an issue ID for this?</p>",
        "id": 713056,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551738158
    },
    {
        "content": "<p>Appears not, fixed in <a href=\"https://github.com/zulip/zulip/commit/b3444354aacada3243df568e75d51846e04a8c34\" target=\"_blank\" title=\"https://github.com/zulip/zulip/commit/b3444354aacada3243df568e75d51846e04a8c34\">b3444354aacada3243df568e75d51846e04a8c34</a></p>",
        "id": 713059,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551738472
    },
    {
        "content": "<p>Sorry, had someone in my office. Attempting upgrade now</p>",
        "id": 713068,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551738824
    },
    {
        "content": "<p>hmm, new error.</p>\n<div class=\"codehilite\"><pre><span></span>2019-03-04 22:36:47,559 upgrade-zulip-stage-2: Building static assets...\nTraceback (most recent call last):\n  File &quot;./tools/update-prod-static&quot;, line 34, in &lt;module&gt;\n    os.makedirs(&quot;var/log&quot;, exist_ok=True)\n  File &quot;/usr/lib/python3.4/os.py&quot;, line 227, in makedirs\n    makedirs(head, mode, exist_ok)\n  File &quot;/usr/lib/python3.4/os.py&quot;, line 237, in makedirs\n    mkdir(name, mode)\nPermissionError: [Errno 13] Permission denied: &#39;var&#39;\n</pre></div>\n\n\n<p>Hmm</p>\n<p>this is likely running into an issue because all the new deployments are still showing up as belonging to root</p>",
        "id": 713076,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551739167
    },
    {
        "content": "<p>the zulip user can't create ./var/log</p>",
        "id": 713078,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551739300
    },
    {
        "content": "<p>and it's failing at an earlier step because we're actually getting the zulip user now</p>",
        "id": 713079,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551739447
    },
    {
        "content": "<p>upgrade-zulip-from-git is what creates that dir. I at least have been looking at this wrong</p>",
        "id": 713081,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551739699
    },
    {
        "content": "<p><del>it's not something that broke since 2.0, the upgrade script deployed broken in 2.0</del></p>",
        "id": 713082,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551739714
    },
    {
        "content": "<p><del>since we use the current/ script</del></p>",
        "id": 713083,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551739724
    },
    {
        "content": "<p><del>in 1.9, (when it was in <code>lib/</code>) the git clone looked like <a href=\"https://github.com/zulip/zulip/blob/1.9.0/scripts/lib/upgrade-zulip-from-git\" target=\"_blank\" title=\"https://github.com/zulip/zulip/blob/1.9.0/scripts/lib/upgrade-zulip-from-git\">this</a>:</del></p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">try</span><span class=\"p\">:</span>\n    <span class=\"n\">deploy_path</span> <span class=\"o\">=</span> <span class=\"n\">make_deploy_path</span><span class=\"p\">()</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">(</span><span class=\"n\">LOCAL_GIT_CACHE_DIR</span><span class=\"p\">):</span>\n        <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cloning the repository&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">check_call</span><span class=\"p\">([</span><span class=\"s2\">&quot;git&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;clone&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;-q&quot;</span><span class=\"p\">,</span> <span class=\"n\">remote_url</span><span class=\"p\">,</span> <span class=\"s2\">&quot;--mirror&quot;</span><span class=\"p\">,</span> <span class=\"n\">LOCAL_GIT_CACHE_DIR</span><span class=\"p\">],</span>\n                              <span class=\"n\">stdout</span><span class=\"o\">=</span><span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"s1\">&#39;/dev/null&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">))</span>\n        <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">check_call</span><span class=\"p\">([</span><span class=\"s2\">&quot;chown&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;-R&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;zulip:zulip&quot;</span><span class=\"p\">,</span> <span class=\"n\">LOCAL_GIT_CACHE_DIR</span><span class=\"p\">])</span>\n</pre></div>",
        "id": 713087,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551739906
    },
    {
        "content": "<p><del>in 2.0, it now looks like:</del></p>\n<div class=\"codehilite\"><pre><span></span>    <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">check_call</span><span class=\"p\">([</span><span class=\"s2\">&quot;git&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;clone&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;-q&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;-b&quot;</span><span class=\"p\">,</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">LOCAL_GIT_CACHE_DIR</span><span class=\"p\">,</span> <span class=\"n\">deploy_path</span><span class=\"p\">],</span>\n                          <span class=\"n\">stdout</span><span class=\"o\">=</span><span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"s1\">&#39;/dev/null&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">),</span>\n                          <span class=\"n\">preexec_fn</span><span class=\"o\">=</span><span class=\"n\">su_to_zulip</span><span class=\"p\">)</span>\n    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">chdir</span><span class=\"p\">(</span><span class=\"n\">deploy_path</span><span class=\"p\">)</span>\n</pre></div>",
        "id": 713088,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551739993
    },
    {
        "content": "<p><del>and the su_to_zulip is broken in my 2.0 deployment :D (for me at least)</del></p>",
        "id": 713089,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551740068
    },
    {
        "content": "<p><del>I'm going to manually modify my upgrade-zulip-from-git script to remove the preexec_fn and use the old subprocess check. That'll get me to the working su_to_zulip function, and future upgrades won't need the manually modified script</del></p>",
        "id": 713090,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551740170
    },
    {
        "content": "<p>nevermind most of that. We still do the manual chown in 2.0, if the <code>LOCAL_GIT_CACHE_DIR</code> doesn't exist</p>",
        "id": 713091,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551740585
    },
    {
        "content": "<p>mine exists though, so it skips that check, and uses the (for me, in 2.0) broken su_to_zulip</p>",
        "id": 713092,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551740622
    },
    {
        "content": "<p><del>I should be able to fix this by deleting the LOCAL_GIT_CACHE_DIR</del> nope, that alone doesn't work because it's followed by a bunch of git commands which attempt the broken su_to_zulip.</p>",
        "id": 713093,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551740635
    },
    {
        "content": "<p>I've manually edited zulip_tools.py to return my zulip user's PID of 1002 for su_to_zulip</p>",
        "id": 713096,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551741286
    },
    {
        "content": "<p>that was enough to fix \"next\"'s ownership issues</p>",
        "id": 713097,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551741347
    },
    {
        "content": "<p>new error somewhere in <code>generate_zulip_bots_static_files.py</code></p>",
        "id": 713104,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551742392
    },
    {
        "content": "<p>but no real error message in the console or logs..</p>",
        "id": 713106,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551742441
    },
    {
        "content": "<p>and of course, all generate_zulip_bots_static_files does is copy files.. and all the permissions on it's destination are correct.</p>",
        "id": 713111,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551742986
    },
    {
        "content": "<p>looks like it failed because it detected the bots_dir static files existed in ~/prod-static and tried to rmtree it</p>",
        "id": 713115,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551743154
    },
    {
        "content": "<p>which failed, because root owns it.. due to all the other problems</p>",
        "id": 713116,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551743324
    },
    {
        "content": "<p>We're upgraded and pointed at master now <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> <span aria-label=\"octopus\" class=\"emoji emoji-1f419\" role=\"img\" title=\"octopus\">:octopus:</span></p>",
        "id": 713120,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551743591
    },
    {
        "content": "<p>1) I had to manually edit zulip_tools.py to include <span class=\"user-mention\" data-user-id=\"7\">@Tim Abbott</span> 's latest changes, because otherwise the broken su_to_zulip function was being called<br>\n2) I had to clear out all the 'root' files that the previous upgrade attempts had created<br>\n3) I had to learn to let go.</p>",
        "id": 713121,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551743652
    },
    {
        "content": "<p>Great, thanks for all the debugging details!</p>",
        "id": 713140,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1551745289
    },
    {
        "content": "<p>haha sorry for all the debugging details</p>",
        "id": 713151,
        "sender_full_name": "Sean Wallitsch",
        "timestamp": 1551746139
    }
]