[
    {
        "content": "<p>I'm setting up a new 4.8 server with AWS S3 as file upload backend. I run it on an EC2 instance and credentials are provided via an IAM role configured for the instance. I have the same setup on an older Zulip server, but on this new server I get  <code>Internal server error</code> when I try to upload a file.</p>\n<p>I find this in <strong>errors.log</strong>:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">01</span> <span class=\"mi\">09</span><span class=\"p\">:</span><span class=\"mi\">51</span><span class=\"p\">:</span><span class=\"mf\">43.859</span> <span class=\"n\">ERR</span>  <span class=\"p\">[</span><span class=\"n\">zerver</span><span class=\"o\">.</span><span class=\"n\">middleware</span><span class=\"o\">.</span><span class=\"n\">json_error_handler</span><span class=\"p\">]</span> <span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">181</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_get_response</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">wrapped_callback</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">callback_args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">callback_kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/lib/rest.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">33</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_wrapped_view_func</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">view_func</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/csrf.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">54</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">wrapped_view</span>\n    <span class=\"k\">return</span> <span class=\"n\">view_func</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/lib/rest.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">166</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">rest_dispatch</span>\n    <span class=\"k\">return</span> <span class=\"n\">target_function</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/django/utils/decorators.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">130</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_wrapped_view</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">view_func</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/decorator.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">751</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_wrapped_view_func</span>\n    <span class=\"k\">return</span> <span class=\"n\">authenticate_log_and_execute_json</span><span class=\"p\">(</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/decorator.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">738</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">authenticate_log_and_execute_json</span>\n    <span class=\"k\">return</span> <span class=\"n\">limited_view_func</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">user_profile</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/decorator.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">880</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">wrapped_func</span>\n    <span class=\"k\">return</span> <span class=\"n\">func</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/views/upload.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">130</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">upload_file_backend</span>\n    <span class=\"n\">uri</span> <span class=\"o\">=</span> <span class=\"n\">upload_message_image_from_request</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">user_file</span><span class=\"p\">,</span> <span class=\"n\">user_profile</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/lib/upload.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1068</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">upload_message_image_from_request</span>\n    <span class=\"k\">return</span> <span class=\"n\">upload_message_file</span><span class=\"p\">(</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/lib/upload.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1023</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">upload_message_file</span>\n    <span class=\"k\">return</span> <span class=\"n\">upload_backend</span><span class=\"o\">.</span><span class=\"n\">upload_message_file</span><span class=\"p\">(</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/lib/upload.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">488</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">upload_message_file</span>\n    <span class=\"n\">upload_image_to_s3</span><span class=\"p\">(</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-01-01-08-43-34/./zerver/lib/upload.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">331</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">upload_image_to_s3</span>\n    <span class=\"n\">key</span><span class=\"o\">.</span><span class=\"n\">put</span><span class=\"p\">(</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/boto3/resources/factory.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">520</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">do_action</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">action</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/boto3/resources/action.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">83</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"fm\">__call__</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">parent</span><span class=\"o\">.</span><span class=\"n\">meta</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"p\">,</span> <span class=\"n\">operation_name</span><span class=\"p\">)(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">params</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/client.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">388</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_api_call</span>\n    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_make_api_call</span><span class=\"p\">(</span><span class=\"n\">operation_name</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/client.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">694</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_make_api_call</span>\n    <span class=\"n\">http</span><span class=\"p\">,</span> <span class=\"n\">parsed_response</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_make_request</span><span class=\"p\">(</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/client.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">714</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_make_request</span>\n    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_endpoint</span><span class=\"o\">.</span><span class=\"n\">make_request</span><span class=\"p\">(</span><span class=\"n\">operation_model</span><span class=\"p\">,</span> <span class=\"n\">request_dict</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/endpoint.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">102</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">make_request</span>\n    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_send_request</span><span class=\"p\">(</span><span class=\"n\">request_dict</span><span class=\"p\">,</span> <span class=\"n\">operation_model</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/endpoint.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">132</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_send_request</span>\n    <span class=\"n\">request</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">create_request</span><span class=\"p\">(</span><span class=\"n\">request_dict</span><span class=\"p\">,</span> <span class=\"n\">operation_model</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/endpoint.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">115</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">create_request</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_emitter</span><span class=\"o\">.</span><span class=\"n\">emit</span><span class=\"p\">(</span><span class=\"n\">event_name</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"o\">=</span><span class=\"n\">request</span><span class=\"p\">,</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/hooks.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">357</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">emit</span>\n    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_emitter</span><span class=\"o\">.</span><span class=\"n\">emit</span><span class=\"p\">(</span><span class=\"n\">aliased_event_name</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/hooks.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">228</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">emit</span>\n    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_emit</span><span class=\"p\">(</span><span class=\"n\">event_name</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/hooks.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">211</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_emit</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">handler</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/signers.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">93</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">handler</span>\n    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sign</span><span class=\"p\">(</span><span class=\"n\">operation_name</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/signers.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">165</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">sign</span>\n    <span class=\"n\">auth</span><span class=\"o\">.</span><span class=\"n\">add_auth</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/a7fb0fe17c8b91b591927bfa8f133a90b20f3d18/zulip-py3-venv/lib/python3.8/site-packages/botocore/auth.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">378</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">add_auth</span>\n    <span class=\"k\">raise</span> <span class=\"n\">NoCredentialsError</span><span class=\"p\">()</span>\n<span class=\"n\">botocore</span><span class=\"o\">.</span><span class=\"n\">exceptions</span><span class=\"o\">.</span><span class=\"n\">NoCredentialsError</span><span class=\"p\">:</span> <span class=\"n\">Unable</span> <span class=\"n\">to</span> <span class=\"n\">locate</span> <span class=\"n\">credentials</span>\n\n<span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">01</span> <span class=\"mi\">09</span><span class=\"p\">:</span><span class=\"mi\">51</span><span class=\"p\">:</span><span class=\"mf\">43.873</span> <span class=\"n\">ERR</span>  <span class=\"p\">[</span><span class=\"n\">django</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"p\">]</span> <span class=\"n\">Internal</span> <span class=\"n\">Server</span> <span class=\"n\">Error</span><span class=\"p\">:</span> <span class=\"o\">/</span><span class=\"n\">json</span><span class=\"o\">/</span><span class=\"n\">user_uploads</span>\n</code></pre></div>\n<p>I enabled debug logging for botocore and find this in <strong>workers.log</strong>:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">01</span> <span class=\"mi\">08</span><span class=\"p\">:</span><span class=\"mi\">55</span><span class=\"p\">:</span><span class=\"mf\">15.690</span> <span class=\"n\">DEBG</span> <span class=\"p\">[</span><span class=\"n\">botocore</span><span class=\"o\">.</span><span class=\"n\">credentials</span><span class=\"p\">]</span> <span class=\"n\">Looking</span> <span class=\"k\">for</span> <span class=\"n\">credentials</span> <span class=\"n\">via</span><span class=\"p\">:</span> <span class=\"n\">iam</span><span class=\"o\">-</span><span class=\"n\">role</span>\n<span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">01</span> <span class=\"mi\">08</span><span class=\"p\">:</span><span class=\"mi\">55</span><span class=\"p\">:</span><span class=\"mf\">15.692</span> <span class=\"n\">DEBG</span> <span class=\"p\">[</span><span class=\"n\">botocore</span><span class=\"o\">.</span><span class=\"n\">utils</span><span class=\"p\">]</span> <span class=\"n\">Metadata</span> <span class=\"n\">service</span> <span class=\"n\">returned</span> <span class=\"n\">non</span><span class=\"o\">-</span><span class=\"mi\">200</span> <span class=\"n\">response</span> <span class=\"k\">with</span> <span class=\"n\">status</span> <span class=\"n\">code</span> <span class=\"n\">of</span> <span class=\"mi\">407</span> <span class=\"k\">for</span> <span class=\"n\">url</span><span class=\"p\">:</span> <span class=\"n\">http</span><span class=\"p\">:</span><span class=\"o\">//</span><span class=\"mf\">169.254.169.254</span><span class=\"o\">/</span><span class=\"n\">latest</span><span class=\"o\">/</span><span class=\"n\">meta</span><span class=\"o\">-</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">iam</span><span class=\"o\">/</span><span class=\"n\">security</span><span class=\"o\">-</span><span class=\"n\">credentials</span><span class=\"o\">/</span><span class=\"p\">,</span> <span class=\"n\">content</span> <span class=\"n\">body</span><span class=\"p\">:</span> <span class=\"sa\">b</span><span class=\"s2\">\"Egress proxying is denied to host '169.254.169.254': The destination address (169.254.169.254) was denied by rule 'Deny: Not Global Unicast'. destination address was denied by rule, see error.</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">01</span> <span class=\"mi\">08</span><span class=\"p\">:</span><span class=\"mi\">55</span><span class=\"p\">:</span><span class=\"mf\">15.692</span> <span class=\"n\">DEBG</span> <span class=\"p\">[</span><span class=\"n\">botocore</span><span class=\"o\">.</span><span class=\"n\">utils</span><span class=\"p\">]</span> <span class=\"n\">Max</span> <span class=\"n\">number</span> <span class=\"n\">of</span> <span class=\"n\">attempts</span> <span class=\"n\">exceeded</span> <span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"n\">when</span> <span class=\"n\">attempting</span> <span class=\"n\">to</span> <span class=\"n\">retrieve</span> <span class=\"n\">data</span> <span class=\"kn\">from</span> <span class=\"nn\">metadata</span> <span class=\"n\">service</span><span class=\"o\">.</span>\n</code></pre></div>\n<p>I'm guessing this is Smokescreen at work. How can I configure it to allow access to the AWS instance metadata service?</p>",
        "id": 1303045,
        "sender_full_name": "Ed",
        "timestamp": 1641031076
    },
    {
        "content": "<p><strong>smokescreen.log</strong> indeed says:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span><span class=\"nt\">\"allow\"</span><span class=\"p\">:</span><span class=\"kc\">false</span><span class=\"p\">,</span><span class=\"nt\">\"content_length\"</span><span class=\"p\">:</span><span class=\"mi\">193</span><span class=\"p\">,</span><span class=\"nt\">\"decision_reason\"</span><span class=\"p\">:</span><span class=\"s2\">\"The destination address (169.254.169.254) was denied by rule 'Deny: Not Global Unicast'. destination address was denied by rule, see error\"</span><span class=\"p\">,</span><span class=\"nt\">\"enforce_would_deny\"</span><span class=\"p\">:</span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"nt\">\"id\"</span><span class=\"p\">:</span><span class=\"s2\">\"c781dvmmuaukpjjbcjv0\"</span><span class=\"p\">,</span><span class=\"nt\">\"inbound_remote_addr\"</span><span class=\"p\">:</span><span class=\"s2\">\"127.0.0.1:47888\"</span><span class=\"p\">,</span><span class=\"nt\">\"level\"</span><span class=\"p\">:</span><span class=\"s2\">\"warning\"</span><span class=\"p\">,</span><span class=\"nt\">\"msg\"</span><span class=\"p\">:</span><span class=\"s2\">\"CANONICAL-PROXY-DECISION\"</span><span class=\"p\">,</span><span class=\"nt\">\"project\"</span><span class=\"p\">:</span><span class=\"s2\">\"\"</span><span class=\"p\">,</span><span class=\"nt\">\"proxy_type\"</span><span class=\"p\">:</span><span class=\"s2\">\"http\"</span><span class=\"p\">,</span><span class=\"nt\">\"requested_host\"</span><span class=\"p\">:</span><span class=\"s2\">\"169.254.169.254\"</span><span class=\"p\">,</span><span class=\"nt\">\"role\"</span><span class=\"p\">:</span><span class=\"s2\">\"\"</span><span class=\"p\">,</span><span class=\"nt\">\"start_time\"</span><span class=\"p\">:</span><span class=\"s2\">\"2022-01-01T08:55:26.13158517Z\"</span><span class=\"p\">,</span><span class=\"nt\">\"time\"</span><span class=\"p\">:</span><span class=\"s2\">\"2022-01-01T08:55:26Z\"</span><span class=\"p\">,</span><span class=\"nt\">\"trace_id\"</span><span class=\"p\">:</span><span class=\"s2\">\"\"</span><span class=\"p\">}</span>\n</code></pre></div>",
        "id": 1303049,
        "sender_full_name": "Ed",
        "timestamp": 1641031511
    },
    {
        "content": "<p>Okay, so I got this working by editing <strong>/etc/supervisor/conf.d/zulip/smokescreen.conf</strong> to add <code>--allow-address 169.254.169.254</code> to the <code>command</code> parameter and then doing a <code>sudo supervisorctl update smokescreen</code>.</p>",
        "id": 1303061,
        "sender_full_name": "Ed",
        "timestamp": 1641040070
    },
    {
        "content": "<p>Also, Happy New Year! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 1303062,
        "sender_full_name": "Ed",
        "timestamp": 1641040128
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"16628\">@Ed</span> Glad you got it working, but I’ll add a security note: if you allow 169.254.169.254 through Smokescreen, you should make sure you’re <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html\">using</a> and <a href=\"https://aws.amazon.com/premiumsupport/knowledge-center/ssm-ec2-enforce-imdsv2/\">enforcing</a> IMDSv2 (<a href=\"https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/\">rationale</a>).</p>",
        "id": 1303168,
        "sender_full_name": "Anders Kaseorg",
        "timestamp": 1641078358
    },
    {
        "content": "<p>Thanks, <span class=\"user-mention\" data-user-id=\"699\">@Anders Kaseorg</span>. I set up IMDSv2 to required and everything works as expected.</p>\n<p>I don't know if there's a way to have this set up properly as part of the install scripts but maybe it's worth mentioning somewhere in the docs.</p>",
        "id": 1303200,
        "sender_full_name": "Ed",
        "timestamp": 1641101030
    },
    {
        "content": "<p>I think it'd probably be reasonable to mention something related to this in the \"S3 uploads backend\" documentation; <span class=\"user-mention\" data-user-id=\"12178\">@Alex Vandiver</span> thoughts?</p>",
        "id": 1303577,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1641245244
    },
    {
        "content": "<p>We should possibly exempt boto from the proxy, rather than make folks reconfigure Smokescreen as well as lock down IMDS</p>",
        "id": 1303591,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1641245985
    },
    {
        "content": "<p>Yeah, that's probably a better solution.</p>",
        "id": 1303598,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1641246609
    },
    {
        "content": "<p>Filed <a href=\"https://github.com/zulip/zulip/pull/20715\">#20715</a>.</p>",
        "id": 1306207,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1641584006
    },
    {
        "content": "<p>Hello, Can I claim this issue since no one is working on this one?? Also this looks easy it won't take much time to get fixed??</p>",
        "id": 1308801,
        "sender_full_name": "Shubh Gupta",
        "timestamp": 1641985941
    },
    {
        "content": "<p>ok so since I haven't contributed before, the bot is not letting me claim this issue. Can you guys add \"help wanted\" label so that i can claim this issue??</p>",
        "id": 1308808,
        "sender_full_name": "Shubh Gupta",
        "timestamp": 1641987530
    }
]