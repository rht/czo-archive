[
    {
        "content": "<p>Hello,</p>\n<p>I am unable to deactivate users and view invited users after upgrading to Zulip 7. Here is the error that I'm getting:</p>\n<div class=\"codehilite\"><pre><span></span><code>2023-07-10 18:32:21.847 ERR  [django.request] Internal Server Error: /json/invites\n2023-07-10 18:32:50.153 ERR  [zerver.middleware.json_error_handler] Traceback (most recent call last):\n  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/core/handlers/base.py&quot;, line 197, in _get_response\n    response = wrapped_callback(request, *callback_args, **callback_kwargs)\n  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/lib/rest.py&quot;, line 39, in _wrapped_view_func\n    response = view_func(request, *args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/views/decorators/csrf.py&quot;, line 56, in wrapper_view\n    return view_func(*args, **kwargs)\n  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/lib/rest.py&quot;, line 203, in rest_dispatch\n    return target_function(request, **kwargs)\n  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/utils/decorators.py&quot;, line 134, in _wrapper_view\n    response = view_func(request, *args, **kwargs)\n  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/decorator.py&quot;, line 889, in _wrapped_view_func\n    return view_func(request, user_profile, *args, **kwargs)\n  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/decorator.py&quot;, line 644, in _wrapped_view_func\n    return view_func(request, user_profile, *args, **kwargs)\n  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/views/invite.py&quot;, line 112, in get_user_invites\n    all_users = do_get_invites_controlled_by_user(user_profile)\n  File &quot;/home/zulip/deployments/2023-07-06-07-55-00/./zerver/actions/invites.py&quot;, line 358, in do_get_invites_controlled_by_user\n    expiry_date=get_invitation_expiry_date(invitee.confirmation.get()),\n  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/manager.py&quot;, line 87, in manager_method\n    return getattr(self.get_queryset(), name)(*args, **kwargs)\n  File &quot;/srv/zulip-venv-cache/8754575f2f64594c058e44afbfe51f77b03ef8f4/zulip-py3-venv/lib/python3.8/site-packages/django/db/models/query.py&quot;, line 637, in get\n    raise self.model.DoesNotExist(\nconfirmation.models.Confirmation.DoesNotExist: Confirmation matching query does not exist.\n</code></pre></div>",
        "id": 1607149,
        "sender_full_name": "VS",
        "timestamp": 1689014324
    },
    {
        "content": "<p>What version were you upgrading from?</p>",
        "id": 1607151,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1689014527
    },
    {
        "content": "<p>Can you run, as the <code>zulip</code> user:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"nb\">cd</span><span class=\"w\"> </span>~/deployments/current\n./manage.py<span class=\"w\"> </span>dbshell\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"PostgreSQL SQL dialect\"><pre><span></span><code><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">zerver_preregistrationuser</span><span class=\"mf\">.</span><span class=\"n\">id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">invited_at</span>\n<span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">zerver_preregistrationuser</span>\n<span class=\"w\"> </span><span class=\"k\">left</span><span class=\"w\"> </span><span class=\"k\">join</span><span class=\"w\"> </span><span class=\"n\">confirmation_confirmation</span><span class=\"w\"> </span><span class=\"k\">on</span>\n<span class=\"w\">  </span><span class=\"n\">content_type_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">django_content_type</span>\n<span class=\"w\">                      </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">app_label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'zerver'</span>\n<span class=\"w\">                      </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'preregistrationuser'</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">object_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">zerver_preregistrationuser</span><span class=\"mf\">.</span><span class=\"n\">id</span>\n<span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">confirmation_confirmation</span><span class=\"mf\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">is</span><span class=\"w\"> </span><span class=\"k\">null</span>\n<span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">invited_at</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">now</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"nb\">interval</span><span class=\"w\"> </span><span class=\"s1\">'1 hour'</span>\n<span class=\"w\"> </span><span class=\"k\">limit</span><span class=\"w\"> </span><span class=\"mf\">50</span><span class=\"p\">;</span>\n</code></pre></div>",
        "id": 1607155,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1689014672
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code> id  |          invited_at\n-----+-------------------------------\n  99 | 2022-06-30 17:09:09.784337+00\n 180 | 2022-08-17 11:02:37.090769+00\n 116 | 2022-07-14 10:56:17.196458+00\n(3 rows)\n</code></pre></div>",
        "id": 1607157,
        "sender_full_name": "VS",
        "timestamp": 1689014925
    },
    {
        "content": "<p>OK, those are old enough that we're not going to be able to get anything useful out of the access logs as to what caused this.</p>\n<p>This is <a href=\"https://github.com/zulip/zulip/pull/21306\">#21306</a> / <a href=\"https://github.com/zulip/zulip/pull/22025\">#22025</a>.</p>",
        "id": 1607163,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1689015496
    },
    {
        "content": "<p>Your fix is, at the database prompt you're at:</p>\n<div class=\"codehilite\" data-code-language=\"PostgreSQL SQL dialect\"><pre><span></span><code><span class=\"k\">start</span><span class=\"w\"> </span><span class=\"k\">transaction</span><span class=\"p\">;</span>\n<span class=\"k\">delete</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">zerver_preregistrationuser_streams</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">preregistrationuser_id</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">99</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">116</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">180</span><span class=\"p\">);</span>\n<span class=\"k\">delete</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">zerver_preregistrationuser</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">99</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">116</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">180</span><span class=\"p\">);</span>\n<span class=\"k\">commit</span><span class=\"p\">;</span>\n</code></pre></div>",
        "id": 1607168,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1689015570
    }
]