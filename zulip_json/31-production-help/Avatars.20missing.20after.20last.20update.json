[
    {
        "content": "<p>There are several issues in latest release. Missing last button from main menu. Custom avatars do not get displayed.</p>",
        "id": 1459396,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667577293
    },
    {
        "content": "<p><a href=\"/user_uploads/2/bf/xWvHfKXB6nVAx2e6oPqcC2LW/4EBC1BE9-4487-4C63-A1B9-69344FBEA0F9.png\">4EBC1BE9-4487-4C63-A1B9-69344FBEA0F9.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/bf/xWvHfKXB6nVAx2e6oPqcC2LW/4EBC1BE9-4487-4C63-A1B9-69344FBEA0F9.png\" title=\"4EBC1BE9-4487-4C63-A1B9-69344FBEA0F9.png\"><img src=\"/user_uploads/2/bf/xWvHfKXB6nVAx2e6oPqcC2LW/4EBC1BE9-4487-4C63-A1B9-69344FBEA0F9.png\"></a></div>",
        "id": 1459397,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667577422
    },
    {
        "content": "<p>I am on latest git main release 6 dev.</p>",
        "id": 1459398,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667577467
    },
    {
        "content": "<p>Its weird cause here the button is displayed when i switch to my server is not anymore.</p>",
        "id": 1459399,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667577499
    },
    {
        "content": "<p>Thanks for the report, <span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span>! It looks like the app is having trouble loading uploaded avatars.</p>\n<p>Some questions to help debug:</p>\n<ul>\n<li>Is it a self-hosted server?</li>\n<li>Do you have a good Internet connection?</li>\n<li>In the mobile app, if you look at a message with an uploaded photo in it, does it show a preview of the photo, or just a broken-link placeholder where the preview should be? If you tap the preview or placeholder, does it open the lightbox where you can pan/zoom?</li>\n</ul>",
        "id": 1459402,
        "sender_full_name": "Chris Bobbe",
        "timestamp": 1667577861
    },
    {
        "content": "<p>yes it is self hosted server running latest main git release</p>",
        "id": 1459413,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667579659
    },
    {
        "content": "<p>My connection is over 200 Mbs so yes i would say good enough</p>",
        "id": 1459414,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667579682
    },
    {
        "content": "<p>Here is a printscren. Seems images upload works well yet avatar has broken placeholder only for the ones with custom avatars. The rest seem to be fine. Those auto generated</p>",
        "id": 1459415,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667579825
    },
    {
        "content": "<p><a href=\"/user_uploads/2/9b/5DEzpZ72flWEj5qJe1EAxlk2/1A8408D9-3C6E-4D6A-8EBF-1AF676F23F15.png\">1A8408D9-3C6E-4D6A-8EBF-1AF676F23F15.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/9b/5DEzpZ72flWEj5qJe1EAxlk2/1A8408D9-3C6E-4D6A-8EBF-1AF676F23F15.png\" title=\"1A8408D9-3C6E-4D6A-8EBF-1AF676F23F15.png\"><img src=\"/user_uploads/2/9b/5DEzpZ72flWEj5qJe1EAxlk2/1A8408D9-3C6E-4D6A-8EBF-1AF676F23F15.png\"></a></div>",
        "id": 1459416,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667579831
    },
    {
        "content": "<p>I believe it could be related to my latest update</p>",
        "id": 1459418,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667579850
    },
    {
        "content": "<p>Yet it came out successfully no errors</p>",
        "id": 1459420,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667579867
    },
    {
        "content": "<p>Yet it seems it is also on desktop, so I think this is not related to the iOS app.</p>",
        "id": 1459421,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667580148
    },
    {
        "content": "<p>Maybe someone could move this topic into production help.</p>",
        "id": 1459422,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667580200
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"48\" href=\"/#narrow/stream/48-mobile/topic/Avatars.20missing.20after.20last.20update\">#mobile &gt; Avatars missing after last update</a> by <span class=\"user-mention silent\" data-user-id=\"13313\">Chris Bobbe</span>.</p>",
        "id": 1459423,
        "sender_full_name": "Notification Bot",
        "timestamp": 1667580302
    },
    {
        "content": "<p>It is very weird, users imported from mattermost a year ago, have avatars, new users who used the account dont have it</p>",
        "id": 1459425,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667580504
    },
    {
        "content": "<p>Also the main view is a bit broken.</p>",
        "id": 1459426,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667580512
    },
    {
        "content": "<p><a href=\"/user_uploads/2/a1/aJtzfci44CQwlioKmTwBUahl/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/a1/aJtzfci44CQwlioKmTwBUahl/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/a1/aJtzfci44CQwlioKmTwBUahl/image.png\"></a></div>",
        "id": 1459427,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667580539
    },
    {
        "content": "<p>Thanks for that screenshot. It's from the desktop app, right? Which platform?</p>\n<p>Do you see the same problem in the web app?</p>\n<p>I'm curious if there's something funny with the avatar image URLs. Are you familiar with using a browser's inspector, like in Chrome DevTools? If so, it could be helpful to know what the <code>src</code> attribute of the image tag in the web app looks like. The one for my avatar here on <a href=\"http://chat.zulip.org\">chat.zulip.org</a> is <code>https://chat.zulip.org/user_avatars/2/08fb6d007eb10a56efee1d64760fbeb6111c4352.png?version=2&amp;s=50</code>, for example. It could be interesting to know if the avatars on your server look much different from that.</p>",
        "id": 1459428,
        "sender_full_name": "Chris Bobbe",
        "timestamp": 1667580802
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"20576\">Cosmic Sound</span> <a href=\"#narrow/stream/31-production-help/topic/Avatars.20missing.20after.20last.20update/near/1459426\">said</a>:</p>\n<blockquote>\n<p>Also the main view is a bit broken.</p>\n</blockquote>\n<p>Created a separate thread for the left sidebar part of this as <a class=\"stream-topic\" data-stream-id=\"9\" href=\"/#narrow/stream/9-issues/topic/left_side_userlist.20broken\">#issues &gt; left_side_userlist broken</a>; thanks for the report!</p>",
        "id": 1459463,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1667584850
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"13313\">Chris Bobbe</span> <a href=\"#narrow/stream/31-production-help/topic/Avatars.20missing.20after.20last.20update/near/1459428\">said</a>:</p>\n<blockquote>\n<p>Thanks for that screenshot. It's from the desktop app, right? Which platform?</p>\n<p>Do you see the same problem in the web app?</p>\n<p>I'm curious if there's something funny with the avatar image URLs. Are you familiar with using a browser's inspector, like in Chrome DevTools? If so, it could be helpful to know what the <code>src</code> attribute of the image tag in the web app looks like. The one for my avatar here on <a href=\"http://chat.zulip.org\">chat.zulip.org</a> is <code>https://chat.zulip.org/user_avatars/2/08fb6d007eb10a56efee1d64760fbeb6111c4352.png?version=2&amp;s=50</code>, for example. It could be interesting to know if the avatars on your server look much different from that.</p>\n</blockquote>\n<p>I am on macos, using latest version of desktop app, and same on ios using latest mobile app, this I doubt it is related to the apps, in any way. Let me try the browser view.</p>",
        "id": 1459565,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667590700
    },
    {
        "content": "<p>It is clearly not the apps here, since this does not replicate on this server, only on my self hosted, until now imho if its present on desktop and ios app, since they are only wrappers around the web app, I doubt it will be any different.</p>",
        "id": 1459573,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667591369
    },
    {
        "content": "<p><a href=\"/user_uploads/2/b7/Z1XV6V02TcMs7sCO2ClI1tnE/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/b7/Z1XV6V02TcMs7sCO2ClI1tnE/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/b7/Z1XV6V02TcMs7sCO2ClI1tnE/image.png\"></a></div>",
        "id": 1459636,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1667594861
    },
    {
        "content": "<blockquote>\n<p>The one for my avatar here on <a href=\"http://chat.zulip.org\">chat.zulip.org</a> is <code>https://chat.zulip.org/user_avatars/2/08fb6d007eb10a56efee1d64760fbeb6111c4352.png?version=2&amp;s=50</code>, for example. It could be interesting to know if the avatars on your server look much different from that.</p>\n</blockquote>\n<p>Hmm, from a quick look at your screenshot, the avatar URLs on your org look like they're in that same form too. I don't yet have a theory for why the server would be giving 404s though.</p>\n<p>Perhaps someone who works closer to the server code than I do can investigate?</p>",
        "id": 1459694,
        "sender_full_name": "Chris Bobbe",
        "timestamp": 1667597301
    },
    {
        "content": "<p>(deleted—double-send from web app)</p>",
        "id": 1459695,
        "sender_full_name": "Chris Bobbe",
        "timestamp": 1667597312
    },
    {
        "content": "<p>(deleted—triple-send from web app)</p>",
        "id": 1459697,
        "sender_full_name": "Chris Bobbe",
        "timestamp": 1667597332
    },
    {
        "content": "<p>Bump, for someone who focuses on server code:</p>\n<blockquote>\n<p>I don't yet have a theory for why the server would be giving 404s though.</p>\n</blockquote>",
        "id": 1461739,
        "sender_full_name": "Chris Bobbe",
        "timestamp": 1668030826
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span> can you check whether the files in question exist in <code>/home/zulip/uploads/user_avatars/</code> on your server? (Or are you using the S3 backend?)</p>",
        "id": 1462075,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1668060479
    },
    {
        "content": "<p>I don't think we've changed anything material in the uploads/avatars code path in this release, so I'm wondering if there's something else going on with your installation (did you do a backup/restore, perhaps)?</p>",
        "id": 1462079,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1668060572
    },
    {
        "content": "<p>The \"you do not have permission to access the requested resource\" interleaved in there is also interesting -- but I can't tell what URL that was for.</p>",
        "id": 1462235,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1668096585
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"7\">Tim Abbott</span> <a href=\"#narrow/stream/31-production-help/topic/Avatars.20missing.20after.20last.20update/near/1462075\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"20576\">Cosmic Sound</span> can you check whether the files in question exist in <code>/home/zulip/uploads/user_avatars/</code> on your server? (Or are you using the S3 backend?)</p>\n</blockquote>\n<p>I am checking now, not using S3.</p>",
        "id": 1463121,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668345042
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>ubuntu@chat:/home/zulip/uploads$ ls\nfiles\nubuntu@chat:/home/zulip/uploads$ <span class=\"nb\">pwd</span>\n/home/zulip/uploads\n</code></pre></div>",
        "id": 1463122,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668345113
    },
    {
        "content": "<p>It seems there is no such folder, and is weird since this looks to be changed in 4th of november, this was previous upgrades where I had issuess.</p>",
        "id": 1463123,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668345164
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"m\">2022</span>-10-18-18-17-31  <span class=\"m\">2022</span>-11-04-03-39-36  <span class=\"m\">2022</span>-11-04-03-45-30\n</code></pre></div>\n<p>these were previous upgrades, yet the last upgrade had issues so we had to make some repairs. It seems what ever done completely wiped all images.</p>",
        "id": 1463124,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668345305
    },
    {
        "content": "<p>I will attempt a restore previous to all the last 2 upgrades, and rerun upgrades to see if the issue persists.</p>",
        "id": 1463125,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668345733
    },
    {
        "content": "<p>Ok, so to narrow it a bit, I have restored a backup previous the upgrades, and run the upgrade again, the upgrade was successfull this time, yet all images are gone.</p>",
        "id": 1463126,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668346723
    },
    {
        "content": "<p><a href=\"/user_uploads/2/5d/ySxMqc5w5-hEJ4LID93-0ySW/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/5d/ySxMqc5w5-hEJ4LID93-0ySW/image.png\" title=\"image.png\"><img src=\"/user_uploads/2/5d/ySxMqc5w5-hEJ4LID93-0ySW/image.png\"></a></div>",
        "id": 1463128,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668346732
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"20576\">Cosmic Sound</span> <a href=\"#narrow/stream/31-production-help/topic/Avatars.20missing.20after.20last.20update/near/1463121\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"7\">Tim Abbott</span> <a href=\"#narrow/stream/31-production-help/topic/Avatars.20missing.20after.20last.20update/near/1462075\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"20576\">Cosmic Sound</span> can you check whether the files in question exist in <code>/home/zulip/uploads/user_avatars/</code> on your server? (Or are you using the S3 backend?)</p>\n</blockquote>\n<p>I am checking now, not using S3.</p>\n</blockquote>\n<p>such folder does not even exists.</p>",
        "id": 1463129,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668346785
    },
    {
        "content": "<p>The previous folder was there because I tried to upload an image</p>",
        "id": 1463130,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668346811
    },
    {
        "content": "<p>So it is either the last upgrade made form git main or previous one that broke all avatars.</p>",
        "id": 1463131,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668347988
    },
    {
        "content": "<p>For now I will restore a backup from 29th last month, and will stick with it, since this matter is fixed.</p>",
        "id": 1463133,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668348014
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"20576\">@Cosmic Sound</span> sorry, I had a typo -- the path would be <code>/home/zulip/uploads/avatars/</code>.</p>",
        "id": 1463509,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1668450595
    },
    {
        "content": "<p>I don't believe we've had any migrations in recent years that would affect avatars, so I'm quite puzzled; the last one a <code>grep</code> finds was from 2019.</p>",
        "id": 1463510,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1668450694
    },
    {
        "content": "<p>Do your backup tarballs contain the avatar files? You can use <code>tar -tf</code> to inspect that.</p>",
        "id": 1463511,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1668450803
    },
    {
        "content": "<p>I wonder if the backup/restore steps are part of the issue you're seeing; one theory would be that there's something wrong with either creating the backups or <code>restore-backup</code> such that those files are being lost?</p>",
        "id": 1463512,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1668450862
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"7\">Tim Abbott</span> <a href=\"#narrow/stream/31-production-help/topic/Avatars.20missing.20after.20last.20update/near/1463509\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"20576\">Cosmic Sound</span> sorry, I had a typo -- the path would be <code>/home/zulip/uploads/avatars/</code>.</p>\n</blockquote>\n<p>It is very weird, last backup where I had the folder is 2 months old. Trying now to upgrade that release and see what happends</p>",
        "id": 1463573,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668452422
    },
    {
        "content": "<p>OK, so that suggests that the folder was somehow deleted on the system 2 months ago; but if that was the case, how was it not noticed until the upgrade?</p>",
        "id": 1463623,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1668453798
    },
    {
        "content": "<p>(I suppose there could be some story where all the browsers had the avatars in their cache?)</p>",
        "id": 1463624,
        "sender_full_name": "Tim Abbott",
        "timestamp": 1668453810
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"7\">Tim Abbott</span> <a href=\"#narrow/stream/31-production-help/topic/Avatars.20missing.20after.20last.20update/near/1463623\">said</a>:</p>\n<blockquote>\n<p>OK, so that suggests that the folder was somehow deleted on the system 2 months ago; but if that was the case, how was it not noticed until the upgrade?</p>\n</blockquote>\n<p>also for me its is a mystery will need to look into this a bit more.</p>",
        "id": 1463751,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668458307
    },
    {
        "content": "<p>yet now seems all is good. could be somehow was deleted by mistake since I was cleaning up the old mattermost imports.</p>",
        "id": 1463753,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1668458339
    }
]