[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">Logger</span> <span class=\"n\">zulip</span><span class=\"o\">.</span><span class=\"n\">send_email</span><span class=\"p\">,</span> <span class=\"kn\">from</span> <span class=\"nn\">module</span> <span class=\"n\">zerver</span><span class=\"o\">.</span><span class=\"n\">lib</span><span class=\"o\">.</span><span class=\"n\">send_email</span> <span class=\"n\">line</span> <span class=\"mi\">288</span><span class=\"p\">:</span>\n<span class=\"n\">Error</span> <span class=\"n\">generated</span> <span class=\"n\">by</span> <span class=\"n\">Anonymous</span> <span class=\"n\">user</span> <span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">logged</span> <span class=\"ow\">in</span><span class=\"p\">)</span> <span class=\"n\">on</span> <span class=\"n\">chat</span> <span class=\"n\">deployment</span>\n\n<span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">391</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">getreply</span>\n<span class=\"n\">line</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"o\">.</span><span class=\"n\">readline</span><span class=\"p\">(</span><span class=\"n\">_MAXLINE</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/socket.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">669</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">readinto</span>\n<span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_sock</span><span class=\"o\">.</span><span class=\"n\">recv_into</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">)</span>\n<span class=\"n\">socket</span><span class=\"o\">.</span><span class=\"n\">timeout</span><span class=\"p\">:</span> <span class=\"n\">timed</span> <span class=\"n\">out</span>\n\n<span class=\"n\">During</span> <span class=\"n\">handling</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">above</span> <span class=\"n\">exception</span><span class=\"p\">,</span> <span class=\"n\">another</span> <span class=\"n\">exception</span> <span class=\"n\">occurred</span><span class=\"p\">:</span>\n\n<span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-04-11-21-43-40/zerver/lib/send_email.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">274</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">send_email</span>\n<span class=\"k\">if</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">send_messages</span><span class=\"p\">([</span><span class=\"n\">mail</span><span class=\"p\">])</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/726c7d1d35d9cd61bb4b70e98167a1db7b0c524d/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">102</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">send_messages</span>\n<span class=\"n\">new_conn_created</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">()</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/726c7d1d35d9cd61bb4b70e98167a1db7b0c524d/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">62</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"nb\">open</span>\n<span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection_class</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">port</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">connection_params</span><span class=\"p\">)</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">255</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"fm\">__init__</span>\n<span class=\"p\">(</span><span class=\"n\">code</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"n\">port</span><span class=\"p\">)</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">341</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">connect</span>\n<span class=\"p\">(</span><span class=\"n\">code</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">getreply</span><span class=\"p\">()</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">394</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">getreply</span>\n<span class=\"k\">raise</span> <span class=\"n\">SMTPServerDisconnected</span><span class=\"p\">(</span><span class=\"s2\">\"Connection unexpectedly closed: \"</span>\n<span class=\"n\">smtplib</span><span class=\"o\">.</span><span class=\"n\">SMTPServerDisconnected</span><span class=\"p\">:</span> <span class=\"n\">Connection</span> <span class=\"n\">unexpectedly</span> <span class=\"n\">closed</span><span class=\"p\">:</span> <span class=\"n\">timed</span> <span class=\"n\">out</span>\n\n\n<span class=\"n\">Deployed</span> <span class=\"n\">code</span><span class=\"p\">:</span>\n<span class=\"o\">-</span> <span class=\"n\">git</span><span class=\"p\">:</span> <span class=\"mf\">6.0</span><span class=\"o\">-</span><span class=\"n\">dev</span><span class=\"o\">-</span><span class=\"mi\">96</span><span class=\"o\">-</span><span class=\"n\">g07c12e8a6c</span>\n<span class=\"o\">-</span> <span class=\"n\">ZULIP_VERSION</span><span class=\"p\">:</span> <span class=\"mf\">6.0</span><span class=\"o\">-</span><span class=\"n\">dev</span><span class=\"o\">-</span><span class=\"mi\">96</span><span class=\"o\">-</span><span class=\"n\">g07c12e8a6c</span>\n\n\n<span class=\"n\">Request</span> <span class=\"n\">info</span><span class=\"p\">:</span> <span class=\"n\">none</span>\n</code></pre></div>",
        "id": 1365048,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649790015
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">Logger</span> <span class=\"n\">zulip</span><span class=\"o\">.</span><span class=\"n\">send_email</span><span class=\"p\">,</span> <span class=\"kn\">from</span> <span class=\"nn\">module</span> <span class=\"n\">zerver</span><span class=\"o\">.</span><span class=\"n\">lib</span><span class=\"o\">.</span><span class=\"n\">send_email</span> <span class=\"n\">line</span> <span class=\"mi\">288</span><span class=\"p\">:</span>\n<span class=\"n\">Error</span> <span class=\"n\">generated</span> <span class=\"n\">by</span> <span class=\"n\">Anonymous</span> <span class=\"n\">user</span> <span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">logged</span> <span class=\"ow\">in</span><span class=\"p\">)</span> <span class=\"n\">on</span> <span class=\"n\">chat</span> <span class=\"n\">deployment</span>\n\n<span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">391</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">getreply</span>\n<span class=\"n\">line</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"o\">.</span><span class=\"n\">readline</span><span class=\"p\">(</span><span class=\"n\">_MAXLINE</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/socket.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">669</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">readinto</span>\n<span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_sock</span><span class=\"o\">.</span><span class=\"n\">recv_into</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">)</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/ssl.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1241</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">recv_into</span>\n<span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"n\">nbytes</span><span class=\"p\">,</span> <span class=\"n\">buffer</span><span class=\"p\">)</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/ssl.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1099</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">read</span>\n<span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_sslobj</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"nb\">len</span><span class=\"p\">,</span> <span class=\"n\">buffer</span><span class=\"p\">)</span>\n<span class=\"n\">socket</span><span class=\"o\">.</span><span class=\"n\">timeout</span><span class=\"p\">:</span> <span class=\"n\">The</span> <span class=\"n\">read</span> <span class=\"n\">operation</span> <span class=\"n\">timed</span> <span class=\"n\">out</span>\n\n<span class=\"n\">During</span> <span class=\"n\">handling</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">above</span> <span class=\"n\">exception</span><span class=\"p\">,</span> <span class=\"n\">another</span> <span class=\"n\">exception</span> <span class=\"n\">occurred</span><span class=\"p\">:</span>\n\n<span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-04-11-21-43-40/zerver/lib/send_email.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">274</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">send_email</span>\n<span class=\"k\">if</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">send_messages</span><span class=\"p\">([</span><span class=\"n\">mail</span><span class=\"p\">])</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/726c7d1d35d9cd61bb4b70e98167a1db7b0c524d/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">102</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">send_messages</span>\n<span class=\"n\">new_conn_created</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">()</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/726c7d1d35d9cd61bb4b70e98167a1db7b0c524d/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">69</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"nb\">open</span>\n<span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">login</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">username</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">password</span><span class=\"p\">)</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">707</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">login</span>\n<span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">ehlo_or_helo_if_needed</span><span class=\"p\">()</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">604</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">ehlo_or_helo_if_needed</span>\n<span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"mi\">200</span> <span class=\"o\">&lt;=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">ehlo</span><span class=\"p\">()[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">&lt;=</span> <span class=\"mi\">299</span><span class=\"p\">):</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">445</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">ehlo</span>\n<span class=\"p\">(</span><span class=\"n\">code</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">getreply</span><span class=\"p\">()</span>\n<span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">394</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">getreply</span>\n<span class=\"k\">raise</span> <span class=\"n\">SMTPServerDisconnected</span><span class=\"p\">(</span><span class=\"s2\">\"Connection unexpectedly closed: \"</span>\n<span class=\"n\">smtplib</span><span class=\"o\">.</span><span class=\"n\">SMTPServerDisconnected</span><span class=\"p\">:</span> <span class=\"n\">Connection</span> <span class=\"n\">unexpectedly</span> <span class=\"n\">closed</span><span class=\"p\">:</span> <span class=\"n\">The</span> <span class=\"n\">read</span> <span class=\"n\">operation</span> <span class=\"n\">timed</span> <span class=\"n\">out</span>\n\n\n<span class=\"n\">Deployed</span> <span class=\"n\">code</span><span class=\"p\">:</span>\n<span class=\"o\">-</span> <span class=\"n\">git</span><span class=\"p\">:</span> <span class=\"mf\">6.0</span><span class=\"o\">-</span><span class=\"n\">dev</span><span class=\"o\">-</span><span class=\"mi\">96</span><span class=\"o\">-</span><span class=\"n\">g07c12e8a6c</span>\n<span class=\"o\">-</span> <span class=\"n\">ZULIP_VERSION</span><span class=\"p\">:</span> <span class=\"mf\">6.0</span><span class=\"o\">-</span><span class=\"n\">dev</span><span class=\"o\">-</span><span class=\"mi\">96</span><span class=\"o\">-</span><span class=\"n\">g07c12e8a6c</span>\n\n\n<span class=\"n\">Request</span> <span class=\"n\">info</span><span class=\"p\">:</span> <span class=\"n\">none</span>\n</code></pre></div>",
        "id": 1365049,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649790052
    },
    {
        "content": "<p>I am not aware of any limitations inside Postal for mail deliveries, since the system was built for such.</p>",
        "id": 1365082,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649791865
    },
    {
        "content": "<p>I would rather see a issue of latency maybe, or the time response set in Zulip to process the SMTP gateway replies.</p>",
        "id": 1365084,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649791917
    },
    {
        "content": "<p>I can't entirely tell from those tracebacks, but it <em>looks</em> from the \"Request info: none\" that those are from a backend worker.  Can you double-check that the error is in <code>/var/log/zulip/events_email_senders.log</code>?</p>\n<p>If so, this is the long-lived worker connection.  ISTR we have a task to let folks turn off this pooling, or make it cap out at some configurable number of minutes, because it's not configurable at the moment.</p>",
        "id": 1365092,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649792305
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"ne\">ConnectionResetError</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"n\">Errno</span> <span class=\"mi\">104</span><span class=\"p\">]</span> <span class=\"n\">Connection</span> <span class=\"n\">reset</span> <span class=\"n\">by</span> <span class=\"n\">peer</span>\n<span class=\"mi\">2021</span><span class=\"o\">-</span><span class=\"mi\">10</span><span class=\"o\">-</span><span class=\"mi\">30</span> <span class=\"mi\">08</span><span class=\"p\">:</span><span class=\"mi\">09</span><span class=\"p\">:</span><span class=\"mf\">12.014</span> <span class=\"n\">INFO</span> <span class=\"p\">[</span><span class=\"n\">process_queue</span><span class=\"p\">]</span> <span class=\"n\">Worker</span> <span class=\"mi\">0</span> <span class=\"n\">connecting</span> <span class=\"n\">to</span> <span class=\"n\">queue</span> <span class=\"n\">email_senders</span>\n<span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/current/manage.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">157</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"o\">&lt;</span><span class=\"n\">module</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">execute_from_command_line</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">argv</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/current/manage.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">122</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute_from_command_line</span>\n    <span class=\"n\">utility</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">413</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetch_command</span><span class=\"p\">(</span><span class=\"n\">subcommand</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">run_from_argv</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">argv</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">354</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">run_from_argv</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">cmd_options</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">398</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute</span>\n    <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">options</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2021-07-03-21-01-47/zerver/management/commands/process_queue.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">82</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">handle</span>\n    <span class=\"n\">worker</span> <span class=\"o\">=</span> <span class=\"n\">get_worker</span><span class=\"p\">(</span><span class=\"n\">queue_name</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2021-07-03-21-01-47/zerver/worker/queue_processors.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">152</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">get_worker</span>\n    <span class=\"k\">return</span> <span class=\"n\">worker_classes</span><span class=\"p\">[</span><span class=\"n\">queue_name</span><span class=\"p\">]()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2021-07-03-21-01-47/zerver/worker/queue_processors.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">628</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"fm\">__init__</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">:</span> <span class=\"n\">EmailBackend</span> <span class=\"o\">=</span> <span class=\"n\">initialize_connection</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/backoff/_sync.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">94</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">retry</span>\n    <span class=\"n\">ret</span> <span class=\"o\">=</span> <span class=\"n\">target</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2021-07-03-21-01-47/zerver/lib/send_email.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">279</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">initialize_connection</span>\n    <span class=\"k\">if</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">():</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">67</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"nb\">open</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">starttls</span><span class=\"p\">(</span><span class=\"n\">keyfile</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">ssl_keyfile</span><span class=\"p\">,</span> <span class=\"n\">certfile</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">ssl_certfile</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">783</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">starttls</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sock</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">wrap_socket</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sock</span><span class=\"p\">,</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/ssl.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">500</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">wrap_socket</span>\n    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sslsocket_class</span><span class=\"o\">.</span><span class=\"n\">_create</span><span class=\"p\">(</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/ssl.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1040</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_create</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">do_handshake</span><span class=\"p\">()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/ssl.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1309</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">do_handshake</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_sslobj</span><span class=\"o\">.</span><span class=\"n\">do_handshake</span><span class=\"p\">()</span>\n</code></pre></div>",
        "id": 1365101,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649792970
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">21</span> <span class=\"mi\">08</span><span class=\"p\">:</span><span class=\"mi\">31</span><span class=\"p\">:</span><span class=\"mf\">00.907</span> <span class=\"n\">INFO</span> <span class=\"p\">[</span><span class=\"n\">zulip</span><span class=\"o\">.</span><span class=\"n\">send_email</span><span class=\"p\">]</span> <span class=\"n\">Sending</span> <span class=\"n\">missed_message</span> <span class=\"n\">email</span> <span class=\"n\">to</span> <span class=\"p\">[</span><span class=\"s1\">'stephan &lt;stephan@uhl-services.ch&gt;'</span><span class=\"p\">]</span>\n<span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">27</span> <span class=\"mi\">06</span><span class=\"p\">:</span><span class=\"mi\">01</span><span class=\"p\">:</span><span class=\"mf\">33.584</span> <span class=\"n\">INFO</span> <span class=\"p\">[</span><span class=\"n\">process_queue</span><span class=\"p\">]</span> <span class=\"n\">Worker</span> <span class=\"mi\">0</span> <span class=\"n\">disconnecting</span> <span class=\"kn\">from</span> <span class=\"nn\">queue</span> <span class=\"n\">email_senders</span>\n<span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">27</span> <span class=\"mi\">06</span><span class=\"p\">:</span><span class=\"mi\">01</span><span class=\"p\">:</span><span class=\"mf\">35.277</span> <span class=\"n\">INFO</span> <span class=\"p\">[</span><span class=\"n\">process_queue</span><span class=\"p\">]</span> <span class=\"n\">Worker</span> <span class=\"mi\">0</span> <span class=\"n\">connecting</span> <span class=\"n\">to</span> <span class=\"n\">queue</span> <span class=\"n\">email_senders</span>\n<span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">27</span> <span class=\"mi\">06</span><span class=\"p\">:</span><span class=\"mi\">02</span><span class=\"p\">:</span><span class=\"mf\">43.611</span> <span class=\"n\">ERR</span>  <span class=\"p\">[</span><span class=\"n\">process_queue</span><span class=\"p\">]</span> <span class=\"n\">Unhandled</span> <span class=\"n\">exception</span> <span class=\"kn\">from</span> <span class=\"nn\">queue</span><span class=\"p\">:</span> <span class=\"n\">email_senders</span>\n<span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">391</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">getreply</span>\n    <span class=\"n\">line</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"o\">.</span><span class=\"n\">readline</span><span class=\"p\">(</span><span class=\"n\">_MAXLINE</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/socket.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">669</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">readinto</span>\n    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_sock</span><span class=\"o\">.</span><span class=\"n\">recv_into</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">)</span>\n<span class=\"n\">socket</span><span class=\"o\">.</span><span class=\"n\">timeout</span><span class=\"p\">:</span> <span class=\"n\">timed</span> <span class=\"n\">out</span>\n\n<span class=\"n\">During</span> <span class=\"n\">handling</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">above</span> <span class=\"n\">exception</span><span class=\"p\">,</span> <span class=\"n\">another</span> <span class=\"n\">exception</span> <span class=\"n\">occurred</span><span class=\"p\">:</span>\n\n<span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-02-10-10-21-52/zerver/management/commands/process_queue.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">24</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">log_and_exit_if_exception</span>\n    <span class=\"k\">yield</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-02-10-10-21-52/zerver/management/commands/process_queue.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">101</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">handle</span>\n    <span class=\"n\">worker</span> <span class=\"o\">=</span> <span class=\"n\">get_worker</span><span class=\"p\">(</span><span class=\"n\">queue_name</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-02-10-10-21-52/zerver/worker/queue_processors.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">165</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">get_worker</span>\n    <span class=\"k\">return</span> <span class=\"n\">worker_classes</span><span class=\"p\">[</span><span class=\"n\">queue_name</span><span class=\"p\">]()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-02-10-10-21-52/zerver/worker/queue_processors.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">732</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"fm\">__init__</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">:</span> <span class=\"n\">EmailBackend</span> <span class=\"o\">=</span> <span class=\"n\">initialize_connection</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/backoff/_sync.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">94</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">retry</span>\n    <span class=\"n\">ret</span> <span class=\"o\">=</span> <span class=\"n\">target</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-02-10-10-21-52/zerver/lib/send_email.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">305</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">initialize_connection</span>\n    <span class=\"k\">if</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">():</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">62</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"nb\">open</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection_class</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">port</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">connection_params</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">255</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"fm\">__init__</span>\n    <span class=\"p\">(</span><span class=\"n\">code</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"n\">port</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">341</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">connect</span>\n    <span class=\"p\">(</span><span class=\"n\">code</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">getreply</span><span class=\"p\">()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">394</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">getreply</span>\n    <span class=\"k\">raise</span> <span class=\"n\">SMTPServerDisconnected</span><span class=\"p\">(</span><span class=\"s2\">\"Connection unexpectedly closed: \"</span>\n<span class=\"n\">smtplib</span><span class=\"o\">.</span><span class=\"n\">SMTPServerDisconnected</span><span class=\"p\">:</span> <span class=\"n\">Connection</span> <span class=\"n\">unexpectedly</span> <span class=\"n\">closed</span><span class=\"p\">:</span> <span class=\"n\">timed</span> <span class=\"n\">out</span>\n<span class=\"n\">Stack</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/current/manage.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">157</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"o\">&lt;</span><span class=\"n\">module</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">execute_from_command_line</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">argv</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/current/manage.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">122</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute_from_command_line</span>\n    <span class=\"n\">utility</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">413</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetch_command</span><span class=\"p\">(</span><span class=\"n\">subcommand</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">run_from_argv</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">argv</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">354</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">run_from_argv</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">cmd_options</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/70260ad6a1c2d182c2e20386ecac861c40870932/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">398</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute</span>\n    <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">options</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-02-10-10-21-52/zerver/management/commands/process_queue.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">111</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">handle</span>\n    <span class=\"n\">worker</span><span class=\"o\">.</span><span class=\"n\">start</span><span class=\"p\">()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/contextlib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">131</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"fm\">__exit__</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">gen</span><span class=\"o\">.</span><span class=\"n\">throw</span><span class=\"p\">(</span><span class=\"nb\">type</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">traceback</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2022-02-10-10-21-52/zerver/management/commands/process_queue.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">26</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">log_and_exit_if_exception</span>\n    <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">exception</span><span class=\"p\">(</span><span class=\"s2\">\"Unhandled exception from queue: </span><span class=\"si\">%s</span><span class=\"s2\">\"</span><span class=\"p\">,</span> <span class=\"n\">queue_name</span><span class=\"p\">,</span> <span class=\"n\">stack_info</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">27</span> <span class=\"mi\">06</span><span class=\"p\">:</span><span class=\"mi\">02</span><span class=\"p\">:</span><span class=\"mf\">50.081</span> <span class=\"n\">INFO</span> <span class=\"p\">[</span><span class=\"n\">process_queue</span><span class=\"p\">]</span> <span class=\"n\">Worker</span> <span class=\"mi\">0</span> <span class=\"n\">connecting</span> <span class=\"n\">to</span> <span class=\"n\">queue</span> <span class=\"n\">email_senders</span>\n</code></pre></div>",
        "id": 1365103,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649793094
    },
    {
        "content": "<p>What is weird is that in last error, you can see there were like 2 hrs since last action, and then suddenly the timeouts</p>",
        "id": 1365104,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649793139
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">04</span><span class=\"o\">-</span><span class=\"mi\">11</span> <span class=\"mi\">21</span><span class=\"p\">:</span><span class=\"mi\">45</span><span class=\"p\">:</span><span class=\"mf\">38.932</span> <span class=\"n\">INFO</span> <span class=\"p\">[</span><span class=\"n\">process_queue</span><span class=\"p\">]</span> <span class=\"n\">Worker</span> <span class=\"mi\">0</span> <span class=\"n\">disconnecting</span> <span class=\"kn\">from</span> <span class=\"nn\">queue</span> <span class=\"n\">email_senders</span>\n<span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">04</span><span class=\"o\">-</span><span class=\"mi\">11</span> <span class=\"mi\">21</span><span class=\"p\">:</span><span class=\"mi\">47</span><span class=\"p\">:</span><span class=\"mf\">12.688</span> <span class=\"n\">INFO</span> <span class=\"p\">[</span><span class=\"n\">process_queue</span><span class=\"p\">]</span> <span class=\"n\">Worker</span> <span class=\"mi\">0</span> <span class=\"n\">connecting</span> <span class=\"n\">to</span> <span class=\"n\">queue</span> <span class=\"n\">email_senders</span>\n</code></pre></div>\n<p>these are last lines of code, beside the ones where users emails are visible for sent emails.</p>",
        "id": 1365105,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649793199
    },
    {
        "content": "<p>Those last two lines are from a server restart, and normal for that.</p>",
        "id": 1365108,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649793392
    },
    {
        "content": "<p>What's a little odd in this:</p>\n<div class=\"codehilite\"><pre><span></span><code>2022-03-27 06:01:35.277 INFO [process_queue] Worker 0 connecting to queue email_senders\n2022-03-27 06:02:43.611 ERR  [process_queue] Unhandled exception from queue: email_senders\n</code></pre></div>\n<p>...is that ISTR that we only <em>make</em> the SMTP connection when we're actively going to send a message.  So that's a <em>new</em> connection that just got closed, which throws out my theory that this is the SMTP server garbage-collecting old connections.</p>",
        "id": 1365110,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649793509
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"20576\">Cosmic Sound</span> <a href=\"#narrow/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed/near/1365101\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"ne\">ConnectionResetError</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"n\">Errno</span> <span class=\"mi\">104</span><span class=\"p\">]</span> <span class=\"n\">Connection</span> <span class=\"n\">reset</span> <span class=\"n\">by</span> <span class=\"n\">peer</span>\n<span class=\"mi\">2021</span><span class=\"o\">-</span><span class=\"mi\">10</span><span class=\"o\">-</span><span class=\"mi\">30</span> <span class=\"mi\">08</span><span class=\"p\">:</span><span class=\"mi\">09</span><span class=\"p\">:</span><span class=\"mf\">12.014</span> <span class=\"n\">INFO</span> <span class=\"p\">[</span><span class=\"n\">process_queue</span><span class=\"p\">]</span> <span class=\"n\">Worker</span> <span class=\"mi\">0</span> <span class=\"n\">connecting</span> <span class=\"n\">to</span> <span class=\"n\">queue</span> <span class=\"n\">email_senders</span>\n<span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/current/manage.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">157</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"o\">&lt;</span><span class=\"n\">module</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">execute_from_command_line</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">argv</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/current/manage.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">122</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute_from_command_line</span>\n    <span class=\"n\">utility</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/__init__.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">413</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetch_command</span><span class=\"p\">(</span><span class=\"n\">subcommand</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">run_from_argv</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">argv</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">354</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">run_from_argv</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">cmd_options</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/management/base.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">398</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">execute</span>\n    <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">options</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2021-07-03-21-01-47/zerver/management/commands/process_queue.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">82</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">handle</span>\n    <span class=\"n\">worker</span> <span class=\"o\">=</span> <span class=\"n\">get_worker</span><span class=\"p\">(</span><span class=\"n\">queue_name</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2021-07-03-21-01-47/zerver/worker/queue_processors.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">152</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">get_worker</span>\n    <span class=\"k\">return</span> <span class=\"n\">worker_classes</span><span class=\"p\">[</span><span class=\"n\">queue_name</span><span class=\"p\">]()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2021-07-03-21-01-47/zerver/worker/queue_processors.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">628</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"fm\">__init__</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">:</span> <span class=\"n\">EmailBackend</span> <span class=\"o\">=</span> <span class=\"n\">initialize_connection</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/backoff/_sync.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">94</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">retry</span>\n    <span class=\"n\">ret</span> <span class=\"o\">=</span> <span class=\"n\">target</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/home/zulip/deployments/2021-07-03-21-01-47/zerver/lib/send_email.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">279</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">initialize_connection</span>\n    <span class=\"k\">if</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">():</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/srv/zulip-venv-cache/36afeea635364c14f58375b18b44b6009dfdf1d0/zulip-py3-venv/lib/python3.8/site-packages/django/core/mail/backends/smtp.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">67</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"nb\">open</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">starttls</span><span class=\"p\">(</span><span class=\"n\">keyfile</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">ssl_keyfile</span><span class=\"p\">,</span> <span class=\"n\">certfile</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">ssl_certfile</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/smtplib.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">783</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">starttls</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sock</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">wrap_socket</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sock</span><span class=\"p\">,</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/ssl.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">500</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">wrap_socket</span>\n    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sslsocket_class</span><span class=\"o\">.</span><span class=\"n\">_create</span><span class=\"p\">(</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/ssl.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1040</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">_create</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">do_handshake</span><span class=\"p\">()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">\"/usr/lib/python3.8/ssl.py\"</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1309</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">do_handshake</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_sslobj</span><span class=\"o\">.</span><span class=\"n\">do_handshake</span><span class=\"p\">()</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Just noticed the date now, so this can maybe be ignored, since is quite old.</p>",
        "id": 1365111,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649793557
    },
    {
        "content": "<p>Tangentially, that the emailed exception didn't have the useful part of the stack trace, and we had to dig it out of the logs, is a little frustrating.</p>",
        "id": 1365112,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649793560
    },
    {
        "content": "<p>Thats true, would be way easier to have a full trace log inside digest.</p>",
        "id": 1365113,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649793632
    },
    {
        "content": "<p>So AFAICT the <code>2022-03-27 06:02:43.611</code> exception is the SMTP server just dropping a new connection.  Which we do retry.  So I think the only potential thing that Zulip could be doing better here is not sending you the error.</p>",
        "id": 1365115,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649793725
    },
    {
        "content": "<p>Oh, we need to broaden the retry exceptions on <a href=\"https://github.com/zulip/zulip/blob/35e27aef4a3c9700753149eb71768fc313889d8d/zerver/lib/send_email.py#L294-L299\">https://github.com/zulip/zulip/blob/35e27aef4a3c9700753149eb71768fc313889d8d/zerver/lib/send_email.py#L294-L299</a></p>",
        "id": 1365116,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649793898
    },
    {
        "content": "<p>That retries <code>OSError</code>, but that includes <code>ConnectionResetError</code>.  So we <em>did</em> retry.</p>",
        "id": 1365117,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649793988
    },
    {
        "content": "<p>Ideally we should have logged that retry, I guess.  But that puts this squarely into \"the SMTP service was down or not responding well\" which I think <em>should</em> alert you.</p>",
        "id": 1365118,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649794030
    },
    {
        "content": "<p>OK, so it makes a connection when it first starts the worker, in addition to when it sends mail.  We could probably not bother making the initial connection, but in some ways it's useful if it immediately tries the SMTP configuration you've set up, and immediately errors, instead of waiting for later.</p>",
        "id": 1365121,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649794176
    },
    {
        "content": "<p>You said you're delivering mail via <a href=\"https://docs.postalserver.io/\">Postal</a>?  I'd check the logs there to make sure everything was running as expected during those time periods.</p>",
        "id": 1365122,
        "sender_full_name": "Alex Vandiver",
        "timestamp": 1649794350
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"12178\">Alex Vandiver</span> <a href=\"#narrow/stream/31-production-help/topic/.5BDjango.5D.20chat.3A.20Connection.20unexpectedly.20closed/near/1365122\">said</a>:</p>\n<blockquote>\n<p>You said you're delivering mail via <a href=\"https://docs.postalserver.io/\">Postal</a>?  I'd check the logs there to make sure everything was running as expected during those time periods.</p>\n</blockquote>\n<p>Nothing in Postal to correspond to that time and date.</p>",
        "id": 1365697,
        "sender_full_name": "Cosmic Sound",
        "timestamp": 1649834456
    }
]